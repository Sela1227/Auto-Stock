======================================================================
# å°ˆæ¡ˆï¼šè‡ªå‹•é¸è‚¡ç³»çµ±
# æ•´åˆæ™‚é–“ï¼š2026-01-12 23:40:29
# æª”æ¡ˆæ•¸é‡ï¼š82
======================================================================

## ğŸ“‚ ç›®éŒ„çµæ§‹

```
è‡ªå‹•é¸è‚¡ç³»çµ±/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ data_sources/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ coingecko.py
â”‚   â”‚   â”œâ”€â”€ fear_greed.py
â”‚   â”‚   â”œâ”€â”€ taiwan_stocks.py
â”‚   â”‚   â””â”€â”€ yahoo_finance.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ comparison.py
â”‚   â”‚   â”œâ”€â”€ crypto_price.py
â”‚   â”‚   â”œâ”€â”€ dividend_history.py
â”‚   â”‚   â”œâ”€â”€ index_price.py
â”‚   â”‚   â”œâ”€â”€ market_sentiment.py
â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â”œâ”€â”€ price_cache.py
â”‚   â”‚   â”œâ”€â”€ stock_price.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ user_settings.py
â”‚   â”‚   â””â”€â”€ watchlist.py
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ admin.py
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ compare.py
â”‚   â”‚   â”œâ”€â”€ crypto.py
â”‚   â”‚   â”œâ”€â”€ market.py
â”‚   â”‚   â”œâ”€â”€ settings.py
â”‚   â”‚   â”œâ”€â”€ stock.py
â”‚   â”‚   â”œâ”€â”€ stock_patch.py
â”‚   â”‚   â”œâ”€â”€ watchlist.py
â”‚   â”‚   â””â”€â”€ watchlist_cache_api.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ schemas.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_service.py
â”‚   â”‚   â”œâ”€â”€ chart_service.py
â”‚   â”‚   â”œâ”€â”€ compare_service.py
â”‚   â”‚   â”œâ”€â”€ compare_service_patch.py
â”‚   â”‚   â”œâ”€â”€ crypto_service.py
â”‚   â”‚   â”œâ”€â”€ indicator_service.py
â”‚   â”‚   â”œâ”€â”€ line_notify_service.py
â”‚   â”‚   â”œâ”€â”€ market_service.py
â”‚   â”‚   â”œâ”€â”€ notification_service.py
â”‚   â”‚   â”œâ”€â”€ price_cache_service.py
â”‚   â”‚   â”œâ”€â”€ signal_service.py
â”‚   â”‚   â”œâ”€â”€ stock_service.py
â”‚   â”‚   â””â”€â”€ watchlist_service.py
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ price_cache_task.py
â”‚   â”‚   â””â”€â”€ scheduler.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cli.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ logging_config.py
â”‚   â””â”€â”€ main.py
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ 20260112-000-readme.md
â”‚   â”œâ”€â”€ 20260112-001-settings-ui.md
â”‚   â”œâ”€â”€ 20260112-002-taiwan-stocks-fix.md
â”‚   â”œâ”€â”€ 20260112-003-stock-search-fix.md
â”‚   â”œâ”€â”€ 20260112-005-feature-specs.md
â”‚   â”œâ”€â”€ stock-analysis-system-spec.md
â”‚   â””â”€â”€ æ•´åˆæŒ‡å—.md
â”œâ”€â”€ fixes/
â”‚   â””â”€â”€ taiwan_stock_names_fix.py
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ watchlist_with_cache.js
â”œâ”€â”€ migrations/
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ åŒ¯æ•´å­ç¨‹å¼.py
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ settings.css
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â””â”€â”€ settings.js
â”‚   â”œâ”€â”€ admin.html
â”‚   â”œâ”€â”€ compare-nav.js
â”‚   â”œâ”€â”€ compare.html
â”‚   â”œâ”€â”€ dashboard-mobile.html
â”‚   â”œâ”€â”€ dashboard.html
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ logo.png
â”‚   â”œâ”€â”€ SELA-Bugä¿®å¾©è¨˜éŒ„.md
â”‚   â””â”€â”€ settings-section.html
â”œâ”€â”€ æ›´æ–°æª”/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ dashboard-patch-example.html
â”œâ”€â”€ Procfile
â”œâ”€â”€ railway.json
â”œâ”€â”€ RAILWAY_SETUP.md
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ runtime.txt
â”œâ”€â”€ åŒ¯æ•´å°ˆæ¡ˆ V2 .py
â””â”€â”€ è‡ªå‹•é¸è‚¡ç³»çµ±_bundle_20260112_2340.txt
```

======================================================================
## ğŸ“‘ æª”æ¡ˆç´¢å¼•

| å±¤ç´š | æª”æ¡ˆ | èªªæ˜ | é‡è¦åº¦ |
|------|------|------|--------|
| ğŸ“‹ | `CHANGELOG.md` | Changelog | â­â­â­ |
| ğŸ“‹ | `docs/20260112-000-readme.md` | ğŸš€ SELA æ›´æ–°åŒ… - 20260112 | â­â­â­ |
| ğŸ“‹ | `docs/20260112-001-settings-ui.md` | ğŸ“‹ è¨­å®šé é¢ UI æ›´æ–° | â­â­â­ |
| ğŸ“‹ | `docs/20260112-002-taiwan-stocks-fix.md` | ğŸ”§ å°è‚¡åç¨±ç·¨ç¢¼ä¿®å¾© | â­â­â­ |
| ğŸ“‹ | `docs/20260112-003-stock-search-fix.md` | ğŸ”§ è‚¡ç¥¨æœå°‹ä¿®å¾©ï¼šBRK.Bã€FIG ç­‰å•é¡Œ | â­â­â­ |
| ğŸ“‹ | `docs/20260112-005-feature-specs.md` | ğŸš€ SELA ç³»çµ±åŠŸèƒ½è¦åŠƒæ›¸ | â­â­â­ |
| ğŸ“‹ | `docs/stock-analysis-system-spec.md` | ğŸ“ˆ å¤šç”¨æˆ¶é¸è‚¡åˆ†æç³»çµ± - é–‹ç™¼è¦æ ¼æ›¸ | â­â­â­ |
| ğŸ“‹ | `docs/æ•´åˆæŒ‡å—.md` | ğŸ› ï¸ SELA è¨­å®šé é¢ UI - æ•´åˆæŒ‡å— | â­â­â­ |
| ğŸ“‹ | `README.md` | ğŸš€ åƒ¹æ ¼å¿«å–åŠŸèƒ½ - å®Œæ•´æ•´åˆåŒ… | â­â­â­ |
| âš™ï¸ | `app/config.py` | æ‡‰ç”¨ç¨‹å¼è¨­å®šæª” | â­â­ |
| âš™ï¸ | `app/routers/settings.py` | è¨­å®šç®¡ç† API è·¯ç”± | â­â­ |
| âš™ï¸ | `Procfile` |  | â­â­ |
| âš™ï¸ | `requirements.txt` | Core Framework | â­â­â­ |
| ğŸš€ | `app/main.py` | FastAPI ä¸»ç¨‹å¼ | â­â­â­ |
| ğŸŒ | `app/routers/__init__.py` | API è·¯ç”±æ¨¡çµ„ | â­â­â­ |
| ğŸŒ | `app/routers/admin.py` | ç®¡ç†å“¡ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/auth.py` | èªè­‰ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/compare.py` | å ±é…¬ç‡æ¯”è¼ƒ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/crypto.py` | åŠ å¯†è²¨å¹£å’Œå¸‚å ´æƒ…ç·’ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/market.py` | å¸‚å ´è³‡æ–™ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/stock.py` | è‚¡ç¥¨æŸ¥è©¢ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/stock_patch.py` | stock.py ä¿®å¾©è£œä¸ | â­â­â­ |
| ğŸŒ | `app/routers/watchlist.py` | è¿½è¹¤æ¸…å–® API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/watchlist_cache_api.py` | è¿½è¹¤æ¸…å–® API - å«åƒ¹æ ¼å¿«å–ç‰ˆæœ¬ | â­â­â­ |
| ğŸ“¦ | `app/database.py` | è³‡æ–™åº«é€£ç·šèˆ‡ Session ç®¡ç† | â­â­ |
| ğŸ“¦ | `app/models/__init__.py` | è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/comparison.py` | å ±é…¬ç‡æ¯”è¼ƒçµ„åˆ Model | â­â­ |
| ğŸ“¦ | `app/models/crypto_price.py` | åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/dividend_history.py` | è‚¡ç¥¨é…æ¯æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/index_price.py` | å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/market_sentiment.py` | å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/notification.py` | é€šçŸ¥è¨˜éŒ„è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/price_cache.py` | è‚¡ç¥¨åƒ¹æ ¼å¿«å– Model | â­â­ |
| ğŸ“¦ | `app/models/stock_price.py` | è‚¡ç¥¨åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/user.py` | ç”¨æˆ¶è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/user_settings.py` | ç”¨æˆ¶è¨­å®šè³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/watchlist.py` | è¿½è¹¤æ¸…å–®è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/schemas/__init__.py` | Pydantic Schemas | â­â­ |
| ğŸ“¦ | `app/schemas/schemas.py` | Pydantic Schemas | â­â­ |
| ğŸ§  | `app/services/__init__.py` | å•†æ¥­é‚è¼¯æœå‹™æ¨¡çµ„ | â­â­â­ |
| ğŸ§  | `app/services/auth_service.py` | èªè­‰æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/chart_service.py` | åœ–è¡¨ç¹ªè£½æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/compare_service.py` | å ±é…¬ç‡æ¯”è¼ƒæœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/compare_service_patch.py` | compare_service.py å°è‚¡åç¨±ä¿®å¾©è£œä¸ | â­â­â­ |
| ğŸ§  | `app/services/crypto_service.py` | åŠ å¯†è²¨å¹£æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/indicator_service.py` | æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/line_notify_service.py` | LINE Messaging API æ¨æ’­æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/market_service.py` | å¸‚å ´æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/notification_service.py` | é€šçŸ¥ç®¡ç†æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/price_cache_service.py` | Ã¥Æ’Â¹Ã¦Â Â¼Ã¥Â¿Â«Ã¥Ââ€“Ã¦Å“ÂÃ¥â€¹â„¢ | â­â­â­ |
| ğŸ§  | `app/services/signal_service.py` | è¨Šè™Ÿåµæ¸¬æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/stock_service.py` | è‚¡ç¥¨æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/watchlist_service.py` | è¿½è¹¤æ¸…å–®æœå‹™ (Async ç‰ˆæœ¬) | â­â­â­ |
| ğŸ¨ | `frontend/watchlist_with_cache.js` | ========== è¿½è¹¤æ¸…å–® - ä½¿ç”¨å¿«å–ç‰ˆæœ¬ ========== | â­ |
| ğŸ¨ | `static/admin.html` |  | â­ |
| ğŸ¨ | `static/compare-nav.js` | * | â­ |
| ğŸ¨ | `static/compare.html` |  | â­ |
| ğŸ¨ | `static/css/settings.css` | * | â­ |
| ğŸ¨ | `static/dashboard-mobile.html` |  | â­ |
| ğŸ¨ | `static/dashboard.html` |  | â­ |
| ğŸ¨ | `static/index.html` |  | â­ |
| ğŸ¨ | `static/js/settings.js` | * | â­ |
| ğŸ¨ | `static/SELA-Bugä¿®å¾©è¨˜éŒ„.md` | SELA é¸è‚¡ç³»çµ± - Bug ä¿®å¾©è¨˜éŒ„ | â­ |
| ğŸ¨ | `static/settings-section.html` |  | â­ |
| ğŸ“ | `app/__init__.py` | Stock Analysis System | â­ |
| ğŸ“ | `app/cli.py` | è‚¡ç¥¨åˆ†æç³»çµ± CLI | â­ |
| ğŸ“ | `app/data_sources/__init__.py` | å¤–éƒ¨è³‡æ–™ä¾†æºæ¨¡çµ„ | â­ |
| ğŸ“ | `app/data_sources/coingecko.py` | CoinGecko API è³‡æ–™ä¾†æº | â­ |
| ğŸ“ | `app/data_sources/fear_greed.py` | å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™ä¾†æº | â­ |
| ğŸ“ | `app/data_sources/taiwan_stocks.py` | å°è‚¡åç¨±å°ç…§è¡¨ | â­ |
| ğŸ“ | `app/data_sources/yahoo_finance.py` | Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â ÃƒÂ¦Ã‚ÂºÃ‚Â | â­ |
| ğŸ“ | `app/logging_config.py` | æ—¥èªŒè¨­å®š | â­ |
| ğŸ“ | `app/tasks/__init__.py` | æ’ç¨‹ä»»å‹™æ¨¡çµ„ | â­ |
| ğŸ“ | `app/tasks/price_cache_task.py` | åƒ¹æ ¼å¿«å–æ’ç¨‹ä»»å‹™ | â­ |
| ğŸ“ | `app/tasks/scheduler.py` | æ’ç¨‹ä»»å‹™æœå‹™ | â­ |
| ğŸ“ | `dashboard-patch-example.html` |  | â­ |
| ğŸ“ | `fixes/taiwan_stock_names_fix.py` | ============================================================ | â­ |
| ğŸ“ | `railway.json` |  | â­ |
| ğŸ“ | `RAILWAY_SETUP.md` | Railway PostgreSQL è¨­å®šæŒ‡å— | â­ |
| ğŸ“ | `runtime.txt` |  | â­ |
| ğŸ“ | `scripts/åŒ¯æ•´å­ç¨‹å¼.py` | å°ˆæ¡ˆæ•´åˆå·¥å…· - æŠŠè³‡æ–™å¤¾çµæ§‹å’Œç¨‹å¼ç¢¼æ•´åˆæˆå–®ä¸€æª”æ¡ˆ | â­ |
| ğŸ“ | `åŒ¯æ•´å°ˆæ¡ˆ V2 .py` | å°ˆæ¡ˆæ•´åˆå·¥å…· v2 - æ™ºèƒ½åˆ†å±¤æ•´ç† | â­ |


======================================================================
## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ CHANGELOG.md  â­â­â­
> Changelog
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# Changelog

æ‰€æœ‰é‡è¦çš„è®Šæ›´éƒ½æœƒè¨˜éŒ„åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚

æ ¼å¼åŸºæ–¼ [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/)ï¼Œ
ç‰ˆæœ¬è™Ÿéµå¾ª [Semantic Versioning](https://semver.org/lang/zh-TW/)ã€‚

## [Unreleased]

### Planned
- Phase 5: éŒ¯èª¤å›å ±ç³»çµ±
- Phase 6: æœƒå“¡æ¬Šé™ç³»çµ±

## [0.8.2] - 2025-01-08

### Added
- **è¨Šè™Ÿåµæ¸¬å¼•æ“ (signal_service.py)**
  - å‡ç·šè¨Šè™Ÿï¼šé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€æ¥è¿‘çªç ´/è·Œç ´
  - RSI è¨Šè™Ÿï¼šè¶…è²· (>70)ã€è¶…è³£ (<30)
  - MACD è¨Šè™Ÿï¼šé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰
  - KD è¨Šè™Ÿï¼šé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰
  - å¸ƒæ—é€šé“è¨Šè™Ÿï¼šçªç ´ä¸Šè»Œã€è·Œç ´ä¸‹è»Œ
  - æˆäº¤é‡è¨Šè™Ÿï¼šé‡æ¯”æš´å¢ (>2 å€)
  - å¸‚å ´æƒ…ç·’è¨Šè™Ÿï¼šæ¥µåº¦ææ‡¼ (<20)ã€æ¥µåº¦è²ªå©ª (>80)

- **LINE æ¨æ’­é€šçŸ¥æœå‹™ (line_notify_service.py)**
  - LINE Messaging API æ•´åˆ
  - å–®ä¸€ç”¨æˆ¶æ¨æ’­ (push_text_message)
  - å¤šç”¨æˆ¶æ¨æ’­ (multicast_text_messageï¼Œæœ€å¤š 500 äºº)
  - Flex Message æ”¯æ´ï¼ˆå¡ç‰‡å¼è¨Šè™Ÿé€šçŸ¥ï¼‰
  - æ¯æ—¥è¨Šè™Ÿå½™æ•´å ±å‘Šæ ¼å¼

- **æ’ç¨‹ä»»å‹™æ•´åˆ (scheduler.py)**
  - è¨Šè™Ÿåµæ¸¬æ•´åˆåˆ°æ¯æ—¥æ›´æ–°ä»»å‹™
  - æ ¹æ“šç”¨æˆ¶è¿½è¹¤æ¸…å–®åµæ¸¬è¨Šè™Ÿ
  - æ ¹æ“šç”¨æˆ¶é€šçŸ¥è¨­å®šéæ¿¾è¨Šè™Ÿ
  - 24 å°æ™‚å…§ä¸é‡è¤‡é€šçŸ¥åŒä¸€è¨Šè™Ÿ
  - é€šçŸ¥è¨˜éŒ„å„²å­˜è‡³ notifications è¡¨

- **ç®¡ç†å¾Œå°è¨Šè™ŸåŠŸèƒ½**
  - POST /api/admin/signal/detect - æ‰‹å‹•åµæ¸¬è¨Šè™Ÿï¼ˆæ¸¬è©¦ï¼‰
  - POST /api/admin/signal/notify - æ‰‹å‹•ç™¼é€é€šçŸ¥
  - POST /api/admin/signal/test-push - æ¸¬è©¦ LINE æ¨æ’­
  - GET /api/admin/signal/status - é€šçŸ¥ç³»çµ±ç‹€æ…‹
  - GET /api/admin/notifications - é€šçŸ¥è¨˜éŒ„æŸ¥è©¢

- **ç®¡ç†å¾Œå°ç™»å…¥çµ±è¨ˆ**
  - é¡¯ç¤ºç¸½ç™»å…¥æ¬¡æ•¸
  - é¡¯ç¤ºæ¯å€‹ç”¨æˆ¶çš„ç™»å…¥æ¬¡æ•¸

### Changed
- **å¹´åŒ–å ±é…¬ç‡ç°¡åŒ–**
  - Yahoo Finance æ­·å²åƒ¹æ ¼ç‚ºé™¤æ¬Šæ¯èª¿æ•´å¾Œåƒ¹æ ¼
  - ç§»é™¤é‡è¤‡çš„ã€Œå«é…æ¯ã€ã€Œé…æ¯å†æŠ•å…¥ã€è¨ˆç®—
  - åªé¡¯ç¤ºå–®ä¸€ã€ŒCAGR (å¹´åŒ–å ±é…¬ç‡)ã€
  - å‰ç«¯ UI ç°¡åŒ–ç‚ºå¤§å­—é¡¯ç¤º CAGR
  - API å›å‚³æ¬„ä½å¾ price_return/total_return/reinvested_return æ”¹ç‚º cagr

### Fixed
- ä¿®æ­£å¹´åŒ–å ±é…¬ç‡å› ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼å°è‡´çš„é‡è¤‡è¨ˆç®—å•é¡Œ

### Added
- **Phase 3: èµ°å‹¢æ¯”è¼ƒåŠŸèƒ½**
  - æ–°å¢ã€Œèµ°å‹¢æ¯”è¼ƒã€é é¢
  - æ”¯æ´æœ€å¤š 5 æ”¯è‚¡ç¥¨/æŒ‡æ•¸åŒæ™‚æ¯”è¼ƒ
  - åƒ¹æ ¼æ­£è¦åŒ–ç‚ºèµ·å§‹æ—¥ = 100%
  - å¿«é€Ÿé¸æ“‡æŒ‰éˆ•ï¼ˆå››å¤§æŒ‡æ•¸ã€ç†±é–€ç¾è‚¡ã€å°è‚¡ã€åŠ å¯†è²¨å¹£ï¼‰
  - æ™‚é–“ç¯„åœé¸æ“‡ï¼š1M / 3M / 6M / 1Y
  - æ¯”è¼ƒçµæœè¡¨æ ¼é¡¯ç¤ºèµ·å§‹åƒ¹ã€æœ€æ–°åƒ¹ã€æ¼²è·Œå¹…
  - API: GET /api/stock/compare/history

- **Phase 4: å¹´åŒ–å ±é…¬ç‡è¨ˆç®—**
  - è‚¡ç¥¨æŸ¥è©¢çµæœæ–°å¢ã€Œå¹´åŒ–å ±é…¬ç‡ã€æŒ‰éˆ•
  - è¨ˆç®— 1Y / 3Y / 5Y / 10Y å¹´åŒ–å ±é…¬ç‡
  - ä¸‰ç¨®è¨ˆç®—æ–¹å¼ï¼š
    - åƒ¹æ ¼å ±é…¬ï¼šç´”è‚¡åƒ¹æ¼²è·Œ
    - å«é…æ¯ï¼šè‚¡åƒ¹ + é…æ¯ï¼ˆä¸å†æŠ•å…¥ï¼‰
    - é…æ¯å†æŠ•å…¥ï¼šé…æ¯ä»¥é™¤æ¯æ—¥è‚¡åƒ¹è²·å…¥æ›´å¤šè‚¡æ•¸
  - é¡¯ç¤ºé…æ¯æ¬¡æ•¸ã€å¹´å‡æ®–åˆ©ç‡
  - API: GET /api/stock/{symbol}/returns

- **å„€è¡¨æ¿æ–°å¢å°è‚¡åŠ æ¬ŠæŒ‡æ•¸**
  - æ”¯æ´ ^TWII å°ç£åŠ æ¬Šè‚¡åƒ¹æŒ‡æ•¸
  - å„€è¡¨æ¿æŒ‡æ•¸å¡ç‰‡å¾ 3 å€‹å¢åŠ åˆ° 4 å€‹
  - èµ°å‹¢æ¯”è¼ƒå¿«é€Ÿé¸æ“‡æ–°å¢å°ç©é›»ã€é´»æµ·

- **ç®¡ç†å¾Œå°ç™»å…¥çµ±è¨ˆ**
  - çµ±è¨ˆå¡ç‰‡æ–°å¢ã€Œç¸½ç™»å…¥æ¬¡æ•¸ã€
  - ç”¨æˆ¶åˆ—è¡¨æ–°å¢ã€Œç™»å…¥æ¬¡æ•¸ã€æ¬„ä½
  - API: /api/admin/stats æ–°å¢ total_logins
  - API: /api/admin/users æ–°å¢ login_count

### Fixed
- **é‡è¦ï¼šä¿®å¾©æ­·å²è‚¡åƒ¹ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼çš„å•é¡Œ**
  - yfinance é è¨­å›å‚³ auto_adjust=Trueï¼ˆé…æ¯èª¿æ•´å¾Œåƒ¹æ ¼ï¼‰
  - æ”¹ç‚º auto_adjust=False å–å¾—åŸå§‹æ”¶ç›¤åƒ¹
  - å½±éŸ¿ï¼šå¹´åŒ–å ±é…¬ç‡ã€æ®–åˆ©ç‡è¨ˆç®—ç¾åœ¨ä½¿ç”¨æ­£ç¢ºçš„æ­·å²åƒ¹æ ¼
- ä¿®å¾©æŒ‡æ•¸æ­·å² API çš„ NaN å€¼ JSON åºåˆ—åŒ–éŒ¯èª¤
- IndexPrice model to_dict() åŠ å…¥ NaN/Infinity æª¢æŸ¥
- market_service save_index_data() å„²å­˜å‰æ¸…ç†ç„¡æ•ˆæ•¸å€¼
- ä¿®å¾©èµ°å‹¢æ¯”è¼ƒåœ–è¡¨éœ€è¦ chartjs-adapter-date-fns
- ä¿®å¾©å¹´åŒ–å ±é…¬ç‡ yearly_detail è®Šæ•¸æœªå®šç¾©éŒ¯èª¤

## [0.7.0] - 2025-01-07

### Added
- **Phase 2: å‰ç«¯é¡¯ç¤ºåŠŸèƒ½**
  - å„€è¡¨æ¿é ‚éƒ¨ä¸‰å¤§æŒ‡æ•¸å¡ç‰‡ï¼ˆS&P 500ã€é“ç“Šå·¥æ¥­ã€ç´æ–¯é”å…‹ï¼‰
  - é»æ“ŠæŒ‡æ•¸å¡ç‰‡é–‹å•Ÿå…¨è¢å¹•èµ°å‹¢åœ–ï¼ˆModal è¦–çª—ï¼‰
  - æŒ‡æ•¸èµ°å‹¢æ”¯æ´ 1M/3M/1Y/5Y æ™‚é–“ç¯„åœåˆ‡æ›
  - ææ‡¼è²ªå©ªæŒ‡æ•¸é»æ“Šé–‹å•Ÿå…¨è¢å¹•æ­·å²èµ°å‹¢åœ–
  - æƒ…ç·’èµ°å‹¢æ”¯æ´ 1M/3M/6M/1Y æ™‚é–“ç¯„åœåˆ‡æ›
  - **ç®¡ç†å¾Œå°å¸‚å ´è³‡æ–™ç®¡ç†å€å¡Š**
    - åˆå§‹åŒ–æ­·å²è³‡æ–™æŒ‰éˆ•
    - æ›´æ–°ä¸‰å¤§æŒ‡æ•¸æŒ‰éˆ•
    - æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸æŒ‰éˆ•
    - åŸ·è¡Œæ¯æ—¥æ›´æ–°æŒ‰éˆ•

### Changed
- ã€Œæƒ…ç·’æŒ‡æ•¸ã€æ›´åç‚ºã€Œææ‡¼è²ªå©ªæŒ‡æ•¸ã€
- åœ–è¡¨æ”¹ç‚º Modal å…¨è¢å¹•é¡¯ç¤ºï¼Œè§£æ±ºå¡ç‰‡å…§åµŒé¡¯ç¤ºå•é¡Œ
- åœ–è¡¨é‚Šè·å¢åŠ ï¼Œæ”¹å–„è§¸æ§é«”é©—

### Fixed
- ä¿®å¾© get_latest_indices å›å‚³æ ¼å¼ï¼ˆList â†’ Dictï¼‰
- åŠ å¼·è³‡æ–™åº«éŒ¯èª¤è™•ç†ï¼Œè‡ªå‹• fallback åˆ° Yahoo Finance API
- ä¿®å¾©æŒ‡æ•¸/æƒ…ç·’èµ°å‹¢åœ–ç„¡æ³•æ­£å¸¸é¡¯ç¤ºçš„å•é¡Œ

## [0.6.1] - 2025-01-07

### Fixed
- **ç”¨æˆ¶èº«ä»½é©—è­‰å¼·åŒ–**
  - ç™»å…¥æ™‚æ¸…é™¤æ‰€æœ‰èˆŠçš„ localStorage/sessionStorage è³‡æ–™ï¼Œé¿å… A ç”¨æˆ¶çœ‹åˆ° B ç”¨æˆ¶è³‡æ–™
  - JWT Token é©—è­‰å¢åŠ  LINE ID ä¸€è‡´æ€§æª¢æŸ¥
  - å‰ç«¯ checkAuth å¢åŠ æœ¬åœ°èˆ‡ä¼ºæœå™¨ç”¨æˆ¶ ID æ¯”å°
  - æ‰€æœ‰ API è«‹æ±‚æ”¹ç”¨çµ±ä¸€çš„ apiRequest å‡½æ•¸ï¼Œè‡ªå‹•å¸¶å…¥é©—è­‰
  - **UserResponse schema åŠ å…¥ is_admin æ¬„ä½**ï¼ˆä¿®å¾©ç®¡ç†å“¡æ¬Šé™æ¶ˆå¤±å•é¡Œï¼‰

- **è¿½è¹¤æ¸…å–®å®‰å…¨æ€§**
  - è¿½è¹¤æ¸…å–®åˆªé™¤æ™‚å¢åŠ  user_id äºŒæ¬¡é©—è­‰
  - æ‰€æœ‰è¿½è¹¤æ¸…å–®æ“ä½œåŠ å…¥è©³ç´° log è¨˜éŒ„
  - å‰ç«¯æ“ä½œå‰æª¢æŸ¥ currentUser æ˜¯å¦å­˜åœ¨

- **æ—¥èªŒç³»çµ±å¼·åŒ–**
  - æ–°å¢ logging_config.py çµ±ä¸€æ—¥èªŒè¨­å®š
  - èªè­‰æœå‹™ (auth_service) å®Œæ•´ç™»å…¥æµç¨‹ log
  - è¿½è¹¤æ¸…å–®æœå‹™ (watchlist_service) æ“ä½œ log
  - æ—¥èªŒæª”æ¡ˆæŒ‰æ—¥æœŸåˆ†é¡å­˜æ”¾æ–¼ logs/ ç›®éŒ„
  - åˆ†é›¢ authã€watchlist å°ˆç”¨æ—¥èªŒæª”

### Changed
- auth_service.py: login_with_line() åŠ å…¥å®Œæ•´ log è¨˜éŒ„
- auth_service.py: get_user_from_token() åŠ å…¥ LINE ID ä¸€è‡´æ€§é©—è­‰
- watchlist_service.py: æ‰€æœ‰æ“ä½œåŠ å…¥è©³ç´° log
- watchlist.py router: æ‰€æœ‰ç«¯é»åŠ å…¥ log è¨˜éŒ„
- dashboard.html: æ–°å¢ apiRequest() çµ±ä¸€ API è«‹æ±‚å‡½æ•¸
- dashboard.html: æ–°å¢ clearAllUserData() æ¸…é™¤ç”¨æˆ¶è³‡æ–™å‡½æ•¸
- main.py: ä½¿ç”¨ logging_config.py åˆå§‹åŒ–æ—¥èªŒç³»çµ±
- schemas.py: UserResponse åŠ å…¥ is_admin æ¬„ä½

### Added
- app/logging_config.py: æ—¥èªŒè¨­å®šæ¨¡çµ„

## [0.6.0] - 2025-01-07

### Added
- **è³‡æ–™åŸºç¤å»ºè¨­ (Phase 1)**
  - ä¸‰å¤§æŒ‡æ•¸æ”¯æ´
    - S&P 500 (^GSPC)
    - é“ç“Šå·¥æ¥­ (^DJI)
    - ç´æ–¯é”å…‹ (^IXIC)
    - IndexPrice è³‡æ–™æ¨¡å‹
    - 10 å¹´æ­·å²è³‡æ–™æ”¯æ´
  - é…æ¯è³‡æ–™
    - DividendHistory è³‡æ–™æ¨¡å‹
    - yfinance é…æ¯æŠ“å–
  - æƒ…ç·’æŒ‡æ•¸æ­·å²
    - å¹£åœˆæƒ…ç·’ 365 å¤©æ­·å²æŠ“å–
    - ç¾è‚¡æƒ…ç·’æ¯æ—¥ç´¯ç©
  - æ’ç¨‹ä»»å‹™æœå‹™ (scheduler.py)
    - æ¯æ—¥è‡ªå‹•æ›´æ–°è‚¡åƒ¹
    - æ¯æ—¥æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
    - æ¯æ—¥æ›´æ–°å¸‚å ´æƒ…ç·’
    - åˆå§‹åŒ–æ­·å²è³‡æ–™åŠŸèƒ½
  - å¸‚å ´æœå‹™ (market_service.py)
    - æŒ‡æ•¸è³‡æ–™å­˜å–
    - æƒ…ç·’è³‡æ–™å­˜å–
    - é…æ¯è³‡æ–™å­˜å–
  - å¸‚å ´ API ç«¯é» (/api/market)
    - GET /indices - å–å¾—ä¸‰å¤§æŒ‡æ•¸
    - GET /indices/{symbol}/history - æŒ‡æ•¸æ­·å²
    - GET /sentiment - å¸‚å ´æƒ…ç·’
    - GET /sentiment/{market}/history - æƒ…ç·’æ­·å²
    - POST /admin/update - æ‰‹å‹•è§¸ç™¼æ›´æ–°
    - POST /admin/initialize - åˆå§‹åŒ–æ­·å²è³‡æ–™
    - POST /admin/update-indices - æ›´æ–°æŒ‡æ•¸
    - POST /admin/update-sentiment - æ›´æ–°æƒ…ç·’
    - POST /admin/init-crypto-sentiment - åˆå§‹åŒ–å¹£åœˆæƒ…ç·’

### Changed
- stock_service.py æ”¯æ´ 10 å¹´æ­·å²è³‡æ–™
- yahoo_finance.py æ–°å¢æŒ‡æ•¸å’Œé…æ¯æŠ“å–æ–¹æ³•
- fear_greed.py æ–°å¢æ­·å²è³‡æ–™æŠ“å–

## [0.5.3] - 2025-01-06

### Fixed
- å¯æŠ˜ç–ŠæŒ‡æ¨™å€å¡Šåœ¨æ¡Œé¢ç‰ˆç„¡æ³•é‹ä½œ
- è¿½è¹¤æ¸…å–®ç¼ºå°‘å³æ™‚åƒ¹æ ¼è³‡è¨Š
- æ¨¡æ¿é¸æ“‡ç„¡è¦–è¦ºå›é¥‹
- è¨­å®šé é¢é¡¯ç¤º LINE IDï¼ˆéš±ç§å•é¡Œï¼‰

### Changed
- è¿½è¹¤æ¸…å–®å¡ç‰‡å¢åŠ å³æ™‚åƒ¹æ ¼å’Œæ¼²è·Œå¹…
- æ¨¡æ¿æŒ‰éˆ•é¸ä¸­ç‹€æ…‹æ¨£å¼
- è¨­å®šé é¢æ”¹é¡¯ç¤ºæœƒå“¡ç­‰ç´š

## [0.3.0] - 2025-01-05

### Added
- ç”¨æˆ¶ç³»çµ±
  - LINE Login æ•´åˆ
  - JWT Token èªè­‰
  - ç”¨æˆ¶è³‡æ–™ç®¡ç†
- è¿½è¹¤æ¸…å–®åŠŸèƒ½
  - æ–°å¢/ç§»é™¤è¿½è¹¤æ¨™çš„
  - è‡ªè¨‚å‚™è¨»
  - è¿½è¹¤æ¸…å–®ç¸½è¦½ (å«å³æ™‚åƒ¹æ ¼)
- å€‹äººåŒ–è¨­å®š
  - æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
  - é€šçŸ¥è¨­å®š
  - æŒ‡æ¨™åƒæ•¸èª¿æ•´
  - é è¨­æ¨¡æ¿ (æ¥µç°¡/æ¨™æº–/å®Œæ•´/çŸ­ç·š)
- FastAPI Web API
  - èªè­‰è·¯ç”± (/auth)
  - è‚¡ç¥¨æŸ¥è©¢ (/api/stock)
  - åŠ å¯†è²¨å¹£æŸ¥è©¢ (/api/crypto)
  - è¿½è¹¤æ¸…å–®ç®¡ç† (/api/watchlist)
  - è¨­å®šç®¡ç† (/api/settings)
  - å¸‚å ´æƒ…ç·’ (/api/market/sentiment)
  - Swagger æ–‡ä»¶ (/docs)
- è³‡æ–™æ¨¡å‹
  - User (ç”¨æˆ¶)
  - Watchlist (è¿½è¹¤æ¸…å–®)
  - UserIndicatorSettings (æŒ‡æ¨™è¨­å®š)
  - UserAlertSettings (é€šçŸ¥è¨­å®š)
  - UserIndicatorParams (åƒæ•¸è¨­å®š)
  - Notification (é€šçŸ¥è¨˜éŒ„)

## [0.2.0] - 2025-01-05

### Added
- åœ–è¡¨ç¹ªè£½æœå‹™ (chart_service.py)
  - åƒ¹æ ¼èµ°å‹¢åœ– + å‡ç·š + å¸ƒæ—é€šé“
  - æˆäº¤é‡æŸ±ç‹€åœ–
  - RSIã€MACDã€KD å­åœ–
  - å‡ç·šäº¤å‰é»æ¨™è¨˜
  - Kç·šåœ–æ”¯æ´
- åŠ å¯†è²¨å¹£æ”¯æ´
  - CoinGecko API æ•´åˆ
  - BTCã€ETH åƒ¹æ ¼è¿½è¹¤
  - å¹£åœˆæŠ€è¡“æŒ‡æ¨™ (MA7/25/99)
- å¸‚å ´æƒ…ç·’æŒ‡æ•¸
  - CNN Fear & Greed Index (ç¾è‚¡)
  - Alternative.me (åŠ å¯†è²¨å¹£)
- CLI æ–°å¢æŒ‡ä»¤
  - `sentiment` - æŸ¥è©¢å¸‚å ´æƒ…ç·’
  - `chart` - ç”ŸæˆæŠ€è¡“åˆ†æåœ–è¡¨
  - æ”¯æ´åŠ å¯†è²¨å¹£æŸ¥è©¢ (BTC, ETH)

### Changed
- CLI äº’å‹•æ¨¡å¼æç¤ºç¬¦æ”¹ç‚º `ä»£è™Ÿ>`
- æ”¯æ´åŒæ™‚æŸ¥è©¢è‚¡ç¥¨å’ŒåŠ å¯†è²¨å¹£

## [0.1.0] - 2025-01-05

### Added
- å°ˆæ¡ˆåˆå§‹åŒ–
- Yahoo Finance è‚¡åƒ¹è³‡æ–™æŠ“å–
- SQLite æœ¬åœ°å¿«å–æ©Ÿåˆ¶
- æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“
  - ç§»å‹•å¹³å‡ç·š (MA20, MA50, MA200)
  - RSI ç›¸å°å¼·å¼±æŒ‡æ¨™
  - MACD æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡
  - KD éš¨æ©ŸæŒ‡æ¨™
  - å¸ƒæ—é€šé“
  - OBV èƒ½é‡æ½®æŒ‡æ¨™
  - æˆäº¤é‡åˆ†æ
- è¨Šè™Ÿåµæ¸¬ç³»çµ±
  - å‡ç·šé»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰
  - æ¥è¿‘çªç ´/è·Œç ´é è­¦
  - RSI è¶…è²·è¶…è³£
  - MACD/KD äº¤å‰
- ç¶œåˆè©•åˆ†ç³»çµ±
- CLI å‘½ä»¤åˆ—æŸ¥è©¢ä»‹é¢
  - äº’å‹•æ¨¡å¼
  - å–®æ¬¡æŸ¥è©¢æŒ‡ä»¤
  - å¼·åˆ¶æ›´æ–°é¸é …
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260112-000-readme.md  â­â­â­
> ğŸš€ SELA æ›´æ–°åŒ… - 20260112
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸš€ SELA æ›´æ–°åŒ… - 20260112

> ç™¼å¸ƒæ—¥æœŸ: 2026-01-12  
> ç‰ˆæœ¬: v0.9.1

---

## ğŸ“¦ ç›®éŒ„çµæ§‹

```
sela-update-20260112/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ data_sources/
â”‚   â”‚   â””â”€â”€ taiwan_stocks.py          # å°è‚¡åç¨±å­—å…¸ï¼ˆå‚™ç”¨ï¼‰
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ compare_service_patch.py  # compare_service.py ä¿®æ”¹èªªæ˜
â”‚   â””â”€â”€ routers/
â”‚       â””â”€â”€ stock_patch.py            # stock.py ä¿®æ”¹èªªæ˜
â”œâ”€â”€ fixes/
â”‚   â””â”€â”€ taiwan_stock_names_fix.py     # â­ æ­£ç¢ºçš„ TAIWAN_STOCK_NAMES å­—å…¸
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ settings.css              # è¨­å®šé é¢æ¨£å¼
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â””â”€â”€ settings.js               # è¨­å®šé é¢é‚è¼¯
â”‚   â””â”€â”€ settings-section.html         # è¨­å®šé é¢ HTML
â””â”€â”€ docs/
    â”œâ”€â”€ 20260112-000-readme.md        # æœ¬æ–‡ä»¶
    â”œâ”€â”€ 20260112-001-settings-ui.md   # è¨­å®šé é¢èªªæ˜
    â”œâ”€â”€ 20260112-002-taiwan-stocks-fix.md  # â­ å°è‚¡åç¨±ä¿®å¾©ï¼ˆç·Šæ€¥ï¼‰
    â””â”€â”€ 20260112-003-stock-search-fix.md   # BRK.B/FIG æœå°‹ä¿®å¾©
```

---

## ğŸ“‹ æ›´æ–°æ¸…å–®

| ç·¨è™Ÿ | é¡å‹ | èªªæ˜ | å„ªå…ˆç´š |
|------|------|------|--------|
| 001 | æ–°åŠŸèƒ½ | è¨­å®šé é¢ UI | P0 |
| 002 | Bug | å°è‚¡åç¨±äº‚ç¢¼ | é«˜ |
| 003 | Bug | BRK.B/FIG æœå°‹å¤±æ•— | ä¸­ |

---

### 1ï¸âƒ£ è¨­å®šé é¢ UIï¼ˆæ–°åŠŸèƒ½ï¼‰

**æª”æ¡ˆï¼š** `static/css/settings.css`, `static/js/settings.js`, `static/settings-section.html`

**åŠŸèƒ½ï¼š**
- å¿«é€Ÿæ¨¡æ¿ï¼ˆæ¥µç°¡/æ¨™æº–/å®Œæ•´/çŸ­ç·šï¼‰
- æŒ‡æ¨™é¡¯ç¤ºé–‹é—œï¼ˆ7 ç¨®ï¼‰
- é€šçŸ¥è¨­å®šé–‹é—œï¼ˆ8 ç¨®ï¼‰
- é€²éšåƒæ•¸èª¿æ•´ï¼ˆ14 ç¨®ï¼‰

**è©³ç´°èªªæ˜ï¼š** `20260112-001-settings-ui.md`

---

### 2ï¸âƒ£ å°è‚¡åç¨±ç·¨ç¢¼ä¿®å¾©ï¼ˆBug Fixï¼‰âš ï¸ ç·Šæ€¥

**å•é¡Œæ ¹æºï¼š** Bundle ä¸­çš„ `TAIWAN_STOCK_NAMES` å­—å…¸å·²ç¶“æ˜¯äº‚ç¢¼ï¼

**éœ€è¦ä¿®å¾©çš„æª”æ¡ˆï¼š**
- `app/data_sources/yahoo_finance.py` - ä¸»è¦
- `app/services/price_cache_service.py` - æ¬¡è¦

**è§£æ±ºï¼š** ç”¨æ­£ç¢º UTF-8 ç·¨ç¢¼çš„å­—å…¸æ›¿æ›ç¾æœ‰çš„äº‚ç¢¼å­—å…¸

**åƒè€ƒï¼š** `fixes/taiwan_stock_names_fix.py` åŒ…å«æ­£ç¢ºçš„å­—å…¸å…§å®¹

**è©³ç´°èªªæ˜ï¼š** `20260112-002-taiwan-stocks-fix.md`

---

### 3ï¸âƒ£ è‚¡ç¥¨æœå°‹ä¿®å¾©ï¼ˆBug Fixï¼‰

**ä¿®æ”¹æª”æ¡ˆï¼š** `app/routers/stock.py`  
**åƒè€ƒï¼š** `app/routers/stock_patch.py`

**å•é¡Œï¼š**
- BRK.B ç­‰å« `.` çš„è‚¡ç¥¨ä»£ç¢¼æœå°‹å¤±æ•—ï¼ˆURL è§£æå•é¡Œ + æ ¼å¼å•é¡Œï¼‰
- FIG ç­‰æ–° IPO è‚¡ç¥¨å› ç¼ºå°‘ 10 å¹´æ­·å²æ•¸æ“šè€Œå¤±æ•—

**è§£æ±ºï¼š**
1. è·¯ç”±æ”¹ç”¨ `{symbol:path}` æ”¯æ´å«é»è™Ÿä»£ç¢¼
2. è‡ªå‹•å˜—è©¦ `.` å’Œ `-` å…©ç¨®æ ¼å¼ï¼ˆBRK.B â†” BRK-Bï¼‰
3. å‹•æ…‹å˜—è©¦ä¸åŒæœŸé–“ï¼ˆ10y â†’ 5y â†’ 2y â†’ 1y â†’ 6mo â†’ 3moï¼‰

**è©³ç´°èªªæ˜ï¼š** `20260112-003-stock-search-fix.md`

---

## ğŸ› ï¸ å¿«é€Ÿéƒ¨ç½²

```bash
# 1. è§£å£“ç¸®
unzip sela-update-20260112.zip
cd sela-update-20260112

# 2. è¤‡è£½æ–°æª”æ¡ˆ
cp app/data_sources/taiwan_stocks.py /ä½ çš„å°ˆæ¡ˆ/app/data_sources/
cp static/css/settings.css /ä½ çš„å°ˆæ¡ˆ/static/css/
cp static/js/settings.js /ä½ çš„å°ˆæ¡ˆ/static/js/

# 3. ä¾ç…§ docs/ ä¸­çš„èªªæ˜ä¿®æ”¹ç¾æœ‰æª”æ¡ˆ
# - dashboard.html (è¨­å®šé é¢) â†’ è¦‹ 20260112-001
# - compare_service.py (å°è‚¡åç¨±) â†’ è¦‹ 20260112-002
# - stock.py (BRK.B/FIG æœå°‹) â†’ è¦‹ 20260112-003

# 4. é‡æ–°éƒ¨ç½²
git add .
git commit -m "æ›´æ–° v0.9.1"
git push
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. å‚™ä»½ç¾æœ‰æª”æ¡ˆå†è¦†è“‹
2. éœ€è¦æ‰‹å‹•ä¿®æ”¹ `dashboard.html`ã€`compare_service.py`ã€`stock.py`
3. è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ `docs/` ç›®éŒ„ä¸­çš„èªªæ˜æ–‡ä»¶
4. æ‰€æœ‰ Python æª”æ¡ˆå¿…é ˆä½¿ç”¨ UTF-8 ç·¨ç¢¼å„²å­˜
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260112-001-settings-ui.md  â­â­â­
> ğŸ“‹ è¨­å®šé é¢ UI æ›´æ–°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ“‹ è¨­å®šé é¢ UI æ›´æ–°

> æ–‡ä»¶ç·¨è™Ÿ: 20260112-001  
> æ›´æ–°æ—¥æœŸ: 2026-01-12  
> é¡å‹: æ–°åŠŸèƒ½

---

## ğŸ“¦ æ›´æ–°å…§å®¹

æ–°å¢ç”¨æˆ¶è¨­å®šé é¢ UIï¼ŒåŒ…å«ï¼š
- å¿«é€Ÿæ¨¡æ¿ï¼ˆæ¥µç°¡/æ¨™æº–/å®Œæ•´/çŸ­ç·šï¼‰
- æŒ‡æ¨™é¡¯ç¤ºé–‹é—œï¼ˆ7 ç¨®æŠ€è¡“æŒ‡æ¨™ï¼‰
- é€šçŸ¥è¨­å®šé–‹é—œï¼ˆ8 ç¨® LINE æ¨æ’­è­¦å ±ï¼‰
- é€²éšåƒæ•¸èª¿æ•´ï¼ˆ14 ç¨®å¯è‡ªè¨‚åƒæ•¸ï¼‰

---

## ğŸ“ æ–°å¢æª”æ¡ˆ

| æª”æ¡ˆ | ä½ç½® | èªªæ˜ |
|------|------|------|
| `settings.css` | `static/css/` | è¨­å®šé é¢æ¨£å¼ |
| `settings.js` | `static/js/` | è¨­å®šé é¢é‚è¼¯ |
| `settings-section.html` | `static/` | HTML ç‰‡æ®µ |

---

## ğŸš€ æ•´åˆæ­¥é©Ÿ

### 1. è¤‡è£½æª”æ¡ˆ

```bash
cp static/css/settings.css /ä½ çš„å°ˆæ¡ˆ/static/css/
cp static/js/settings.js /ä½ çš„å°ˆæ¡ˆ/static/js/
```

### 2. ä¿®æ”¹ dashboard.html

#### åœ¨ `<head>` åŠ å…¥ï¼š
```html
<link rel="stylesheet" href="/static/css/settings.css">
```

#### åœ¨ `</body>` å‰åŠ å…¥ï¼š
```html
<script src="/static/js/settings.js"></script>
```

#### åŠ å…¥ HTML sectionï¼š
å°‡ `settings-section.html` å…§å®¹è²¼åˆ°å…¶ä»– section ä¹‹å¾Œ

#### åŠ å…¥å°èˆªé€£çµï¼š

**æ¡Œé¢ç‰ˆï¼š**
```html
<a onclick="showSection('settings', event)" class="nav-link ...">
    <i class="fas fa-cog mr-2"></i>è¨­å®š
</a>
```

**æ‰‹æ©Ÿç‰ˆï¼š**
```html
<button onclick="showSection('settings', event)" class="nav-tab ...">
    <i class="fas fa-cog text-lg"></i>
    <span class="text-xs mt-1">è¨­å®š</span>
</button>
```

### 3. ä¿®æ”¹ showSection å‡½æ•¸

```javascript
if (name === 'settings') {
    if (typeof initSettingsPage === 'function') {
        initSettingsPage();
    }
}
```

---

## ğŸ”§ API ä¾è³´

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/settings/indicators` | GET/PUT | æŒ‡æ¨™é¡¯ç¤ºè¨­å®š |
| `/api/settings/alerts` | GET/PUT | é€šçŸ¥è¨­å®š |
| `/api/settings/params` | GET/PUT | åƒæ•¸è¨­å®š |
| `/api/settings/template/{name}` | POST | å¥—ç”¨æ¨¡æ¿ |

---

## âœ… é©—è­‰

1. å¯åˆ‡æ›åˆ°è¨­å®šé é¢
2. è¨­å®šæ­£å¸¸è¼‰å…¥
3. è¨­å®šå¯å„²å­˜
4. æ¨¡æ¿å¯å¥—ç”¨
5. æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæ­£å¸¸
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260112-002-taiwan-stocks-fix.md  â­â­â­
> ğŸ”§ å°è‚¡åç¨±ç·¨ç¢¼ä¿®å¾©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ å°è‚¡åç¨±ç·¨ç¢¼ä¿®å¾©

> æ–‡ä»¶ç·¨è™Ÿ: 20260112-002  
> æ›´æ–°æ—¥æœŸ: 2026-01-12  
> é¡å‹: Bug ä¿®å¾©  
> å„ªå…ˆç´š: **ç·Šæ€¥**

---

## ğŸ”´ å•é¡Œæ ¹æºï¼ˆé‡è¦ï¼ï¼‰

**Bundle æ–‡ä»¶ä¸­çš„ `TAIWAN_STOCK_NAMES` å­—å…¸å·²ç¶“æ˜¯äº‚ç¢¼ï¼**

é€™ä¸æ˜¯ compare_service.py çš„å•é¡Œï¼Œè€Œæ˜¯åŸå§‹æª”æ¡ˆä¸­çš„ä¸­æ–‡è¢«ç ´å£äº†ï¼š

```python
# yahoo_finance.py ä¸­ç¾åœ¨çš„ç‹€æ…‹ï¼ˆå·²æå£ï¼‰:
"2330": "ÃƒÂ¥Ã‚Ã‚Â°ÃƒÂ§Ã‚Â©Ã‚ÃƒÂ©Ã¢â‚¬ÂºÃ‚Â»",  # æ‡‰è©²æ˜¯ã€Œå°ç©é›»ã€

# price_cache_service.py ä¸­ç¾åœ¨çš„ç‹€æ…‹ï¼ˆå·²æå£ï¼‰:
"0050": "Ã¥â€¦Æ’Ã¥Â¤Â§Ã¥Â°Ã§Â£50",  # æ‡‰è©²æ˜¯ã€Œå…ƒå¤§å°ç£50ã€
```

**åŸå› ï¼š** åœ¨æŸæ¬¡æª”æ¡ˆè™•ç†æ™‚ï¼ŒUTF-8 ç·¨ç¢¼è¢«ç ´å£äº†ã€‚

---

## ğŸ“ éœ€è¦ä¿®å¾©çš„æª”æ¡ˆ

| æª”æ¡ˆ | ä½ç½® | èªªæ˜ |
|------|------|------|
| `yahoo_finance.py` | `app/data_sources/` | ä¸»è¦è³‡æ–™ä¾†æºï¼Œ**å¿…é ˆä¿®å¾©** |
| `price_cache_service.py` | `app/services/` | å¿«å–æœå‹™ï¼Œä¹Ÿéœ€è¦ä¿®å¾© |

---

## ğŸš€ ä¿®å¾©æ­¥é©Ÿ

### æ­¥é©Ÿ 1: ä¿®å¾© yahoo_finance.py

æ‰¾åˆ° `app/data_sources/yahoo_finance.py` ä¸­çš„ `TAIWAN_STOCK_NAMES = {...}`

**æ•´å€‹æ›¿æ›ç‚ºï¼š**

```python
TAIWAN_STOCK_NAMES = {
    # æ¬Šå€¼è‚¡
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    # é‡‘èè‚¡
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    # é›»å­è‚¡
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    "5876": "ä¸Šæµ·å•†éŠ€",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ETF
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "006208": "å¯Œé‚¦å°50",
    "00646": "å…ƒå¤§S&P500",
    "00662": "å¯Œé‚¦NASDAQ",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}
```

### æ­¥é©Ÿ 2: åŒæ¨£ä¿®å¾© price_cache_service.py

æ‰¾åˆ° `app/services/price_cache_service.py` ä¸­çš„ `TAIWAN_STOCK_NAMES = {...}`ï¼Œç”¨ç›¸åŒçš„å­—å…¸æ›¿æ›ã€‚

### æ­¥é©Ÿ 3: ç¢ºä¿æª”æ¡ˆä½¿ç”¨ UTF-8 ç·¨ç¢¼å„²å­˜

å„²å­˜æ™‚ç¢ºèªç·¨è¼¯å™¨ä½¿ç”¨ **UTF-8 without BOM** ç·¨ç¢¼ã€‚

---

## âœ… é©—è­‰

1. é–‹å•Ÿæ¯”è¼ƒé é¢
2. é¸æ“‡å°è‚¡ï¼ˆå¦‚ 2330.TWï¼‰
3. ç¢ºèªåç¨±é¡¯ç¤ºç‚ºã€Œå°ç©é›»ã€è€Œéäº‚ç¢¼

---

## âš ï¸ é é˜²æªæ–½

1. ä½¿ç”¨ Git æ™‚è¨­å®šï¼š`git config --global core.quotepath false`
2. ç·¨è¼¯å™¨è¨­å®šç‚º UTF-8
3. é¿å…ç”¨ Windows è¨˜äº‹æœ¬ç·¨è¼¯ Python æª”æ¡ˆ
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260112-003-stock-search-fix.md  â­â­â­
> ğŸ”§ è‚¡ç¥¨æœå°‹ä¿®å¾©ï¼šBRK.Bã€FIG ç­‰å•é¡Œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ è‚¡ç¥¨æœå°‹ä¿®å¾©ï¼šBRK.Bã€FIG ç­‰å•é¡Œ

> æ–‡ä»¶ç·¨è™Ÿ: 20260112-003  
> æ›´æ–°æ—¥æœŸ: 2026-01-12  
> é¡å‹: Bug ä¿®å¾©  
> å„ªå…ˆç´š: é«˜

---

## ğŸ› å•é¡Œæè¿°

| è‚¡ç¥¨ | å•é¡Œç¾è±¡ | æ ¹æœ¬åŸå›  |
|------|----------|---------|
| BRK.B | æœå°‹è¿”å› 404 | 1. URL ä¸­ `.B` è¢«è§£æç‚ºå‰¯æª”å<br>2. Yahoo å¯èƒ½éœ€è¦ `BRK-B` æ ¼å¼ |
| FIG | æ‰¾ä¸åˆ°è‚¡ç¥¨ | 2024 IPO æ–°è‚¡ï¼Œåªæœ‰ 1 å¹´æ•¸æ“šï¼Œä½†ç³»çµ±è¦æ±‚ 10 å¹´ |

---

## ğŸ“ ä¿®æ”¹æª”æ¡ˆ

- `app/routers/stock.py` - ä¸»è¦ä¿®æ”¹
- åƒè€ƒï¼š`app/routers/stock_patch.py` - å®Œæ•´ä¿®æ”¹èªªæ˜

---

## ğŸš€ ä¿®å¾©æ­¥é©Ÿï¼ˆå…± 3 æ­¥ï¼‰

### æ­¥é©Ÿ 1: ä¿®æ”¹è·¯ç”±å®šç¾©

æ‰¾åˆ°ç´„ç¬¬ **3706 è¡Œ**ï¼š

```python
# âŒ åŸæœ¬
@router.get("/{symbol}", summary="æŸ¥è©¢è‚¡ç¥¨")

# âœ… æ”¹ç‚º
@router.get("/{symbol:path}", summary="æŸ¥è©¢è‚¡ç¥¨")
```

### æ­¥é©Ÿ 2: æ–°å¢è‚¡ç¥¨ä»£ç¢¼è®Šé«”å‡½æ•¸

åœ¨ `normalize_tw_symbol` å‡½æ•¸å¾Œé¢åŠ å…¥ï¼š

```python
def get_symbol_variants(symbol: str) -> list:
    """
    ç”¢ç”Ÿè‚¡ç¥¨ä»£ç¢¼çš„è®Šé«”åˆ—è¡¨
    BRK.B -> ["BRK.B", "BRK-B"]
    """
    variants = [symbol]
    
    # å« `.` ä½†ä¸æ˜¯å°è‚¡ï¼Œä¹Ÿå˜—è©¦ `-` æ ¼å¼
    if '.' in symbol and not symbol.endswith('.TW') and not symbol.endswith('.TWO'):
        variants.append(symbol.replace('.', '-'))
    
    # å« `-`ï¼Œä¹Ÿå˜—è©¦ `.` æ ¼å¼
    if '-' in symbol:
        variants.append(symbol.replace('-', '.'))
    
    return variants
```

### æ­¥é©Ÿ 3: ä¿®æ”¹æ­·å²æ•¸æ“šæŠ“å–é‚è¼¯

æ‰¾åˆ°ç´„ç¬¬ **3722-3741 è¡Œ**ï¼Œå°‡ï¼š

```python
# âŒ åŸæœ¬
df = yahoo_finance.get_stock_history(symbol, period="10y")

if (df is None or df.empty) and symbol.endswith('.TW'):
    # ... å°è‚¡è™•ç† ...

if df is None or df.empty:
    raise HTTPException(status_code=404, ...)
```

æ›¿æ›ç‚ºï¼š

```python
# âœ… ä¿®å¾©å¾Œ
df = None
used_period = None
actual_symbol = symbol

# ç”¢ç”Ÿä»£ç¢¼è®Šé«”ï¼ˆBRK.B -> BRK-Bï¼‰
symbol_variants = get_symbol_variants(symbol)

# å˜—è©¦ä¸åŒæœŸé–“ï¼ˆè§£æ±ºæ–°è‚¡å•é¡Œï¼‰
periods = ["10y", "5y", "2y", "1y", "6mo", "3mo"]

for try_symbol in symbol_variants:
    if df is not None and len(df) >= 20:
        break
    for period in periods:
        logger.info(f"å˜—è©¦ {try_symbol} æœŸé–“ {period}...")
        df = yahoo_finance.get_stock_history(try_symbol, period=period)
        if df is not None and len(df) >= 20:
            used_period = period
            actual_symbol = try_symbol
            logger.info(f"æˆåŠŸ: {try_symbol} ä½¿ç”¨ {period}ï¼Œå…± {len(df)} ç­†")
            break

# å°è‚¡ .TW -> .TWO å˜—è©¦
if (df is None or len(df) < 20) and symbol.endswith('.TW'):
    two_symbol = symbol.replace('.TW', '.TWO')
    for period in periods:
        df = yahoo_finance.get_stock_history(two_symbol, period=period)
        if df is not None and len(df) >= 20:
            actual_symbol = two_symbol
            used_period = period
            break

if df is None or len(df) < 20:
    tried = ", ".join(set(symbol_variants))
    raise HTTPException(
        status_code=404,
        detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦: {tried}ï¼‰"
    )

# ä½¿ç”¨å¯¦éš›æ‰¾åˆ°çš„ symbol
symbol = actual_symbol
```

---

## âœ… é©—è­‰

ä¿®å¾©å¾Œæ¸¬è©¦ï¼š

| è¼¸å…¥ | é æœŸè¡Œç‚º |
|------|---------|
| `BRK.B` | è‡ªå‹•å˜—è©¦ BRK.B å’Œ BRK-B |
| `BRK-B` | è‡ªå‹•å˜—è©¦ BRK-B å’Œ BRK.B |
| `FIG` | è‡ªå‹•å˜—è©¦è¼ƒçŸ­æœŸé–“ï¼ˆ1y, 6moï¼‰|
| `AAPL` | æ­£å¸¸ï¼ˆ10yï¼‰|
| `2330` | æ­£å¸¸ï¼ˆè‡ªå‹•åŠ  .TWï¼‰|

---

## ğŸ“Œ ç‰¹æ®Šè‚¡ç¥¨ä»£ç¢¼å°ç…§

| å…¬å¸ | Yahoo æ ¼å¼ | èªªæ˜ |
|------|-----------|------|
| Berkshire A | BRK-A æˆ– BRK.A | ç³»çµ±æœƒè‡ªå‹•å˜—è©¦å…©ç¨® |
| Berkshire B | BRK-B æˆ– BRK.B | ç³»çµ±æœƒè‡ªå‹•å˜—è©¦å…©ç¨® |
| Figma | FIG | 2024 IPOï¼Œéœ€ç”¨çŸ­æœŸé–“ |
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260112-005-feature-specs.md  â­â­â­
> ğŸš€ SELA ç³»çµ±åŠŸèƒ½è¦åŠƒæ›¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸš€ SELA ç³»çµ±åŠŸèƒ½è¦åŠƒæ›¸

> æ–‡ä»¶ç·¨è™Ÿ: 20260112-005-feature-specs  
> å»ºç«‹æ—¥æœŸ: 2026-01-12  
> ç‰ˆæœ¬: 1.0

---

## ğŸ“‹ åŠŸèƒ½ç¸½è¦½

| # | åŠŸèƒ½åç¨± | å„ªå…ˆç´š | è¤‡é›œåº¦ | é ä¼°å·¥æ™‚ |
|---|---------|--------|--------|---------|
| 1 | ç®¡ç†å“¡ç™»å…¥è‡ªå‹•æ›´æ–° | P1 | ä½ | 2h |
| 2 | å€‹äººè²·è³£è‚¡ç¥¨ç®¡ç† | P0 | é«˜ | 8h |
| 3 | å„€è¡¨æ¿æ¯”ç‰¹å¹£åƒ¹æ ¼ | P2 | ä½ | 1h |
| 4 | åˆ—è¡¨æ¸…å–®æ’åº | P1 | ä¸­ | 3h |

---

# åŠŸèƒ½ 1: ç®¡ç†å“¡ç™»å…¥è‡ªå‹•æ›´æ–°

## 1.1 éœ€æ±‚æè¿°

ç®¡ç†å“¡ç™»å…¥å¾Œï¼Œè‡ªå‹•åœ¨èƒŒæ™¯è§¸ç™¼ç³»çµ±æ›´æ–°ã€‚

## 1.2 è§¸ç™¼æ™‚æ©Ÿ

- ç®¡ç†å“¡æˆåŠŸç™»å…¥æ™‚ï¼ˆ`is_admin=True`ï¼‰
- åƒ…è§¸ç™¼ä¸€æ¬¡ï¼Œä¸é˜»å¡ç™»å…¥æµç¨‹

## 1.3 æ›´æ–°é …ç›®

```python
AUTO_UPDATE_TASKS = [
    "update_stock_prices",      # æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼å¿«å–
    "update_crypto_prices",     # æ›´æ–°åŠ å¯†è²¨å¹£åƒ¹æ ¼
    "update_market_sentiment",  # æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸
    "cleanup_old_data",         # æ¸…ç†éæœŸæ•¸æ“š
]
```

## 1.4 æŠ€è¡“è¨­è¨ˆ

### å¾Œç«¯ä¿®æ”¹

**æª”æ¡ˆ:** `app/routers/auth.py`

```python
# åœ¨ LINE callback è™•ç†æˆåŠŸç™»å…¥å¾ŒåŠ å…¥

@router.get("/callback")
async def line_callback(...):
    # ... ç¾æœ‰ç™»å…¥é‚è¼¯ ...
    
    # ç®¡ç†å“¡ç™»å…¥è§¸ç™¼è‡ªå‹•æ›´æ–°
    if user.is_admin:
        background_tasks.add_task(trigger_admin_updates, db)
    
    return RedirectResponse(...)


async def trigger_admin_updates(db: Session):
    """ç®¡ç†å“¡ç™»å…¥è§¸ç™¼çš„èƒŒæ™¯æ›´æ–°"""
    from app.services.price_cache_service import PriceCacheService
    
    logger.info("ğŸ”„ ç®¡ç†å“¡ç™»å…¥ï¼Œè§¸ç™¼è‡ªå‹•æ›´æ–°...")
    
    try:
        cache_service = PriceCacheService(db)
        
        # 1. æ›´æ–°æ‰€æœ‰è¿½è¹¤è‚¡ç¥¨åƒ¹æ ¼
        result = cache_service.update_all_prices()
        logger.info(f"è‚¡ç¥¨åƒ¹æ ¼æ›´æ–°: {result}")
        
        # 2. æ›´æ–°å¸‚å ´æƒ…ç·’
        from app.services.market_service import market_service
        market_service.update_fear_greed()
        
        logger.info("âœ… è‡ªå‹•æ›´æ–°å®Œæˆ")
        
    except Exception as e:
        logger.error(f"è‡ªå‹•æ›´æ–°å¤±æ•—: {e}")
```

### API ç«¯é»ï¼ˆå¯é¸ï¼‰

```
POST /api/admin/trigger-update
Authorization: Bearer {admin_token}

Response:
{
    "success": true,
    "message": "æ›´æ–°å·²è§¸ç™¼",
    "tasks": ["stock_prices", "crypto_prices", "market_sentiment"]
}
```

## 1.5 å‰ç«¯æç¤ºï¼ˆå¯é¸ï¼‰

ç™»å…¥å¾Œåœ¨å„€è¡¨æ¿é¡¯ç¤º Toast æç¤ºï¼š
```
ğŸ”„ ç³»çµ±æ­£åœ¨èƒŒæ™¯æ›´æ–°æ•¸æ“š...
```

---

# åŠŸèƒ½ 2: å€‹äººè²·è³£è‚¡ç¥¨ç®¡ç†

## 2.1 éœ€æ±‚æè¿°

ç”¨æˆ¶å¯è¨˜éŒ„å€‹äººè‚¡ç¥¨è²·è³£äº¤æ˜“ï¼Œè¿½è¹¤æŒè‚¡å’Œæç›Šã€‚

## 2.2 è³‡æ–™åº«è¨­è¨ˆ

### æ–°å¢è³‡æ–™è¡¨

**æª”æ¡ˆ:** `app/models/portfolio.py`

```python
"""
å€‹äººæŠ•è³‡çµ„åˆæ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, ForeignKey, Index, Enum
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base
import enum


class MarketType(enum.Enum):
    """å¸‚å ´é¡å‹"""
    TW = "tw"      # å°è‚¡
    US = "us"      # ç¾è‚¡


class TransactionType(enum.Enum):
    """äº¤æ˜“é¡å‹"""
    BUY = "buy"    # è²·å…¥
    SELL = "sell"  # è³£å‡º


class PortfolioTransaction(Base):
    """äº¤æ˜“ç´€éŒ„"""
    
    __tablename__ = "portfolio_transactions"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    
    # è‚¡ç¥¨è³‡è¨Š
    symbol = Column(String(20), nullable=False)           # è‚¡ç¥¨ä»£ç¢¼
    name = Column(String(100))                            # è‚¡ç¥¨åç¨±
    market = Column(String(10), nullable=False)           # tw / us
    
    # äº¤æ˜“è³‡è¨Š
    transaction_type = Column(String(10), nullable=False) # buy / sell
    quantity = Column(Integer, nullable=False)            # è‚¡æ•¸
    price = Column(Numeric(12, 4), nullable=False)        # æˆäº¤åƒ¹
    fee = Column(Numeric(10, 2), default=0)               # æ‰‹çºŒè²»
    tax = Column(Numeric(10, 2), default=0)               # äº¤æ˜“ç¨…ï¼ˆè³£å‡ºæ™‚ï¼‰
    transaction_date = Column(Date, nullable=False)       # äº¤æ˜“æ—¥æœŸ
    
    # å‚™è¨»
    note = Column(String(500))
    
    # æ™‚é–“æˆ³
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    # ç´¢å¼•
    __table_args__ = (
        Index('idx_portfolio_user', 'user_id'),
        Index('idx_portfolio_symbol', 'symbol'),
        Index('idx_portfolio_market', 'market'),
        Index('idx_portfolio_date', 'transaction_date'),
    )
    
    @property
    def total_cost(self) -> float:
        """ç¸½æˆæœ¬ï¼ˆå«æ‰‹çºŒè²»ï¼‰"""
        base = float(self.quantity) * float(self.price)
        if self.transaction_type == "buy":
            return base + float(self.fee or 0)
        else:  # sell
            return base - float(self.fee or 0) - float(self.tax or 0)
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "name": self.name,
            "market": self.market,
            "transaction_type": self.transaction_type,
            "quantity": self.quantity,
            "price": float(self.price),
            "fee": float(self.fee or 0),
            "tax": float(self.tax or 0),
            "total_cost": self.total_cost,
            "transaction_date": self.transaction_date.isoformat() if self.transaction_date else None,
            "note": self.note,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }


class PortfolioHolding(Base):
    """æŒè‚¡å½™ç¸½ï¼ˆè¨ˆç®—ç”¨ï¼Œå¯ç”±äº¤æ˜“ç´€éŒ„æ¨å°ï¼‰"""
    
    __tablename__ = "portfolio_holdings"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(20), nullable=False)
    name = Column(String(100))
    market = Column(String(10), nullable=False)
    
    # æŒè‚¡è³‡è¨Š
    total_shares = Column(Integer, default=0)              # ç¸½æŒè‚¡
    avg_cost = Column(Numeric(12, 4), default=0)           # å¹³å‡æˆæœ¬
    total_invested = Column(Numeric(14, 2), default=0)     # ç¸½æŠ•å…¥é‡‘é¡
    realized_profit = Column(Numeric(14, 2), default=0)    # å·²å¯¦ç¾æç›Š
    
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_holding_user_symbol', 'user_id', 'symbol', 'market', unique=True),
    )
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "name": self.name,
            "market": self.market,
            "total_shares": self.total_shares,
            "avg_cost": float(self.avg_cost),
            "total_invested": float(self.total_invested),
            "realized_profit": float(self.realized_profit),
        }
```

## 2.3 API è¨­è¨ˆ

**æª”æ¡ˆ:** `app/routers/portfolio.py`

### ç«¯é»åˆ—è¡¨

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/api/portfolio/transactions` | å–å¾—äº¤æ˜“ç´€éŒ„ |
| POST | `/api/portfolio/transactions` | æ–°å¢äº¤æ˜“ |
| PUT | `/api/portfolio/transactions/{id}` | ä¿®æ”¹äº¤æ˜“ |
| DELETE | `/api/portfolio/transactions/{id}` | åˆªé™¤äº¤æ˜“ |
| GET | `/api/portfolio/holdings` | å–å¾—æŒè‚¡ç¸½è¦½ |
| GET | `/api/portfolio/holdings/{market}` | å–å¾—ç‰¹å®šå¸‚å ´æŒè‚¡ |
| GET | `/api/portfolio/summary` | å–å¾—æŠ•è³‡æ‘˜è¦ |

### è«‹æ±‚/å›æ‡‰æ ¼å¼

```python
# POST /api/portfolio/transactions
class TransactionCreate(BaseModel):
    symbol: str                     # "2330" æˆ– "AAPL"
    name: Optional[str] = None      # "å°ç©é›»" æˆ– "Apple"
    market: str                     # "tw" æˆ– "us"
    transaction_type: str           # "buy" æˆ– "sell"
    quantity: int                   # è‚¡æ•¸
    price: float                    # æˆäº¤åƒ¹
    fee: Optional[float] = 0        # æ‰‹çºŒè²»
    tax: Optional[float] = 0        # äº¤æ˜“ç¨…
    transaction_date: date          # äº¤æ˜“æ—¥æœŸ
    note: Optional[str] = None      # å‚™è¨»

# GET /api/portfolio/holdings
class HoldingsResponse(BaseModel):
    success: bool
    data: dict  # { "tw": [...], "us": [...] }
    summary: dict  # { "total_value", "total_profit", ... }

# GET /api/portfolio/summary
class SummaryResponse(BaseModel):
    success: bool
    data: {
        "total_invested": float,     # ç¸½æŠ•å…¥
        "current_value": float,      # ç¾å€¼
        "unrealized_profit": float,  # æœªå¯¦ç¾æç›Š
        "realized_profit": float,    # å·²å¯¦ç¾æç›Š
        "total_profit": float,       # ç¸½æç›Š
        "return_rate": float,        # å ±é…¬ç‡ %
        "tw_count": int,             # å°è‚¡æŒè‚¡æ•¸
        "us_count": int,             # ç¾è‚¡æŒè‚¡æ•¸
    }
```

## 2.4 å‰ç«¯è¨­è¨ˆ

### é é¢çµæ§‹

```
ğŸ“Š æŠ•è³‡çµ„åˆ
â”œâ”€â”€ ğŸ“ˆ ç¸½è¦½å¡ç‰‡
â”‚   â”œâ”€â”€ ç¸½è³‡ç”¢
â”‚   â”œâ”€â”€ ç¸½æç›Š
â”‚   â””â”€â”€ å ±é…¬ç‡
â”œâ”€â”€ ğŸ”„ Tab åˆ‡æ›
â”‚   â”œâ”€â”€ å°è‚¡
â”‚   â””â”€â”€ ç¾è‚¡
â”œâ”€â”€ ğŸ“‹ æŒè‚¡åˆ—è¡¨
â”‚   â”œâ”€â”€ è‚¡ç¥¨åç¨±
â”‚   â”œâ”€â”€ æŒè‚¡æ•¸
â”‚   â”œâ”€â”€ å¹³å‡æˆæœ¬
â”‚   â”œâ”€â”€ ç¾åƒ¹
â”‚   â””â”€â”€ æç›Š
â””â”€â”€ â• æ–°å¢äº¤æ˜“æŒ‰éˆ•
```

### æ–°å¢äº¤æ˜“è¡¨å–®

```html
<form id="transaction-form">
    <!-- å¸‚å ´é¸æ“‡ -->
    <select name="market">
        <option value="tw">å°è‚¡</option>
        <option value="us">ç¾è‚¡</option>
    </select>
    
    <!-- è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¯æœå°‹ï¼‰ -->
    <input type="text" name="symbol" placeholder="è‚¡ç¥¨ä»£ç¢¼">
    
    <!-- äº¤æ˜“é¡å‹ -->
    <select name="transaction_type">
        <option value="buy">è²·å…¥</option>
        <option value="sell">è³£å‡º</option>
    </select>
    
    <!-- æ•¸é‡ã€åƒ¹æ ¼ã€æ—¥æœŸ -->
    <input type="number" name="quantity" placeholder="è‚¡æ•¸">
    <input type="number" name="price" step="0.01" placeholder="æˆäº¤åƒ¹">
    <input type="date" name="transaction_date">
    
    <!-- æ‰‹çºŒè²»ï¼ˆå¯é¸ï¼‰ -->
    <input type="number" name="fee" step="0.01" placeholder="æ‰‹çºŒè²»">
    
    <!-- å‚™è¨» -->
    <textarea name="note" placeholder="å‚™è¨»"></textarea>
</form>
```

## 2.5 å°èˆªæ•´åˆ

åœ¨ `dashboard.html` å´é‚Šæ¬„æ–°å¢ï¼š

```html
<a onclick="showSection('portfolio', event)" class="nav-link">
    <i class="fas fa-briefcase mr-2"></i>æŠ•è³‡çµ„åˆ
</a>
```

---

# åŠŸèƒ½ 3: å„€è¡¨æ¿æ¯”ç‰¹å¹£åƒ¹æ ¼

## 3.1 éœ€æ±‚æè¿°

åœ¨å„€è¡¨æ¿é¦–é é¡¯ç¤ºæ¯”ç‰¹å¹£å³æ™‚åƒ¹æ ¼ã€‚

## 3.2 é¡¯ç¤ºå…§å®¹

- ç•¶å‰åƒ¹æ ¼ (USD)
- 24 å°æ™‚æ¼²è·Œå¹…
- æ¼²è·Œé¡è‰²æ¨™ç¤ºï¼ˆç¶ æ¼²ç´…è·Œï¼‰

## 3.3 æŠ€è¡“è¨­è¨ˆ

### å¾Œç«¯

å·²æœ‰ APIï¼š`GET /api/crypto/BTC`

### å‰ç«¯

**æª”æ¡ˆ:** `static/dashboard.html`

åœ¨å„€è¡¨æ¿å€å¡ŠåŠ å…¥ï¼š

```html
<!-- æ¯”ç‰¹å¹£åƒ¹æ ¼å¡ç‰‡ -->
<div id="btc-price-card" class="bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl p-4 text-white">
    <div class="flex items-center justify-between">
        <div>
            <div class="text-sm opacity-80">Bitcoin</div>
            <div class="text-2xl font-bold" id="btc-price">$--,---</div>
        </div>
        <div class="text-right">
            <div class="text-lg font-semibold" id="btc-change">--%</div>
            <div class="text-xs opacity-80">24h</div>
        </div>
        <i class="fab fa-bitcoin text-4xl opacity-50"></i>
    </div>
</div>
```

**JavaScript:**

```javascript
async function loadBtcPrice() {
    try {
        const res = await fetch(`${API_BASE}/api/crypto/BTC`);
        const data = await res.json();
        
        if (data.success) {
            const price = data.data.current_price;
            const change = data.data.change_24h;
            
            document.getElementById('btc-price').textContent = 
                `$${price.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
            
            const changeEl = document.getElementById('btc-change');
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeEl.classList.add(change >= 0 ? 'text-green-200' : 'text-red-200');
        }
    } catch (e) {
        console.error('è¼‰å…¥ BTC åƒ¹æ ¼å¤±æ•—:', e);
    }
}

// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
document.addEventListener('DOMContentLoaded', loadBtcPrice);
```

---

# åŠŸèƒ½ 4: åˆ—è¡¨æ¸…å–®æ’åº

## 4.1 éœ€æ±‚æè¿°

å„ç¨®åˆ—è¡¨æ”¯æ´é»æ“Šæ¬„ä½æ¨™é¡Œæ’åºã€‚

## 4.2 é©ç”¨é é¢

1. è‡ªé¸è‚¡åˆ—è¡¨ï¼ˆ`watchlist`ï¼‰
2. æ¯”è¼ƒé é¢ï¼ˆ`compare`ï¼‰
3. æŠ•è³‡çµ„åˆï¼ˆ`portfolio`ï¼‰- æ–°åŠŸèƒ½

## 4.3 æŠ€è¡“è¨­è¨ˆ

### é€šç”¨æ’åºæ¨¡çµ„

**æª”æ¡ˆ:** `static/js/table-sort.js`

```javascript
/**
 * è¡¨æ ¼æ’åºæ¨¡çµ„
 */
class TableSorter {
    constructor(tableId, options = {}) {
        this.table = document.getElementById(tableId);
        this.data = [];
        this.currentSort = { column: null, direction: 'asc' };
        this.options = {
            onSort: options.onSort || null,
            savePreference: options.savePreference !== false,
            storageKey: options.storageKey || `sort_${tableId}`,
        };
        
        this.init();
    }
    
    init() {
        // è¼‰å…¥å„²å­˜çš„åå¥½
        if (this.options.savePreference) {
            const saved = localStorage.getItem(this.options.storageKey);
            if (saved) {
                this.currentSort = JSON.parse(saved);
            }
        }
        
        // ç¶å®šæ¨™é¡Œé»æ“Šäº‹ä»¶
        this.bindHeaders();
    }
    
    bindHeaders() {
        const headers = this.table.querySelectorAll('th[data-sort]');
        headers.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                this.sort(header.dataset.sort);
            });
            
            // åŠ å…¥æ’åºåœ–ç¤º
            const icon = document.createElement('i');
            icon.className = 'fas fa-sort ml-1 opacity-30';
            header.appendChild(icon);
        });
    }
    
    setData(data) {
        this.data = [...data];
        if (this.currentSort.column) {
            this.applySort();
        }
    }
    
    sort(column) {
        // åˆ‡æ›æ–¹å‘
        if (this.currentSort.column === column) {
            this.currentSort.direction = 
                this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.column = column;
            this.currentSort.direction = 'asc';
        }
        
        // å„²å­˜åå¥½
        if (this.options.savePreference) {
            localStorage.setItem(
                this.options.storageKey, 
                JSON.stringify(this.currentSort)
            );
        }
        
        this.applySort();
        this.updateIcons();
    }
    
    applySort() {
        const { column, direction } = this.currentSort;
        
        this.data.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            
            // è™•ç†æ•¸å­—
            if (typeof valA === 'string' && !isNaN(parseFloat(valA))) {
                valA = parseFloat(valA);
                valB = parseFloat(valB);
            }
            
            // è™•ç† null/undefined
            if (valA == null) return 1;
            if (valB == null) return -1;
            
            // æ¯”è¼ƒ
            let result = 0;
            if (typeof valA === 'string') {
                result = valA.localeCompare(valB, 'zh-TW');
            } else {
                result = valA - valB;
            }
            
            return direction === 'asc' ? result : -result;
        });
        
        // è§¸ç™¼å›èª¿
        if (this.options.onSort) {
            this.options.onSort(this.data, this.currentSort);
        }
    }
    
    updateIcons() {
        const headers = this.table.querySelectorAll('th[data-sort]');
        headers.forEach(header => {
            const icon = header.querySelector('i');
            const column = header.dataset.sort;
            
            if (column === this.currentSort.column) {
                icon.className = this.currentSort.direction === 'asc' 
                    ? 'fas fa-sort-up ml-1' 
                    : 'fas fa-sort-down ml-1';
                icon.classList.remove('opacity-30');
            } else {
                icon.className = 'fas fa-sort ml-1 opacity-30';
            }
        });
    }
    
    getData() {
        return this.data;
    }
}

// å°å‡º
window.TableSorter = TableSorter;
```

### ä½¿ç”¨ç¯„ä¾‹

**è‡ªé¸è‚¡åˆ—è¡¨:**

```html
<table id="watchlist-table">
    <thead>
        <tr>
            <th data-sort="symbol">ä»£ç¢¼</th>
            <th data-sort="name">åç¨±</th>
            <th data-sort="price">ç¾åƒ¹</th>
            <th data-sort="change_pct">æ¼²è·Œå¹…</th>
            <th data-sort="volume">æˆäº¤é‡</th>
        </tr>
    </thead>
    <tbody id="watchlist-body"></tbody>
</table>

<script>
const watchlistSorter = new TableSorter('watchlist-table', {
    onSort: (sortedData) => {
        renderWatchlistTable(sortedData);
    },
    storageKey: 'watchlist_sort'
});

// è¼‰å…¥æ•¸æ“šæ™‚
function loadWatchlist(data) {
    watchlistSorter.setData(data);
    renderWatchlistTable(watchlistSorter.getData());
}
</script>
```

**æ¯”è¼ƒé é¢:**

```html
<table id="compare-table">
    <thead>
        <tr>
            <th>æ’å</th>
            <th data-sort="symbol">æ¨™çš„</th>
            <th data-sort="price">ç¾åƒ¹</th>
            <th data-sort="return_1y">1å¹´</th>
            <th data-sort="return_3y">3å¹´</th>
            <th data-sort="return_5y">5å¹´</th>
        </tr>
    </thead>
</table>
```

---

# ğŸ“ æª”æ¡ˆæ¸…å–®

## æ–°å¢æª”æ¡ˆ

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `app/models/portfolio.py` | æŠ•è³‡çµ„åˆè³‡æ–™æ¨¡å‹ |
| `app/routers/portfolio.py` | æŠ•è³‡çµ„åˆ API |
| `app/services/portfolio_service.py` | æŠ•è³‡çµ„åˆæ¥­å‹™é‚è¼¯ |
| `static/js/portfolio.js` | æŠ•è³‡çµ„åˆå‰ç«¯ |
| `static/css/portfolio.css` | æŠ•è³‡çµ„åˆæ¨£å¼ |
| `static/js/table-sort.js` | é€šç”¨æ’åºæ¨¡çµ„ |

## ä¿®æ”¹æª”æ¡ˆ

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|----------|
| `app/routers/auth.py` | åŠ å…¥ç®¡ç†å“¡è‡ªå‹•æ›´æ–° |
| `app/routers/__init__.py` | è¨»å†Š portfolio router |
| `app/models/__init__.py` | åŒ¯å‡ºæ–°æ¨¡å‹ |
| `static/dashboard.html` | åŠ å…¥ BTC åƒ¹æ ¼ã€æŠ•è³‡çµ„åˆå°èˆª |
| `static/js/watchlist.js` | æ•´åˆæ’åºåŠŸèƒ½ |
| `static/compare.html` | æ•´åˆæ’åºåŠŸèƒ½ |

---

# ğŸ“… å¯¦ä½œé †åºå»ºè­°

```
Week 1:
â”œâ”€â”€ Day 1: åŠŸèƒ½ 3 (BTC åƒ¹æ ¼) - ç°¡å–®ï¼Œå¿«é€Ÿè¦‹æ•ˆ
â”œâ”€â”€ Day 2: åŠŸèƒ½ 1 (ç®¡ç†å“¡æ›´æ–°) - å¾Œç«¯ç‚ºä¸»
â””â”€â”€ Day 3: åŠŸèƒ½ 4 (æ’åº) - é€šç”¨æ¨¡çµ„

Week 2:
â”œâ”€â”€ Day 1-2: åŠŸèƒ½ 2 å¾Œç«¯ (Model + API)
â”œâ”€â”€ Day 3-4: åŠŸèƒ½ 2 å‰ç«¯ (UI + æ•´åˆ)
â””â”€â”€ Day 5: æ¸¬è©¦ + ä¿®å¾©
```

---

# âœ… é©—æ”¶æ¨™æº–

## åŠŸèƒ½ 1: ç®¡ç†å“¡ç™»å…¥è‡ªå‹•æ›´æ–°
- [ ] ç®¡ç†å“¡ç™»å…¥å¾Œè‡ªå‹•è§¸ç™¼æ›´æ–°
- [ ] æ›´æ–°åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä¸å½±éŸ¿ç™»å…¥
- [ ] æ›´æ–°æ—¥èªŒæ­£ç¢ºè¨˜éŒ„

## åŠŸèƒ½ 2: å€‹äººè²·è³£è‚¡ç¥¨ç®¡ç†
- [ ] å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤äº¤æ˜“ç´€éŒ„
- [ ] å°è‚¡/ç¾è‚¡åˆ†é–‹é¡¯ç¤º
- [ ] æŒè‚¡å’Œæç›Šè¨ˆç®—æ­£ç¢º
- [ ] æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæ­£å¸¸

## åŠŸèƒ½ 3: å„€è¡¨æ¿æ¯”ç‰¹å¹£åƒ¹æ ¼
- [ ] é¦–é é¡¯ç¤º BTC åƒ¹æ ¼
- [ ] æ¼²è·Œé¡è‰²æ­£ç¢º
- [ ] åƒ¹æ ¼æ ¼å¼åŒ–æ­£ç¢º

## åŠŸèƒ½ 4: åˆ—è¡¨æ¸…å–®æ’åº
- [ ] é»æ“Šæ¨™é¡Œå¯æ’åº
- [ ] å‡é™åºåˆ‡æ›æ­£å¸¸
- [ ] æ’åºåå¥½è¢«è¨˜ä½
- [ ] æ’åºåœ–ç¤ºæ­£ç¢ºé¡¯ç¤º
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/stock-analysis-system-spec.md  â­â­â­
> ğŸ“ˆ å¤šç”¨æˆ¶é¸è‚¡åˆ†æç³»çµ± - é–‹ç™¼è¦æ ¼æ›¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ“ˆ å¤šç”¨æˆ¶é¸è‚¡åˆ†æç³»çµ± - é–‹ç™¼è¦æ ¼æ›¸

> ç‰ˆæœ¬ï¼š1.0  
> æœ€å¾Œæ›´æ–°ï¼š2025-01

---

## ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#1-å°ˆæ¡ˆæ¦‚è¿°)
2. [ç³»çµ±æ¶æ§‹](#2-ç³»çµ±æ¶æ§‹)
3. [è³‡æ–™ä¾†æº](#3-è³‡æ–™ä¾†æº)
4. [è³‡æ–™åº«è¨­è¨ˆ](#4-è³‡æ–™åº«è¨­è¨ˆ)
5. [åŠŸèƒ½æ¨¡çµ„](#5-åŠŸèƒ½æ¨¡çµ„)
6. [æŠ€è¡“æŒ‡æ¨™](#6-æŠ€è¡“æŒ‡æ¨™)
7. [ç”¨æˆ¶ç³»çµ±](#7-ç”¨æˆ¶ç³»çµ±)
8. [é€šçŸ¥ç³»çµ±](#8-é€šçŸ¥ç³»çµ±)
9. [åœ–è¡¨ç³»çµ±](#9-åœ–è¡¨ç³»çµ±)
10. [API è¨­è¨ˆ](#10-api-è¨­è¨ˆ)
11. [æŠ€è¡“é¸å‹](#11-æŠ€è¡“é¸å‹)
12. [é–‹ç™¼éšæ®µ](#12-é–‹ç™¼éšæ®µ)

---

## 1. å°ˆæ¡ˆæ¦‚è¿°

### 1.1 å°ˆæ¡ˆç›®æ¨™

å»ºç«‹ä¸€å€‹æ”¯æ´å¤šç”¨æˆ¶çš„è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°ï¼Œæä¾›ï¼š

- ç¾è‚¡å³æ™‚å ±åƒ¹èˆ‡æŠ€è¡“æŒ‡æ¨™åˆ†æ
- æ¯”ç‰¹å¹£ã€ä»¥å¤ªå¹£åƒ¹æ ¼è¿½è¹¤
- å€‹äººåŒ–è¿½è¹¤æ¸…å–®
- è‡ªè¨‚æŠ€è¡“æŒ‡æ¨™èˆ‡é€šçŸ¥
- LINE æ¨æ’­è­¦å ±

### 1.2 æ ¸å¿ƒç‰¹è‰²

| ç‰¹è‰² | èªªæ˜ |
|------|------|
| å¤šç”¨æˆ¶æ”¯æ´ | LINE ç™»å…¥ï¼Œæ¯äººç¨ç«‹è¿½è¹¤æ¸…å–® |
| å…±äº«è³‡æ–™åº« | è‚¡åƒ¹è³‡æ–™å…±ç”¨ï¼Œæ¸›å°‘ API å‘¼å« |
| å½ˆæ€§æŒ‡æ¨™ | ç”¨æˆ¶å¯è‡ªé¸è¦é¡¯ç¤º/é€šçŸ¥çš„æŒ‡æ¨™ |
| æ™ºèƒ½é è­¦ | çªç ´ã€äº¤å‰ã€æ¥µç«¯å€¼è‡ªå‹•æ¨æ’­ |
| é›™å¸‚å ´ | åŒæ™‚æ”¯æ´ç¾è‚¡èˆ‡åŠ å¯†è²¨å¹£ |

### 1.3 æ”¯æ´è³‡ç”¢

| é¡å‹ | æ¨™çš„ |
|------|------|
| ç¾è‚¡ | æ‰€æœ‰ Yahoo Finance æ”¯æ´çš„è‚¡ç¥¨ä»£è™Ÿ |
| åŠ å¯†è²¨å¹£ | BTCï¼ˆæ¯”ç‰¹å¹£ï¼‰ã€ETHï¼ˆä»¥å¤ªå¹£ï¼‰ |

---

## 2. ç³»çµ±æ¶æ§‹

### 2.1 æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ä»‹é¢                              â”‚
â”‚              (Web æ‡‰ç”¨ç¨‹å¼ / LINE Bot)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        API å±¤                                â”‚
â”‚    â”œâ”€ ç”¨æˆ¶é©—è­‰ (LINE Login)                                  â”‚
â”‚    â”œâ”€ è¿½è¹¤æ¸…å–®ç®¡ç†                                           â”‚
â”‚    â”œâ”€ è‚¡ç¥¨/å¹£åœˆæŸ¥è©¢                                          â”‚
â”‚    â””â”€ è¨­å®šç®¡ç†                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      å•†æ¥­é‚è¼¯å±¤                               â”‚
â”‚    â”œâ”€ æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“                                        â”‚
â”‚    â”œâ”€ è¨Šè™Ÿåµæ¸¬å¼•æ“                                           â”‚
â”‚    â”œâ”€ ç¶œåˆè©•åˆ†ç³»çµ±                                           â”‚
â”‚    â””â”€ é€šçŸ¥æ’ç¨‹æœå‹™                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       å¿«å–å±¤                                  â”‚
â”‚    â””â”€ åˆ¤æ–·è®€å–æœ¬åœ°è³‡æ–™åº« æˆ– æŠ“å–å¤–éƒ¨ API                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      è³‡æ–™åº«å±¤                                 â”‚
â”‚    â”œâ”€ å…±äº«è³‡æ–™ (è‚¡åƒ¹ã€å¹£åƒ¹ã€æƒ…ç·’æŒ‡æ•¸)                          â”‚
â”‚    â””â”€ ç§æœ‰è³‡æ–™ (ç”¨æˆ¶ã€è¿½è¹¤æ¸…å–®ã€è¨­å®š)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å¤–éƒ¨è³‡æ–™ä¾†æº                               â”‚
â”‚    â”œâ”€ Yahoo Finance (ç¾è‚¡)                                   â”‚
â”‚    â”œâ”€ CoinGecko (åŠ å¯†è²¨å¹£)                                   â”‚
â”‚    â”œâ”€ CNN Fear & Greed (ç¾è‚¡æƒ…ç·’)                            â”‚
â”‚    â”œâ”€ Alternative.me (å¹£åœˆæƒ…ç·’)                              â”‚
â”‚    â””â”€ LINE Login API (ç”¨æˆ¶é©—è­‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è³‡æ–™æµç¨‹

```
ç”¨æˆ¶æŸ¥è©¢ AAPL
      â”‚
      â–¼
  æª¢æŸ¥æœ¬åœ°è³‡æ–™åº«
      â”‚
      â”œâ”€ æœ‰è³‡æ–™ ä¸” ä»Šæ—¥å·²æ›´æ–° â†’ ç›´æ¥ä½¿ç”¨
      â”‚
      â””â”€ ç„¡è³‡æ–™ æˆ– éæœŸ â†’ æŠ“ Yahoo Finance
                              â”‚
                              â–¼
                         å¯«å…¥è³‡æ–™åº«
                              â”‚
                              â–¼
                         è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
                              â”‚
                              â–¼
                      æ ¹æ“šç”¨æˆ¶è¨­å®šéæ¿¾
                              â”‚
                              â–¼
                         å›å‚³çµæœ
```

---

## 3. è³‡æ–™ä¾†æº

### 3.1 ç¾è‚¡è³‡æ–™

| ä¾†æº | ç”¨é€” | å–å¾—æ–¹å¼ |
|------|------|----------|
| Yahoo Finance | è‚¡åƒ¹ã€æˆäº¤é‡ã€æ­·å²è³‡æ–™ | yfinance Python å¥—ä»¶ |
| CNN Fear & Greed | ç¾è‚¡å¸‚å ´æƒ…ç·’æŒ‡æ•¸ | ç¶²é çˆ¬èŸ² æˆ– ç¬¬ä¸‰æ–¹ API |

**yfinance å¯å–å¾—æ¬„ä½ï¼š**
- Open, High, Low, Close, Volume
- æ­·å²è³‡æ–™ï¼ˆå¯å–å¤šå¹´ï¼‰
- å»¶é²ç´„ 15-20 åˆ†é˜

### 3.2 åŠ å¯†è²¨å¹£è³‡æ–™

| ä¾†æº | ç”¨é€” | å–å¾—æ–¹å¼ |
|------|------|----------|
| CoinGecko | BTC/ETH åƒ¹æ ¼ã€å¸‚å€¼ã€æˆäº¤é‡ | å…è²»å…¬é–‹ API |
| Alternative.me | å¹£åœˆ Fear & Greed æŒ‡æ•¸ | å…è²»å…¬é–‹ API |

**CoinGecko API ç«¯é»ï¼š**
```
GET https://api.coingecko.com/api/v3/simple/price
    ?ids=bitcoin,ethereum
    &vs_currencies=usd
    &include_24hr_change=true
    &include_market_cap=true
    &include_24hr_vol=true
```

**Alternative.me API ç«¯é»ï¼š**
```
GET https://api.alternative.me/fng/
```

### 3.3 è³‡æ–™æ›´æ–°ç­–ç•¥

| è³‡æ–™é¡å‹ | æ›´æ–°é »ç‡ | è§¸ç™¼æ–¹å¼ |
|----------|----------|----------|
| ç¾è‚¡è‚¡åƒ¹ | æ¯æ—¥ä¸€æ¬¡ | ç¾è‚¡æ”¶ç›¤å¾Œ (ç´„ UTC+8 05:00) |
| åŠ å¯†è²¨å¹£ | æ¯å°æ™‚ æˆ– æŸ¥è©¢æ™‚ | æ’ç¨‹ / ç”¨æˆ¶æŸ¥è©¢è§¸ç™¼ |
| æƒ…ç·’æŒ‡æ•¸ | æ¯æ—¥ä¸€æ¬¡ | æ’ç¨‹ä»»å‹™ |

---

## 4. è³‡æ–™åº«è¨­è¨ˆ

### 4.1 å…±äº«è³‡æ–™è¡¨

#### stock_pricesï¼ˆç¾è‚¡åƒ¹æ ¼æ­·å²ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµï¼Œè‡ªå‹•éå¢ |
| symbol | VARCHAR(10) | è‚¡ç¥¨ä»£è™Ÿ |
| date | DATE | äº¤æ˜“æ—¥æœŸ |
| open | DECIMAL(12,4) | é–‹ç›¤åƒ¹ |
| high | DECIMAL(12,4) | æœ€é«˜åƒ¹ |
| low | DECIMAL(12,4) | æœ€ä½åƒ¹ |
| close | DECIMAL(12,4) | æ”¶ç›¤åƒ¹ |
| volume | BIGINT | æˆäº¤é‡ |
| updated_at | TIMESTAMP | è³‡æ–™æ›´æ–°æ™‚é–“ |

**ç´¢å¼•ï¼š**
- `idx_stock_symbol_date` ON (symbol, date)

---

#### crypto_pricesï¼ˆåŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµï¼Œè‡ªå‹•éå¢ |
| symbol | VARCHAR(10) | å¹£ç¨®ä»£è™Ÿ (BTC/ETH) |
| date | DATE | æ—¥æœŸ |
| price | DECIMAL(18,8) | åƒ¹æ ¼ (USD) |
| volume_24h | DECIMAL(18,2) | 24 å°æ™‚æˆäº¤é‡ |
| market_cap | DECIMAL(18,2) | å¸‚å€¼ |
| updated_at | TIMESTAMP | è³‡æ–™æ›´æ–°æ™‚é–“ |

**ç´¢å¼•ï¼š**
- `idx_crypto_symbol_date` ON (symbol, date)

---

#### market_sentimentï¼ˆå¸‚å ´æƒ…ç·’æŒ‡æ•¸ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµï¼Œè‡ªå‹•éå¢ |
| date | DATE | æ—¥æœŸ |
| market | VARCHAR(10) | stock / crypto |
| value | INTEGER | æŒ‡æ•¸å€¼ (0-100) |
| classification | VARCHAR(20) | æ–‡å­—åˆ†é¡ |
| updated_at | TIMESTAMP | è³‡æ–™æ›´æ–°æ™‚é–“ |

---

### 4.2 ç§æœ‰è³‡æ–™è¡¨

#### usersï¼ˆç”¨æˆ¶è³‡æ–™ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµï¼Œè‡ªå‹•éå¢ |
| line_user_id | VARCHAR(50) | LINE å”¯ä¸€è­˜åˆ¥ç¢¼ |
| display_name | VARCHAR(100) | LINE é¡¯ç¤ºåç¨± |
| picture_url | VARCHAR(500) | LINE é ­åƒç¶²å€ |
| created_at | TIMESTAMP | è¨»å†Šæ™‚é–“ |
| last_login | TIMESTAMP | æœ€å¾Œç™»å…¥æ™‚é–“ |

**ç´¢å¼•ï¼š**
- `idx_users_line_id` UNIQUE ON (line_user_id)

---

#### watchlistsï¼ˆè¿½è¹¤æ¸…å–®ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµï¼Œè‡ªå‹•éå¢ |
| user_id | INTEGER | ç”¨æˆ¶ ID (FK â†’ users.id) |
| symbol | VARCHAR(10) | è‚¡ç¥¨/å¹£ç¨®ä»£è™Ÿ |
| asset_type | VARCHAR(10) | stock / crypto |
| note | VARCHAR(200) | è‡ªè¨‚å‚™è¨»ï¼ˆé¸å¡«ï¼‰ |
| added_at | TIMESTAMP | åŠ å…¥æ™‚é–“ |

**ç´¢å¼•ï¼š**
- `idx_watchlist_user` ON (user_id)
- `idx_watchlist_unique` UNIQUE ON (user_id, symbol, asset_type)

---

#### user_indicator_settingsï¼ˆæŒ‡æ¨™é¡¯ç¤ºè¨­å®šï¼‰

| æ¬„ä½ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| user_id | INTEGER | - | ç”¨æˆ¶ ID (PK, FK) |
| show_ma | BOOLEAN | true | é¡¯ç¤ºå‡ç·š |
| show_rsi | BOOLEAN | true | é¡¯ç¤º RSI |
| show_macd | BOOLEAN | true | é¡¯ç¤º MACD |
| show_kd | BOOLEAN | false | é¡¯ç¤º KD |
| show_bollinger | BOOLEAN | true | é¡¯ç¤ºå¸ƒæ—é€šé“ |
| show_obv | BOOLEAN | false | é¡¯ç¤º OBV |
| show_volume | BOOLEAN | true | é¡¯ç¤ºæˆäº¤é‡ |

---

#### user_alert_settingsï¼ˆé€šçŸ¥è¨­å®šï¼‰

| æ¬„ä½ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| user_id | INTEGER | - | ç”¨æˆ¶ ID (PK, FK) |
| alert_ma_cross | BOOLEAN | true | å‡ç·šäº¤å‰é€šçŸ¥ |
| alert_ma_breakout | BOOLEAN | true | å‡ç·šçªç ´é€šçŸ¥ |
| alert_rsi | BOOLEAN | true | RSI è¶…è²·è¶…è³£é€šçŸ¥ |
| alert_macd | BOOLEAN | true | MACD äº¤å‰é€šçŸ¥ |
| alert_kd | BOOLEAN | false | KD äº¤å‰é€šçŸ¥ |
| alert_bollinger | BOOLEAN | false | å¸ƒæ—çªç ´é€šçŸ¥ |
| alert_volume | BOOLEAN | false | é‡èƒ½ç•°å¸¸é€šçŸ¥ |
| alert_sentiment | BOOLEAN | true | æƒ…ç·’æ¥µç«¯é€šçŸ¥ |

---

#### user_indicator_paramsï¼ˆæŒ‡æ¨™åƒæ•¸è¨­å®šï¼‰

| æ¬„ä½ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| user_id | INTEGER | - | ç”¨æˆ¶ ID (PK, FK) |
| ma_short | INTEGER | 20 | çŸ­å‡ç·šé€±æœŸ |
| ma_mid | INTEGER | 50 | ä¸­å‡ç·šé€±æœŸ |
| ma_long | INTEGER | 200 | é•·å‡ç·šé€±æœŸ |
| rsi_period | INTEGER | 14 | RSI é€±æœŸ |
| rsi_overbought | INTEGER | 70 | RSI è¶…è²·é–€æª» |
| rsi_oversold | INTEGER | 30 | RSI è¶…è³£é–€æª» |
| macd_fast | INTEGER | 12 | MACD å¿«ç·šé€±æœŸ |
| macd_slow | INTEGER | 26 | MACD æ…¢ç·šé€±æœŸ |
| macd_signal | INTEGER | 9 | MACD è¨Šè™Ÿç·šé€±æœŸ |
| kd_period | INTEGER | 9 | KD é€±æœŸ |
| bollinger_period | INTEGER | 20 | å¸ƒæ—é€šé“é€±æœŸ |
| bollinger_std | DECIMAL(3,1) | 2.0 | å¸ƒæ—æ¨™æº–å·®å€æ•¸ |
| breakout_threshold | DECIMAL(4,2) | 2.00 | çªç ´é è­¦é–€æª» (%) |
| volume_alert_ratio | DECIMAL(3,1) | 2.0 | é‡æ¯”è­¦æˆ’å€æ•¸ |

---

#### notificationsï¼ˆé€šçŸ¥è¨˜éŒ„ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµï¼Œè‡ªå‹•éå¢ |
| user_id | INTEGER | ç”¨æˆ¶ ID (FK) |
| symbol | VARCHAR(10) | è‚¡ç¥¨/å¹£ç¨®ä»£è™Ÿ |
| asset_type | VARCHAR(10) | stock / crypto |
| alert_type | VARCHAR(30) | é€šçŸ¥é¡å‹ï¼ˆè¦‹ä¸‹è¡¨ï¼‰ |
| indicator | VARCHAR(20) | ç›¸é—œæŒ‡æ¨™ |
| message | TEXT | é€šçŸ¥å…§å®¹ |
| price_at_trigger | DECIMAL(18,8) | è§¸ç™¼æ™‚åƒ¹æ ¼ |
| triggered_at | TIMESTAMP | è§¸ç™¼æ™‚é–“ |
| sent | BOOLEAN | æ˜¯å¦å·²ç™¼é€ |

**alert_type é¡å‹ï¼š**
- `ma_golden_cross` - å‡ç·šé»ƒé‡‘äº¤å‰
- `ma_death_cross` - å‡ç·šæ­»äº¡äº¤å‰
- `approaching_breakout` - æ¥è¿‘å‘ä¸Šçªç ´
- `approaching_breakdown` - æ¥è¿‘å‘ä¸‹è·Œç ´
- `breakout` - å·²çªç ´
- `breakdown` - å·²è·Œç ´
- `rsi_overbought` - RSI è¶…è²·
- `rsi_oversold` - RSI è¶…è³£
- `macd_golden_cross` - MACD é»ƒé‡‘äº¤å‰
- `macd_death_cross` - MACD æ­»äº¡äº¤å‰
- `kd_golden_cross` - KD é»ƒé‡‘äº¤å‰
- `kd_death_cross` - KD æ­»äº¡äº¤å‰
- `bollinger_breakout` - å¸ƒæ—ä¸Šè»Œçªç ´
- `bollinger_breakdown` - å¸ƒæ—ä¸‹è»Œè·Œç ´
- `volume_surge` - æˆäº¤é‡æš´å¢
- `sentiment_extreme_fear` - æ¥µåº¦ææ‡¼
- `sentiment_extreme_greed` - æ¥µåº¦è²ªå©ª

---

## 5. åŠŸèƒ½æ¨¡çµ„

### 5.1 è‚¡ç¥¨/åŠ å¯†è²¨å¹£æŸ¥è©¢

#### è¼¸å…¥
- è‚¡ç¥¨ä»£è™Ÿ (å¦‚ AAPLã€TSLA) æˆ–å¹£ç¨® (BTCã€ETH)

#### è¼¸å‡ºè³‡æ–™

**åƒ¹æ ¼è³‡è¨Šï¼š**
| é …ç›® | èªªæ˜ |
|------|------|
| ç¾åƒ¹ | æœ€æ–°æ”¶ç›¤åƒ¹/å³æ™‚åƒ¹ |
| 52 é€±æœ€é«˜ | éå»ä¸€å¹´æœ€é«˜åƒ¹ï¼ˆç¾è‚¡ï¼‰|
| 52 é€±æœ€ä½ | éå»ä¸€å¹´æœ€ä½åƒ¹ï¼ˆç¾è‚¡ï¼‰|
| ATH | æ­·å²æœ€é«˜åƒ¹ï¼ˆåŠ å¯†è²¨å¹£ï¼‰|
| é›¢é«˜é» % | ç¾åƒ¹è·é›¢é«˜é»è·Œå¹… |
| é›¢ä½é» % | ç¾åƒ¹è·é›¢ä½é»æ¼²å¹… |
| å¸‚å€¼ | Market Cap |

**æ¼²è·Œå¹…ï¼š**
| é …ç›® | è¨ˆç®—æ–¹å¼ |
|------|----------|
| æ—¥æ¼²è·Œ | ä»Šæ—¥ vs æ˜¨æ—¥ |
| é€±æ¼²è·Œ | ä»Šæ—¥ vs 5 äº¤æ˜“æ—¥å‰ |
| æœˆæ¼²è·Œ | ä»Šæ—¥ vs 20 äº¤æ˜“æ—¥å‰ |
| å­£æ¼²è·Œ | ä»Šæ—¥ vs 60 äº¤æ˜“æ—¥å‰ |
| å¹´æ¼²è·Œ | ä»Šæ—¥ vs 250 äº¤æ˜“æ—¥å‰ |
| YTD | ä»Šå¹´ä»¥ä¾† |

**æˆäº¤é‡ï¼š**
| é …ç›® | èªªæ˜ |
|------|------|
| ä»Šæ—¥æˆäº¤é‡ | ç•¶æ—¥æˆäº¤é‡ |
| 20 æ—¥å‡é‡ | è¿‘ 20 æ—¥å¹³å‡æˆäº¤é‡ |
| é‡æ¯” | ä»Šæ—¥é‡ / å‡é‡ |

---

### 5.2 è¿½è¹¤æ¸…å–®ç®¡ç†

| æ“ä½œ | èªªæ˜ |
|------|------|
| æ–°å¢ | åŠ å…¥è‚¡ç¥¨/åŠ å¯†è²¨å¹£åˆ°å€‹äººæ¸…å–® |
| åˆªé™¤ | å¾æ¸…å–®ç§»é™¤ |
| åˆ—è¡¨ | é¡¯ç¤ºæ‰€æœ‰è¿½è¹¤çš„æ¨™çš„ |
| ç¸½è¦½ | ä¸€æ¬¡é¡¯ç¤ºæ‰€æœ‰è¿½è¹¤æ¨™çš„çš„å³æ™‚ç‹€æ…‹ |
| å‚™è¨» | ç‚ºæ¨™çš„åŠ å…¥è‡ªè¨‚å‚™è¨» |

---

### 5.3 å¸‚å ´æƒ…ç·’ç¸½è¦½

| å¸‚å ´ | ä¾†æº | æ•¸å€¼ç¯„åœ |
|------|------|----------|
| ç¾è‚¡ | CNN Fear & Greed Index | 0-100 |
| å¹£åœˆ | Alternative.me | 0-100 |

**æƒ…ç·’åˆ†ç´šï¼š**
| æ•¸å€¼ | åˆ†é¡ | æ„ç¾© |
|------|------|------|
| 0-25 | æ¥µåº¦ææ‡¼ | å¯èƒ½è²·é» |
| 26-45 | ææ‡¼ | åè¬¹æ… |
| 46-55 | ä¸­æ€§ | è§€æœ› |
| 56-75 | è²ªå©ª | åæ¨‚è§€ |
| 76-100 | æ¥µåº¦è²ªå©ª | å¯èƒ½è³£é» |

---

### 5.4 è¨­å®šç®¡ç†

**æŒ‡æ¨™é¡¯ç¤ºè¨­å®šï¼š**
- å‹¾é¸è¦åœ¨å ±å‘Šä¸­é¡¯ç¤ºçš„æŒ‡æ¨™
- é è¨­æ¨¡æ¿ï¼šæ¥µç°¡ / æ¨™æº– / å®Œæ•´ / çŸ­ç·š / è‡ªè¨‚

**é€šçŸ¥è¨­å®šï¼š**
- å‹¾é¸è¦æ¥æ”¶æ¨æ’­çš„è¨Šè™Ÿé¡å‹
- è¨­å®šé è­¦é–€æª»ï¼ˆå¦‚æ¥è¿‘å‡ç·š 2%ï¼‰

**åƒæ•¸èª¿æ•´ï¼š**
- è‡ªè¨‚å‡ç·šé€±æœŸã€RSI é€±æœŸç­‰åƒæ•¸

---

## 6. æŠ€è¡“æŒ‡æ¨™

### 6.1 ç§»å‹•å¹³å‡ç·š (MA)

**å®šç¾©ï¼š** éå» N æ—¥æ”¶ç›¤åƒ¹çš„ç°¡å–®å¹³å‡

**å¸¸ç”¨é€±æœŸï¼š**
| å¸‚å ´ | çŸ­æœŸ | ä¸­æœŸ | é•·æœŸ |
|------|------|------|------|
| ç¾è‚¡ | MA20 | MA50 | MA200 |
| å¹£åœˆ | MA7 | MA25 | MA99 |

**è¨ˆç®—å…¬å¼ï¼š**
```
MA(N) = (P1 + P2 + ... + PN) / N
å…¶ä¸­ P ç‚ºæ”¶ç›¤åƒ¹
```

**è¨Šè™Ÿï¼š**
| è¨Šè™Ÿ | æ¢ä»¶ | æ„ç¾© |
|------|------|------|
| é»ƒé‡‘äº¤å‰ | çŸ­å‡ç·šç”±ä¸‹å¾€ä¸Šç©¿è¶Šé•·å‡ç·š | åå¤š |
| æ­»äº¡äº¤å‰ | çŸ­å‡ç·šç”±ä¸Šå¾€ä¸‹ç©¿è¶Šé•·å‡ç·š | åç©º |
| å¤šé ­æ’åˆ— | åƒ¹ > çŸ­å‡ > ä¸­å‡ > é•·å‡ | å¼·å‹¢ |
| ç©ºé ­æ’åˆ— | åƒ¹ < çŸ­å‡ < ä¸­å‡ < é•·å‡ | å¼±å‹¢ |

**äº¤å‰åˆ¤æ–·é‚è¼¯ï¼š**
```python
# é»ƒé‡‘äº¤å‰
yesterday: MA_short < MA_long
today: MA_short > MA_long

# æ­»äº¡äº¤å‰
yesterday: MA_short > MA_long
today: MA_short < MA_long
```

---

### 6.2 RSIï¼ˆç›¸å°å¼·å¼±æŒ‡æ¨™ï¼‰

**å®šç¾©ï¼š** è¡¡é‡åƒ¹æ ¼æ¼²è·ŒåŠ›é“çš„æ¯”ä¾‹

**é è¨­é€±æœŸï¼š** 14 æ—¥

**è¨ˆç®—å…¬å¼ï¼š**
```
RS = å¹³å‡æ¼²å¹… / å¹³å‡è·Œå¹…
RSI = 100 - (100 / (1 + RS))
```

**è¨Šè™Ÿï¼š**
| æ•¸å€¼ | ç‹€æ…‹ | æ„ç¾© |
|------|------|------|
| > 70 | è¶…è²· | å¯èƒ½å›æª” |
| < 30 | è¶…è³£ | å¯èƒ½åå½ˆ |
| 50 | ä¸­æ€§ | å¤šç©ºå¹³è¡¡ |

**é€²éšè¨Šè™Ÿï¼š**
- RSI èƒŒé›¢ï¼šåƒ¹æ ¼å‰µæ–°é«˜ä½† RSI æœªå‰µæ–°é«˜ â†’ å¼±å‹¢è­¦å‘Š

---

### 6.3 MACDï¼ˆæŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ï¼‰

**å®šç¾©ï¼š** çŸ­æœŸèˆ‡é•·æœŸ EMA çš„å·®è·åŠå…¶è®ŠåŒ–

**é è¨­åƒæ•¸ï¼š** (12, 26, 9)

**çµ„æˆï¼š**
| ç·šæ¢ | è¨ˆç®— |
|------|------|
| DIF | EMA(12) - EMA(26) |
| MACD (DEA) | DIF çš„ EMA(9) |
| æŸ±ç‹€é«” | DIF - MACD |

**è¨Šè™Ÿï¼š**
| è¨Šè™Ÿ | æ¢ä»¶ | å¼·åº¦ |
|------|------|------|
| é»ƒé‡‘äº¤å‰ + é›¶è»¸ä¸Šæ–¹ | DIF ä¸Šç©¿ MACDï¼Œä¸” > 0 | å¼·å‹¢è²·é» |
| é»ƒé‡‘äº¤å‰ + é›¶è»¸ä¸‹æ–¹ | DIF ä¸Šç©¿ MACDï¼Œä½† < 0 | å¼±å‹¢åå½ˆ |
| æ­»äº¡äº¤å‰ + é›¶è»¸ä¸Šæ–¹ | DIF ä¸‹ç©¿ MACDï¼Œä½† > 0 | å›æª”ä¿®æ­£ |
| æ­»äº¡äº¤å‰ + é›¶è»¸ä¸‹æ–¹ | DIF ä¸‹ç©¿ MACDï¼Œä¸” < 0 | å¼·å‹¢è³£é» |

---

### 6.4 KDï¼ˆéš¨æ©ŸæŒ‡æ¨™ï¼‰

**å®šç¾©ï¼š** è¡¡é‡æ”¶ç›¤åƒ¹åœ¨ä¸€æ®µæ™‚é–“å…§çš„ç›¸å°ä½ç½®

**é è¨­åƒæ•¸ï¼š** (9, 3, 3)

**è¨ˆç®—å…¬å¼ï¼š**
```
RSV = (ä»Šæ—¥æ”¶ç›¤ - 9æ—¥æœ€ä½) / (9æ—¥æœ€é«˜ - 9æ—¥æœ€ä½) Ã— 100
K = 2/3 Ã— æ˜¨æ—¥K + 1/3 Ã— RSV
D = 2/3 Ã— æ˜¨æ—¥D + 1/3 Ã— K
```

**è¨Šè™Ÿï¼š**
| è¨Šè™Ÿ | æ¢ä»¶ | æ„ç¾© |
|------|------|------|
| K > 80 | è¶…è²·å€ | ç•™æ„å›æª” |
| K < 20 | è¶…è³£å€ | ç•™æ„åå½ˆ |
| K ä¸Šç©¿ D | é»ƒé‡‘äº¤å‰ | è²·é€²è¨Šè™Ÿ |
| K ä¸‹ç©¿ D | æ­»äº¡äº¤å‰ | è³£å‡ºè¨Šè™Ÿ |
| ä½æª”éˆåŒ– | K æŒçºŒ < 20 | æ¥µå¼±å‹¢ï¼Œå‹¿æ¥åˆ€ |

---

### 6.5 å¸ƒæ—é€šé“ (Bollinger Bands)

**å®šç¾©ï¼š** ä»¥ç§»å‹•å¹³å‡ç‚ºä¸­å¿ƒï¼Œä¸Šä¸‹åŠ æ¸›æ¨™æº–å·®å½¢æˆé€šé“

**é è¨­åƒæ•¸ï¼š** é€±æœŸ 20ï¼Œæ¨™æº–å·® 2 å€

**è¨ˆç®—å…¬å¼ï¼š**
```
ä¸­è»Œ = MA(20)
ä¸Šè»Œ = MA(20) + 2 Ã— æ¨™æº–å·®
ä¸‹è»Œ = MA(20) - 2 Ã— æ¨™æº–å·®
å¸¶å¯¬ = (ä¸Šè»Œ - ä¸‹è»Œ) / ä¸­è»Œ
```

**è¨Šè™Ÿï¼š**
| è¨Šè™Ÿ | æ¢ä»¶ | æ„ç¾© |
|------|------|------|
| è§¸åŠä¸Šè»Œ | åƒ¹æ ¼ â‰¥ ä¸Šè»Œ | çŸ­ç·šå¼·å‹¢ï¼Œå¯èƒ½å›æª” |
| è§¸åŠä¸‹è»Œ | åƒ¹æ ¼ â‰¤ ä¸‹è»Œ | çŸ­ç·šå¼±å‹¢ï¼Œå¯èƒ½åå½ˆ |
| é€šé“æ”¶çª„ | å¸¶å¯¬å‰µæ–°ä½ | ç›¤æ•´ï¼Œå³å°‡è®Šç›¤ |
| é€šé“æ“´å¼µ | å¸¶å¯¬æ”¾å¤§ | è¶¨å‹¢é€²è¡Œä¸­ |

---

### 6.6 OBVï¼ˆèƒ½é‡æ½®æŒ‡æ¨™ï¼‰

**å®šç¾©ï¼š** ç´¯ç©æˆäº¤é‡ï¼Œåˆ¤æ–·è³‡é‡‘æµå‘

**è¨ˆç®—é‚è¼¯ï¼š**
```python
if ä»Šæ—¥æ”¶ç›¤ > æ˜¨æ—¥æ”¶ç›¤:
    OBV = æ˜¨æ—¥OBV + ä»Šæ—¥æˆäº¤é‡
elif ä»Šæ—¥æ”¶ç›¤ < æ˜¨æ—¥æ”¶ç›¤:
    OBV = æ˜¨æ—¥OBV - ä»Šæ—¥æˆäº¤é‡
else:
    OBV = æ˜¨æ—¥OBV
```

**è¨Šè™Ÿï¼š**
| è¨Šè™Ÿ | æ¢ä»¶ | æ„ç¾© |
|------|------|------|
| OBV ä¸Šå‡ | OBV æŒçºŒå‰µæ–°é«˜ | è³‡é‡‘æµå…¥ |
| OBV ä¸‹é™ | OBV æŒçºŒç ´åº• | è³‡é‡‘æµå‡º |
| èƒŒé›¢ | åƒ¹æ¼²ä½† OBV ä¸æ¼² | æ¼²å‹¢å¯èƒ½è¡°ç«­ |

---

### 6.7 æˆäº¤é‡åˆ†æ

**æŒ‡æ¨™ï¼š**
| æŒ‡æ¨™ | è¨ˆç®— | æ„ç¾© |
|------|------|------|
| ä»Šæ—¥é‡ | ç•¶æ—¥æˆäº¤é‡ | - |
| 20 æ—¥å‡é‡ | è¿‘ 20 æ—¥å¹³å‡ | åŸºæº–é‡ |
| é‡æ¯” | ä»Šæ—¥é‡ / å‡é‡ | ç›¸å°å¼·åº¦ |

**è¨Šè™Ÿï¼š**
| é‡æ¯” | ç‹€æ…‹ | æ„ç¾© |
|------|------|------|
| > 2.0 | çˆ†é‡ | é—œæ³¨å¾ŒçºŒæ–¹å‘ |
| 1.0 - 2.0 | æ­£å¸¸åå¤š | é‡åƒ¹é…åˆ |
| 0.5 - 1.0 | ç¸®é‡ | è§€æœ›æ°£æ°› |
| < 0.5 | æ¥µåº¦ç¸®é‡ | å†·é–€æˆ–ç›¤æ•´ |

---

### 6.8 ç¶œåˆè©•åˆ†ç³»çµ±

æ ¹æ“šå¤šæŒ‡æ¨™å…±æŒ¯çµ¦äºˆè©•åˆ†ï¼š

**è²·é€²è¨Šè™Ÿè©•åˆ†ï¼š**
| æ¢ä»¶ | åŠ åˆ† |
|------|------|
| å¤šé ­æ’åˆ— | +1 |
| RSI è¶…è³£å›å‡ | +1 |
| MACD é»ƒé‡‘äº¤å‰ | +1 |
| KD é»ƒé‡‘äº¤å‰ | +1 |
| å¸ƒæ—ä¸‹è»Œæ”¯æ’ | +1 |
| é‡èƒ½æ”¾å¤§ | +1 |
| OBV ä¸Šå‡ | +1 |

**è³£å‡ºè¨Šè™Ÿè©•åˆ†ï¼š**
| æ¢ä»¶ | åŠ åˆ† |
|------|------|
| ç©ºé ­æ’åˆ— | +1 |
| RSI è¶…è²·ä¸‹å½ | +1 |
| MACD æ­»äº¡äº¤å‰ | +1 |
| KD æ­»äº¡äº¤å‰ | +1 |
| è·Œç ´å¸ƒæ—ä¸­è»Œ | +1 |
| é‡åƒ¹èƒŒé›¢ | +1 |
| OBV ä¸‹é™ | +1 |

**è©•åˆ†ç­‰ç´šï¼š**
| åˆ†æ•¸ | ç­‰ç´š | å»ºè­° |
|------|------|------|
| 5-7 | â­â­â­â­â­ | å¼·çƒˆè¨Šè™Ÿ |
| 3-4 | â­â­â­â­ | ä¸­ç­‰è¨Šè™Ÿ |
| 1-2 | â­â­ | å¼±è¨Šè™Ÿ |
| 0 | - | ç„¡æ˜é¡¯è¨Šè™Ÿ |

---

## 7. ç”¨æˆ¶ç³»çµ±

### 7.1 LINE Login æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LINE Login æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ¶é»æ“Šã€ŒLINE ç™»å…¥ã€
          â”‚
          â–¼
    è·³è½‰è‡³ LINE æˆæ¬Šé é¢
    https://access.line.me/oauth2/v2.1/authorize
          â”‚
          â–¼
     ç”¨æˆ¶åŒæ„æˆæ¬Š
          â”‚
          â–¼
    LINE å›å‚³ authorization code
          â”‚
          â–¼
    å¾Œç«¯ç”¨ code æ›å– access_token
    POST https://api.line.me/oauth2/v2.1/token
          â”‚
          â–¼
    ç”¨ access_token å–å¾—ç”¨æˆ¶è³‡æ–™
    GET https://api.line.me/v2/profile
          â”‚
          â”œâ”€ line_user_id
          â”œâ”€ displayName
          â””â”€ pictureUrl
          â”‚
          â–¼
    â”Œâ”€ æ–°ç”¨æˆ¶ â†’ å»ºç«‹å¸³è™Ÿï¼Œåˆå§‹åŒ–é è¨­è¨­å®š
    â”‚
    â””â”€ èˆŠç”¨æˆ¶ â†’ æ›´æ–° last_login
          â”‚
          â–¼
    ç™¼é€ JWT Token çµ¦å‰ç«¯
          â”‚
          â–¼
      ç™»å…¥å®Œæˆ âœ…
```

### 7.2 LINE Login æ‰€éœ€è¨­å®š

1. å»ºç«‹ LINE Login Channelï¼ˆLINE Developers Consoleï¼‰
2. è¨­å®š Callback URL
3. å–å¾— Channel ID å’Œ Channel Secret

### 7.3 JWT Token è¨­è¨ˆ

**Payloadï¼š**
```json
{
  "user_id": 123,
  "line_user_id": "Uxxxxxxxxxxxx",
  "display_name": "ç”¨æˆ¶åç¨±",
  "exp": 1234567890
}
```

**Token æœ‰æ•ˆæœŸï¼š** 7 å¤©

---

## 8. é€šçŸ¥ç³»çµ±

### 8.1 é€šçŸ¥é¡å‹

#### å‡ç·šç›¸é—œ

| é¡å‹ | æ¢ä»¶ | è¨Šæ¯ç¯„ä¾‹ |
|------|------|----------|
| æ¥è¿‘çªç ´ | åƒ¹æ ¼åœ¨å‡ç·šä¸‹æ–¹ï¼Œå·®è· < é–€æª» | "AAPL æ¥è¿‘çªç ´ MA50 â¬†ï¸" |
| æ¥è¿‘è·Œç ´ | åƒ¹æ ¼åœ¨å‡ç·šä¸Šæ–¹ï¼Œå·®è· < é–€æª» | "AAPL æ¥è¿‘è·Œç ´ MA20 â¬‡ï¸" |
| å·²çªç ´ | åƒ¹æ ¼ç”±ä¸‹å¾€ä¸Šç©¿è¶Šå‡ç·š | "AAPL å·²çªç ´ MA50 âœ…" |
| å·²è·Œç ´ | åƒ¹æ ¼ç”±ä¸Šå¾€ä¸‹ç©¿è¶Šå‡ç·š | "AAPL å·²è·Œç ´ MA20 âŒ" |
| é»ƒé‡‘äº¤å‰ | çŸ­å‡ç·šä¸Šç©¿é•·å‡ç·š | "AAPL MA20 é»ƒé‡‘äº¤å‰ MA50 ğŸŸ¢" |
| æ­»äº¡äº¤å‰ | çŸ­å‡ç·šä¸‹ç©¿é•·å‡ç·š | "AAPL MA20 æ­»äº¡äº¤å‰ MA50 ğŸ”´" |

#### å…¶ä»–æŒ‡æ¨™

| é¡å‹ | æ¢ä»¶ | è¨Šæ¯ç¯„ä¾‹ |
|------|------|----------|
| RSI è¶…è²· | RSI > è¶…è²·é–€æª» | "NVDA RSI é” 75ï¼Œé€²å…¥è¶…è²·å€ âš ï¸" |
| RSI è¶…è³£ | RSI < è¶…è³£é–€æª» | "TSLA RSI è·Œè‡³ 25ï¼Œé€²å…¥è¶…è³£å€ ğŸŸ¢" |
| MACD é»ƒé‡‘äº¤å‰ | DIF ä¸Šç©¿ MACD | "MSFT MACD é»ƒé‡‘äº¤å‰ ğŸŸ¢" |
| MACD æ­»äº¡äº¤å‰ | DIF ä¸‹ç©¿ MACD | "GOOGL MACD æ­»äº¡äº¤å‰ ğŸ”´" |
| é‡èƒ½ç•°å¸¸ | é‡æ¯” > é–€æª» | "AMD æˆäº¤é‡æš´å¢ (é‡æ¯” 2.5) ğŸ“Š" |
| æƒ…ç·’æ¥µç«¯ | æŒ‡æ•¸ < 20 æˆ– > 80 | "å¹£åœˆæ¥µåº¦ææ‡¼ (18)ï¼Œç•™æ„æ©Ÿæœƒ ğŸ˜±" |

### 8.2 é€šçŸ¥æµç¨‹

```
æ’ç¨‹ä»»å‹™è§¸ç™¼ï¼ˆæ¯æ—¥æ”¶ç›¤å¾Œï¼‰
          â”‚
          â–¼
    è¼‰å…¥æ‰€æœ‰éœ€æª¢æŸ¥çš„æ¨™çš„
    ï¼ˆæ‰€æœ‰ç”¨æˆ¶è¿½è¹¤æ¸…å–®çš„è¯é›†ï¼‰
          â”‚
          â–¼
    æ›´æ–°åƒ¹æ ¼è³‡æ–™
          â”‚
          â–¼
    è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  éæ­·æ¯å€‹ç”¨æˆ¶           â”‚
    â”‚    â”‚                   â”‚
    â”‚    â–¼                   â”‚
    â”‚  éæ­·ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®     â”‚
    â”‚    â”‚                   â”‚
    â”‚    â–¼                   â”‚
    â”‚  æ ¹æ“šç”¨æˆ¶çš„é€šçŸ¥è¨­å®š     â”‚
    â”‚  æª¢æŸ¥æ˜¯å¦è§¸ç™¼æ¢ä»¶       â”‚
    â”‚    â”‚                   â”‚
    â”‚    â–¼                   â”‚
    â”‚  â”Œâ”€ æœªè§¸ç™¼ â†’ ç•¥é      â”‚
    â”‚  â”‚                     â”‚
    â”‚  â””â”€ è§¸ç™¼ â†’ æª¢æŸ¥æ˜¯å¦    â”‚
    â”‚            å·²é€šçŸ¥é    â”‚
    â”‚              â”‚         â”‚
    â”‚    â”Œâ”€ æ˜¯ â†’ ç•¥é       â”‚
    â”‚    â”‚                   â”‚
    â”‚    â””â”€ å¦ â†’ åŠ å…¥é€šçŸ¥    â”‚
    â”‚             ä½‡åˆ—       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    æ‰¹æ¬¡ç™¼é€ LINE æ¨æ’­
          â”‚
          â–¼
    æ›´æ–°é€šçŸ¥è¨˜éŒ„
```

### 8.3 é¿å…é‡è¤‡é€šçŸ¥

**è¦å‰‡ï¼š**
1. åŒä¸€è¨Šè™Ÿ 24 å°æ™‚å…§ä¸é‡è¤‡ç™¼é€
2. åƒ¹æ ¼ç©¿è¶Šå¾Œï¼ˆçªç ´/è·Œç ´ï¼‰ï¼Œæ¸…é™¤ã€Œæ¥è¿‘ã€çš„é€šçŸ¥è¨˜éŒ„
3. åˆä½µé€šçŸ¥ï¼šå¤šæª”åŒæ™‚è§¸ç™¼æ™‚ï¼Œåˆä½µç‚ºä¸€å‰‡è¨Šæ¯

### 8.4 LINE æ¨æ’­

**ä½¿ç”¨ LINE Messaging APIï¼š**
```
POST https://api.line.me/v2/bot/message/push
```

**æ‰€éœ€è¨­å®šï¼š**
1. å»ºç«‹ Messaging API Channel
2. å–å¾— Channel Access Token

---

## 9. åœ–è¡¨ç³»çµ±

### 9.1 åœ–è¡¨é¡å‹

| åœ–è¡¨ | ç”¨é€” |
|------|------|
| åƒ¹æ ¼èµ°å‹¢åœ– | é¡¯ç¤ºæ”¶ç›¤åƒ¹æŠ˜ç·š + å‡ç·š |
| K ç·šåœ– | é¡¯ç¤º OHLC + å‡ç·š |
| æˆäº¤é‡åœ– | æŸ±ç‹€åœ–é¡¯ç¤ºæ¯æ—¥æˆäº¤é‡ |
| æŒ‡æ¨™å­åœ– | RSIã€MACDã€KD ç­‰ç¨ç«‹é¡¯ç¤º |
| æƒ…ç·’èµ°å‹¢åœ– | Fear & Greed æ­·å²èµ°å‹¢ |

### 9.2 åœ–è¡¨å…ƒç´ 

**ä¸»åœ–ï¼ˆåƒ¹æ ¼ï¼‰ï¼š**
- æ”¶ç›¤åƒ¹æŠ˜ç·š æˆ– K ç·š
- MA20ï¼ˆè—è‰²ï¼‰
- MA50ï¼ˆæ©™è‰²ï¼‰
- MA200ï¼ˆç´…è‰²ï¼‰
- å¸ƒæ—é€šé“ï¼ˆæ·ºç°è‰²å€åŸŸï¼‰
- äº¤å‰é»æ¨™è¨˜ï¼ˆåœ“é»ï¼‰

**å‰¯åœ–ï¼ˆæŒ‡æ¨™ï¼‰ï¼š**
- æˆäº¤é‡æŸ±ç‹€åœ–
- RSI æŠ˜ç·š + è¶…è²·è¶…è³£ç·š
- MACD æŸ±ç‹€åœ– + DIF/MACD ç·š
- KD ç·š

### 9.3 ä½¿ç”¨è€…å¯è‡ªè¨‚é …ç›®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åœ–è¡¨é¡¯ç¤ºè¨­å®š              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ™‚é–“ç¯„åœ: [1M] [3M] [6M] [1Y]  â”‚
â”‚                                 â”‚
â”‚  ä¸»åœ–:                          â”‚
â”‚    â˜‘ æ”¶ç›¤åƒ¹                     â”‚
â”‚    â˜ K ç·š                       â”‚
â”‚    â˜‘ MA20 / MA50 / MA200        â”‚
â”‚    â˜‘ å¸ƒæ—é€šé“                   â”‚
â”‚    â˜‘ æ¨™è¨˜äº¤å‰é»                 â”‚
â”‚                                 â”‚
â”‚  å‰¯åœ–:                          â”‚
â”‚    â˜‘ æˆäº¤é‡                     â”‚
â”‚    â˜ RSI                        â”‚
â”‚    â˜ MACD                       â”‚
â”‚    â˜ KD                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.4 æŠ€è¡“å¯¦ä½œ

**æ¨è–¦å¥—ä»¶ï¼š** matplotlib + mplfinance

**è¼¸å‡ºæ ¼å¼ï¼š** PNG åœ–ç‰‡

---

## 10. API è¨­è¨ˆ

### 10.1 API ç«¯é»ç¸½è¦½

#### èªè­‰

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/auth/line` | å°å‘ LINE ç™»å…¥ |
| GET | `/auth/line/callback` | LINE ç™»å…¥å›èª¿ |
| POST | `/auth/logout` | ç™»å‡º |

#### è‚¡ç¥¨/åŠ å¯†è²¨å¹£

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/api/stock/{symbol}` | æŸ¥è©¢å–®ä¸€è‚¡ç¥¨ |
| GET | `/api/crypto/{symbol}` | æŸ¥è©¢å–®ä¸€åŠ å¯†è²¨å¹£ |
| GET | `/api/market/sentiment` | å–å¾—å¸‚å ´æƒ…ç·’ |
| GET | `/api/stock/{symbol}/chart` | å–å¾—è‚¡ç¥¨åœ–è¡¨ |
| GET | `/api/crypto/{symbol}/chart` | å–å¾—åŠ å¯†è²¨å¹£åœ–è¡¨ |

#### è¿½è¹¤æ¸…å–®

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/api/watchlist` | å–å¾—è¿½è¹¤æ¸…å–® |
| POST | `/api/watchlist` | æ–°å¢è¿½è¹¤æ¨™çš„ |
| DELETE | `/api/watchlist/{id}` | åˆªé™¤è¿½è¹¤æ¨™çš„ |
| GET | `/api/watchlist/overview` | è¿½è¹¤æ¸…å–®ç¸½è¦½ |

#### è¨­å®š

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/api/settings/indicators` | å–å¾—æŒ‡æ¨™è¨­å®š |
| PUT | `/api/settings/indicators` | æ›´æ–°æŒ‡æ¨™è¨­å®š |
| GET | `/api/settings/alerts` | å–å¾—é€šçŸ¥è¨­å®š |
| PUT | `/api/settings/alerts` | æ›´æ–°é€šçŸ¥è¨­å®š |
| GET | `/api/settings/params` | å–å¾—åƒæ•¸è¨­å®š |
| PUT | `/api/settings/params` | æ›´æ–°åƒæ•¸è¨­å®š |
| POST | `/api/settings/template` | å¥—ç”¨é è¨­æ¨¡æ¿ |

---

### 10.2 API å›æ‡‰æ ¼å¼

#### æˆåŠŸå›æ‡‰

```json
{
  "success": true,
  "data": { ... }
}
```

#### éŒ¯èª¤å›æ‡‰

```json
{
  "success": false,
  "error": {
    "code": "INVALID_SYMBOL",
    "message": "æ‰¾ä¸åˆ°æ­¤è‚¡ç¥¨ä»£è™Ÿ"
  }
}
```

---

### 10.3 ä¸»è¦ API è©³ç´°è¦æ ¼

#### GET /api/stock/{symbol}

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "symbol": "AAPL",
    "name": "Apple Inc.",
    "asset_type": "stock",
    "price": {
      "current": 195.50,
      "high_52w": 199.62,
      "low_52w": 164.08,
      "from_high_pct": -2.07,
      "from_low_pct": 19.15
    },
    "change": {
      "day": 1.25,
      "week": 3.42,
      "month": 8.15,
      "quarter": 12.30,
      "year": 48.25,
      "ytd": 5.60
    },
    "volume": {
      "today": 52300000,
      "avg_20d": 48500000,
      "ratio": 1.08
    },
    "indicators": {
      "ma": {
        "ma20": 192.30,
        "ma50": 188.75,
        "ma200": 178.20,
        "alignment": "bullish",
        "price_vs_ma20": "above",
        "price_vs_ma50": "above",
        "price_vs_ma200": "above"
      },
      "rsi": {
        "value": 62.5,
        "status": "neutral"
      },
      "macd": {
        "dif": 2.35,
        "macd": 1.98,
        "histogram": 0.37,
        "status": "bullish"
      },
      "kd": {
        "k": 68.5,
        "d": 62.3,
        "status": "neutral_high"
      },
      "bollinger": {
        "upper": 198.50,
        "middle": 192.30,
        "lower": 186.10,
        "position": "upper_half"
      },
      "obv": {
        "trend": "rising"
      }
    },
    "signals": {
      "recent": [
        {
          "date": "2025-01-10",
          "type": "ma_golden_cross",
          "description": "MA20 é»ƒé‡‘äº¤å‰ MA50"
        }
      ]
    },
    "score": {
      "buy": 4,
      "sell": 0,
      "rating": "bullish"
    },
    "updated_at": "2025-01-15T05:30:00Z"
  }
}
```

#### GET /api/watchlist/overview

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "stocks": [
      {
        "symbol": "AAPL",
        "price": 195.50,
        "change_day": 1.25,
        "ma_alignment": "bullish",
        "score": 4
      }
    ],
    "crypto": [
      {
        "symbol": "BTC",
        "price": 67850,
        "change_24h": 2.35,
        "ma_alignment": "bullish",
        "score": 3
      }
    ],
    "sentiment": {
      "stock": {
        "value": 45,
        "classification": "neutral"
      },
      "crypto": {
        "value": 32,
        "classification": "fear"
      }
    }
  }
}
```

---

## 11. æŠ€è¡“é¸å‹

### 11.1 å¾Œç«¯

| é …ç›® | é¸æ“‡ | ç†ç”± |
|------|------|------|
| èªè¨€ | Python 3.10+ | è±å¯Œçš„é‡‘èåˆ†æå¥—ä»¶ |
| æ¡†æ¶ | FastAPI | ç¾ä»£ã€é«˜æ•ˆèƒ½ã€è‡ªå‹• API æ–‡ä»¶ |
| è³‡æ–™åº« | PostgreSQL | ç©©å®šã€æ”¯æ´å¤šç”¨æˆ¶ä½µç™¼ |
| ORM | SQLAlchemy | æˆç†Ÿç©©å®š |
| ä»»å‹™æ’ç¨‹ | APScheduler æˆ– Celery | å®šæ™‚æ›´æ–°è³‡æ–™ |
| å¿«å– | Redisï¼ˆé¸é…ï¼‰ | åŠ é€Ÿé »ç¹æŸ¥è©¢ |

### 11.2 è³‡æ–™è™•ç†

| é …ç›® | å¥—ä»¶ |
|------|------|
| è‚¡åƒ¹æŠ“å– | yfinance |
| æ•¸æ“šè™•ç† | pandas, numpy |
| æŠ€è¡“æŒ‡æ¨™ | ta-lib æˆ– pandas-ta |
| åœ–è¡¨ç¹ªè£½ | matplotlib, mplfinance |

### 11.3 å¤–éƒ¨æœå‹™

| é …ç›® | æœå‹™ |
|------|------|
| ç”¨æˆ¶é©—è­‰ | LINE Login API |
| æ¨æ’­é€šçŸ¥ | LINE Messaging API |
| è‚¡åƒ¹è³‡æ–™ | Yahoo Finance |
| å¹£åƒ¹è³‡æ–™ | CoinGecko API |
| æƒ…ç·’æŒ‡æ•¸ | CNN, Alternative.me |

### 11.4 éƒ¨ç½²

| é …ç›® | å»ºè­°é¸é … |
|------|----------|
| ä¸»æ©Ÿ | Render / Railway / DigitalOcean / AWS |
| è³‡æ–™åº« | Supabase / Railway PostgreSQL / AWS RDS |
| æ’ç¨‹ | ä¸»æ©Ÿå…§å»º æˆ– å¤–éƒ¨ Cron æœå‹™ |

### 11.5 å‰ç«¯ï¼ˆé¸é…ï¼‰

| æ–¹æ¡ˆ | èªªæ˜ |
|------|------|
| ç´” LINE Bot | æœ€è¼•é‡ï¼Œç”¨æŒ‡ä»¤äº’å‹• |
| Web æ‡‰ç”¨ | React / Vue + REST API |
| æ··åˆ | Web ç‚ºä¸»ï¼ŒLINE Bot æ¨æ’­ |

---

## 12. é–‹ç™¼éšæ®µ

### éšæ®µä¸€ï¼šæ ¸å¿ƒåŸºç¤

**ç›®æ¨™ï¼š** å–®æ©Ÿå¯é‹è¡Œçš„è‚¡ç¥¨åˆ†æå·¥å…·

**åŠŸèƒ½ï¼š**
- [ ] è‚¡ç¥¨è³‡æ–™æŠ“å–ï¼ˆyfinanceï¼‰
- [ ] æœ¬åœ° SQLite å¿«å–
- [ ] åŸºæœ¬æŠ€è¡“æŒ‡æ¨™ï¼ˆMA20/50/200ï¼‰
- [ ] å‘½ä»¤åˆ—æŸ¥è©¢ä»‹é¢

**ç”¢å‡ºï¼š** å¯ç”¨ CLI æŸ¥è©¢è‚¡ç¥¨è³‡è¨Š

---

### éšæ®µäºŒï¼šå®Œæ•´æŒ‡æ¨™

**ç›®æ¨™ï¼š** å®Œæ•´çš„æŠ€è¡“åˆ†æåŠŸèƒ½

**åŠŸèƒ½ï¼š**
- [ ] RSI è¨ˆç®—èˆ‡åˆ¤è®€
- [ ] MACD è¨ˆç®—èˆ‡åˆ¤è®€
- [ ] KD è¨ˆç®—èˆ‡åˆ¤è®€
- [ ] å¸ƒæ—é€šé“
- [ ] OBV
- [ ] æˆäº¤é‡åˆ†æ
- [ ] ç¶œåˆè©•åˆ†ç³»çµ±
- [ ] åœ–è¡¨ç¹ªè£½

**ç”¢å‡ºï¼š** å®Œæ•´æŠ€è¡“åˆ†æå ±å‘Šèˆ‡åœ–è¡¨

---

### éšæ®µä¸‰ï¼šåŠ å¯†è²¨å¹£

**ç›®æ¨™ï¼š** æ•´åˆå¹£åœˆè³‡æ–™

**åŠŸèƒ½ï¼š**
- [ ] CoinGecko API æ•´åˆ
- [ ] BTC/ETH åƒ¹æ ¼è¿½è¹¤
- [ ] å¹£åœˆæŠ€è¡“æŒ‡æ¨™
- [ ] å¸‚å ´æƒ…ç·’æŒ‡æ•¸ï¼ˆé›™å¸‚å ´ï¼‰

**ç”¢å‡ºï¼š** è‚¡ç¥¨ + åŠ å¯†è²¨å¹£çµ±ä¸€åˆ†æ

---

### éšæ®µå››ï¼šç”¨æˆ¶ç³»çµ±

**ç›®æ¨™ï¼š** å¤šç”¨æˆ¶æ”¯æ´

**åŠŸèƒ½ï¼š**
- [ ] è³‡æ–™åº«é·ç§»è‡³ PostgreSQL
- [ ] LINE Login æ•´åˆ
- [ ] ç”¨æˆ¶è³‡æ–™è¡¨å»ºç«‹
- [ ] è¿½è¹¤æ¸…å–®åŠŸèƒ½
- [ ] JWT é©—è­‰

**ç”¢å‡ºï¼š** å¯ç™»å…¥ã€æœ‰å€‹äººè¿½è¹¤æ¸…å–®

---

### éšæ®µäº”ï¼šå€‹äººåŒ–è¨­å®š

**ç›®æ¨™ï¼š** ç”¨æˆ¶è‡ªè¨‚é«”é©—

**åŠŸèƒ½ï¼š**
- [ ] æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
- [ ] é€šçŸ¥è¨­å®š
- [ ] åƒæ•¸èª¿æ•´
- [ ] é è¨­æ¨¡æ¿

**ç”¢å‡ºï¼š** å®Œæ•´çš„è¨­å®šç³»çµ±

---

### éšæ®µå…­ï¼šé€šçŸ¥ç³»çµ±

**ç›®æ¨™ï¼š** è‡ªå‹•æ¨æ’­è­¦å ±

**åŠŸèƒ½ï¼š**
- [ ] LINE Messaging API æ•´åˆ
- [ ] æ’ç¨‹ä»»å‹™å»ºç«‹
- [ ] è¨Šè™Ÿåµæ¸¬å¼•æ“
- [ ] é€šçŸ¥è¨˜éŒ„èˆ‡é˜²é‡è¤‡

**ç”¢å‡ºï¼š** è‡ªå‹•æ¨æ’­æŠ€è¡“è¨Šè™Ÿ

---

### éšæ®µä¸ƒï¼šWeb ä»‹é¢ï¼ˆé¸é…ï¼‰

**ç›®æ¨™ï¼š** æä¾›ç¶²é æ“ä½œä»‹é¢

**åŠŸèƒ½ï¼š**
- [ ] å‰ç«¯æ¡†æ¶å»ºç«‹
- [ ] ç™»å…¥é é¢
- [ ] å„€è¡¨æ¿é é¢
- [ ] è¨­å®šé é¢
- [ ] äº’å‹•å¼åœ–è¡¨

**ç”¢å‡ºï¼š** å®Œæ•´ Web æ‡‰ç”¨

---

### éšæ®µå…«ï¼šå„ªåŒ–èˆ‡ä¸Šç·š

**ç›®æ¨™ï¼š** æ­£å¼ç’°å¢ƒéƒ¨ç½²

**åŠŸèƒ½ï¼š**
- [ ] æ•ˆèƒ½å„ªåŒ–
- [ ] éŒ¯èª¤è™•ç†å®Œå–„
- [ ] æ—¥èªŒç³»çµ±
- [ ] ç›£æ§èˆ‡å‘Šè­¦
- [ ] æ­£å¼ç’°å¢ƒéƒ¨ç½²

**ç”¢å‡ºï¼š** ç©©å®šé‹è¡Œçš„ç”Ÿç”¢ç³»çµ±

---

## é™„éŒ„

### A. ç’°å¢ƒè®Šæ•¸

```bash
# è³‡æ–™åº«
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# LINE Login
LINE_LOGIN_CHANNEL_ID=your_channel_id
LINE_LOGIN_CHANNEL_SECRET=your_channel_secret
LINE_LOGIN_CALLBACK_URL=https://your-domain.com/auth/line/callback

# LINE Messaging
LINE_MESSAGING_CHANNEL_ACCESS_TOKEN=your_access_token

# JWT
JWT_SECRET_KEY=your_secret_key
JWT_EXPIRE_DAYS=7

# æ‡‰ç”¨ç¨‹å¼
APP_ENV=development
APP_DEBUG=true
```

### B. å°ˆæ¡ˆç›®éŒ„çµæ§‹

```
stock-analysis/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI å…¥å£
â”‚   â”œâ”€â”€ config.py            # è¨­å®šæª”
â”‚   â”œâ”€â”€ database.py          # è³‡æ–™åº«é€£ç·š
â”‚   â”‚
â”‚   â”œâ”€â”€ models/              # è³‡æ–™æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ watchlist.py
â”‚   â”‚   â”œâ”€â”€ stock_price.py
â”‚   â”‚   â”œâ”€â”€ crypto_price.py
â”‚   â”‚   â”œâ”€â”€ sentiment.py
â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â””â”€â”€ settings.py
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/             # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ stock.py
â”‚   â”‚   â”œâ”€â”€ crypto.py
â”‚   â”‚   â””â”€â”€ settings.py
â”‚   â”‚
â”‚   â”œâ”€â”€ routers/             # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ stock.py
â”‚   â”‚   â”œâ”€â”€ crypto.py
â”‚   â”‚   â”œâ”€â”€ watchlist.py
â”‚   â”‚   â””â”€â”€ settings.py
â”‚   â”‚
â”‚   â”œâ”€â”€ services/            # å•†æ¥­é‚è¼¯
â”‚   â”‚   â”œâ”€â”€ stock_service.py
â”‚   â”‚   â”œâ”€â”€ crypto_service.py
â”‚   â”‚   â”œâ”€â”€ indicator_service.py
â”‚   â”‚   â”œâ”€â”€ chart_service.py
â”‚   â”‚   â”œâ”€â”€ notification_service.py
â”‚   â”‚   â””â”€â”€ line_service.py
â”‚   â”‚
â”‚   â”œâ”€â”€ data_sources/        # å¤–éƒ¨è³‡æ–™ä¾†æº
â”‚   â”‚   â”œâ”€â”€ yahoo_finance.py
â”‚   â”‚   â”œâ”€â”€ coingecko.py
â”‚   â”‚   â”œâ”€â”€ cnn_fear_greed.py
â”‚   â”‚   â””â”€â”€ alternative_me.py
â”‚   â”‚
â”‚   â””â”€â”€ tasks/               # æ’ç¨‹ä»»å‹™
â”‚       â”œâ”€â”€ update_prices.py
â”‚       â”œâ”€â”€ update_sentiment.py
â”‚       â””â”€â”€ check_alerts.py
â”‚
â”œâ”€â”€ tests/                   # æ¸¬è©¦
â”œâ”€â”€ migrations/              # è³‡æ–™åº«é·ç§»
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

### C. åƒè€ƒè³‡æº

- [yfinance æ–‡ä»¶](https://github.com/ranaroussi/yfinance)
- [CoinGecko API æ–‡ä»¶](https://www.coingecko.com/en/api/documentation)
- [LINE Login æ–‡ä»¶](https://developers.line.biz/en/docs/line-login/)
- [LINE Messaging API æ–‡ä»¶](https://developers.line.biz/en/docs/messaging-api/)
- [FastAPI æ–‡ä»¶](https://fastapi.tiangolo.com/)
- [pandas-ta æŠ€è¡“æŒ‡æ¨™](https://github.com/twopirllc/pandas-ta)

---

> æœ¬æ–‡ä»¶ç‚ºé–‹ç™¼è¦æ ¼æ›¸ï¼Œå¯¦éš›é–‹ç™¼æ™‚å¯ä¾éœ€æ±‚èª¿æ•´ç´°ç¯€ã€‚
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/æ•´åˆæŒ‡å—.md  â­â­â­
> ğŸ› ï¸ SELA è¨­å®šé é¢ UI - æ•´åˆæŒ‡å—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ› ï¸ SELA è¨­å®šé é¢ UI - æ•´åˆæŒ‡å—

> ç‰ˆæœ¬: 1.0.0  
> æ›´æ–°æ—¥æœŸ: 2026-01-12

---

## ğŸ“¦ æª”æ¡ˆæ¸…å–®

```
settings-ui-update/
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ settings.css      # è¨­å®šé é¢æ¨£å¼
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â””â”€â”€ settings.js       # è¨­å®šé é¢é‚è¼¯
â”‚   â””â”€â”€ settings-section.html # HTML ç‰‡æ®µ
â””â”€â”€ æ•´åˆæŒ‡å—.md                # æœ¬æ–‡ä»¶
```

---

## ğŸš€ å¿«é€Ÿæ•´åˆæ­¥é©Ÿ

### æ­¥é©Ÿ 1: è¤‡è£½éœæ…‹è³‡æº

å°‡ `static/css/` å’Œ `static/js/` è³‡æ–™å¤¾è¤‡è£½åˆ°å°ˆæ¡ˆçš„ `static/` ç›®éŒ„ä¸‹ï¼š

```bash
cp -r static/css static/js /path/to/your/project/static/
```

### æ­¥é©Ÿ 2: åœ¨ dashboard.html å¼•å…¥è³‡æº

åœ¨ `<head>` å€å¡Šå…§åŠ å…¥ CSSï¼š

```html
<!-- è¨­å®šé é¢æ¨£å¼ -->
<link rel="stylesheet" href="/static/css/settings.css">
```

åœ¨ `</body>` æ¨™ç±¤ä¹‹å‰åŠ å…¥ JavaScriptï¼š

```html
<!-- è¨­å®šé é¢è…³æœ¬ -->
<script src="/static/js/settings.js"></script>
```

### æ­¥é©Ÿ 3: åŠ å…¥ HTML çµæ§‹

å°‡ `settings-section.html` çš„å…§å®¹è¤‡è£½åˆ° dashboard.html ä¸­ï¼Œæ”¾åœ¨å…¶ä»– section ä¹‹å¾Œï¼š

```html
<!-- ç¾æœ‰çš„ sections -->
<section id="section-dashboard" class="section">...</section>
<section id="section-watchlist" class="section hidden">...</section>
<section id="section-compare" class="section hidden">...</section>

<!-- æ–°å¢ï¼šè¨­å®šé é¢ section -->
<section id="section-settings" class="section hidden">
    <!-- å¾ settings-section.html è¤‡è£½å…§å®¹ -->
</section>
```

### æ­¥é©Ÿ 4: æ–°å¢å°èˆªé€£çµ

#### æ¡Œé¢ç‰ˆå°èˆªåˆ—

åœ¨ `<nav>` å€å¡Šå…§åŠ å…¥è¨­å®šé€£çµï¼š

```html
<a onclick="showSection('settings', event)" 
   class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer">
    <i class="fas fa-cog mr-2"></i>
    è¨­å®š
</a>
```

#### æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆª

åœ¨åº•éƒ¨å°èˆªåˆ—åŠ å…¥ï¼š

```html
<button onclick="showSection('settings', event)" 
        class="nav-tab flex flex-col items-center py-2 px-3 text-gray-500 hover:text-orange-500 transition-colors">
    <i class="fas fa-cog text-lg"></i>
    <span class="text-xs mt-1">è¨­å®š</span>
</button>
```

### æ­¥é©Ÿ 5: æ›´æ–° showSection å‡½æ•¸

åœ¨ç¾æœ‰çš„ `showSection` å‡½æ•¸ä¸­åŠ å…¥è¨­å®šé é¢çš„åˆå§‹åŒ–é‚è¼¯ï¼š

```javascript
function showSection(name, evt) {
    // ... åŸæœ‰çš„ section åˆ‡æ›é‚è¼¯ ...
    
    // åˆ‡æ›åˆ°è¨­å®šé æ™‚è¼‰å…¥è¨­å®š
    if (name === 'settings') {
        if (typeof initSettingsPage === 'function') {
            initSettingsPage();
        }
    }
}
```

### æ­¥é©Ÿ 6: æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º

åœ¨ç™»å…¥æˆåŠŸå¾Œï¼Œæ›´æ–°è¨­å®šé é¢çš„ç”¨æˆ¶è³‡è¨Šï¼š

```javascript
function updateSettingsUserInfo() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    const avatar = document.getElementById('settings-user-avatar');
    const name = document.getElementById('settings-user-name');
    const level = document.getElementById('settings-user-level');
    
    if (avatar && user.avatar_url) {
        avatar.src = user.avatar_url;
    }
    if (name) {
        name.textContent = user.display_name || 'ç”¨æˆ¶';
    }
    if (level) {
        level.textContent = user.is_admin ? 'ç®¡ç†å“¡' : 'å…è²»æœƒå“¡';
    }
}

// åœ¨ checkAuth() æˆåŠŸå¾Œèª¿ç”¨
updateSettingsUserInfo();
```

---

## ğŸ”§ API ä¾è³´

è¨­å®šé é¢éœ€è¦ä»¥ä¸‹ API ç«¯é»ï¼ˆæ‡‰å·²å­˜åœ¨æ–¼å¾Œç«¯ï¼‰ï¼š

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/settings/indicators` | GET | å–å¾—æŒ‡æ¨™é¡¯ç¤ºè¨­å®š |
| `/api/settings/indicators` | PUT | æ›´æ–°æŒ‡æ¨™é¡¯ç¤ºè¨­å®š |
| `/api/settings/alerts` | GET | å–å¾—é€šçŸ¥è¨­å®š |
| `/api/settings/alerts` | PUT | æ›´æ–°é€šçŸ¥è¨­å®š |
| `/api/settings/params` | GET | å–å¾—åƒæ•¸è¨­å®š |
| `/api/settings/params` | PUT | æ›´æ–°åƒæ•¸è¨­å®š |
| `/api/settings/template/{name}` | POST | å¥—ç”¨é è¨­æ¨¡æ¿ |

---

## ğŸ¨ è‡ªè¨‚æ¨£å¼

### ä¿®æ”¹ä¸»é¡Œè‰²

åœ¨ `settings.css` ä¸­æœå°‹ä¸¦æ›¿æ›ä»¥ä¸‹é¡è‰²ï¼š

- **ä¸»è‰²èª¿** (æ©™è‰²): `#f97316`, `#ea580c`
- **æ´»å‹•ç‹€æ…‹** (è—è‰²): `#3b82f6`, `#2563eb`
- **æˆåŠŸç‹€æ…‹** (ç¶ è‰²): `#16a34a`
- **éŒ¯èª¤ç‹€æ…‹** (ç´…è‰²): `#dc2626`

### è‡ªè¨‚é–‹é—œæ¨£å¼

ä¿®æ”¹ `.toggle-switch` å’Œ `.toggle-dot` é¡åˆ¥ã€‚

---

## âš ï¸ æ³¨æ„äº‹é …

1. **apiRequest å‡½æ•¸ä¾è³´**  
   `settings.js` ä¾è³´ dashboard.html ä¸­çš„ `apiRequest()` å‡½æ•¸ï¼Œç¢ºä¿è©²å‡½æ•¸å¯ç”¨ã€‚

2. **Token èªè­‰**  
   æ‰€æœ‰ API è«‹æ±‚éœ€è¦å¸¶æœ‰ Authorization headerï¼Œç”± `apiRequest()` è™•ç†ã€‚

3. **é›¢é–‹ç¢ºèª**  
   è‹¥éœ€è¦åœ¨é›¢é–‹è¨­å®šé é¢æ™‚æç¤ºæœªå„²å­˜è®Šæ›´ï¼Œå¯åœ¨ `showSection` ä¸­èª¿ç”¨ï¼š
   ```javascript
   if (!checkUnsavedChanges()) return;
   ```

4. **éŸ¿æ‡‰å¼è¨­è¨ˆ**  
   CSS å·²åŒ…å«æ‰‹æ©Ÿç‰ˆé©é…ï¼Œç„¡éœ€é¡å¤–è™•ç†ã€‚

---

## ğŸ› ç–‘é›£æ’è§£

### å•é¡Œï¼šè¨­å®šç„¡æ³•è¼‰å…¥

1. ç¢ºèª API ç«¯é»å¯ç”¨
2. æª¢æŸ¥ Console æ˜¯å¦æœ‰éŒ¯èª¤
3. ç¢ºèª Token æœ‰æ•ˆ

### å•é¡Œï¼šæ¨£å¼ä¸æ­£ç¢º

1. ç¢ºèª CSS æª”æ¡ˆå·²æ­£ç¢ºè¼‰å…¥
2. æ¸…é™¤ç€è¦½å™¨å¿«å– (Ctrl+Shift+R)
3. æª¢æŸ¥æ˜¯å¦æœ‰ CSS è¡çª

### å•é¡Œï¼šJavaScript éŒ¯èª¤

1. ç¢ºèª JS æª”æ¡ˆè¼‰å…¥é †åºæ­£ç¢ºï¼ˆsettings.js æ‡‰åœ¨ dashboard.html çš„ä¸»è…³æœ¬ä¹‹å¾Œï¼‰
2. ç¢ºèª `apiRequest` å‡½æ•¸å­˜åœ¨

---

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

- [ ] CSS æª”æ¡ˆå·²è¤‡è£½åˆ° `/static/css/`
- [ ] JS æª”æ¡ˆå·²è¤‡è£½åˆ° `/static/js/`
- [ ] dashboard.html å·²å¼•å…¥ CSS
- [ ] dashboard.html å·²å¼•å…¥ JS
- [ ] HTML section å·²åŠ å…¥
- [ ] å°èˆªé€£çµå·²åŠ å…¥ï¼ˆæ¡Œé¢ç‰ˆ + æ‰‹æ©Ÿç‰ˆï¼‰
- [ ] showSection å‡½æ•¸å·²æ›´æ–°
- [ ] æ¸¬è©¦ï¼šå¯ä»¥åˆ‡æ›åˆ°è¨­å®šé é¢
- [ ] æ¸¬è©¦ï¼šè¨­å®šå¯ä»¥æ­£å¸¸è¼‰å…¥
- [ ] æ¸¬è©¦ï¼šè¨­å®šå¯ä»¥æ­£å¸¸å„²å­˜
- [ ] æ¸¬è©¦ï¼šæ¨¡æ¿å¯ä»¥æ­£å¸¸å¥—ç”¨

---

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æä¾›ï¼š
1. ç€è¦½å™¨ Console éŒ¯èª¤è¨Šæ¯
2. Network é¢æ¿çš„ API è«‹æ±‚çµæœ
3. æ“ä½œæ­¥é©Ÿèªªæ˜

---

> âœ… æ•´åˆå®Œæˆå¾Œï¼Œç”¨æˆ¶å³å¯é€éè¨­å®šé é¢è‡ªè¨‚æŒ‡æ¨™é¡¯ç¤ºå’Œé€šçŸ¥åå¥½ï¼
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ README.md  â­â­â­
> ğŸš€ åƒ¹æ ¼å¿«å–åŠŸèƒ½ - å®Œæ•´æ•´åˆåŒ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸš€ åƒ¹æ ¼å¿«å–åŠŸèƒ½ - å®Œæ•´æ•´åˆåŒ…

## æ•ˆæœ

| å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|--------|--------|
| è¿½è¹¤ 5 æ”¯è‚¡ç¥¨è¼‰å…¥ 50-150 ç§’ | **< 1 ç§’** |

---

## æ•´åˆæ–¹å¼ï¼šç›´æ¥è¦†è“‹æª”æ¡ˆ

**ä¸éœ€è¦æ‰‹å‹•ä¿®æ”¹ä»»ä½•ç¨‹å¼ç¢¼ï¼Œç›´æ¥è¦†è“‹å³å¯ï¼**

| æª”æ¡ˆ | å‹•ä½œ |
|------|------|
| `app/main.py` | è¦†è“‹ |
| `app/models/__init__.py` | è¦†è“‹ |
| `app/models/price_cache.py` | æ–°å¢ |
| `app/services/price_cache_service.py` | æ–°å¢ |
| `app/routers/watchlist.py` | è¦†è“‹ |
| `static/dashboard.html` | è¦†è“‹ |

---

## ç¢ºèª requirements.txt

ç¢ºä¿æœ‰ä»¥ä¸‹å¥—ä»¶ï¼š

```
apscheduler>=3.10.0
```

---

## éƒ¨ç½²å¾Œ

1. é‡æ–°éƒ¨ç½²
2. è³‡æ–™è¡¨ `stock_price_cache` æœƒè‡ªå‹•å»ºç«‹
3. æ’ç¨‹æœƒè‡ªå‹•å•Ÿå‹•ï¼Œæ¯ 10 åˆ†é˜æ›´æ–°åƒ¹æ ¼
4. è¿½è¹¤æ¸…å–®æœƒå¾å¿«å–è®€å–åƒ¹æ ¼ï¼Œç§’é€Ÿè¼‰å…¥

---

## é©—è­‰

éƒ¨ç½²å¾Œè¨ªå•ï¼š

```
https://ä½ çš„ç¶²åŸŸ/api/watchlist/cache-status
```

æ‡‰è©²çœ‹åˆ°ï¼š
```json
{
  "success": true,
  "total_cached": 5,
  "tw_stocks": 3,
  "us_stocks": 2,
  "crypto": 0,
  "market_status": {
    "tw_open": true,
    "us_open": false,
    "crypto_open": true
  }
}
```

---

## æ’ç¨‹æ™‚é–“ï¼ˆå°ç£æ™‚é–“ï¼‰

| æ’ç¨‹ | åŸ·è¡Œæ™‚é–“ | èªªæ˜ |
|------|----------|------|
| æ¯ 10 åˆ†é˜ | å…¨å¤© | åªæ›´æ–°é–‹ç›¤ä¸­çš„å¸‚å ´ |
| å°è‚¡æ”¶ç›¤ | 13:35 | ç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹ |
| ç¾è‚¡æ”¶ç›¤ | 05:05 | ç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹ |

---

## æ–°å¢åŠŸèƒ½

1. âœ… **è¿½è¹¤æ¸…å–®ç§’é€Ÿè¼‰å…¥** - å¾å¿«å–è®€å–åƒ¹æ ¼
2. âœ… **å„€è¡¨æ¿å¿«è¦½é¡¯ç¤ºåƒ¹æ ¼** - é¦–é è¿½è¹¤æ¸…å–®é¡¯ç¤ºåƒ¹æ ¼å’Œæ¼²è·Œ
3. âœ… **å ±é…¬ç‡æ¯”è¼ƒé€£çµ** - å´é‚Šæ¬„å·²åŠ å…¥
```

======================================================================
## âš™ï¸ è¨­å®šæª”
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/config.py  â­â­
> æ‡‰ç”¨ç¨‹å¼è¨­å®šæª”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ‡‰ç”¨ç¨‹å¼è¨­å®šæª”
"""
from pydantic_settings import BaseSettings
from pathlib import Path
from typing import Optional, List


class Settings(BaseSettings):
    """æ‡‰ç”¨ç¨‹å¼è¨­å®š"""
    
    # æ‡‰ç”¨ç¨‹å¼
    APP_NAME: str = "SELA è‡ªå‹•é¸è‚¡ç³»çµ±"
    APP_VERSION: str = "0.8.2"  # Phase 4 è¨Šè™Ÿåµæ¸¬ + LINE æ¨æ’­
    APP_ENV: str = "development"
    DEBUG: bool = True
    
    # è³‡æ–™åº«
    DATABASE_URL: str = "sqlite+aiosqlite:///./stock_analysis.db"
    
    # LINE Login (éšæ®µå››)
    LINE_LOGIN_CHANNEL_ID: Optional[str] = None
    LINE_LOGIN_CHANNEL_SECRET: Optional[str] = None
    LINE_LOGIN_CALLBACK_URL: Optional[str] = None
    
    # LINE Messaging (éšæ®µå…­)
    LINE_MESSAGING_CHANNEL_ACCESS_TOKEN: Optional[str] = None
    
    # JWT (éšæ®µå››)
    JWT_SECRET_KEY: str = "your-secret-key-change-in-production"
    JWT_EXPIRE_DAYS: int = 7
    
    # ç®¡ç†å“¡è¨­å®š
    # åˆå§‹ç®¡ç†å“¡çš„ LINE User IDï¼ˆç”¨é€—è™Ÿåˆ†éš”å¤šå€‹ï¼‰
    ADMIN_LINE_USER_IDS: str = "U0f094e89838337e64ba0ca2f68161f3a"
    
    # è³‡æ–™æ›´æ–°è¨­å®š
    STOCK_DATA_CACHE_HOURS: int = 4  # è‚¡åƒ¹è³‡æ–™å¿«å–æ™‚é–“ï¼ˆå°æ™‚ï¼‰
    CRYPTO_DATA_CACHE_MINUTES: int = 15  # å¹£åƒ¹è³‡æ–™å¿«å–æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
    HISTORY_DEFAULT_YEARS: int = 10  # æ­·å²è³‡æ–™é è¨­å¹´æ•¸
    
    # æŠ€è¡“æŒ‡æ¨™é è¨­åƒæ•¸
    MA_SHORT: int = 20
    MA_MID: int = 50
    MA_LONG: int = 200
    RSI_PERIOD: int = 14
    RSI_OVERBOUGHT: int = 70
    RSI_OVERSOLD: int = 30
    MACD_FAST: int = 12
    MACD_SLOW: int = 26
    MACD_SIGNAL: int = 9
    KD_PERIOD: int = 9
    BOLLINGER_PERIOD: int = 20
    BOLLINGER_STD: float = 2.0
    
    # é€šçŸ¥è¨­å®š
    BREAKOUT_THRESHOLD: float = 2.0  # çªç ´é è­¦é–€æª» (%)
    VOLUME_ALERT_RATIO: float = 2.0  # é‡æ¯”è­¦æˆ’å€æ•¸
    
    def get_admin_line_ids(self) -> List[str]:
        """å–å¾—ç®¡ç†å“¡ LINE User ID åˆ—è¡¨"""
        if not self.ADMIN_LINE_USER_IDS:
            return []
        return [x.strip() for x in self.ADMIN_LINE_USER_IDS.split(",") if x.strip()]
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"


# å…¨åŸŸè¨­å®šå¯¦ä¾‹
settings = Settings()

# å°ˆæ¡ˆè·¯å¾‘
BASE_DIR = Path(__file__).resolve().parent.parent
DATA_DIR = BASE_DIR / "data"
CHARTS_DIR = BASE_DIR / "charts"

# ç¢ºä¿ç›®éŒ„å­˜åœ¨
DATA_DIR.mkdir(exist_ok=True)
CHARTS_DIR.mkdir(exist_ok=True)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/settings.py  â­â­
> è¨­å®šç®¡ç† API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨­å®šç®¡ç† API è·¯ç”±
"""
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from app.database import get_async_session
from app.services.auth_service import AuthService
from app.models.user import User
from app.models.user_settings import (
    UserIndicatorSettings,
    UserAlertSettings,
    UserIndicatorParams,
)
from app.schemas.schemas import (
    IndicatorSettingsUpdate,
    IndicatorSettingsResponse,
    AlertSettingsUpdate,
    AlertSettingsResponse,
    IndicatorParamsUpdate,
    IndicatorParamsResponse,
    ResponseBase,
)

router = APIRouter(prefix="/api/settings", tags=["è¨­å®š"])


async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
) -> User:
    """ä¾è³´æ³¨å…¥ï¼šå–å¾—ç•¶å‰ç”¨æˆ¶"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )
    
    return user


# ==================== æŒ‡æ¨™é¡¯ç¤ºè¨­å®š ====================

@router.get("/indicators", summary="å–å¾—æŒ‡æ¨™é¡¯ç¤ºè¨­å®š", response_model=IndicatorSettingsResponse)
async def get_indicator_settings(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
    """
    stmt = select(UserIndicatorSettings).where(
        UserIndicatorSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        # å»ºç«‹é è¨­è¨­å®š
        settings = UserIndicatorSettings.create_default(user.id)
        db.add(settings)
        await db.commit()
        await db.refresh(settings)
    
    return IndicatorSettingsResponse(
        success=True,
        data=settings.to_dict(),
    )


@router.put("/indicators", summary="æ›´æ–°æŒ‡æ¨™é¡¯ç¤ºè¨­å®š", response_model=IndicatorSettingsResponse)
async def update_indicator_settings(
    data: IndicatorSettingsUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°ç”¨æˆ¶çš„æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
    """
    stmt = select(UserIndicatorSettings).where(
        UserIndicatorSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        settings = UserIndicatorSettings.create_default(user.id)
        db.add(settings)
    
    # æ›´æ–°è¨­å®š
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(settings, key, value)
    
    await db.commit()
    await db.refresh(settings)
    
    return IndicatorSettingsResponse(
        success=True,
        message="è¨­å®šå·²æ›´æ–°",
        data=settings.to_dict(),
    )


# ==================== é€šçŸ¥è¨­å®š ====================

@router.get("/alerts", summary="å–å¾—é€šçŸ¥è¨­å®š", response_model=AlertSettingsResponse)
async def get_alert_settings(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„é€šçŸ¥è¨­å®š
    """
    stmt = select(UserAlertSettings).where(
        UserAlertSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        settings = UserAlertSettings.create_default(user.id)
        db.add(settings)
        await db.commit()
        await db.refresh(settings)
    
    return AlertSettingsResponse(
        success=True,
        data=settings.to_dict(),
    )


@router.put("/alerts", summary="æ›´æ–°é€šçŸ¥è¨­å®š", response_model=AlertSettingsResponse)
async def update_alert_settings(
    data: AlertSettingsUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°ç”¨æˆ¶çš„é€šçŸ¥è¨­å®š
    """
    stmt = select(UserAlertSettings).where(
        UserAlertSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        settings = UserAlertSettings.create_default(user.id)
        db.add(settings)
    
    # æ›´æ–°è¨­å®š
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(settings, key, value)
    
    await db.commit()
    await db.refresh(settings)
    
    return AlertSettingsResponse(
        success=True,
        message="è¨­å®šå·²æ›´æ–°",
        data=settings.to_dict(),
    )


# ==================== æŒ‡æ¨™åƒæ•¸è¨­å®š ====================

@router.get("/params", summary="å–å¾—æŒ‡æ¨™åƒæ•¸", response_model=IndicatorParamsResponse)
async def get_indicator_params(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„æŒ‡æ¨™åƒæ•¸è¨­å®š
    """
    stmt = select(UserIndicatorParams).where(
        UserIndicatorParams.user_id == user.id
    )
    result = await db.execute(stmt)
    params = result.scalar_one_or_none()
    
    if not params:
        params = UserIndicatorParams.create_default(user.id)
        db.add(params)
        await db.commit()
        await db.refresh(params)
    
    return IndicatorParamsResponse(
        success=True,
        data=params.to_dict(),
    )


@router.put("/params", summary="æ›´æ–°æŒ‡æ¨™åƒæ•¸", response_model=IndicatorParamsResponse)
async def update_indicator_params(
    data: IndicatorParamsUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°ç”¨æˆ¶çš„æŒ‡æ¨™åƒæ•¸è¨­å®š
    
    å¯è‡ªè¨‚åƒæ•¸åŒ…æ‹¬ï¼š
    - å‡ç·šé€±æœŸ (ma_short, ma_mid, ma_long)
    - RSI åƒæ•¸ (rsi_period, rsi_overbought, rsi_oversold)
    - MACD åƒæ•¸ (macd_fast, macd_slow, macd_signal)
    - KD é€±æœŸ (kd_period)
    - å¸ƒæ—é€šé“ (bollinger_period, bollinger_std)
    - è­¦æˆ’å€¼ (breakout_threshold, volume_alert_ratio)
    """
    stmt = select(UserIndicatorParams).where(
        UserIndicatorParams.user_id == user.id
    )
    result = await db.execute(stmt)
    params = result.scalar_one_or_none()
    
    if not params:
        params = UserIndicatorParams.create_default(user.id)
        db.add(params)
    
    # æ›´æ–°åƒæ•¸
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(params, key, value)
    
    await db.commit()
    await db.refresh(params)
    
    return IndicatorParamsResponse(
        success=True,
        message="åƒæ•¸å·²æ›´æ–°",
        data=params.to_dict(),
    )


# ==================== é è¨­æ¨¡æ¿ ====================

TEMPLATES = {
    "minimal": {
        "indicators": {
            "show_ma": True,
            "show_rsi": False,
            "show_macd": False,
            "show_kd": False,
            "show_bollinger": False,
            "show_obv": False,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": False,
            "alert_macd": False,
            "alert_kd": False,
            "alert_bollinger": False,
            "alert_volume": False,
            "alert_sentiment": False,
        },
    },
    "standard": {
        "indicators": {
            "show_ma": True,
            "show_rsi": True,
            "show_macd": True,
            "show_kd": False,
            "show_bollinger": True,
            "show_obv": False,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": True,
            "alert_macd": True,
            "alert_kd": False,
            "alert_bollinger": False,
            "alert_volume": False,
            "alert_sentiment": True,
        },
    },
    "full": {
        "indicators": {
            "show_ma": True,
            "show_rsi": True,
            "show_macd": True,
            "show_kd": True,
            "show_bollinger": True,
            "show_obv": True,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": True,
            "alert_macd": True,
            "alert_kd": True,
            "alert_bollinger": True,
            "alert_volume": True,
            "alert_sentiment": True,
        },
    },
    "short_term": {
        "indicators": {
            "show_ma": True,
            "show_rsi": True,
            "show_macd": True,
            "show_kd": True,
            "show_bollinger": True,
            "show_obv": False,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": True,
            "alert_macd": True,
            "alert_kd": True,
            "alert_bollinger": True,
            "alert_volume": True,
            "alert_sentiment": False,
        },
        "params": {
            "ma_short": 5,
            "ma_mid": 10,
            "ma_long": 20,
        },
    },
}


@router.post("/template/{template_name}", summary="å¥—ç”¨é è¨­æ¨¡æ¿", response_model=ResponseBase)
async def apply_template(
    template_name: str,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å¥—ç”¨é è¨­è¨­å®šæ¨¡æ¿
    
    å¯ç”¨æ¨¡æ¿ï¼š
    - **minimal**: æ¥µç°¡ (åªé¡¯ç¤ºå‡ç·šå’Œæˆäº¤é‡)
    - **standard**: æ¨™æº– (é è¨­ï¼Œå«ä¸»è¦æŒ‡æ¨™)
    - **full**: å®Œæ•´ (é¡¯ç¤ºæ‰€æœ‰æŒ‡æ¨™)
    - **short_term**: çŸ­ç·š (ä½¿ç”¨è¼ƒçŸ­çš„å‡ç·šé€±æœŸ)
    """
    if template_name not in TEMPLATES:
        raise HTTPException(
            status_code=400,
            detail=f"ä¸å­˜åœ¨çš„æ¨¡æ¿: {template_name}"
        )
    
    template = TEMPLATES[template_name]
    
    # æ›´æ–°æŒ‡æ¨™è¨­å®š
    if "indicators" in template:
        stmt = select(UserIndicatorSettings).where(
            UserIndicatorSettings.user_id == user.id
        )
        result = await db.execute(stmt)
        ind_settings = result.scalar_one_or_none()
        if not ind_settings:
            ind_settings = UserIndicatorSettings.create_default(user.id)
            db.add(ind_settings)
        
        for key, value in template["indicators"].items():
            setattr(ind_settings, key, value)
    
    # æ›´æ–°é€šçŸ¥è¨­å®š
    if "alerts" in template:
        stmt = select(UserAlertSettings).where(
            UserAlertSettings.user_id == user.id
        )
        result = await db.execute(stmt)
        alert_settings = result.scalar_one_or_none()
        if not alert_settings:
            alert_settings = UserAlertSettings.create_default(user.id)
            db.add(alert_settings)
        
        for key, value in template["alerts"].items():
            setattr(alert_settings, key, value)
    
    # æ›´æ–°åƒæ•¸è¨­å®š
    if "params" in template:
        stmt = select(UserIndicatorParams).where(
            UserIndicatorParams.user_id == user.id
        )
        result = await db.execute(stmt)
        params = result.scalar_one_or_none()
        if not params:
            params = UserIndicatorParams.create_default(user.id)
            db.add(params)
        
        for key, value in template["params"].items():
            setattr(params, key, value)
    
    await db.commit()
    
    return ResponseBase(
        success=True,
        message=f"å·²å¥—ç”¨æ¨¡æ¿: {template_name}",
    )
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ Procfile  â­â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```text
web: uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ requirements.txt  â­â­â­
> Core Framework
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```text
# Core Framework
fastapi>=0.109.0
uvicorn[standard]>=0.27.0
python-dotenv>=1.0.0

# Database
sqlalchemy>=2.0.0
aiosqlite>=0.19.0
greenlet>=3.0.0
asyncpg>=0.29.0        # PostgreSQL async driver
psycopg2-binary>=2.9.9  # PostgreSQL sync driver

# Data Sources
yfinance>=0.2.36
requests>=2.31.0

# Data Processing
pandas>=2.2.0
numpy>=1.26.0
# pandas-ta>=0.3.14b  # å·²åœ¨ indicator_service.py æ‰‹å‹•å¯¦ä½œæŒ‡æ¨™è¨ˆç®—

# Chart Generation
matplotlib>=3.8.0
mplfinance>=0.12.9b7

# Authentication
python-jose[cryptography]>=3.3.0
httpx>=0.26.0

# Utilities
pydantic>=2.5.0
pydantic-settings>=2.1.0
rich>=13.7.0  # CLI ç¾åŒ–è¼¸å‡º

# Testing
pytest>=8.0.0
pytest-asyncio>=0.23.0
apscheduler>=3.10.0
```

======================================================================
## ğŸš€ ç¨‹å¼é€²å…¥é»
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/main.py  â­â­â­
> FastAPI ä¸»ç¨‹å¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
FastAPI ä¸»ç¨‹å¼
è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ± API
"""
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import RedirectResponse
import logging
import os

from app.config import settings
from app.database import init_db
from app.logging_config import setup_logging

# åˆå§‹åŒ–æ—¥èªŒç³»çµ±ï¼ˆåœ¨å…¶ä»– import ä¹‹å‰ï¼‰
setup_logging(
    log_level="DEBUG" if settings.DEBUG else "INFO",
    log_to_file=True
)

# ç¢ºä¿æ‰€æœ‰ models è¢«è¼‰å…¥ï¼Œé€™æ¨£ Base.metadata æ‰æœƒåŒ…å«æ‰€æœ‰è¡¨æ ¼
from app.models import (
    User, Watchlist, StockPrice, CryptoPrice, 
    MarketSentiment, Notification,
    UserIndicatorSettings, UserAlertSettings, UserIndicatorParams,
    IndexPrice, DividendHistory,
    Comparison,
    StockPriceCache,  # ğŸ†• åƒ¹æ ¼å¿«å–
)
from app.models.user import LoginLog, TokenBlacklist, SystemConfig

from app.routers import (
    auth_router,
    stock_router,
    crypto_router,
    watchlist_router,
    settings_router,
    admin_router,
    compare_router,
)
from app.routers.market import router as market_router

# ğŸ†• æ’ç¨‹å™¨
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

logger = logging.getLogger(__name__)

# ğŸ†• å»ºç«‹æ’ç¨‹å™¨
scheduler = AsyncIOScheduler()


# ğŸ†• åƒ¹æ ¼å¿«å–æ›´æ–°å‡½æ•¸
def update_price_cache():
    """æ’ç¨‹ä»»å‹™ï¼šæ›´æ–°åƒ¹æ ¼å¿«å–ï¼ˆæ¯ 10 åˆ†é˜ï¼‰"""
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService
    
    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°åƒ¹æ ¼å¿«å–...")
    db = SyncSessionLocal()
    try:
        service = PriceCacheService(db)
        result = service.update_all(force=False)
        logger.info(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–æ›´æ–°å®Œæˆ: {result['total_updated']} ç­†")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


def update_price_cache_force():
    """å¼·åˆ¶æ›´æ–°æ‰€æœ‰åƒ¹æ ¼ï¼ˆå•Ÿå‹•æ™‚ / æ”¶ç›¤å¾Œï¼‰"""
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService
    
    logger.info("[æ’ç¨‹] å¼·åˆ¶æ›´æ–°æ‰€æœ‰åƒ¹æ ¼å¿«å–...")
    db = SyncSessionLocal()
    try:
        service = PriceCacheService(db)
        result = service.update_all(force=True)
        logger.info(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–å¼·åˆ¶æ›´æ–°å®Œæˆ: {result['total_updated']} ç­†")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–å¼·åˆ¶æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


@asynccontextmanager
async def lifespan(app: FastAPI):
    """æ‡‰ç”¨ç¨‹å¼ç”Ÿå‘½é€±æœŸç®¡ç†"""
    # å•Ÿå‹•æ™‚
    logger.info(f"Starting {settings.APP_NAME} v{settings.APP_VERSION}")
    
    # â˜…â˜…â˜… è¨ºæ–·è³‡æ–™åº«é€£ç·š â˜…â˜…â˜…
    from app.database import database_url, is_postgres
    db_type = "PostgreSQL" if is_postgres(database_url) else "SQLite"
    logger.info(f"â˜…â˜…â˜… Database Type: {db_type} â˜…â˜…â˜…")
    if is_postgres(database_url):
        # éš±è—å¯†ç¢¼
        safe_url = database_url.split("@")[-1] if "@" in database_url else database_url
        logger.info(f"â˜…â˜…â˜… Database Host: {safe_url} â˜…â˜…â˜…")
    else:
        logger.warning("âš ï¸ ä½¿ç”¨ SQLiteï¼è³‡æ–™æœƒåœ¨é‡æ–°éƒ¨ç½²å¾Œéºå¤±ï¼")
        logger.warning("âš ï¸ è«‹è¨­å®š DATABASE_URL ç’°å¢ƒè®Šæ•¸æŒ‡å‘ PostgreSQL")
    
    await init_db()
    logger.info("Database initialized")
    
    # ğŸ†• è¨­å®šåƒ¹æ ¼å¿«å–æ’ç¨‹
    # æ¯ 10 åˆ†é˜åŸ·è¡Œï¼ˆè‡ªå‹•åˆ¤æ–·é–‹ç›¤æ™‚é–“ï¼‰
    scheduler.add_job(
        update_price_cache,
        'interval',
        minutes=10,
        id='price_cache_update',
        name='åƒ¹æ ¼å¿«å–æ›´æ–°(æ¯10åˆ†é˜)',
    )
    
    # å°è‚¡æ”¶ç›¤å¾Œï¼ˆé€±ä¸€åˆ°é€±äº” 13:35ï¼‰
    scheduler.add_job(
        update_price_cache_force,
        CronTrigger(day_of_week='mon-fri', hour=13, minute=35),
        id='tw_close_update',
        name='å°è‚¡æ”¶ç›¤æ›´æ–°',
    )
    
    # ç¾è‚¡æ”¶ç›¤å¾Œï¼ˆé€±äºŒåˆ°é€±å…­ 05:05ï¼‰
    scheduler.add_job(
        update_price_cache_force,
        CronTrigger(day_of_week='tue-sat', hour=5, minute=5),
        id='us_close_update',
        name='ç¾è‚¡æ”¶ç›¤æ›´æ–°',
    )
    
    # å•Ÿå‹•æ’ç¨‹å™¨
    scheduler.start()
    logger.info("åƒ¹æ ¼å¿«å–æ’ç¨‹å™¨å·²å•Ÿå‹•")
    
    # å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡å¼·åˆ¶æ›´æ–°
    try:
        update_price_cache_force()
    except Exception as e:
        logger.error(f"å•Ÿå‹•æ™‚æ›´æ–°åƒ¹æ ¼å¿«å–å¤±æ•—: {e}")
    
    yield
    
    # é—œé–‰æ™‚
    scheduler.shutdown()
    logger.info("Shutting down...")


# å»ºç«‹ FastAPI æ‡‰ç”¨ç¨‹å¼
app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description="""
## ğŸ“ˆ SELA è‡ªå‹•é¸è‚¡ç³»çµ± API

å¤šç”¨æˆ¶è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°

### åŠŸèƒ½ç‰¹è‰²

- **æŠ€è¡“æŒ‡æ¨™**: MA, RSI, MACD, KD, å¸ƒæ—é€šé“, OBV
- **æ™ºèƒ½è¨Šè™Ÿ**: é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ã€çªç ´é è­¦
- **ç¶œåˆè©•åˆ†**: å¤šæŒ‡æ¨™å…±æŒ¯åˆ†æ
- **å¸‚å ´æƒ…ç·’**: CNN Fear & Greed / Alternative.me
- **åœ–è¡¨ç”Ÿæˆ**: å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨
- **å ±é…¬ç‡æ¯”è¼ƒ**: å¤šæ¨™çš„å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒ ğŸ†•

### èªè­‰æ–¹å¼

ä½¿ç”¨ LINE Login ç™»å…¥ï¼Œå–å¾— JWT Token å¾Œåœ¨ Header å¸¶å…¥ï¼š
```
Authorization: Bearer {token}
```
    """,
    docs_url="/docs",
    redoc_url="/redoc",
    lifespan=lifespan,
)

# CORS è¨­å®š
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # æ­£å¼ç’°å¢ƒæ‡‰é™åˆ¶ä¾†æº
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# è¨»å†Šè·¯ç”±
app.include_router(auth_router)
app.include_router(stock_router)
app.include_router(crypto_router)
app.include_router(watchlist_router)
app.include_router(settings_router)
app.include_router(admin_router)
app.include_router(market_router)
app.include_router(compare_router)

# æ›è¼‰éœæ…‹æª”æ¡ˆ
static_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "static")
if os.path.exists(static_path):
    app.mount("/static", StaticFiles(directory=static_path, html=True), name="static")


# æ ¹è·¯å¾‘ - é‡å°å‘åˆ°ç™»å…¥é 
@app.get("/", tags=["ç³»çµ±"])
async def root():
    """é‡å°å‘åˆ°é¦–é """
    return RedirectResponse(url="/static/index.html")


# API ç‹€æ…‹
@app.get("/api", tags=["ç³»çµ±"])
async def api_root():
    """API æ ¹è·¯å¾‘"""
    return {
        "name": settings.APP_NAME,
        "version": settings.APP_VERSION,
        "status": "running",
        "docs": "/docs",
    }


# å¥åº·æª¢æŸ¥
@app.get("/health", tags=["ç³»çµ±"])
async def health_check():
    """å¥åº·æª¢æŸ¥"""
    return {
        "status": "healthy",
        "version": settings.APP_VERSION,
    }


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=settings.DEBUG,
    )
```

======================================================================
## ğŸŒ API / è·¯ç”±
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/__init__.py  â­â­â­
> API è·¯ç”±æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
API è·¯ç”±æ¨¡çµ„
"""
from app.routers.auth import router as auth_router
from app.routers.stock import router as stock_router
from app.routers.crypto import router as crypto_router
from app.routers.watchlist import router as watchlist_router
from app.routers.settings import router as settings_router
from app.routers.admin import router as admin_router
from app.routers.compare import router as compare_router  # ğŸ†• æ–°å¢ï¼šå ±é…¬ç‡æ¯”è¼ƒ

__all__ = [
    "auth_router",
    "stock_router",
    "crypto_router",
    "watchlist_router",
    "settings_router",
    "admin_router",
    "compare_router",  # ğŸ†• æ–°å¢
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/admin.py  â­â­â­
> ç®¡ç†å“¡ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ç®¡ç†å“¡ API è·¯ç”±
"""
from fastapi import APIRouter, Depends, HTTPException, Query, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, update, delete
from sqlalchemy.orm import selectinload
from typing import Optional
from datetime import datetime, timedelta
import logging

from app.database import get_async_session
from app.models.user import User, LoginLog, TokenBlacklist, SystemConfig
from app.services.auth_service import AuthService
from app.config import settings

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/admin", tags=["ç®¡ç†å“¡"])


async def get_admin_user(request: Request, db: AsyncSession = Depends(get_async_session)) -> User:
    """é©—è­‰ç®¡ç†å“¡èº«ä»½"""
    # å¾ Header å–å¾— Token
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="æœªæä¾›èªè­‰ Token")
    
    token = auth_header.split(" ")[1]
    
    # é©—è­‰ Token ä¸¦å–å¾—ç”¨æˆ¶
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        raise HTTPException(status_code=401, detail="ç„¡æ•ˆçš„ Token")
    
    # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    if not user.is_admin:
        # æª¢æŸ¥æ˜¯å¦åœ¨ç’°å¢ƒè®Šæ•¸çš„åˆå§‹ç®¡ç†å“¡åå–®ä¸­
        admin_ids = settings.get_admin_line_ids()
        if user.line_user_id not in admin_ids:
            raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å“¡æ¬Šé™")
        
        # è‡ªå‹•è¨­å®šç‚ºç®¡ç†å“¡
        user.is_admin = True
        await db.commit()
        logger.info(f"Auto-promoted user {user.id} to admin")
    
    return user


@router.get("/stats", summary="ç³»çµ±çµ±è¨ˆ")
async def get_stats(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç³»çµ±çµ±è¨ˆè³‡æ–™"""
    # ç”¨æˆ¶çµ±è¨ˆ
    total_users = await db.scalar(select(func.count(User.id)))
    active_users = await db.scalar(select(func.count(User.id)).where(User.is_active == True))
    blocked_users = await db.scalar(select(func.count(User.id)).where(User.is_blocked == True))
    admin_users = await db.scalar(select(func.count(User.id)).where(User.is_admin == True))
    
    # ç¸½ç™»å…¥æ¬¡æ•¸
    total_logins = await db.scalar(
        select(func.count(LoginLog.id))
        .where(LoginLog.action == "login")
    )
    
    # ä»Šæ—¥ç™»å…¥
    today = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)
    today_logins = await db.scalar(
        select(func.count(LoginLog.id))
        .where(LoginLog.action == "login")
        .where(LoginLog.created_at >= today)
    )
    
    # è¿‘ 7 å¤©æ´»èºç”¨æˆ¶
    week_ago = datetime.utcnow() - timedelta(days=7)
    weekly_active = await db.scalar(
        select(func.count(func.distinct(LoginLog.user_id)))
        .where(LoginLog.created_at >= week_ago)
    )
    
    return {
        "success": True,
        "stats": {
            "total_users": total_users or 0,
            "active_users": active_users or 0,
            "blocked_users": blocked_users or 0,
            "admin_users": admin_users or 0,
            "total_logins": total_logins or 0,
            "today_logins": today_logins or 0,
            "weekly_active_users": weekly_active or 0,
        }
    }


@router.get("/users", summary="ç”¨æˆ¶åˆ—è¡¨")
async def list_users(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    search: Optional[str] = None,
    blocked_only: bool = False,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç”¨æˆ¶åˆ—è¡¨ï¼ˆå«ç™»å…¥æ¬¡æ•¸ï¼‰"""
    query = select(User).order_by(User.last_login.desc())
    
    # æœå°‹
    if search:
        query = query.where(
            (User.display_name.ilike(f"%{search}%")) |
            (User.email.ilike(f"%{search}%")) |
            (User.line_user_id.ilike(f"%{search}%"))
        )
    
    # åªé¡¯ç¤ºå°é–ç”¨æˆ¶
    if blocked_only:
        query = query.where(User.is_blocked == True)
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    users = result.scalars().all()
    
    # å–å¾—æ¯å€‹ç”¨æˆ¶çš„ç™»å…¥æ¬¡æ•¸
    user_ids = [u.id for u in users]
    login_counts = {}
    if user_ids:
        login_count_result = await db.execute(
            select(LoginLog.user_id, func.count(LoginLog.id).label('count'))
            .where(LoginLog.user_id.in_(user_ids))
            .where(LoginLog.action == "login")
            .group_by(LoginLog.user_id)
        )
        for row in login_count_result:
            login_counts[row.user_id] = row.count
    
    # çµ„åˆçµæœ
    users_data = []
    for u in users:
        user_dict = u.to_dict()
        user_dict["login_count"] = login_counts.get(u.id, 0)
        users_data.append(user_dict)
    
    return {
        "success": True,
        "users": users_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }


@router.get("/users/{user_id}", summary="ç”¨æˆ¶è©³æƒ…")
async def get_user_detail(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç”¨æˆ¶è©³ç´°è³‡è¨Š"""
    result = await db.execute(
        select(User).where(User.id == user_id)
    )
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    # å–å¾—æœ€è¿‘ç™»å…¥è¨˜éŒ„
    logs_result = await db.execute(
        select(LoginLog)
        .where(LoginLog.user_id == user_id)
        .order_by(LoginLog.created_at.desc())
        .limit(20)
    )
    logs = logs_result.scalars().all()
    
    return {
        "success": True,
        "user": user.to_dict(),
        "recent_logs": [log.to_dict() for log in logs],
    }


@router.get("/logs", summary="ç™»å…¥æ—¥èªŒ")
async def list_logs(
    page: int = Query(1, ge=1),
    page_size: int = Query(50, ge=1, le=100),
    user_id: Optional[int] = None,
    action: Optional[str] = None,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç™»å…¥æ—¥èªŒ"""
    query = select(LoginLog).order_by(LoginLog.created_at.desc())
    
    if user_id:
        query = query.where(LoginLog.user_id == user_id)
    
    if action:
        query = query.where(LoginLog.action == action)
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    logs = result.scalars().all()
    
    # å–å¾—ç”¨æˆ¶åç¨±
    user_ids = list(set(log.user_id for log in logs))
    if user_ids:
        users_result = await db.execute(
            select(User).where(User.id.in_(user_ids))
        )
        users_map = {u.id: u.display_name for u in users_result.scalars().all()}
    else:
        users_map = {}
    
    logs_data = []
    for log in logs:
        log_dict = log.to_dict()
        log_dict["user_name"] = users_map.get(log.user_id, "Unknown")
        logs_data.append(log_dict)
    
    return {
        "success": True,
        "logs": logs_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }


@router.post("/users/{user_id}/block", summary="å°é–ç”¨æˆ¶")
async def block_user(
    user_id: int,
    reason: str = Query("", description="å°é–åŸå› "),
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å°é–ç”¨æˆ¶"""
    if user_id == admin.id:
        raise HTTPException(status_code=400, detail="ä¸èƒ½å°é–è‡ªå·±")
    
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    user.is_blocked = True
    user.blocked_reason = reason
    user.blocked_at = datetime.utcnow()
    
    # è¨˜éŒ„æ—¥èªŒ
    log = LoginLog(
        user_id=user_id,
        action="blocked",
        ip_address=f"by_admin:{admin.id}",
    )
    db.add(log)
    
    await db.commit()
    
    logger.info(f"User {user_id} blocked by admin {admin.id}, reason: {reason}")
    
    return {"success": True, "message": f"å·²å°é–ç”¨æˆ¶ {user.display_name}"}


@router.post("/users/{user_id}/unblock", summary="è§£é™¤å°é–")
async def unblock_user(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è§£é™¤ç”¨æˆ¶å°é–"""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    user.is_blocked = False
    user.blocked_reason = None
    user.blocked_at = None
    
    # è¨˜éŒ„æ—¥èªŒ
    log = LoginLog(
        user_id=user_id,
        action="unblocked",
        ip_address=f"by_admin:{admin.id}",
    )
    db.add(log)
    
    await db.commit()
    
    logger.info(f"User {user_id} unblocked by admin {admin.id}")
    
    return {"success": True, "message": f"å·²è§£é™¤å°é– {user.display_name}"}


@router.post("/users/{user_id}/set-admin", summary="è¨­ç‚ºç®¡ç†å“¡")
async def set_admin(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è¨­å®šç”¨æˆ¶ç‚ºç®¡ç†å“¡"""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    user.is_admin = True
    await db.commit()
    
    logger.info(f"User {user_id} promoted to admin by {admin.id}")
    
    return {"success": True, "message": f"å·²å°‡ {user.display_name} è¨­ç‚ºç®¡ç†å“¡"}


@router.post("/users/{user_id}/remove-admin", summary="ç§»é™¤ç®¡ç†å“¡")
async def remove_admin(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """ç§»é™¤ç®¡ç†å“¡æ¬Šé™"""
    if user_id == admin.id:
        raise HTTPException(status_code=400, detail="ä¸èƒ½ç§»é™¤è‡ªå·±çš„ç®¡ç†å“¡æ¬Šé™")
    
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    user.is_admin = False
    await db.commit()
    
    logger.info(f"User {user_id} admin removed by {admin.id}")
    
    return {"success": True, "message": f"å·²ç§»é™¤ {user.display_name} çš„ç®¡ç†å“¡æ¬Šé™"}


@router.post("/users/{user_id}/kick", summary="è¸¢å‡ºç”¨æˆ¶")
async def kick_user(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è¸¢å‡ºå–®ä¸€ç”¨æˆ¶ï¼ˆä½¿å…¶ Token å¤±æ•ˆï¼‰"""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    # å¢åŠ  token ç‰ˆæœ¬ï¼Œä½¿èˆŠ token å¤±æ•ˆ
    # é€™è£¡æˆ‘å€‘ç”¨æ™‚é–“æˆ³è¨˜éŒ„
    config_key = f"user_token_version:{user_id}"
    result = await db.execute(
        select(SystemConfig).where(SystemConfig.key == config_key)
    )
    config = result.scalar_one_or_none()
    
    if config:
        config.value = str(int(datetime.utcnow().timestamp()))
    else:
        config = SystemConfig(
            key=config_key,
            value=str(int(datetime.utcnow().timestamp())),
            description=f"Token version for user {user_id}"
        )
        db.add(config)
    
    # è¨˜éŒ„æ—¥èªŒ
    log = LoginLog(
        user_id=user_id,
        action="kicked",
        ip_address=f"by_admin:{admin.id}",
    )
    db.add(log)
    
    await db.commit()
    
    logger.info(f"User {user_id} kicked by admin {admin.id}")
    
    return {"success": True, "message": f"å·²è¸¢å‡ºç”¨æˆ¶ {user.display_name}"}


@router.post("/kick-all", summary="è¸¢å‡ºæ‰€æœ‰ç”¨æˆ¶")
async def kick_all_users(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è¸¢å‡ºæ‰€æœ‰ç”¨æˆ¶ï¼ˆä½¿æ‰€æœ‰ Token å¤±æ•ˆï¼‰"""
    # è¨­å®šå…¨åŸŸ token ç‰ˆæœ¬
    config_key = "global_token_version"
    result = await db.execute(
        select(SystemConfig).where(SystemConfig.key == config_key)
    )
    config = result.scalar_one_or_none()
    
    new_version = str(int(datetime.utcnow().timestamp()))
    
    if config:
        config.value = new_version
    else:
        config = SystemConfig(
            key=config_key,
            value=new_version,
            description="Global token version for kick-all"
        )
        db.add(config)
    
    # è¨˜éŒ„æ—¥èªŒ
    log = LoginLog(
        user_id=admin.id,
        action="kick_all",
        ip_address=f"admin:{admin.id}",
    )
    db.add(log)
    
    await db.commit()
    
    logger.warning(f"All users kicked by admin {admin.id}")
    
    return {
        "success": True,
        "message": "å·²è¸¢å‡ºæ‰€æœ‰ç”¨æˆ¶ï¼Œæ‰€æœ‰äººéœ€è¦é‡æ–°ç™»å…¥",
        "new_version": new_version
    }


@router.delete("/users/{user_id}", summary="åˆªé™¤ç”¨æˆ¶")
async def delete_user(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤ç”¨æˆ¶ï¼ˆå±éšªæ“ä½œï¼‰"""
    if user_id == admin.id:
        raise HTTPException(status_code=400, detail="ä¸èƒ½åˆªé™¤è‡ªå·±")
    
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    display_name = user.display_name
    
    await db.delete(user)
    await db.commit()
    
    logger.warning(f"User {user_id} ({display_name}) deleted by admin {admin.id}")
    
    return {"success": True, "message": f"å·²åˆªé™¤ç”¨æˆ¶ {display_name}"}


@router.get("/debug/watchlists", summary="è¨ºæ–·è¿½è¹¤æ¸…å–®")
async def debug_watchlists(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    è¨ºæ–·è¿½è¹¤æ¸…å–®ï¼ˆæŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®æ•¸é‡ï¼‰
    """
    from app.models.watchlist import Watchlist
    
    # çµ±è¨ˆæ¯å€‹ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®æ•¸é‡
    result = await db.execute(
        select(
            Watchlist.user_id,
            func.count(Watchlist.id).label('count')
        ).group_by(Watchlist.user_id)
    )
    user_counts = result.all()
    
    # å–å¾—ç”¨æˆ¶è³‡è¨Š
    user_data = []
    for user_id, count in user_counts:
        user_result = await db.execute(select(User).where(User.id == user_id))
        user = user_result.scalar_one_or_none()
        user_data.append({
            "user_id": user_id,
            "display_name": user.display_name if user else "æœªçŸ¥",
            "line_user_id": user.line_user_id[:10] + "..." if user else "æœªçŸ¥",
            "watchlist_count": count
        })
    
    # ç¸½æ•¸
    total = await db.scalar(select(func.count(Watchlist.id)))
    
    return {
        "success": True,
        "total_watchlist_items": total,
        "users": user_data
    }


# ============== è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­ ==============

@router.post("/signals/check", summary="åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥")
async def run_signal_check(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥
    
    æª¢æŸ¥æ‰€æœ‰ç”¨æˆ¶è¿½è¹¤çš„è‚¡ç¥¨ï¼Œåµæ¸¬æŠ€è¡“æŒ‡æ¨™è¨Šè™Ÿä¸¦ç™¼é€ LINE é€šçŸ¥
    """
    from app.services.notification_service import notification_service
    
    try:
        result = await notification_service.run_signal_check(db)
        
        return {
            "success": True,
            "message": "è¨Šè™Ÿæª¢æŸ¥å®Œæˆ",
            "result": result
        }
    except Exception as e:
        logger.error(f"è¨Šè™Ÿæª¢æŸ¥å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/signals/test/{symbol}", summary="æ¸¬è©¦å–®ä¸€è‚¡ç¥¨è¨Šè™Ÿ")
async def test_signal_detection(
    symbol: str,
    admin: User = Depends(get_admin_user),
):
    """
    æ¸¬è©¦å–®ä¸€è‚¡ç¥¨çš„è¨Šè™Ÿåµæ¸¬ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
    """
    from app.services.signal_service import signal_service
    from app.services.indicator_service import indicator_service
    from app.data_sources.yahoo_finance import yahoo_finance
    
    symbol = symbol.upper()
    
    try:
        # å–å¾—è‚¡åƒ¹è³‡æ–™
        df = yahoo_finance.get_stock_history(symbol, period="6mo")
        
        if df is None or df.empty:
            raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
        
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        indicators = indicator_service.calculate_all_indicators(df)
        
        if not indicators:
            raise HTTPException(status_code=500, detail="ç„¡æ³•è¨ˆç®—æŠ€è¡“æŒ‡æ¨™")
        
        # åµæ¸¬è¨Šè™Ÿ
        signals = signal_service.detect_signals(symbol, indicators, "stock")
        
        # æ ¼å¼åŒ–è¼¸å‡º
        signals_data = []
        for s in signals:
            signals_data.append({
                "type": s.signal_type.value,
                "indicator": s.indicator,
                "message": s.message,
                "price": s.price,
                "details": s.details,
            })
        
        return {
            "success": True,
            "symbol": symbol,
            "current_price": indicators.get("current_price"),
            "signals_count": len(signals),
            "signals": signals_data,
            "indicators_summary": {
                "ma20": indicators.get("ma", {}).get("ma20"),
                "ma50": indicators.get("ma", {}).get("ma50"),
                "rsi": indicators.get("rsi", {}).get("value"),
                "macd_status": indicators.get("macd", {}).get("status"),
                "kd_k": indicators.get("kd", {}).get("k"),
            }
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æ¸¬è©¦è¨Šè™Ÿåµæ¸¬å¤±æ•— {symbol}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/notify/test", summary="æ¸¬è©¦ LINE æ¨æ’­")
async def test_line_push(
    message: str = Query("é€™æ˜¯æ¸¬è©¦è¨Šæ¯", description="æ¸¬è©¦è¨Šæ¯å…§å®¹"),
    admin: User = Depends(get_admin_user),
):
    """
    æ¸¬è©¦ LINE æ¨æ’­åŠŸèƒ½ï¼ˆç™¼é€çµ¦ç®¡ç†å“¡è‡ªå·±ï¼‰
    """
    from app.services.line_notify_service import line_notify_service
    
    if not line_notify_service.enabled:
        raise HTTPException(
            status_code=400, 
            detail="LINE Messaging API æœªè¨­å®šï¼Œè«‹è¨­å®š LINE_MESSAGING_CHANNEL_ACCESS_TOKEN ç’°å¢ƒè®Šæ•¸"
        )
    
    try:
        test_message = f"ğŸ”” SELA ç³»çµ±æ¸¬è©¦\n\n{message}\n\nâ° {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        
        success = await line_notify_service.push_text_message(
            admin.line_user_id,
            test_message
        )
        
        if success:
            return {
                "success": True,
                "message": "æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINE"
            }
        else:
            raise HTTPException(status_code=500, detail="LINE æ¨æ’­å¤±æ•—")
            
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æ¸¬è©¦ LINE æ¨æ’­å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/notifications", summary="é€šçŸ¥è¨˜éŒ„")
async def list_notifications(
    page: int = Query(1, ge=1),
    page_size: int = Query(50, ge=1, le=100),
    user_id: Optional[int] = None,
    symbol: Optional[str] = None,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—é€šçŸ¥è¨˜éŒ„"""
    from app.models.notification import Notification
    
    query = select(Notification).order_by(Notification.triggered_at.desc())
    
    if user_id:
        query = query.where(Notification.user_id == user_id)
    
    if symbol:
        query = query.where(Notification.symbol == symbol.upper())
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    notifications = result.scalars().all()
    
    # å–å¾—ç”¨æˆ¶åç¨±
    user_ids = list(set(n.user_id for n in notifications))
    if user_ids:
        users_result = await db.execute(
            select(User).where(User.id.in_(user_ids))
        )
        users_map = {u.id: u.display_name for u in users_result.scalars().all()}
    else:
        users_map = {}
    
    notifications_data = []
    for n in notifications:
        n_dict = n.to_dict()
        n_dict["user_name"] = users_map.get(n.user_id, "Unknown")
        notifications_data.append(n_dict)
    
    return {
        "success": True,
        "notifications": notifications_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }


@router.post("/signal/detect", summary="åµæ¸¬è¨Šè™Ÿï¼ˆæ¸¬è©¦ï¼‰")
async def detect_signals(
    admin: User = Depends(get_admin_user),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
    ç”¨æ–¼æ¸¬è©¦è¨Šè™Ÿåµæ¸¬åŠŸèƒ½
    """
    from app.tasks.scheduler import scheduler_service
    
    try:
        result = scheduler_service.run_signal_detection_only()
        
        return {
            "success": True,
            "signals_count": len(result.get("signals", [])),
            "by_symbol": result.get("by_symbol", {}),
            "message": f"åµæ¸¬åˆ° {len(result.get('signals', []))} å€‹äº¤å‰è¨Šè™Ÿ"
        }
    except Exception as e:
        logger.error(f"è¨Šè™Ÿåµæ¸¬å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/signal/notify", summary="ç™¼é€è¨Šè™Ÿé€šçŸ¥")
async def send_signal_notifications(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ä¸¦ç™¼é€é€šçŸ¥
    æœƒåµæ¸¬æ‰€æœ‰è¿½è¹¤è‚¡ç¥¨çš„äº¤å‰è¨Šè™Ÿï¼Œä¸¦ç™¼é€ LINE æ¨æ’­çµ¦ç›¸é—œç”¨æˆ¶
    """
    from app.tasks.scheduler import scheduler_service
    
    try:
        # ä½¿ç”¨åŒæ­¥ session
        sync_db = scheduler_service._get_db()
        result = scheduler_service._detect_and_notify(sync_db)
        sync_db.close()
        
        return {
            "success": True,
            "signals_detected": result.get("signals_count", 0),
            "notifications_sent": result.get("notifications_sent", 0),
            "errors": result.get("errors", []),
            "message": f"åµæ¸¬åˆ° {result.get('signals_count', 0)} å€‹è¨Šè™Ÿï¼Œç™¼é€ {result.get('notifications_sent', 0)} å‰‡é€šçŸ¥"
        }
    except Exception as e:
        logger.error(f"è¨Šè™Ÿé€šçŸ¥å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/signal/test-push", summary="æ¸¬è©¦ LINE æ¨æ’­")
async def test_line_push(
    message: str = Query("é€™æ˜¯æ¸¬è©¦è¨Šæ¯", description="æ¸¬è©¦è¨Šæ¯å…§å®¹"),
    admin: User = Depends(get_admin_user),
):
    """
    æ¸¬è©¦ LINE æ¨æ’­åŠŸèƒ½
    ç™¼é€æ¸¬è©¦è¨Šæ¯çµ¦ç®¡ç†å“¡è‡ªå·±
    """
    from app.services.line_notify_service import line_notify_service
    
    if not line_notify_service.enabled:
        return {
            "success": False,
            "message": "LINE Messaging API æœªå•Ÿç”¨ï¼Œè«‹è¨­å®š LINE_MESSAGING_CHANNEL_ACCESS_TOKEN"
        }
    
    try:
        test_message = f"ğŸ“Š SELA ç³»çµ±æ¸¬è©¦\n\n{message}\n\nâ° {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        
        success = await line_notify_service.push_text_message(admin.line_user_id, test_message)
        
        return {
            "success": success,
            "message": "æ¸¬è©¦è¨Šæ¯å·²ç™¼é€" if success else "ç™¼é€å¤±æ•—",
            "line_user_id": admin.line_user_id[:10] + "..."
        }
    except Exception as e:
        logger.error(f"æ¸¬è©¦æ¨æ’­å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/signal/status", summary="é€šçŸ¥ç³»çµ±ç‹€æ…‹")
async def get_signal_status(
    admin: User = Depends(get_admin_user),
):
    """
    å–å¾—è¨Šè™Ÿé€šçŸ¥ç³»çµ±ç‹€æ…‹
    """
    from app.services.line_notify_service import line_notify_service
    from app.tasks.scheduler import scheduler_service
    from app.config import settings
    
    return {
        "success": True,
        "status": {
            "line_messaging_enabled": line_notify_service.enabled,
            "line_messaging_token_set": bool(settings.LINE_MESSAGING_CHANNEL_ACCESS_TOKEN),
            "scheduler_last_run": scheduler_service.last_run.isoformat() if scheduler_service.last_run else None,
            "scheduler_last_result": scheduler_service.last_result,
        }
    }


@router.post("/signal/detect", summary="æ‰‹å‹•åµæ¸¬è¨Šè™Ÿ")
async def detect_signals_manual(
    admin: User = Depends(get_admin_user),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
    ç”¨æ–¼æ¸¬è©¦è¨Šè™Ÿåµæ¸¬é‚è¼¯
    """
    from app.tasks.scheduler import scheduler_service
    
    try:
        result = scheduler_service.run_signal_detection_only()
        
        return {
            "success": True,
            "message": f"åµæ¸¬å®Œæˆï¼Œå…± {len(result.get('signals', []))} å€‹è¨Šè™Ÿ",
            "signals_by_symbol": result.get("by_symbol", {}),
            "total_signals": len(result.get("signals", [])),
        }
    except Exception as e:
        logger.error(f"è¨Šè™Ÿåµæ¸¬å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/signal/notify", summary="æ‰‹å‹•ç™¼é€é€šçŸ¥")
async def send_notifications_manual(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ä¸¦ç™¼é€é€šçŸ¥
    ç­‰åŒæ–¼æ¯æ—¥æ’ç¨‹ä»»å‹™
    """
    from app.tasks.scheduler import scheduler_service
    
    try:
        result = scheduler_service.run_daily_update()
        
        return {
            "success": result.get("success", False),
            "message": "æ¯æ—¥æ›´æ–°ä»»å‹™å·²åŸ·è¡Œ",
            "result": {
                "stocks_updated": result.get("stocks_updated", 0),
                "signals_detected": result.get("signals_detected", 0),
                "notifications_sent": result.get("notifications_sent", 0),
                "errors": result.get("errors", []),
            }
        }
    except Exception as e:
        logger.error(f"é€šçŸ¥ä»»å‹™å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/notifications", summary="é€šçŸ¥è¨˜éŒ„")
async def list_notifications(
    page: int = Query(1, ge=1),
    page_size: int = Query(50, ge=1, le=100),
    user_id: Optional[int] = None,
    symbol: Optional[str] = None,
    sent_only: bool = False,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—é€šçŸ¥è¨˜éŒ„
    """
    from app.models.notification import Notification
    
    query = select(Notification).order_by(Notification.triggered_at.desc())
    
    if user_id:
        query = query.where(Notification.user_id == user_id)
    
    if symbol:
        query = query.where(Notification.symbol == symbol.upper())
    
    if sent_only:
        query = query.where(Notification.sent == True)
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    notifications = result.scalars().all()
    
    # å–å¾—ç”¨æˆ¶åç¨±
    user_ids = list(set(n.user_id for n in notifications))
    users_map = {}
    if user_ids:
        users_result = await db.execute(select(User).where(User.id.in_(user_ids)))
        users_map = {u.id: u.display_name for u in users_result.scalars().all()}
    
    notifications_data = []
    for n in notifications:
        n_dict = n.to_dict()
        n_dict["user_name"] = users_map.get(n.user_id, "Unknown")
        notifications_data.append(n_dict)
    
    return {
        "success": True,
        "notifications": notifications_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/auth.py  â­â­â­
> èªè­‰ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
èªè­‰ API è·¯ç”±
LINE Login æ•´åˆ
"""
from fastapi import APIRouter, Depends, HTTPException, Query, Request
from fastapi.responses import RedirectResponse
from sqlalchemy.ext.asyncio import AsyncSession
import secrets
import hashlib
import hmac
import time
import urllib.parse
import logging

from app.database import get_async_session
from app.services.auth_service import AuthService
from app.schemas.schemas import LoginResponse, UserResponse, ErrorResponse
from app.config import settings

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/auth", tags=["èªè­‰"])

# ç‰ˆæœ¬æ¨™è­˜
AUTH_VERSION = "2.0.0-hmac"


@router.get("/version", summary="èªè­‰æ¨¡çµ„ç‰ˆæœ¬")
async def auth_version():
    """å›å‚³èªè­‰æ¨¡çµ„ç‰ˆæœ¬ï¼Œç”¨æ–¼ç¢ºèªéƒ¨ç½²"""
    return {
        "auth_version": AUTH_VERSION,
        "state_method": "HMAC",
        "jwt_key_set": bool(settings.JWT_SECRET_KEY and settings.JWT_SECRET_KEY != "your-secret-key-change-in-production"),
    }


def create_state_token() -> str:
    """å»ºç«‹ state token (HMAC ç°½åï¼Œæœ‰æ•ˆæœŸ 10 åˆ†é˜)"""
    # æ ¼å¼: timestamp.nonce.signature
    timestamp = str(int(time.time()))
    nonce = secrets.token_hex(8)  # 16 å­—å…ƒ
    
    # ç°½å
    message = f"{timestamp}.{nonce}"
    signature = hmac.new(
        settings.JWT_SECRET_KEY.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()[:16]  # åªå–å‰ 16 å­—å…ƒ
    
    state = f"{timestamp}.{nonce}.{signature}"
    logger.info(f"Created state: {state}")
    return state


def verify_state_token(state: str) -> bool:
    """é©—è­‰ state token"""
    logger.info(f"Verifying state: {state}")
    try:
        parts = state.split(".")
        logger.info(f"State parts count: {len(parts)}")
        
        if len(parts) != 3:
            logger.warning(f"Invalid state format, expected 3 parts, got {len(parts)}")
            return False
        
        timestamp, nonce, signature = parts
        logger.info(f"timestamp={timestamp}, nonce={nonce}, signature={signature}")
        
        # æª¢æŸ¥æ˜¯å¦éæœŸ (10 åˆ†é˜)
        time_diff = int(time.time()) - int(timestamp)
        logger.info(f"Time difference: {time_diff} seconds")
        if time_diff > 600:
            logger.warning(f"State expired, time_diff={time_diff}")
            return False
        
        # é©—è­‰ç°½å
        message = f"{timestamp}.{nonce}"
        expected_signature = hmac.new(
            settings.JWT_SECRET_KEY.encode(),
            message.encode(),
            hashlib.sha256
        ).hexdigest()[:16]
        
        logger.info(f"Expected signature: {expected_signature}")
        result = hmac.compare_digest(signature, expected_signature)
        logger.info(f"Signature match: {result}")
        
        return result
    except Exception as e:
        logger.error(f"State verification error: {e}")
        return False


@router.get("/line", summary="LINE ç™»å…¥")
async def line_login():
    """
    å°å‘ LINE ç™»å…¥æˆæ¬Šé é¢
    """
    if not settings.LINE_LOGIN_CHANNEL_ID:
        raise HTTPException(
            status_code=500,
            detail="LINE Login å°šæœªè¨­å®š"
        )
    
    # ç”¢ç”Ÿ state
    state = create_state_token()
    
    # URL encode callback URL
    callback_url = urllib.parse.quote(settings.LINE_LOGIN_CALLBACK_URL, safe='')
    
    # å»ºç«‹æˆæ¬Š URL
    auth_url = (
        "https://access.line.me/oauth2/v2.1/authorize"
        f"?response_type=code"
        f"&client_id={settings.LINE_LOGIN_CHANNEL_ID}"
        f"&redirect_uri={callback_url}"
        f"&state={state}"
        f"&scope=profile%20openid%20email"
    )
    
    logger.info(f"Redirecting to LINE with state: {state}")
    
    return RedirectResponse(url=auth_url)


@router.get("/line/callback", summary="LINE ç™»å…¥å›èª¿")
async def line_callback(
    request: Request,
    code: str = Query(..., description="æˆæ¬Šç¢¼"),
    state: str = Query(..., description="State"),
    db: AsyncSession = Depends(get_async_session),
):
    """
    LINE ç™»å…¥å›èª¿è™•ç†
    
    - é©—è­‰ state
    - ç”¨ code æ›å– access token
    - å–å¾—ç”¨æˆ¶è³‡æ–™
    - å»ºç«‹/æ›´æ–°ç”¨æˆ¶
    - å›å‚³ HTML é é¢å„²å­˜ Token ä¸¦è·³è½‰
    """
    from fastapi.responses import HTMLResponse
    
    # é©—è­‰ state (ä½¿ç”¨ JWT é©—è­‰)
    if not verify_state_token(state):
        raise HTTPException(
            status_code=400,
            detail="Invalid state"
        )
    
    # å–å¾—å®¢æˆ¶ç«¯è³‡è¨Š
    client_ip = request.client.host if request.client else None
    user_agent = request.headers.get("user-agent")
    
    # åŸ·è¡Œç™»å…¥æµç¨‹
    auth_service = AuthService(db)
    result = await auth_service.login_with_line(code, client_ip, user_agent)
    
    if not result:
        # å¯èƒ½æ˜¯è¢«å°é–çš„ç”¨æˆ¶
        html_content = """
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
            <style>
                body {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                .card {
                    background: white;
                    padding: 3rem;
                    border-radius: 1rem;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    text-align: center;
                }
                h2 { color: #dc2626; margin: 0 0 1rem; }
                p { color: #64748b; margin: 0; }
                a { color: #3b82f6; }
            </style>
        </head>
        <body>
            <div class="card">
                <h2>âš ï¸ ç™»å…¥å¤±æ•—</h2>
                <p>æ‚¨çš„å¸³è™Ÿå·²è¢«åœç”¨æˆ–ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤</p>
                <p style="margin-top: 1rem;"><a href="/static/index.html">è¿”å›é¦–é </a></p>
            </div>
        </body>
        </html>
        """
        return HTMLResponse(content=html_content, status_code=403)
    
    # å›å‚³ HTML é é¢ï¼Œå°‡ Token å­˜å…¥ localStorage ä¸¦è·³è½‰åˆ°å„€è¡¨æ¿
    token = result["token"]
    user = result["user"]
    
    # è¨˜éŒ„ç™»å…¥æˆåŠŸçš„ log
    logger.info(f"=== ç™»å…¥æˆåŠŸï¼Œæº–å‚™è·³è½‰ ===")
    logger.info(f"ç”¨æˆ¶ ID: {user.id}, LINE ID: {user.line_user_id}, åç¨±: {user.display_name}")
    
    html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
        <style>
            body {{
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }}
            .card {{
                background: white;
                padding: 3rem;
                border-radius: 1rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                text-align: center;
            }}
            .logo {{
                background-color: #FA7A35;
                color: white;
                font-weight: bold;
                font-size: 1.5rem;
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                display: inline-block;
                margin-bottom: 1.5rem;
            }}
            .spinner {{
                width: 50px;
                height: 50px;
                border: 4px solid #e2e8f0;
                border-top: 4px solid #FA7A35;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 1.5rem;
            }}
            @keyframes spin {{
                0% {{ transform: rotate(0deg); }}
                100% {{ transform: rotate(360deg); }}
            }}
            h2 {{ color: #1e293b; margin: 0 0 0.5rem; }}
            p {{ color: #64748b; margin: 0; }}
        </style>
    </head>
    <body>
        <div class="card">
            <div class="logo">SELA</div>
            <div class="spinner"></div>
            <h2>ç™»å…¥æˆåŠŸï¼</h2>
            <p>æ­¡è¿å›ä¾†ï¼Œ{user.display_name}</p>
        </div>
        <script>
            // â˜…â˜…â˜… é‡è¦ï¼šå…ˆæ¸…é™¤æ‰€æœ‰èˆŠè³‡æ–™ï¼Œé¿å… A ç”¨æˆ¶çœ‹åˆ° B ç”¨æˆ¶çš„è³‡æ–™ â˜…â˜…â˜…
            localStorage.clear();
            sessionStorage.clear();
            
            // è¨­å®šæ–°çš„ç”¨æˆ¶è³‡æ–™
            localStorage.setItem('token', '{token}');
            localStorage.setItem('user', JSON.stringify({{
                id: {user.id},
                display_name: "{user.display_name}",
                picture_url: "{user.picture_url or ''}",
                line_user_id: "{user.line_user_id}",
                is_admin: {'true' if getattr(user, 'is_admin', False) else 'false'}
            }}));
            localStorage.setItem('login_time', new Date().toISOString());
            
            console.log('ç™»å…¥æˆåŠŸ: ç”¨æˆ¶ ID = {user.id}, LINE ID = {user.line_user_id}');
            
            setTimeout(function() {{
                window.location.href = '/static/dashboard.html';
            }}, 1500);
        </script>
    </body>
    </html>
    """
    
    return HTMLResponse(content=html_content)


@router.post("/logout", summary="ç™»å‡º")
async def logout():
    """
    ç™»å‡ºï¼ˆå‰ç«¯æ¸…é™¤ Token å³å¯ï¼‰
    """
    return {"success": True, "message": "å·²ç™»å‡º"}


@router.get("/me", summary="å–å¾—ç•¶å‰ç”¨æˆ¶", response_model=UserResponse)
async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç•¶å‰ç™»å…¥ç”¨æˆ¶è³‡è¨Š
    
    éœ€è¦åœ¨ Header å¸¶å…¥ Authorization: Bearer {token}
    """
    # å¾ Header å–å¾— Token
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )
    
    token = auth_header.split(" ")[1]
    
    # é©—è­‰ Token ä¸¦å–å¾—ç”¨æˆ¶
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )
    
    return UserResponse.model_validate(user)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/compare.py  â­â­â­
> å ±é…¬ç‡æ¯”è¼ƒ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å ±é…¬ç‡æ¯”è¼ƒ API è·¯ç”±
"""
from typing import List, Optional
from datetime import datetime

from fastapi import APIRouter, Depends, HTTPException, Query, Request
from pydantic import BaseModel, Field
from sqlalchemy.ext.asyncio import AsyncSession
import logging

from app.database import get_async_session
from app.services.compare_service import compare_service, ComparisonCRUD
from app.services.auth_service import AuthService
from app.models.user import User

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/compare", tags=["Compare"])


# ==================== èªè­‰ä¾è³´ ====================

async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
) -> User:
    """ä¾è³´æ³¨å…¥ï¼šå–å¾—ç•¶å‰ç”¨æˆ¶"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        logger.warning("Compare API: æœªæä¾›èªè­‰ Token")
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        logger.warning("Compare API: Token é©—è­‰å¤±æ•—")
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )
    
    return user


async def get_optional_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
) -> Optional[User]:
    """ä¾è³´æ³¨å…¥ï¼šå–å¾—ç•¶å‰ç”¨æˆ¶ï¼ˆå¯é¸ï¼Œæœªç™»å…¥è¿”å› Noneï¼‰"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        return None
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    return user


# ==================== Schemas ====================

class CompareRequest(BaseModel):
    """æ¯”è¼ƒè«‹æ±‚"""
    symbols: List[str] = Field(..., min_length=1, max_length=5, description="æ¨™çš„ä»£è™Ÿåˆ—è¡¨")
    periods: List[str] = Field(default=["1y", "3y", "5y", "10y"], description="æ™‚é–“é€±æœŸ")
    custom_range: Optional[dict] = Field(default=None, description="è‡ªè¨‚å€é–“ {start, end}")
    benchmark: str = Field(default="^GSPC", description="åŸºæº–æŒ‡æ•¸")
    sort_by: str = Field(default="5y", description="æ’åºä¾æ“š")
    sort_order: str = Field(default="desc", pattern="^(asc|desc)$", description="æ’åºæ–¹å‘")


class SaveComparisonRequest(BaseModel):
    """å„²å­˜æ¯”è¼ƒçµ„åˆè«‹æ±‚"""
    name: str = Field(..., min_length=1, max_length=100, description="çµ„åˆåç¨±")
    symbols: List[str] = Field(..., min_length=1, max_length=5, description="æ¨™çš„ä»£è™Ÿåˆ—è¡¨")
    benchmark: str = Field(default="^GSPC", description="åŸºæº–æŒ‡æ•¸")


class UpdateComparisonRequest(BaseModel):
    """æ›´æ–°æ¯”è¼ƒçµ„åˆè«‹æ±‚"""
    name: Optional[str] = Field(default=None, max_length=100)
    symbols: Optional[List[str]] = Field(default=None, max_length=5)
    benchmark: Optional[str] = Field(default=None)


# ==================== å…¬é–‹ API ====================

@router.post("/cagr", summary="è¨ˆç®—å¹´åŒ–å ±é…¬ç‡æ¯”è¼ƒ")
async def compare_cagr(request: CompareRequest):
    """
    æ¯”è¼ƒå¤šå€‹æ¨™çš„çš„å¹´åŒ–å ±é…¬ç‡ (CAGR)
    
    - æ”¯æ´è‚¡ç¥¨ã€åŠ å¯†è²¨å¹£ã€æŒ‡æ•¸æ··åˆæ¯”è¼ƒ
    - æœ€å¤š 5 å€‹æ¨™çš„
    - å¯é¸æ™‚é–“é€±æœŸï¼š1å¹´ã€3å¹´ã€5å¹´ã€10å¹´ã€è‡ªè¨‚å€é–“
    """
    result = await compare_service.compare_cagr(
        symbols=request.symbols,
        periods=request.periods,
        custom_range=request.custom_range,
        benchmark=request.benchmark,
        sort_by=request.sort_by,
        sort_order=request.sort_order,
    )
    
    if not result.get("success"):
        raise HTTPException(status_code=400, detail=result.get("error", "æ¯”è¼ƒå¤±æ•—"))
    
    return result


@router.get("/presets", summary="å–å¾—é è¨­çµ„åˆåˆ—è¡¨")
async def get_presets():
    """å–å¾—æ‰€æœ‰é è¨­æ¯”è¼ƒçµ„åˆ"""
    presets = compare_service.get_presets()
    return {
        "success": True,
        "presets": presets,
    }


@router.get("/presets/{preset_id}", summary="å–å¾—é è¨­çµ„åˆè©³æƒ…")
async def get_preset_detail(preset_id: str):
    """å–å¾—é è¨­çµ„åˆçš„è©³ç´°å…§å®¹"""
    preset = compare_service.get_preset_detail(preset_id)
    
    if not preset:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²é è¨­çµ„åˆ")
    
    return {
        "success": True,
        "preset": preset,
    }


@router.get("/benchmarks", summary="å–å¾—åŸºæº–æŒ‡æ•¸é¸é …")
async def get_benchmarks():
    """å–å¾—å¯ç”¨çš„åŸºæº–æŒ‡æ•¸é¸é …"""
    benchmarks = compare_service.get_benchmark_options()
    return {
        "success": True,
        "benchmarks": [
            {"symbol": k, "name": v}
            for k, v in benchmarks.items()
        ],
    }


# ==================== ç”¨æˆ¶å„²å­˜çš„çµ„åˆ API ====================

@router.get("/saved", summary="å–å¾—æˆ‘çš„æ¯”è¼ƒçµ„åˆ")
async def get_saved_comparisons(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç•¶å‰ç”¨æˆ¶å„²å­˜çš„æ‰€æœ‰æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    comparisons = await crud.get_user_comparisons(user.id)
    
    return {
        "success": True,
        "comparisons": [c.to_dict() for c in comparisons],
    }


@router.post("/saved", summary="å„²å­˜æ¯”è¼ƒçµ„åˆ")
async def save_comparison(
    request: SaveComparisonRequest,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å„²å­˜æ–°çš„æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    
    # æª¢æŸ¥ç”¨æˆ¶å·²æœ‰çš„çµ„åˆæ•¸é‡ï¼ˆé™åˆ¶æœ€å¤š 10 å€‹ï¼‰
    existing = await crud.get_user_comparisons(user.id)
    if len(existing) >= 10:
        raise HTTPException(status_code=400, detail="æœ€å¤šåªèƒ½å„²å­˜ 10 å€‹æ¯”è¼ƒçµ„åˆ")
    
    # æ­£è¦åŒ– symbols
    symbols = [s.upper().strip() for s in request.symbols]
    
    comparison = await crud.create_comparison(
        user_id=user.id,
        name=request.name,
        symbols=symbols,
        benchmark=request.benchmark,
    )
    
    return {
        "success": True,
        "message": "æ¯”è¼ƒçµ„åˆå·²å„²å­˜",
        "comparison": comparison.to_dict(),
    }


@router.get("/saved/{comparison_id}", summary="å–å¾—å–®ä¸€æ¯”è¼ƒçµ„åˆ")
async def get_saved_comparison(
    comparison_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—å–®ä¸€æ¯”è¼ƒçµ„åˆè©³æƒ…"""
    crud = ComparisonCRUD(db)
    comparison = await crud.get_comparison(comparison_id, user.id)
    
    if not comparison:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²æ¯”è¼ƒçµ„åˆ")
    
    return {
        "success": True,
        "comparison": comparison.to_dict(),
    }


@router.put("/saved/{comparison_id}", summary="æ›´æ–°æ¯”è¼ƒçµ„åˆ")
async def update_saved_comparison(
    comparison_id: int,
    request: UpdateComparisonRequest,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ›´æ–°å„²å­˜çš„æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    
    # æ­£è¦åŒ– symbols
    symbols = None
    if request.symbols:
        symbols = [s.upper().strip() for s in request.symbols]
    
    comparison = await crud.update_comparison(
        comparison_id=comparison_id,
        user_id=user.id,
        name=request.name,
        symbols=symbols,
        benchmark=request.benchmark,
    )
    
    if not comparison:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²æ¯”è¼ƒçµ„åˆ")
    
    return {
        "success": True,
        "message": "æ¯”è¼ƒçµ„åˆå·²æ›´æ–°",
        "comparison": comparison.to_dict(),
    }


@router.delete("/saved/{comparison_id}", summary="åˆªé™¤æ¯”è¼ƒçµ„åˆ")
async def delete_saved_comparison(
    comparison_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤å„²å­˜çš„æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    deleted = await crud.delete_comparison(comparison_id, user.id)
    
    if not deleted:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²æ¯”è¼ƒçµ„åˆ")
    
    return {
        "success": True,
        "message": "æ¯”è¼ƒçµ„åˆå·²åˆªé™¤",
    }


# ==================== å¿«é€Ÿæ¯”è¼ƒ (çµåˆ preset + è¨ˆç®—) ====================

@router.get("/quick/{preset_id}", summary="å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ")
async def quick_compare_preset(
    preset_id: str,
    benchmark: str = Query(default="^GSPC", description="åŸºæº–æŒ‡æ•¸"),
    sort_by: str = Query(default="5y", description="æ’åºä¾æ“š"),
):
    """
    å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ
    ç›´æ¥è¼‰å…¥é è¨­çµ„åˆä¸¦è¨ˆç®— CAGR
    """
    preset = compare_service.get_preset_detail(preset_id)
    
    if not preset:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²é è¨­çµ„åˆ")
    
    result = await compare_service.compare_cagr(
        symbols=preset["symbols"],
        periods=["1y", "3y", "5y", "10y"],
        benchmark=benchmark,
        sort_by=sort_by,
        sort_order="desc",
    )
    
    result["preset"] = preset
    return result
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/crypto.py  â­â­â­
> åŠ å¯†è²¨å¹£å’Œå¸‚å ´æƒ…ç·’ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŠ å¯†è²¨å¹£å’Œå¸‚å ´æƒ…ç·’ API è·¯ç”±
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import FileResponse
import pandas as pd
import logging

from app.schemas.schemas import MarketSentimentResponse

router = APIRouter(tags=["åŠ å¯†è²¨å¹£"])
logger = logging.getLogger(__name__)

# åŠ å¯†è²¨å¹£å°æ‡‰çš„ Yahoo Finance ä»£è™Ÿ
CRYPTO_YAHOO_MAP = {
    "BTC": "BTC-USD",
    "ETH": "ETH-USD",
    "BITCOIN": "BTC-USD",
    "ETHEREUM": "ETH-USD",
}


@router.get("/api/crypto/{symbol}", summary="æŸ¥è©¢åŠ å¯†è²¨å¹£")
async def get_crypto_analysis(
    symbol: str,
    refresh: bool = Query(False, description="æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™"),
):
    """
    æŸ¥è©¢å–®ä¸€åŠ å¯†è²¨å¹£çš„æŠ€è¡“åˆ†æå ±å‘Š
    
    - **symbol**: åŠ å¯†è²¨å¹£ä»£è™Ÿ (BTC, ETH)
    - **refresh**: æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™
    """
    from app.data_sources.coingecko import coingecko
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.indicator_service import indicator_service
    
    symbol = symbol.upper()
    logger.info(f"é–‹å§‹æŸ¥è©¢åŠ å¯†è²¨å¹£: {symbol}")
    
    # é©—è­‰ä»£è™Ÿ
    yahoo_symbol = CRYPTO_YAHOO_MAP.get(symbol)
    if not yahoo_symbol and not coingecko.validate_symbol(symbol):
        logger.warning(f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}")
        raise HTTPException(
            status_code=400,
            detail=f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}ï¼Œç›®å‰åƒ…æ”¯æ´ BTC å’Œ ETH"
        )
    
    df = None
    info = None
    data_source = None
    
    # å„ªå…ˆå˜—è©¦ CoinGecko
    try:
        logger.info(f"å˜—è©¦å¾ CoinGecko å–å¾— {symbol} è³‡æ–™...")
        df = coingecko.get_ohlc(symbol, days=365)
        if df is not None and not df.empty:
            info = coingecko.get_coin_info(symbol)
            data_source = "CoinGecko"
            logger.info(f"æˆåŠŸå¾ CoinGecko å–å¾— {len(df)} ç­†è³‡æ–™")
    except Exception as e:
        logger.warning(f"CoinGecko API å¤±æ•—: {e}")
    
    # å¦‚æœ CoinGecko å¤±æ•—ï¼Œä½¿ç”¨ Yahoo Finance å‚™ç”¨
    if df is None or df.empty:
        yahoo_symbol = CRYPTO_YAHOO_MAP.get(symbol, f"{symbol}-USD")
        logger.info(f"CoinGecko å¤±æ•—ï¼Œå˜—è©¦ Yahoo Finance: {yahoo_symbol}")
        
        try:
            df = yahoo_finance.get_stock_history(yahoo_symbol, period="1y")
            if df is not None and not df.empty:
                data_source = "Yahoo Finance"
                logger.info(f"æˆåŠŸå¾ Yahoo Finance å–å¾— {len(df)} ç­†è³‡æ–™")
                # å¾ Yahoo Finance å–å¾—åŸºæœ¬è³‡è¨Š
                try:
                    yf_info = yahoo_finance.get_stock_info(yahoo_symbol)
                    if yf_info:
                        info = {
                            "name": yf_info.get("shortName") or yf_info.get("name") or symbol,
                            "market_cap": yf_info.get("market_cap") or yf_info.get("marketCap"),
                            "total_volume": yf_info.get("total_volume"),
                        }
                except Exception as e:
                    logger.warning(f"å–å¾— Yahoo Finance info å¤±æ•—: {e}")
                    info = {"name": symbol}
        except Exception as e:
            logger.error(f"Yahoo Finance ä¹Ÿå¤±æ•—: {e}")
    
    # å¦‚æœå…©å€‹éƒ½å¤±æ•—
    if df is None or df.empty:
        raise HTTPException(
            status_code=503,
            detail=f"ç„¡æ³•å–å¾— {symbol} è³‡æ–™ã€‚CoinGecko å’Œ Yahoo Finance éƒ½ç„¡æ³•é€£æ¥ã€‚è«‹ç¨å¾Œå†è©¦ã€‚"
        )
    
    logger.info(f"ä½¿ç”¨ {data_source} è³‡æ–™ï¼Œå…± {len(df)} ç­†")
    
    # ç¢ºä¿æœ‰å¿…è¦çš„æ¬„ä½ (åœ¨ try å¡Šå¤–é¢å…ˆè™•ç†)
    if 'volume' not in df.columns:
        df['volume'] = 0
        logger.warning(f"{symbol} æ²’æœ‰ volume è³‡æ–™ï¼Œå·²å¡«å…¥ 0")
    
    # ç¢ºä¿ volume ä¸æ˜¯ None æˆ– NaN
    df['volume'] = df['volume'].fillna(0).astype(float)
    
    try:
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        df = indicator_service.calculate_all_indicators(df)
        
        # å–å¾—æœ€æ–°è³‡æ–™
        latest = df.iloc[-1]
        current_price = float(latest['close'])
        
        # æ¼²è·Œå¹…è¨ˆç®—
        def calc_change(days):
            try:
                if len(df) > days:
                    old_price = float(df.iloc[-days-1]['close'])
                    return round((current_price - old_price) / old_price * 100, 2)
            except:
                pass
            return None
        
        # å‡ç·šè³‡è¨Š (åŠ å¯†è²¨å¹£ç”¨ MA7/25/99)
        ma7 = float(df['close'].tail(7).mean()) if len(df) >= 7 else None
        ma25 = float(df['close'].tail(25).mean()) if len(df) >= 25 else None
        ma99 = float(df['close'].tail(99).mean()) if len(df) >= 99 else None
        
        # åˆ¤æ–·å‡ç·šæ’åˆ—
        alignment = "neutral"
        if ma7 and ma25 and ma99:
            if current_price > ma7 > ma25 > ma99:
                alignment = "bullish"
            elif current_price < ma7 < ma25 < ma99:
                alignment = "bearish"
        
        # RSI (å°å¯«: rsi)
        rsi_value = float(latest.get('rsi', 50)) if 'rsi' in latest else 50
        rsi_status = "overbought" if rsi_value > 70 else "oversold" if rsi_value < 30 else "neutral"
        
        # MACD (å°å¯«: macd_dif, macd_dea)
        macd_dif = float(latest.get('macd_dif', 0)) if 'macd_dif' in latest else 0
        macd_dea = float(latest.get('macd_dea', 0)) if 'macd_dea' in latest else 0
        macd_status = "bullish" if macd_dif > macd_dea else "bearish"
        
        # ç¶œåˆè©•åˆ†
        buy_score = 0
        sell_score = 0
        
        if alignment == "bullish":
            buy_score += 1
        elif alignment == "bearish":
            sell_score += 1
        
        if rsi_value < 30:
            buy_score += 1
        elif rsi_value > 70:
            sell_score += 1
        
        if macd_status == "bullish":
            buy_score += 1
        else:
            sell_score += 1
        
        rating = "bullish" if buy_score > sell_score else "bearish" if sell_score > buy_score else "neutral"
        
        return {
            "success": True,
            "symbol": symbol,
            "name": info.get("name", symbol) if info else symbol,
            "asset_type": "crypto",
            "price": {
                "current": current_price,
                "ath": info.get("ath") if info else None,
                "from_ath_pct": info.get("ath_change_percentage") if info else None,
            },
            "change": {
                "day": calc_change(1),
                "week": calc_change(7),
                "month": calc_change(30),
                "year": calc_change(365),
            },
            "market": {
                "market_cap": info.get("market_cap") if info else None,
                "market_cap_rank": info.get("market_cap_rank") if info else None,
                "volume_24h": info.get("total_volume") if info else None,
            },
            "indicators": {
                "ma": {
                    "ma7": ma7,
                    "ma25": ma25,
                    "ma99": ma99,
                    "alignment": alignment,
                    "price_vs_ma7": "above" if ma7 and current_price > ma7 else "below",
                    "price_vs_ma25": "above" if ma25 and current_price > ma25 else "below",
                    "price_vs_ma99": "above" if ma99 and current_price > ma99 else "below",
                },
                "rsi": {
                    "value": rsi_value,
                    "period": 14,
                    "status": rsi_status,
                },
                "macd": {
                    "dif": macd_dif,
                    "macd": macd_dea,
                    "status": macd_status,
                },
            },
            "score": {
                "buy": buy_score,
                "sell": sell_score,
                "rating": rating,
            },
            "chart_data": {
                "dates": [str(d) for d in df['date'].tail(365).tolist()] if 'date' in df.columns else [],
                "prices": [float(p) for p in df['close'].tail(365).tolist()] if 'close' in df.columns else [],
                "ma20": [float(v) if not pd.isna(v) else None for v in df['ma20'].tail(365).tolist()] if 'ma20' in df.columns else [],
                "ma50": [float(v) if not pd.isna(v) else None for v in df['ma50'].tail(365).tolist()] if 'ma50' in df.columns else [],
                "ma200": [float(v) if not pd.isna(v) else None for v in df['ma200'].tail(365).tolist()] if 'ma200' in df.columns else [],
                "ma250": [float(v) if not pd.isna(v) else None for v in df['ma250'].tail(365).tolist()] if 'ma250' in df.columns else [],
            },
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æŸ¥è©¢ {symbol} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"æŸ¥è©¢å¤±æ•—: {str(e)}"
        )


@router.get("/api/crypto/{symbol}/chart", summary="å–å¾—åŠ å¯†è²¨å¹£åœ–è¡¨")
async def get_crypto_chart(
    symbol: str,
    days: int = Query(120, ge=30, le=365, description="é¡¯ç¤ºå¤©æ•¸"),
):
    """
    ç”ŸæˆåŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æåœ–è¡¨
    
    - **symbol**: åŠ å¯†è²¨å¹£ä»£è™Ÿ (BTC, ETH)
    - **days**: é¡¯ç¤ºå¤©æ•¸ (30-365)
    
    å›å‚³ PNG åœ–ç‰‡
    """
    from app.data_sources.coingecko import coingecko
    from app.services.chart_service import chart_service
    
    symbol = symbol.upper()
    
    df = coingecko.get_ohlc(symbol, days=days)
    
    if df is None or df.empty:
        raise HTTPException(
            status_code=404,
            detail=f"æ‰¾ä¸åˆ°åŠ å¯†è²¨å¹£: {symbol}"
        )
    
    # å–å¾—åç¨±
    info = coingecko.get_coin_info(symbol)
    name = info.get("name", "") if info else ""
    
    # ç”Ÿæˆåœ–è¡¨
    chart_path = chart_service.plot_stock_analysis(
        df,
        symbol=symbol,
        name=name,
        days=days,
        show_kd=False,
    )
    
    return FileResponse(
        chart_path,
        media_type="image/png",
        filename=f"{symbol}_chart.png",
    )


@router.get("/api/market/sentiment", summary="å–å¾—å¸‚å ´æƒ…ç·’", response_model=MarketSentimentResponse)
async def get_market_sentiment(
    market: str = Query("all", description="å¸‚å ´é¡å‹ (stock, crypto, all)"),
):
    """
    å–å¾—å¸‚å ´æƒ…ç·’æŒ‡æ•¸
    
    - **market**: å¸‚å ´é¡å‹
      - `stock`: ç¾è‚¡ CNN Fear & Greed Index
      - `crypto`: åŠ å¯†è²¨å¹£ Alternative.me
      - `all`: å…©è€…éƒ½å–å¾—
    
    æƒ…ç·’æŒ‡æ•¸ç¯„åœ 0-100ï¼š
    - 0-25: æ¥µåº¦ææ‡¼
    - 26-45: ææ‡¼
    - 46-55: ä¸­æ€§
    - 56-75: è²ªå©ª
    - 76-100: æ¥µåº¦è²ªå©ª
    """
    from app.data_sources.fear_greed import fear_greed
    
    result = {}
    
    if market in ("all", "stock"):
        stock_sentiment = fear_greed.get_stock_fear_greed()
        if stock_sentiment:
            result["stock"] = stock_sentiment
    
    if market in ("all", "crypto"):
        crypto_sentiment = fear_greed.get_crypto_fear_greed()
        if crypto_sentiment:
            result["crypto"] = crypto_sentiment
    
    return MarketSentimentResponse(
        success=True,
        stock=result.get("stock"),
        crypto=result.get("crypto"),
    )
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/market.py  â­â­â­
> å¸‚å ´è³‡æ–™ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´è³‡æ–™ API è·¯ç”±
ä¸‰å¤§æŒ‡æ•¸ã€å¸‚å ´æƒ…ç·’ã€æ’ç¨‹ä»»å‹™
"""
from fastapi import APIRouter, Depends, HTTPException, Query, Request
from sqlalchemy.orm import Session
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional
import logging

from app.database import get_db, get_async_session
from app.services.market_service import MarketService
from app.services.auth_service import AuthService
from app.tasks.scheduler import scheduler_service
from app.models.index_price import INDEX_SYMBOLS

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/market", tags=["market"])


# ==================== èªè­‰ä¾è³´ ====================

async def get_current_user_optional(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç•¶å‰ç”¨æˆ¶ï¼ˆé¸æ“‡æ€§ï¼Œæœªç™»å…¥è¿”å› Noneï¼‰"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        return None
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    return user


async def get_current_admin(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç•¶å‰ç®¡ç†å“¡ï¼ˆå¿…é ˆæ˜¯ç®¡ç†å“¡ï¼‰"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="æœªæä¾›èªè­‰ Token")
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        raise HTTPException(status_code=401, detail="ç„¡æ•ˆçš„ Token")
    
    if not user.is_admin:
        raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å“¡æ¬Šé™")
    
    return user


# ==================== ä¸‰å¤§æŒ‡æ•¸ ====================

@router.get("/indices")
async def get_indices(
    db: Session = Depends(get_db),
):
    """
    å–å¾—ä¸‰å¤§æŒ‡æ•¸æœ€æ–°è³‡æ–™
    
    Returns:
        - S&P 500 (^GSPC)
        - é“ç“Šå·¥æ¥­ (^DJI)
        - ç´æ–¯é”å…‹ (^IXIC)
    """
    try:
        market_service = MarketService(db)
        indices = market_service.get_latest_indices()
        
        return {
            "success": True,
            "data": {
                "indices": indices,
                "symbols": INDEX_SYMBOLS,
            }
        }
    except Exception as e:
        logger.error(f"å–å¾—æŒ‡æ•¸å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/indices/{symbol}/history")
async def get_index_history(
    symbol: str,
    days: int = Query(default=365, ge=1, le=3650),
    db: Session = Depends(get_db),
):
    """
    å–å¾—æŒ‡æ•¸æ­·å²è³‡æ–™
    
    Args:
        symbol: æŒ‡æ•¸ä»£è™Ÿ (^GSPC, ^DJI, ^IXIC)
        days: å¤©æ•¸ (é è¨­ 365ï¼Œæœ€å¤š 3650)
    """
    # é©—è­‰ symbol
    if symbol not in INDEX_SYMBOLS:
        raise HTTPException(
            status_code=400,
            detail=f"ç„¡æ•ˆçš„æŒ‡æ•¸ä»£è™Ÿï¼Œå¯ç”¨: {list(INDEX_SYMBOLS.keys())}"
        )
    
    try:
        market_service = MarketService(db)
        history = market_service.get_index_history(symbol, days)
        
        return {
            "success": True,
            "data": {
                "symbol": symbol,
                "name": INDEX_SYMBOLS[symbol]["name"],
                "name_zh": INDEX_SYMBOLS[symbol]["name_zh"],
                "days": days,
                "count": len(history),
                "history": history,
            }
        }
    except Exception as e:
        logger.error(f"å–å¾—æŒ‡æ•¸æ­·å²å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ==================== å¸‚å ´æƒ…ç·’ ====================

@router.get("/sentiment")
async def get_sentiment(
    db: Session = Depends(get_db),
):
    """
    å–å¾—å¸‚å ´æƒ…ç·’ï¼ˆç¾è‚¡ + å¹£åœˆï¼‰
    """
    try:
        market_service = MarketService(db)
        sentiment = market_service.get_latest_sentiment()
        
        return {
            "success": True,
            "data": sentiment,
        }
    except Exception as e:
        logger.error(f"å–å¾—æƒ…ç·’å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/sentiment/{market}/history")
async def get_sentiment_history(
    market: str,
    days: int = Query(default=365, ge=1, le=365),
    db: Session = Depends(get_db),
):
    """
    å–å¾—æƒ…ç·’æ­·å²è³‡æ–™
    
    Args:
        market: å¸‚å ´é¡å‹ (stock, crypto)
        days: å¤©æ•¸ (é è¨­ 365ï¼Œæœ€å¤š 365)
    """
    if market not in ["stock", "crypto"]:
        raise HTTPException(
            status_code=400,
            detail="ç„¡æ•ˆçš„å¸‚å ´é¡å‹ï¼Œå¯ç”¨: stock, crypto"
        )
    
    try:
        market_service = MarketService(db)
        history = market_service.get_sentiment_history(market, days)
        
        return {
            "success": True,
            "data": {
                "market": market,
                "days": days,
                "count": len(history),
                "history": history,
            }
        }
    except Exception as e:
        logger.error(f"å–å¾—æƒ…ç·’æ­·å²å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ==================== ç®¡ç†å“¡åŠŸèƒ½ï¼šæ’ç¨‹ä»»å‹™ ====================

@router.post("/admin/update")
async def trigger_daily_update(
    current_user = Depends(get_current_admin),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] æ‰‹å‹•è§¸ç™¼æ¯æ—¥æ›´æ–°
    """
    try:
        result = scheduler_service.run_daily_update()
        
        return {
            "success": result.get("success", False),
            "data": result,
        }
    except Exception as e:
        logger.error(f"åŸ·è¡Œæ›´æ–°å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/initialize")
async def initialize_historical_data(
    years: int = Query(default=10, ge=1, le=10),
    current_user = Depends(get_current_admin),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] åˆå§‹åŒ–æ­·å²è³‡æ–™
    
    é¦–æ¬¡éƒ¨ç½²æ™‚åŸ·è¡Œï¼ŒæŠ“å–ï¼š
    - ä¸‰å¤§æŒ‡æ•¸ N å¹´æ­·å²
    - å¹£åœˆæƒ…ç·’ 365 å¤©æ­·å²
    """
    try:
        result = scheduler_service.initialize_historical_data(years=years)
        
        return {
            "success": result.get("success", False),
            "data": result,
        }
    except Exception as e:
        logger.error(f"åˆå§‹åŒ–å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/update-indices")
async def update_indices(
    period: str = Query(default="5d", pattern="^(5d|1mo|3mo|1y|5y|10y)$"),
    current_user = Depends(get_current_admin),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] æ›´æ–°ä¸‰å¤§æŒ‡æ•¸è³‡æ–™
    """
    try:
        market_service = MarketService(db)
        result = market_service.fetch_and_save_all_indices(period=period)
        
        return {
            "success": True,
            "data": {
                "period": period,
                "indices": result,
            }
        }
    except Exception as e:
        logger.error(f"æ›´æ–°æŒ‡æ•¸å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/update-sentiment")
async def update_sentiment(
    current_user = Depends(get_current_admin),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] æ›´æ–°ä»Šæ—¥å¸‚å ´æƒ…ç·’
    """
    try:
        market_service = MarketService(db)
        result = market_service.update_today_sentiment()
        
        return {
            "success": True,
            "data": result,
        }
    except Exception as e:
        logger.error(f"æ›´æ–°æƒ…ç·’å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/init-crypto-sentiment")
async def init_crypto_sentiment(
    days: int = Query(default=365, ge=1, le=365),
    current_user = Depends(get_current_admin),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] åˆå§‹åŒ–å¹£åœˆæƒ…ç·’æ­·å²
    """
    try:
        market_service = MarketService(db)
        count = market_service.fetch_and_save_crypto_history(days=days)
        
        return {
            "success": True,
            "data": {
                "days_requested": days,
                "records_added": count,
            }
        }
    except Exception as e:
        logger.error(f"åˆå§‹åŒ–å¹£åœˆæƒ…ç·’å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/admin/scheduler-status")
async def get_scheduler_status(
    current_user = Depends(get_current_admin),
):
    """
    [ç®¡ç†å“¡] å–å¾—æ’ç¨‹ç‹€æ…‹
    """
    return {
        "success": True,
        "data": scheduler_service.get_status(),
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/stock.py  â­â­â­
> è‚¡ç¥¨æŸ¥è©¢ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨æŸ¥è©¢ API è·¯ç”±

ä¿®å¾©: å°è‚¡ä»£è™Ÿè‡ªå‹•è½‰æ› (0050 â†’ 0050.TW)
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import FileResponse
import logging
import pandas as pd
from datetime import datetime

from app.schemas.schemas import StockAnalysisResponse

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/stock", tags=["è‚¡ç¥¨"])


def normalize_tw_symbol(symbol: str) -> str:
    """
    æ¨™æº–åŒ–å°è‚¡ä»£è™Ÿ
    - ç´”æ•¸å­— 4-6 ä½ â†’ è‡ªå‹•åŠ  .TW
    - å·²æœ‰å¾Œç¶´ â†’ ä¿æŒä¸è®Š
    """
    symbol = symbol.strip().upper()
    
    # å¦‚æœå·²ç¶“æœ‰å¾Œç¶´ï¼Œä¸è™•ç†
    if '.' in symbol or symbol.startswith('^'):
        return symbol
    
    # å°è‚¡ä»£è™Ÿï¼š4-6 ä½ç´”æ•¸å­—
    if symbol.isdigit() and 4 <= len(symbol) <= 6:
        return f"{symbol}.TW"
    
    return symbol


@router.get("/{symbol}", summary="æŸ¥è©¢è‚¡ç¥¨")
async def get_stock_analysis(
    symbol: str,
    refresh: bool = Query(False, description="æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™"),
):
    """
    æŸ¥è©¢å–®ä¸€è‚¡ç¥¨çš„æŠ€è¡“åˆ†æå ±å‘Š
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.indicator_service import indicator_service
    
    # å°è‚¡ä»£è™Ÿè‡ªå‹•è½‰æ›
    symbol = normalize_tw_symbol(symbol)
    original_symbol = symbol
    logger.info(f"é–‹å§‹æŸ¥è©¢è‚¡ç¥¨: {symbol}")
    
    try:
        # å–å¾—è‚¡ç¥¨è³‡æ–™ (æŠ“å– 10 å¹´ä»¥è¨ˆç®—é•·æœŸ CAGR)
        logger.info(f"æ­£åœ¨å¾ Yahoo Finance å–å¾— {symbol} è³‡æ–™...")
        df = yahoo_finance.get_stock_history(symbol, period="10y")
        
        # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO (ä¸Šæ«ƒè‚¡ç¥¨)
        if (df is None or df.empty) and symbol.endswith('.TW'):
            two_symbol = symbol.replace('.TW', '.TWO')
            logger.info(f"{symbol} æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
            df = yahoo_finance.get_stock_history(two_symbol, period="10y")
            if df is not None and not df.empty:
                symbol = two_symbol
                logger.info(f"æˆåŠŸæ‰¾åˆ°ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
        
        if df is None or df.empty:
            logger.warning(f"æ‰¾ä¸åˆ°è‚¡ç¥¨è³‡æ–™: {original_symbol}")
            raise HTTPException(
                status_code=404,
                detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦ä¸Šå¸‚ .TW å’Œä¸Šæ«ƒ .TWOï¼‰"
            )
        
        logger.info(f"å–å¾— {len(df)} ç­†è³‡æ–™ï¼Œæ­£åœ¨è¨ˆç®—æŠ€è¡“æŒ‡æ¨™...")
        
        # å–å¾—è‚¡ç¥¨è³‡è¨Š
        info = yahoo_finance.get_stock_info(symbol)
        
        # ä¿å­˜åŸå§‹æ”¶ç›¤åƒ¹ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
        df['close_raw'] = df['close'].copy()
        
        # ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆè™•ç†åˆ†å‰²å’Œé…æ¯ï¼‰
        # é€™æ¨£ MA ç·šå’Œåœ–è¡¨æ‰ä¸æœƒæœ‰æ–·å´–
        if 'adj_close' in df.columns:
            df['close'] = df['adj_close']
            logger.info(f"{symbol} ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼è¨ˆç®—æŒ‡æ¨™")
        
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆåŸºæ–¼èª¿æ•´å¾Œåƒ¹æ ¼ï¼‰
        df = indicator_service.calculate_all_indicators(df)
        
        # å–å¾—æœ€æ–°è³‡æ–™
        latest = df.iloc[-1]
        # é¡¯ç¤ºç”¨åŸå§‹åƒ¹æ ¼ï¼ˆç”¨æˆ¶ç¿’æ…£çœ‹çš„åƒ¹æ ¼ï¼‰
        current_price = float(latest['close_raw'])
        
        logger.info(f"{symbol} ç¾åƒ¹: {current_price}")
        
        # åƒ¹æ ¼è³‡è¨Šï¼ˆç”¨åŸå§‹åƒ¹æ ¼é¡¯ç¤º 52 é€±é«˜ä½ï¼‰
        high_52w = float(df['close_raw'].tail(252).max()) if len(df) >= 252 else float(df['close_raw'].max())
        low_52w = float(df['close_raw'].tail(252).min()) if len(df) >= 252 else float(df['close_raw'].min())
        
        # æ¼²è·Œå¹…è¨ˆç®—ï¼ˆç”¨èª¿æ•´å¾Œåƒ¹æ ¼è¨ˆç®—ï¼Œåæ˜ çœŸå¯¦å ±é…¬ï¼‰
        current_price_adj = float(latest['close'])  # èª¿æ•´å¾Œç¾åƒ¹
        def calc_change(days):
            if len(df) > days:
                old_price_adj = float(df.iloc[-days-1]['close'])  # èª¿æ•´å¾Œæ­·å²åƒ¹æ ¼
                return round((current_price_adj - old_price_adj) / old_price_adj * 100, 2)
            return None
        
        # å‡ç·šè³‡è¨Š (indicator_service ç”¨å°å¯«: ma20, ma50, ma200)
        ma20 = float(latest.get('ma20', 0)) if 'ma20' in latest else None
        ma50 = float(latest.get('ma50', 0)) if 'ma50' in latest else None
        ma200 = float(latest.get('ma200', 0)) if 'ma200' in latest else None
        
        # åˆ¤æ–·å‡ç·šæ’åˆ—ï¼ˆç”¨èª¿æ•´å¾Œåƒ¹æ ¼æ¯”è¼ƒï¼‰
        alignment = "neutral"
        if ma20 and ma50 and ma200:
            if current_price_adj > ma20 > ma50 > ma200:
                alignment = "bullish"
            elif current_price_adj < ma20 < ma50 < ma200:
                alignment = "bearish"
        
        # RSI (å°å¯«: rsi)
        rsi_value = float(latest.get('rsi', 50)) if 'rsi' in latest else 50
        rsi_status = "overbought" if rsi_value > 70 else "oversold" if rsi_value < 30 else "neutral"
        
        # MACD (å°å¯«: macd_dif, macd_dea, macd_hist)
        macd_dif = float(latest.get('macd_dif', 0)) if 'macd_dif' in latest else 0
        macd_dea = float(latest.get('macd_dea', 0)) if 'macd_dea' in latest else 0
        macd_hist = float(latest.get('macd_hist', 0)) if 'macd_hist' in latest else 0
        macd_status = "bullish" if macd_dif > macd_dea else "bearish"
        
        # æˆäº¤é‡
        volume_today = int(latest['volume']) if 'volume' in latest else 0
        volume_avg = int(df['volume'].tail(20).mean()) if 'volume' in df.columns else 0
        volume_ratio = round(volume_today / volume_avg, 2) if volume_avg > 0 else 1.0
        
        # ç¶œåˆè©•åˆ†
        buy_score = 0
        sell_score = 0
        
        if alignment == "bullish":
            buy_score += 1
        elif alignment == "bearish":
            sell_score += 1
        
        if rsi_value < 30:
            buy_score += 1
        elif rsi_value > 70:
            sell_score += 1
        
        if macd_status == "bullish":
            buy_score += 1
        else:
            sell_score += 1
        
        rating = "bullish" if buy_score > sell_score else "bearish" if sell_score > buy_score else "neutral"
        
        logger.info(f"{symbol} æŸ¥è©¢å®Œæˆï¼Œè©•åˆ†: {rating}")
        
        # ç¢ºä¿ name æ­£ç¢ºç²å–
        stock_name = ""
        if info:
            stock_name = info.get("name", "")
        if not stock_name:
            # å†æ¬¡å˜—è©¦å¾æœ¬åœ°æ˜ å°„è¡¨ç²å–
            from app.data_sources.yahoo_finance import TAIWAN_STOCK_NAMES
            stock_code = symbol.replace(".TW", "").replace(".TWO", "")
            stock_name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
        
        return {
            "success": True,
            "symbol": symbol,
            "name": stock_name,
            "asset_type": "stock",
            "price": {
                "current": current_price,
                "high_52w": high_52w,
                "low_52w": low_52w,
                "from_high_pct": round((current_price - high_52w) / high_52w * 100, 2),
                "from_low_pct": round((current_price - low_52w) / low_52w * 100, 2),
            },
            "change": {
                "day": calc_change(1),
                "week": calc_change(5),
                "month": calc_change(20),
                "quarter": calc_change(60),
                "year": calc_change(250),
            },
            "volume": {
                "today": volume_today,
                "avg_20d": volume_avg,
                "ratio": volume_ratio,
            },
            "indicators": {
                "ma": {
                    "ma20": ma20,
                    "ma50": ma50,
                    "ma200": ma200,
                    "alignment": alignment,
                    "price_vs_ma20": "above" if ma20 and current_price > ma20 else "below" if ma20 else None,
                    "price_vs_ma50": "above" if ma50 and current_price > ma50 else "below" if ma50 else None,
                    "price_vs_ma200": "above" if ma200 and current_price > ma200 else "below" if ma200 else None,
                },
                "rsi": {
                    "value": rsi_value,
                    "period": 14,
                    "status": rsi_status,
                },
                "macd": {
                    "dif": macd_dif,
                    "macd": macd_dea,
                    "histogram": macd_hist,
                    "status": macd_status,
                },
            },
            "score": {
                "buy": buy_score,
                "sell": sell_score,
                "rating": rating,
            },
            # æ·»åŠ åœ–è¡¨æ•¸æ“š (æœ€è¿‘ 1500 å¤©ï¼Œæ”¯æ´ 5 å¹´ç¯„åœ)
            "chart_data": {
                "dates": [str(d) for d in df['date'].tail(1500).tolist()],
                "prices": [float(p) for p in df['close'].tail(1500).tolist()],
                "ma20": [float(v) if not pd.isna(v) else None for v in df['ma20'].tail(1500).tolist()] if 'ma20' in df.columns else [],
                "ma50": [float(v) if not pd.isna(v) else None for v in df['ma50'].tail(1500).tolist()] if 'ma50' in df.columns else [],
                "ma200": [float(v) if not pd.isna(v) else None for v in df['ma200'].tail(1500).tolist()] if 'ma200' in df.columns else [],
                "ma250": [float(v) if not pd.isna(v) else None for v in df['ma250'].tail(1500).tolist()] if 'ma250' in df.columns else [],
            },
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æŸ¥è©¢ {symbol} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"æŸ¥è©¢å¤±æ•—: {str(e)}"
        )


@router.get("/{symbol}/chart", summary="å–å¾—è‚¡ç¥¨åœ–è¡¨")
async def get_stock_chart(
    symbol: str,
    days: int = Query(120, ge=30, le=365, description="é¡¯ç¤ºå¤©æ•¸"),
):
    """
    ç”Ÿæˆè‚¡ç¥¨æŠ€è¡“åˆ†æåœ–è¡¨
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.chart_service import chart_service
    
    # å°è‚¡ä»£è™Ÿè‡ªå‹•è½‰æ›
    symbol = normalize_tw_symbol(symbol)
    
    df = yahoo_finance.get_stock_history(symbol, period="1y")
    
    # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO
    if (df is None or df.empty) and symbol.endswith('.TW'):
        two_symbol = symbol.replace('.TW', '.TWO')
        df = yahoo_finance.get_stock_history(two_symbol, period="1y")
        if df is not None and not df.empty:
            symbol = two_symbol
    
    if df is None or df.empty:
        raise HTTPException(
            status_code=404,
            detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}"
        )
    
    # å–å¾—è‚¡ç¥¨åç¨±
    info = yahoo_finance.get_stock_info(symbol)
    name = info.get("name", "") if info else ""
    
    # ç”Ÿæˆåœ–è¡¨
    chart_path = chart_service.plot_stock_analysis(
        df,
        symbol=symbol,
        name=name,
        days=days,
        show_kd=False,
    )
    
    return FileResponse(
        chart_path,
        media_type="image/png",
        filename=f"{symbol}_chart.png",
    )


@router.get("/compare/history", summary="èµ°å‹¢æ¯”è¼ƒ")
async def compare_stocks(
    symbols: str = Query(..., description="è‚¡ç¥¨ä»£è™Ÿï¼Œé€—è™Ÿåˆ†éš”ï¼Œæœ€å¤š 5 å€‹"),
    days: int = Query(90, ge=7, le=365, description="æ¯”è¼ƒå¤©æ•¸"),
):
    """
    å–å¾—å¤šæ”¯è‚¡ç¥¨çš„æ­£è¦åŒ–èµ°å‹¢è³‡æ–™ï¼ˆç”¨æ–¼æ¯”è¼ƒåœ–è¡¨ï¼‰
    
    - åƒ¹æ ¼æœƒæ­£è¦åŒ–ç‚ºèµ·å§‹æ—¥ = 100%
    - å›å‚³å„è‚¡ç¥¨çš„æ—¥æœŸã€æ­£è¦åŒ–åƒ¹æ ¼
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    import math
    
    # è§£æ symbolsï¼Œä¸¦è‡ªå‹•è½‰æ›å°è‚¡ä»£è™Ÿ
    symbol_list = [normalize_tw_symbol(s.strip()) for s in symbols.split(",") if s.strip()]
    
    if len(symbol_list) < 1:
        raise HTTPException(status_code=400, detail="è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ä»£è™Ÿ")
    
    if len(symbol_list) > 5:
        raise HTTPException(status_code=400, detail="æœ€å¤šæ¯”è¼ƒ 5 å€‹æ¨™çš„")
    
    logger.info(f"èµ°å‹¢æ¯”è¼ƒ: {symbol_list}, {days} å¤©")
    
    result = {}
    common_dates = None
    
    for symbol in symbol_list:
        try:
            # åˆ¤æ–·æ˜¯æŒ‡æ•¸é‚„æ˜¯è‚¡ç¥¨
            if symbol.startswith("^"):
                df = yahoo_finance.get_index_data(symbol, period="2y")
            else:
                df = yahoo_finance.get_stock_history(symbol, period="2y")
                
                # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO
                if (df is None or df.empty) and symbol.endswith('.TW'):
                    two_symbol = symbol.replace('.TW', '.TWO')
                    df = yahoo_finance.get_stock_history(two_symbol, period="2y")
                    if df is not None and not df.empty:
                        symbol = two_symbol
            
            if df is None or df.empty:
                logger.warning(f"æ‰¾ä¸åˆ°è³‡æ–™: {symbol}")
                continue
            
            # å–æœ€è¿‘ N å¤©
            df = df.tail(days).copy()
            
            if len(df) < 5:
                logger.warning(f"{symbol} è³‡æ–™ä¸è¶³")
                continue
            
            # æ­£è¦åŒ–ï¼šèµ·å§‹åƒ¹æ ¼ = 100ï¼ˆä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼ä»¥è™•ç†åˆ†å‰²ï¼‰
            # å¦‚æœæ²’æœ‰ adj_closeï¼Œç”¨ close
            price_col = "adj_close" if "adj_close" in df.columns else "close"
            start_price = df.iloc[0][price_col]
            if start_price == 0 or pd.isna(start_price):
                continue
            
            df["normalized"] = (df[price_col] / start_price) * 100
            
            # æ¸…ç† NaN
            df = df.dropna(subset=["normalized"])
            
            # å–å¾—åç¨±
            if symbol.startswith("^"):
                from app.models.index_price import INDEX_SYMBOLS
                info = INDEX_SYMBOLS.get(symbol, {})
                name = info.get("name_zh", symbol)
            else:
                info = yahoo_finance.get_stock_info(symbol)
                name = info.get("name", symbol) if info else symbol
            
            # è½‰ç‚ºåˆ—è¡¨
            history = []
            for _, row in df.iterrows():
                val = row["normalized"]
                # æª¢æŸ¥ NaN/Inf
                if math.isnan(val) or math.isinf(val):
                    continue
                history.append({
                    "date": row["date"].isoformat() if hasattr(row["date"], "isoformat") else str(row["date"]),
                    "value": round(val, 2),
                    "price": round(float(row["close"]), 2),  # é¡¯ç¤ºç”¨åŸå§‹åƒ¹æ ¼
                })
            
            if history:
                end_price_adj = float(df.iloc[-1][price_col])
                result[symbol] = {
                    "symbol": symbol,
                    "name": name,
                    "start_price": round(float(df.iloc[0]["close"]), 2),  # é¡¯ç¤ºç”¨åŸå§‹åƒ¹æ ¼
                    "end_price": round(float(df.iloc[-1]["close"]), 2),   # é¡¯ç¤ºç”¨åŸå§‹åƒ¹æ ¼
                    "change_pct": round((end_price_adj / start_price - 1) * 100, 2),  # è¨ˆç®—ç”¨èª¿æ•´å¾Œåƒ¹æ ¼
                    "data": history,
                }
                
                # è¨˜éŒ„æ—¥æœŸç”¨æ–¼å°é½Š
                dates = set(h["date"] for h in history)
                if common_dates is None:
                    common_dates = dates
                else:
                    common_dates = common_dates.intersection(dates)
        
        except Exception as e:
            logger.error(f"è™•ç† {symbol} å¤±æ•—: {e}")
            continue
    
    if not result:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™")
    
    return {
        "success": True,
        "data": {
            "symbols": list(result.keys()),
            "days": days,
            "stocks": result,
        }
    }


@router.get("/{symbol}/returns", summary="å¹´åŒ–å ±é…¬ç‡")
async def get_stock_returns(
    symbol: str,
):
    """
    è¨ˆç®—è‚¡ç¥¨çš„æ­·å²å¹´åŒ–å ±é…¬ç‡ (CAGR)
    
    è¨ˆç®—æ–¹å¼ï¼šå«é…æ¯å†æŠ•å…¥çš„ç¸½å ±é…¬ç‡
    - åˆ†å‰²èª¿æ•´ï¼šå·²è™•ç†
    - é…æ¯é‚„åŸï¼šåœ¨è¨ˆç®—æ™‚å°‡é…æ¯åŠ å›
    
    å›å‚³ 1Y, 3Y, 5Y, 10Y çš„ CAGR
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    from datetime import date, timedelta
    import math
    
    # å°è‚¡ä»£è™Ÿè‡ªå‹•è½‰æ›
    symbol = normalize_tw_symbol(symbol)
    original_symbol = symbol
    logger.info(f"è¨ˆç®—å¹´åŒ–å ±é…¬ç‡: {symbol}")
    
    try:
        # å–å¾— 10 å¹´è‚¡åƒ¹æ­·å²
        df = yahoo_finance.get_stock_history(symbol, period="10y")
        
        # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO
        if (df is None or df.empty) and symbol.endswith('.TW'):
            two_symbol = symbol.replace('.TW', '.TWO')
            df = yahoo_finance.get_stock_history(two_symbol, period="10y")
            if df is not None and not df.empty:
                symbol = two_symbol
        
        if df is None or df.empty:
            raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}")
        
        # ç¢ºä¿æœ‰ date æ¬„ä½
        if 'date' not in df.columns:
            df = df.reset_index()
            if 'Date' in df.columns:
                df = df.rename(columns={'Date': 'date'})
        
        df['date'] = pd.to_datetime(df['date']).dt.date
        df = df.sort_values('date').reset_index(drop=True)
        
        # å–å¾—é…æ¯æ­·å²
        dividends_df = yahoo_finance.get_dividends(symbol, period="10y")
        
        # å»ºç«‹é…æ¯å­—å…¸ {date: amount}
        dividends = {}
        if dividends_df is not None and not dividends_df.empty:
            for _, row in dividends_df.iterrows():
                div_date = row['date']
                if isinstance(div_date, str):
                    div_date = datetime.strptime(div_date, '%Y-%m-%d').date()
                dividends[div_date] = float(row['amount'])
        
        logger.info(f"{symbol} é…æ¯è¨˜éŒ„: {len(dividends)} ç­†")
        
        # å–å¾—è‚¡ç¥¨åç¨±
        info = yahoo_finance.get_stock_info(symbol)
        stock_name = info.get("name", symbol) if info else symbol
        
        # ç¾åƒ¹ï¼ˆé¡¯ç¤ºç”¨ï¼Œç”¨åŸå§‹æ”¶ç›¤åƒ¹ï¼‰
        current_price_display = float(df.iloc[-1]['close'])
        current_date = df.iloc[-1]['date']
        
        # ===== è¨ˆç®—å«æ¯èª¿æ•´åƒ¹æ ¼ï¼ˆç”¨æ–¼å ±é…¬ç‡è¨ˆç®—ï¼‰ =====
        # å¾æœ€æ–°æ—¥æœŸå¾€å‰ï¼Œæ¯é‡åˆ°ä¸€æ¬¡é…æ¯å°±èª¿æ•´ä¹‹å‰çš„åƒ¹æ ¼
        df['adj_close_with_div'] = df['adj_close'].astype(float)
        date_to_idx = {row['date']: idx for idx, row in df.iterrows()}
        
        # æ‰¾å‡ºåœ¨è³‡æ–™ç¯„åœå…§çš„é…æ¯
        min_date = df['date'].min()
        max_date = df['date'].max()
        relevant_divs = [(d, amt) for d, amt in dividends.items() 
                        if min_date < d <= max_date]
        
        if relevant_divs:
            # å¾æœ€æ–°åˆ°æœ€èˆŠè™•ç†é…æ¯
            for div_date, div_amount in sorted(relevant_divs, reverse=True):
                if div_date in date_to_idx:
                    ex_idx = date_to_idx[div_date]
                    if ex_idx > 0:
                        # é™¤æ¯å‰ä¸€å¤©çš„åƒ¹æ ¼
                        prev_price = df.loc[ex_idx - 1, 'adj_close_with_div']
                        if prev_price > div_amount and div_amount > 0:
                            # é‚„åŸå› å­
                            adjustment_factor = prev_price / (prev_price - div_amount)
                            # èª¿æ•´é™¤æ¯æ—¥ä¹‹å‰çš„æ‰€æœ‰åƒ¹æ ¼
                            df.loc[:ex_idx-1, 'adj_close_with_div'] = df.loc[:ex_idx-1, 'adj_close_with_div'] / adjustment_factor
        
        # å«æ¯èª¿æ•´å¾Œç¾åƒ¹
        current_price_adj = float(df.iloc[-1]['adj_close_with_div'])
        
        # è¨ˆç®—ä¸åŒæœŸé–“çš„å ±é…¬ç‡
        periods = [
            ("1Y", 1),
            ("3Y", 3),
            ("5Y", 5),
            ("10Y", 10),
        ]
        
        results = {}
        
        for period_name, years in periods:
            target_date = current_date - timedelta(days=years * 365)
            
            # æ‰¾åˆ°æœ€æ¥è¿‘ç›®æ¨™æ—¥æœŸçš„è‚¡åƒ¹
            past_df = df[df['date'] <= target_date]
            
            if past_df.empty or len(past_df) < 10:
                results[period_name] = None
                continue
            
            start_row = past_df.iloc[-1]
            # ä½¿ç”¨å«æ¯èª¿æ•´å¾Œåƒ¹æ ¼è¨ˆç®—å ±é…¬ç‡
            start_price_adj = float(start_row['adj_close_with_div'])
            start_date = start_row['date']
            
            if start_price_adj <= 0:
                results[period_name] = None
                continue
            
            # å¯¦éš›å¹´æ•¸ï¼ˆæ›´ç²¾ç¢ºï¼‰
            actual_days = (current_date - start_date).days
            actual_years = actual_days / 365.25
            
            if actual_years < 0.5:
                results[period_name] = None
                continue
            
            # CAGR è¨ˆç®—ï¼ˆå«æ¯èª¿æ•´å¾Œåƒ¹æ ¼ï¼‰
            cagr = (current_price_adj / start_price_adj) ** (1 / actual_years) - 1
            
            # è¨ˆç®—æœŸé–“å…§çš„é…æ¯çµ±è¨ˆï¼ˆåƒè€ƒç”¨ï¼‰
            period_dividends = {d: amt for d, amt in dividends.items() 
                              if start_date < d <= current_date}
            
            total_dividends_per_share = sum(period_dividends.values())
            
            logger.info(f"{symbol} {period_name}: èµ·å§‹æ—¥={start_date}, èµ·å§‹åƒ¹(å«æ¯èª¿æ•´)={start_price_adj:.2f}, ç¾åƒ¹(å«æ¯èª¿æ•´)={current_price_adj:.2f}, CAGR={cagr*100:.2f}%")
            
            # æª¢æŸ¥æ•¸å€¼æœ‰æ•ˆæ€§
            def safe_pct(val):
                if val is None or math.isnan(val) or math.isinf(val):
                    return None
                return round(val * 100, 2)
            
            results[period_name] = {
                "years": round(actual_years, 1),
                "start_date": start_date.isoformat(),
                "start_price": round(float(start_row['close']), 2),  # é¡¯ç¤ºåŸå§‹èµ·å§‹åƒ¹
                "end_price": round(current_price_display, 2),  # é¡¯ç¤ºåŸå§‹ç¾åƒ¹
                "cagr": safe_pct(cagr),
                "dividend_count": len(period_dividends),
                "total_dividends": round(total_dividends_per_share, 4),
            }
        
        return {
            "success": True,
            "data": {
                "symbol": symbol,
                "name": stock_name,
                "current_price": round(current_price_display, 2),
                "current_date": current_date.isoformat(),
                "returns": results,
                "note": "CAGR å·²åŒ…å«åˆ†å‰²èª¿æ•´åŠé…æ¯å†æŠ•å…¥æ•ˆæœ"
            }
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"è¨ˆç®—å¹´åŒ–å ±é…¬ç‡å¤±æ•— {symbol}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{symbol}/debug-prices", summary="Debug: æŸ¥çœ‹åƒ¹æ ¼èª¿æ•´è³‡è¨Š")
async def debug_prices(
    symbol: str,
    years: int = Query(5, description="æŸ¥è©¢å¹´æ•¸"),
):
    """
    Debug ç”¨ï¼šæŸ¥çœ‹åŸå§‹åƒ¹æ ¼ã€åˆ†å‰²èª¿æ•´ã€é…æ¯è³‡è¨Š
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    from datetime import date, timedelta
    import yfinance as yf
    
    # å°è‚¡ä»£è™Ÿè‡ªå‹•è½‰æ›
    symbol = normalize_tw_symbol(symbol)
    
    # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO
    df = yahoo_finance.get_stock_history(symbol, period=f"{years}y")
    if (df is None or df.empty) and symbol.endswith('.TW'):
        two_symbol = symbol.replace('.TW', '.TWO')
        df = yahoo_finance.get_stock_history(two_symbol, period=f"{years}y")
        if df is not None and not df.empty:
            symbol = two_symbol
    
    try:
        if df is None or df.empty:
            raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
        
        # å–å¾—é…æ¯è¨˜éŒ„
        ticker = yf.Ticker(symbol)
        dividends = ticker.dividends
        div_records = []
        total_div = 0
        if dividends is not None and len(dividends) > 0:
            for date_idx, amount in dividends.items():
                div_date = date_idx.date() if hasattr(date_idx, 'date') else pd.to_datetime(date_idx).date()
                div_records.append({
                    "date": str(div_date),
                    "amount": round(float(amount), 4)
                })
                total_div += float(amount)
        
        # å–å¾—åˆ†å‰²è¨˜éŒ„
        splits = ticker.splits
        split_records = []
        if splits is not None and len(splits) > 0:
            for date_idx, ratio in splits.items():
                split_records.append({
                    "date": str(date_idx.date()),
                    "ratio": float(ratio)
                })
        
        # å–æ¨£åƒ¹æ ¼æ¯”è¼ƒ
        sample_prices = []
        indices = [0]
        for y in range(years, 0, -1):
            target_date = date.today() - timedelta(days=y*365)
            closest = df[df['date'] <= target_date]
            if not closest.empty:
                indices.append(closest.index[-1])
        indices.append(len(df) - 1)
        indices = sorted(set(indices))
        
        for idx in indices:
            if idx < len(df):
                row = df.iloc[idx]
                sample_prices.append({
                    "date": str(row['date']),
                    "close_raw": round(float(row['close']), 2),
                    "close_split_adj": round(float(row['adj_close']), 2),
                })
        
        # è¨ˆç®—å ±é…¬ç‡æ¯”è¼ƒ
        first_raw = float(df.iloc[0]['close'])
        first_adj = float(df.iloc[0]['adj_close'])
        last_raw = float(df.iloc[-1]['close'])
        last_adj = float(df.iloc[-1]['adj_close'])
        
        raw_return = (last_raw / first_raw - 1) * 100 if first_raw > 0 else 0
        split_adj_return = (last_adj / first_adj - 1) * 100 if first_adj > 0 else 0
        
        return {
            "success": True,
            "symbol": symbol,
            "total_records": len(df),
            "date_range": {
                "start": str(df.iloc[0]['date']),
                "end": str(df.iloc[-1]['date'])
            },
            "splits": split_records,
            "dividends": div_records[-10:] if len(div_records) > 10 else div_records,  # æœ€è¿‘ 10 ç­†
            "dividend_count": len(div_records),
            "total_dividends": round(total_div, 4),
            "sample_prices": sample_prices,
            "returns": {
                "raw_return_pct": round(raw_return, 2),
                "split_adj_return_pct": round(split_adj_return, 2),
            },
            "note": "close_raw=åŸå§‹åƒ¹æ ¼, close_split_adj=åˆ†å‰²èª¿æ•´å¾Œ(åœ–è¡¨ç”¨), å¹´åŒ–å ±é…¬å¦å«é…æ¯é‚„åŸ"
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Debug prices å¤±æ•— {symbol}: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/stock_patch.py  â­â­â­
> stock.py ä¿®å¾©è£œä¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
stock.py ä¿®å¾©è£œä¸
è§£æ±º BRK.Bã€FIG ç­‰è‚¡ç¥¨æœå°‹å¤±æ•—å•é¡Œ

å•é¡Œï¼š
1. BRK.B ç­‰å« `.` çš„è‚¡ç¥¨ä»£ç¢¼åœ¨ URL ä¸­è¢«éŒ¯èª¤è§£æ
2. FIG ç­‰æ–° IPO è‚¡ç¥¨å› æ­·å²æ•¸æ“šä¸è¶³è€Œå¤±æ•—
3. Yahoo Finance å°æŸäº›è‚¡ç¥¨ä½¿ç”¨ `-` è€Œé `.`ï¼ˆå¦‚ BRK-Bï¼‰
"""

# ============================================================
# ä¿®å¾© 1: è·¯ç”±å®šç¾©ï¼ˆç´„ç¬¬ 3706 è¡Œï¼‰
# ============================================================

# åŸæœ¬:
# @router.get("/{symbol}", summary="æŸ¥è©¢è‚¡ç¥¨")

# æ”¹ç‚º:
# @router.get("/{symbol:path}", summary="æŸ¥è©¢è‚¡ç¥¨")


# ============================================================
# ä¿®å¾© 2: æ–°å¢è‚¡ç¥¨ä»£ç¢¼æ¨™æº–åŒ–å‡½æ•¸ï¼ˆåœ¨ normalize_tw_symbol å¾Œé¢åŠ ï¼‰
# ============================================================

def normalize_us_symbol(symbol: str) -> str:
    """
    æ¨™æº–åŒ–ç¾è‚¡ä»£ç¢¼
    - BRK.B -> å˜—è©¦ BRK.B å’Œ BRK-B
    - è™•ç†å…¶ä»–ç‰¹æ®Šæ ¼å¼
    """
    symbol = symbol.strip().upper()
    return symbol


def get_symbol_variants(symbol: str) -> list:
    """
    ç”¢ç”Ÿè‚¡ç¥¨ä»£ç¢¼çš„è®Šé«”åˆ—è¡¨ï¼Œç”¨æ–¼å˜—è©¦ä¸åŒæ ¼å¼
    ä¾‹å¦‚ BRK.B -> ["BRK.B", "BRK-B"]
    """
    variants = [symbol]
    
    # å¦‚æœåŒ…å« `.`ï¼Œä¹Ÿå˜—è©¦ `-` æ ¼å¼
    if '.' in symbol and not symbol.endswith('.TW') and not symbol.endswith('.TWO'):
        variants.append(symbol.replace('.', '-'))
    
    # å¦‚æœåŒ…å« `-`ï¼Œä¹Ÿå˜—è©¦ `.` æ ¼å¼
    if '-' in symbol:
        variants.append(symbol.replace('-', '.'))
    
    return variants


# ============================================================
# ä¿®å¾© 3: ä¿®æ”¹ get_stock_analysis å‡½æ•¸
# ============================================================

# æ‰¾åˆ°é€™æ®µä»£ç¢¼ï¼ˆç´„ç¬¬ 3722-3741 è¡Œï¼‰:
"""
åŸå§‹ä»£ç¢¼:
    try:
        # å–å¾—è‚¡ç¥¨è³‡æ–™ (æŠ“å– 10 å¹´ä»¥è¨ˆç®—é•·æœŸ CAGR)
        logger.info(f"æ­£åœ¨å¾ Yahoo Finance å–å¾— {symbol} è³‡æ–™...")
        df = yahoo_finance.get_stock_history(symbol, period="10y")
        
        # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO (ä¸Šæ«ƒè‚¡ç¥¨)
        if (df is None or df.empty) and symbol.endswith('.TW'):
            ...
        
        if df is None or df.empty:
            logger.warning(f"æ‰¾ä¸åˆ°è‚¡ç¥¨è³‡æ–™: {original_symbol}")
            raise HTTPException(
                status_code=404,
                detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦ä¸Šå¸‚ .TW å’Œä¸Šæ«ƒ .TWOï¼‰"
            )
"""

# æ›¿æ›ç‚º:
"""
ä¿®å¾©å¾Œä»£ç¢¼:
    try:
        # å–å¾—è‚¡ç¥¨è³‡æ–™
        logger.info(f"æ­£åœ¨å¾ Yahoo Finance å–å¾— {symbol} è³‡æ–™...")
        
        df = None
        used_period = None
        actual_symbol = symbol
        
        # ç”¢ç”Ÿè‚¡ç¥¨ä»£ç¢¼è®Šé«”ï¼ˆè™•ç† BRK.B / BRK-B ç­‰æƒ…æ³ï¼‰
        symbol_variants = get_symbol_variants(symbol)
        
        # å˜—è©¦ä¸åŒæœŸé–“ï¼ˆè§£æ±ºæ–°è‚¡æ­·å²æ•¸æ“šä¸è¶³å•é¡Œï¼‰
        periods = ["10y", "5y", "2y", "1y", "6mo", "3mo"]
        
        for try_symbol in symbol_variants:
            if df is not None and not df.empty:
                break
                
            for period in periods:
                logger.info(f"å˜—è©¦ {try_symbol} æœŸé–“ {period}...")
                df = yahoo_finance.get_stock_history(try_symbol, period=period)
                
                if df is not None and len(df) >= 20:
                    used_period = period
                    actual_symbol = try_symbol
                    logger.info(f"æˆåŠŸ: {try_symbol} ä½¿ç”¨ {period}ï¼Œå…± {len(df)} ç­†")
                    break
        
        # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO (ä¸Šæ«ƒè‚¡ç¥¨)
        if (df is None or df.empty) and symbol.endswith('.TW'):
            two_symbol = symbol.replace('.TW', '.TWO')
            logger.info(f"{symbol} æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
            for period in periods:
                df = yahoo_finance.get_stock_history(two_symbol, period=period)
                if df is not None and len(df) >= 20:
                    actual_symbol = two_symbol
                    used_period = period
                    logger.info(f"æˆåŠŸæ‰¾åˆ°ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
                    break
        
        if df is None or df.empty:
            # æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
            tried = ", ".join(symbol_variants)
            logger.warning(f"æ‰¾ä¸åˆ°è‚¡ç¥¨è³‡æ–™: {original_symbol} (å·²å˜—è©¦: {tried})")
            raise HTTPException(
                status_code=404,
                detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦: {tried}ï¼‰"
            )
        
        # ä½¿ç”¨å¯¦éš›æ‰¾åˆ°çš„ symbol
        symbol = actual_symbol
        logger.info(f"å–å¾— {len(df)} ç­†è³‡æ–™ï¼ˆ{used_period}ï¼‰ï¼Œæ­£åœ¨è¨ˆç®—æŠ€è¡“æŒ‡æ¨™...")
"""


# ============================================================
# å®Œæ•´çš„ä¿®å¾©å¾Œå‡½æ•¸ï¼ˆå¯ç›´æ¥è¤‡è£½æ›¿æ›ï¼‰
# ============================================================

@router.get("/{symbol:path}", summary="æŸ¥è©¢è‚¡ç¥¨")
async def get_stock_analysis(
    symbol: str,
    refresh: bool = Query(False, description="æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™"),
):
    """
    æŸ¥è©¢å–®ä¸€è‚¡ç¥¨çš„æŠ€è¡“åˆ†æå ±å‘Š
    æ”¯æ´: ç¾è‚¡(AAPL)ã€å°è‚¡(2330)ã€ç‰¹æ®Šæ ¼å¼(BRK.B, BRK-B)
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.indicator_service import indicator_service
    
    # å°è‚¡ä»£è™Ÿè‡ªå‹•è½‰æ›
    symbol = normalize_tw_symbol(symbol)
    original_symbol = symbol
    logger.info(f"é–‹å§‹æŸ¥è©¢è‚¡ç¥¨: {symbol}")
    
    try:
        df = None
        used_period = None
        actual_symbol = symbol
        
        # ç”¢ç”Ÿè‚¡ç¥¨ä»£ç¢¼è®Šé«”ï¼ˆè™•ç† BRK.B / BRK-Bï¼‰
        symbol_variants = [symbol]
        if '.' in symbol and not symbol.endswith('.TW') and not symbol.endswith('.TWO'):
            symbol_variants.append(symbol.replace('.', '-'))
        if '-' in symbol:
            symbol_variants.append(symbol.replace('-', '.'))
        
        # å˜—è©¦ä¸åŒæœŸé–“
        periods = ["10y", "5y", "2y", "1y", "6mo", "3mo"]
        
        for try_symbol in symbol_variants:
            if df is not None and len(df) >= 20:
                break
            for period in periods:
                logger.info(f"å˜—è©¦ {try_symbol} æœŸé–“ {period}...")
                df = yahoo_finance.get_stock_history(try_symbol, period=period)
                if df is not None and len(df) >= 20:
                    used_period = period
                    actual_symbol = try_symbol
                    logger.info(f"æˆåŠŸ: {try_symbol} ä½¿ç”¨ {period}ï¼Œå…± {len(df)} ç­†")
                    break
        
        # å°è‚¡ .TW -> .TWO å˜—è©¦
        if (df is None or len(df) < 20) and symbol.endswith('.TW'):
            two_symbol = symbol.replace('.TW', '.TWO')
            for period in periods:
                df = yahoo_finance.get_stock_history(two_symbol, period=period)
                if df is not None and len(df) >= 20:
                    actual_symbol = two_symbol
                    used_period = period
                    break
        
        if df is None or len(df) < 20:
            tried = ", ".join(set(symbol_variants))
            raise HTTPException(
                status_code=404,
                detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦: {tried}ï¼‰"
            )
        
        symbol = actual_symbol
        logger.info(f"å–å¾— {len(df)} ç­†è³‡æ–™ï¼Œæ­£åœ¨è¨ˆç®—æŠ€è¡“æŒ‡æ¨™...")
        
        # ... å¾ŒçºŒä»£ç¢¼ä¿æŒä¸è®Š ...
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/watchlist.py  â­â­â­
> è¿½è¹¤æ¸…å–® API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–® API è·¯ç”±
åŒ…å«åƒ¹æ ¼å¿«å–åŠŸèƒ½
"""
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import List
import logging

from app.database import get_async_session
from app.services.auth_service import AuthService
from app.services.watchlist_service import WatchlistService
from app.schemas.schemas import (
    WatchlistAdd,
    WatchlistUpdate,
    WatchlistItem,
    WatchlistResponse,
    WatchlistListResponse,
    WatchlistOverviewResponse,
    ResponseBase,
)
from app.models.user import User
from app.models.watchlist import Watchlist
from app.models.price_cache import StockPriceCache

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/watchlist", tags=["è¿½è¹¤æ¸…å–®"])


async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
) -> User:
    """ä¾è³´æ³¨å…¥ï¼šå–å¾—ç•¶å‰ç”¨æˆ¶"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        logger.warning("Watchlist API: æœªæä¾›èªè­‰ Token")
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        logger.warning("Watchlist API: Token é©—è­‰å¤±æ•—")
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )
    
    logger.debug(f"Watchlist API: é©—è­‰æˆåŠŸ user_id={user.id}, line_id={user.line_user_id}")
    return user


# ============================================================
# ğŸ†• åƒ¹æ ¼å¿«å– API
# ============================================================

@router.get("/with-prices", summary="è¿½è¹¤æ¸…å–®ï¼ˆå«å³æ™‚åƒ¹æ ¼ï¼‰")
async def get_watchlist_with_prices(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶è¿½è¹¤æ¸…å–®ï¼ŒåŒ…å«å³æ™‚åƒ¹æ ¼ï¼ˆå¾å¿«å–è®€å–ï¼‰
    
    - åƒ¹æ ¼ä¾†è‡ª stock_price_cache è¡¨
    - æ¯ 10 åˆ†é˜ç”±æ’ç¨‹æ›´æ–°
    - å›æ‡‰æ™‚é–“ï¼šæ¯«ç§’ç´š
    """
    logger.info(f"API: è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼) - user_id={user.id}")
    
    try:
        # 1. å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
        stmt = (
            select(Watchlist)
            .where(Watchlist.user_id == user.id)
            .order_by(Watchlist.added_at.desc())
        )
        result = await db.execute(stmt)
        watchlist_items = list(result.scalars().all())
        
        if not watchlist_items:
            return {
                "success": True,
                "data": [],
                "total": 0,
            }
        
        # 2. å–å¾—æ‰€æœ‰ symbol
        symbols = [item.symbol for item in watchlist_items]
        
        # 3. å¾å¿«å–æ‰¹æ¬¡å–å¾—åƒ¹æ ¼
        cache_stmt = select(StockPriceCache).where(
            StockPriceCache.symbol.in_(symbols)
        )
        cache_result = await db.execute(cache_stmt)
        cached_prices = {r.symbol: r for r in cache_result.scalars().all()}
        
        # 4. çµ„åˆè³‡æ–™
        data = []
        for item in watchlist_items:
            cache = cached_prices.get(item.symbol)
            
            data.append({
                "id": item.id,
                "symbol": item.symbol,
                "asset_type": item.asset_type,
                "note": item.note,
                "added_at": item.added_at.isoformat() if item.added_at else None,
                # åƒ¹æ ¼è³‡è¨Šï¼ˆå¾å¿«å–ï¼‰
                "name": cache.name if cache else None,
                "price": float(cache.price) if cache and cache.price else None,
                "change": float(cache.change) if cache and cache.change else None,
                "change_pct": float(cache.change_pct) if cache and cache.change_pct else None,
                "price_updated_at": cache.updated_at.isoformat() if cache and cache.updated_at else None,
            })
        
        return {
            "success": True,
            "data": data,
            "total": len(data),
        }
        
    except Exception as e:
        logger.error(f"å–å¾—è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼)å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/cache-status", summary="å¿«å–ç‹€æ…‹")
async def get_cache_status(
    db: AsyncSession = Depends(get_async_session),
):
    """æŸ¥çœ‹åƒ¹æ ¼å¿«å–ç‹€æ…‹"""
    try:
        from app.services.price_cache_service import get_market_status
        
        stmt = select(StockPriceCache)
        result = await db.execute(stmt)
        all_cache = list(result.scalars().all())
        
        if not all_cache:
            return {
                "success": True,
                "total_cached": 0,
                "message": "å¿«å–ç‚ºç©ºï¼Œè«‹ç­‰å¾…æ’ç¨‹æ›´æ–°",
                "market_status": get_market_status(),
            }
        
        updates = [c.updated_at for c in all_cache if c.updated_at]
        tw_stocks = [c for c in all_cache if c.symbol.endswith(('.TW', '.TWO'))]
        us_stocks = [c for c in all_cache if c.asset_type == 'stock' and not c.symbol.endswith(('.TW', '.TWO'))]
        crypto = [c for c in all_cache if c.asset_type == 'crypto']
        
        return {
            "success": True,
            "total_cached": len(all_cache),
            "tw_stocks": len(tw_stocks),
            "us_stocks": len(us_stocks),
            "crypto": len(crypto),
            "oldest_update": min(updates).isoformat() if updates else None,
            "newest_update": max(updates).isoformat() if updates else None,
            "market_status": get_market_status(),
        }
        
    except Exception as e:
        logger.error(f"æŸ¥è©¢å¿«å–ç‹€æ…‹å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# åŸæœ‰çš„ç«¯é»
# ============================================================

@router.get("", summary="å–å¾—è¿½è¹¤æ¸…å–®", response_model=WatchlistListResponse)
async def get_watchlist(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
    """
    logger.info(f"API: å–å¾—è¿½è¹¤æ¸…å–® - user_id={user.id}, line_id={user.line_user_id}")
    
    service = WatchlistService(db)
    items = await service.get_watchlist(user.id)
    
    return WatchlistListResponse(
        success=True,
        data=[WatchlistItem.model_validate(item) for item in items],
        total=len(items),
    )


@router.post("", summary="æ–°å¢è¿½è¹¤", response_model=WatchlistResponse)
async def add_to_watchlist(
    data: WatchlistAdd,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ–°å¢æ¨™çš„åˆ°è¿½è¹¤æ¸…å–®
    
    - **symbol**: è‚¡ç¥¨ä»£è™Ÿ (å¦‚ AAPL) æˆ–åŠ å¯†è²¨å¹£ (å¦‚ BTC)
    - **note**: è‡ªè¨‚å‚™è¨»ï¼ˆé¸å¡«ï¼‰
    """
    logger.info(f"API: æ–°å¢è¿½è¹¤ - user_id={user.id}, line_id={user.line_user_id}, symbol={data.symbol}")
    
    service = WatchlistService(db)
    result = await service.add_to_watchlist(
        user_id=user.id,
        symbol=data.symbol,
        note=data.note,
    )
    
    if not result["success"]:
        raise HTTPException(
            status_code=400,
            detail=result["message"]
        )
    
    return WatchlistResponse(
        success=True,
        message=result["message"],
        data=WatchlistItem.model_validate(result["watchlist"]),
    )


@router.delete("/{symbol}", summary="ç§»é™¤è¿½è¹¤", response_model=ResponseBase)
async def remove_from_watchlist(
    symbol: str,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å¾è¿½è¹¤æ¸…å–®ç§»é™¤æ¨™çš„
    """
    logger.info(f"API: ç§»é™¤è¿½è¹¤ - user_id={user.id}, line_id={user.line_user_id}, symbol={symbol}")
    
    service = WatchlistService(db)
    result = await service.remove_from_watchlist(
        user_id=user.id,
        symbol=symbol,
    )
    
    if not result["success"]:
        raise HTTPException(
            status_code=404,
            detail=result["message"]
        )
    
    return ResponseBase(
        success=True,
        message=result["message"],
    )


@router.put("/{symbol}", summary="æ›´æ–°å‚™è¨»", response_model=ResponseBase)
async def update_watchlist_note(
    symbol: str,
    data: WatchlistUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°è¿½è¹¤æ¨™çš„çš„å‚™è¨»
    """
    logger.info(f"API: æ›´æ–°å‚™è¨» - user_id={user.id}, symbol={symbol}")
    
    service = WatchlistService(db)
    result = await service.update_note(
        user_id=user.id,
        symbol=symbol,
        note=data.note,
    )
    
    if not result["success"]:
        raise HTTPException(
            status_code=404,
            detail=result["message"]
        )
    
    return ResponseBase(
        success=True,
        message=result["message"],
    )


@router.get("/overview", summary="è¿½è¹¤æ¸…å–®ç¸½è¦½")
async def get_watchlist_overview(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—è¿½è¹¤æ¸…å–®ç¸½è¦½
    
    åŒ…å«æ‰€æœ‰è¿½è¹¤æ¨™çš„çš„åŸºæœ¬è³‡è¨Š
    """
    logger.info(f"API: è¿½è¹¤æ¸…å–®ç¸½è¦½ - user_id={user.id}, line_id={user.line_user_id}")
    
    service = WatchlistService(db)
    items = await service.get_watchlist(user.id)
    
    return {
        "success": True,
        "data": [
            {
                "id": item.id,
                "symbol": item.symbol,
                "asset_type": item.asset_type,
                "note": item.note,
                "added_at": item.added_at.isoformat() if item.added_at else None,
            }
            for item in items
        ],
        "total": len(items),
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/watchlist_cache_api.py  â­â­â­
> è¿½è¹¤æ¸…å–® API - å«åƒ¹æ ¼å¿«å–ç‰ˆæœ¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–® API - å«åƒ¹æ ¼å¿«å–ç‰ˆæœ¬

============================================================
æ³¨æ„ï¼šé€™å€‹æª”æ¡ˆæ˜¯ç¯„ä¾‹ç¨‹å¼ç¢¼
è«‹å°‡ä¸‹æ–¹çš„ç«¯é»æ•´åˆåˆ°ä½ ç¾æœ‰çš„ app/routers/watchlist.py
============================================================

æ–°å¢ç«¯é»ï¼š
- GET /api/watchlist/with-prices  å¾å¿«å–å–å¾—è¿½è¹¤æ¸…å–®ï¼ˆå«å³æ™‚åƒ¹æ ¼ï¼‰
- POST /api/watchlist/refresh-cache  æ‰‹å‹•è§¸ç™¼å¿«å–æ›´æ–°
- GET /api/watchlist/cache-status  æŸ¥çœ‹å¿«å–ç‹€æ…‹
"""
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import Session
from sqlalchemy import select
from typing import List, Dict, Any
import logging

# ============================================================
# ä»¥ä¸‹ import éœ€è¦æ ¹æ“šä½ çš„å°ˆæ¡ˆçµæ§‹èª¿æ•´
# ============================================================
from app.database import get_async_session, get_db
from app.models.user import User
from app.models.watchlist import Watchlist
from app.models.price_cache import StockPriceCache  # æ–°å¢çš„ model
from app.services.price_cache_service import PriceCacheService  # æ–°å¢çš„ service

logger = logging.getLogger(__name__)


# ============================================================
# æ•´åˆåˆ°ç¾æœ‰çš„ watchlist.py
# 
# 1. åŠ å…¥ä¸Šæ–¹çš„ import
# 2. è¤‡è£½ä¸‹æ–¹ä¸‰å€‹ç«¯é»åˆ° watchlist.py
# 3. å°‡ get_current_user æ›¿æ›æˆä½ ç¾æœ‰çš„é©—è­‰å‡½æ•¸
# ============================================================


# ---------- ç«¯é» 1: è¿½è¹¤æ¸…å–®ï¼ˆå«åƒ¹æ ¼ï¼‰ ----------

"""
@router.get("/with-prices", summary="è¿½è¹¤æ¸…å–®ï¼ˆå«å³æ™‚åƒ¹æ ¼ï¼‰")
async def get_watchlist_with_prices(
    user: User = Depends(get_current_user),  # ç”¨ä½ ç¾æœ‰çš„é©—è­‰å‡½æ•¸
    db: AsyncSession = Depends(get_async_session),
):
    '''
    å–å¾—ç”¨æˆ¶è¿½è¹¤æ¸…å–®ï¼ŒåŒ…å«å³æ™‚åƒ¹æ ¼ï¼ˆå¾å¿«å–è®€å–ï¼‰
    
    - åƒ¹æ ¼ä¾†è‡ª stock_price_cache è¡¨
    - æ¯ 10 åˆ†é˜ç”±æ’ç¨‹æ›´æ–°
    - å›æ‡‰æ™‚é–“ï¼šæ¯«ç§’ç´š
    '''
    logger.info(f"API: è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼) - user_id={user.id}")
    
    try:
        # 1. å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
        stmt = (
            select(Watchlist)
            .where(Watchlist.user_id == user.id)
            .order_by(Watchlist.added_at.desc())
        )
        result = await db.execute(stmt)
        watchlist_items = list(result.scalars().all())
        
        if not watchlist_items:
            return {
                "success": True,
                "data": [],
                "total": 0,
                "cache_info": None,
            }
        
        # 2. å–å¾—æ‰€æœ‰ symbol
        symbols = [item.symbol for item in watchlist_items]
        
        # 3. å¾å¿«å–æ‰¹æ¬¡å–å¾—åƒ¹æ ¼
        cache_stmt = select(StockPriceCache).where(
            StockPriceCache.symbol.in_(symbols)
        )
        cache_result = await db.execute(cache_stmt)
        cached_prices = {r.symbol: r for r in cache_result.scalars().all()}
        
        # 4. çµ„åˆè³‡æ–™
        data = []
        oldest_update = None
        
        for item in watchlist_items:
            cache = cached_prices.get(item.symbol)
            
            item_data = {
                "id": item.id,
                "symbol": item.symbol,
                "asset_type": item.asset_type,
                "note": item.note,
                "added_at": item.added_at.isoformat() if item.added_at else None,
                # åƒ¹æ ¼è³‡è¨Šï¼ˆå¾å¿«å–ï¼‰
                "name": cache.name if cache else None,
                "price": float(cache.price) if cache and cache.price else None,
                "change": float(cache.change) if cache and cache.change else None,
                "change_pct": float(cache.change_pct) if cache and cache.change_pct else None,
                "volume": cache.volume if cache else None,
                "price_updated_at": cache.updated_at.isoformat() if cache and cache.updated_at else None,
            }
            data.append(item_data)
            
            # è¨˜éŒ„æœ€èˆŠçš„æ›´æ–°æ™‚é–“
            if cache and cache.updated_at:
                if oldest_update is None or cache.updated_at < oldest_update:
                    oldest_update = cache.updated_at
        
        return {
            "success": True,
            "data": data,
            "total": len(data),
            "cache_info": {
                "oldest_update": oldest_update.isoformat() if oldest_update else None,
                "symbols_with_price": len(cached_prices),
                "symbols_without_price": len(symbols) - len(cached_prices),
            },
        }
        
    except Exception as e:
        logger.error(f"å–å¾—è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼)å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))
"""


# ---------- ç«¯é» 2: æ‰‹å‹•æ›´æ–°å¿«å– ----------

"""
@router.post("/refresh-cache", summary="æ‰‹å‹•æ›´æ–°åƒ¹æ ¼å¿«å–")
async def refresh_price_cache(
    user: User = Depends(get_current_user),  # ç”¨ä½ ç¾æœ‰çš„é©—è­‰å‡½æ•¸
    db: Session = Depends(get_db),  # ä½¿ç”¨åŒæ­¥ session
):
    '''
    æ‰‹å‹•è§¸ç™¼åƒ¹æ ¼å¿«å–æ›´æ–°
    
    æ³¨æ„ï¼šé€™æœƒå° Yahoo Finance ç™¼é€è«‹æ±‚ï¼Œè«‹å‹¿é »ç¹å‘¼å«
    '''
    # å¯é¸ï¼šåŠ ä¸Šç®¡ç†å“¡æ¬Šé™æª¢æŸ¥
    # if not user.is_admin:
    #     raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å“¡æ¬Šé™")
    
    logger.info(f"æ‰‹å‹•æ›´æ–°åƒ¹æ ¼å¿«å– - by user_id={user.id}")
    
    try:
        service = PriceCacheService(db)
        result = service.update_all_tracked_prices(force=True)
        
        return {
            "success": True,
            "message": f"å·²æ›´æ–° {result['total_updated']} ç­†åƒ¹æ ¼",
            "detail": result,
        }
        
    except Exception as e:
        logger.error(f"æ‰‹å‹•æ›´æ–°åƒ¹æ ¼å¿«å–å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))
"""


# ---------- ç«¯é» 3: å¿«å–ç‹€æ…‹ï¼ˆå…¬é–‹ï¼‰ ----------

"""
@router.get("/cache-status", summary="å¿«å–ç‹€æ…‹")
async def get_cache_status(
    db: AsyncSession = Depends(get_async_session),
):
    '''
    æŸ¥çœ‹åƒ¹æ ¼å¿«å–ç‹€æ…‹ï¼ˆå…¬é–‹ APIï¼Œç”¨æ–¼ç›£æ§ï¼‰
    '''
    from app.services.price_cache_service import get_market_status
    
    try:
        stmt = select(StockPriceCache)
        result = await db.execute(stmt)
        all_cache = list(result.scalars().all())
        
        if not all_cache:
            return {
                "success": True,
                "total_cached": 0,
                "market_status": get_market_status(),
            }
        
        tw_stocks = [c for c in all_cache if c.symbol.endswith(('.TW', '.TWO'))]
        us_stocks = [c for c in all_cache if c.asset_type == 'stock' and not c.symbol.endswith(('.TW', '.TWO'))]
        crypto = [c for c in all_cache if c.asset_type == "crypto"]
        
        updates = [c.updated_at for c in all_cache if c.updated_at]
        
        return {
            "success": True,
            "total_cached": len(all_cache),
            "tw_stocks": len(tw_stocks),
            "us_stocks": len(us_stocks),
            "crypto": len(crypto),
            "oldest_update": min(updates).isoformat() if updates else None,
            "newest_update": max(updates).isoformat() if updates else None,
            "market_status": get_market_status(),
        }
        
    except Exception as e:
        logger.error(f"æŸ¥è©¢å¿«å–ç‹€æ…‹å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))
"""

```

======================================================================
## ğŸ“¦ è³‡æ–™æ¨¡å‹
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/database.py  â­â­
> è³‡æ–™åº«é€£ç·šèˆ‡ Session ç®¡ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è³‡æ–™åº«é€£ç·šèˆ‡ Session ç®¡ç†
æ”¯æ´ SQLite (é–‹ç™¼) å’Œ PostgreSQL (ç”Ÿç”¢)
"""
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.orm import declarative_base
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import NullPool

from app.config import settings


def get_async_url(url: str) -> str:
    """å°‡ä¸€èˆ¬çš„è³‡æ–™åº« URL è½‰æ›ç‚º async æ ¼å¼"""
    if url.startswith("sqlite:///") and "+aiosqlite" not in url:
        return url.replace("sqlite:///", "sqlite+aiosqlite:///")
    elif url.startswith("postgresql://") and "+asyncpg" not in url:
        return url.replace("postgresql://", "postgresql+asyncpg://")
    elif url.startswith("postgres://"):
        # Railway ä½¿ç”¨ postgres:// ä½† SQLAlchemy éœ€è¦ postgresql://
        return url.replace("postgres://", "postgresql+asyncpg://")
    return url


def get_sync_url(url: str) -> str:
    """ç¢ºä¿æ˜¯åŒæ­¥æ ¼å¼çš„ URL"""
    url = url.replace("+aiosqlite", "").replace("+asyncpg", "")
    # ä¿®æ­£ Railway çš„ postgres:// æ ¼å¼
    if url.startswith("postgres://"):
        url = url.replace("postgres://", "postgresql://")
    return url


def is_postgres(url: str) -> bool:
    """æª¢æŸ¥æ˜¯å¦ç‚º PostgreSQL"""
    return "postgresql" in url or "postgres" in url


# å–å¾—è³‡æ–™åº« URL
database_url = settings.DATABASE_URL

# éåŒæ­¥å¼•æ“ (FastAPI ç”¨)
async_database_url = get_async_url(database_url)

# PostgreSQL éœ€è¦ç‰¹åˆ¥çš„é€£ç·šæ± è¨­å®š
if is_postgres(database_url):
    async_engine = create_async_engine(
        async_database_url,
        echo=settings.DEBUG,
        poolclass=NullPool,  # Railway å»ºè­°ä½¿ç”¨ NullPool
    )
else:
    async_engine = create_async_engine(
        async_database_url,
        echo=settings.DEBUG,
    )

# éåŒæ­¥ Session
AsyncSessionLocal = async_sessionmaker(
    bind=async_engine,
    class_=AsyncSession,
    expire_on_commit=False,
)

# åŒæ­¥å¼•æ“ (CLI ç”¨)
sync_database_url = get_sync_url(database_url)

if is_postgres(database_url):
    sync_engine = create_engine(
        sync_database_url,
        echo=settings.DEBUG,
        poolclass=NullPool,
    )
else:
    sync_engine = create_engine(
        sync_database_url,
        echo=settings.DEBUG,
    )

# åŒæ­¥ Session
SyncSessionLocal = sessionmaker(
    bind=sync_engine,
    autocommit=False,
    autoflush=False,
)

# ORM Base
Base = declarative_base()


async def get_async_session():
    """FastAPI ä¾è³´æ³¨å…¥ç”¨"""
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()


def get_sync_session():
    """CLI ç”¨åŒæ­¥ Session"""
    session = SyncSessionLocal()
    try:
        return session
    except Exception:
        session.close()
        raise


async def init_db():
    """åˆå§‹åŒ–è³‡æ–™åº«ï¼ˆå»ºç«‹æ‰€æœ‰è¡¨æ ¼ï¼‰"""
    async with async_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


def init_db_sync():
    """åŒæ­¥åˆå§‹åŒ–è³‡æ–™åº«"""
    Base.metadata.create_all(bind=sync_engine)


# FastAPI ä¾è³´æ³¨å…¥ç”¨ï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼Œç”¨æ–¼æŸäº› APIï¼‰
def get_db():
    """FastAPI ä¾è³´æ³¨å…¥ç”¨ï¼ˆåŒæ­¥ Sessionï¼‰"""
    db = SyncSessionLocal()
    try:
        yield db
    finally:
        db.close()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/__init__.py  â­â­
> è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è³‡æ–™æ¨¡å‹
"""
from app.models.stock_price import StockPrice
from app.models.crypto_price import CryptoPrice
from app.models.market_sentiment import MarketSentiment
from app.models.user import User, LoginLog, TokenBlacklist, SystemConfig
from app.models.watchlist import Watchlist
from app.models.user_settings import (
    UserIndicatorSettings,
    UserAlertSettings,
    UserIndicatorParams,
)
from app.models.notification import Notification
from app.models.index_price import IndexPrice, INDEX_SYMBOLS
from app.models.dividend_history import DividendHistory
from app.models.comparison import Comparison
from app.models.price_cache import StockPriceCache  # ğŸ†• åƒ¹æ ¼å¿«å–

__all__ = [
    "StockPrice",
    "CryptoPrice", 
    "MarketSentiment",
    "User",
    "LoginLog",
    "TokenBlacklist",
    "SystemConfig",
    "Watchlist",
    "UserIndicatorSettings",
    "UserAlertSettings",
    "UserIndicatorParams",
    "Notification",
    "IndexPrice",
    "INDEX_SYMBOLS",
    "DividendHistory",
    "Comparison",
    "StockPriceCache",  # ğŸ†• åƒ¹æ ¼å¿«å–
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/comparison.py  â­â­
> å ±é…¬ç‡æ¯”è¼ƒçµ„åˆ Model
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å ±é…¬ç‡æ¯”è¼ƒçµ„åˆ Model
å„²å­˜ç”¨æˆ¶çš„è‡ªè¨‚æ¯”è¼ƒçµ„åˆ
"""
from datetime import datetime
from typing import List, Optional
import json

from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship

from app.database import Base


class Comparison(Base):
    """ç”¨æˆ¶å„²å­˜çš„æ¯”è¼ƒçµ„åˆ"""
    __tablename__ = "comparisons"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    name = Column(String(100), nullable=False)  # çµ„åˆåç¨±
    symbols_json = Column(Text, nullable=False)  # JSON æ ¼å¼å„²å­˜ ["AAPL","MSFT"]
    benchmark = Column(String(20), nullable=True, default="^GSPC")  # åŸºæº–æŒ‡æ•¸
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # é—œè¯
    user = relationship("User", backref="comparisons")
    
    @property
    def symbols(self) -> List[str]:
        """å–å¾—æ¨™çš„åˆ—è¡¨"""
        try:
            return json.loads(self.symbols_json)
        except (json.JSONDecodeError, TypeError):
            return []
    
    @symbols.setter
    def symbols(self, value: List[str]):
        """è¨­å®šæ¨™çš„åˆ—è¡¨"""
        self.symbols_json = json.dumps(value)
    
    def to_dict(self) -> dict:
        """è½‰æ›ç‚ºå­—å…¸"""
        return {
            "id": self.id,
            "user_id": self.user_id,
            "name": self.name,
            "symbols": self.symbols,
            "benchmark": self.benchmark,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
    
    def __repr__(self):
        return f"<Comparison(id={self.id}, name='{self.name}', symbols={self.symbols})>"
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/crypto_price.py  â­â­
> åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class CryptoPrice(Base):
    """åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²"""
    
    __tablename__ = "crypto_prices"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)  # BTC, ETH
    date = Column(Date, nullable=False, index=True)
    price = Column(Numeric(18, 8))  # USD åƒ¹æ ¼
    volume_24h = Column(Numeric(18, 2))  # 24 å°æ™‚æˆäº¤é‡
    market_cap = Column(Numeric(18, 2))  # å¸‚å€¼
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_crypto_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<CryptoPrice(symbol={self.symbol}, date={self.date}, price={self.price})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "date": self.date.isoformat() if self.date else None,
            "price": float(self.price) if self.price else None,
            "volume_24h": float(self.volume_24h) if self.volume_24h else None,
            "market_cap": float(self.market_cap) if self.market_cap else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/dividend_history.py  â­â­
> è‚¡ç¥¨é…æ¯æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨é…æ¯æ­·å²è³‡æ–™æ¨¡å‹
ç”¨æ–¼è¨ˆç®—å«æ¯å¹´åŒ–å ±é…¬ç‡
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class DividendHistory(Base):
    """è‚¡ç¥¨é…æ¯æ­·å²"""
    
    __tablename__ = "dividend_history"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)
    date = Column(Date, nullable=False, index=True)  # é™¤æ¯æ—¥
    amount = Column(Numeric(10, 4), nullable=False)  # æ¯è‚¡é…æ¯é‡‘é¡
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_dividend_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<DividendHistory(symbol={self.symbol}, date={self.date}, amount={self.amount})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "date": self.date.isoformat() if self.date else None,
            "amount": float(self.amount) if self.amount else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/index_price.py  â­â­
> å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
æ”¯æ´ S&P 500, é“ç“Š, ç´æ–¯é”å…‹, å°è‚¡åŠ æ¬Š
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, BigInteger, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


# æŒ‡æ•¸ä»£è™Ÿå°ç…§
INDEX_SYMBOLS = {
    "^GSPC": {"name": "S&P 500", "name_zh": "æ¨™æ™®500"},
    "^DJI": {"name": "Dow Jones", "name_zh": "é“ç“Šå·¥æ¥­"},
    "^IXIC": {"name": "NASDAQ", "name_zh": "ç´æ–¯é”å…‹"},
    "^TWII": {"name": "TAIEX", "name_zh": "å°è‚¡åŠ æ¬Š"},
}


class IndexPrice(Base):
    """å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²"""
    
    __tablename__ = "index_prices"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)  # ^GSPC, ^DJI, ^IXIC
    name = Column(String(50))  # S&P 500, Dow Jones, NASDAQ
    date = Column(Date, nullable=False, index=True)
    open = Column(Numeric(12, 2))
    high = Column(Numeric(12, 2))
    low = Column(Numeric(12, 2))
    close = Column(Numeric(12, 2))
    volume = Column(BigInteger)
    change = Column(Numeric(10, 2))  # æ¼²è·Œé»æ•¸
    change_pct = Column(Numeric(6, 2))  # æ¼²è·Œå¹… %
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_index_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<IndexPrice(symbol={self.symbol}, date={self.date}, close={self.close})>"
    
    @property
    def name_zh(self) -> str:
        """å–å¾—ä¸­æ–‡åç¨±"""
        info = INDEX_SYMBOLS.get(self.symbol, {})
        return info.get("name_zh", self.name or self.symbol)
    
    def to_dict(self):
        def safe_float(val):
            """å®‰å…¨è½‰æ› floatï¼Œè™•ç† NaN å’Œ Infinity"""
            if val is None:
                return None
            try:
                f = float(val)
                # æª¢æŸ¥ NaN å’Œ Infinity
                import math
                if math.isnan(f) or math.isinf(f):
                    return None
                return f
            except (ValueError, TypeError):
                return None
        
        return {
            "id": self.id,
            "symbol": self.symbol,
            "name": self.name,
            "name_zh": self.name_zh,
            "date": self.date.isoformat() if self.date else None,
            "open": safe_float(self.open),
            "high": safe_float(self.high),
            "low": safe_float(self.low),
            "close": safe_float(self.close),
            "volume": self.volume,
            "change": safe_float(self.change),
            "change_pct": safe_float(self.change_pct),
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/market_sentiment.py  â­â­
> å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class MarketSentiment(Base):
    """å¸‚å ´æƒ…ç·’æŒ‡æ•¸"""
    
    __tablename__ = "market_sentiment"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    date = Column(Date, nullable=False, index=True)
    market = Column(String(10), nullable=False)  # stock / crypto
    value = Column(Integer)  # 0-100
    classification = Column(String(20))  # extreme_fear, fear, neutral, greed, extreme_greed
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_sentiment_market_date', 'market', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<MarketSentiment(market={self.market}, date={self.date}, value={self.value})>"
    
    @staticmethod
    def get_classification(value: int) -> str:
        """æ ¹æ“šæ•¸å€¼å–å¾—åˆ†é¡"""
        if value <= 25:
            return "extreme_fear"
        elif value <= 45:
            return "fear"
        elif value <= 55:
            return "neutral"
        elif value <= 75:
            return "greed"
        else:
            return "extreme_greed"
    
    @staticmethod
    def get_classification_zh(value: int) -> str:
        """æ ¹æ“šæ•¸å€¼å–å¾—ä¸­æ–‡åˆ†é¡"""
        if value <= 25:
            return "æ¥µåº¦ææ‡¼"
        elif value <= 45:
            return "ææ‡¼"
        elif value <= 55:
            return "ä¸­æ€§"
        elif value <= 75:
            return "è²ªå©ª"
        else:
            return "æ¥µåº¦è²ªå©ª"
    
    def to_dict(self):
        return {
            "id": self.id,
            "date": self.date.isoformat() if self.date else None,
            "market": self.market,
            "value": self.value,
            "classification": self.classification,
            "classification_zh": self.get_classification_zh(self.value) if self.value else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/notification.py  â­â­
> é€šçŸ¥è¨˜éŒ„è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
é€šçŸ¥è¨˜éŒ„è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Boolean, Numeric, Text, Index
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base


class Notification(Base):
    """é€šçŸ¥è¨˜éŒ„"""
    
    __tablename__ = "notifications"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(10), nullable=False)
    asset_type = Column(String(10), nullable=False)  # stock / crypto
    alert_type = Column(String(30), nullable=False)  # é€šçŸ¥é¡å‹
    indicator = Column(String(20))  # ç›¸é—œæŒ‡æ¨™
    message = Column(Text)  # é€šçŸ¥å…§å®¹
    price_at_trigger = Column(Numeric(18, 8))  # è§¸ç™¼æ™‚åƒ¹æ ¼
    triggered_at = Column(DateTime, server_default=func.now())
    sent = Column(Boolean, default=False)  # æ˜¯å¦å·²ç™¼é€
    sent_at = Column(DateTime)  # ç™¼é€æ™‚é–“
    
    # é—œè¯
    user = relationship("User")
    
    __table_args__ = (
        Index('idx_notification_user', 'user_id'),
        Index('idx_notification_symbol', 'symbol'),
        Index('idx_notification_triggered', 'triggered_at'),
    )
    
    # é€šçŸ¥é¡å‹å¸¸æ•¸
    ALERT_TYPES = {
        "ma_golden_cross": "å‡ç·šé»ƒé‡‘äº¤å‰",
        "ma_death_cross": "å‡ç·šæ­»äº¡äº¤å‰",
        "approaching_breakout": "æ¥è¿‘å‘ä¸Šçªç ´",
        "approaching_breakdown": "æ¥è¿‘å‘ä¸‹è·Œç ´",
        "breakout": "å·²çªç ´",
        "breakdown": "å·²è·Œç ´",
        "rsi_overbought": "RSI è¶…è²·",
        "rsi_oversold": "RSI è¶…è³£",
        "macd_golden_cross": "MACD é»ƒé‡‘äº¤å‰",
        "macd_death_cross": "MACD æ­»äº¡äº¤å‰",
        "kd_golden_cross": "KD é»ƒé‡‘äº¤å‰",
        "kd_death_cross": "KD æ­»äº¡äº¤å‰",
        "bollinger_breakout": "å¸ƒæ—ä¸Šè»Œçªç ´",
        "bollinger_breakdown": "å¸ƒæ—ä¸‹è»Œè·Œç ´",
        "volume_surge": "æˆäº¤é‡æš´å¢",
        "sentiment_extreme_fear": "æ¥µåº¦ææ‡¼",
        "sentiment_extreme_greed": "æ¥µåº¦è²ªå©ª",
    }
    
    def __repr__(self):
        return f"<Notification(user_id={self.user_id}, symbol={self.symbol}, alert_type={self.alert_type})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "asset_type": self.asset_type,
            "alert_type": self.alert_type,
            "alert_type_zh": self.ALERT_TYPES.get(self.alert_type, self.alert_type),
            "indicator": self.indicator,
            "message": self.message,
            "price_at_trigger": float(self.price_at_trigger) if self.price_at_trigger else None,
            "triggered_at": self.triggered_at.isoformat() if self.triggered_at else None,
            "sent": self.sent,
            "sent_at": self.sent_at.isoformat() if self.sent_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/price_cache.py  â­â­
> è‚¡ç¥¨åƒ¹æ ¼å¿«å– Model
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨åƒ¹æ ¼å¿«å– Model
ç”¨æ–¼è¿½è¹¤æ¸…å–®çš„å³æ™‚åƒ¹æ ¼é¡¯ç¤ºï¼ˆå…¨ç³»çµ±å…±ç”¨ï¼‰
"""
from sqlalchemy import Column, String, Numeric, BigInteger, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class StockPriceCache(Base):
    """
    è‚¡ç¥¨å³æ™‚åƒ¹æ ¼å¿«å–
    
    - å…¨ç³»çµ±å…±ç”¨ï¼Œä¸åˆ†ç”¨æˆ¶
    - æ¯ 10 åˆ†é˜ç”±æ’ç¨‹æ‰¹æ¬¡æ›´æ–°
    - è¿½è¹¤æ¸…å–®é é¢ç›´æ¥å¾é€™è£¡è®€å–
    """
    
    __tablename__ = "stock_price_cache"
    
    # ä¸»éµï¼šè‚¡ç¥¨ä»£è™Ÿï¼ˆå¦‚ 0050.TW, AAPLï¼‰
    symbol = Column(String(20), primary_key=True)
    
    # è‚¡ç¥¨åç¨±
    name = Column(String(100))
    
    # åƒ¹æ ¼è³‡è¨Š
    price = Column(Numeric(12, 4))           # æœ€æ–°åƒ¹æ ¼
    prev_close = Column(Numeric(12, 4))      # å‰æ”¶ç›¤åƒ¹ï¼ˆç”¨æ–¼è¨ˆç®—æ¼²è·Œï¼‰
    change = Column(Numeric(12, 4))          # æ¼²è·Œé‡‘é¡
    change_pct = Column(Numeric(8, 4))       # æ¼²è·Œå¹… %
    
    # æˆäº¤é‡
    volume = Column(BigInteger)
    
    # è³‡ç”¢é¡å‹ï¼šstock / crypto
    asset_type = Column(String(10), default="stock")
    
    # æ›´æ–°æ™‚é–“
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_cache_asset_type', 'asset_type'),
        Index('idx_cache_updated', 'updated_at'),
    )
    
    def __repr__(self):
        return f"<StockPriceCache(symbol={self.symbol}, price={self.price}, change_pct={self.change_pct}%)>"
    
    def to_dict(self):
        return {
            "symbol": self.symbol,
            "name": self.name,
            "price": float(self.price) if self.price else None,
            "prev_close": float(self.prev_close) if self.prev_close else None,
            "change": float(self.change) if self.change else None,
            "change_pct": float(self.change_pct) if self.change_pct else None,
            "volume": self.volume,
            "asset_type": self.asset_type,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/stock_price.py  â­â­
> è‚¡ç¥¨åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, BigInteger, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class StockPrice(Base):
    """ç¾è‚¡åƒ¹æ ¼æ­·å²"""
    
    __tablename__ = "stock_prices"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)
    date = Column(Date, nullable=False, index=True)
    open = Column(Numeric(12, 4))
    high = Column(Numeric(12, 4))
    low = Column(Numeric(12, 4))
    close = Column(Numeric(12, 4))
    volume = Column(BigInteger)
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_stock_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<StockPrice(symbol={self.symbol}, date={self.date}, close={self.close})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "date": self.date.isoformat() if self.date else None,
            "open": float(self.open) if self.open else None,
            "high": float(self.high) if self.high else None,
            "low": float(self.low) if self.low else None,
            "close": float(self.close) if self.close else None,
            "volume": self.volume,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/user.py  â­â­
> ç”¨æˆ¶è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ç”¨æˆ¶è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, DateTime, Boolean, Text, ForeignKey
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base


class User(Base):
    """ç”¨æˆ¶è³‡æ–™"""
    
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    line_user_id = Column(String(50), unique=True, nullable=False, index=True)
    display_name = Column(String(100))
    picture_url = Column(String(500))
    email = Column(String(200))
    is_active = Column(Boolean, default=True)
    is_admin = Column(Boolean, default=False)  # ç®¡ç†å“¡
    is_blocked = Column(Boolean, default=False)  # å°é–
    blocked_reason = Column(String(200))  # å°é–åŸå› 
    blocked_at = Column(DateTime)  # å°é–æ™‚é–“
    created_at = Column(DateTime, server_default=func.now())
    last_login = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    # é—œè¯
    watchlists = relationship("Watchlist", back_populates="user", cascade="all, delete-orphan")
    indicator_settings = relationship("UserIndicatorSettings", back_populates="user", uselist=False, cascade="all, delete-orphan")
    alert_settings = relationship("UserAlertSettings", back_populates="user", uselist=False, cascade="all, delete-orphan")
    login_logs = relationship("LoginLog", back_populates="user", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<User(id={self.id}, line_user_id={self.line_user_id}, display_name={self.display_name})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "line_user_id": self.line_user_id,
            "display_name": self.display_name,
            "picture_url": self.picture_url,
            "email": self.email,
            "is_active": self.is_active,
            "is_admin": self.is_admin,
            "is_blocked": self.is_blocked,
            "blocked_reason": self.blocked_reason,
            "blocked_at": self.blocked_at.isoformat() if self.blocked_at else None,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "last_login": self.last_login.isoformat() if self.last_login else None,
        }


class LoginLog(Base):
    """ç™»å…¥æ—¥èªŒ"""
    
    __tablename__ = "login_logs"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    action = Column(String(20), nullable=False)  # login, logout, token_refresh
    ip_address = Column(String(50))
    user_agent = Column(String(500))
    created_at = Column(DateTime, server_default=func.now())
    
    # é—œè¯
    user = relationship("User", back_populates="login_logs")
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "action": self.action,
            "ip_address": self.ip_address,
            "user_agent": self.user_agent,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }


class TokenBlacklist(Base):
    """Token é»‘åå–®ï¼ˆç”¨æ–¼è¸¢å‡ºç”¨æˆ¶ï¼‰"""
    
    __tablename__ = "token_blacklist"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    token_jti = Column(String(100), unique=True, nullable=False, index=True)  # JWT ID
    user_id = Column(Integer, index=True)
    reason = Column(String(100))  # kicked, logout, blocked
    created_at = Column(DateTime, server_default=func.now())
    expires_at = Column(DateTime)  # Token éæœŸæ™‚é–“ï¼ˆéæœŸå¾Œå¯æ¸…ç†ï¼‰
    
    def to_dict(self):
        return {
            "id": self.id,
            "token_jti": self.token_jti,
            "user_id": self.user_id,
            "reason": self.reason,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }


class SystemConfig(Base):
    """ç³»çµ±è¨­å®š"""
    
    __tablename__ = "system_config"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    key = Column(String(50), unique=True, nullable=False, index=True)
    value = Column(Text)
    description = Column(String(200))
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    def to_dict(self):
        return {
            "id": self.id,
            "key": self.key,
            "value": self.value,
            "description": self.description,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/user_settings.py  â­â­
> ç”¨æˆ¶è¨­å®šè³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ç”¨æˆ¶è¨­å®šè³‡æ–™æ¨¡å‹
åŒ…å«æŒ‡æ¨™é¡¯ç¤ºè¨­å®šã€é€šçŸ¥è¨­å®šã€åƒæ•¸è¨­å®š
"""
from sqlalchemy import Column, Integer, Boolean, ForeignKey, Numeric
from sqlalchemy.orm import relationship
from app.database import Base


class UserIndicatorSettings(Base):
    """ç”¨æˆ¶æŒ‡æ¨™é¡¯ç¤ºè¨­å®š"""
    
    __tablename__ = "user_indicator_settings"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    show_ma = Column(Boolean, default=True)
    show_rsi = Column(Boolean, default=True)
    show_macd = Column(Boolean, default=True)
    show_kd = Column(Boolean, default=False)
    show_bollinger = Column(Boolean, default=True)
    show_obv = Column(Boolean, default=False)
    show_volume = Column(Boolean, default=True)
    
    # é—œè¯
    user = relationship("User", back_populates="indicator_settings")
    
    def __repr__(self):
        return f"<UserIndicatorSettings(user_id={self.user_id})>"
    
    def to_dict(self):
        return {
            "show_ma": self.show_ma,
            "show_rsi": self.show_rsi,
            "show_macd": self.show_macd,
            "show_kd": self.show_kd,
            "show_bollinger": self.show_bollinger,
            "show_obv": self.show_obv,
            "show_volume": self.show_volume,
        }
    
    @classmethod
    def create_default(cls, user_id: int):
        """å»ºç«‹é è¨­è¨­å®š"""
        return cls(user_id=user_id)


class UserAlertSettings(Base):
    """ç”¨æˆ¶é€šçŸ¥è¨­å®š"""
    
    __tablename__ = "user_alert_settings"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    alert_ma_cross = Column(Boolean, default=True)      # å‡ç·šäº¤å‰é€šçŸ¥
    alert_ma_breakout = Column(Boolean, default=True)   # å‡ç·šçªç ´é€šçŸ¥
    alert_rsi = Column(Boolean, default=True)           # RSI è¶…è²·è¶…è³£é€šçŸ¥
    alert_macd = Column(Boolean, default=True)          # MACD äº¤å‰é€šçŸ¥
    alert_kd = Column(Boolean, default=False)           # KD äº¤å‰é€šçŸ¥
    alert_bollinger = Column(Boolean, default=False)    # å¸ƒæ—çªç ´é€šçŸ¥
    alert_volume = Column(Boolean, default=False)       # é‡èƒ½ç•°å¸¸é€šçŸ¥
    alert_sentiment = Column(Boolean, default=True)     # æƒ…ç·’æ¥µç«¯é€šçŸ¥
    
    # é—œè¯
    user = relationship("User", back_populates="alert_settings")
    
    def __repr__(self):
        return f"<UserAlertSettings(user_id={self.user_id})>"
    
    def to_dict(self):
        return {
            "alert_ma_cross": self.alert_ma_cross,
            "alert_ma_breakout": self.alert_ma_breakout,
            "alert_rsi": self.alert_rsi,
            "alert_macd": self.alert_macd,
            "alert_kd": self.alert_kd,
            "alert_bollinger": self.alert_bollinger,
            "alert_volume": self.alert_volume,
            "alert_sentiment": self.alert_sentiment,
        }
    
    @classmethod
    def create_default(cls, user_id: int):
        """å»ºç«‹é è¨­è¨­å®š"""
        return cls(user_id=user_id)


class UserIndicatorParams(Base):
    """ç”¨æˆ¶æŒ‡æ¨™åƒæ•¸è¨­å®š"""
    
    __tablename__ = "user_indicator_params"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    
    # å‡ç·š
    ma_short = Column(Integer, default=20)
    ma_mid = Column(Integer, default=50)
    ma_long = Column(Integer, default=200)
    
    # RSI
    rsi_period = Column(Integer, default=14)
    rsi_overbought = Column(Integer, default=70)
    rsi_oversold = Column(Integer, default=30)
    
    # MACD
    macd_fast = Column(Integer, default=12)
    macd_slow = Column(Integer, default=26)
    macd_signal = Column(Integer, default=9)
    
    # KD
    kd_period = Column(Integer, default=9)
    
    # å¸ƒæ—é€šé“
    bollinger_period = Column(Integer, default=20)
    bollinger_std = Column(Numeric(3, 1), default=2.0)
    
    # è­¦æˆ’å€¼
    breakout_threshold = Column(Numeric(4, 2), default=2.00)  # çªç ´é è­¦é–€æª» (%)
    volume_alert_ratio = Column(Numeric(3, 1), default=2.0)   # é‡æ¯”è­¦æˆ’å€æ•¸
    
    # é—œè¯
    user = relationship("User")
    
    def __repr__(self):
        return f"<UserIndicatorParams(user_id={self.user_id})>"
    
    def to_dict(self):
        return {
            "ma_short": self.ma_short,
            "ma_mid": self.ma_mid,
            "ma_long": self.ma_long,
            "rsi_period": self.rsi_period,
            "rsi_overbought": self.rsi_overbought,
            "rsi_oversold": self.rsi_oversold,
            "macd_fast": self.macd_fast,
            "macd_slow": self.macd_slow,
            "macd_signal": self.macd_signal,
            "kd_period": self.kd_period,
            "bollinger_period": self.bollinger_period,
            "bollinger_std": float(self.bollinger_std) if self.bollinger_std else 2.0,
            "breakout_threshold": float(self.breakout_threshold) if self.breakout_threshold else 2.0,
            "volume_alert_ratio": float(self.volume_alert_ratio) if self.volume_alert_ratio else 2.0,
        }
    
    @classmethod
    def create_default(cls, user_id: int):
        """å»ºç«‹é è¨­è¨­å®š"""
        return cls(user_id=user_id)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/watchlist.py  â­â­
> è¿½è¹¤æ¸…å–®è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–®è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Index
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base


class Watchlist(Base):
    """ç”¨æˆ¶è¿½è¹¤æ¸…å–®"""
    
    __tablename__ = "watchlists"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(10), nullable=False)
    asset_type = Column(String(10), nullable=False)  # stock / crypto
    note = Column(String(200))  # è‡ªè¨‚å‚™è¨»
    added_at = Column(DateTime, server_default=func.now())
    
    # é—œè¯
    user = relationship("User", back_populates="watchlists")
    
    __table_args__ = (
        Index('idx_watchlist_user', 'user_id'),
        Index('idx_watchlist_unique', 'user_id', 'symbol', 'asset_type', unique=True),
    )
    
    def __repr__(self):
        return f"<Watchlist(user_id={self.user_id}, symbol={self.symbol}, asset_type={self.asset_type})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "asset_type": self.asset_type,
            "note": self.note,
            "added_at": self.added_at.isoformat() if self.added_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/schemas/__init__.py  â­â­
> Pydantic Schemas
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Pydantic Schemas
"""
from app.schemas.schemas import *
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/schemas/schemas.py  â­â­
> Pydantic Schemas
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Pydantic Schemas
API è«‹æ±‚/å›æ‡‰è³‡æ–™æ¨¡å‹
"""
from pydantic import BaseModel, Field
from typing import Optional, List, Any, Dict
from datetime import datetime


# ==================== é€šç”¨ ====================

class ResponseBase(BaseModel):
    """åŸºç¤å›æ‡‰"""
    success: bool = True
    message: Optional[str] = None


class ErrorResponse(BaseModel):
    """éŒ¯èª¤å›æ‡‰"""
    success: bool = False
    error: Dict[str, str]


# ==================== ç”¨æˆ¶ ====================

class UserBase(BaseModel):
    """ç”¨æˆ¶åŸºæœ¬è³‡è¨Š"""
    display_name: Optional[str] = None
    picture_url: Optional[str] = None
    email: Optional[str] = None


class UserResponse(UserBase):
    """ç”¨æˆ¶å›æ‡‰"""
    id: int
    line_user_id: str
    is_active: bool
    is_admin: bool = False  # ç®¡ç†å“¡æ¬Šé™
    created_at: Optional[datetime] = None
    last_login: Optional[datetime] = None
    
    class Config:
        from_attributes = True


class LoginResponse(ResponseBase):
    """ç™»å…¥å›æ‡‰"""
    token: str
    user: UserResponse
    is_new_user: bool = False


# ==================== è¿½è¹¤æ¸…å–® ====================

class WatchlistAdd(BaseModel):
    """æ–°å¢è¿½è¹¤æ¸…å–®è«‹æ±‚"""
    symbol: str = Field(..., min_length=1, max_length=10)
    note: Optional[str] = Field(None, max_length=200)


class WatchlistUpdate(BaseModel):
    """æ›´æ–°è¿½è¹¤æ¸…å–®è«‹æ±‚"""
    note: Optional[str] = Field(None, max_length=200)


class WatchlistItem(BaseModel):
    """è¿½è¹¤æ¸…å–®é …ç›®"""
    id: int
    symbol: str
    asset_type: str
    note: Optional[str] = None
    added_at: Optional[datetime] = None
    
    class Config:
        from_attributes = True


class WatchlistResponse(ResponseBase):
    """è¿½è¹¤æ¸…å–®å›æ‡‰"""
    data: Optional[WatchlistItem] = None


class WatchlistListResponse(ResponseBase):
    """è¿½è¹¤æ¸…å–®åˆ—è¡¨å›æ‡‰"""
    data: List[WatchlistItem] = []
    total: int = 0


class WatchlistOverviewItem(BaseModel):
    """è¿½è¹¤æ¸…å–®ç¸½è¦½é …ç›®"""
    id: int
    symbol: str
    name: Optional[str] = None
    price: Optional[float] = None
    change_day: Optional[float] = None
    change_24h: Optional[float] = None
    ma_alignment: Optional[str] = None
    rsi: Optional[float] = None
    score: Optional[Dict[str, Any]] = None
    note: Optional[str] = None
    added_at: Optional[str] = None


class SentimentItem(BaseModel):
    """æƒ…ç·’æŒ‡æ•¸é …ç›®"""
    value: int
    classification: str
    classification_zh: str
    timestamp: str
    market: str


class WatchlistOverviewResponse(ResponseBase):
    """è¿½è¹¤æ¸…å–®ç¸½è¦½å›æ‡‰"""
    stocks: List[WatchlistOverviewItem] = []
    crypto: List[WatchlistOverviewItem] = []
    sentiment: Optional[Dict[str, SentimentItem]] = None
    total_count: int = 0


# ==================== è¨­å®š ====================

class IndicatorSettingsUpdate(BaseModel):
    """æŒ‡æ¨™é¡¯ç¤ºè¨­å®šæ›´æ–°"""
    show_ma: Optional[bool] = None
    show_rsi: Optional[bool] = None
    show_macd: Optional[bool] = None
    show_kd: Optional[bool] = None
    show_bollinger: Optional[bool] = None
    show_obv: Optional[bool] = None
    show_volume: Optional[bool] = None


class IndicatorSettingsResponse(ResponseBase):
    """æŒ‡æ¨™é¡¯ç¤ºè¨­å®šå›æ‡‰"""
    data: Dict[str, bool] = {}


class AlertSettingsUpdate(BaseModel):
    """é€šçŸ¥è¨­å®šæ›´æ–°"""
    alert_ma_cross: Optional[bool] = None
    alert_ma_breakout: Optional[bool] = None
    alert_rsi: Optional[bool] = None
    alert_macd: Optional[bool] = None
    alert_kd: Optional[bool] = None
    alert_bollinger: Optional[bool] = None
    alert_volume: Optional[bool] = None
    alert_sentiment: Optional[bool] = None


class AlertSettingsResponse(ResponseBase):
    """é€šçŸ¥è¨­å®šå›æ‡‰"""
    data: Dict[str, bool] = {}


class IndicatorParamsUpdate(BaseModel):
    """æŒ‡æ¨™åƒæ•¸æ›´æ–°"""
    ma_short: Optional[int] = Field(None, ge=5, le=50)
    ma_mid: Optional[int] = Field(None, ge=20, le=100)
    ma_long: Optional[int] = Field(None, ge=50, le=300)
    rsi_period: Optional[int] = Field(None, ge=5, le=30)
    rsi_overbought: Optional[int] = Field(None, ge=60, le=90)
    rsi_oversold: Optional[int] = Field(None, ge=10, le=40)
    macd_fast: Optional[int] = Field(None, ge=5, le=20)
    macd_slow: Optional[int] = Field(None, ge=15, le=40)
    macd_signal: Optional[int] = Field(None, ge=5, le=15)
    kd_period: Optional[int] = Field(None, ge=5, le=20)
    bollinger_period: Optional[int] = Field(None, ge=10, le=30)
    bollinger_std: Optional[float] = Field(None, ge=1.0, le=3.0)
    breakout_threshold: Optional[float] = Field(None, ge=0.5, le=5.0)
    volume_alert_ratio: Optional[float] = Field(None, ge=1.0, le=5.0)


class IndicatorParamsResponse(ResponseBase):
    """æŒ‡æ¨™åƒæ•¸å›æ‡‰"""
    data: Dict[str, Any] = {}


# ==================== è‚¡ç¥¨/åŠ å¯†è²¨å¹£ ====================

class PriceInfo(BaseModel):
    """åƒ¹æ ¼è³‡è¨Š"""
    current: float
    high_52w: Optional[float] = None
    low_52w: Optional[float] = None
    ath: Optional[float] = None
    from_high_pct: Optional[float] = None
    from_low_pct: Optional[float] = None
    from_ath_pct: Optional[float] = None


class ChangeInfo(BaseModel):
    """æ¼²è·Œå¹…è³‡è¨Š"""
    day: Optional[float] = None
    week: Optional[float] = None
    month: Optional[float] = None
    quarter: Optional[float] = None
    year: Optional[float] = None


class VolumeInfo(BaseModel):
    """æˆäº¤é‡è³‡è¨Š"""
    today: Optional[int] = None
    avg_20d: Optional[int] = None
    ratio: Optional[float] = None


class SignalItem(BaseModel):
    """è¨Šè™Ÿé …ç›®"""
    type: str
    indicator: str
    description: str


class ScoreInfo(BaseModel):
    """è©•åˆ†è³‡è¨Š"""
    buy_score: int = 0
    sell_score: int = 0
    rating: str = "neutral"
    details: List[str] = []


class StockAnalysisResponse(ResponseBase):
    """è‚¡ç¥¨åˆ†æå›æ‡‰"""
    symbol: str
    name: str
    asset_type: str = "stock"
    price: PriceInfo
    change: ChangeInfo
    volume: Optional[VolumeInfo] = None
    indicators: Dict[str, Any] = {}
    signals: List[SignalItem] = []
    score: ScoreInfo
    updated_at: Optional[str] = None


class CryptoAnalysisResponse(ResponseBase):
    """åŠ å¯†è²¨å¹£åˆ†æå›æ‡‰"""
    symbol: str
    name: str
    asset_type: str = "crypto"
    price: PriceInfo
    change: ChangeInfo
    market: Optional[Dict[str, Any]] = None
    indicators: Dict[str, Any] = {}
    signals: List[SignalItem] = []
    score: ScoreInfo
    updated_at: Optional[str] = None


# ==================== å¸‚å ´æƒ…ç·’ ====================

class MarketSentimentResponse(ResponseBase):
    """å¸‚å ´æƒ…ç·’å›æ‡‰"""
    stock: Optional[SentimentItem] = None
    crypto: Optional[SentimentItem] = None
```

======================================================================
## ğŸ§  æ ¸å¿ƒé‚è¼¯
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/__init__.py  â­â­â­
> å•†æ¥­é‚è¼¯æœå‹™æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å•†æ¥­é‚è¼¯æœå‹™æ¨¡çµ„
"""
from app.services.indicator_service import indicator_service, IndicatorService
from app.services.stock_service import StockService
from app.services.crypto_service import CryptoService
from app.services.chart_service import chart_service, ChartService
from app.services.auth_service import AuthService, AuthServiceSync
from app.services.watchlist_service import WatchlistService
from app.services.market_service import MarketService
from app.services.signal_service import signal_service, SignalService, SignalType
from app.services.line_notify_service import line_notify_service, LineNotifyService

__all__ = [
    "indicator_service",
    "IndicatorService",
    "StockService",
    "CryptoService",
    "chart_service",
    "ChartService",
    "AuthService",
    "AuthServiceSync",
    "WatchlistService",
    "MarketService",
    "signal_service",
    "SignalService",
    "SignalType",
    "line_notify_service",
    "LineNotifyService",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/auth_service.py  â­â­â­
> èªè­‰æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
èªè­‰æœå‹™
LINE Login æ•´åˆ + JWT Token ç®¡ç†
"""
import httpx
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
from jose import jwt, JWTError
from sqlalchemy.orm import Session
from sqlalchemy import select
import logging
import secrets
import uuid

from app.config import settings
from app.models.user import User, LoginLog, SystemConfig
from app.models.user_settings import UserIndicatorSettings, UserAlertSettings, UserIndicatorParams

logger = logging.getLogger(__name__)

# JWT è¨­å®š
JWT_ALGORITHM = "HS256"


class AuthService:
    """èªè­‰æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    # ==================== LINE Login ====================
    
    def get_line_auth_url(self, state: str = None) -> str:
        """
        å–å¾— LINE æˆæ¬Š URL
        
        Args:
            state: é˜² CSRF çš„éš¨æ©Ÿå­—ä¸²
            
        Returns:
            LINE æˆæ¬Šé é¢ URL
        """
        if not state:
            state = secrets.token_urlsafe(32)
        
        params = {
            "response_type": "code",
            "client_id": settings.LINE_LOGIN_CHANNEL_ID,
            "redirect_uri": settings.LINE_LOGIN_CALLBACK_URL,
            "state": state,
            "scope": "profile openid email",
        }
        
        query_string = "&".join(f"{k}={v}" for k, v in params.items())
        return f"https://access.line.me/oauth2/v2.1/authorize?{query_string}"
    
    async def exchange_code_for_token(self, code: str) -> Optional[Dict[str, Any]]:
        """
        ç”¨ authorization code æ›å– access token
        
        Args:
            code: LINE å›å‚³çš„ authorization code
            
        Returns:
            åŒ…å« access_token, id_token ç­‰çš„å­—å…¸
        """
        url = "https://api.line.me/oauth2/v2.1/token"
        
        data = {
            "grant_type": "authorization_code",
            "code": code,
            "redirect_uri": settings.LINE_LOGIN_CALLBACK_URL,
            "client_id": settings.LINE_LOGIN_CHANNEL_ID,
            "client_secret": settings.LINE_LOGIN_CHANNEL_SECRET,
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(url, data=data)
                response.raise_for_status()
                return response.json()
        except Exception as e:
            logger.error(f"LINE token äº¤æ›å¤±æ•—: {e}")
            return None
    
    async def get_line_profile(self, access_token: str) -> Optional[Dict[str, Any]]:
        """
        ç”¨ access token å–å¾— LINE ç”¨æˆ¶è³‡æ–™
        
        Args:
            access_token: LINE access token
            
        Returns:
            ç”¨æˆ¶è³‡æ–™å­—å…¸ (userId, displayName, pictureUrl, statusMessage)
        """
        url = "https://api.line.me/v2/profile"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.get(
                    url,
                    headers={"Authorization": f"Bearer {access_token}"}
                )
                response.raise_for_status()
                return response.json()
        except Exception as e:
            logger.error(f"å–å¾— LINE ç”¨æˆ¶è³‡æ–™å¤±æ•—: {e}")
            return None
    
    async def verify_id_token(self, id_token: str) -> Optional[Dict[str, Any]]:
        """
        é©—è­‰ LINE ID Token
        
        Args:
            id_token: LINE ID Token
            
        Returns:
            è§£ç¢¼å¾Œçš„ token payload
        """
        url = "https://api.line.me/oauth2/v2.1/verify"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    url,
                    data={
                        "id_token": id_token,
                        "client_id": settings.LINE_LOGIN_CHANNEL_ID,
                    }
                )
                response.raise_for_status()
                return response.json()
        except Exception as e:
            logger.error(f"LINE ID Token é©—è­‰å¤±æ•—: {e}")
            return None
    
    # ==================== ç”¨æˆ¶ç®¡ç† ====================
    
    async def get_user_by_line_id(self, line_user_id: str) -> Optional[User]:
        """æ ¹æ“š LINE User ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.line_user_id == line_user_id)
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def get_user_by_id(self, user_id: int) -> Optional[User]:
        """æ ¹æ“š ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.id == user_id)
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def create_user(
        self,
        line_user_id: str,
        display_name: str = None,
        picture_url: str = None,
        email: str = None,
    ) -> User:
        """
        å»ºç«‹æ–°ç”¨æˆ¶
        
        æœƒè‡ªå‹•å»ºç«‹é è¨­è¨­å®šï¼Œä¸¦æª¢æŸ¥æ˜¯å¦ç‚ºåˆå§‹ç®¡ç†å“¡
        """
        # æª¢æŸ¥æ˜¯å¦ç‚ºåˆå§‹ç®¡ç†å“¡
        admin_ids = settings.get_admin_line_ids()
        is_admin = line_user_id in admin_ids
        
        user = User(
            line_user_id=line_user_id,
            display_name=display_name,
            picture_url=picture_url,
            email=email,
            is_admin=is_admin,
        )
        self.db.add(user)
        await self.db.flush()  # å–å¾— user.id
        
        # å»ºç«‹é è¨­è¨­å®š
        indicator_settings = UserIndicatorSettings.create_default(user.id)
        alert_settings = UserAlertSettings.create_default(user.id)
        params = UserIndicatorParams.create_default(user.id)
        
        self.db.add(indicator_settings)
        self.db.add(alert_settings)
        self.db.add(params)
        
        await self.db.commit()
        await self.db.refresh(user)
        
        logger.info(f"æ–°ç”¨æˆ¶å»ºç«‹: {user.id} ({display_name}), admin={is_admin}")
        return user
    
    async def update_user_login(self, user: User, display_name: str = None, picture_url: str = None):
        """æ›´æ–°ç”¨æˆ¶ç™»å…¥è³‡è¨Š"""
        if display_name:
            user.display_name = display_name
        if picture_url:
            user.picture_url = picture_url
        user.last_login = datetime.utcnow()
        
        # æª¢æŸ¥æ˜¯å¦éœ€è¦å‡ç´šç‚ºç®¡ç†å“¡ï¼ˆä½¿ç”¨ getattr å’Œ setattr é¿å…æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼‰
        try:
            if not getattr(user, 'is_admin', False):
                admin_ids = settings.get_admin_line_ids()
                if user.line_user_id in admin_ids:
                    user.is_admin = True
                    logger.info(f"ç”¨æˆ¶ {user.id} å‡ç´šç‚ºç®¡ç†å“¡")
        except Exception as e:
            logger.warning(f"is_admin check failed: {e}")
        
        await self.db.commit()
    
    async def log_login(self, user_id: int, action: str = "login", ip_address: str = None, user_agent: str = None):
        """è¨˜éŒ„ç™»å…¥æ—¥èªŒ"""
        try:
            log = LoginLog(
                user_id=user_id,
                action=action,
                ip_address=ip_address,
                user_agent=user_agent[:500] if user_agent else None,
            )
            self.db.add(log)
            await self.db.commit()
        except Exception as e:
            # å¦‚æœ login_logs è¡¨ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤
            logger.warning(f"log_login failed (table may not exist): {e}")
    
    async def login_with_line(self, code: str, ip_address: str = None, user_agent: str = None) -> Optional[Dict[str, Any]]:
        """
        LINE Login å®Œæ•´æµç¨‹
        
        Args:
            code: LINE å›å‚³çš„ authorization code
            
        Returns:
            {
                "user": User,
                "token": str,
                "is_new_user": bool
            }
        """
        logger.info(f"=== LINE Login é–‹å§‹ ===")
        logger.info(f"IP: {ip_address}, UA: {user_agent[:100] if user_agent else 'N/A'}")
        
        # 1. æ›å– access token
        token_data = await self.exchange_code_for_token(code)
        if not token_data:
            logger.error("LINE token äº¤æ›å¤±æ•—")
            return None
        
        access_token = token_data.get("access_token")
        logger.info(f"LINE token äº¤æ›æˆåŠŸ")
        
        # 2. å–å¾—ç”¨æˆ¶è³‡æ–™
        profile = await self.get_line_profile(access_token)
        if not profile:
            logger.error("å–å¾— LINE ç”¨æˆ¶è³‡æ–™å¤±æ•—")
            return None
        
        line_user_id = profile.get("userId")
        display_name = profile.get("displayName")
        picture_url = profile.get("pictureUrl")
        
        logger.info(f"LINE ç”¨æˆ¶è³‡æ–™: line_id={line_user_id}, name={display_name}")
        
        # 3. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
        user = await self.get_user_by_line_id(line_user_id)
        is_new_user = False
        
        if user:
            logger.info(f"æ—¢æœ‰ç”¨æˆ¶ç™»å…¥: db_id={user.id}, line_id={user.line_user_id}, name={user.display_name}")
            
            # æª¢æŸ¥æ˜¯å¦è¢«å°é–ï¼ˆä½¿ç”¨ getattr é¿å…æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼‰
            if getattr(user, 'is_blocked', False):
                logger.warning(f"å°é–ç”¨æˆ¶å˜—è©¦ç™»å…¥: {user.id} ({display_name})")
                return None
            
            # æ›´æ–°ç™»å…¥è³‡è¨Š
            await self.update_user_login(user, display_name, picture_url)
            logger.info(f"ç”¨æˆ¶ç™»å…¥è³‡è¨Šå·²æ›´æ–°: db_id={user.id}")
        else:
            # å»ºç«‹æ–°ç”¨æˆ¶
            logger.info(f"å»ºç«‹æ–°ç”¨æˆ¶: line_id={line_user_id}, name={display_name}")
            
            # å˜—è©¦å¾ ID token å–å¾— email
            email = None
            if token_data.get("id_token"):
                id_token_data = await self.verify_id_token(token_data["id_token"])
                if id_token_data:
                    email = id_token_data.get("email")
            
            user = await self.create_user(
                line_user_id=line_user_id,
                display_name=display_name,
                picture_url=picture_url,
                email=email,
            )
            is_new_user = True
            logger.info(f"æ–°ç”¨æˆ¶å»ºç«‹æˆåŠŸ: db_id={user.id}, line_id={user.line_user_id}")
        
        # 4. è¨˜éŒ„ç™»å…¥æ—¥èªŒ
        await self.log_login(user.id, "login", ip_address, user_agent)
        logger.info(f"ç™»å…¥æ—¥èªŒå·²è¨˜éŒ„: user_id={user.id}")
        
        # 5. ç”¢ç”Ÿ JWT Token
        jwt_token = self.create_jwt_token(user)
        
        logger.info(f"=== LINE Login å®Œæˆ ===")
        logger.info(f"ç”¨æˆ¶: db_id={user.id}, line_id={user.line_user_id}, name={user.display_name}, is_new={is_new_user}")
        
        return {
            "user": user,
            "token": jwt_token,
            "is_new_user": is_new_user,
        }
    
    # ==================== JWT Token ====================
    
    def create_jwt_token(self, user: User) -> str:
        """
        å»ºç«‹ JWT Token
        
        Args:
            user: ç”¨æˆ¶ç‰©ä»¶
            
        Returns:
            JWT Token å­—ä¸²
        """
        expire = datetime.utcnow() + timedelta(days=settings.JWT_EXPIRE_DAYS)
        issued_at = datetime.utcnow()
        
        payload = {
            "sub": str(user.id),
            "line_user_id": user.line_user_id,
            "display_name": user.display_name,
            "is_admin": getattr(user, 'is_admin', False),
            "exp": expire,
            "iat": issued_at,
            "jti": str(uuid.uuid4()),  # å”¯ä¸€ Token ID
        }
        
        token = jwt.encode(payload, settings.JWT_SECRET_KEY, algorithm=JWT_ALGORITHM)
        return token
    
    def verify_jwt_token(self, token: str) -> Optional[Dict[str, Any]]:
        """
        é©—è­‰ JWT Token
        
        Args:
            token: JWT Token å­—ä¸²
            
        Returns:
            Token payload æˆ– None
        """
        try:
            payload = jwt.decode(
                token,
                settings.JWT_SECRET_KEY,
                algorithms=[JWT_ALGORITHM]
            )
            return payload
        except JWTError as e:
            logger.warning(f"JWT é©—è­‰å¤±æ•—: {e}")
            return None
    
    async def check_token_valid(self, user_id: int, issued_at: int) -> bool:
        """
        æª¢æŸ¥ Token æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆæœªè¢«è¸¢å‡ºï¼‰
        
        Args:
            user_id: ç”¨æˆ¶ ID
            issued_at: Token ç°½ç™¼æ™‚é–“æˆ³
            
        Returns:
            True å¦‚æœ Token æœ‰æ•ˆ
        """
        try:
            # æª¢æŸ¥å…¨åŸŸ token ç‰ˆæœ¬
            result = await self.db.execute(
                select(SystemConfig).where(SystemConfig.key == "global_token_version")
            )
            global_config = result.scalar_one_or_none()
            
            if global_config and global_config.value:
                global_version = int(global_config.value)
                if issued_at < global_version:
                    return False
            
            # æª¢æŸ¥ç”¨æˆ¶ token ç‰ˆæœ¬
            result = await self.db.execute(
                select(SystemConfig).where(SystemConfig.key == f"user_token_version:{user_id}")
            )
            user_config = result.scalar_one_or_none()
            
            if user_config and user_config.value:
                user_version = int(user_config.value)
                if issued_at < user_version:
                    return False
        except Exception as e:
            # å¦‚æœ system_config è¡¨ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤ï¼Œé è¨­ token æœ‰æ•ˆ
            logger.warning(f"check_token_valid error (table may not exist): {e}")
        
        return True
    
    async def get_user_from_token(self, token: str) -> Optional[User]:
        """
        å¾ JWT Token å–å¾—ç”¨æˆ¶
        
        Args:
            token: JWT Token å­—ä¸²
            
        Returns:
            User ç‰©ä»¶æˆ– None
        """
        payload = self.verify_jwt_token(token)
        if not payload:
            logger.warning("Token é©—è­‰å¤±æ•—: payload ç‚ºç©º")
            return None
        
        user_id = payload.get("sub")
        token_line_user_id = payload.get("line_user_id")
        
        if not user_id:
            logger.warning("Token é©—è­‰å¤±æ•—: ç¼ºå°‘ user_id")
            return None
        
        user_id = int(user_id)
        
        # æª¢æŸ¥ Token æ˜¯å¦è¢«è¸¢å‡º
        issued_at = payload.get("iat")
        if issued_at:
            if isinstance(issued_at, datetime):
                issued_at = int(issued_at.timestamp())
            
            is_valid = await self.check_token_valid(user_id, issued_at)
            if not is_valid:
                logger.info(f"Token å·²è¢«è¸¢å‡º: user_id={user_id}")
                return None
        
        user = await self.get_user_by_id(user_id)
        
        if not user:
            logger.warning(f"Token é©—è­‰å¤±æ•—: ç”¨æˆ¶ä¸å­˜åœ¨ user_id={user_id}")
            return None
        
        # â˜…â˜…â˜… é‡è¦ï¼šé©—è­‰ Token ä¸­çš„ line_user_id èˆ‡è³‡æ–™åº«ä¸€è‡´ â˜…â˜…â˜…
        if token_line_user_id and user.line_user_id != token_line_user_id:
            logger.error(f"Token é©—è­‰å¤±æ•—: LINE ID ä¸ä¸€è‡´! token={token_line_user_id}, db={user.line_user_id}")
            return None
        
        # æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦è¢«å°é–ï¼ˆä½¿ç”¨ getattr é¿å…æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼‰
        if getattr(user, 'is_blocked', False):
            logger.info(f"å°é–ç”¨æˆ¶å˜—è©¦å­˜å–: user_id={user_id}")
            return None
        
        logger.debug(f"Token é©—è­‰æˆåŠŸ: user_id={user_id}, line_id={user.line_user_id}")
        return user


# ==================== åŒæ­¥ç‰ˆæœ¬ï¼ˆCLI ç”¨ï¼‰====================

class AuthServiceSync:
    """åŒæ­¥ç‰ˆèªè­‰æœå‹™ï¼ˆCLI ç”¨ï¼‰"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_user_by_id(self, user_id: int) -> Optional[User]:
        """æ ¹æ“š ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.id == user_id)
        return self.db.execute(stmt).scalar_one_or_none()
    
    def get_user_by_line_id(self, line_user_id: str) -> Optional[User]:
        """æ ¹æ“š LINE User ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.line_user_id == line_user_id)
        return self.db.execute(stmt).scalar_one_or_none()
    
    def create_demo_user(self, name: str = "Demo User") -> User:
        """å»ºç«‹æ¸¬è©¦ç”¨æˆ¶ï¼ˆé–‹ç™¼ç”¨ï¼‰"""
        demo_line_id = f"demo_{secrets.token_hex(8)}"
        
        user = User(
            line_user_id=demo_line_id,
            display_name=name,
        )
        self.db.add(user)
        self.db.flush()
        
        # å»ºç«‹é è¨­è¨­å®š
        self.db.add(UserIndicatorSettings.create_default(user.id))
        self.db.add(UserAlertSettings.create_default(user.id))
        self.db.add(UserIndicatorParams.create_default(user.id))
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def verify_jwt_token(self, token: str) -> Optional[Dict[str, Any]]:
        """é©—è­‰ JWT Token"""
        try:
            payload = jwt.decode(
                token,
                settings.JWT_SECRET_KEY,
                algorithms=[JWT_ALGORITHM]
            )
            return payload
        except JWTError:
            return None
    
    def get_user_from_token(self, token: str) -> Optional[User]:
        """å¾ JWT Token å–å¾—ç”¨æˆ¶"""
        payload = self.verify_jwt_token(token)
        if not payload:
            return None
        user_id = payload.get("sub")
        if not user_id:
            return None
        return self.get_user_by_id(int(user_id))
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/chart_service.py  â­â­â­
> åœ–è¡¨ç¹ªè£½æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åœ–è¡¨ç¹ªè£½æœå‹™
ä½¿ç”¨ matplotlib + mplfinance ç¹ªè£½æŠ€è¡“åˆ†æåœ–è¡¨
"""
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from matplotlib.patches import Circle
from datetime import datetime, timedelta
from pathlib import Path
from typing import Optional, Dict, Any, List, Tuple
import logging

from app.config import settings, CHARTS_DIR

logger = logging.getLogger(__name__)

# è¨­å®šä¸­æ–‡å­—é«”
plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# é¡è‰²å®šç¾©
COLORS = {
    "price": "#2196F3",      # åƒ¹æ ¼ç·š - è—è‰²
    "ma_short": "#FF9800",   # MA20 - æ©™è‰²
    "ma_mid": "#9C27B0",     # MA50 - ç´«è‰²
    "ma_long": "#F44336",    # MA200 - ç´…è‰²
    "volume_up": "#4CAF50",  # ä¸Šæ¼²æˆäº¤é‡ - ç¶ è‰²
    "volume_down": "#F44336", # ä¸‹è·Œæˆäº¤é‡ - ç´…è‰²
    "bb_fill": "#E3F2FD",    # å¸ƒæ—é€šé“å¡«å…… - æ·ºè—
    "bb_line": "#90CAF9",    # å¸ƒæ—é€šé“ç·š - è—è‰²
    "rsi": "#673AB7",        # RSI - æ·±ç´«
    "macd_dif": "#2196F3",   # MACD DIF - è—è‰²
    "macd_dea": "#FF9800",   # MACD DEA - æ©™è‰²
    "macd_hist_pos": "#4CAF50",  # MACD æ­£æŸ± - ç¶ è‰²
    "macd_hist_neg": "#F44336",  # MACD è² æŸ± - ç´…è‰²
    "kd_k": "#2196F3",       # K ç·š - è—è‰²
    "kd_d": "#FF9800",       # D ç·š - æ©™è‰²
    "golden_cross": "#4CAF50",   # é»ƒé‡‘äº¤å‰ - ç¶ è‰²
    "death_cross": "#F44336",    # æ­»äº¡äº¤å‰ - ç´…è‰²
    "grid": "#E0E0E0",       # ç¶²æ ¼ç·š
    "overbought": "#FFCDD2", # è¶…è²·å€ - æ·ºç´…
    "oversold": "#C8E6C9",   # è¶…è³£å€ - æ·ºç¶ 
}


class ChartService:
    """åœ–è¡¨ç¹ªè£½æœå‹™"""
    
    def __init__(self, output_dir: Path = None):
        self.output_dir = output_dir or CHARTS_DIR
        self.output_dir.mkdir(exist_ok=True)
    
    def plot_stock_analysis(
        self,
        df: pd.DataFrame,
        symbol: str,
        name: str = "",
        show_ma: bool = True,
        show_bollinger: bool = True,
        show_volume: bool = True,
        show_rsi: bool = True,
        show_macd: bool = True,
        show_kd: bool = False,
        show_signals: bool = True,
        days: int = 120,
        save_path: Optional[str] = None,
    ) -> str:
        """
        ç¹ªè£½å®Œæ•´è‚¡ç¥¨åˆ†æåœ–è¡¨
        
        Args:
            df: å«æœ‰åƒ¹æ ¼å’ŒæŒ‡æ¨™çš„ DataFrame
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            name: è‚¡ç¥¨åç¨±
            show_ma: é¡¯ç¤ºå‡ç·š
            show_bollinger: é¡¯ç¤ºå¸ƒæ—é€šé“
            show_volume: é¡¯ç¤ºæˆäº¤é‡
            show_rsi: é¡¯ç¤º RSI
            show_macd: é¡¯ç¤º MACD
            show_kd: é¡¯ç¤º KD
            show_signals: æ¨™è¨˜äº¤å‰è¨Šè™Ÿ
            days: é¡¯ç¤ºå¤©æ•¸
            save_path: å„²å­˜è·¯å¾‘ï¼ˆä¸æŒ‡å®šå‰‡è‡ªå‹•ç”Ÿæˆï¼‰
            
        Returns:
            åœ–è¡¨æª”æ¡ˆè·¯å¾‘
        """
        # åªå–æœ€è¿‘ N å¤©è³‡æ–™
        if len(df) > days:
            df = df.tail(days).copy()
        else:
            df = df.copy()
        
        # ç¢ºä¿ date æ¬„ä½æ­£ç¢º
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
            df = df.set_index('date')
        
        # è¨ˆç®—å­åœ–æ•¸é‡
        n_subplots = 1  # ä¸»åœ–
        if show_volume:
            n_subplots += 1
        if show_rsi:
            n_subplots += 1
        if show_macd:
            n_subplots += 1
        if show_kd:
            n_subplots += 1
        
        # è¨­å®šå­åœ–é«˜åº¦æ¯”ä¾‹
        height_ratios = [3]  # ä¸»åœ–
        if show_volume:
            height_ratios.append(1)
        if show_rsi:
            height_ratios.append(1)
        if show_macd:
            height_ratios.append(1.2)
        if show_kd:
            height_ratios.append(1)
        
        # å»ºç«‹åœ–è¡¨
        fig, axes = plt.subplots(
            n_subplots, 1,
            figsize=(14, 3 + n_subplots * 2),
            gridspec_kw={'height_ratios': height_ratios},
            sharex=True,
        )
        
        if n_subplots == 1:
            axes = [axes]
        
        ax_idx = 0
        
        # === ä¸»åœ–ï¼šåƒ¹æ ¼ + å‡ç·š + å¸ƒæ—é€šé“ ===
        ax_main = axes[ax_idx]
        ax_idx += 1
        
        self._plot_price(ax_main, df, show_ma, show_bollinger, show_signals)
        
        # æ¨™é¡Œ
        title = f"{symbol}"
        if name:
            title += f" - {name}"
        title += f"\næœ€å¾Œæ›´æ–°: {df.index[-1].strftime('%Y-%m-%d')} | æ”¶ç›¤: ${df['close'].iloc[-1]:.2f}"
        ax_main.set_title(title, fontsize=14, fontweight='bold', pad=10)
        
        # === æˆäº¤é‡ ===
        if show_volume:
            self._plot_volume(axes[ax_idx], df)
            ax_idx += 1
        
        # === RSI ===
        if show_rsi and 'rsi' in df.columns:
            self._plot_rsi(axes[ax_idx], df)
            ax_idx += 1
        
        # === MACD ===
        if show_macd and 'macd_dif' in df.columns:
            self._plot_macd(axes[ax_idx], df)
            ax_idx += 1
        
        # === KD ===
        if show_kd and 'kd_k' in df.columns:
            self._plot_kd(axes[ax_idx], df)
            ax_idx += 1
        
        # èª¿æ•´å¸ƒå±€
        plt.tight_layout()
        
        # å„²å­˜åœ–è¡¨
        if not save_path:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            save_path = self.output_dir / f"{symbol}_{timestamp}.png"
        
        plt.savefig(save_path, dpi=150, bbox_inches='tight', facecolor='white')
        plt.close(fig)
        
        logger.info(f"åœ–è¡¨å·²å„²å­˜: {save_path}")
        return str(save_path)
    
    def _plot_price(
        self,
        ax: plt.Axes,
        df: pd.DataFrame,
        show_ma: bool,
        show_bollinger: bool,
        show_signals: bool,
    ):
        """ç¹ªè£½åƒ¹æ ¼ä¸»åœ–"""
        # å¸ƒæ—é€šé“ï¼ˆå…ˆç•«ï¼Œä½œç‚ºèƒŒæ™¯ï¼‰
        if show_bollinger and 'bb_upper' in df.columns:
            ax.fill_between(
                df.index,
                df['bb_lower'],
                df['bb_upper'],
                color=COLORS['bb_fill'],
                alpha=0.5,
                label='å¸ƒæ—é€šé“',
            )
            ax.plot(df.index, df['bb_middle'], color=COLORS['bb_line'], 
                   linewidth=0.8, linestyle='--', alpha=0.7)
        
        # åƒ¹æ ¼ç·š
        ax.plot(df.index, df['close'], color=COLORS['price'], 
               linewidth=1.5, label='æ”¶ç›¤åƒ¹')
        
        # å‡ç·š
        if show_ma:
            ma_short = f"ma{settings.MA_SHORT}"
            ma_mid = f"ma{settings.MA_MID}"
            ma_long = f"ma{settings.MA_LONG}"
            
            if ma_short in df.columns:
                ax.plot(df.index, df[ma_short], color=COLORS['ma_short'],
                       linewidth=1, label=f'MA{settings.MA_SHORT}')
            if ma_mid in df.columns:
                ax.plot(df.index, df[ma_mid], color=COLORS['ma_mid'],
                       linewidth=1, label=f'MA{settings.MA_MID}')
            if ma_long in df.columns:
                ax.plot(df.index, df[ma_long], color=COLORS['ma_long'],
                       linewidth=1, label=f'MA{settings.MA_LONG}')
        
        # æ¨™è¨˜äº¤å‰è¨Šè™Ÿ
        if show_signals and show_ma:
            self._mark_crossovers(ax, df)
        
        # è¨­å®š
        ax.set_ylabel('åƒ¹æ ¼ ($)', fontsize=10)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        ax.set_xlim(df.index[0], df.index[-1])
    
    def _mark_crossovers(self, ax: plt.Axes, df: pd.DataFrame):
        """æ¨™è¨˜å‡ç·šäº¤å‰é»"""
        ma_short = f"ma{settings.MA_SHORT}"
        ma_mid = f"ma{settings.MA_MID}"
        
        if ma_short not in df.columns or ma_mid not in df.columns:
            return
        
        for i in range(1, len(df)):
            # é»ƒé‡‘äº¤å‰
            if (df[ma_short].iloc[i-1] < df[ma_mid].iloc[i-1] and 
                df[ma_short].iloc[i] > df[ma_mid].iloc[i]):
                ax.scatter(df.index[i], df['close'].iloc[i], 
                          color=COLORS['golden_cross'], s=100, marker='^', 
                          zorder=5, edgecolors='white', linewidths=1)
            
            # æ­»äº¡äº¤å‰
            elif (df[ma_short].iloc[i-1] > df[ma_mid].iloc[i-1] and 
                  df[ma_short].iloc[i] < df[ma_mid].iloc[i]):
                ax.scatter(df.index[i], df['close'].iloc[i], 
                          color=COLORS['death_cross'], s=100, marker='v', 
                          zorder=5, edgecolors='white', linewidths=1)
    
    def _plot_volume(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½æˆäº¤é‡"""
        colors = []
        for i in range(len(df)):
            if i == 0:
                colors.append(COLORS['volume_up'])
            elif df['close'].iloc[i] >= df['close'].iloc[i-1]:
                colors.append(COLORS['volume_up'])
            else:
                colors.append(COLORS['volume_down'])
        
        ax.bar(df.index, df['volume'], color=colors, alpha=0.7, width=0.8)
        
        # 20æ—¥å‡é‡ç·š
        if 'volume_ma20' in df.columns:
            ax.plot(df.index, df['volume_ma20'], color='orange', 
                   linewidth=1, label='20æ—¥å‡é‡')
            ax.legend(loc='upper left', fontsize=8)
        
        ax.set_ylabel('æˆäº¤é‡', fontsize=10)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        
        # æ ¼å¼åŒ– Y è»¸
        ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1e6:.1f}M'))
    
    def _plot_rsi(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½ RSI"""
        # è¶…è²·è¶…è³£å€åŸŸ
        ax.axhspan(settings.RSI_OVERBOUGHT, 100, color=COLORS['overbought'], alpha=0.3)
        ax.axhspan(0, settings.RSI_OVERSOLD, color=COLORS['oversold'], alpha=0.3)
        
        # ä¸­ç·š
        ax.axhline(y=50, color='gray', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=settings.RSI_OVERBOUGHT, color='red', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=settings.RSI_OVERSOLD, color='green', linestyle='--', linewidth=0.8, alpha=0.5)
        
        # RSI ç·š
        ax.plot(df.index, df['rsi'], color=COLORS['rsi'], linewidth=1.2, label='RSI')
        
        # è¨­å®š
        ax.set_ylabel('RSI', fontsize=10)
        ax.set_ylim(0, 100)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        
        # æ¨™è¨˜æœ€æ–°å€¼
        latest_rsi = df['rsi'].iloc[-1]
        if not pd.isna(latest_rsi):
            ax.annotate(f'{latest_rsi:.1f}', 
                       xy=(df.index[-1], latest_rsi),
                       xytext=(5, 0), textcoords='offset points',
                       fontsize=9, color=COLORS['rsi'])
    
    def _plot_macd(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½ MACD"""
        # é›¶è»¸
        ax.axhline(y=0, color='gray', linestyle='-', linewidth=0.8)
        
        # MACD æŸ±ç‹€åœ–
        colors = [COLORS['macd_hist_pos'] if v >= 0 else COLORS['macd_hist_neg'] 
                 for v in df['macd_hist']]
        ax.bar(df.index, df['macd_hist'], color=colors, alpha=0.6, width=0.8)
        
        # DIF å’Œ DEA ç·š
        ax.plot(df.index, df['macd_dif'], color=COLORS['macd_dif'], 
               linewidth=1.2, label='DIF')
        ax.plot(df.index, df['macd_dea'], color=COLORS['macd_dea'], 
               linewidth=1.2, label='DEA')
        
        # æ¨™è¨˜äº¤å‰é»
        for i in range(1, len(df)):
            if pd.isna(df['macd_dif'].iloc[i]) or pd.isna(df['macd_dea'].iloc[i]):
                continue
            # é»ƒé‡‘äº¤å‰
            if (df['macd_dif'].iloc[i-1] < df['macd_dea'].iloc[i-1] and 
                df['macd_dif'].iloc[i] > df['macd_dea'].iloc[i]):
                ax.scatter(df.index[i], df['macd_dif'].iloc[i], 
                          color=COLORS['golden_cross'], s=50, marker='^', zorder=5)
            # æ­»äº¡äº¤å‰
            elif (df['macd_dif'].iloc[i-1] > df['macd_dea'].iloc[i-1] and 
                  df['macd_dif'].iloc[i] < df['macd_dea'].iloc[i]):
                ax.scatter(df.index[i], df['macd_dif'].iloc[i], 
                          color=COLORS['death_cross'], s=50, marker='v', zorder=5)
        
        # è¨­å®š
        ax.set_ylabel('MACD', fontsize=10)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
    
    def _plot_kd(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½ KD"""
        # è¶…è²·è¶…è³£å€åŸŸ
        ax.axhspan(80, 100, color=COLORS['overbought'], alpha=0.3)
        ax.axhspan(0, 20, color=COLORS['oversold'], alpha=0.3)
        
        # ä¸­ç·š
        ax.axhline(y=50, color='gray', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=80, color='red', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=20, color='green', linestyle='--', linewidth=0.8, alpha=0.5)
        
        # K å’Œ D ç·š
        ax.plot(df.index, df['kd_k'], color=COLORS['kd_k'], linewidth=1.2, label='K')
        ax.plot(df.index, df['kd_d'], color=COLORS['kd_d'], linewidth=1.2, label='D')
        
        # è¨­å®š
        ax.set_ylabel('KD', fontsize=10)
        ax.set_ylim(0, 100)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        ax.set_xlabel('æ—¥æœŸ', fontsize=10)
    
    def plot_candlestick(
        self,
        df: pd.DataFrame,
        symbol: str,
        name: str = "",
        days: int = 60,
        save_path: Optional[str] = None,
    ) -> str:
        """
        ç¹ªè£½ K ç·šåœ–ï¼ˆä½¿ç”¨ mplfinanceï¼‰
        
        Args:
            df: OHLCV DataFrame
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            name: è‚¡ç¥¨åç¨±
            days: é¡¯ç¤ºå¤©æ•¸
            save_path: å„²å­˜è·¯å¾‘
            
        Returns:
            åœ–è¡¨æª”æ¡ˆè·¯å¾‘
        """
        try:
            import mplfinance as mpf
        except ImportError:
            logger.warning("mplfinance æœªå®‰è£ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ")
            return self._plot_candlestick_fallback(df, symbol, name, days, save_path)
        
        # æº–å‚™è³‡æ–™
        if len(df) > days:
            df = df.tail(days).copy()
        else:
            df = df.copy()
        
        # ç¢ºä¿ç´¢å¼•ç‚º DatetimeIndex
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
            df = df.set_index('date')
        
        # ç¢ºä¿æ¬„ä½åç¨±æ­£ç¢ºï¼ˆmplfinance éœ€è¦å¤§å¯«ï¼‰
        df = df.rename(columns={
            'open': 'Open',
            'high': 'High',
            'low': 'Low',
            'close': 'Close',
            'volume': 'Volume',
        })
        
        # æº–å‚™å‡ç·š
        ma_short = f"ma{settings.MA_SHORT}"
        ma_mid = f"ma{settings.MA_MID}"
        ma_long = f"ma{settings.MA_LONG}"
        
        addplots = []
        if ma_short in df.columns:
            addplots.append(mpf.make_addplot(df[ma_short], color=COLORS['ma_short']))
        if ma_mid in df.columns:
            addplots.append(mpf.make_addplot(df[ma_mid], color=COLORS['ma_mid']))
        if ma_long in df.columns:
            addplots.append(mpf.make_addplot(df[ma_long], color=COLORS['ma_long']))
        
        # è¨­å®šæ¨£å¼
        mc = mpf.make_marketcolors(
            up='#4CAF50',
            down='#F44336',
            edge='inherit',
            wick='inherit',
            volume='inherit',
        )
        style = mpf.make_mpf_style(
            marketcolors=mc,
            gridstyle='-',
            gridcolor=COLORS['grid'],
        )
        
        # å„²å­˜è·¯å¾‘
        if not save_path:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            save_path = self.output_dir / f"{symbol}_kline_{timestamp}.png"
        
        # æ¨™é¡Œ
        title = f"{symbol}"
        if name:
            title += f" - {name}"
        
        # ç¹ªè£½
        mpf.plot(
            df,
            type='candle',
            style=style,
            title=title,
            ylabel='åƒ¹æ ¼ ($)',
            ylabel_lower='æˆäº¤é‡',
            volume=True,
            addplot=addplots if addplots else None,
            figsize=(14, 8),
            savefig=str(save_path),
        )
        
        logger.info(f"Kç·šåœ–å·²å„²å­˜: {save_path}")
        return str(save_path)
    
    def _plot_candlestick_fallback(
        self,
        df: pd.DataFrame,
        symbol: str,
        name: str,
        days: int,
        save_path: Optional[str],
    ) -> str:
        """ç•¶ mplfinance ä¸å¯ç”¨æ™‚çš„æ›¿ä»£ K ç·šåœ–"""
        if len(df) > days:
            df = df.tail(days).copy()
        else:
            df = df.copy()
        
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
            df = df.set_index('date')
        
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(14, 8), 
                                        gridspec_kw={'height_ratios': [3, 1]},
                                        sharex=True)
        
        # K ç·š
        width = 0.6
        width2 = 0.1
        
        up = df[df['close'] >= df['open']]
        down = df[df['close'] < df['open']]
        
        # ä¸Šæ¼² K ç·š
        ax1.bar(up.index, up['close'] - up['open'], width, bottom=up['open'], 
               color='#4CAF50', edgecolor='#4CAF50')
        ax1.bar(up.index, up['high'] - up['close'], width2, bottom=up['close'], 
               color='#4CAF50')
        ax1.bar(up.index, up['low'] - up['open'], width2, bottom=up['open'], 
               color='#4CAF50')
        
        # ä¸‹è·Œ K ç·š
        ax1.bar(down.index, down['close'] - down['open'], width, bottom=down['open'], 
               color='#F44336', edgecolor='#F44336')
        ax1.bar(down.index, down['high'] - down['open'], width2, bottom=down['open'], 
               color='#F44336')
        ax1.bar(down.index, down['low'] - down['close'], width2, bottom=down['close'], 
               color='#F44336')
        
        # æ¨™é¡Œ
        title = f"{symbol}"
        if name:
            title += f" - {name}"
        ax1.set_title(title, fontsize=14, fontweight='bold')
        ax1.set_ylabel('åƒ¹æ ¼ ($)')
        ax1.grid(True, alpha=0.3)
        
        # æˆäº¤é‡
        colors = ['#4CAF50' if df['close'].iloc[i] >= df['open'].iloc[i] 
                 else '#F44336' for i in range(len(df))]
        ax2.bar(df.index, df['volume'], color=colors, alpha=0.7)
        ax2.set_ylabel('æˆäº¤é‡')
        ax2.grid(True, alpha=0.3)
        
        plt.tight_layout()
        
        if not save_path:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            save_path = self.output_dir / f"{symbol}_kline_{timestamp}.png"
        
        plt.savefig(save_path, dpi=150, bbox_inches='tight', facecolor='white')
        plt.close(fig)
        
        return str(save_path)


# å»ºç«‹é è¨­å¯¦ä¾‹
chart_service = ChartService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/compare_service.py  â­â­â­
> å ±é…¬ç‡æ¯”è¼ƒæœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å ±é…¬ç‡æ¯”è¼ƒæœå‹™
è¨ˆç®—ä¸¦æ¯”è¼ƒå¤šå€‹æ¨™çš„çš„å¹´åŒ–å ±é…¬ç‡ (CAGR)

ä¿®å¾©ï¼š
1. å°è‚¡ä»£è™Ÿè‡ªå‹•åŠ  .TW / .TWO
2. ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼(adj_close)è¨ˆç®—ï¼Œé¿å…åˆ†å‰²å½±éŸ¿
3. åŠ å…¥é…æ¯é‚„åŸï¼Œåæ˜ çœŸå¯¦å ±é…¬
"""
import logging
from datetime import datetime, date, timedelta
from typing import List, Dict, Any, Optional, Tuple
import json
import math

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_
import pandas as pd

from app.models.comparison import Comparison
from app.data_sources.yahoo_finance import yahoo_finance
from app.data_sources.coingecko import coingecko, CRYPTO_MAP

logger = logging.getLogger(__name__)


# é è¨­æ¯”è¼ƒçµ„åˆ
PRESET_GROUPS = {
    "us_tech": {
        "name": "ç¾åœ‹ç§‘æŠ€è‚¡",
        "symbols": ["AAPL", "MSFT", "GOOGL", "AMZN", "NVDA"],
        "description": "ç¾åœ‹äº”å¤§ç§‘æŠ€å·¨é ­"
    },
    "crypto_major": {
        "name": "ä¸»æµåŠ å¯†è²¨å¹£",
        "symbols": ["BTC", "ETH", "SOL", "BNB", "XRP"],
        "description": "å¸‚å€¼å‰äº”å¤§åŠ å¯†è²¨å¹£"
    },
    "index": {
        "name": "å¤§ç›¤æŒ‡æ•¸",
        "symbols": ["^GSPC", "^IXIC", "^DJI"],
        "description": "ç¾åœ‹ä¸‰å¤§æŒ‡æ•¸"
    },
    "etf_popular": {
        "name": "ç†±é–€ ETF",
        "symbols": ["SPY", "QQQ", "VOO", "VTI", "IWM"],
        "description": "æœ€å—æ­¡è¿çš„ ETF"
    },
    "dividend": {
        "name": "é«˜è‚¡æ¯è‚¡ç¥¨",
        "symbols": ["JNJ", "PG", "KO", "PEP", "VZ"],
        "description": "ç©©å®šé…æ¯çš„è—ç±Œè‚¡"
    },
    "tw_etf": {
        "name": "å°è‚¡ ETF",
        "symbols": ["0050", "0056", "00878", "00919", "006208"],
        "description": "å°ç£ç†±é–€ ETF"
    },
    "tw_tech": {
        "name": "å°ç£ç§‘æŠ€è‚¡",
        "symbols": ["2330", "2454", "2317", "3711", "2308"],
        "description": "å°ç£ç§‘æŠ€æ¬Šå€¼è‚¡"
    }
}

# åŸºæº–æŒ‡æ•¸é¸é …
BENCHMARK_OPTIONS = {
    "^GSPC": "S&P 500",
    "^IXIC": "ç´æ–¯é”å…‹",
    "^DJI": "é“ç“Šå·¥æ¥­",
    "": "ç„¡"
}

# æ”¯æ´çš„åŠ å¯†è²¨å¹£
SUPPORTED_CRYPTO = set(k for k in CRYPTO_MAP.keys() if k not in ("BITCOIN", "ETHEREUM"))


class CompareService:
    """å ±é…¬ç‡æ¯”è¼ƒæœå‹™"""
    
    def __init__(self):
        self.max_symbols = 5  # æœ€å¤šæ¯”è¼ƒ 5 å€‹
    
    def _normalize_symbol(self, symbol: str) -> str:
        """
        æ¨™æº–åŒ–è‚¡ç¥¨ä»£è™Ÿ
        - å°è‚¡ä»£è™Ÿï¼ˆç´”æ•¸å­— 4-6 ä½ï¼‰è‡ªå‹•åŠ  .TW
        - å…¶ä»–ä¿æŒåŸæ¨£
        """
        symbol = symbol.strip().upper()
        
        # å¦‚æœå·²ç¶“æœ‰å¾Œç¶´ï¼Œä¸è™•ç†
        if '.' in symbol or symbol.startswith('^'):
            return symbol
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£
        if symbol in SUPPORTED_CRYPTO:
            return symbol
        
        # å°è‚¡ä»£è™Ÿï¼š4-6 ä½ç´”æ•¸å­—
        if symbol.isdigit() and 4 <= len(symbol) <= 6:
            return f"{symbol}.TW"
        
        return symbol
    
    def _get_asset_type(self, symbol: str) -> str:
        """åˆ¤æ–·è³‡ç”¢é¡å‹"""
        symbol_upper = symbol.upper()
        
        # å…ˆæª¢æŸ¥åŸå§‹ä»£è™Ÿæ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£
        base_symbol = symbol_upper.replace('.TW', '').replace('.TWO', '')
        if base_symbol in SUPPORTED_CRYPTO:
            return "crypto"
        
        if symbol_upper.startswith("^"):
            return "index"
        elif symbol_upper.endswith(".TW") or symbol_upper.endswith(".TWO"):
            return "tw_stock"
        else:
            return "stock"
    
    def _get_period_days(self, period: str) -> int:
        """å–å¾—æ™‚é–“é€±æœŸå°æ‡‰çš„å¤©æ•¸"""
        period_map = {
            "1y": 365,
            "3y": 365 * 3,
            "5y": 365 * 5,
            "10y": 365 * 10,
        }
        return period_map.get(period, 365)
    
    async def _fetch_price_data(
        self,
        symbol: str,
        days: int = 3650,  # é è¨­æŠ“ 10 å¹´
    ) -> Tuple[Optional[pd.DataFrame], Optional[Dict]]:
        """
        æŠ“å–åƒ¹æ ¼è³‡æ–™
        
        Returns:
            (DataFrame, info_dict) æˆ– (None, None)
        """
        asset_type = self._get_asset_type(symbol)
        
        try:
            if asset_type == "crypto":
                # åŠ å¯†è²¨å¹£ç”¨ CoinGecko
                df = coingecko.get_crypto_history(symbol, days=days)
                info = coingecko.get_crypto_info(symbol)
                if info:
                    info_dict = {
                        "name": info.get("name", symbol),
                        "type": "crypto",
                        "current_price": info.get("current_price"),
                    }
                else:
                    info_dict = {"name": symbol, "type": "crypto", "current_price": None}
                return df, info_dict
            else:
                # è‚¡ç¥¨/æŒ‡æ•¸/ETF ç”¨ Yahoo Finance
                period = "10y" if days >= 3650 else ("5y" if days >= 1825 else "1y")
                df = yahoo_finance.get_stock_history(symbol, period=period)
                
                # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO (ä¸Šæ«ƒè‚¡ç¥¨)
                if (df is None or df.empty) and symbol.endswith('.TW'):
                    two_symbol = symbol.replace('.TW', '.TWO')
                    logger.info(f"{symbol} æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
                    df = yahoo_finance.get_stock_history(two_symbol, period=period)
                    if df is not None and not df.empty:
                        symbol = two_symbol
                        logger.info(f"æˆåŠŸæ‰¾åˆ°ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
                
                info = yahoo_finance.get_stock_info(symbol)
                
                # å–å¾—ç¾åƒ¹ï¼ˆç”¨åŸå§‹æ”¶ç›¤åƒ¹ï¼‰
                current_price = None
                if df is not None and not df.empty:
                    current_price = float(df['close'].iloc[-1])
                
                if info:
                    info_dict = {
                        "name": info.get("name", symbol),
                        "type": asset_type,
                        "current_price": current_price or info.get("current_price"),
                        "symbol": symbol,  # å¯èƒ½å·²ç¶“æ”¹æˆ .TWO
                    }
                else:
                    info_dict = {
                        "name": symbol, 
                        "type": asset_type, 
                        "current_price": current_price,
                        "symbol": symbol,
                    }
                
                return df, info_dict
            
        except Exception as e:
            logger.error(f"æŠ“å– {symbol} è³‡æ–™å¤±æ•—: {e}")
            return None, None
    
    def _calculate_cagr_with_dividends(
        self,
        symbol: str,
        df: pd.DataFrame,
        years: int,
    ) -> Optional[float]:
        """
        è¨ˆç®—å«é…æ¯èª¿æ•´çš„ CAGR
        
        ä½¿ç”¨ adj_closeï¼ˆåˆ†å‰²èª¿æ•´ï¼‰+ é…æ¯é‚„åŸ
        é€™å’Œè‚¡ç¥¨æŸ¥è©¢é é¢çš„è¨ˆç®—æ–¹å¼ä¸€è‡´
        """
        if df is None or df.empty:
            return None
        
        try:
            # ç¢ºä¿æœ‰ date æ¬„ä½
            if 'date' not in df.columns:
                df = df.reset_index()
                if 'Date' in df.columns:
                    df = df.rename(columns={'Date': 'date'})
            
            df['date'] = pd.to_datetime(df['date']).dt.date
            df = df.sort_values('date').reset_index(drop=True)
            
            current_date = df['date'].iloc[-1]
            target_date = current_date - timedelta(days=years * 365)
            
            # æ‰¾åˆ°ç›®æ¨™æ—¥æœŸä¹‹å‰çš„è³‡æ–™
            past_df = df[df['date'] <= target_date]
            
            if past_df.empty or len(past_df) < 10:
                return None
            
            # å„ªå…ˆä½¿ç”¨ adj_closeï¼Œæ²’æœ‰å‰‡ç”¨ close
            price_col = 'adj_close' if 'adj_close' in df.columns else 'close'
            
            start_row = past_df.iloc[-1]
            start_price = float(start_row[price_col])
            start_date = start_row['date']
            
            current_price = float(df.iloc[-1][price_col])
            
            if start_price <= 0:
                return None
            
            # å–å¾—é…æ¯è³‡æ–™ä¸¦èª¿æ•´
            try:
                dividends_df = yahoo_finance.get_dividends(symbol, period=f"{years + 1}y")
                
                if dividends_df is not None and not dividends_df.empty:
                    # å»ºç«‹å«é…æ¯èª¿æ•´çš„åƒ¹æ ¼åºåˆ—
                    df_adj = df.copy()
                    df_adj['adj_with_div'] = df_adj[price_col].astype(float)
                    
                    date_to_idx = {row['date']: idx for idx, row in df_adj.iterrows()}
                    
                    # ç¯©é¸åœ¨è¨ˆç®—ç¯„åœå…§çš„é…æ¯
                    min_date = df_adj['date'].min()
                    max_date = df_adj['date'].max()
                    
                    dividends = {}
                    for _, row in dividends_df.iterrows():
                        div_date = row['date']
                        if isinstance(div_date, str):
                            div_date = datetime.strptime(div_date, '%Y-%m-%d').date()
                        elif hasattr(div_date, 'date'):
                            div_date = div_date.date()
                        if min_date < div_date <= max_date:
                            dividends[div_date] = float(row['amount'])
                    
                    # å¾æœ€æ–°åˆ°æœ€èˆŠè™•ç†é…æ¯ï¼ˆé…æ¯é‚„åŸèª¿æ•´ï¼‰
                    for div_date, div_amount in sorted(dividends.items(), reverse=True):
                        if div_date in date_to_idx:
                            ex_idx = date_to_idx[div_date]
                            if ex_idx > 0:
                                prev_price = df_adj.loc[ex_idx - 1, 'adj_with_div']
                                if prev_price > div_amount and div_amount > 0:
                                    adjustment_factor = prev_price / (prev_price - div_amount)
                                    df_adj.loc[:ex_idx-1, 'adj_with_div'] = df_adj.loc[:ex_idx-1, 'adj_with_div'] / adjustment_factor
                    
                    # ä½¿ç”¨èª¿æ•´å¾Œçš„åƒ¹æ ¼è¨ˆç®—
                    start_price = float(df_adj[df_adj['date'] <= target_date].iloc[-1]['adj_with_div'])
                    current_price = float(df_adj.iloc[-1]['adj_with_div'])
                    
                    logger.debug(f"{symbol} é…æ¯èª¿æ•´: æ‰¾åˆ° {len(dividends)} ç­†é…æ¯")
                    
            except Exception as e:
                logger.warning(f"{symbol} é…æ¯èª¿æ•´å¤±æ•—ï¼Œä½¿ç”¨åŸºæœ¬è¨ˆç®—: {e}")
            
            # å¯¦éš›å¹´æ•¸ï¼ˆæ›´ç²¾ç¢ºï¼‰
            actual_days = (current_date - start_date).days
            actual_years = actual_days / 365.25
            
            if actual_years < 0.5:
                return None
            
            # CAGR å…¬å¼
            cagr = (current_price / start_price) ** (1 / actual_years) - 1
            
            # æª¢æŸ¥æœ‰æ•ˆæ€§
            if math.isnan(cagr) or math.isinf(cagr):
                return None
            
            return round(cagr * 100, 2)
            
        except Exception as e:
            logger.error(f"è¨ˆç®— {symbol} CAGR å¤±æ•—: {e}")
            return None
    
    def _calculate_custom_cagr(
        self,
        df: pd.DataFrame,
        start_date: date,
        end_date: date,
    ) -> Optional[float]:
        """è¨ˆç®—è‡ªè¨‚å€é–“çš„ CAGR"""
        if df is None or df.empty:
            return None
        
        try:
            # ç¢ºä¿æ—¥æœŸæ¬„ä½
            if 'date' in df.columns:
                df = df.set_index('date')
            
            # ç¯©é¸æ—¥æœŸç¯„åœ
            mask = (df.index >= pd.Timestamp(start_date)) & (df.index <= pd.Timestamp(end_date))
            filtered_df = df[mask]
            
            if len(filtered_df) < 2:
                return None
            
            # å„ªå…ˆä½¿ç”¨ adj_close
            price_col = 'adj_close' if 'adj_close' in filtered_df.columns else 'close'
            
            start_price = float(filtered_df[price_col].iloc[0])
            end_price = float(filtered_df[price_col].iloc[-1])
            
            # è¨ˆç®—å¹´æ•¸
            days = (end_date - start_date).days
            years = days / 365.0
            
            if years <= 0 or start_price <= 0:
                return None
            
            # CAGR å…¬å¼
            cagr = (end_price / start_price) ** (1 / years) - 1
            return round(cagr * 100, 2)
            
        except Exception as e:
            logger.error(f"è¨ˆç®—è‡ªè¨‚ CAGR å¤±æ•—: {e}")
            return None
    
    async def compare_cagr(
        self,
        symbols: List[str],
        periods: List[str] = None,
        custom_range: Dict[str, str] = None,
        benchmark: str = "^GSPC",
        sort_by: str = "5y",
        sort_order: str = "desc",
    ) -> Dict[str, Any]:
        """
        æ¯”è¼ƒå¤šå€‹æ¨™çš„çš„å¹´åŒ–å ±é…¬ç‡
        
        Args:
            symbols: æ¨™çš„ä»£è™Ÿåˆ—è¡¨ (æœ€å¤š 5 å€‹)
            periods: æ™‚é–“é€±æœŸ ["1y", "3y", "5y", "10y"]
            custom_range: è‡ªè¨‚å€é–“ {"start": "2020-01-01", "end": "2024-12-31"}
            benchmark: åŸºæº–æŒ‡æ•¸
            sort_by: æ’åºä¾æ“š
            sort_order: æ’åºæ–¹å‘ "asc" / "desc"
            
        Returns:
            æ¯”è¼ƒçµæœ
        """
        # é©—è­‰
        if not symbols:
            return {"success": False, "error": "è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™çš„"}
        
        if len(symbols) > self.max_symbols:
            return {"success": False, "error": f"æœ€å¤šåªèƒ½æ¯”è¼ƒ {self.max_symbols} å€‹æ¨™çš„"}
        
        if periods is None:
            periods = ["1y", "3y", "5y"]
        
        # æ­£è¦åŒ–ä»£è™Ÿï¼ˆè™•ç†å°è‚¡ç­‰ï¼‰
        symbols = [self._normalize_symbol(s) for s in symbols]
        logger.info(f"æ¨™æº–åŒ–å¾Œçš„ä»£è™Ÿ: {symbols}")
        
        # è¨ˆç®—éœ€è¦çš„å¤©æ•¸
        max_days = 3650  # 10 å¹´
        if custom_range:
            try:
                start_date = datetime.strptime(custom_range["start"], "%Y-%m-%d").date()
                end_date = datetime.strptime(custom_range["end"], "%Y-%m-%d").date()
                custom_days = (date.today() - start_date).days
                max_days = max(max_days, custom_days)
            except (ValueError, KeyError):
                custom_range = None
        
        results = []
        
        # è™•ç†æ¯å€‹æ¨™çš„
        for symbol in symbols:
            df, info = await self._fetch_price_data(symbol, max_days)
            
            # å¦‚æœæœ‰ symbol æ›´æ–°ï¼ˆä¾‹å¦‚ .TW -> .TWOï¼‰ï¼Œä½¿ç”¨æ›´æ–°å¾Œçš„
            actual_symbol = info.get("symbol", symbol) if info else symbol
            
            if df is None or info is None:
                results.append({
                    "symbol": actual_symbol,
                    "name": actual_symbol,
                    "type": self._get_asset_type(actual_symbol),
                    "current_price": None,
                    "cagr": {p: None for p in periods},
                    "error": "ç„¡æ³•å–å¾—è³‡æ–™"
                })
                continue
            
            # è¨ˆç®—å„é€±æœŸ CAGRï¼ˆä½¿ç”¨å«é…æ¯çš„è¨ˆç®—ï¼‰
            cagr_results = {}
            for period in periods:
                period_years = {"1y": 1, "3y": 3, "5y": 5, "10y": 10}.get(period)
                if period_years:
                    cagr_results[period] = self._calculate_cagr_with_dividends(
                        actual_symbol, df, period_years
                    )
            
            # è‡ªè¨‚å€é–“
            if custom_range:
                cagr_results["custom"] = self._calculate_custom_cagr(
                    df, start_date, end_date
                )
            
            results.append({
                "symbol": actual_symbol,
                "name": info.get("name", actual_symbol),
                "type": info.get("type", "stock"),
                "current_price": info.get("current_price"),
                "cagr": cagr_results,
            })
        
        # è¨ˆç®—åŸºæº–æŒ‡æ•¸
        benchmark_data = None
        if benchmark:
            benchmark_df, benchmark_info = await self._fetch_price_data(benchmark, max_days)
            if benchmark_df is not None:
                benchmark_cagr = {}
                for period in periods:
                    period_years = {"1y": 1, "3y": 3, "5y": 5, "10y": 10}.get(period)
                    if period_years:
                        benchmark_cagr[period] = self._calculate_cagr_with_dividends(
                            benchmark, benchmark_df, period_years
                        )
                
                benchmark_data = {
                    "symbol": benchmark,
                    "name": BENCHMARK_OPTIONS.get(benchmark, benchmark),
                    "cagr": benchmark_cagr,
                }
                
                # è¨ˆç®— vs benchmark
                for result in results:
                    result["vs_benchmark"] = {}
                    for period in periods:
                        result_cagr = result["cagr"].get(period)
                        bench_cagr = benchmark_cagr.get(period)
                        if result_cagr is not None and bench_cagr is not None:
                            result["vs_benchmark"][period] = round(result_cagr - bench_cagr, 2)
                        else:
                            result["vs_benchmark"][period] = None
        
        # æ’åº
        def get_sort_value(item):
            val = item.get("cagr", {}).get(sort_by)
            return val if val is not None else float('-inf')
        
        results.sort(key=get_sort_value, reverse=(sort_order == "desc"))
        
        # åŠ å…¥æ’å
        for i, result in enumerate(results):
            result["rank"] = i + 1
        
        return {
            "success": True,
            "comparison": results,
            "benchmark": benchmark_data,
            "periods": periods + (["custom"] if custom_range else []),
            "custom_range": custom_range,
            "sort_by": sort_by,
            "generated_at": datetime.now().isoformat(),
            "note": "CAGR å·²åŒ…å«åˆ†å‰²èª¿æ•´åŠé…æ¯å†æŠ•å…¥æ•ˆæœ"
        }
    
    def get_presets(self) -> List[Dict[str, Any]]:
        """å–å¾—é è¨­çµ„åˆåˆ—è¡¨"""
        return [
            {
                "id": key,
                "name": value["name"],
                "description": value["description"],
                "symbols": value["symbols"],
                "count": len(value["symbols"]),
            }
            for key, value in PRESET_GROUPS.items()
        ]
    
    def get_preset_detail(self, preset_id: str) -> Optional[Dict[str, Any]]:
        """å–å¾—é è¨­çµ„åˆè©³æƒ…"""
        if preset_id not in PRESET_GROUPS:
            return None
        
        preset = PRESET_GROUPS[preset_id]
        return {
            "id": preset_id,
            "name": preset["name"],
            "description": preset["description"],
            "symbols": preset["symbols"],
        }


class ComparisonCRUD:
    """æ¯”è¼ƒçµ„åˆ CRUD æ“ä½œ"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def get_user_comparisons(self, user_id: int) -> List[Comparison]:
        """å–å¾—ç”¨æˆ¶çš„æ¯”è¼ƒçµ„åˆ"""
        result = await self.db.execute(
            select(Comparison)
            .where(Comparison.user_id == user_id)
            .order_by(Comparison.updated_at.desc())
        )
        return result.scalars().all()
    
    async def get_comparison_by_id(self, comparison_id: int, user_id: int) -> Optional[Comparison]:
        """å–å¾—å–®ä¸€æ¯”è¼ƒçµ„åˆ"""
        result = await self.db.execute(
            select(Comparison)
            .where(and_(Comparison.id == comparison_id, Comparison.user_id == user_id))
        )
        return result.scalar_one_or_none()
    
    async def create_comparison(
        self,
        user_id: int,
        name: str,
        symbols: List[str],
        benchmark: str = None,
    ) -> Comparison:
        """å»ºç«‹æ¯”è¼ƒçµ„åˆ"""
        comparison = Comparison(
            user_id=user_id,
            name=name,
            _symbols=json.dumps(symbols),
            benchmark=benchmark,
        )
        self.db.add(comparison)
        await self.db.commit()
        await self.db.refresh(comparison)
        return comparison
    
    async def update_comparison(
        self,
        comparison: Comparison,
        name: str = None,
        symbols: List[str] = None,
        benchmark: str = None,
    ) -> Comparison:
        """æ›´æ–°æ¯”è¼ƒçµ„åˆ"""
        if name is not None:
            comparison.name = name
        if symbols is not None:
            comparison._symbols = json.dumps(symbols)
        if benchmark is not None:
            comparison.benchmark = benchmark
        
        await self.db.commit()
        await self.db.refresh(comparison)
        return comparison
    
    async def delete_comparison(self, comparison: Comparison) -> bool:
        """åˆªé™¤æ¯”è¼ƒçµ„åˆ"""
        await self.db.delete(comparison)
        await self.db.commit()
        return True
    
    async def count_user_comparisons(self, user_id: int) -> int:
        """è¨ˆç®—ç”¨æˆ¶çš„æ¯”è¼ƒçµ„åˆæ•¸é‡"""
        result = await self.db.execute(
            select(Comparison)
            .where(Comparison.user_id == user_id)
        )
        return len(result.scalars().all())


# å–®ä¾‹
compare_service = CompareService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/compare_service_patch.py  â­â­â­
> compare_service.py å°è‚¡åç¨±ä¿®å¾©è£œä¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
compare_service.py å°è‚¡åç¨±ä¿®å¾©è£œä¸

å•é¡Œä½ç½®: _fetch_price_data æ–¹æ³•ä¸­çš„åç¨±å–å¾—é‚è¼¯
å•é¡Œä»£ç¢¼ (ç´„ç¬¬ 7529-7542 è¡Œ):
    if info:
        info_dict = {
            "name": info.get("name", symbol),  # âš ï¸ é€™è£¡ç›´æ¥ç”¨ infoï¼Œæœƒæœ‰äº‚ç¢¼
            ...
        }

ä¿®å¾©: å°è‚¡å„ªå…ˆä½¿ç”¨ TAIWAN_STOCK_NAMES å­—å…¸
"""

# ============================================================
# æ­¥é©Ÿ 1: åœ¨ compare_service.py é–‹é ­åŠ å…¥å°å…¥
# ============================================================
# æ‰¾åˆ°ç¾æœ‰çš„ import å€å¡Šï¼Œåœ¨æœ€å¾ŒåŠ å…¥ï¼š

# from app.data_sources.taiwan_stocks import TAIWAN_STOCK_NAMES, is_taiwan_stock


# ============================================================
# æ­¥é©Ÿ 2: ä¿®æ”¹ _fetch_price_data æ–¹æ³•
# ============================================================
# æ‰¾åˆ°é€™æ®µä»£ç¢¼ (ç´„åœ¨ 7529-7542 è¡Œ):

"""
åŸå§‹ä»£ç¢¼:
                if info:
                    info_dict = {
                        "name": info.get("name", symbol),
                        "type": asset_type,
                        "current_price": current_price or info.get("current_price"),
                        "symbol": symbol,
                    }
                else:
                    info_dict = {
                        "name": symbol, 
                        "type": asset_type, 
                        "current_price": current_price,
                        "symbol": symbol,
                    }
"""

# æ›¿æ›ç‚º:

"""
ä¿®å¾©å¾Œä»£ç¢¼:
                # ========== ä¿®å¾©: å°è‚¡å„ªå…ˆä½¿ç”¨æœ¬åœ°åç¨±å­—å…¸ ==========
                name = symbol
                if is_taiwan_stock(symbol):
                    stock_code = symbol.replace('.TW', '').replace('.TWO', '')
                    name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
                elif info:
                    name = info.get("name", symbol)
                # ================================================
                
                if info:
                    info_dict = {
                        "name": name,  # ä½¿ç”¨ä¿®å¾©å¾Œçš„åç¨±
                        "type": asset_type,
                        "current_price": current_price or info.get("current_price"),
                        "symbol": symbol,
                    }
                else:
                    info_dict = {
                        "name": name,  # ä½¿ç”¨ä¿®å¾©å¾Œçš„åç¨±
                        "type": asset_type, 
                        "current_price": current_price,
                        "symbol": symbol,
                    }
"""


# ============================================================
# å®Œæ•´çš„ä¿®å¾©å¾Œ _fetch_price_data æ–¹æ³• (å¯ç›´æ¥è¤‡è£½æ›¿æ›)
# ============================================================

async def _fetch_price_data(
    self,
    symbol: str,
    days: int = 3650,
):
    """
    æŠ“å–åƒ¹æ ¼è³‡æ–™ (ä¿®å¾©ç‰ˆ - è§£æ±ºå°è‚¡åç¨±äº‚ç¢¼)
    
    Returns:
        (DataFrame, info_dict) æˆ– (None, None)
    """
    asset_type = self._get_asset_type(symbol)
    
    try:
        if asset_type == "crypto":
            # åŠ å¯†è²¨å¹£ç”¨ CoinGecko
            df = coingecko.get_crypto_history(symbol, days=days)
            info = coingecko.get_crypto_info(symbol)
            if info:
                info_dict = {
                    "name": info.get("name", symbol),
                    "type": "crypto",
                    "current_price": info.get("current_price"),
                }
            else:
                info_dict = {"name": symbol, "type": "crypto", "current_price": None}
            return df, info_dict
        else:
            # è‚¡ç¥¨/æŒ‡æ•¸/ETF ç”¨ Yahoo Finance
            period = "10y" if days >= 3650 else ("5y" if days >= 1825 else "1y")
            df = yahoo_finance.get_stock_history(symbol, period=period)
            
            # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO (ä¸Šæ«ƒè‚¡ç¥¨)
            if (df is None or df.empty) and symbol.endswith('.TW'):
                two_symbol = symbol.replace('.TW', '.TWO')
                logger.info(f"{symbol} æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
                df = yahoo_finance.get_stock_history(two_symbol, period=period)
                if df is not None and not df.empty:
                    symbol = two_symbol
                    logger.info(f"æˆåŠŸæ‰¾åˆ°ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
            
            info = yahoo_finance.get_stock_info(symbol)
            
            # å–å¾—ç¾åƒ¹ï¼ˆç”¨åŸå§‹æ”¶ç›¤åƒ¹ï¼‰
            current_price = None
            if df is not None and not df.empty:
                current_price = float(df['close'].iloc[-1])
            
            # ========== ä¿®å¾©: å°è‚¡å„ªå…ˆä½¿ç”¨æœ¬åœ°åç¨±å­—å…¸ ==========
            name = symbol
            if is_taiwan_stock(symbol):
                stock_code = symbol.replace('.TW', '').replace('.TWO', '')
                name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
                logger.debug(f"å°è‚¡åç¨±ä¿®å¾©: {symbol} -> {name}")
            elif info:
                name = info.get("name", symbol)
            # ================================================
            
            if info:
                info_dict = {
                    "name": name,  # ä½¿ç”¨ä¿®å¾©å¾Œçš„åç¨±
                    "type": asset_type,
                    "current_price": current_price or info.get("current_price"),
                    "symbol": symbol,
                }
            else:
                info_dict = {
                    "name": name,  # ä½¿ç”¨ä¿®å¾©å¾Œçš„åç¨±
                    "type": asset_type, 
                    "current_price": current_price,
                    "symbol": symbol,
                }
            
            return df, info_dict
        
    except Exception as e:
        logger.error(f"æŠ“å– {symbol} è³‡æ–™å¤±æ•—: {e}")
        return None, None
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/crypto_service.py  â­â­â­
> åŠ å¯†è²¨å¹£æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŠ å¯†è²¨å¹£æœå‹™
æ•´åˆ CoinGecko è³‡æ–™ã€å¿«å–å’ŒæŠ€è¡“æŒ‡æ¨™è¨ˆç®—
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Dict, Any, List
from sqlalchemy.orm import Session
from sqlalchemy import select, and_
import logging

from app.models.crypto_price import CryptoPrice
from app.models.market_sentiment import MarketSentiment
from app.data_sources.coingecko import coingecko
from app.data_sources.fear_greed import fear_greed
from app.services.indicator_service import indicator_service, TrendDirection
from app.config import settings

logger = logging.getLogger(__name__)


class CryptoService:
    """åŠ å¯†è²¨å¹£æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def _is_cache_valid(self, symbol: str) -> bool:
        """æª¢æŸ¥å¿«å–æ˜¯å¦æœ‰æ•ˆ"""
        today = date.today()
        
        stmt = (
            select(CryptoPrice)
            .where(CryptoPrice.symbol == symbol.upper())
            .order_by(CryptoPrice.date.desc())
            .limit(1)
        )
        result = self.db.execute(stmt).scalar_one_or_none()
        
        if not result:
            return False
        
        # åŠ å¯†è²¨å¹£å¸‚å ´ 24/7ï¼Œæª¢æŸ¥æ›´æ–°æ™‚é–“
        if result.updated_at:
            cache_minutes = settings.CRYPTO_DATA_CACHE_MINUTES
            cache_deadline = datetime.now() - timedelta(minutes=cache_minutes)
            if result.updated_at > cache_deadline:
                return True
        
        return False
    
    def _save_prices_to_db(self, df: pd.DataFrame) -> int:
        """å„²å­˜åƒ¹æ ¼è³‡æ–™åˆ°è³‡æ–™åº«"""
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            stmt = select(CryptoPrice).where(
                and_(
                    CryptoPrice.symbol == row["symbol"],
                    CryptoPrice.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                existing.price = row.get("price") or row.get("close")
                existing.volume_24h = row.get("volume_24h")
                existing.market_cap = row.get("market_cap")
            else:
                price = CryptoPrice(
                    symbol=row["symbol"],
                    date=row["date"],
                    price=row.get("price") or row.get("close"),
                    volume_24h=row.get("volume_24h"),
                    market_cap=row.get("market_cap"),
                )
                self.db.add(price)
                count += 1
        
        self.db.commit()
        return count
    
    def _load_prices_from_db(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """å¾è³‡æ–™åº«è¼‰å…¥åƒ¹æ ¼è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(CryptoPrice)
            .where(
                and_(
                    CryptoPrice.symbol == symbol.upper(),
                    CryptoPrice.date >= start_date,
                )
            )
            .order_by(CryptoPrice.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        if not results:
            return None
        
        data = []
        for r in results:
            data.append({
                "symbol": r.symbol,
                "date": r.date,
                "close": float(r.price) if r.price else None,
                "price": float(r.price) if r.price else None,
                "volume": float(r.volume_24h) if r.volume_24h else 0,
                "volume_24h": float(r.volume_24h) if r.volume_24h else None,
                "market_cap": float(r.market_cap) if r.market_cap else None,
                # åŠ å¯†è²¨å¹£æ²’æœ‰ OHLCï¼Œç”¨ close å¡«å……
                "open": float(r.price) if r.price else None,
                "high": float(r.price) if r.price else None,
                "low": float(r.price) if r.price else None,
            })
        
        return pd.DataFrame(data)
    
    def fetch_and_cache_crypto(self, symbol: str, days: int = 365) -> bool:
        """æŠ“å–åŠ å¯†è²¨å¹£è³‡æ–™ä¸¦å¿«å–"""
        df = coingecko.get_market_chart(symbol, days=days)
        if df is None:
            return False
        
        # è½‰æ›æ¬„ä½åç¨±ä»¥ç¬¦åˆè³‡æ–™åº«
        df["close"] = df["price"]
        
        self._save_prices_to_db(df)
        return True
    
    def get_crypto_data(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[pd.DataFrame]:
        """å–å¾—åŠ å¯†è²¨å¹£è³‡æ–™ï¼ˆå„ªå…ˆä½¿ç”¨å¿«å–ï¼‰"""
        symbol = symbol.upper()
        
        if not coingecko.validate_symbol(symbol):
            logger.warning(f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}")
            return None
        
        # æª¢æŸ¥å¿«å–
        if not force_refresh and self._is_cache_valid(symbol):
            logger.info(f"ä½¿ç”¨å¿«å–è³‡æ–™: {symbol}")
            df = self._load_prices_from_db(symbol)
        else:
            logger.info(f"å¾ CoinGecko æŠ“å–: {symbol}")
            if not self.fetch_and_cache_crypto(symbol):
                df = self._load_prices_from_db(symbol)
                if df is None:
                    return None
            else:
                df = self._load_prices_from_db(symbol)
        
        if df is None or df.empty:
            return None
        
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆä½¿ç”¨é©åˆåŠ å¯†è²¨å¹£çš„åƒæ•¸ï¼‰
        df = self._calculate_crypto_indicators(df)
        
        return df
    
    def _calculate_crypto_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """è¨ˆç®—åŠ å¯†è²¨å¹£æŠ€è¡“æŒ‡æ¨™ï¼ˆä½¿ç”¨å¹£åœˆå¸¸ç”¨åƒæ•¸ï¼‰"""
        # å»ºç«‹å¹£åœˆå°ˆç”¨çš„æŒ‡æ¨™æœå‹™ï¼ˆä½¿ç”¨ä¸åŒçš„ MA é€±æœŸï¼‰
        crypto_indicator = indicator_service.__class__(
            ma_short=7,    # å¹£åœˆçŸ­å‡ç·š
            ma_mid=25,     # å¹£åœˆä¸­å‡ç·š
            ma_long=99,    # å¹£åœˆé•·å‡ç·š
        )
        
        df = crypto_indicator.add_ma_indicators(df)
        df = indicator_service.add_rsi_indicator(df)
        df = indicator_service.add_macd_indicator(df)
        df = indicator_service.add_kd_indicator(df)
        df = indicator_service.add_bollinger_indicator(df)
        
        # åŠ å¯†è²¨å¹£é€šå¸¸æ²’æœ‰çœŸæ­£çš„æˆäº¤é‡è³‡æ–™ï¼Œè·³é OBV
        if 'volume' in df.columns and df['volume'].sum() > 0:
            df = indicator_service.add_obv_indicator(df)
        
        return df
    
    def get_crypto_analysis(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[Dict[str, Any]]:
        """å–å¾—åŠ å¯†è²¨å¹£å®Œæ•´åˆ†æå ±å‘Š"""
        symbol = symbol.upper()
        
        # å–å¾—è³‡æ–™
        df = self.get_crypto_data(symbol, force_refresh)
        if df is None:
            return None
        
        # å–å¾—è©³ç´°è³‡è¨Š
        info = coingecko.get_coin_info(symbol)
        
        # æœ€æ–°åƒ¹æ ¼
        latest = df.iloc[-1]
        price = float(latest["close"])
        
        # æ¼²è·Œå¹…
        changes = self._calculate_changes(df, info)
        
        # æŠ€è¡“æŒ‡æ¨™
        indicators = self._get_indicators_summary(df, latest)
        
        # è¨Šè™Ÿ
        signals = indicator_service.get_all_signals(df)
        
        # è©•åˆ†
        score = indicator_service.calculate_score(df)
        
        return {
            "symbol": symbol,
            "name": info.get("name", symbol) if info else symbol,
            "asset_type": "crypto",
            "price": {
                "current": price,
                "ath": info.get("ath") if info else None,
                "atl": info.get("atl") if info else None,
                "from_ath_pct": info.get("ath_change_percentage") if info else None,
                "high_24h": info.get("high_24h") if info else None,
                "low_24h": info.get("low_24h") if info else None,
            },
            "change": changes,
            "market": {
                "market_cap": info.get("market_cap") if info else None,
                "market_cap_rank": info.get("market_cap_rank") if info else None,
                "volume_24h": info.get("total_volume") if info else None,
                "circulating_supply": info.get("circulating_supply") if info else None,
            },
            "indicators": indicators,
            "signals": [
                {
                    "type": s.type.value,
                    "indicator": s.indicator,
                    "description": s.description,
                }
                for s in signals
            ],
            "score": score,
            "updated_at": datetime.now().isoformat(),
        }
    
    def _calculate_changes(
        self,
        df: pd.DataFrame,
        info: Optional[Dict],
    ) -> Dict[str, float]:
        """è¨ˆç®—æ¼²è·Œå¹…"""
        changes = {}
        
        # å¾ CoinGecko API å–å¾—
        if info:
            changes["day"] = info.get("price_change_percentage_24h")
            changes["week"] = info.get("price_change_percentage_7d")
            changes["month"] = info.get("price_change_percentage_30d")
            changes["year"] = info.get("price_change_percentage_1y")
        
        # å¾æœ¬åœ°è³‡æ–™è¨ˆç®—
        latest_close = df["close"].iloc[-1]
        
        def calc_change(days: int) -> Optional[float]:
            if len(df) <= days:
                return None
            old_close = df["close"].iloc[-(days + 1)]
            if old_close and old_close != 0:
                return round((latest_close - old_close) / old_close * 100, 2)
            return None
        
        # è£œå……ç¼ºå¤±çš„è³‡æ–™
        if not changes.get("day"):
            changes["day"] = calc_change(1)
        if not changes.get("week"):
            changes["week"] = calc_change(7)
        if not changes.get("month"):
            changes["month"] = calc_change(30)
        
        return changes
    
    def _get_indicators_summary(
        self,
        df: pd.DataFrame,
        latest: pd.Series,
    ) -> Dict[str, Any]:
        """å–å¾—æŒ‡æ¨™æ‘˜è¦"""
        price = float(latest["close"])
        
        # MAï¼ˆå¹£åœˆé€±æœŸï¼‰
        ma_info = {
            "ma7": round(latest.get("ma7", 0), 2) if not pd.isna(latest.get("ma7")) else None,
            "ma25": round(latest.get("ma25", 0), 2) if not pd.isna(latest.get("ma25")) else None,
            "ma99": round(latest.get("ma99", 0), 2) if not pd.isna(latest.get("ma99")) else None,
        }
        
        # åˆ¤æ–·å‡ç·šæ’åˆ—
        ma7 = latest.get("ma7")
        ma25 = latest.get("ma25")
        ma99 = latest.get("ma99")
        
        if not any(pd.isna(x) for x in [ma7, ma25, ma99]):
            if price > ma7 > ma25 > ma99:
                ma_info["alignment"] = "bullish"
            elif price < ma7 < ma25 < ma99:
                ma_info["alignment"] = "bearish"
            else:
                ma_info["alignment"] = "neutral"
        else:
            ma_info["alignment"] = "unknown"
        
        # RSI
        rsi = latest.get("rsi")
        rsi_status, _ = indicator_service.get_rsi_status(rsi)
        rsi_info = {
            "value": round(rsi, 2) if not pd.isna(rsi) else None,
            "status": rsi_status,
        }
        
        # MACD
        macd_dif = latest.get("macd_dif")
        macd_dea = latest.get("macd_dea")
        macd_hist = latest.get("macd_hist")
        macd_info = {
            "dif": round(macd_dif, 4) if not pd.isna(macd_dif) else None,
            "dea": round(macd_dea, 4) if not pd.isna(macd_dea) else None,
            "histogram": round(macd_hist, 4) if not pd.isna(macd_hist) else None,
            "status": "bullish" if macd_hist and macd_hist > 0 else "bearish",
        }
        
        # Bollinger
        bb_upper = latest.get("bb_upper")
        bb_middle = latest.get("bb_middle")
        bb_lower = latest.get("bb_lower")
        bb_info = {
            "upper": round(bb_upper, 2) if not pd.isna(bb_upper) else None,
            "middle": round(bb_middle, 2) if not pd.isna(bb_middle) else None,
            "lower": round(bb_lower, 2) if not pd.isna(bb_lower) else None,
            "position": indicator_service.get_bollinger_position(price, bb_upper, bb_middle, bb_lower),
        }
        
        return {
            "ma": ma_info,
            "rsi": rsi_info,
            "macd": macd_info,
            "bollinger": bb_info,
        }
    
    # ==================== å¸‚å ´æƒ…ç·’ ====================
    
    def get_market_sentiment(self, market: str = "all") -> Dict[str, Any]:
        """
        å–å¾—å¸‚å ´æƒ…ç·’æŒ‡æ•¸
        
        Args:
            market: "stock", "crypto", or "all"
        """
        result = {}
        
        if market in ("all", "stock"):
            stock_sentiment = fear_greed.get_stock_fear_greed()
            if stock_sentiment:
                result["stock"] = stock_sentiment
                # å„²å­˜åˆ°è³‡æ–™åº«
                self._save_sentiment(stock_sentiment)
        
        if market in ("all", "crypto"):
            crypto_sentiment = fear_greed.get_crypto_fear_greed()
            if crypto_sentiment:
                result["crypto"] = crypto_sentiment
                # å„²å­˜åˆ°è³‡æ–™åº«
                self._save_sentiment(crypto_sentiment)
        
        return result
    
    def _save_sentiment(self, sentiment_data: Dict[str, Any]):
        """å„²å­˜æƒ…ç·’æŒ‡æ•¸åˆ°è³‡æ–™åº«"""
        try:
            market = sentiment_data.get("market")
            value = sentiment_data.get("value")
            timestamp = sentiment_data.get("timestamp")
            
            if not all([market, value, timestamp]):
                return
            
            sentiment_date = datetime.strptime(timestamp, "%Y-%m-%d").date()
            
            stmt = select(MarketSentiment).where(
                and_(
                    MarketSentiment.market == market,
                    MarketSentiment.date == sentiment_date,
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                existing.value = value
                existing.classification = sentiment_data.get("classification")
            else:
                sentiment = MarketSentiment(
                    date=sentiment_date,
                    market=market,
                    value=value,
                    classification=sentiment_data.get("classification"),
                )
                self.db.add(sentiment)
            
            self.db.commit()
        except Exception as e:
            logger.error(f"å„²å­˜æƒ…ç·’æŒ‡æ•¸å¤±æ•—: {e}")
    
    def get_supported_cryptos(self) -> List[Dict[str, str]]:
        """å–å¾—æ”¯æ´çš„åŠ å¯†è²¨å¹£åˆ—è¡¨"""
        from app.data_sources.coingecko import CRYPTO_MAP
        return [
            {"symbol": symbol, "id": coin_id}
            for symbol, coin_id in CRYPTO_MAP.items()
            if symbol not in ("BITCOIN", "ETHEREUM")  # æ’é™¤åˆ¥å
        ]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/indicator_service.py  â­â­â­
> æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™
åŒ…å« MAã€RSIã€MACDã€KDã€å¸ƒæ—é€šé“ã€OBV ç­‰æŒ‡æ¨™è¨ˆç®—
"""
import pandas as pd
import numpy as np
from typing import Dict, Any, Optional, Tuple, List
from dataclasses import dataclass
from enum import Enum

from app.config import settings


class TrendDirection(Enum):
    """è¶¨å‹¢æ–¹å‘"""
    BULLISH = "bullish"      # å¤šé ­
    BEARISH = "bearish"      # ç©ºé ­
    NEUTRAL = "neutral"      # ä¸­æ€§


class SignalType(Enum):
    """è¨Šè™Ÿé¡å‹"""
    GOLDEN_CROSS = "golden_cross"      # é»ƒé‡‘äº¤å‰
    DEATH_CROSS = "death_cross"        # æ­»äº¡äº¤å‰
    OVERBOUGHT = "overbought"          # è¶…è²·
    OVERSOLD = "oversold"              # è¶…è³£
    BREAKOUT = "breakout"              # çªç ´
    BREAKDOWN = "breakdown"            # è·Œç ´
    APPROACHING_BREAKOUT = "approaching_breakout"  # æ¥è¿‘çªç ´
    APPROACHING_BREAKDOWN = "approaching_breakdown"  # æ¥è¿‘è·Œç ´


@dataclass
class Signal:
    """äº¤æ˜“è¨Šè™Ÿ"""
    type: SignalType
    indicator: str
    description: str
    value: Optional[float] = None
    date: Optional[str] = None


class IndicatorService:
    """æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™"""
    
    def __init__(
        self,
        ma_short: int = None,
        ma_mid: int = None,
        ma_long: int = None,
        rsi_period: int = None,
        rsi_overbought: int = None,
        rsi_oversold: int = None,
        macd_fast: int = None,
        macd_slow: int = None,
        macd_signal: int = None,
        kd_period: int = None,
        bollinger_period: int = None,
        bollinger_std: float = None,
        breakout_threshold: float = None,
    ):
        """
        åˆå§‹åŒ–æŒ‡æ¨™åƒæ•¸
        è‹¥æœªæŒ‡å®šï¼Œå‰‡ä½¿ç”¨ config ä¸­çš„é è¨­å€¼
        """
        self.ma_short = ma_short or settings.MA_SHORT
        self.ma_mid = ma_mid or settings.MA_MID
        self.ma_long = ma_long or settings.MA_LONG
        self.rsi_period = rsi_period or settings.RSI_PERIOD
        self.rsi_overbought = rsi_overbought or settings.RSI_OVERBOUGHT
        self.rsi_oversold = rsi_oversold or settings.RSI_OVERSOLD
        self.macd_fast = macd_fast or settings.MACD_FAST
        self.macd_slow = macd_slow or settings.MACD_SLOW
        self.macd_signal = macd_signal or settings.MACD_SIGNAL
        self.kd_period = kd_period or settings.KD_PERIOD
        self.bollinger_period = bollinger_period or settings.BOLLINGER_PERIOD
        self.bollinger_std = bollinger_std or settings.BOLLINGER_STD
        self.breakout_threshold = breakout_threshold or settings.BREAKOUT_THRESHOLD
    
    # ==================== ç§»å‹•å¹³å‡ç·š (MA) ====================
    
    def calculate_ma(self, df: pd.DataFrame, period: int, column: str = "close") -> pd.Series:
        """è¨ˆç®—ç°¡å–®ç§»å‹•å¹³å‡ç·š (SMA)"""
        return df[column].rolling(window=period).mean()
    
    def calculate_ema(self, df: pd.DataFrame, period: int, column: str = "close") -> pd.Series:
        """è¨ˆç®—æŒ‡æ•¸ç§»å‹•å¹³å‡ç·š (EMA)"""
        return df[column].ewm(span=period, adjust=False).mean()
    
    def add_ma_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """
        æ–°å¢ç§»å‹•å¹³å‡ç·šæŒ‡æ¨™
        
        Returns:
            æ–°å¢ ma20, ma50, ma200, ma250 æ¬„ä½çš„ DataFrame
        """
        df = df.copy()
        df[f"ma{self.ma_short}"] = self.calculate_ma(df, self.ma_short)
        df[f"ma{self.ma_mid}"] = self.calculate_ma(df, self.ma_mid)
        df[f"ma{self.ma_long}"] = self.calculate_ma(df, self.ma_long)
        df["ma250"] = self.calculate_ma(df, 250)  # æ·»åŠ  MA250
        return df
    
    def get_ma_alignment(self, df: pd.DataFrame) -> Tuple[TrendDirection, str]:
        """
        åˆ¤æ–·å‡ç·šæ’åˆ—
        
        Returns:
            (è¶¨å‹¢æ–¹å‘, æè¿°)
        """
        if len(df) < self.ma_long:
            return TrendDirection.NEUTRAL, "è³‡æ–™ä¸è¶³"
        
        latest = df.iloc[-1]
        ma_short = latest.get(f"ma{self.ma_short}")
        ma_mid = latest.get(f"ma{self.ma_mid}")
        ma_long = latest.get(f"ma{self.ma_long}")
        price = latest["close"]
        
        if pd.isna(ma_short) or pd.isna(ma_mid) or pd.isna(ma_long):
            return TrendDirection.NEUTRAL, "å‡ç·šè³‡æ–™ä¸è¶³"
        
        # å¤šé ­æ’åˆ—ï¼šåƒ¹æ ¼ > çŸ­å‡ > ä¸­å‡ > é•·å‡
        if price > ma_short > ma_mid > ma_long:
            return TrendDirection.BULLISH, "å¤šé ­æ’åˆ—"
        
        # ç©ºé ­æ’åˆ—ï¼šåƒ¹æ ¼ < çŸ­å‡ < ä¸­å‡ < é•·å‡
        if price < ma_short < ma_mid < ma_long:
            return TrendDirection.BEARISH, "ç©ºé ­æ’åˆ—"
        
        return TrendDirection.NEUTRAL, "ç›¤æ•´"
    
    def check_ma_cross(self, df: pd.DataFrame, short_ma: str, long_ma: str) -> Optional[Signal]:
        """
        æª¢æŸ¥å‡ç·šäº¤å‰
        
        Args:
            df: å«æœ‰å‡ç·šè³‡æ–™çš„ DataFrame
            short_ma: çŸ­å‡ç·šæ¬„ä½åç¨± (å¦‚ "ma20")
            long_ma: é•·å‡ç·šæ¬„ä½åç¨± (å¦‚ "ma50")
            
        Returns:
            Signal ç‰©ä»¶æˆ– None
        """
        if len(df) < 2:
            return None
        
        today = df.iloc[-1]
        yesterday = df.iloc[-2]
        
        short_today = today.get(short_ma)
        short_yesterday = yesterday.get(short_ma)
        long_today = today.get(long_ma)
        long_yesterday = yesterday.get(long_ma)
        
        if any(pd.isna(x) for x in [short_today, short_yesterday, long_today, long_yesterday]):
            return None
        
        # é»ƒé‡‘äº¤å‰ï¼šçŸ­å‡ç·šç”±ä¸‹å¾€ä¸Šç©¿è¶Šé•·å‡ç·š
        if short_yesterday < long_yesterday and short_today > long_today:
            return Signal(
                type=SignalType.GOLDEN_CROSS,
                indicator=f"{short_ma}/{long_ma}",
                description=f"{short_ma.upper()} é»ƒé‡‘äº¤å‰ {long_ma.upper()}",
            )
        
        # æ­»äº¡äº¤å‰ï¼šçŸ­å‡ç·šç”±ä¸Šå¾€ä¸‹ç©¿è¶Šé•·å‡ç·š
        if short_yesterday > long_yesterday and short_today < long_today:
            return Signal(
                type=SignalType.DEATH_CROSS,
                indicator=f"{short_ma}/{long_ma}",
                description=f"{short_ma.upper()} æ­»äº¡äº¤å‰ {long_ma.upper()}",
            )
        
        return None
    
    def check_price_vs_ma(
        self,
        price: float,
        ma_value: float,
        ma_name: str,
    ) -> Optional[Signal]:
        """
        æª¢æŸ¥åƒ¹æ ¼èˆ‡å‡ç·šçš„é—œä¿‚ï¼ˆæ¥è¿‘çªç ´/è·Œç ´ï¼‰
        
        Args:
            price: ç•¶å‰åƒ¹æ ¼
            ma_value: å‡ç·šå€¼
            ma_name: å‡ç·šåç¨± (å¦‚ "MA20")
            
        Returns:
            Signal ç‰©ä»¶æˆ– None
        """
        if pd.isna(ma_value):
            return None
        
        distance_pct = ((price - ma_value) / ma_value) * 100
        
        # åƒ¹æ ¼åœ¨å‡ç·šä¸‹æ–¹ï¼Œä¸”è·é›¢å°æ–¼é–€æª» -> æ¥è¿‘å‘ä¸Šçªç ´
        if -self.breakout_threshold < distance_pct < 0:
            return Signal(
                type=SignalType.APPROACHING_BREAKOUT,
                indicator=ma_name,
                description=f"æ¥è¿‘çªç ´ {ma_name} ({abs(distance_pct):.1f}%)",
                value=distance_pct,
            )
        
        # åƒ¹æ ¼åœ¨å‡ç·šä¸Šæ–¹ï¼Œä¸”è·é›¢å°æ–¼é–€æª» -> æ¥è¿‘å‘ä¸‹è·Œç ´
        if 0 < distance_pct < self.breakout_threshold:
            return Signal(
                type=SignalType.APPROACHING_BREAKDOWN,
                indicator=ma_name,
                description=f"æ¥è¿‘è·Œç ´ {ma_name} ({distance_pct:.1f}%)",
                value=distance_pct,
            )
        
        return None
    
    # ==================== RSI ====================
    
    def calculate_rsi(self, df: pd.DataFrame, period: int = None) -> pd.Series:
        """
        è¨ˆç®— RSIï¼ˆç›¸å°å¼·å¼±æŒ‡æ¨™ï¼‰
        
        RSI = 100 - (100 / (1 + RS))
        RS = å¹³å‡æ¼²å¹… / å¹³å‡è·Œå¹…
        """
        period = period or self.rsi_period
        
        delta = df["close"].diff()
        gain = delta.where(delta > 0, 0)
        loss = (-delta).where(delta < 0, 0)
        
        avg_gain = gain.rolling(window=period).mean()
        avg_loss = loss.rolling(window=period).mean()
        
        rs = avg_gain / avg_loss
        rsi = 100 - (100 / (1 + rs))
        
        return rsi
    
    def add_rsi_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ RSI æŒ‡æ¨™"""
        df = df.copy()
        df["rsi"] = self.calculate_rsi(df)
        return df
    
    def get_rsi_status(self, rsi_value: float) -> Tuple[str, str]:
        """
        å–å¾— RSI ç‹€æ…‹
        
        Returns:
            (ç‹€æ…‹, æè¿°)
        """
        if pd.isna(rsi_value):
            return "unknown", "è³‡æ–™ä¸è¶³"
        
        if rsi_value >= self.rsi_overbought:
            return "overbought", f"è¶…è²· ({rsi_value:.1f})"
        elif rsi_value <= self.rsi_oversold:
            return "oversold", f"è¶…è³£ ({rsi_value:.1f})"
        else:
            return "neutral", f"ä¸­æ€§ ({rsi_value:.1f})"
    
    def check_rsi_signal(self, df: pd.DataFrame) -> Optional[Signal]:
        """æª¢æŸ¥ RSI è¨Šè™Ÿ"""
        if len(df) < 2 or "rsi" not in df.columns:
            return None
        
        rsi_today = df["rsi"].iloc[-1]
        rsi_yesterday = df["rsi"].iloc[-2]
        
        if pd.isna(rsi_today) or pd.isna(rsi_yesterday):
            return None
        
        # é€²å…¥è¶…è²·å€
        if rsi_yesterday < self.rsi_overbought <= rsi_today:
            return Signal(
                type=SignalType.OVERBOUGHT,
                indicator="RSI",
                description=f"RSI é€²å…¥è¶…è²·å€ ({rsi_today:.1f})",
                value=rsi_today,
            )
        
        # é€²å…¥è¶…è³£å€
        if rsi_yesterday > self.rsi_oversold >= rsi_today:
            return Signal(
                type=SignalType.OVERSOLD,
                indicator="RSI",
                description=f"RSI é€²å…¥è¶…è³£å€ ({rsi_today:.1f})",
                value=rsi_today,
            )
        
        return None
    
    # ==================== MACD ====================
    
    def calculate_macd(self, df: pd.DataFrame) -> Tuple[pd.Series, pd.Series, pd.Series]:
        """
        è¨ˆç®— MACD
        
        Returns:
            (DIF, MACD/DEA, Histogram)
        """
        ema_fast = self.calculate_ema(df, self.macd_fast)
        ema_slow = self.calculate_ema(df, self.macd_slow)
        
        dif = ema_fast - ema_slow
        dea = dif.ewm(span=self.macd_signal, adjust=False).mean()
        histogram = dif - dea
        
        return dif, dea, histogram
    
    def add_macd_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ MACD æŒ‡æ¨™"""
        df = df.copy()
        df["macd_dif"], df["macd_dea"], df["macd_hist"] = self.calculate_macd(df)
        return df
    
    def check_macd_signal(self, df: pd.DataFrame) -> Optional[Signal]:
        """æª¢æŸ¥ MACD äº¤å‰è¨Šè™Ÿ"""
        if len(df) < 2:
            return None
        
        dif_today = df["macd_dif"].iloc[-1]
        dif_yesterday = df["macd_dif"].iloc[-2]
        dea_today = df["macd_dea"].iloc[-1]
        dea_yesterday = df["macd_dea"].iloc[-2]
        
        if any(pd.isna(x) for x in [dif_today, dif_yesterday, dea_today, dea_yesterday]):
            return None
        
        # é»ƒé‡‘äº¤å‰ï¼šDIF ç”±ä¸‹å¾€ä¸Šç©¿è¶Š DEA
        if dif_yesterday < dea_yesterday and dif_today > dea_today:
            position = "é›¶è»¸ä¸Šæ–¹" if dif_today > 0 else "é›¶è»¸ä¸‹æ–¹"
            return Signal(
                type=SignalType.GOLDEN_CROSS,
                indicator="MACD",
                description=f"MACD é»ƒé‡‘äº¤å‰ ({position})",
                value=dif_today,
            )
        
        # æ­»äº¡äº¤å‰ï¼šDIF ç”±ä¸Šå¾€ä¸‹ç©¿è¶Š DEA
        if dif_yesterday > dea_yesterday and dif_today < dea_today:
            position = "é›¶è»¸ä¸Šæ–¹" if dif_today > 0 else "é›¶è»¸ä¸‹æ–¹"
            return Signal(
                type=SignalType.DEATH_CROSS,
                indicator="MACD",
                description=f"MACD æ­»äº¡äº¤å‰ ({position})",
                value=dif_today,
            )
        
        return None
    
    # ==================== KD ====================
    
    def calculate_kd(self, df: pd.DataFrame) -> Tuple[pd.Series, pd.Series]:
        """
        è¨ˆç®— KDï¼ˆéš¨æ©ŸæŒ‡æ¨™ï¼‰
        
        RSV = (ä»Šæ—¥æ”¶ç›¤ - Næ—¥æœ€ä½) / (Næ—¥æœ€é«˜ - Næ—¥æœ€ä½) Ã— 100
        K = 2/3 Ã— æ˜¨æ—¥K + 1/3 Ã— RSV
        D = 2/3 Ã— æ˜¨æ—¥D + 1/3 Ã— K
        
        Returns:
            (K, D)
        """
        period = self.kd_period
        
        lowest = df["low"].rolling(window=period).min()
        highest = df["high"].rolling(window=period).max()
        
        rsv = ((df["close"] - lowest) / (highest - lowest)) * 100
        
        # åˆå§‹åŒ– K, D
        k = pd.Series(index=df.index, dtype=float)
        d = pd.Series(index=df.index, dtype=float)
        
        # ç¬¬ä¸€å€‹æœ‰æ•ˆå€¼è¨­ç‚º 50
        first_valid = rsv.first_valid_index()
        if first_valid is not None:
            idx = df.index.get_loc(first_valid)
            k.iloc[idx] = 50
            d.iloc[idx] = 50
            
            # è¿­ä»£è¨ˆç®—
            for i in range(idx + 1, len(df)):
                k.iloc[i] = (2/3) * k.iloc[i-1] + (1/3) * rsv.iloc[i]
                d.iloc[i] = (2/3) * d.iloc[i-1] + (1/3) * k.iloc[i]
        
        return k, d
    
    def add_kd_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ KD æŒ‡æ¨™"""
        df = df.copy()
        df["kd_k"], df["kd_d"] = self.calculate_kd(df)
        return df
    
    def check_kd_signal(self, df: pd.DataFrame) -> Optional[Signal]:
        """æª¢æŸ¥ KD äº¤å‰è¨Šè™Ÿ"""
        if len(df) < 2:
            return None
        
        k_today = df["kd_k"].iloc[-1]
        k_yesterday = df["kd_k"].iloc[-2]
        d_today = df["kd_d"].iloc[-1]
        d_yesterday = df["kd_d"].iloc[-2]
        
        if any(pd.isna(x) for x in [k_today, k_yesterday, d_today, d_yesterday]):
            return None
        
        # é»ƒé‡‘äº¤å‰ï¼šK ç”±ä¸‹å¾€ä¸Šç©¿è¶Š D
        if k_yesterday < d_yesterday and k_today > d_today:
            zone = "è¶…è³£å€" if k_today < 20 else ("è¶…è²·å€" if k_today > 80 else "ä¸­æ€§å€")
            return Signal(
                type=SignalType.GOLDEN_CROSS,
                indicator="KD",
                description=f"KD é»ƒé‡‘äº¤å‰ ({zone}, K={k_today:.1f})",
                value=k_today,
            )
        
        # æ­»äº¡äº¤å‰ï¼šK ç”±ä¸Šå¾€ä¸‹ç©¿è¶Š D
        if k_yesterday > d_yesterday and k_today < d_today:
            zone = "è¶…è³£å€" if k_today < 20 else ("è¶…è²·å€" if k_today > 80 else "ä¸­æ€§å€")
            return Signal(
                type=SignalType.DEATH_CROSS,
                indicator="KD",
                description=f"KD æ­»äº¡äº¤å‰ ({zone}, K={k_today:.1f})",
                value=k_today,
            )
        
        return None
    
    # ==================== å¸ƒæ—é€šé“ ====================
    
    def calculate_bollinger(self, df: pd.DataFrame) -> Tuple[pd.Series, pd.Series, pd.Series]:
        """
        è¨ˆç®—å¸ƒæ—é€šé“
        
        Returns:
            (ä¸Šè»Œ, ä¸­è»Œ, ä¸‹è»Œ)
        """
        middle = df["close"].rolling(window=self.bollinger_period).mean()
        std = df["close"].rolling(window=self.bollinger_period).std()
        
        upper = middle + (self.bollinger_std * std)
        lower = middle - (self.bollinger_std * std)
        
        return upper, middle, lower
    
    def add_bollinger_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢å¸ƒæ—é€šé“æŒ‡æ¨™"""
        df = df.copy()
        df["bb_upper"], df["bb_middle"], df["bb_lower"] = self.calculate_bollinger(df)
        df["bb_width"] = (df["bb_upper"] - df["bb_lower"]) / df["bb_middle"]
        return df
    
    def get_bollinger_position(self, price: float, upper: float, middle: float, lower: float) -> str:
        """å–å¾—åƒ¹æ ¼åœ¨å¸ƒæ—é€šé“ä¸­çš„ä½ç½®"""
        if pd.isna(upper) or pd.isna(lower):
            return "unknown"
        
        if price >= upper:
            return "above_upper"
        elif price <= lower:
            return "below_lower"
        elif price >= middle:
            return "upper_half"
        else:
            return "lower_half"
    
    # ==================== OBV ====================
    
    def calculate_obv(self, df: pd.DataFrame) -> pd.Series:
        """
        è¨ˆç®— OBVï¼ˆèƒ½é‡æ½®æŒ‡æ¨™ï¼‰
        
        è‹¥ä»Šæ—¥æ”¶ç›¤ > æ˜¨æ—¥æ”¶ç›¤ï¼šOBV = æ˜¨æ—¥ OBV + ä»Šæ—¥æˆäº¤é‡
        è‹¥ä»Šæ—¥æ”¶ç›¤ < æ˜¨æ—¥æ”¶ç›¤ï¼šOBV = æ˜¨æ—¥ OBV - ä»Šæ—¥æˆäº¤é‡
        è‹¥ä»Šæ—¥æ”¶ç›¤ = æ˜¨æ—¥æ”¶ç›¤ï¼šOBV = æ˜¨æ—¥ OBV
        """
        obv = pd.Series(index=df.index, dtype=float)
        obv.iloc[0] = df["volume"].iloc[0]
        
        for i in range(1, len(df)):
            if df["close"].iloc[i] > df["close"].iloc[i-1]:
                obv.iloc[i] = obv.iloc[i-1] + df["volume"].iloc[i]
            elif df["close"].iloc[i] < df["close"].iloc[i-1]:
                obv.iloc[i] = obv.iloc[i-1] - df["volume"].iloc[i]
            else:
                obv.iloc[i] = obv.iloc[i-1]
        
        return obv
    
    def add_obv_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ OBV æŒ‡æ¨™"""
        df = df.copy()
        # æª¢æŸ¥æ˜¯å¦æœ‰ volume æ¬„ä½
        if "volume" not in df.columns:
            df["obv"] = None
            return df
        df["obv"] = self.calculate_obv(df)
        return df
    
    def get_obv_trend(self, df: pd.DataFrame, lookback: int = 5) -> str:
        """
        åˆ¤æ–· OBV è¶¨å‹¢
        
        Args:
            df: å«æœ‰ OBV çš„ DataFrame
            lookback: å›é¡§å¤©æ•¸
            
        Returns:
            è¶¨å‹¢å­—ä¸² ("rising", "falling", "flat")
        """
        if "obv" not in df.columns or len(df) < lookback:
            return "unknown"
        
        obv_recent = df["obv"].iloc[-lookback:]
        
        if obv_recent.is_monotonic_increasing:
            return "rising"
        elif obv_recent.is_monotonic_decreasing:
            return "falling"
        else:
            # æ¯”è¼ƒé¦–å°¾
            change_pct = (obv_recent.iloc[-1] - obv_recent.iloc[0]) / abs(obv_recent.iloc[0]) * 100
            if change_pct > 5:
                return "rising"
            elif change_pct < -5:
                return "falling"
            else:
                return "flat"
    
    # ==================== æˆäº¤é‡åˆ†æ ====================
    
    def calculate_volume_ratio(self, df: pd.DataFrame, ma_period: int = 20) -> pd.Series:
        """è¨ˆç®—é‡æ¯”ï¼ˆä»Šæ—¥æˆäº¤é‡ / Næ—¥å‡é‡ï¼‰"""
        avg_volume = df["volume"].rolling(window=ma_period).mean()
        return df["volume"] / avg_volume
    
    def add_volume_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢æˆäº¤é‡æŒ‡æ¨™"""
        df = df.copy()
        # æª¢æŸ¥æ˜¯å¦æœ‰ volume æ¬„ä½
        if "volume" not in df.columns:
            df["volume_ma20"] = None
            df["volume_ratio"] = None
            return df
        df["volume_ma20"] = df["volume"].rolling(window=20).mean()
        df["volume_ratio"] = self.calculate_volume_ratio(df)
        return df
    
    # ==================== ç¶œåˆè¨ˆç®— ====================
    
    def calculate_all_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """è¨ˆç®—æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™"""
        df = self.add_ma_indicators(df)
        df = self.add_rsi_indicator(df)
        df = self.add_macd_indicator(df)
        df = self.add_kd_indicator(df)
        df = self.add_bollinger_indicator(df)
        df = self.add_obv_indicator(df)
        df = self.add_volume_indicator(df)
        return df
    
    def get_all_signals(self, df: pd.DataFrame) -> List[Signal]:
        """å–å¾—æ‰€æœ‰è¨Šè™Ÿ"""
        signals = []
        
        # MA äº¤å‰
        ma_cross_20_50 = self.check_ma_cross(df, f"ma{self.ma_short}", f"ma{self.ma_mid}")
        if ma_cross_20_50:
            signals.append(ma_cross_20_50)
        
        ma_cross_50_200 = self.check_ma_cross(df, f"ma{self.ma_mid}", f"ma{self.ma_long}")
        if ma_cross_50_200:
            signals.append(ma_cross_50_200)
        
        # RSI
        rsi_signal = self.check_rsi_signal(df)
        if rsi_signal:
            signals.append(rsi_signal)
        
        # MACD
        macd_signal = self.check_macd_signal(df)
        if macd_signal:
            signals.append(macd_signal)
        
        # KD
        kd_signal = self.check_kd_signal(df)
        if kd_signal:
            signals.append(kd_signal)
        
        # åƒ¹æ ¼æ¥è¿‘å‡ç·š
        if len(df) > 0:
            latest = df.iloc[-1]
            price = latest["close"]
            
            for ma_col in [f"ma{self.ma_short}", f"ma{self.ma_mid}", f"ma{self.ma_long}"]:
                if ma_col in df.columns:
                    signal = self.check_price_vs_ma(price, latest[ma_col], ma_col.upper())
                    if signal:
                        signals.append(signal)
        
        return signals
    
    def calculate_score(self, df: pd.DataFrame) -> Dict[str, Any]:
        """
        è¨ˆç®—ç¶œåˆè©•åˆ†
        
        Returns:
            {
                "buy_score": int,
                "sell_score": int,
                "rating": str,
                "details": list
            }
        """
        buy_score = 0
        sell_score = 0
        details = []
        
        if len(df) < self.ma_long:
            return {
                "buy_score": 0,
                "sell_score": 0,
                "rating": "insufficient_data",
                "details": ["è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•è©•åˆ†"],
            }
        
        latest = df.iloc[-1]
        
        # 1. å‡ç·šæ’åˆ—
        alignment, alignment_desc = self.get_ma_alignment(df)
        if alignment == TrendDirection.BULLISH:
            buy_score += 1
            details.append(f"âœ… {alignment_desc}")
        elif alignment == TrendDirection.BEARISH:
            sell_score += 1
            details.append(f"âŒ {alignment_desc}")
        
        # 2. RSI
        if "rsi" in df.columns:
            rsi = latest["rsi"]
            if not pd.isna(rsi):
                if rsi <= self.rsi_oversold:
                    buy_score += 1
                    details.append(f"âœ… RSI è¶…è³£ ({rsi:.1f})")
                elif rsi >= self.rsi_overbought:
                    sell_score += 1
                    details.append(f"âŒ RSI è¶…è²· ({rsi:.1f})")
        
        # 3. MACD
        if "macd_hist" in df.columns and len(df) >= 2:
            hist_today = latest["macd_hist"]
            hist_yesterday = df["macd_hist"].iloc[-2]
            if not pd.isna(hist_today) and not pd.isna(hist_yesterday):
                if hist_today > 0 and hist_today > hist_yesterday:
                    buy_score += 1
                    details.append("âœ… MACD å‹•èƒ½å¢å¼·")
                elif hist_today < 0 and hist_today < hist_yesterday:
                    sell_score += 1
                    details.append("âŒ MACD å‹•èƒ½æ¸›å¼±")
        
        # 4. KD
        if "kd_k" in df.columns:
            k = latest["kd_k"]
            d = latest["kd_d"]
            if not pd.isna(k) and not pd.isna(d):
                if k < 20 and k > d:
                    buy_score += 1
                    details.append(f"âœ… KD ä½æª”é»ƒé‡‘äº¤å‰ (K={k:.1f})")
                elif k > 80 and k < d:
                    sell_score += 1
                    details.append(f"âŒ KD é«˜æª”æ­»äº¡äº¤å‰ (K={k:.1f})")
        
        # 5. å¸ƒæ—é€šé“
        if "bb_lower" in df.columns:
            price = latest["close"]
            bb_lower = latest["bb_lower"]
            bb_upper = latest["bb_upper"]
            bb_middle = latest["bb_middle"]
            
            if not pd.isna(bb_lower):
                if price <= bb_lower:
                    buy_score += 1
                    details.append("âœ… è§¸åŠå¸ƒæ—ä¸‹è»Œ")
                elif price >= bb_upper:
                    sell_score += 1
                    details.append("âŒ è§¸åŠå¸ƒæ—ä¸Šè»Œ")
                elif price < bb_middle and len(df) >= 2:
                    if df["close"].iloc[-2] >= bb_middle:
                        sell_score += 1
                        details.append("âŒ è·Œç ´å¸ƒæ—ä¸­è»Œ")
        
        # 6. é‡èƒ½
        if "volume_ratio" in df.columns:
            vol_ratio = latest["volume_ratio"]
            if not pd.isna(vol_ratio):
                if vol_ratio >= 2.0:
                    details.append(f"ğŸ“Š æˆäº¤é‡çˆ†å¢ (é‡æ¯” {vol_ratio:.1f})")
        
        # 7. OBV
        if "obv" in df.columns:
            obv_trend = self.get_obv_trend(df)
            if obv_trend == "rising":
                buy_score += 1
                details.append("âœ… OBV ä¸Šå‡è¶¨å‹¢")
            elif obv_trend == "falling":
                sell_score += 1
                details.append("âŒ OBV ä¸‹é™è¶¨å‹¢")
        
        # è¨ˆç®—è©•ç­‰
        if buy_score >= 5:
            rating = "strong_buy"
        elif buy_score >= 3:
            rating = "buy"
        elif sell_score >= 5:
            rating = "strong_sell"
        elif sell_score >= 3:
            rating = "sell"
        else:
            rating = "neutral"
        
        return {
            "buy_score": buy_score,
            "sell_score": sell_score,
            "rating": rating,
            "details": details,
        }
    
    # ==================== å¹´åŒ–å ±é…¬ç‡ï¼ˆCAGRï¼‰è¨ˆç®— ====================
    
    def calculate_cagr(
        self,
        df: pd.DataFrame,
        years: float,
    ) -> Optional[float]:
        """
        è¨ˆç®—å¹´åŒ–è¤‡åˆæˆé•·ç‡ï¼ˆCAGRï¼‰
        
        å…¬å¼: CAGR = (çµ‚å€¼/åˆå€¼)^(1/å¹´æ•¸) - 1
        
        Args:
            df: è‚¡åƒ¹ DataFrameï¼ˆéœ€æœ‰ 'close' æ¬„ä½ï¼‰
            years: è¨ˆç®—çš„å¹´æ•¸
            
        Returns:
            å¹´åŒ–å ±é…¬ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œä¾‹å¦‚ 15.5 è¡¨ç¤º 15.5%
            å¦‚æœè³‡æ–™ä¸è¶³å‰‡è¿”å› None
        """
        if df is None or df.empty:
            return None
        
        # è¨ˆç®—éœ€è¦çš„å¤©æ•¸ï¼ˆå‡è¨­ä¸€å¹´ç´„ 252 å€‹äº¤æ˜“æ—¥ï¼‰
        trading_days = int(years * 252)
        
        if len(df) < trading_days:
            return None
        
        try:
            # å–å¾—çµ‚å€¼ï¼ˆæœ€æ–°åƒ¹æ ¼ï¼‰
            end_price = float(df['close'].iloc[-1])
            
            # å–å¾—åˆå€¼ï¼ˆNå¹´å‰åƒ¹æ ¼ï¼‰
            start_price = float(df['close'].iloc[-trading_days])
            
            if start_price <= 0 or end_price <= 0:
                return None
            
            # è¨ˆç®— CAGR
            cagr = (end_price / start_price) ** (1 / years) - 1
            
            # è½‰æ›ç‚ºç™¾åˆ†æ¯”
            return round(cagr * 100, 2)
        except Exception:
            return None
    
    def calculate_all_cagr(
        self,
        df: pd.DataFrame,
    ) -> Dict[str, Optional[float]]:
        """
        è¨ˆç®—æ‰€æœ‰æ™‚é–“ç¯„åœçš„å¹´åŒ–å ±é…¬ç‡
        
        Returns:
            {
                "cagr_1y": 15.5,   # 1 å¹´å¹´åŒ–
                "cagr_3y": 12.3,   # 3 å¹´å¹´åŒ–
                "cagr_5y": 18.7,   # 5 å¹´å¹´åŒ–
                "cagr_10y": 14.2,  # 10 å¹´å¹´åŒ–
            }
        """
        return {
            "cagr_1y": self.calculate_cagr(df, 1),
            "cagr_3y": self.calculate_cagr(df, 3),
            "cagr_5y": self.calculate_cagr(df, 5),
            "cagr_10y": self.calculate_cagr(df, 10),
        }
    
    def calculate_cagr_from_prices(
        self,
        start_price: float,
        end_price: float,
        years: float,
    ) -> Optional[float]:
        """
        å¾èµ·å§‹å’ŒçµæŸåƒ¹æ ¼è¨ˆç®— CAGR
        
        Args:
            start_price: èµ·å§‹åƒ¹æ ¼
            end_price: çµæŸåƒ¹æ ¼
            years: å¹´æ•¸
            
        Returns:
            å¹´åŒ–å ±é…¬ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        """
        if start_price <= 0 or end_price <= 0 or years <= 0:
            return None
        
        try:
            cagr = (end_price / start_price) ** (1 / years) - 1
            return round(cagr * 100, 2)
        except Exception:
            return None


# å»ºç«‹é è¨­å¯¦ä¾‹
indicator_service = IndicatorService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/line_notify_service.py  â­â­â­
> LINE Messaging API æ¨æ’­æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
LINE Messaging API æ¨æ’­æœå‹™
ç™¼é€æŠ€è¡“è¨Šè™Ÿé€šçŸ¥çµ¦ç”¨æˆ¶
"""
import httpx
import logging
from typing import List, Optional, Dict, Any
from datetime import datetime

from app.config import settings

logger = logging.getLogger(__name__)


class LineNotifyService:
    """LINE Messaging API æ¨æ’­æœå‹™"""
    
    PUSH_URL = "https://api.line.me/v2/bot/message/push"
    MULTICAST_URL = "https://api.line.me/v2/bot/message/multicast"
    BROADCAST_URL = "https://api.line.me/v2/bot/message/broadcast"
    
    def __init__(self):
        self.channel_access_token = settings.LINE_MESSAGING_CHANNEL_ACCESS_TOKEN
        self.enabled = bool(self.channel_access_token)
        
        if not self.enabled:
            logger.warning("LINE Messaging API æœªè¨­å®š Channel Access Tokenï¼Œæ¨æ’­åŠŸèƒ½åœç”¨")
    
    def _get_headers(self) -> Dict[str, str]:
        """å–å¾— API è«‹æ±‚æ¨™é ­"""
        return {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.channel_access_token}",
        }
    
    async def push_text_message(
        self, 
        user_id: str, 
        message: str
    ) -> bool:
        """
        æ¨é€æ–‡å­—è¨Šæ¯çµ¦å–®ä¸€ç”¨æˆ¶
        
        Args:
            user_id: LINE User ID
            message: è¨Šæ¯å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        if not user_id or not message:
            logger.warning("user_id æˆ– message ç‚ºç©º")
            return False
        
        payload = {
            "to": user_id,
            "messages": [
                {
                    "type": "text",
                    "text": message
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.PUSH_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=10.0
                )
                
                if response.status_code == 200:
                    logger.info(f"LINE æ¨æ’­æˆåŠŸ: user={user_id[:10]}...")
                    return True
                else:
                    logger.error(f"LINE æ¨æ’­å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE æ¨æ’­ä¾‹å¤–: {e}")
            return False
    
    async def push_flex_message(
        self,
        user_id: str,
        alt_text: str,
        flex_content: Dict[str, Any]
    ) -> bool:
        """
        æ¨é€ Flex Message çµ¦å–®ä¸€ç”¨æˆ¶
        
        Args:
            user_id: LINE User ID
            alt_text: æ›¿ä»£æ–‡å­—ï¼ˆæ‰‹æ©Ÿé€šçŸ¥é¡¯ç¤ºï¼‰
            flex_content: Flex Message å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        payload = {
            "to": user_id,
            "messages": [
                {
                    "type": "flex",
                    "altText": alt_text,
                    "contents": flex_content
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.PUSH_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=10.0
                )
                
                if response.status_code == 200:
                    logger.info(f"LINE Flex æ¨æ’­æˆåŠŸ: user={user_id[:10]}...")
                    return True
                else:
                    logger.error(f"LINE Flex æ¨æ’­å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE Flex æ¨æ’­ä¾‹å¤–: {e}")
            return False
    
    async def multicast_text_message(
        self,
        user_ids: List[str],
        message: str
    ) -> bool:
        """
        æ¨é€æ–‡å­—è¨Šæ¯çµ¦å¤šå€‹ç”¨æˆ¶ï¼ˆæœ€å¤š 500 äººï¼‰
        
        Args:
            user_ids: LINE User ID åˆ—è¡¨
            message: è¨Šæ¯å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        if not user_ids or not message:
            return False
        
        # LINE API é™åˆ¶æœ€å¤š 500 äºº
        if len(user_ids) > 500:
            logger.warning(f"ç”¨æˆ¶æ•¸è¶…é 500ï¼Œåªæ¨é€å‰ 500 äºº")
            user_ids = user_ids[:500]
        
        payload = {
            "to": user_ids,
            "messages": [
                {
                    "type": "text",
                    "text": message
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.MULTICAST_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=30.0
                )
                
                if response.status_code == 200:
                    logger.info(f"LINE ç¾¤ç™¼æˆåŠŸ: {len(user_ids)} äºº")
                    return True
                else:
                    logger.error(f"LINE ç¾¤ç™¼å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE ç¾¤ç™¼ä¾‹å¤–: {e}")
            return False
    
    async def broadcast_text_message(self, message: str) -> bool:
        """
        å»£æ’­è¨Šæ¯çµ¦æ‰€æœ‰å¥½å‹
        
        Args:
            message: è¨Šæ¯å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        payload = {
            "messages": [
                {
                    "type": "text",
                    "text": message
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.BROADCAST_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=30.0
                )
                
                if response.status_code == 200:
                    logger.info("LINE å»£æ’­æˆåŠŸ")
                    return True
                else:
                    logger.error(f"LINE å»£æ’­å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE å»£æ’­ä¾‹å¤–: {e}")
            return False
    
    def create_signal_flex_message(
        self,
        symbol: str,
        signals: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        å»ºç«‹è¨Šè™Ÿé€šçŸ¥çš„ Flex Message
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            signals: è¨Šè™Ÿåˆ—è¡¨
            
        Returns:
            Flex Message å…§å®¹
        """
        # è¨Šè™Ÿé¡è‰²å°ç…§
        signal_colors = {
            "golden": "#00C853",  # ç¶ è‰²
            "death": "#FF1744",   # ç´…è‰²
            "overbought": "#FF9800",  # æ©™è‰²
            "oversold": "#00C853",
            "breakout": "#00C853",
            "breakdown": "#FF1744",
            "surge": "#2196F3",   # è—è‰²
            "fear": "#FF9800",
            "greed": "#FF1744",
        }
        
        def get_color(signal_type: str) -> str:
            for key, color in signal_colors.items():
                if key in signal_type.lower():
                    return color
            return "#666666"
        
        # å»ºç«‹è¨Šè™Ÿåˆ—è¡¨
        signal_boxes = []
        for s in signals:
            signal_type = s.get("signal_type", "")
            message = s.get("message", "")
            color = get_color(signal_type)
            
            signal_boxes.append({
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "text",
                        "text": "â—",
                        "size": "sm",
                        "color": color,
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": message,
                        "size": "sm",
                        "color": "#333333",
                        "flex": 1,
                        "wrap": True
                    }
                ],
                "margin": "sm"
            })
        
        # Flex Message çµæ§‹
        flex_content = {
            "type": "bubble",
            "size": "kilo",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": f"ğŸ“Š {symbol}",
                        "weight": "bold",
                        "size": "lg",
                        "color": "#FFFFFF"
                    }
                ],
                "backgroundColor": "#FA7A35",
                "paddingAll": "15px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": signal_boxes,
                "paddingAll": "15px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": datetime.now().strftime("%Y-%m-%d %H:%M"),
                        "size": "xs",
                        "color": "#999999",
                        "align": "end"
                    }
                ],
                "paddingAll": "10px"
            }
        }
        
        return flex_content


# å–®ä¾‹
line_notify_service = LineNotifyService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/market_service.py  â­â­â­
> å¸‚å ´æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æœå‹™
è™•ç†ä¸‰å¤§æŒ‡æ•¸ã€å¸‚å ´æƒ…ç·’çš„è³‡æ–™å­˜å–
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Dict, Any, List
from sqlalchemy.orm import Session
from sqlalchemy import select, and_, desc
import logging

from app.models.index_price import IndexPrice, INDEX_SYMBOLS
from app.models.market_sentiment import MarketSentiment
from app.models.dividend_history import DividendHistory
from app.models.stock_price import StockPrice
from app.data_sources.yahoo_finance import yahoo_finance
from app.data_sources.fear_greed import fear_greed

logger = logging.getLogger(__name__)


class MarketService:
    """å¸‚å ´æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    # ==================== ä¸‰å¤§æŒ‡æ•¸ ====================
    
    def get_latest_indices(self) -> Dict[str, Any]:
        """å–å¾—ä¸‰å¤§æŒ‡æ•¸æœ€æ–°è³‡æ–™ï¼Œå›å‚³å­—å…¸æ ¼å¼"""
        result = {}
        
        for symbol, info in INDEX_SYMBOLS.items():
            try:
                stmt = (
                    select(IndexPrice)
                    .where(IndexPrice.symbol == symbol)
                    .order_by(desc(IndexPrice.date))
                    .limit(1)
                )
                latest = self.db.execute(stmt).scalar_one_or_none()
                
                if latest:
                    result[symbol] = latest.to_dict()
                    continue
            except Exception as e:
                logger.warning(f"å¾è³‡æ–™åº«å–å¾— {symbol} å¤±æ•—: {e}")
            
            # Fallback: å¾ Yahoo Finance API å–å¾—
            try:
                df = yahoo_finance.get_index_data(symbol, period="5d")
                if df is not None and not df.empty:
                    row = df.iloc[-1]
                    result[symbol] = {
                        "symbol": symbol,
                        "name": info["name"],
                        "name_zh": info["name_zh"],
                        "date": str(row["date"]),
                        "close": float(row["close"]),
                        "change": float(row["change"]) if pd.notna(row.get("change")) else None,
                        "change_pct": float(row["change_pct"]) if pd.notna(row.get("change_pct")) else None,
                    }
                    logger.info(f"å¾ API å–å¾— {symbol}: {result[symbol]['close']}")
            except Exception as e:
                logger.error(f"å¾ API å–å¾— {symbol} å¤±æ•—: {e}")
        
        return result
    
    def get_index_history(
        self,
        symbol: str,
        days: int = 365,
    ) -> List[Dict[str, Any]]:
        """å–å¾—æŒ‡æ•¸æ­·å²è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(IndexPrice)
            .where(
                and_(
                    IndexPrice.symbol == symbol,
                    IndexPrice.date >= start_date,
                )
            )
            .order_by(IndexPrice.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        return [r.to_dict() for r in results]
    
    def save_index_data(self, df: pd.DataFrame, symbol: str) -> int:
        """
        å„²å­˜æŒ‡æ•¸è³‡æ–™åˆ°è³‡æ–™åº«
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        import math
        
        def clean_value(val):
            """æ¸…ç†å€¼ï¼Œå°‡ NaN/Inf è½‰ç‚º None"""
            if val is None:
                return None
            if pd.isna(val):
                return None
            try:
                f = float(val)
                if math.isnan(f) or math.isinf(f):
                    return None
                return f
            except (ValueError, TypeError):
                return None
        
        if df is None or df.empty:
            return 0
        
        count = 0
        index_info = INDEX_SYMBOLS.get(symbol, {})
        
        for _, row in df.iterrows():
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(IndexPrice).where(
                and_(
                    IndexPrice.symbol == symbol,
                    IndexPrice.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                # æ›´æ–°ç¾æœ‰è³‡æ–™
                existing.open = clean_value(row.get("open"))
                existing.high = clean_value(row.get("high"))
                existing.low = clean_value(row.get("low"))
                existing.close = clean_value(row.get("close"))
                existing.volume = row.get("volume")
                existing.change = clean_value(row.get("change"))
                existing.change_pct = clean_value(row.get("change_pct"))
            else:
                # æ–°å¢è³‡æ–™
                price = IndexPrice(
                    symbol=symbol,
                    name=index_info.get("name", symbol),
                    date=row["date"],
                    open=clean_value(row.get("open")),
                    high=clean_value(row.get("high")),
                    low=clean_value(row.get("low")),
                    close=clean_value(row.get("close")),
                    volume=row.get("volume"),
                    change=clean_value(row.get("change")),
                    change_pct=clean_value(row.get("change_pct")),
                )
                self.db.add(price)
                count += 1
        
        self.db.commit()
        return count
    
    def fetch_and_save_all_indices(self, period: str = "10y") -> Dict[str, int]:
        """
        æŠ“å–ä¸¦å„²å­˜æ‰€æœ‰ä¸‰å¤§æŒ‡æ•¸è³‡æ–™
        
        Returns:
            {symbol: å„²å­˜ç­†æ•¸}
        """
        result = {}
        
        for symbol in INDEX_SYMBOLS.keys():
            logger.info(f"æŠ“å–æŒ‡æ•¸è³‡æ–™: {symbol}")
            df = yahoo_finance.get_index_data(symbol, period=period)
            
            if df is not None:
                count = self.save_index_data(df, symbol)
                result[symbol] = count
                logger.info(f"{symbol} æ–°å¢ {count} ç­†è³‡æ–™")
            else:
                result[symbol] = 0
                logger.warning(f"{symbol} æŠ“å–å¤±æ•—")
        
        return result
    
    # ==================== å¸‚å ´æƒ…ç·’ ====================
    
    def get_latest_sentiment(self) -> Dict[str, Any]:
        """å–å¾—æœ€æ–°çš„å¸‚å ´æƒ…ç·’"""
        result = {}
        
        for market in ["stock", "crypto"]:
            stmt = (
                select(MarketSentiment)
                .where(MarketSentiment.market == market)
                .order_by(desc(MarketSentiment.date))
                .limit(1)
            )
            latest = self.db.execute(stmt).scalar_one_or_none()
            
            if latest:
                result[market] = latest.to_dict()
            else:
                # å¾ API å–å¾—
                if market == "crypto":
                    data = fear_greed.get_crypto_fear_greed()
                else:
                    data = fear_greed.get_stock_fear_greed()
                
                if data:
                    result[market] = data
        
        return result
    
    def get_sentiment_history(
        self,
        market: str,
        days: int = 365,
    ) -> List[Dict[str, Any]]:
        """å–å¾—æƒ…ç·’æ­·å²è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(MarketSentiment)
            .where(
                and_(
                    MarketSentiment.market == market,
                    MarketSentiment.date >= start_date,
                )
            )
            .order_by(MarketSentiment.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        return [r.to_dict() for r in results]
    
    def save_sentiment(
        self,
        market: str,
        value: int,
        target_date: Optional[date] = None,
    ) -> bool:
        """
        å„²å­˜å¸‚å ´æƒ…ç·’è³‡æ–™
        """
        if target_date is None:
            target_date = date.today()
        
        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        stmt = select(MarketSentiment).where(
            and_(
                MarketSentiment.market == market,
                MarketSentiment.date == target_date,
            )
        )
        existing = self.db.execute(stmt).scalar_one_or_none()
        
        classification = MarketSentiment.get_classification(value)
        
        if existing:
            existing.value = value
            existing.classification = classification
        else:
            sentiment = MarketSentiment(
                date=target_date,
                market=market,
                value=value,
                classification=classification,
            )
            self.db.add(sentiment)
        
        self.db.commit()
        return True
    
    def fetch_and_save_crypto_history(self, days: int = 365) -> int:
        """
        æŠ“å–ä¸¦å„²å­˜å¹£åœˆæƒ…ç·’æ­·å²è³‡æ–™
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        logger.info(f"æŠ“å–å¹£åœˆæƒ…ç·’æ­·å²: {days} å¤©")
        history = fear_greed.get_crypto_fear_greed_history(days)
        
        count = 0
        for item in history:
            try:
                target_date = datetime.strptime(item["date"], "%Y-%m-%d").date()
                
                # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                stmt = select(MarketSentiment).where(
                    and_(
                        MarketSentiment.market == "crypto",
                        MarketSentiment.date == target_date,
                    )
                )
                existing = self.db.execute(stmt).scalar_one_or_none()
                
                if not existing:
                    sentiment = MarketSentiment(
                        date=target_date,
                        market="crypto",
                        value=item["value"],
                        classification=item["classification"],
                    )
                    self.db.add(sentiment)
                    count += 1
            except Exception as e:
                logger.error(f"å„²å­˜æƒ…ç·’è³‡æ–™å¤±æ•—: {e}")
        
        self.db.commit()
        logger.info(f"å¹£åœˆæƒ…ç·’æ­·å²æ–°å¢ {count} ç­†")
        return count
    
    def update_today_sentiment(self) -> Dict[str, bool]:
        """
        æ›´æ–°ä»Šæ—¥çš„å¸‚å ´æƒ…ç·’
        
        Returns:
            {market: success}
        """
        result = {}
        
        # ç¾è‚¡æƒ…ç·’
        stock_data = fear_greed.get_stock_fear_greed()
        if stock_data and not stock_data.get("is_fallback"):
            result["stock"] = self.save_sentiment("stock", stock_data["value"])
        else:
            result["stock"] = False
        
        # å¹£åœˆæƒ…ç·’
        crypto_data = fear_greed.get_crypto_fear_greed()
        if crypto_data and not crypto_data.get("is_fallback"):
            result["crypto"] = self.save_sentiment("crypto", crypto_data["value"])
        else:
            result["crypto"] = False
        
        return result
    
    # ==================== é…æ¯è³‡æ–™ ====================
    
    def save_dividends(self, df: pd.DataFrame) -> int:
        """
        å„²å­˜é…æ¯è³‡æ–™
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(DividendHistory).where(
                and_(
                    DividendHistory.symbol == row["symbol"],
                    DividendHistory.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if not existing:
                dividend = DividendHistory(
                    symbol=row["symbol"],
                    date=row["date"],
                    amount=row["amount"],
                )
                self.db.add(dividend)
                count += 1
        
        self.db.commit()
        return count
    
    def fetch_and_save_dividends(self, symbol: str, period: str = "10y") -> int:
        """
        æŠ“å–ä¸¦å„²å­˜é…æ¯è³‡æ–™
        """
        logger.info(f"æŠ“å–é…æ¯è³‡æ–™: {symbol}")
        df = yahoo_finance.get_dividends(symbol, period=period)
        
        if df is not None:
            count = self.save_dividends(df)
            logger.info(f"{symbol} é…æ¯æ–°å¢ {count} ç­†")
            return count
        
        return 0
    
    def get_dividends(
        self,
        symbol: str,
        years: int = 10,
    ) -> List[Dict[str, Any]]:
        """å–å¾—é…æ¯æ­·å²"""
        start_date = date.today() - timedelta(days=years * 365)
        
        stmt = (
            select(DividendHistory)
            .where(
                and_(
                    DividendHistory.symbol == symbol.upper(),
                    DividendHistory.date >= start_date,
                )
            )
            .order_by(DividendHistory.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        return [r.to_dict() for r in results]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/notification_service.py  â­â­â­
> é€šçŸ¥ç®¡ç†æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
é€šçŸ¥ç®¡ç†æœå‹™
æ•´åˆè¨Šè™Ÿåµæ¸¬ã€é€šçŸ¥è¨˜éŒ„ã€LINE æ¨æ’­
"""
import logging
from datetime import datetime, timedelta
from typing import List, Dict, Any, Optional, Set
from sqlalchemy import select, and_, func
from sqlalchemy.ext.asyncio import AsyncSession

from app.models.user import User
from app.models.watchlist import Watchlist
from app.models.notification import Notification
from app.models.user_settings import UserAlertSettings
from app.services.signal_service import Signal, SignalType, signal_service
from app.services.line_notify_service import line_notify_service
from app.services.indicator_service import indicator_service
from app.data_sources.yahoo_finance import yahoo_finance

logger = logging.getLogger(__name__)


class NotificationService:
    """é€šçŸ¥ç®¡ç†æœå‹™"""
    
    # è¨Šè™Ÿé¡å‹èˆ‡é€šçŸ¥è¨­å®šçš„å°æ‡‰
    SIGNAL_TO_SETTING = {
        SignalType.MA_GOLDEN_CROSS: "alert_ma_cross",
        SignalType.MA_DEATH_CROSS: "alert_ma_cross",
        SignalType.APPROACHING_BREAKOUT: "alert_ma_breakout",
        SignalType.APPROACHING_BREAKDOWN: "alert_ma_breakout",
        SignalType.BREAKOUT: "alert_ma_breakout",
        SignalType.BREAKDOWN: "alert_ma_breakout",
        SignalType.RSI_OVERBOUGHT: "alert_rsi",
        SignalType.RSI_OVERSOLD: "alert_rsi",
        SignalType.MACD_GOLDEN_CROSS: "alert_macd",
        SignalType.MACD_DEATH_CROSS: "alert_macd",
        SignalType.KD_GOLDEN_CROSS: "alert_kd",
        SignalType.KD_DEATH_CROSS: "alert_kd",
        SignalType.BOLLINGER_BREAKOUT: "alert_bollinger",
        SignalType.BOLLINGER_BREAKDOWN: "alert_bollinger",
        SignalType.VOLUME_SURGE: "alert_volume",
        SignalType.SENTIMENT_EXTREME_FEAR: "alert_sentiment",
        SignalType.SENTIMENT_EXTREME_GREED: "alert_sentiment",
    }
    
    async def get_all_tracked_symbols(self, db: AsyncSession) -> Dict[str, Set[int]]:
        """
        å–å¾—æ‰€æœ‰ç”¨æˆ¶è¿½è¹¤çš„è‚¡ç¥¨ï¼ˆè¯é›†ï¼‰
        
        Returns:
            {symbol: set(user_ids)} å°æ‡‰è¡¨
        """
        result = await db.execute(
            select(Watchlist.symbol, Watchlist.user_id, Watchlist.asset_type)
            .join(User, Watchlist.user_id == User.id)
            .where(User.is_active == True)
            .where(User.is_blocked == False)
        )
        rows = result.all()
        
        symbol_users = {}
        for symbol, user_id, asset_type in rows:
            key = f"{symbol}|{asset_type}"
            if key not in symbol_users:
                symbol_users[key] = {"symbol": symbol, "asset_type": asset_type, "users": set()}
            symbol_users[key]["users"].add(user_id)
        
        logger.info(f"å…± {len(symbol_users)} å€‹è¿½è¹¤æ¨™çš„")
        return symbol_users
    
    async def get_user_alert_settings(
        self, 
        db: AsyncSession, 
        user_id: int
    ) -> Dict[str, bool]:
        """å–å¾—ç”¨æˆ¶çš„é€šçŸ¥è¨­å®š"""
        result = await db.execute(
            select(UserAlertSettings).where(UserAlertSettings.user_id == user_id)
        )
        settings = result.scalar_one_or_none()
        
        if not settings:
            # ä½¿ç”¨é è¨­å€¼ï¼ˆå…¨éƒ¨é–‹å•Ÿï¼‰
            return {
                "alert_ma_cross": True,
                "alert_ma_breakout": True,
                "alert_rsi": True,
                "alert_macd": True,
                "alert_kd": False,
                "alert_bollinger": False,
                "alert_volume": False,
                "alert_sentiment": True,
            }
        
        return {
            "alert_ma_cross": settings.alert_ma_cross,
            "alert_ma_breakout": settings.alert_ma_breakout,
            "alert_rsi": settings.alert_rsi,
            "alert_macd": settings.alert_macd,
            "alert_kd": settings.alert_kd,
            "alert_bollinger": settings.alert_bollinger,
            "alert_volume": settings.alert_volume,
            "alert_sentiment": settings.alert_sentiment,
        }
    
    async def is_recently_notified(
        self,
        db: AsyncSession,
        user_id: int,
        symbol: str,
        signal_type: str,
        hours: int = 24
    ) -> bool:
        """
        æª¢æŸ¥æ˜¯å¦æœ€è¿‘å·²é€šçŸ¥éï¼ˆé˜²æ­¢é‡è¤‡ï¼‰
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            signal_type: è¨Šè™Ÿé¡å‹
            hours: å¤šå°‘å°æ™‚å…§ä¸é‡è¤‡
            
        Returns:
            æ˜¯å¦å·²é€šçŸ¥é
        """
        since = datetime.utcnow() - timedelta(hours=hours)
        
        result = await db.execute(
            select(func.count(Notification.id))
            .where(and_(
                Notification.user_id == user_id,
                Notification.symbol == symbol,
                Notification.alert_type == signal_type,
                Notification.triggered_at >= since
            ))
        )
        count = result.scalar()
        return count > 0
    
    async def save_notification(
        self,
        db: AsyncSession,
        user_id: int,
        signal: Signal,
        sent: bool = False
    ) -> Notification:
        """å„²å­˜é€šçŸ¥è¨˜éŒ„"""
        notification = Notification(
            user_id=user_id,
            symbol=signal.symbol,
            asset_type=signal.asset_type,
            alert_type=signal.signal_type.value,
            indicator=signal.indicator,
            message=signal.message,
            price_at_trigger=signal.price if signal.price > 0 else None,
            triggered_at=signal.timestamp,
            sent=sent,
            sent_at=datetime.utcnow() if sent else None,
        )
        db.add(notification)
        await db.commit()
        return notification
    
    async def process_signals_for_user(
        self,
        db: AsyncSession,
        user_id: int,
        line_user_id: str,
        signals: List[Signal]
    ) -> Dict[str, Any]:
        """
        è™•ç†ç”¨æˆ¶çš„è¨Šè™Ÿé€šçŸ¥
        
        Args:
            db: è³‡æ–™åº« session
            user_id: ç”¨æˆ¶ ID
            line_user_id: LINE User ID
            signals: è¨Šè™Ÿåˆ—è¡¨
            
        Returns:
            è™•ç†çµæœ
        """
        if not signals:
            return {"sent": 0, "skipped": 0, "filtered": 0}
        
        # å–å¾—ç”¨æˆ¶é€šçŸ¥è¨­å®š
        alert_settings = await self.get_user_alert_settings(db, user_id)
        
        sent_count = 0
        skipped_count = 0
        filtered_count = 0
        signals_to_send = []
        
        for signal in signals:
            # 1. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é–‹å•Ÿæ­¤é¡é€šçŸ¥
            setting_key = self.SIGNAL_TO_SETTING.get(signal.signal_type)
            if setting_key and not alert_settings.get(setting_key, True):
                filtered_count += 1
                continue
            
            # 2. æª¢æŸ¥æ˜¯å¦æœ€è¿‘å·²é€šçŸ¥é
            if await self.is_recently_notified(
                db, user_id, signal.symbol, signal.signal_type.value
            ):
                skipped_count += 1
                continue
            
            signals_to_send.append(signal)
        
        # 3. ç™¼é€ LINE é€šçŸ¥
        if signals_to_send and line_user_id:
            # åˆä½µè¨Šæ¯ç™¼é€
            message = signal_service.format_signals_summary(signals_to_send)
            
            success = await line_notify_service.push_text_message(
                line_user_id, message
            )
            
            # 4. å„²å­˜é€šçŸ¥è¨˜éŒ„
            for signal in signals_to_send:
                await self.save_notification(db, user_id, signal, sent=success)
                if success:
                    sent_count += 1
        
        return {
            "sent": sent_count,
            "skipped": skipped_count,
            "filtered": filtered_count,
        }
    
    async def run_signal_check(self, db: AsyncSession) -> Dict[str, Any]:
        """
        åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥ï¼ˆä¸»è¦å…¥å£ï¼‰
        
        æµç¨‹ï¼š
        1. å–å¾—æ‰€æœ‰è¿½è¹¤çš„è‚¡ç¥¨
        2. è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        3. åµæ¸¬è¨Šè™Ÿ
        4. æ ¹æ“šç”¨æˆ¶è¨­å®šéæ¿¾ä¸¦ç™¼é€é€šçŸ¥
        
        Returns:
            åŸ·è¡Œçµæœæ‘˜è¦
        """
        logger.info("=" * 50)
        logger.info("é–‹å§‹åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥")
        logger.info("=" * 50)
        
        start_time = datetime.now()
        result = {
            "symbols_checked": 0,
            "signals_detected": 0,
            "notifications_sent": 0,
            "errors": [],
        }
        
        try:
            # 1. å–å¾—æ‰€æœ‰è¿½è¹¤çš„è‚¡ç¥¨
            symbol_users = await self.get_all_tracked_symbols(db)
            
            if not symbol_users:
                logger.info("ç„¡è¿½è¹¤æ¨™çš„ï¼ŒçµæŸæª¢æŸ¥")
                return result
            
            all_signals_by_symbol = {}  # {symbol: [signals]}
            
            # 2. é€ä¸€è¨ˆç®—æŒ‡æ¨™ä¸¦åµæ¸¬è¨Šè™Ÿ
            for key, info in symbol_users.items():
                symbol = info["symbol"]
                asset_type = info["asset_type"]
                
                try:
                    # å–å¾—è‚¡åƒ¹è³‡æ–™
                    if asset_type == "stock":
                        df = yahoo_finance.get_stock_history(symbol, period="6mo")
                    else:
                        # åŠ å¯†è²¨å¹£è™•ç†
                        from app.services.crypto_service import crypto_service
                        df = await crypto_service.get_crypto_history(symbol, period="6mo")
                    
                    if df is None or df.empty:
                        logger.warning(f"{symbol} ç„¡æ³•å–å¾—è³‡æ–™")
                        continue
                    
                    # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
                    indicators = indicator_service.calculate_all_indicators(df)
                    
                    if not indicators:
                        continue
                    
                    # åµæ¸¬è¨Šè™Ÿ
                    signals = signal_service.detect_signals(
                        symbol, indicators, asset_type
                    )
                    
                    if signals:
                        all_signals_by_symbol[key] = {
                            "signals": signals,
                            "users": info["users"],
                        }
                        result["signals_detected"] += len(signals)
                    
                    result["symbols_checked"] += 1
                    
                except Exception as e:
                    logger.error(f"è™•ç† {symbol} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                    result["errors"].append(f"{symbol}: {str(e)}")
            
            # 3. ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
            for key, data in all_signals_by_symbol.items():
                signals = data["signals"]
                user_ids = data["users"]
                
                for user_id in user_ids:
                    try:
                        # å–å¾—ç”¨æˆ¶ LINE ID
                        user_result = await db.execute(
                            select(User).where(User.id == user_id)
                        )
                        user = user_result.scalar_one_or_none()
                        
                        if not user or not user.line_user_id:
                            continue
                        
                        # è™•ç†ä¸¦ç™¼é€é€šçŸ¥
                        send_result = await self.process_signals_for_user(
                            db, user_id, user.line_user_id, signals
                        )
                        
                        result["notifications_sent"] += send_result["sent"]
                        
                    except Exception as e:
                        logger.error(f"ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶ {user_id} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                        result["errors"].append(f"user_{user_id}: {str(e)}")
            
            # 4. æª¢æŸ¥å¸‚å ´æƒ…ç·’
            try:
                from app.services.market_service import MarketService
                market_service = MarketService()
                sentiment = await market_service.get_current_sentiment()
                
                sentiment_signals = signal_service.detect_sentiment_signals(sentiment)
                
                if sentiment_signals:
                    result["signals_detected"] += len(sentiment_signals)
                    # æƒ…ç·’è¨Šè™Ÿç™¼é€çµ¦æ‰€æœ‰é–‹å•Ÿæ­¤é€šçŸ¥çš„ç”¨æˆ¶
                    # ï¼ˆé€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›å¯ä»¥æ›´ç²¾ç´°æ§åˆ¶ï¼‰
                    logger.info(f"åµæ¸¬åˆ° {len(sentiment_signals)} å€‹æƒ…ç·’è¨Šè™Ÿ")
                    
            except Exception as e:
                logger.error(f"æª¢æŸ¥å¸‚å ´æƒ…ç·’æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            
        except Exception as e:
            logger.error(f"è¨Šè™Ÿæª¢æŸ¥ç™¼ç”Ÿåš´é‡éŒ¯èª¤: {e}", exc_info=True)
            result["errors"].append(f"critical: {str(e)}")
        
        elapsed = (datetime.now() - start_time).total_seconds()
        result["elapsed_seconds"] = round(elapsed, 2)
        
        logger.info(f"è¨Šè™Ÿæª¢æŸ¥å®Œæˆ: {result}")
        return result
    
    async def get_user_notifications(
        self,
        db: AsyncSession,
        user_id: int,
        limit: int = 50,
        unread_only: bool = False
    ) -> List[Dict]:
        """å–å¾—ç”¨æˆ¶çš„é€šçŸ¥æ­·å²"""
        query = select(Notification).where(
            Notification.user_id == user_id
        ).order_by(Notification.triggered_at.desc()).limit(limit)
        
        if unread_only:
            query = query.where(Notification.sent == False)
        
        result = await db.execute(query)
        notifications = result.scalars().all()
        
        return [n.to_dict() for n in notifications]


# å–®ä¾‹
notification_service = NotificationService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/price_cache_service.py  â­â­â­
> Ã¥Æ’Â¹Ã¦Â Â¼Ã¥Â¿Â«Ã¥Ââ€“Ã¦Å“ÂÃ¥â€¹â„¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Ã¥Æ’Â¹Ã¦Â Â¼Ã¥Â¿Â«Ã¥Ââ€“Ã¦Å“ÂÃ¥â€¹â„¢
Ã¨Â²Â Ã¨Â²Â¬Ã¦â€°Â¹Ã¦Â¬Â¡Ã¦â€ºÂ´Ã¦â€“Â°Ã¨Â¿Â½Ã¨Â¹Â¤Ã¨â€šÂ¡Ã§Â¥Â¨Ã§Å¡â€Ã¥ÂÂ³Ã¦â„¢â€šÃ¥Æ’Â¹Ã¦Â Â¼

Ã¦Å½â€™Ã§Â¨â€¹Ã©â€šÂÃ¨Â¼Â¯Ã¯Â¼Å¡
- Ã¥ÂÂ°Ã¨â€šÂ¡Ã©â€“â€¹Ã§â€ºÂ¤ (09:00-13:30)Ã¯Â¼Å¡Ã¦Â¯Â 10 Ã¥Ë†â€ Ã©ÂËœÃ¦â€ºÂ´Ã¦â€“Â°Ã¥ÂÂ°Ã¨â€šÂ¡
- Ã§Â¾Å½Ã¨â€šÂ¡Ã©â€“â€¹Ã§â€ºÂ¤ (21:30-05:00)Ã¯Â¼Å¡Ã¦Â¯Â 10 Ã¥Ë†â€ Ã©ÂËœÃ¦â€ºÂ´Ã¦â€“Â°Ã§Â¾Å½Ã¨â€šÂ¡
- Ã¦â€Â¶Ã§â€ºÂ¤Ã¥Â¾Å’Ã¯Â¼Å¡Ã¤Â¸ÂÃ¦â€ºÂ´Ã¦â€“Â°Ã¯Â¼Ë†Ã¤Â½Â¿Ã§â€Â¨Ã¦â€Â¶Ã§â€ºÂ¤Ã¥Æ’Â¹Ã¯Â¼â€°
- Ã¥Å Â Ã¥Â¯â€ Ã¨Â²Â¨Ã¥Â¹Â£Ã¯Â¼Å¡24 Ã¥Â°ÂÃ¦â„¢â€šÃ¦Â¯Â 10 Ã¥Ë†â€ Ã©ÂËœÃ¦â€ºÂ´Ã¦â€“Â°
"""
import logging
from datetime import datetime, time
from typing import Dict, List, Any
from sqlalchemy.orm import Session
from sqlalchemy import select, distinct
import yfinance as yf

from app.models.price_cache import StockPriceCache
from app.models.watchlist import Watchlist

logger = logging.getLogger(__name__)


# Ã¥ÂÂ°Ã¨â€šÂ¡Ã¥ÂÂÃ§Â¨Â±Ã¥Â°ÂÃ§â€¦Â§Ã¯Â¼Ë†Ã¥Â¸Â¸Ã¨Â¦â€¹Ã§Å¡â€Ã¯Â¼â€°
TAIWAN_STOCK_NAMES = {
    # ===== æ¬Šå€¼è‚¡ =====
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    # ===== é‡‘èè‚¡ =====
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    "5876": "ä¸Šæµ·å•†éŠ€",
    # ===== é›»å­è‚¡ =====
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "2351": "é †å¾·",
    "2354": "é´»æº–",
    "2360": "è‡´èŒ‚",
    "2385": "ç¾¤å…‰",
    "2388": "å¨ç››",
    "2392": "æ­£å´´",
    "2401": "å‡Œé™½",
    "2402": "æ¯…å˜‰",
    # ===== èˆªé‹/å‚³ç”¢ =====
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    # ===== ç”ŸæŠ€ =====
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ===== ETF =====
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "0057": "å¯Œé‚¦æ‘©å°",
    "006205": "å¯Œé‚¦ä¸Šè­‰",
    "006206": "å…ƒå¤§ä¸Šè­‰50",
    "006208": "å¯Œé‚¦å°50",
    "00631L": "å…ƒå¤§å°ç£50æ­£2",
    "00632R": "å…ƒå¤§å°ç£50å1",
    "00635U": "å…ƒå¤§S&Pé»ƒé‡‘",
    "00636": "åœ‹æ³°ä¸­åœ‹A50",
    "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
    "00639": "å¯Œé‚¦æ·±100",
    "00642U": "å…ƒå¤§S&PçŸ³æ²¹",
    "00645": "å¯Œé‚¦æ—¥æœ¬",
    "00646": "å…ƒå¤§S&P500",
    "00647L": "å…ƒå¤§S&P500æ­£2",
    "00648R": "å…ƒå¤§S&P500å1",
    "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
    "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
    "00657": "åœ‹æ³°æ—¥ç¶“225",
    "00661": "å…ƒå¤§æ—¥ç¶“225",
    "00662": "å¯Œé‚¦NASDAQ",
    "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
    "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
    "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
    "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
    "00670L": "å¯Œé‚¦NASDAQæ­£2",
    "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
    "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
    "00677U": "å¯Œé‚¦VIX",
    "00678": "ç¾¤ç›ŠNBIç”ŸæŠ€",
    "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
    "00681R": "å…ƒå¤§ç¾å‚µ20å1",
    "00682U": "å…ƒå¤§ç¾å‚µ20å¹´",
    "00690": "å…†è±è—ç±Œ30",
    "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
    "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
    "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
    "00757": "çµ±ä¸€FANG+",
    "00762": "å…ƒå¤§å…¨çƒAI",
    "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00851": "å°æ–°å…¨çƒAI",
    "00852L": "åœ‹æ³°ç¾åœ‹è²»åŠæ­£2",
    "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
    "00876": "å…ƒå¤§å…¨çƒ5G",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00885": "å¯Œé‚¦è¶Šå—",
    "00886": "å…ƒå¤§å…¨çƒé›²ç«¯æœå‹™",
    "00887": "æ°¸è±å°ç£ESG",
    "00888": "æ°¸è±ç¾åœ‹è²»åŠ",
    "00889": "æ°¸è±å°ç£æ™ºèƒ½è»Š",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00896": "ä¸­ä¿¡ç¶ èƒ½é›»å‹•è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
    "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
    "00905": "FTè‡ºç£Smart",
    "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
    "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
    "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
    "00916": "åœ‹æ³°å…¨çƒå“ç‰Œ50",
    "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
    "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
    "00923": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
    "00931": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
    "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
    "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
    "00935": "é‡æ‘å°ç£æ–°ç§‘æŠ€50",
    "00936": "å°æ–°è‡ºç£ICè¨­è¨ˆ",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}



# ============================================================
# Ã©â€“â€¹Ã§â€ºÂ¤Ã¦â„¢â€šÃ©â€“â€œÃ¥Ë†Â¤Ã¦â€“Â·Ã¯Â¼Ë†Ã¥ÂÂ°Ã§ÂÂ£Ã¦â„¢â€šÃ©â€“â€œÃ¯Â¼â€°
# ============================================================

def is_tw_market_open() -> bool:
    """Ã¥Ë†Â¤Ã¦â€“Â·Ã¥ÂÂ°Ã¨â€šÂ¡Ã¦ËœÂ¯Ã¥ÂÂ¦Ã©â€“â€¹Ã§â€ºÂ¤Ã¯Â¼Ë†Ã©â‚¬Â±Ã¤Â¸â‚¬Ã¥Ë†Â°Ã©â‚¬Â±Ã¤Âºâ€ 09:00-13:30Ã¯Â¼â€°"""
    now = datetime.now()
    if now.weekday() >= 5:
        return False
    return time(9, 0) <= now.time() <= time(13, 30)


def is_us_market_open() -> bool:
    """Ã¥Ë†Â¤Ã¦â€“Â·Ã§Â¾Å½Ã¨â€šÂ¡Ã¦ËœÂ¯Ã¥ÂÂ¦Ã©â€“â€¹Ã§â€ºÂ¤Ã¯Â¼Ë†Ã¥ÂÂ°Ã§ÂÂ£Ã¦â„¢â€šÃ©â€“â€œ 21:30-05:00Ã¯Â¼â€°"""
    now = datetime.now()
    weekday = now.weekday()
    current_time = now.time()
    
    # Ã¦â„¢Å¡Ã¤Â¸Å  21:30 Ã¥Â¾Å’Ã¯Â¼Ë†Ã©â‚¬Â±Ã¤Â¸â‚¬Ã¥Ë†Â°Ã©â‚¬Â±Ã¤Âºâ€Ã¯Â¼â€°
    if weekday < 5 and current_time >= time(21, 30):
        return True
    # Ã¥â€¡Å’Ã¦â„¢Â¨ 05:00 Ã¥â€°ÂÃ¯Â¼Ë†Ã©â‚¬Â±Ã¤ÂºÅ’Ã¥Ë†Â°Ã©â‚¬Â±Ã¥â€¦Â­Ã¯Â¼â€°
    if weekday > 0 and current_time <= time(5, 0):
        return True
    # Ã©â‚¬Â±Ã¥â€¦Â­Ã¥â€¡Å’Ã¦â„¢Â¨
    if weekday == 5 and current_time <= time(5, 0):
        return True
    return False


def get_market_status() -> Dict[str, bool]:
    """Ã¥Ââ€“Ã¥Â¾â€”Ã¥Ââ€Ã¥Â¸â€šÃ¥Â Â´Ã©â€“â€¹Ã§â€ºÂ¤Ã§â€¹â‚¬Ã¦â€¦â€¹"""
    return {
        "tw_open": is_tw_market_open(),
        "us_open": is_us_market_open(),
        "crypto_open": True,
    }


# ============================================================
# Ã¥Æ’Â¹Ã¦Â Â¼Ã¥Â¿Â«Ã¥Ââ€“Ã¦Å“ÂÃ¥â€¹â„¢
# ============================================================

class PriceCacheService:
    """Ã¥Æ’Â¹Ã¦Â Â¼Ã¥Â¿Â«Ã¥Ââ€“Ã¦Å“ÂÃ¥â€¹â„¢"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_all_tracked_symbols(self) -> Dict[str, List[str]]:
        """Ã¥Ââ€“Ã¥Â¾â€”Ã¦â€°â‚¬Ã¦Å“â€°Ã¨Â¢Â«Ã¨Â¿Â½Ã¨Â¹Â¤Ã§Å¡â€ symbolÃ¯Â¼Ë†Ã¥Å½Â»Ã©â€¡ÂÃ¯Â¼Å’Ã¦Å’â€°Ã¥Â¸â€šÃ¥Â Â´Ã¥Ë†â€ Ã©Â¡Å¾Ã¯Â¼â€°"""
        stmt = select(distinct(Watchlist.symbol), Watchlist.asset_type)
        results = self.db.execute(stmt).all()
        
        tw_stocks = []
        us_stocks = []
        crypto = []
        
        for symbol, asset_type in results:
            if asset_type == "crypto":
                crypto.append(symbol)
            elif symbol.endswith((".TW", ".TWO")):
                tw_stocks.append(symbol)
            else:
                us_stocks.append(symbol)
        
        logger.info(f"Ã¨Â¿Â½Ã¨Â¹Â¤: Ã¥ÂÂ°Ã¨â€šÂ¡ {len(tw_stocks)}, Ã§Â¾Å½Ã¨â€šÂ¡ {len(us_stocks)}, Ã¥Å Â Ã¥Â¯â€ Ã¨Â²Â¨Ã¥Â¹Â£ {len(crypto)}")
        return {"tw_stocks": tw_stocks, "us_stocks": us_stocks, "crypto": crypto}
    
    def batch_update_stock_prices(self, symbols: List[str]) -> Dict[str, Any]:
        """Ã¦â€°Â¹Ã¦Â¬Â¡Ã¦â€ºÂ´Ã¦â€“Â°Ã¨â€šÂ¡Ã§Â¥Â¨Ã¥Æ’Â¹Ã¦Â Â¼"""
        if not symbols:
            return {"updated": 0, "failed": []}
        
        result = {"updated": 0, "failed": []}
        logger.info(f"Ã©â€“â€¹Ã¥Â§â€¹Ã¦â€ºÂ´Ã¦â€“Â° {len(symbols)} Ã¦â€Â¯Ã¨â€šÂ¡Ã§Â¥Â¨...")
        
        try:
            # Ã¤Â½Â¿Ã§â€Â¨ yfinance Ã¦â€°Â¹Ã¦Â¬Â¡Ã¥Ââ€“Ã¥Â¾â€”
            tickers = yf.Tickers(" ".join(symbols))
            
            for symbol in symbols:
                try:
                    ticker = tickers.tickers.get(symbol)
                    if not ticker:
                        result["failed"].append(symbol)
                        continue
                    
                    info = ticker.info
                    if not info:
                        result["failed"].append(symbol)
                        continue
                    
                    # Ã¥Ââ€“Ã¥Â¾â€”Ã¥Æ’Â¹Ã¦Â Â¼
                    price = info.get("regularMarketPrice") or info.get("currentPrice")
                    prev_close = info.get("regularMarketPreviousClose") or info.get("previousClose")
                    
                    if price is None:
                        # Ã¥Ëœâ€”Ã¨Â©Â¦Ã¥Â¾Å¾Ã¦Â­Â·Ã¥ÂÂ²Ã¨Â³â€¡Ã¦â€“â„¢Ã¥Ââ€“Ã¥Â¾â€”
                        hist = ticker.history(period="2d")
                        if not hist.empty:
                            price = float(hist['Close'].iloc[-1])
                            if len(hist) > 1:
                                prev_close = float(hist['Close'].iloc[-2])
                    
                    if price is None:
                        result["failed"].append(symbol)
                        continue
                    
                    # Ã¨Â¨Ë†Ã§Â®â€”Ã¦Â¼Â²Ã¨Â·Å’
                    change = None
                    change_pct = None
                    if prev_close and prev_close > 0:
                        change = price - prev_close
                        change_pct = (change / prev_close) * 100
                    
                    # Ã¥Ââ€“Ã¥Â¾â€”Ã¥ÂÂÃ§Â¨Â±
                    name = info.get("shortName") or info.get("longName") or ""
                    if not name and symbol.endswith((".TW", ".TWO")):
                        stock_code = symbol.replace(".TW", "").replace(".TWO", "")
                        name = TAIWAN_STOCK_NAMES.get(stock_code, "")
                    
                    # Ã¥Ââ€“Ã¥Â¾â€”Ã¦Ë†ÂÃ¤ÂºÂ¤Ã©â€¡Â
                    volume = info.get("regularMarketVolume") or info.get("volume")
                    
                    # Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Â¿Â«Ã¥Ââ€“
                    self._upsert_cache(
                        symbol=symbol,
                        name=name,
                        price=price,
                        prev_close=prev_close,
                        change=change,
                        change_pct=change_pct,
                        volume=volume,
                        asset_type="stock",
                    )
                    result["updated"] += 1
                    
                except Exception as e:
                    logger.error(f"Ã¦â€ºÂ´Ã¦â€“Â° {symbol} Ã¥Â¤Â±Ã¦â€¢â€”: {e}")
                    result["failed"].append(symbol)
            
            self.db.commit()
            logger.info(f"Ã¨â€šÂ¡Ã§Â¥Â¨Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Â®Å’Ã¦Ë†Â: Ã¦Ë†ÂÃ¥Å Å¸ {result['updated']}, Ã¥Â¤Â±Ã¦â€¢â€” {len(result['failed'])}")
            
        except Exception as e:
            logger.error(f"Ã¦â€°Â¹Ã¦Â¬Â¡Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Â¤Â±Ã¦â€¢â€”: {e}")
        
        return result
    
    def batch_update_crypto_prices(self, symbols: List[str]) -> Dict[str, Any]:
        """Ã¦â€°Â¹Ã¦Â¬Â¡Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Å Â Ã¥Â¯â€ Ã¨Â²Â¨Ã¥Â¹Â£Ã¥Æ’Â¹Ã¦Â Â¼"""
        if not symbols:
            return {"updated": 0, "failed": []}
        
        result = {"updated": 0, "failed": []}
        
        try:
            from app.data_sources.coingecko import coingecko
            
            for symbol in symbols:
                try:
                    data = coingecko.get_price(symbol)
                    if not data or data.get("price") is None:
                        result["failed"].append(symbol)
                        continue
                    
                    self._upsert_cache(
                        symbol=symbol,
                        name=data.get("name", symbol),
                        price=data["price"],
                        prev_close=None,
                        change=None,
                        change_pct=data.get("change_24h"),
                        volume=data.get("volume_24h"),
                        asset_type="crypto",
                    )
                    result["updated"] += 1
                    
                except Exception as e:
                    logger.error(f"Ã¦â€ºÂ´Ã¦â€“Â° {symbol} Ã¥Â¤Â±Ã¦â€¢â€”: {e}")
                    result["failed"].append(symbol)
            
            self.db.commit()
            
        except Exception as e:
            logger.error(f"Ã¥Å Â Ã¥Â¯â€ Ã¨Â²Â¨Ã¥Â¹Â£Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Â¤Â±Ã¦â€¢â€”: {e}")
        
        return result
    
    def _upsert_cache(self, symbol, name, price, prev_close, change, change_pct, volume, asset_type):
        """Ã¦â€ºÂ´Ã¦â€“Â°Ã¦Ë†â€“Ã¦â€“Â°Ã¥Â¢Å¾Ã¥Â¿Â«Ã¥Ââ€“"""
        cache = self.db.query(StockPriceCache).filter(
            StockPriceCache.symbol == symbol
        ).first()
        
        if cache:
            cache.name = name or cache.name
            cache.price = price
            cache.prev_close = prev_close
            cache.change = change
            cache.change_pct = change_pct
            cache.volume = volume
            cache.updated_at = datetime.now()
        else:
            cache = StockPriceCache(
                symbol=symbol,
                name=name,
                price=price,
                prev_close=prev_close,
                change=change,
                change_pct=change_pct,
                volume=volume,
                asset_type=asset_type,
            )
            self.db.add(cache)
    
    def update_all(self, force: bool = False) -> Dict[str, Any]:
        """
        Ã¦â€ºÂ´Ã¦â€“Â°Ã¦â€°â‚¬Ã¦Å“â€°Ã¨Â¿Â½Ã¨Â¹Â¤Ã§Å¡â€Ã¥Æ’Â¹Ã¦Â Â¼
        
        - force=True: Ã¥Â¼Â·Ã¥Ë†Â¶Ã¦â€ºÂ´Ã¦â€“Â°Ã¦â€°â‚¬Ã¦Å“â€°
        - force=False: Ã¥ÂÂªÃ¦â€ºÂ´Ã¦â€“Â°Ã©â€“â€¹Ã§â€ºÂ¤Ã¤Â¸Â­Ã§Å¡â€Ã¥Â¸â€šÃ¥Â Â´
        """
        logger.info("=" * 40)
        logger.info(f"Ã©â€“â€¹Ã¥Â§â€¹Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Æ’Â¹Ã¦Â Â¼Ã¥Â¿Â«Ã¥Ââ€“ (force={force})")
        logger.info(f"Ã¦â„¢â€šÃ©â€“â€œ: {datetime.now()}")
        
        tw_open = is_tw_market_open()
        us_open = is_us_market_open()
        logger.info(f"Ã¥ÂÂ°Ã¨â€šÂ¡: {'Ã©â€“â€¹Ã§â€ºÂ¤' if tw_open else 'Ã¦â€Â¶Ã§â€ºÂ¤'}, Ã§Â¾Å½Ã¨â€šÂ¡: {'Ã©â€“â€¹Ã§â€ºÂ¤' if us_open else 'Ã¦â€Â¶Ã§â€ºÂ¤'}")
        logger.info("=" * 40)
        
        tracked = self.get_all_tracked_symbols()
        
        result = {
            "tw_stocks": {"updated": 0, "failed": [], "skipped": False},
            "us_stocks": {"updated": 0, "failed": [], "skipped": False},
            "crypto": {"updated": 0, "failed": []},
            "timestamp": datetime.now().isoformat(),
        }
        
        # Ã¥ÂÂ°Ã¨â€šÂ¡
        if force or tw_open:
            if tracked["tw_stocks"]:
                result["tw_stocks"] = self.batch_update_stock_prices(tracked["tw_stocks"])
        else:
            result["tw_stocks"]["skipped"] = True
        
        # Ã§Â¾Å½Ã¨â€šÂ¡
        if force or us_open:
            if tracked["us_stocks"]:
                result["us_stocks"] = self.batch_update_stock_prices(tracked["us_stocks"])
        else:
            result["us_stocks"]["skipped"] = True
        
        # Ã¥Å Â Ã¥Â¯â€ Ã¨Â²Â¨Ã¥Â¹Â£Ã¯Â¼Ë†24Ã¥Â°ÂÃ¦â„¢â€šÃ¯Â¼â€°
        if tracked["crypto"]:
            result["crypto"] = self.batch_update_crypto_prices(tracked["crypto"])
        
        result["total_updated"] = (
            result["tw_stocks"].get("updated", 0) +
            result["us_stocks"].get("updated", 0) +
            result["crypto"].get("updated", 0)
        )
        
        logger.info(f"Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Â®Å’Ã¦Ë†Â: Ã¥â€¦Â± {result['total_updated']} Ã§Â­â€ ")
        return result
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/signal_service.py  â­â­â­
> è¨Šè™Ÿåµæ¸¬æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨Šè™Ÿåµæ¸¬æœå‹™
åµæ¸¬æŠ€è¡“æŒ‡æ¨™è¨Šè™Ÿï¼ˆé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ç­‰ï¼‰
"""
import logging
from datetime import datetime, date, timedelta
from typing import Dict, List, Any, Optional, Tuple
from dataclasses import dataclass
from enum import Enum

logger = logging.getLogger(__name__)


class SignalType(str, Enum):
    """è¨Šè™Ÿé¡å‹"""
    # å‡ç·š
    MA_GOLDEN_CROSS = "ma_golden_cross"
    MA_DEATH_CROSS = "ma_death_cross"
    APPROACHING_BREAKOUT = "approaching_breakout"
    APPROACHING_BREAKDOWN = "approaching_breakdown"
    BREAKOUT = "breakout"
    BREAKDOWN = "breakdown"
    
    # RSI
    RSI_OVERBOUGHT = "rsi_overbought"
    RSI_OVERSOLD = "rsi_oversold"
    
    # MACD
    MACD_GOLDEN_CROSS = "macd_golden_cross"
    MACD_DEATH_CROSS = "macd_death_cross"
    
    # KD
    KD_GOLDEN_CROSS = "kd_golden_cross"
    KD_DEATH_CROSS = "kd_death_cross"
    
    # å¸ƒæ—é€šé“
    BOLLINGER_BREAKOUT = "bollinger_breakout"
    BOLLINGER_BREAKDOWN = "bollinger_breakdown"
    
    # æˆäº¤é‡
    VOLUME_SURGE = "volume_surge"
    
    # å¸‚å ´æƒ…ç·’
    SENTIMENT_EXTREME_FEAR = "sentiment_extreme_fear"
    SENTIMENT_EXTREME_GREED = "sentiment_extreme_greed"


@dataclass
class Signal:
    """è¨Šè™Ÿè³‡æ–™"""
    symbol: str
    asset_type: str  # stock / crypto
    signal_type: SignalType
    indicator: str
    message: str
    price: float
    details: Dict[str, Any]
    timestamp: datetime


class SignalService:
    """è¨Šè™Ÿåµæ¸¬æœå‹™"""
    
    # è¨Šè™Ÿé¡å‹ä¸­æ–‡å°ç…§
    SIGNAL_NAMES = {
        SignalType.MA_GOLDEN_CROSS: "å‡ç·šé»ƒé‡‘äº¤å‰",
        SignalType.MA_DEATH_CROSS: "å‡ç·šæ­»äº¡äº¤å‰",
        SignalType.APPROACHING_BREAKOUT: "æ¥è¿‘å‘ä¸Šçªç ´",
        SignalType.APPROACHING_BREAKDOWN: "æ¥è¿‘å‘ä¸‹è·Œç ´",
        SignalType.BREAKOUT: "å‘ä¸Šçªç ´",
        SignalType.BREAKDOWN: "å‘ä¸‹è·Œç ´",
        SignalType.RSI_OVERBOUGHT: "RSI è¶…è²·",
        SignalType.RSI_OVERSOLD: "RSI è¶…è³£",
        SignalType.MACD_GOLDEN_CROSS: "MACD é»ƒé‡‘äº¤å‰",
        SignalType.MACD_DEATH_CROSS: "MACD æ­»äº¡äº¤å‰",
        SignalType.KD_GOLDEN_CROSS: "KD é»ƒé‡‘äº¤å‰",
        SignalType.KD_DEATH_CROSS: "KD æ­»äº¡äº¤å‰",
        SignalType.BOLLINGER_BREAKOUT: "çªç ´å¸ƒæ—ä¸Šè»Œ",
        SignalType.BOLLINGER_BREAKDOWN: "è·Œç ´å¸ƒæ—ä¸‹è»Œ",
        SignalType.VOLUME_SURGE: "æˆäº¤é‡æš´å¢",
        SignalType.SENTIMENT_EXTREME_FEAR: "æ¥µåº¦ææ‡¼",
        SignalType.SENTIMENT_EXTREME_GREED: "æ¥µåº¦è²ªå©ª",
    }
    
    # è¨Šè™Ÿ Emoji
    SIGNAL_EMOJI = {
        SignalType.MA_GOLDEN_CROSS: "ğŸŸ¢",
        SignalType.MA_DEATH_CROSS: "ğŸ”´",
        SignalType.APPROACHING_BREAKOUT: "â¬†ï¸",
        SignalType.APPROACHING_BREAKDOWN: "â¬‡ï¸",
        SignalType.BREAKOUT: "âœ…",
        SignalType.BREAKDOWN: "âŒ",
        SignalType.RSI_OVERBOUGHT: "âš ï¸",
        SignalType.RSI_OVERSOLD: "ğŸŸ¢",
        SignalType.MACD_GOLDEN_CROSS: "ğŸŸ¢",
        SignalType.MACD_DEATH_CROSS: "ğŸ”´",
        SignalType.KD_GOLDEN_CROSS: "ğŸŸ¢",
        SignalType.KD_DEATH_CROSS: "ğŸ”´",
        SignalType.BOLLINGER_BREAKOUT: "ğŸ“ˆ",
        SignalType.BOLLINGER_BREAKDOWN: "ğŸ“‰",
        SignalType.VOLUME_SURGE: "ğŸ“Š",
        SignalType.SENTIMENT_EXTREME_FEAR: "ğŸ˜±",
        SignalType.SENTIMENT_EXTREME_GREED: "ğŸ¤‘",
    }
    
    def __init__(self):
        # é è¨­åƒæ•¸ï¼ˆå¯è¢«ç”¨æˆ¶è¨­å®šè¦†è“‹ï¼‰
        self.default_params = {
            "ma_short": 20,
            "ma_mid": 50,
            "ma_long": 200,
            "rsi_period": 14,
            "rsi_overbought": 70,
            "rsi_oversold": 30,
            "macd_fast": 12,
            "macd_slow": 26,
            "macd_signal": 9,
            "kd_period": 9,
            "bollinger_period": 20,
            "bollinger_std": 2.0,
            "breakout_threshold": 2.0,  # æ¥è¿‘çªç ´é–€æª» (%)
            "volume_alert_ratio": 2.0,  # é‡æ¯”è­¦æˆ’å€æ•¸
        }
    
    def detect_signals(
        self, 
        symbol: str, 
        indicators: Dict[str, Any],
        asset_type: str = "stock",
        params: Optional[Dict] = None
    ) -> List[Signal]:
        """
        åµæ¸¬è‚¡ç¥¨/åŠ å¯†è²¨å¹£çš„æŠ€è¡“æŒ‡æ¨™è¨Šè™Ÿ
        
        Args:
            symbol: è‚¡ç¥¨/å¹£ç¨®ä»£è™Ÿ
            indicators: æŠ€è¡“æŒ‡æ¨™è³‡æ–™ï¼ˆä¾†è‡ª indicator_serviceï¼‰
            asset_type: stock / crypto
            params: ç”¨æˆ¶è‡ªè¨‚åƒæ•¸ï¼ˆå¯é¸ï¼‰
            
        Returns:
            åµæ¸¬åˆ°çš„è¨Šè™Ÿåˆ—è¡¨
        """
        signals = []
        p = {**self.default_params, **(params or {})}
        
        current_price = indicators.get("current_price", 0)
        if not current_price:
            logger.warning(f"{symbol} ç„¡æ³•å–å¾—ç¾åƒ¹")
            return signals
        
        now = datetime.now()
        
        # 1. å‡ç·šè¨Šè™Ÿ
        ma_signals = self._detect_ma_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(ma_signals)
        
        # 2. RSI è¨Šè™Ÿ
        rsi_signals = self._detect_rsi_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(rsi_signals)
        
        # 3. MACD è¨Šè™Ÿ
        macd_signals = self._detect_macd_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(macd_signals)
        
        # 4. KD è¨Šè™Ÿ
        kd_signals = self._detect_kd_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(kd_signals)
        
        # 5. å¸ƒæ—é€šé“è¨Šè™Ÿ
        bb_signals = self._detect_bollinger_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(bb_signals)
        
        # 6. æˆäº¤é‡è¨Šè™Ÿ
        vol_signals = self._detect_volume_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(vol_signals)
        
        logger.info(f"{symbol} åµæ¸¬åˆ° {len(signals)} å€‹è¨Šè™Ÿ")
        return signals
    
    def _detect_ma_signals(
        self, symbol: str, indicators: Dict, price: float, 
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬å‡ç·šè¨Šè™Ÿ"""
        signals = []
        ma = indicators.get("ma", {})
        
        if not ma:
            return signals
        
        ma20 = ma.get("ma20")
        ma50 = ma.get("ma50")
        ma200 = ma.get("ma200")
        
        # å‡ç·šäº¤å‰ï¼ˆéœ€è¦æœ‰å‰ä¸€æ—¥è³‡æ–™æ‰èƒ½åˆ¤æ–·ï¼Œé€™è£¡ç°¡åŒ–ç‚ºæª¢æŸ¥ç•¶å‰ç‹€æ…‹ï¼‰
        # å¯¦éš›ä¸Šéœ€è¦æ¯”è¼ƒæ˜¨æ—¥å’Œä»Šæ—¥çš„ MA å€¼
        
        # æ¥è¿‘çªç ´/è·Œç ´æª¢æ¸¬
        threshold_pct = params["breakout_threshold"] / 100
        
        for ma_name, ma_value in [("MA20", ma20), ("MA50", ma50), ("MA200", ma200)]:
            if ma_value is None or ma_value <= 0:
                continue
            
            diff_pct = (price - ma_value) / ma_value
            
            # æ¥è¿‘å‘ä¸Šçªç ´ï¼ˆåƒ¹æ ¼åœ¨å‡ç·šä¸‹æ–¹ï¼Œå·®è·å°æ–¼é–€æª»ï¼‰
            if -threshold_pct < diff_pct < 0:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.APPROACHING_BREAKOUT,
                    indicator=ma_name,
                    message=f"{symbol} æ¥è¿‘çªç ´ {ma_name} ({ma_value:.2f})ï¼Œå·®è· {abs(diff_pct)*100:.1f}%",
                    price=price,
                    details={"ma_name": ma_name, "ma_value": ma_value, "diff_pct": diff_pct},
                    timestamp=now,
                ))
            
            # æ¥è¿‘å‘ä¸‹è·Œç ´ï¼ˆåƒ¹æ ¼åœ¨å‡ç·šä¸Šæ–¹ï¼Œå·®è·å°æ–¼é–€æª»ï¼‰
            elif 0 < diff_pct < threshold_pct:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.APPROACHING_BREAKDOWN,
                    indicator=ma_name,
                    message=f"{symbol} æ¥è¿‘è·Œç ´ {ma_name} ({ma_value:.2f})ï¼Œå·®è· {diff_pct*100:.1f}%",
                    price=price,
                    details={"ma_name": ma_name, "ma_value": ma_value, "diff_pct": diff_pct},
                    timestamp=now,
                ))
        
        # é»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰ï¼ˆMA20 vs MA50ï¼‰
        if ma20 and ma50:
            cross_info = ma.get("cross_info", {})
            if cross_info.get("type") == "golden_cross" and cross_info.get("days_ago", 999) <= 3:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.MA_GOLDEN_CROSS,
                    indicator="MA20/MA50",
                    message=f"{symbol} MA20 é»ƒé‡‘äº¤å‰ MA50",
                    price=price,
                    details={"ma20": ma20, "ma50": ma50},
                    timestamp=now,
                ))
            elif cross_info.get("type") == "death_cross" and cross_info.get("days_ago", 999) <= 3:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.MA_DEATH_CROSS,
                    indicator="MA20/MA50",
                    message=f"{symbol} MA20 æ­»äº¡äº¤å‰ MA50",
                    price=price,
                    details={"ma20": ma20, "ma50": ma50},
                    timestamp=now,
                ))
        
        return signals
    
    def _detect_rsi_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬ RSI è¨Šè™Ÿ"""
        signals = []
        rsi_data = indicators.get("rsi", {})
        
        if not rsi_data:
            return signals
        
        rsi_value = rsi_data.get("value")
        if rsi_value is None:
            return signals
        
        overbought = params["rsi_overbought"]
        oversold = params["rsi_oversold"]
        
        if rsi_value >= overbought:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.RSI_OVERBOUGHT,
                indicator="RSI",
                message=f"{symbol} RSI é” {rsi_value:.1f}ï¼Œé€²å…¥è¶…è²·å€",
                price=price,
                details={"rsi": rsi_value, "threshold": overbought},
                timestamp=now,
            ))
        elif rsi_value <= oversold:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.RSI_OVERSOLD,
                indicator="RSI",
                message=f"{symbol} RSI è·Œè‡³ {rsi_value:.1f}ï¼Œé€²å…¥è¶…è³£å€",
                price=price,
                details={"rsi": rsi_value, "threshold": oversold},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_macd_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬ MACD è¨Šè™Ÿ"""
        signals = []
        macd_data = indicators.get("macd", {})
        
        if not macd_data:
            return signals
        
        dif = macd_data.get("dif")
        macd = macd_data.get("macd")
        histogram = macd_data.get("histogram")
        status = macd_data.get("status", "")
        
        # æ ¹æ“š status åˆ¤æ–·ï¼ˆindicator_service å·²ç¶“è¨ˆç®—å¥½ï¼‰
        if "golden_cross" in status.lower() or status == "bullish_cross":
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.MACD_GOLDEN_CROSS,
                indicator="MACD",
                message=f"{symbol} MACD é»ƒé‡‘äº¤å‰",
                price=price,
                details={"dif": dif, "macd": macd, "histogram": histogram},
                timestamp=now,
            ))
        elif "death_cross" in status.lower() or status == "bearish_cross":
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.MACD_DEATH_CROSS,
                indicator="MACD",
                message=f"{symbol} MACD æ­»äº¡äº¤å‰",
                price=price,
                details={"dif": dif, "macd": macd, "histogram": histogram},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_kd_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬ KD è¨Šè™Ÿ"""
        signals = []
        kd_data = indicators.get("kd", {})
        
        if not kd_data:
            return signals
        
        k = kd_data.get("k")
        d = kd_data.get("d")
        status = kd_data.get("status", "")
        
        # KD äº¤å‰
        if "golden" in status.lower():
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.KD_GOLDEN_CROSS,
                indicator="KD",
                message=f"{symbol} KD é»ƒé‡‘äº¤å‰ (K={k:.1f}, D={d:.1f})",
                price=price,
                details={"k": k, "d": d},
                timestamp=now,
            ))
        elif "death" in status.lower():
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.KD_DEATH_CROSS,
                indicator="KD",
                message=f"{symbol} KD æ­»äº¡äº¤å‰ (K={k:.1f}, D={d:.1f})",
                price=price,
                details={"k": k, "d": d},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_bollinger_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬å¸ƒæ—é€šé“è¨Šè™Ÿ"""
        signals = []
        bb_data = indicators.get("bollinger", {})
        
        if not bb_data:
            return signals
        
        upper = bb_data.get("upper")
        lower = bb_data.get("lower")
        position = bb_data.get("position", "")
        
        if upper and price >= upper:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.BOLLINGER_BREAKOUT,
                indicator="Bollinger",
                message=f"{symbol} çªç ´å¸ƒæ—ä¸Šè»Œ ({upper:.2f})",
                price=price,
                details={"upper": upper, "lower": lower, "price": price},
                timestamp=now,
            ))
        elif lower and price <= lower:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.BOLLINGER_BREAKDOWN,
                indicator="Bollinger",
                message=f"{symbol} è·Œç ´å¸ƒæ—ä¸‹è»Œ ({lower:.2f})",
                price=price,
                details={"upper": upper, "lower": lower, "price": price},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_volume_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬æˆäº¤é‡è¨Šè™Ÿ"""
        signals = []
        vol_data = indicators.get("volume", {})
        
        if not vol_data:
            return signals
        
        ratio = vol_data.get("ratio")
        alert_ratio = params["volume_alert_ratio"]
        
        if ratio and ratio >= alert_ratio:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.VOLUME_SURGE,
                indicator="Volume",
                message=f"{symbol} æˆäº¤é‡æš´å¢ (é‡æ¯” {ratio:.1f})",
                price=price,
                details={"ratio": ratio, "threshold": alert_ratio},
                timestamp=now,
            ))
        
        return signals
    
    def detect_sentiment_signals(
        self, sentiment_data: Dict[str, Any]
    ) -> List[Signal]:
        """
        åµæ¸¬å¸‚å ´æƒ…ç·’è¨Šè™Ÿ
        
        Args:
            sentiment_data: æƒ…ç·’è³‡æ–™ {"stock": {...}, "crypto": {...}}
            
        Returns:
            åµæ¸¬åˆ°çš„è¨Šè™Ÿåˆ—è¡¨
        """
        signals = []
        now = datetime.now()
        
        for market, data in sentiment_data.items():
            if not data:
                continue
            
            value = data.get("value")
            if value is None:
                continue
            
            asset_type = "stock" if market == "stock" else "crypto"
            market_name = "ç¾è‚¡" if market == "stock" else "å¹£åœˆ"
            
            if value <= 20:
                signals.append(Signal(
                    symbol=market_name,
                    asset_type=asset_type,
                    signal_type=SignalType.SENTIMENT_EXTREME_FEAR,
                    indicator="Fear & Greed",
                    message=f"{market_name}æ¥µåº¦ææ‡¼ ({value})ï¼Œç•™æ„è²·å…¥æ©Ÿæœƒ",
                    price=0,
                    details={"value": value, "classification": data.get("classification")},
                    timestamp=now,
                ))
            elif value >= 80:
                signals.append(Signal(
                    symbol=market_name,
                    asset_type=asset_type,
                    signal_type=SignalType.SENTIMENT_EXTREME_GREED,
                    indicator="Fear & Greed",
                    message=f"{market_name}æ¥µåº¦è²ªå©ª ({value})ï¼Œç•™æ„é¢¨éšª",
                    price=0,
                    details={"value": value, "classification": data.get("classification")},
                    timestamp=now,
                ))
        
        return signals
    
    def format_signal_message(self, signal: Signal) -> str:
        """æ ¼å¼åŒ–è¨Šè™Ÿè¨Šæ¯ï¼ˆç”¨æ–¼ LINE æ¨æ’­ï¼‰"""
        emoji = self.SIGNAL_EMOJI.get(signal.signal_type, "ğŸ“¢")
        return f"{emoji} {signal.message}"
    
    def format_signals_summary(self, signals: List[Signal]) -> str:
        """
        æ ¼å¼åŒ–å¤šå€‹è¨Šè™Ÿç‚ºæ‘˜è¦è¨Šæ¯
        
        Args:
            signals: è¨Šè™Ÿåˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–çš„è¨Šæ¯æ–‡å­—
        """
        if not signals:
            return ""
        
        # æŒ‰è‚¡ç¥¨åˆ†çµ„
        by_symbol = {}
        for s in signals:
            if s.symbol not in by_symbol:
                by_symbol[s.symbol] = []
            by_symbol[s.symbol].append(s)
        
        lines = ["ğŸ“Š æŠ€è¡“è¨Šè™Ÿé€šçŸ¥", ""]
        
        for symbol, symbol_signals in by_symbol.items():
            lines.append(f"ã€{symbol}ã€‘")
            for s in symbol_signals:
                emoji = self.SIGNAL_EMOJI.get(s.signal_type, "â€¢")
                name = self.SIGNAL_NAMES.get(s.signal_type, str(s.signal_type))
                if s.price > 0:
                    lines.append(f"  {emoji} {name} @ ${s.price:.2f}")
                else:
                    lines.append(f"  {emoji} {s.message}")
            lines.append("")
        
        lines.append(f"â° {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        
        return "\n".join(lines)


# å–®ä¾‹
signal_service = SignalService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/stock_service.py  â­â­â­
> è‚¡ç¥¨æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨æœå‹™
æ•´åˆè³‡æ–™æŠ“å–ã€å¿«å–å’ŒæŠ€è¡“æŒ‡æ¨™è¨ˆç®—
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Dict, Any, List
from sqlalchemy.orm import Session
from sqlalchemy import select, and_
import logging

from app.models.stock_price import StockPrice
from app.data_sources.yahoo_finance import yahoo_finance
from app.services.indicator_service import indicator_service, TrendDirection
from app.config import settings

logger = logging.getLogger(__name__)


class StockService:
    """è‚¡ç¥¨æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def _is_cache_valid(self, symbol: str) -> bool:
        """
        æª¢æŸ¥å¿«å–æ˜¯å¦æœ‰æ•ˆ
        
        è¦å‰‡ï¼š
        1. æœ‰ä»Šæ—¥è³‡æ–™
        2. æˆ–æ˜¯é€±æœ«/å‡æ—¥æ™‚æœ‰æœ€è¿‘äº¤æ˜“æ—¥è³‡æ–™
        """
        today = date.today()
        
        # æŸ¥è©¢æœ€æ–°è³‡æ–™
        stmt = (
            select(StockPrice)
            .where(StockPrice.symbol == symbol.upper())
            .order_by(StockPrice.date.desc())
            .limit(1)
        )
        result = self.db.execute(stmt).scalar_one_or_none()
        
        if not result:
            return False
        
        # å¦‚æœæœ‰ä»Šæ—¥è³‡æ–™ï¼Œå¿«å–æœ‰æ•ˆ
        if result.date == today:
            return True
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«
        if today.weekday() >= 5:  # é€±å…­=5, é€±æ—¥=6
            # é€±æœ«æ™‚ï¼Œåªè¦æœ‰é€±äº”çš„è³‡æ–™å°±ç®—æœ‰æ•ˆ
            friday = today - timedelta(days=(today.weekday() - 4))
            if result.date >= friday:
                return True
        
        # æª¢æŸ¥æ›´æ–°æ™‚é–“æ˜¯å¦åœ¨å¿«å–æ™‚é–“å…§
        if result.updated_at:
            cache_hours = settings.STOCK_DATA_CACHE_HOURS
            cache_deadline = datetime.now() - timedelta(hours=cache_hours)
            if result.updated_at > cache_deadline:
                return True
        
        return False
    
    def _save_prices_to_db(self, df: pd.DataFrame) -> int:
        """
        å„²å­˜åƒ¹æ ¼è³‡æ–™åˆ°è³‡æ–™åº«
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(StockPrice).where(
                and_(
                    StockPrice.symbol == row["symbol"],
                    StockPrice.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                # æ›´æ–°ç¾æœ‰è³‡æ–™
                existing.open = row["open"]
                existing.high = row["high"]
                existing.low = row["low"]
                existing.close = row["close"]
                existing.volume = row["volume"]
            else:
                # æ–°å¢è³‡æ–™
                price = StockPrice(
                    symbol=row["symbol"],
                    date=row["date"],
                    open=row["open"],
                    high=row["high"],
                    low=row["low"],
                    close=row["close"],
                    volume=row["volume"],
                )
                self.db.add(price)
                count += 1
        
        self.db.commit()
        return count
    
    def _load_prices_from_db(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """å¾è³‡æ–™åº«è¼‰å…¥åƒ¹æ ¼è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(StockPrice)
            .where(
                and_(
                    StockPrice.symbol == symbol.upper(),
                    StockPrice.date >= start_date,
                )
            )
            .order_by(StockPrice.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        if not results:
            return None
        
        data = []
        for r in results:
            data.append({
                "symbol": r.symbol,
                "date": r.date,
                "open": float(r.open) if r.open else None,
                "high": float(r.high) if r.high else None,
                "low": float(r.low) if r.low else None,
                "close": float(r.close) if r.close else None,
                "volume": r.volume,
            })
        
        return pd.DataFrame(data)
    
    def fetch_and_cache_stock(self, symbol: str, period: str = "1y") -> bool:
        """
        æŠ“å–è‚¡ç¥¨è³‡æ–™ä¸¦å¿«å–
        
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        df = yahoo_finance.get_stock_history(symbol, period=period)
        if df is None:
            return False
        
        self._save_prices_to_db(df)
        return True
    
    def get_stock_data(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾—è‚¡ç¥¨è³‡æ–™ï¼ˆå„ªå…ˆä½¿ç”¨å¿«å–ï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            force_refresh: æ˜¯å¦å¼·åˆ¶æ›´æ–°
            
        Returns:
            åŒ…å«åƒ¹æ ¼å’ŒæŠ€è¡“æŒ‡æ¨™çš„ DataFrame
        """
        symbol = symbol.upper()
        
        # æª¢æŸ¥å¿«å–
        if not force_refresh and self._is_cache_valid(symbol):
            logger.info(f"ä½¿ç”¨å¿«å–è³‡æ–™: {symbol}")
            df = self._load_prices_from_db(symbol)
        else:
            # å¾ Yahoo Finance æŠ“å–
            logger.info(f"å¾ Yahoo Finance æŠ“å–: {symbol}")
            if not self.fetch_and_cache_stock(symbol):
                # æŠ“å–å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨èˆŠçš„å¿«å–
                df = self._load_prices_from_db(symbol)
                if df is None:
                    return None
            else:
                df = self._load_prices_from_db(symbol)
        
        if df is None or df.empty:
            return None
        
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        df = indicator_service.calculate_all_indicators(df)
        
        return df
    
    def get_stock_analysis(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[Dict[str, Any]]:
        """
        å–å¾—è‚¡ç¥¨å®Œæ•´åˆ†æå ±å‘Š
        
        Returns:
            åˆ†æå ±å‘Šå­—å…¸
        """
        symbol = symbol.upper()
        
        # å–å¾—è³‡æ–™
        df = self.get_stock_data(symbol, force_refresh)
        if df is None:
            return None
        
        # å–å¾—è‚¡ç¥¨åŸºæœ¬è³‡è¨Š
        info = yahoo_finance.get_stock_info(symbol)
        
        # æœ€æ–°åƒ¹æ ¼è³‡æ–™
        latest = df.iloc[-1]
        price = float(latest["close"])
        
        # è¨ˆç®—æ¼²è·Œå¹…
        changes = self._calculate_changes(df)
        
        # æŠ€è¡“æŒ‡æ¨™
        indicators = self._get_indicators_summary(df, latest)
        
        # è¨Šè™Ÿ
        signals = indicator_service.get_all_signals(df)
        
        # è©•åˆ†
        score = indicator_service.calculate_score(df)
        
        # æˆäº¤é‡
        volume_info = self._get_volume_info(df, latest)
        
        return {
            "symbol": symbol,
            "name": info.get("name", "N/A") if info else "N/A",
            "asset_type": "stock",
            "price": {
                "current": price,
                "high_52w": info.get("fifty_two_week_high") if info else None,
                "low_52w": info.get("fifty_two_week_low") if info else None,
                "from_high_pct": self._calc_pct_from_high(price, info),
                "from_low_pct": self._calc_pct_from_low(price, info),
            },
            "change": changes,
            "volume": volume_info,
            "indicators": indicators,
            "signals": [
                {
                    "type": s.type.value,
                    "indicator": s.indicator,
                    "description": s.description,
                }
                for s in signals
            ],
            "score": score,
            "updated_at": datetime.now().isoformat(),
        }
    
    def _calculate_changes(self, df: pd.DataFrame) -> Dict[str, float]:
        """è¨ˆç®—å„æ™‚é–“æ®µæ¼²è·Œå¹…"""
        latest_close = df["close"].iloc[-1]
        
        def calc_change(days: int) -> Optional[float]:
            if len(df) <= days:
                return None
            old_close = df["close"].iloc[-(days + 1)]
            return round((latest_close - old_close) / old_close * 100, 2)
        
        return {
            "day": calc_change(1),
            "week": calc_change(5),
            "month": calc_change(20),
            "quarter": calc_change(60),
            "year": calc_change(250) if len(df) > 250 else None,
        }
    
    def _get_indicators_summary(
        self,
        df: pd.DataFrame,
        latest: pd.Series,
    ) -> Dict[str, Any]:
        """å–å¾—æŒ‡æ¨™æ‘˜è¦"""
        price = float(latest["close"])
        
        # MA
        ma_short = latest.get(f"ma{settings.MA_SHORT}")
        ma_mid = latest.get(f"ma{settings.MA_MID}")
        ma_long = latest.get(f"ma{settings.MA_LONG}")
        
        alignment, _ = indicator_service.get_ma_alignment(df)
        
        ma_info = {
            f"ma{settings.MA_SHORT}": round(ma_short, 2) if not pd.isna(ma_short) else None,
            f"ma{settings.MA_MID}": round(ma_mid, 2) if not pd.isna(ma_mid) else None,
            f"ma{settings.MA_LONG}": round(ma_long, 2) if not pd.isna(ma_long) else None,
            "alignment": alignment.value,
            f"price_vs_ma{settings.MA_SHORT}": "above" if price > ma_short else "below" if not pd.isna(ma_short) else None,
            f"price_vs_ma{settings.MA_MID}": "above" if price > ma_mid else "below" if not pd.isna(ma_mid) else None,
            f"price_vs_ma{settings.MA_LONG}": "above" if price > ma_long else "below" if not pd.isna(ma_long) else None,
        }
        
        # RSI
        rsi = latest.get("rsi")
        rsi_status, _ = indicator_service.get_rsi_status(rsi)
        rsi_info = {
            "value": round(rsi, 2) if not pd.isna(rsi) else None,
            "status": rsi_status,
        }
        
        # MACD
        macd_dif = latest.get("macd_dif")
        macd_dea = latest.get("macd_dea")
        macd_hist = latest.get("macd_hist")
        macd_info = {
            "dif": round(macd_dif, 4) if not pd.isna(macd_dif) else None,
            "dea": round(macd_dea, 4) if not pd.isna(macd_dea) else None,
            "histogram": round(macd_hist, 4) if not pd.isna(macd_hist) else None,
            "status": "bullish" if macd_hist and macd_hist > 0 else "bearish",
        }
        
        # KD
        kd_k = latest.get("kd_k")
        kd_d = latest.get("kd_d")
        kd_info = {
            "k": round(kd_k, 2) if not pd.isna(kd_k) else None,
            "d": round(kd_d, 2) if not pd.isna(kd_d) else None,
            "status": self._get_kd_status(kd_k),
        }
        
        # Bollinger
        bb_upper = latest.get("bb_upper")
        bb_middle = latest.get("bb_middle")
        bb_lower = latest.get("bb_lower")
        bb_info = {
            "upper": round(bb_upper, 2) if not pd.isna(bb_upper) else None,
            "middle": round(bb_middle, 2) if not pd.isna(bb_middle) else None,
            "lower": round(bb_lower, 2) if not pd.isna(bb_lower) else None,
            "position": indicator_service.get_bollinger_position(price, bb_upper, bb_middle, bb_lower),
        }
        
        # OBV
        obv_trend = indicator_service.get_obv_trend(df)
        obv_info = {
            "trend": obv_trend,
        }
        
        return {
            "ma": ma_info,
            "rsi": rsi_info,
            "macd": macd_info,
            "kd": kd_info,
            "bollinger": bb_info,
            "obv": obv_info,
        }
    
    def _get_kd_status(self, k_value: float) -> str:
        """å–å¾— KD ç‹€æ…‹"""
        if pd.isna(k_value):
            return "unknown"
        if k_value > 80:
            return "overbought"
        elif k_value < 20:
            return "oversold"
        elif k_value > 50:
            return "neutral_high"
        else:
            return "neutral_low"
    
    def _get_volume_info(
        self,
        df: pd.DataFrame,
        latest: pd.Series,
    ) -> Dict[str, Any]:
        """å–å¾—æˆäº¤é‡è³‡è¨Š"""
        today_vol = latest.get("volume", 0)
        avg_vol = latest.get("volume_ma20")
        vol_ratio = latest.get("volume_ratio")
        
        return {
            "today": int(today_vol) if today_vol else 0,
            "avg_20d": int(avg_vol) if not pd.isna(avg_vol) else None,
            "ratio": round(vol_ratio, 2) if not pd.isna(vol_ratio) else None,
        }
    
    def _calc_pct_from_high(self, price: float, info: Optional[Dict]) -> Optional[float]:
        """è¨ˆç®—è·é›¢ 52 é€±é«˜é»çš„è·Œå¹…"""
        if not info or not info.get("fifty_two_week_high"):
            return None
        high = info["fifty_two_week_high"]
        return round((price - high) / high * 100, 2)
    
    def _calc_pct_from_low(self, price: float, info: Optional[Dict]) -> Optional[float]:
        """è¨ˆç®—è·é›¢ 52 é€±ä½é»çš„æ¼²å¹…"""
        if not info or not info.get("fifty_two_week_low"):
            return None
        low = info["fifty_two_week_low"]
        return round((price - low) / low * 100, 2)
    
    def search_stocks(self, query: str) -> List[Dict[str, str]]:
        """
        æœå°‹è‚¡ç¥¨ï¼ˆç°¡å–®å¯¦ä½œï¼Œç›´æ¥é©—è­‰ä»£è™Ÿï¼‰
        
        Returns:
            ç¬¦åˆçš„è‚¡ç¥¨åˆ—è¡¨
        """
        symbol = query.upper().strip()
        
        if yahoo_finance.validate_symbol(symbol):
            info = yahoo_finance.get_stock_info(symbol)
            if info:
                return [{
                    "symbol": info["symbol"],
                    "name": info.get("name", "N/A"),
                }]
        
        return []
    
    def fetch_extended_history(
        self,
        symbol: str,
        years: int = 10,
    ) -> bool:
        """
        æŠ“å–ä¸¦å¿«å–å»¶ä¼¸æ­·å²è³‡æ–™ï¼ˆæ”¯æ´å¤šå¹´ï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            years: å¹´æ•¸ (1, 3, 5, 10)
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        period_map = {1: "1y", 2: "2y", 5: "5y", 10: "10y"}
        period = period_map.get(years, "10y")
        
        df = yahoo_finance.get_stock_history(symbol, period=period)
        if df is None:
            return False
        
        self._save_prices_to_db(df)
        return True
    
    def get_price_history(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾—è‚¡ç¥¨åƒ¹æ ¼æ­·å²ï¼ˆå¾è³‡æ–™åº«ï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            days: å¤©æ•¸
            
        Returns:
            åƒ¹æ ¼ DataFrame
        """
        return self._load_prices_from_db(symbol, days)
    
    def ensure_historical_data(
        self,
        symbol: str,
        years: int = 10,
    ) -> bool:
        """
        ç¢ºä¿æœ‰è¶³å¤ çš„æ­·å²è³‡æ–™
        
        æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æœ‰æŒ‡å®šå¹´ä»½çš„è³‡æ–™ï¼Œ
        å¦‚æœä¸è¶³å‰‡å¾ API æŠ“å–è£œé½Š
        """
        symbol = symbol.upper()
        days_needed = years * 365
        
        # æª¢æŸ¥è³‡æ–™åº«ä¸­æœ€æ—©çš„è³‡æ–™æ—¥æœŸ
        stmt = (
            select(StockPrice)
            .where(StockPrice.symbol == symbol)
            .order_by(StockPrice.date)
            .limit(1)
        )
        earliest = self.db.execute(stmt).scalar_one_or_none()
        
        if earliest:
            days_available = (date.today() - earliest.date).days
            if days_available >= days_needed * 0.9:  # 90% å°±ç®—è¶³å¤ 
                return True
        
        # è³‡æ–™ä¸è¶³ï¼ŒæŠ“å–æ›´å¤š
        logger.info(f"æŠ“å– {symbol} çš„ {years} å¹´æ­·å²è³‡æ–™")
        return self.fetch_extended_history(symbol, years)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/watchlist_service.py  â­â­â­
> è¿½è¹¤æ¸…å–®æœå‹™ (Async ç‰ˆæœ¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–®æœå‹™ (Async ç‰ˆæœ¬)
"""
from typing import Optional, Dict, Any, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_
import logging

from app.models.watchlist import Watchlist
from app.models.user import User
from app.data_sources.coingecko import CRYPTO_MAP

logger = logging.getLogger(__name__)

# æ”¯æ´çš„åŠ å¯†è²¨å¹£ä»£è™Ÿ
SUPPORTED_CRYPTO = set(k for k in CRYPTO_MAP.keys() if k not in ("BITCOIN", "ETHEREUM"))


class WatchlistService:
    """è¿½è¹¤æ¸…å–®æœå‹™ (Async)"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    def _get_asset_type(self, symbol: str) -> str:
        """åˆ¤æ–·è³‡ç”¢é¡å‹"""
        return "crypto" if symbol.upper() in SUPPORTED_CRYPTO else "stock"
    
    async def add_to_watchlist(
        self,
        user_id: int,
        symbol: str,
        note: str = None,
    ) -> Dict[str, Any]:
        """
        æ–°å¢è¿½è¹¤æ¨™çš„
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: è‚¡ç¥¨/åŠ å¯†è²¨å¹£ä»£è™Ÿ
            note: å‚™è¨»
            
        Returns:
            {
                "success": bool,
                "message": str,
                "watchlist": Watchlist (if success)
            }
        """
        symbol = symbol.upper()
        asset_type = self._get_asset_type(symbol)
        
        logger.info(f"=== æ–°å¢è¿½è¹¤æ¸…å–® ===")
        logger.info(f"ç”¨æˆ¶ ID: {user_id}, ä»£è™Ÿ: {symbol}, é¡å‹: {asset_type}")
        
        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        existing = await self._get_watchlist_item(user_id, symbol, asset_type)
        if existing:
            logger.info(f"å·²å­˜åœ¨è¿½è¹¤: user_id={user_id}, symbol={symbol}")
            return {
                "success": False,
                "message": f"{symbol} å·²åœ¨è¿½è¹¤æ¸…å–®ä¸­",
            }
        
        # é©—è­‰ä»£è™Ÿæ˜¯å¦æœ‰æ•ˆ
        if asset_type == "crypto":
            from app.data_sources.coingecko import coingecko
            if not coingecko.validate_symbol(symbol):
                logger.warning(f"ç„¡æ•ˆçš„åŠ å¯†è²¨å¹£: {symbol}")
                return {
                    "success": False,
                    "message": f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}",
                }
        else:
            from app.data_sources.yahoo_finance import yahoo_finance
            if not yahoo_finance.validate_symbol(symbol):
                logger.warning(f"ç„¡æ•ˆçš„è‚¡ç¥¨ä»£è™Ÿ: {symbol}")
                return {
                    "success": False,
                    "message": f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}",
                }
        
        # æ–°å¢
        watchlist = Watchlist(
            user_id=user_id,
            symbol=symbol,
            asset_type=asset_type,
            note=note,
        )
        self.db.add(watchlist)
        await self.db.commit()
        await self.db.refresh(watchlist)
        
        logger.info(f"â˜… è¿½è¹¤æ¸…å–®å¯«å…¥æˆåŠŸ: id={watchlist.id}, user_id={user_id}, symbol={symbol}")
        
        return {
            "success": True,
            "message": f"å·²æ–°å¢ {symbol} åˆ°è¿½è¹¤æ¸…å–®",
            "watchlist": watchlist,
        }
    
    async def remove_from_watchlist(
        self,
        user_id: int,
        symbol: str = None,
        watchlist_id: int = None,
    ) -> Dict[str, Any]:
        """
        å¾è¿½è¹¤æ¸…å–®ç§»é™¤
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: ä»£è™Ÿï¼ˆèˆ‡ watchlist_id äºŒæ“‡ä¸€ï¼‰
            watchlist_id: è¿½è¹¤æ¸…å–® ID
            
        Returns:
            {"success": bool, "message": str}
        """
        logger.info(f"=== ç§»é™¤è¿½è¹¤æ¸…å–® ===")
        logger.info(f"ç”¨æˆ¶ ID: {user_id}, ä»£è™Ÿ: {symbol}, watchlist_id: {watchlist_id}")
        
        if watchlist_id:
            stmt = select(Watchlist).where(
                and_(
                    Watchlist.id == watchlist_id,
                    Watchlist.user_id == user_id,  # â˜… ç¢ºä¿åªèƒ½åˆªé™¤è‡ªå·±çš„
                )
            )
        elif symbol:
            symbol = symbol.upper()
            asset_type = self._get_asset_type(symbol)
            stmt = select(Watchlist).where(
                and_(
                    Watchlist.user_id == user_id,  # â˜… ç¢ºä¿åªèƒ½åˆªé™¤è‡ªå·±çš„
                    Watchlist.symbol == symbol,
                    Watchlist.asset_type == asset_type,
                )
            )
        else:
            return {
                "success": False,
                "message": "è«‹æä¾› symbol æˆ– watchlist_id",
            }
        
        result = await self.db.execute(stmt)
        watchlist = result.scalar_one_or_none()
        
        if not watchlist:
            logger.warning(f"æ‰¾ä¸åˆ°è¿½è¹¤é …ç›®: user_id={user_id}, symbol={symbol}")
            return {
                "success": False,
                "message": "æ‰¾ä¸åˆ°è¿½è¹¤é …ç›®",
            }
        
        # â˜…â˜…â˜… é¡å¤–é©—è­‰ï¼šç¢ºä¿ watchlist çš„ user_id èˆ‡è«‹æ±‚çš„ user_id ä¸€è‡´ â˜…â˜…â˜…
        if watchlist.user_id != user_id:
            logger.error(f"æ¬Šé™éŒ¯èª¤ï¼å˜—è©¦åˆªé™¤ä»–äººè³‡æ–™: è«‹æ±‚ user_id={user_id}, è³‡æ–™ user_id={watchlist.user_id}")
            return {
                "success": False,
                "message": "æ¬Šé™ä¸è¶³",
            }
        
        symbol = watchlist.symbol
        await self.db.delete(watchlist)
        await self.db.commit()
        
        logger.info(f"â˜… è¿½è¹¤æ¸…å–®åˆªé™¤æˆåŠŸ: user_id={user_id}, symbol={symbol}")
        
        return {
            "success": True,
            "message": f"å·²å¾è¿½è¹¤æ¸…å–®ç§»é™¤ {symbol}",
        }
    
    async def update_note(
        self,
        user_id: int,
        symbol: str,
        note: str,
    ) -> Dict[str, Any]:
        """
        æ›´æ–°å‚™è¨»
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: ä»£è™Ÿ
            note: æ–°å‚™è¨»
            
        Returns:
            {"success": bool, "message": str}
        """
        symbol = symbol.upper()
        asset_type = self._get_asset_type(symbol)
        
        watchlist = await self._get_watchlist_item(user_id, symbol, asset_type)
        if not watchlist:
            return {
                "success": False,
                "message": f"{symbol} ä¸åœ¨è¿½è¹¤æ¸…å–®ä¸­",
            }
        
        watchlist.note = note
        await self.db.commit()
        
        return {
            "success": True,
            "message": f"å·²æ›´æ–° {symbol} çš„å‚™è¨»",
        }
    
    async def get_watchlist(self, user_id: int) -> List[Watchlist]:
        """
        å–å¾—ç”¨æˆ¶è¿½è¹¤æ¸…å–®
        
        Args:
            user_id: ç”¨æˆ¶ ID
            
        Returns:
            è¿½è¹¤æ¸…å–®åˆ—è¡¨
        """
        logger.debug(f"å–å¾—è¿½è¹¤æ¸…å–®: user_id={user_id}")
        
        stmt = (
            select(Watchlist)
            .where(Watchlist.user_id == user_id)  # â˜… åªå–å¾—è©²ç”¨æˆ¶çš„è³‡æ–™
            .order_by(Watchlist.added_at.desc())
        )
        result = await self.db.execute(stmt)
        items = list(result.scalars().all())
        
        logger.info(f"å–å¾—è¿½è¹¤æ¸…å–®: user_id={user_id}, æ•¸é‡={len(items)}")
        for item in items:
            logger.debug(f"  - id={item.id}, symbol={item.symbol}, user_id={item.user_id}")
        
        return items
    
    async def get_watchlist_symbols(self, user_id: int) -> Dict[str, List[str]]:
        """
        å–å¾—ç”¨æˆ¶è¿½è¹¤çš„ä»£è™Ÿåˆ—è¡¨ï¼ˆç”¨æ–¼é€šçŸ¥ç³»çµ±ï¼‰
        
        Returns:
            {
                "stocks": ["AAPL", "TSLA"],
                "crypto": ["BTC", "ETH"]
            }
        """
        watchlists = await self.get_watchlist(user_id)
        
        stocks = []
        cryptos = []
        
        for item in watchlists:
            if item.asset_type == "stock":
                stocks.append(item.symbol)
            else:
                cryptos.append(item.symbol)
        
        return {
            "stocks": stocks,
            "crypto": cryptos,
        }
    
    async def _get_watchlist_item(
        self,
        user_id: int,
        symbol: str,
        asset_type: str,
    ) -> Optional[Watchlist]:
        """å–å¾—ç‰¹å®šè¿½è¹¤é …ç›®"""
        stmt = select(Watchlist).where(
            and_(
                Watchlist.user_id == user_id,
                Watchlist.symbol == symbol,
                Watchlist.asset_type == asset_type,
            )
        )
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def get_all_tracked_symbols(self) -> Dict[str, set]:
        """
        å–å¾—æ‰€æœ‰ç”¨æˆ¶è¿½è¹¤çš„ä»£è™Ÿï¼ˆç”¨æ–¼æ‰¹æ¬¡æ›´æ–°ï¼‰
        
        Returns:
            {
                "stocks": {"AAPL", "TSLA", ...},
                "crypto": {"BTC", "ETH"}
            }
        """
        stmt = select(Watchlist.symbol, Watchlist.asset_type).distinct()
        result = await self.db.execute(stmt)
        results = result.all()
        
        stocks = set()
        cryptos = set()
        
        for symbol, asset_type in results:
            if asset_type == "stock":
                stocks.add(symbol)
            else:
                cryptos.add(symbol)
        
        return {
            "stocks": stocks,
            "crypto": cryptos,
        }
```

======================================================================
## ğŸ¨ å‰ç«¯ / éœæ…‹è³‡æº
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ frontend/watchlist_with_cache.js  â­
> ========== è¿½è¹¤æ¸…å–® - ä½¿ç”¨å¿«å–ç‰ˆæœ¬ ==========
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
        // ========== è¿½è¹¤æ¸…å–® - ä½¿ç”¨å¿«å–ç‰ˆæœ¬ ==========
        // æ”¹ç”¨ /api/watchlist/with-prices APIï¼Œç›´æ¥å–å¾—åƒ¹æ ¼
        
        async function loadWatchlist() {
            const container = document.getElementById('watchlistContent');
            
            if (!currentUser || !currentUser.id) {
                console.error('loadWatchlist: ç”¨æˆ¶æœªç™»å…¥');
                container.innerHTML = '<p class="text-red-500 text-center py-4">è«‹å…ˆç™»å…¥</p>';
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
            `;
            
            try {
                // â˜… æ”¹ç”¨æ–° APIï¼šä¸€æ¬¡å–å¾—æ¸…å–® + åƒ¹æ ¼
                const res = await apiRequest('/api/watchlist/with-prices');
                const data = await res.json();
                
                console.log('è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼):', data);
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-star text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500 mb-4">å°šç„¡è¿½è¹¤çš„è‚¡ç¥¨</p>
                            <button onclick="showAddWatchlistModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">
                                <i class="fas fa-plus mr-2"></i>æ–°å¢è¿½è¹¤
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // é¡¯ç¤ºå¿«å–æ›´æ–°æ™‚é–“ï¼ˆå¦‚æœæœ‰ï¼‰
                let cacheInfo = '';
                if (data.cache_info && data.cache_info.oldest_update) {
                    const updateTime = new Date(data.cache_info.oldest_update);
                    const now = new Date();
                    const diffMin = Math.round((now - updateTime) / 60000);
                    cacheInfo = `<p class="text-xs text-gray-400 text-right mb-2">åƒ¹æ ¼æ›´æ–°æ–¼ ${diffMin} åˆ†é˜å‰</p>`;
                }
                
                let html = cacheInfo + '<div class="space-y-3">';
                
                for (const item of data.data) {
                    const typeClass = item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                    const typeText = item.asset_type === 'crypto' ? 'å¹£' : 'è‚¡';
                    
                    // åƒ¹æ ¼é¡¯ç¤ºï¼ˆç›´æ¥å¾ API å›æ‡‰å–å¾—ï¼‰
                    let priceInfo = '';
                    if (item.price !== null) {
                        const change = item.change_pct || 0;
                        const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                        const changeIcon = change >= 0 ? 'â–²' : 'â–¼';
                        priceInfo = `
                            <div class="flex items-baseline gap-2 mt-2">
                                <span class="text-xl font-bold text-gray-800">$${item.price.toLocaleString()}</span>
                                <span class="${changeClass} text-sm font-medium">${changeIcon} ${Math.abs(change).toFixed(2)}%</span>
                            </div>
                        `;
                    } else {
                        priceInfo = `
                            <div class="flex items-baseline gap-2 mt-2">
                                <span class="text-gray-400 text-sm">åƒ¹æ ¼æœªæ›´æ–°</span>
                            </div>
                        `;
                    }
                    
                    // é¡¯ç¤ºè‚¡ç¥¨åç¨±
                    const nameDisplay = item.name ? `<span class="text-gray-500 text-sm ml-2">${item.name}</span>` : '';
                    
                    html += `
                        <div class="stock-card bg-white rounded-xl shadow-sm p-4 border-l-4 ${item.asset_type === 'crypto' ? 'border-purple-500' : 'border-blue-500'}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center flex-wrap">
                                        <span class="font-bold text-lg text-gray-800">${item.symbol}</span>
                                        <span class="ml-2 px-2 py-0.5 rounded text-xs ${typeClass}">${typeText}</span>
                                        ${nameDisplay}
                                    </div>
                                    ${priceInfo}
                                    ${item.note ? `<p class="text-gray-500 text-sm mt-2 italic"><i class="fas fa-sticky-note mr-1"></i>${item.note}</p>` : ''}
                                </div>
                                <button onclick="removeFromWatchlist('${item.symbol}')" class="p-2 text-gray-400 hover:text-red-500 touch-target">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between mt-3 pt-3 border-t">
                                <span class="text-gray-400 text-xs"><i class="fas fa-clock mr-1"></i>åŠ å…¥æ–¼ ${new Date(item.added_at).toLocaleDateString()}</span>
                                <button onclick="searchSymbol('${item.symbol}')" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 touch-target">
                                    <i class="fas fa-chart-line mr-1"></i>è©³ç´°åˆ†æ
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('è¼‰å…¥è¿½è¹¤æ¸…å–®å¤±æ•—', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
            }
        }
        
        // ========== é¦–é è¿½è¹¤æ¸…å–®å¿«è¦½ ==========
        async function loadWatchlistOverview() {
            const container = document.getElementById('dashboardWatchlist');
            
            try {
                // â˜… åŒæ¨£ä½¿ç”¨å¿«å– API
                const res = await apiRequest('/api/watchlist/with-prices');
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                            <p class="text-gray-500 text-sm">å°šç„¡è¿½è¹¤æ¸…å–®</p>
                            <button onclick="showSection('search')" class="mt-2 text-blue-600 text-sm">å‰å¾€æŸ¥è©¢è‚¡ç¥¨</button>
                        </div>
                    `;
                    return;
                }
                
                // åªé¡¯ç¤ºå‰ 5 ç­†
                const items = data.data.slice(0, 5);
                let html = '<div class="space-y-2">';
                
                for (const item of items) {
                    const change = item.change_pct || 0;
                    const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                    const changeText = item.price !== null 
                        ? `<span class="${changeClass} text-sm">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`
                        : '';
                    
                    const priceText = item.price !== null
                        ? `<span class="text-gray-700 font-medium">$${item.price.toLocaleString()}</span>`
                        : '<span class="text-gray-400 text-sm">--</span>';
                    
                    html += `
                        <div class="flex items-center justify-between py-2 border-b last:border-0 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded" 
                             onclick="searchSymbol('${item.symbol}')">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-800 w-20">${item.symbol}</span>
                                <span class="text-xs px-2 py-0.5 rounded ${item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                    ${item.asset_type === 'crypto' ? 'å¹£' : 'è‚¡'}
                                </span>
                            </div>
                            <div class="text-right">
                                ${priceText}
                                ${changeText}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // å¦‚æœè¶…é 5 ç­†ï¼Œé¡¯ç¤ºã€ŒæŸ¥çœ‹å…¨éƒ¨ã€
                if (data.data.length > 5) {
                    html += `
                        <div class="text-center mt-3">
                            <button onclick="showSection('watchlist')" class="text-blue-600 text-sm hover:underline">
                                æŸ¥çœ‹å…¨éƒ¨ (${data.data.length})
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error('è¼‰å…¥è¿½è¹¤æ¸…å–®å¿«è¦½å¤±æ•—', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
            }
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/admin.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <style>
        .brand-orange { color: #FA7A35; }
        .bg-brand-orange { background-color: #FA7A35; }
        .hover\:bg-brand-orange-dark:hover { background-color: #e56a25; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-slate-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-xl font-bold bg-brand-orange px-3 py-1 rounded">SELA</span>
                    <span class="text-lg">ç®¡ç†å¾Œå°</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/static/dashboard.html" class="text-gray-300 hover:text-white">
                        â† è¿”å›å„€è¡¨æ¿
                    </a>
                    <span id="adminName" class="text-gray-300"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ç¸½ç”¨æˆ¶æ•¸</div>
                <div id="statTotal" class="text-2xl font-bold text-slate-800">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ç¸½ç™»å…¥æ¬¡æ•¸</div>
                <div id="statTotalLogins" class="text-2xl font-bold text-purple-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ä»Šæ—¥ç™»å…¥</div>
                <div id="statToday" class="text-2xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">å°é–ç”¨æˆ¶</div>
                <div id="statBlocked" class="text-2xl font-bold text-red-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ç®¡ç†å“¡</div>
                <div id="statAdmin" class="text-2xl font-bold text-blue-600">-</div>
            </div>
        </div>
        
        <!-- ç³»çµ±ç®¡ç† -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š å¸‚å ´è³‡æ–™ç®¡ç†</h3>
            <div class="flex flex-wrap gap-3">
                <button onclick="initializeData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                    <span class="mr-2">ğŸ”„</span>åˆå§‹åŒ–æ­·å²è³‡æ–™
                </button>
                <button onclick="updateIndices()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
                    <span class="mr-2">ğŸ“ˆ</span>æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
                </button>
                <button onclick="updateSentiment()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center">
                    <span class="mr-2">ğŸ’­</span>æ›´æ–°ææ‡¼è²ªå©ª
                </button>
                <button onclick="triggerDailyUpdate()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center">
                    <span class="mr-2">âš¡</span>åŸ·è¡Œæ¯æ—¥æ›´æ–°
                </button>
            </div>
            <p id="systemMessage" class="mt-3 text-sm text-gray-500"></p>
        </div>

        <!-- è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h3 class="font-bold text-gray-700 mb-4">ğŸ”” è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­</h3>
            <div class="flex flex-wrap gap-3 mb-3">
                <button onclick="runSignalCheck()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center">
                    <span class="mr-2">ğŸ”</span>åµæ¸¬è¨Šè™Ÿï¼ˆæ¸¬è©¦ï¼‰
                </button>
                <button onclick="sendSignalNotifications()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center">
                    <span class="mr-2">ğŸ“¤</span>ç™¼é€è¨Šè™Ÿé€šçŸ¥
                </button>
                <button onclick="testLineNotify()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center">
                    <span class="mr-2">ğŸ“±</span>æ¸¬è©¦ LINE æ¨æ’­
                </button>
            </div>
            <div class="flex gap-2 items-center">
                <input type="text" id="testSymbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæ¸¬è©¦è¨Šè™Ÿåµæ¸¬ (å¦‚ AAPL)"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <button onclick="testSignalDetection()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    æ¸¬è©¦åµæ¸¬
                </button>
            </div>
            <p id="signalMessage" class="mt-3 text-sm text-gray-500"></p>
            <div id="signalResult" class="mt-3 hidden">
                <h4 class="font-medium text-gray-700 mb-2">åµæ¸¬çµæœï¼š</h4>
                <pre id="signalResultContent" class="bg-gray-100 p-3 rounded text-xs overflow-x-auto"></pre>
            </div>
        </div>

        <!-- æœå°‹å’Œç¯©é¸ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="æœå°‹ç”¨æˆ¶åç¨±ã€Email æˆ– LINE ID..."
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400">
                </div>
                <div class="flex gap-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="blockedOnly" class="mr-2">
                        <span class="text-sm">åªé¡¯ç¤ºå°é–</span>
                    </label>
                    <button onclick="loadUsers()" class="bg-brand-orange text-white px-4 py-2 rounded-lg hover:bg-brand-orange-dark">
                        æœå°‹
                    </button>
                    <button onclick="kickAllUsers()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        è¸¢å‡ºå…¨éƒ¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç”¨æˆ¶</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç™»å…¥æ¬¡æ•¸</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">æœ€å¾Œç™»å…¥</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="divide-y divide-gray-200">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é  -->
            <div class="px-4 py-3 bg-gray-50 flex items-center justify-between">
                <div id="pageInfo" class="text-sm text-gray-500"></div>
                <div class="flex gap-2">
                    <button id="prevPage" onclick="changePage(-1)" class="px-3 py-1 border rounded hover:bg-gray-100" disabled>ä¸Šä¸€é </button>
                    <button id="nextPage" onclick="changePage(1)" class="px-3 py-1 border rounded hover:bg-gray-100" disabled>ä¸‹ä¸€é </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ¶è©³æƒ… Modal -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">ç”¨æˆ¶è©³æƒ…</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div id="modalContent">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // æª¢æŸ¥ç™»å…¥å’Œç®¡ç†å“¡æ¬Šé™
        if (!token) {
            window.location.href = '/static/index.html';
        }

        document.getElementById('adminName').textContent = user.display_name || '';

        // API è«‹æ±‚
        async function apiRequest(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/static/index.html';
                return null;
            }
            
            if (response.status === 403) {
                alert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
                window.location.href = '/static/dashboard.html';
                return null;
            }
            
            return response.json();
        }

        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            const data = await apiRequest('/api/admin/stats');
            if (data && data.success) {
                document.getElementById('statTotal').textContent = data.stats.total_users;
                document.getElementById('statTotalLogins').textContent = data.stats.total_logins;
                document.getElementById('statToday').textContent = data.stats.today_logins;
                document.getElementById('statBlocked').textContent = data.stats.blocked_users;
                document.getElementById('statAdmin').textContent = data.stats.admin_users;
            }
        }

        // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
        async function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const blockedOnly = document.getElementById('blockedOnly').checked;
            
            let url = `/api/admin/users?page=${currentPage}&page_size=20`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (blockedOnly) url += `&blocked_only=true`;
            
            const data = await apiRequest(url);
            if (data && data.success) {
                renderUsers(data.users);
                totalPages = data.pagination.total_pages;
                document.getElementById('pageInfo').textContent = 
                    `ç¬¬ ${data.pagination.page} / ${totalPages} é ï¼Œå…± ${data.pagination.total} ç­†`;
                document.getElementById('prevPage').disabled = currentPage <= 1;
                document.getElementById('nextPage').disabled = currentPage >= totalPages;
            }
        }

        // æ¸²æŸ“ç”¨æˆ¶åˆ—è¡¨
        function renderUsers(users) {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <img src="${u.picture_url || '/static/logo.png'}" 
                                class="w-10 h-10 rounded-full mr-3" 
                                onerror="this.src='/static/logo.png'">
                            <div>
                                <div class="font-medium text-gray-900">${escapeHtml(u.display_name || 'æœªå‘½å')}</div>
                                <div class="text-xs text-gray-500">ID: ${u.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 hidden md:table-cell">
                        ${escapeHtml(u.email || '-')}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-1">
                            ${u.is_admin ? '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800">ç®¡ç†å“¡</span>' : ''}
                            ${u.is_blocked ? '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800">å·²å°é–</span>' : '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800">æ­£å¸¸</span>'}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-sm font-medium rounded-full bg-purple-100 text-purple-700">${u.login_count || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 hidden md:table-cell">
                        ${formatDate(u.last_login)}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex gap-1">
                            <button onclick="showUserDetail(${u.id})" 
                                class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">è©³æƒ…</button>
                            ${u.is_blocked 
                                ? `<button onclick="unblockUser(${u.id})" class="px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded">è§£å°</button>`
                                : `<button onclick="blockUser(${u.id})" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-700 rounded">å°é–</button>`
                            }
                            <button onclick="kickUser(${u.id})" 
                                class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded">è¸¢å‡º</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // é¡¯ç¤ºç”¨æˆ¶è©³æƒ…
        async function showUserDetail(userId) {
            const data = await apiRequest(`/api/admin/users/${userId}`);
            if (data && data.success) {
                const u = data.user;
                const logs = data.recent_logs;
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${u.picture_url || '/static/logo.png'}" 
                            class="w-16 h-16 rounded-full mr-4"
                            onerror="this.src='/static/logo.png'">
                        <div>
                            <div class="font-bold text-xl">${escapeHtml(u.display_name || 'æœªå‘½å')}</div>
                            <div class="text-gray-500">${escapeHtml(u.email || 'ç„¡ Email')}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">ç”¨æˆ¶ ID</div>
                            <div class="font-medium">${u.id}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">LINE ID</div>
                            <div class="font-medium text-xs break-all">${u.line_user_id}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">è¨»å†Šæ™‚é–“</div>
                            <div class="font-medium">${formatDate(u.created_at)}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">æœ€å¾Œç™»å…¥</div>
                            <div class="font-medium">${formatDate(u.last_login)}</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        ${u.is_admin 
                            ? `<button onclick="removeAdmin(${u.id})" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded">ç§»é™¤ç®¡ç†å“¡</button>`
                            : `<button onclick="setAdmin(${u.id})" class="flex-1 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">è¨­ç‚ºç®¡ç†å“¡</button>`
                        }
                        ${u.is_blocked 
                            ? `<button onclick="unblockUser(${u.id})" class="flex-1 py-2 bg-green-500 hover:bg-green-600 text-white rounded">è§£é™¤å°é–</button>`
                            : `<button onclick="blockUser(${u.id})" class="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white rounded">å°é–ç”¨æˆ¶</button>`
                        }
                    </div>
                    
                    ${u.is_blocked ? `
                        <div class="bg-red-50 p-3 rounded mb-4">
                            <div class="text-red-800 font-medium">å°é–è³‡è¨Š</div>
                            <div class="text-sm text-red-600">åŸå› ï¼š${escapeHtml(u.blocked_reason || 'æœªèªªæ˜')}</div>
                            <div class="text-sm text-red-600">æ™‚é–“ï¼š${formatDate(u.blocked_at)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="border-t pt-4">
                        <div class="font-medium mb-2">æœ€è¿‘æ´»å‹•è¨˜éŒ„</div>
                        <div class="max-h-48 overflow-y-auto">
                            ${logs.length ? logs.map(log => `
                                <div class="flex justify-between py-1 text-sm border-b">
                                    <span class="text-gray-600">${getActionText(log.action)}</span>
                                    <span class="text-gray-400">${formatDate(log.created_at)}</span>
                                </div>
                            `).join('') : '<div class="text-gray-400 text-sm">ç„¡è¨˜éŒ„</div>'}
                        </div>
                    </div>
                `;
                
                document.getElementById('userModal').classList.remove('hidden');
                document.getElementById('userModal').classList.add('flex');
            }
        }

        function closeModal() {
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('userModal').classList.remove('flex');
        }

        // æ“ä½œå‡½æ•¸
        async function blockUser(userId) {
            const reason = prompt('è«‹è¼¸å…¥å°é–åŸå› ï¼ˆå¯ç•™ç©ºï¼‰ï¼š');
            if (reason === null) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/block?reason=${encodeURIComponent(reason)}`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        async function unblockUser(userId) {
            if (!confirm('ç¢ºå®šè¦è§£é™¤å°é–æ­¤ç”¨æˆ¶å—ï¼Ÿ')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/unblock`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        async function kickUser(userId) {
            if (!confirm('ç¢ºå®šè¦è¸¢å‡ºæ­¤ç”¨æˆ¶å—ï¼Ÿç”¨æˆ¶éœ€è¦é‡æ–°ç™»å…¥ã€‚')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/kick`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
            }
        }

        async function kickAllUsers() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦è¸¢å‡ºæ‰€æœ‰ç”¨æˆ¶å—ï¼Ÿæ‰€æœ‰äººï¼ˆåŒ…æ‹¬æ‚¨è‡ªå·±ï¼‰éƒ½éœ€è¦é‡æ–°ç™»å…¥ï¼')) return;
            if (!confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡ä½¿æ‰€æœ‰ç™»å…¥ Token å¤±æ•ˆï¼')) return;
            
            const data = await apiRequest('/api/admin/kick-all', {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                localStorage.clear();
                window.location.href = '/static/index.html';
            }
        }

        async function setAdmin(userId) {
            if (!confirm('ç¢ºå®šè¦å°‡æ­¤ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡å—ï¼Ÿ')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/set-admin`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        async function removeAdmin(userId) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ç”¨æˆ¶çš„ç®¡ç†å“¡æ¬Šé™å—ï¼Ÿ')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/remove-admin`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        function changePage(delta) {
            currentPage += delta;
            loadUsers();
        }

        // å·¥å…·å‡½æ•¸
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getActionText(action) {
            const actions = {
                'login': 'ğŸ”‘ ç™»å…¥',
                'logout': 'ğŸšª ç™»å‡º',
                'blocked': 'ğŸš« è¢«å°é–',
                'unblocked': 'âœ… è§£é™¤å°é–',
                'kicked': 'ğŸ‘¢ è¢«è¸¢å‡º',
                'kick_all': 'ğŸ‘¢ å…¨å“¡è¸¢å‡º',
            };
            return actions[action] || action;
        }
        
        // ===== å¸‚å ´è³‡æ–™ç®¡ç† =====
        
        function showSystemMessage(msg, isError = false) {
            const el = document.getElementById('systemMessage');
            el.textContent = msg;
            el.className = `mt-3 text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
        }
        
        async function initializeData() {
            if (!confirm('é€™æœƒåˆå§‹åŒ–ä¸‰å¤§æŒ‡æ•¸æ­·å²è³‡æ–™ï¼ˆ10å¹´ï¼‰å’Œå¹£åœˆæƒ…ç·’æ­·å²ï¼ˆ365å¤©ï¼‰ï¼Œå¯èƒ½éœ€è¦å¹¾åˆ†é˜ã€‚ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                return;
            }
            
            showSystemMessage('æ­£åœ¨åˆå§‹åŒ–è³‡æ–™ï¼Œè«‹ç¨å€™...');
            
            try {
                const data = await apiRequest('/api/market/admin/initialize', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… åˆå§‹åŒ–å®Œæˆï¼æŒ‡æ•¸: ${data.data?.indices || 0} ç­†, æƒ…ç·’: ${data.data?.sentiment || 0} ç­†`);
                } else {
                    showSystemMessage(`âŒ åˆå§‹åŒ–å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ åˆå§‹åŒ–å¤±æ•—: ${e.message}`, true);
            }
        }
        
        async function updateIndices() {
            showSystemMessage('æ­£åœ¨æ›´æ–°ä¸‰å¤§æŒ‡æ•¸...');
            
            try {
                const data = await apiRequest('/api/market/admin/update-indices', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… ä¸‰å¤§æŒ‡æ•¸æ›´æ–°å®Œæˆï¼${data.data?.count || 0} ç­†è³‡æ–™`);
                } else {
                    showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
            }
        }
        
        async function updateSentiment() {
            showSystemMessage('æ­£åœ¨æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸...');
            
            try {
                const data = await apiRequest('/api/market/admin/update-sentiment', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… ææ‡¼è²ªå©ªæŒ‡æ•¸æ›´æ–°å®Œæˆï¼`);
                } else {
                    showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
            }
        }
        
        async function triggerDailyUpdate() {
            showSystemMessage('æ­£åœ¨åŸ·è¡Œæ¯æ—¥æ›´æ–°...');
            
            try {
                const data = await apiRequest('/api/market/admin/update', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… æ¯æ—¥æ›´æ–°å®Œæˆï¼`);
                } else {
                    showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
            }
        }

        // ========== è¨Šè™Ÿæª¢æŸ¥ç›¸é—œ ==========
        
        function showSignalMessage(msg, isError = false) {
            const el = document.getElementById('signalMessage');
            el.textContent = msg;
            el.className = isError ? 'mt-3 text-sm text-red-500' : 'mt-3 text-sm text-gray-500';
        }

        async function runSignalCheck() {
            showSignalMessage('æ­£åœ¨åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥...');
            document.getElementById('signalResult').classList.add('hidden');
            
            try {
                const data = await apiRequest('/api/admin/signal/detect', { method: 'POST' });
                if (data && data.success) {
                    showSignalMessage(`âœ… æª¢æŸ¥å®Œæˆï¼šåµæ¸¬åˆ° ${data.total_signals} å€‹è¨Šè™Ÿ`);
                    
                    if (data.signals_by_symbol && Object.keys(data.signals_by_symbol).length > 0) {
                        document.getElementById('signalResult').classList.remove('hidden');
                        document.getElementById('signalResultContent').textContent = 
                            JSON.stringify(data.signals_by_symbol, null, 2);
                    }
                } else {
                    showSignalMessage(`âŒ æª¢æŸ¥å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ æª¢æŸ¥å¤±æ•—: ${e.message}`, true);
            }
        }

        async function sendSignalNotifications() {
            showSignalMessage('æ­£åœ¨ç™¼é€è¨Šè™Ÿé€šçŸ¥...');
            
            try {
                const data = await apiRequest('/api/admin/signal/notify', { method: 'POST' });
                if (data && data.success) {
                    const r = data.result || {};
                    showSignalMessage(`âœ… ${data.message} - è‚¡ç¥¨æ›´æ–°: ${r.stocks_updated}, è¨Šè™Ÿåµæ¸¬: ${r.signals_detected}, é€šçŸ¥ç™¼é€: ${r.notifications_sent}`);
                    
                    if (r.errors && r.errors.length > 0) {
                        document.getElementById('signalResult').classList.remove('hidden');
                        document.getElementById('signalResultContent').textContent = 
                            'éŒ¯èª¤è¨˜éŒ„:\n' + r.errors.join('\n');
                    }
                } else {
                    showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${e.message}`, true);
            }
        }

        async function testSignalDetection() {
            const symbol = document.getElementById('testSymbolInput').value.trim();
            if (!symbol) {
                showSignalMessage('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ', true);
                return;
            }
            
            showSignalMessage(`æ­£åœ¨æ¸¬è©¦ ${symbol.toUpperCase()} çš„è¨Šè™Ÿåµæ¸¬...`);
            document.getElementById('signalResult').classList.add('hidden');
            
            // ä½¿ç”¨ detect API ç„¶å¾Œéæ¿¾ç‰¹å®šè‚¡ç¥¨
            try {
                const data = await apiRequest('/api/admin/signal/detect', { method: 'POST' });
                if (data && data.success) {
                    const symbolUpper = symbol.toUpperCase();
                    const symbolSignals = data.signals_by_symbol[symbolUpper] || [];
                    
                    showSignalMessage(`âœ… ${symbolUpper} åµæ¸¬åˆ° ${symbolSignals.length} å€‹è¨Šè™Ÿ`);
                    
                    document.getElementById('signalResult').classList.remove('hidden');
                    document.getElementById('signalResultContent').textContent = 
                        JSON.stringify({ symbol: symbolUpper, signals: symbolSignals }, null, 2);
                } else {
                    showSignalMessage(`âŒ åµæ¸¬å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ åµæ¸¬å¤±æ•—: ${e.message}`, true);
            }
        }

        async function testLineNotify() {
            showSignalMessage('æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...');
            
            try {
                const data = await apiRequest('/api/admin/signal/test-push?message=ç®¡ç†å“¡æ¸¬è©¦è¨Šæ¯', { method: 'POST' });
                if (data && data.success) {
                    showSignalMessage('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINE');
                } else {
                    showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${data?.message || data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${e.message}`, true);
            }
        }

        // æ¸¬è©¦è‚¡ç¥¨è¼¸å…¥æ¡† Enter éµæ”¯æ´
        document.getElementById('testSymbolInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testSignalDetection();
        });

        // æœå°‹ Enter éµæ”¯æ´
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadUsers();
        });

        // åˆå§‹è¼‰å…¥
        loadStats();
        loadUsers();
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/compare-nav.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * SELA å ±é…¬ç‡æ¯”è¼ƒåŠŸèƒ½ - å°èˆªé€£çµæ³¨å…¥
 * å°‡æ­¤æª”æ¡ˆæ”¾åˆ° static/ ç›®éŒ„ï¼Œä¸¦åœ¨ dashboard.html çš„ </body> å‰å¼•å…¥
 * <script src="/static/compare-nav.js"></script>
 */

(function() {
    'use strict';
    
    // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
        injectCompareLinks();
    });
    
    // å¦‚æœ DOM å·²ç¶“è¼‰å…¥å®Œæˆï¼Œç›´æ¥åŸ·è¡Œ
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(injectCompareLinks, 100);
    }
    
    function injectCompareLinks() {
        // æ¡Œé¢ç‰ˆå´é‚Šæ¬„é€£çµ HTML
        const desktopLinkHTML = `
            <a href="/static/compare.html" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                <i class="fas fa-chart-bar mr-3"></i>
                <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
            </a>
        `;
        
        // æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„é€£çµ HTML
        const mobileLinkHTML = `
            <a href="/static/compare.html" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target">
                <i class="fas fa-chart-bar mr-3 w-6"></i>
                <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
            </a>
        `;
        
        // æ‰¾åˆ°ã€Œè¨­å®šã€é€£çµä¸¦åœ¨å…¶å¾Œæ’å…¥
        // æ¡Œé¢ç‰ˆ
        const desktopSettingsLinks = document.querySelectorAll('a.nav-link');
        desktopSettingsLinks.forEach(function(link) {
            if (link.textContent.includes('è¨­å®š') && !link.nextElementSibling?.textContent?.includes('å ±é…¬ç‡')) {
                link.insertAdjacentHTML('afterend', desktopLinkHTML);
            }
        });
        
        // æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„
        const mobileSettingsLinks = document.querySelectorAll('a.mobile-nav-link');
        mobileSettingsLinks.forEach(function(link) {
            if (link.textContent.includes('è¨­å®š') && !link.nextElementSibling?.textContent?.includes('å ±é…¬ç‡')) {
                link.insertAdjacentHTML('afterend', mobileLinkHTML);
            }
        });
        
        // ä¹Ÿå¯ä»¥åœ¨å„€è¡¨æ¿å€åŸŸåŠ å…¥å¿«æ·å…¥å£
        addDashboardQuickAccess();
        
        console.log('âœ… å ±é…¬ç‡æ¯”è¼ƒé€£çµå·²æ³¨å…¥');
    }
    
    function addDashboardQuickAccess() {
        // æ‰¾åˆ°å„€è¡¨æ¿å€å¡Š
        const dashboardSection = document.getElementById('section-dashboard');
        if (!dashboardSection) return;
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å¿«æ·å…¥å£
        if (dashboardSection.querySelector('.compare-quick-access')) return;
        
        // åœ¨å„€è¡¨æ¿é–‹é ­åŠ å…¥å¿«æ·å¡ç‰‡
        const quickAccessHTML = `
            <div class="compare-quick-access bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-4 mb-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-lg">ğŸ† å ±é…¬ç‡æ¯”è¼ƒ</h3>
                        <p class="text-indigo-100 text-sm">æ¯”è¼ƒè‚¡ç¥¨ã€åŠ å¯†è²¨å¹£çš„å¹´åŒ–å ±é…¬</p>
                    </div>
                    <a href="/static/compare.html" 
                       class="px-4 py-2 bg-white text-indigo-600 rounded-lg font-medium hover:bg-indigo-50 transition">
                        ç«‹å³æ¯”è¼ƒ â†’
                    </a>
                </div>
            </div>
        `;
        
        // æ‰¾åˆ°ç¬¬ä¸€å€‹å­å…ƒç´ ä¸¦åœ¨å‰é¢æ’å…¥
        const firstChild = dashboardSection.querySelector('h2');
        if (firstChild && firstChild.nextElementSibling) {
            firstChild.nextElementSibling.insertAdjacentHTML('beforebegin', quickAccessHTML);
        }
    }
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/compare.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±é…¬ç‡æ¯”è¼ƒ - SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <style>
        :root {
            --brand-orange: #FA7A35;
        }
        .brand-orange { background-color: var(--brand-orange); }
        .brand-orange:hover { background-color: #e86a25; }
        .brand-text { color: var(--brand-orange); }
        .brand-border { border-color: var(--brand-orange); }
        
        .cagr-positive { color: #16a34a; }
        .cagr-negative { color: #dc2626; }
        .cagr-neutral { color: #6b7280; }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%); }
        
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .symbol-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            border-radius: 9999px;
            margin: 0.25rem;
        }
        .symbol-tag button {
            margin-left: 0.5rem;
            color: #9ca3af;
        }
        .symbol-tag button:hover {
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-slate-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="/static/dashboard.html" class="flex items-center space-x-2">
                        <img src="/static/logo.png" alt="SELA" class="w-10 h-10 rounded-lg">
                        <span class="font-bold text-xl">SELA</span>
                    </a>
                    <span class="text-gray-400">|</span>
                    <span class="text-lg">ğŸ“Š å ±é…¬ç‡æ¯”è¼ƒ</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/static/dashboard.html" class="text-gray-300 hover:text-white">
                        â† è¿”å›å„€è¡¨æ¿
                    </a>
                    <span id="userName" class="text-gray-300"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- èªªæ˜å¡ç‰‡ -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-6 mb-6 text-white">
            <h1 class="text-2xl font-bold mb-2">ğŸ† å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒå™¨</h1>
            <p class="text-blue-100">æ¯”è¼ƒè‚¡ç¥¨ã€åŠ å¯†è²¨å¹£ã€æŒ‡æ•¸çš„é•·æœŸæŠ•è³‡å ±é…¬è¡¨ç¾ï¼Œæ‰¾å‡ºæœ€ä½³æŠ•è³‡æ¨™çš„</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šé¸æ“‡æ¨™çš„ -->
            <div class="lg:col-span-1 space-y-4">
                <!-- å¿«é€Ÿé¸æ“‡é è¨­çµ„åˆ -->
                <div class="bg-white rounded-xl shadow p-4">
                    <h3 class="font-bold text-gray-700 mb-3">ğŸš€ å¿«é€Ÿæ¯”è¼ƒ</h3>
                    <div class="space-y-2" id="presetList">
                        <p class="text-gray-400 text-sm">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- è‡ªè¨‚æ¨™çš„ -->
                <div class="bg-white rounded-xl shadow p-4">
                    <h3 class="font-bold text-gray-700 mb-3">âœï¸ è‡ªè¨‚æ¯”è¼ƒ</h3>
                    
                    <!-- å·²é¸æ¨™çš„ -->
                    <div class="mb-3">
                        <label class="text-sm text-gray-500 mb-1 block">å·²é¸æ¨™çš„ (æœ€å¤š5å€‹)</label>
                        <div id="selectedSymbols" class="min-h-[40px] p-2 bg-gray-50 rounded-lg flex flex-wrap">
                            <span class="text-gray-400 text-sm">å°šæœªé¸æ“‡</span>
                        </div>
                    </div>
                    
                    <!-- è¼¸å…¥æ¡† -->
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="symbolInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ AAPL, BTC)"
                            class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                            onkeypress="if(event.key==='Enter') addSymbol()">
                        <button onclick="addSymbol()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- æ™‚é–“é€±æœŸ -->
                    <div class="mb-3">
                        <label class="text-sm text-gray-500 mb-1 block">æ¯”è¼ƒé€±æœŸ</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="1y" checked> 1å¹´
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="3y" checked> 3å¹´
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="5y" checked> 5å¹´
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="10y"> 10å¹´
                            </label>
                        </div>
                    </div>
                    
                    <!-- åŸºæº–æŒ‡æ•¸ -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 mb-1 block">åŸºæº–æŒ‡æ•¸</label>
                        <select id="benchmarkSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="^GSPC">S&P 500</option>
                            <option value="^IXIC">ç´æ–¯é”å…‹</option>
                            <option value="^DJI">é“ç“Šå·¥æ¥­</option>
                            <option value="">ç„¡</option>
                        </select>
                    </div>
                    
                    <!-- æ’åº -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 mb-1 block">æ’åºä¾æ“š</label>
                        <select id="sortBySelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="1y">1å¹´å ±é…¬ç‡</option>
                            <option value="3y">3å¹´å ±é…¬ç‡</option>
                            <option value="5y" selected>5å¹´å ±é…¬ç‡</option>
                            <option value="10y">10å¹´å ±é…¬ç‡</option>
                        </select>
                    </div>
                    
                    <!-- åŸ·è¡Œæ¯”è¼ƒæŒ‰éˆ• -->
                    <button onclick="runComparison()" id="compareBtn"
                        class="w-full py-3 brand-orange text-white rounded-lg font-bold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chart-bar mr-2"></i>é–‹å§‹æ¯”è¼ƒ
                    </button>
                </div>
                
                <!-- æˆ‘çš„çµ„åˆ -->
                <div class="bg-white rounded-xl shadow p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-700">ğŸ’¾ æˆ‘çš„çµ„åˆ</h3>
                        <button onclick="saveCurrentComparison()" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-save mr-1"></i>å„²å­˜ç›®å‰
                        </button>
                    </div>
                    <div id="savedComparisons" class="space-y-2">
                        <p class="text-gray-400 text-sm">ç™»å…¥å¾Œå¯å„²å­˜çµ„åˆ</p>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šæ¯”è¼ƒçµæœ -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 text-lg">ğŸ“Š æ¯”è¼ƒçµæœ</h3>
                        <span id="resultTime" class="text-sm text-gray-400"></span>
                    </div>
                    
                    <div id="comparisonResult">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-chart-line text-6xl mb-4"></i>
                            <p>é¸æ“‡æ¨™çš„å¾Œé»æ“Šã€Œé–‹å§‹æ¯”è¼ƒã€</p>
                            <p class="text-sm mt-2">æˆ–ä½¿ç”¨å·¦å´çš„å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        const API_BASE = '';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // é¸ä¸­çš„æ¨™çš„
        let selectedSymbols = [];
        
        // æª¢æŸ¥ç™»å…¥
        if (token && user.display_name) {
            document.getElementById('userName').textContent = user.display_name;
        }
        
        // ==================== é è¨­çµ„åˆ ====================
        async function loadPresets() {
            try {
                const res = await fetch(`${API_BASE}/api/compare/presets`);
                const data = await res.json();
                
                if (data.success) {
                    const container = document.getElementById('presetList');
                    container.innerHTML = data.presets.map(preset => `
                        <button onclick="quickCompare('${preset.id}')" 
                            class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition flex justify-between items-center">
                            <span>${preset.name}</span>
                            <span class="text-xs text-gray-400">${preset.count}å€‹</span>
                        </button>
                    `).join('');
                }
            } catch (e) {
                console.error('è¼‰å…¥é è¨­çµ„åˆå¤±æ•—', e);
            }
        }
        
        async function quickCompare(presetId) {
            showLoading();
            try {
                const benchmark = document.getElementById('benchmarkSelect').value;
                const sortBy = document.getElementById('sortBySelect').value;
                
                const res = await fetch(`${API_BASE}/api/compare/quick/${presetId}?benchmark=${benchmark}&sort_by=${sortBy}`);
                const data = await res.json();
                
                if (data.success) {
                    // æ›´æ–°é¸ä¸­çš„æ¨™çš„
                    if (data.preset && data.preset.symbols) {
                        selectedSymbols = data.preset.symbols;
                        renderSelectedSymbols();
                    }
                    renderResult(data);
                } else {
                    showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + e.message);
            }
        }
        
        // ==================== æ¨™çš„é¸æ“‡ ====================
        function addSymbol() {
            const input = document.getElementById('symbolInput');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) return;
            
            if (selectedSymbols.length >= 5) {
                showToast('æœ€å¤šåªèƒ½é¸æ“‡ 5 å€‹æ¨™çš„');
                return;
            }
            
            if (selectedSymbols.includes(symbol)) {
                showToast('å·²ç¶“é¸æ“‡éæ­¤æ¨™çš„');
                return;
            }
            
            selectedSymbols.push(symbol);
            renderSelectedSymbols();
            input.value = '';
        }
        
        function removeSymbol(symbol) {
            selectedSymbols = selectedSymbols.filter(s => s !== symbol);
            renderSelectedSymbols();
        }
        
        function renderSelectedSymbols() {
            const container = document.getElementById('selectedSymbols');
            
            if (selectedSymbols.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">å°šæœªé¸æ“‡</span>';
                return;
            }
            
            container.innerHTML = selectedSymbols.map(symbol => `
                <span class="symbol-tag">
                    ${symbol}
                    <button onclick="removeSymbol('${symbol}')" title="ç§»é™¤">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }
        
        // ==================== åŸ·è¡Œæ¯”è¼ƒ ====================
        async function runComparison() {
            if (selectedSymbols.length === 0) {
                showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™çš„');
                return;
            }
            
            showLoading();
            
            // å–å¾—å‹¾é¸çš„é€±æœŸ
            const periods = Array.from(document.querySelectorAll('.period-check:checked'))
                .map(cb => cb.value);
            
            if (periods.length === 0) {
                showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ™‚é–“é€±æœŸ');
                return;
            }
            
            const benchmark = document.getElementById('benchmarkSelect').value;
            const sortBy = document.getElementById('sortBySelect').value;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/cagr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({
                        symbols: selectedSymbols,
                        periods: periods,
                        benchmark: benchmark,
                        sort_by: sortBy,
                        sort_order: 'desc'
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    renderResult(data);
                } else {
                    showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + (data.detail || data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    document.getElementById('comparisonResult').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                            <p>${data.detail || data.error || 'æ¯”è¼ƒå¤±æ•—'}</p>
                        </div>
                    `;
                }
            } catch (e) {
                showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + e.message);
            }
        }
        
        function showLoading() {
            document.getElementById('comparisonResult').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-gray-500">æ­£åœ¨è¨ˆç®—å ±é…¬ç‡...</p>
                    <p class="text-gray-400 text-sm mt-1">é¦–æ¬¡æŸ¥è©¢å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“</p>
                </div>
            `;
        }
        
        // ==================== æ¸²æŸ“çµæœ ====================
        function renderResult(data) {
            const container = document.getElementById('comparisonResult');
            const periods = data.periods || ['1y', '3y', '5y'];
            
            // æ›´æ–°æ™‚é–“
            if (data.generated_at) {
                const time = new Date(data.generated_at).toLocaleString('zh-TW');
                document.getElementById('resultTime').textContent = `æ›´æ–°ï¼š${time}`;
            }
            
            // å»ºç«‹è¡¨æ ¼
            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ’å</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ¨™çš„</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ç¾åƒ¹</th>
                                ${periods.map(p => `
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">${formatPeriod(p)}</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;
            
            data.comparison.forEach((item, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                const typeIcon = item.type === 'crypto' ? 'ğŸª™' : item.type === 'index' ? 'ğŸ“ˆ' : 'ğŸ“Š';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${rankClass} font-bold text-sm">
                                ${rankIcon}
                            </span>
                        </td>
                        <td class="px-4 py-4">
                            <div class="flex items-center">
                                <span class="mr-2">${typeIcon}</span>
                                <div>
                                    <div class="font-medium text-gray-900">${item.symbol}</div>
                                    <div class="text-xs text-gray-500">${item.name || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-right">
                            ${item.current_price ? `$${formatNumber(item.current_price)}` : '--'}
                        </td>
                        ${periods.map(p => {
                            const cagr = item.cagr ? item.cagr[p] : null;
                            const vsBench = item.vs_benchmark ? item.vs_benchmark[p] : null;
                            return `
                                <td class="px-4 py-4 text-right">
                                    ${formatCAGR(cagr)}
                                    ${vsBench !== null && vsBench !== undefined ? `
                                        <div class="text-xs ${vsBench >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${vsBench >= 0 ? '+' : ''}${vsBench.toFixed(1)}%
                                        </div>
                                    ` : ''}
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // åŸºæº–æŒ‡æ•¸è³‡è¨Š
            if (data.benchmark) {
                html += `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm text-gray-500">ğŸ“Œ åŸºæº–æŒ‡æ•¸ï¼š</span>
                        <span class="font-medium">${data.benchmark.name} (${data.benchmark.symbol})</span>
                        <span class="ml-4 text-sm text-gray-500">
                            ${periods.map(p => `${formatPeriod(p)}: ${formatCAGR(data.benchmark.cagr[p], true)}`).join(' | ')}
                        </span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function formatPeriod(period) {
            const map = { '1y': '1å¹´', '3y': '3å¹´', '5y': '5å¹´', '10y': '10å¹´', 'custom': 'è‡ªè¨‚' };
            return map[period] || period;
        }
        
        function formatCAGR(value, simple = false) {
            if (value === null || value === undefined) {
                return '<span class="text-gray-400">--</span>';
            }
            
            const colorClass = value > 0 ? 'cagr-positive' : value < 0 ? 'cagr-negative' : 'cagr-neutral';
            const sign = value > 0 ? '+' : '';
            
            if (simple) {
                return `<span class="${colorClass}">${sign}${value.toFixed(1)}%</span>`;
            }
            
            return `<span class="${colorClass} font-medium text-lg">${sign}${value.toFixed(1)}%</span>`;
        }
        
        function formatNumber(num) {
            if (num >= 1000) {
                return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return num.toFixed(2);
        }
        
        // ==================== å„²å­˜çµ„åˆ ====================
        async function saveCurrentComparison() {
            if (!token) {
                showToast('è«‹å…ˆç™»å…¥');
                return;
            }
            
            if (selectedSymbols.length === 0) {
                showToast('è«‹å…ˆé¸æ“‡æ¨™çš„');
                return;
            }
            
            const name = prompt('è«‹è¼¸å…¥çµ„åˆåç¨±ï¼š');
            if (!name) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/saved`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name: name,
                        symbols: selectedSymbols,
                        benchmark: document.getElementById('benchmarkSelect').value
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('çµ„åˆå·²å„²å­˜');
                    loadSavedComparisons();
                } else {
                    showToast('å„²å­˜å¤±æ•—ï¼š' + (data.detail || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                showToast('å„²å­˜å¤±æ•—ï¼š' + e.message);
            }
        }
        
        async function loadSavedComparisons() {
            if (!token) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/saved`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success && data.comparisons.length > 0) {
                    const container = document.getElementById('savedComparisons');
                    container.innerHTML = data.comparisons.map(c => `
                        <div class="flex justify-between items-center p-2 rounded hover:bg-gray-50">
                            <button onclick="loadSavedComparison(${c.id}, ${JSON.stringify(c.symbols).replace(/"/g, '&quot;')})" 
                                class="text-left flex-1">
                                <div class="font-medium text-sm">${c.name}</div>
                                <div class="text-xs text-gray-400">${c.symbols.join(', ')}</div>
                            </button>
                            <button onclick="deleteSavedComparison(${c.id})" class="text-red-400 hover:text-red-600 ml-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('è¼‰å…¥å„²å­˜çµ„åˆå¤±æ•—', e);
            }
        }
        
        function loadSavedComparison(id, symbols) {
            selectedSymbols = symbols;
            renderSelectedSymbols();
            runComparison();
        }
        
        async function deleteSavedComparison(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤çµ„åˆï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/saved/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('å·²åˆªé™¤');
                    loadSavedComparisons();
                }
            } catch (e) {
                showToast('åˆªé™¤å¤±æ•—');
            }
        }
        
        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        
        // ==================== åˆå§‹åŒ– ====================
        loadPresets();
        if (token) {
            loadSavedComparisons();
        }
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/css/settings.css  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```css
/**
 * SELA è¨­å®šé é¢æ¨£å¼
 * ç‰ˆæœ¬: 1.0.0
 * æ—¥æœŸ: 2026-01-12
 */

/* ========== å¿«é€Ÿæ¨¡æ¿æŒ‰éˆ• ========== */
.template-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    border-radius: 0.75rem;
    border: 2px solid #e5e7eb;
    color: #6b7280;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.template-btn:hover {
    border-color: #fb923c;
    color: #f97316;
    background: #fff7ed;
    transform: translateY(-2px);
}

.template-btn.active {
    border-color: #f97316;
    background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
    color: #ea580c;
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
}

.template-btn i {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.template-btn span {
    font-size: 0.75rem;
    font-weight: 600;
}

/* ========== é–‹é—œåˆ‡æ› ========== */
.toggle-switch {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1rem;
    background: #f9fafb;
    border-radius: 0.75rem;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s ease;
    user-select: none;
}

.toggle-switch:hover {
    background: #f3f4f6;
}

.toggle-switch.active {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #93c5fd;
}

.toggle-switch .toggle-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toggle-switch .toggle-label i {
    color: #9ca3af;
    width: 1.25rem;
    text-align: center;
}

.toggle-switch.active .toggle-label i {
    color: #3b82f6;
}

.toggle-switch .toggle-label span {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
}

.toggle-dot {
    width: 2.75rem;
    height: 1.5rem;
    background: #d1d5db;
    border-radius: 9999px;
    position: relative;
    transition: background 0.2s ease;
    flex-shrink: 0;
}

.toggle-switch.active .toggle-dot {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.toggle-dot::after {
    content: '';
    position: absolute;
    width: 1.125rem;
    height: 1.125rem;
    background: white;
    border-radius: 50%;
    top: 0.1875rem;
    left: 0.1875rem;
    transition: transform 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-switch.active .toggle-dot::after {
    transform: translateX(1.25rem);
}

/* ========== åƒæ•¸è¼¸å…¥ ========== */
.param-input {
    width: 100%;
    padding: 0.625rem 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    text-align: center;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    background: white;
    transition: all 0.2s ease;
    outline: none;
}

.param-input:hover {
    border-color: #d1d5db;
}

.param-input:focus {
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}

/* ========== åƒæ•¸å€å¡Šæ¨™é¡Œ ========== */
.param-section-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.param-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.375rem;
    display: block;
}

/* ========== å¡ç‰‡æ¨£å¼ ========== */
.settings-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid #f3f4f6;
}

.settings-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #f3f4f6;
}

.settings-card-header h3 {
    font-size: 1rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

/* ========== æŠ˜ç–Šé¢æ¿ ========== */
.collapse-header {
    width: 100%;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: white;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
}

.collapse-header:hover {
    background: #fafafa;
}

.collapse-arrow {
    color: #9ca3af;
    transition: transform 0.3s ease;
}

.collapse-arrow.rotated {
    transform: rotate(180deg);
}

.collapse-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.collapse-content.expanded {
    max-height: 1000px;
}

.collapse-content-inner {
    padding: 0 1.25rem 1.25rem;
    border-top: 1px solid #f3f4f6;
}

/* ========== å„²å­˜æŒ‰éˆ• ========== */
.save-btn {
    width: 100%;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: white;
    font-weight: 700;
    font-size: 1rem;
    border: none;
    border-radius: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.25);
}

.save-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(249, 115, 22, 0.3);
}

.save-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.save-btn .unsaved-badge {
    font-size: 0.75rem;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    margin-left: 0.5rem;
}

/* ========== è¨Šæ¯æç¤º ========== */
.settings-message {
    padding: 1rem;
    border-radius: 0.75rem;
    text-align: center;
    font-weight: 500;
    margin-top: 1rem;
    animation: slideIn 0.3s ease;
}

.settings-message.success {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #166534;
    border: 1px solid #86efac;
}

.settings-message.error {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 1px solid #fca5a5;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ========== ç”¨æˆ¶è³‡è¨Š ========== */
.user-info-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.user-info-card .user-avatar {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.2);
}

.user-info-card .user-name {
    font-size: 1.125rem;
    font-weight: 700;
}

.user-info-card .user-level {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    margin-top: 0.25rem;
}

/* ========== è¼‰å…¥å‹•ç•« ========== */
.settings-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #6b7280;
}

.settings-loading i {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #f97316;
}

/* ========== éŸ¿æ‡‰å¼ ========== */
@media (max-width: 640px) {
    .settings-card { padding: 1rem; }
    .toggle-switch { padding: 0.75rem; }
    .template-btn { padding: 0.625rem; }
    .template-btn i { font-size: 1rem; }
    .template-btn span { font-size: 0.6875rem; }
}
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/dashboard-mobile.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --brand-orange: #FA7A35;
            --brand-orange-hover: #e86a25;
        }
        
        .brand-orange { background-color: var(--brand-orange); }
        .brand-orange:hover { background-color: var(--brand-orange-hover); }
        .brand-text { color: var(--brand-orange); }
        .brand-border { border-color: var(--brand-orange); }
        
        /* é è¨­éš±è—ä¸»å…§å®¹ */
        #app-content { display: none; }
        
        /* é€šç”¨å‹•ç•« */
        .transition-all { transition: all 0.3s ease; }
        
        /* ===== é›»è…¦ç‰ˆæ¨£å¼ (é è¨­) ===== */
        .desktop-sidebar { display: block; }
        .mobile-header-menu { display: none; }
        .mobile-bottom-nav { display: none; }
        .mobile-sidebar-overlay { display: none; }
        .mobile-sidebar { transform: translateX(-100%); }
        
        /* ===== æ‰‹æ©Ÿç‰ˆæ¨£å¼ ===== */
        @media (max-width: 767px) {
            /* éš±è—é›»è…¦ç‰ˆå´é‚Šæ¬„ */
            .desktop-sidebar { display: none !important; }
            
            /* ä¸»å…§å®¹å€ä¸éœ€è¦å·¦é‚Šè· */
            .main-content { margin-left: 0 !important; padding-bottom: 70px; }
            
            /* é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆå…ƒç´  */
            .mobile-header-menu { display: flex !important; }
            .mobile-bottom-nav { display: flex !important; }
            
            /* æ‰‹æ©Ÿç‰ˆå´é‚Šé¸å–® */
            .mobile-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                background: white;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            
            .mobile-sidebar.open { transform: translateX(0); }
            
            .mobile-sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .mobile-sidebar-overlay.open { display: block; opacity: 1; }
            
            /* åŠ å¤§è§¸æ§å€åŸŸ */
            .touch-target { min-height: 44px; min-width: 44px; }
            
            /* å¡ç‰‡æ¨£å¼ */
            .stock-card {
                background: white;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            /* æ‘ºç–Šå€å¡Š */
            .collapsible-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }
            
            .collapsible-content.open { max-height: 500px; }
            
            /* å…¨è¢å¹•åœ–è¡¨ */
            .chart-fullscreen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: white;
                z-index: 2000;
                display: none;
            }
            
            .chart-fullscreen.open { display: block; }
            
            /* å¼·åˆ¶æ©«å‘æç¤º */
            .rotate-hint {
                display: none;
            }
            
            @media (orientation: portrait) {
                .chart-fullscreen .rotate-hint { display: flex; }
                .chart-fullscreen .chart-container { display: none; }
            }
            
            @media (orientation: landscape) {
                .chart-fullscreen .rotate-hint { display: none; }
                .chart-fullscreen .chart-container { display: block; }
            }
        }
        
        /* åº•éƒ¨å°èˆªåˆ— */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 100;
            display: none;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 8px 0;
            color: #6b7280;
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
        }
        
        .bottom-nav-item.active { color: var(--brand-orange); }
        .bottom-nav-item i { font-size: 20px; margin-bottom: 2px; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center z-50">
        <div class="text-center">
            <img src="/static/logo.png" alt="SELA" class="w-24 h-24 mx-auto mb-4 rounded-xl">
            <p class="text-white text-lg">è¼‰å…¥ä¸­...</p>
            <i class="fas fa-spinner fa-spin text-white text-2xl mt-4"></i>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å…§å®¹ -->
    <div id="app-content">
        
        <!-- ===== æ‰‹æ©Ÿç‰ˆå´é‚Šé¸å–®é®ç½© ===== -->
        <div id="sidebarOverlay" class="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>
        
        <!-- ===== æ‰‹æ©Ÿç‰ˆå´é‚Šé¸å–® ===== -->
        <aside id="mobileSidebar" class="mobile-sidebar">
            <div class="p-4 border-b flex items-center justify-between">
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-10 h-10 rounded-lg mr-2">
                    <span class="font-bold text-lg">SELA</span>
                </div>
                <button onclick="closeMobileSidebar()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#" onclick="mobileNavTo('dashboard')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-700 bg-blue-50 rounded-lg touch-target" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i>
                    <span>å„€è¡¨æ¿</span>
                </a>
                <a href="#" onclick="mobileNavTo('search')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="search">
                    <i class="fas fa-search mr-3 w-5"></i>
                    <span>è‚¡ç¥¨æŸ¥è©¢</span>
                </a>
                <a href="#" onclick="mobileNavTo('watchlist')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="watchlist">
                    <i class="fas fa-star mr-3 w-5"></i>
                    <span>è¿½è¹¤æ¸…å–®</span>
                </a>
                <a href="#" onclick="mobileNavTo('sentiment')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="sentiment">
                    <i class="fas fa-heart-pulse mr-3 w-5"></i>
                    <span>å¸‚å ´æƒ…ç·’</span>
                </a>
                <a href="#" onclick="mobileNavTo('settings')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="settings">
                    <i class="fas fa-cog mr-3 w-5"></i>
                    <span>è¨­å®š</span>
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <img id="sidebarAvatar" class="w-10 h-10 rounded-full mr-3" src="" alt="">
                        <span id="sidebarUserName" class="text-gray-700 font-medium"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-400 mb-2">
                    é–’ç½®ç™»å‡º: <span id="sidebarTimer">5:00</span>
                </div>
                <button onclick="logout()" class="w-full py-2 text-red-500 hover:bg-red-50 rounded-lg flex items-center justify-center touch-target">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>ç™»å‡º</span>
                </button>
            </div>
        </aside>
        
        <!-- ===== é ‚éƒ¨å°è¦½åˆ— ===== -->
        <nav class="bg-white shadow-sm border-b fixed w-full z-50 top-0">
            <div class="px-4 h-14 flex items-center justify-between">
                <!-- æ‰‹æ©Ÿç‰ˆ: æ¼¢å ¡é¸å–®æŒ‰éˆ• -->
                <button onclick="openMobileSidebar()" class="mobile-header-menu p-2 -ml-2 text-gray-600 touch-target">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <!-- Logo -->
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-8 h-8 rounded-lg mr-2">
                    <span class="font-bold text-lg text-gray-800 hidden sm:inline">è‡ªå‹•é¸è‚¡ç³»çµ±</span>
                    <span class="font-bold text-lg text-gray-800 sm:hidden">SELA</span>
                </div>
                
                <!-- å³å´è³‡è¨Š -->
                <div class="flex items-center space-x-2">
                    <span id="sessionTimer" class="text-xs text-gray-400 hidden sm:inline"></span>
                    <span id="userName" class="text-gray-600 text-sm hidden md:inline"></span>
                    <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="">
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 hidden sm:inline p-2" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- ===== é›»è…¦ç‰ˆå´é‚Šæ¬„ ===== -->
        <aside class="desktop-sidebar w-64 bg-white shadow-sm min-h-screen fixed top-14">
            <nav class="p-4 space-y-2">
                <a href="#" onclick="showSection('dashboard', event)" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-blue-50 rounded-lg" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>å„€è¡¨æ¿</span>
                </a>
                <a href="#" onclick="showSection('search', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="search">
                    <i class="fas fa-search mr-3"></i>
                    <span>è‚¡ç¥¨æŸ¥è©¢</span>
                </a>
                <a href="#" onclick="showSection('watchlist', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="watchlist">
                    <i class="fas fa-star mr-3"></i>
                    <span>è¿½è¹¤æ¸…å–®</span>
                </a>
                <a href="#" onclick="showSection('sentiment', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="sentiment">
                    <i class="fas fa-heart-pulse mr-3"></i>
                    <span>å¸‚å ´æƒ…ç·’</span>
                </a>
                <a href="#" onclick="showSection('settings', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="settings">
                    <i class="fas fa-cog mr-3"></i>
                    <span>è¨­å®š</span>
                </a>
            </nav>
        </aside>

        <!-- ===== ä¸»å€åŸŸ ===== -->
        <main class="main-content md:ml-64 pt-14 p-4 md:p-6 min-h-screen">
            
            <!-- ===== å„€è¡¨æ¿å€å¡Š ===== -->
            <section id="section-dashboard" class="section">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">å„€è¡¨æ¿</h2>
                
                <!-- å¸‚å ´æƒ…ç·’å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                    <!-- ç¾è‚¡æƒ…ç·’ -->
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-3 md:mb-4">
                            <h3 class="font-semibold text-gray-700 text-sm md:text-base">ç¾è‚¡æƒ…ç·’æŒ‡æ•¸</h3>
                            <span id="stockSentimentBadge" class="px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-medium"></span>
                        </div>
                        <div class="flex items-center">
                            <span id="stockSentimentValue" class="text-3xl md:text-4xl font-bold text-gray-800">--</span>
                            <span class="text-gray-500 ml-2 text-sm">/ 100</span>
                        </div>
                        <div class="mt-3 md:mt-4 bg-gray-200 rounded-full h-2 md:h-3">
                            <div id="stockSentimentBar" class="h-2 md:h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- å¹£åœˆæƒ…ç·’ -->
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-3 md:mb-4">
                            <h3 class="font-semibold text-gray-700 text-sm md:text-base">å¹£åœˆæƒ…ç·’æŒ‡æ•¸</h3>
                            <span id="cryptoSentimentBadge" class="px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-medium"></span>
                        </div>
                        <div class="flex items-center">
                            <span id="cryptoSentimentValue" class="text-3xl md:text-4xl font-bold text-gray-800">--</span>
                            <span class="text-gray-500 ml-2 text-sm">/ 100</span>
                        </div>
                        <div class="mt-3 md:mt-4 bg-gray-200 rounded-full h-2 md:h-3">
                            <div id="cryptoSentimentBar" class="h-2 md:h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- è¿½è¹¤æ¸…å–®å¿«è¦½ -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">è¿½è¹¤æ¸…å–®</h3>
                        <a href="#" onclick="showSection('watchlist')" class="text-blue-600 text-sm hover:underline">æŸ¥çœ‹å…¨éƒ¨</a>
                    </div>
                    <div id="dashboardWatchlist">
                        <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </section>

            <!-- ===== è‚¡ç¥¨æŸ¥è©¢å€å¡Š ===== -->
            <section id="section-search" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">è‚¡ç¥¨æŸ¥è©¢</h2>
                
                <!-- æœå°‹æ¡† -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4 md:mb-6">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="searchSymbol" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ˆå¦‚ AAPLï¼‰æˆ–åŠ å¯†è²¨å¹£ï¼ˆBTCï¼‰" 
                            class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                            onkeypress="if(event.key==='Enter')searchStock()">
                        <button onclick="searchStock()" class="brand-orange text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center touch-target">
                            <i class="fas fa-search mr-2"></i>
                            <span>æŸ¥è©¢</span>
                        </button>
                    </div>
                    <p class="text-gray-500 text-xs md:text-sm mt-2">æ”¯æ´ç¾è‚¡ä»£è™ŸåŠåŠ å¯†è²¨å¹£ (BTC, ETH)</p>
                </div>
                
                <!-- æœå°‹çµæœ -->
                <div id="searchResult" class="hidden"></div>
            </section>

            <!-- ===== è¿½è¹¤æ¸…å–®å€å¡Š ===== -->
            <section id="section-watchlist" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">è¿½è¹¤æ¸…å–®</h2>
                    <button onclick="showAddWatchlistModal()" class="brand-orange text-white px-4 py-2 rounded-lg font-medium flex items-center touch-target">
                        <i class="fas fa-plus mr-2"></i>
                        <span class="hidden sm:inline">æ–°å¢</span>
                    </button>
                </div>
                <div id="watchlistContent">
                    <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </section>

            <!-- ===== å¸‚å ´æƒ…ç·’å€å¡Š ===== -->
            <section id="section-sentiment" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">å¸‚å ´æƒ…ç·’</h2>
                <div id="sentimentContent">
                    <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </section>

            <!-- ===== è¨­å®šå€å¡Š ===== -->
            <section id="section-settings" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">è¨­å®š</h2>
                <div id="settingsContent" class="bg-white rounded-xl shadow p-4 md:p-6">
                    <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </section>
            
        </main>

        <!-- ===== æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªåˆ— ===== -->
        <nav class="mobile-bottom-nav">
            <a href="#" onclick="mobileNavTo('dashboard')" class="bottom-nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>é¦–é </span>
            </a>
            <a href="#" onclick="mobileNavTo('search')" class="bottom-nav-item" data-section="search">
                <i class="fas fa-search"></i>
                <span>æŸ¥è©¢</span>
            </a>
            <a href="#" onclick="mobileNavTo('watchlist')" class="bottom-nav-item" data-section="watchlist">
                <i class="fas fa-star"></i>
                <span>è¿½è¹¤</span>
            </a>
            <a href="#" onclick="mobileNavTo('sentiment')" class="bottom-nav-item" data-section="sentiment">
                <i class="fas fa-heart-pulse"></i>
                <span>æƒ…ç·’</span>
            </a>
            <a href="#" onclick="mobileNavTo('settings')" class="bottom-nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>è¨­å®š</span>
            </a>
        </nav>

    </div><!-- end app-content -->

    <!-- ===== å…¨è¢å¹•åœ–è¡¨ ===== -->
    <div id="chartFullscreen" class="chart-fullscreen">
        <!-- æ©«å‘æç¤º -->
        <div class="rotate-hint fixed inset-0 bg-white flex flex-col items-center justify-center z-10">
            <div class="text-6xl mb-4">ğŸ“±ğŸ”„</div>
            <p class="text-lg text-gray-700 mb-2">è«‹å°‡æ‰‹æ©Ÿæ©«å‘æ”¾ç½®</p>
            <p class="text-gray-500 text-sm">ä»¥ç²å¾—æœ€ä½³åœ–è¡¨é«”é©—</p>
            <button onclick="closeChartFullscreen()" class="mt-6 px-6 py-2 border border-gray-300 rounded-lg text-gray-600">
                è¿”å›
            </button>
        </div>
        <!-- æ©«å‘åœ–è¡¨ -->
        <div class="chart-container h-full flex flex-col">
            <div class="flex items-center justify-between p-3 border-b bg-white">
                <button onclick="closeChartFullscreen()" class="p-2 text-gray-600 touch-target">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <span id="chartFullscreenTitle" class="font-bold text-lg"></span>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 p-2 bg-gray-50">
                <canvas id="fullscreenChart"></canvas>
            </div>
            <div class="flex items-center justify-center gap-2 p-2 bg-white border-t">
                <button onclick="setChartRange(30)" class="chart-range-btn px-3 py-1 text-sm rounded border">1M</button>
                <button onclick="setChartRange(90)" class="chart-range-btn px-3 py-1 text-sm rounded border bg-blue-50 border-blue-500 text-blue-600">3M</button>
                <button onclick="setChartRange(180)" class="chart-range-btn px-3 py-1 text-sm rounded border">6M</button>
                <button onclick="setChartRange(365)" class="chart-range-btn px-3 py-1 text-sm rounded border">1Y</button>
            </div>
        </div>
    </div>

    <!-- ===== æ–°å¢è¿½è¹¤æ¸…å–® Modal ===== -->
    <div id="addWatchlistModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢è¿½è¹¤</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨/åŠ å¯†è²¨å¹£ä»£è™Ÿ</label>
                    <input type="text" id="addSymbol" placeholder="å¦‚ AAPLã€BTC" 
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">é¡å‹</label>
                    <select id="addAssetType" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                        <option value="stock">è‚¡ç¥¨</option>
                        <option value="crypto">åŠ å¯†è²¨å¹£</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                    <input type="text" id="addNote" placeholder="è‡ªè¨‚å‚™è¨»" 
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideAddWatchlistModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">å–æ¶ˆ</button>
                <button onclick="addToWatchlist()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 touch-target">æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- ===== Toast é€šçŸ¥ ===== -->
    <div id="toast" class="fixed bottom-20 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-auto bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity text-center">
        <span id="toastMessage"></span>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let currentChartData = null;
        let fullscreenChartInstance = null;
        
        // ========== è¨­å‚™æª¢æ¸¬ ==========
        const deviceInfo = {
            isMobile: window.innerWidth < 768,
            isTouch: 'ontouchstart' in window,
            isLineApp: /Line\//i.test(navigator.userAgent),
            isIOS: /iPhone|iPad/i.test(navigator.userAgent),
            isAndroid: /Android/i.test(navigator.userAgent),
        };
        
        console.log('Device info:', deviceInfo);
        
        // ========== è‡ªå‹•ç™»å‡ºåŠŸèƒ½ ==========
        const SESSION_TIMEOUT = 5 * 60 * 1000; // 5 åˆ†é˜
        let sessionTimer = null;
        let lastActivity = Date.now();
        
        function resetSessionTimer() {
            lastActivity = Date.now();
        }
        
        function checkSessionTimeout() {
            const elapsed = Date.now() - lastActivity;
            const remaining = SESSION_TIMEOUT - elapsed;
            
            if (remaining <= 0) {
                showToast('é–’ç½®è¶…é 5 åˆ†é˜ï¼Œå·²è‡ªå‹•ç™»å‡º');
                setTimeout(() => logout(), 1500);
            } else {
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                const timerEl = document.getElementById('sessionTimer');
                const sidebarTimerEl = document.getElementById('sidebarTimer');
                if (timerEl) timerEl.textContent = `é–’ç½®ç™»å‡º: ${timeStr}`;
                if (sidebarTimerEl) sidebarTimerEl.textContent = timeStr;
            }
        }
        
        function startSessionMonitor() {
            ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetSessionTimer, { passive: true });
            });
            sessionTimer = setInterval(checkSessionTimeout, 1000);
        }
        
        function stopSessionMonitor() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }
        
        // ========== ç™»å…¥é©—è­‰ ==========
        async function checkAuth() {
            if (!token) {
                window.location.href = '/static/index.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error('Unauthorized');
                
                currentUser = await res.json();
                
                // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
                document.getElementById('userName').textContent = currentUser.display_name;
                document.getElementById('userAvatar').src = currentUser.picture_url || 'https://via.placeholder.com/40';
                document.getElementById('sidebarUserName').textContent = currentUser.display_name;
                document.getElementById('sidebarAvatar').src = currentUser.picture_url || 'https://via.placeholder.com/40';
                
                // é¡¯ç¤ºä¸»å…§å®¹
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                
                startSessionMonitor();
                loadDashboard();
            } catch (e) {
                localStorage.removeItem('token');
                window.location.href = '/static/index.html';
            }
        }

        function logout() {
            stopSessionMonitor();
            localStorage.removeItem('token');
            window.location.href = '/static/index.html';
        }

        // ========== æ‰‹æ©Ÿç‰ˆé¸å–® ==========
        function openMobileSidebar() {
            document.getElementById('mobileSidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileSidebar() {
            document.getElementById('mobileSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
            document.body.style.overflow = '';
        }
        
        function mobileNavTo(section) {
            closeMobileSidebar();
            showSection(section);
            
            // æ›´æ–°åº•éƒ¨å°èˆªå’Œå´é‚Šé¸å–®é«˜äº®
            document.querySelectorAll('.bottom-nav-item, .mobile-nav-link').forEach(el => {
                el.classList.remove('active', 'bg-blue-50', 'text-gray-700');
                if (el.dataset.section === section) {
                    el.classList.add('active');
                    if (el.classList.contains('mobile-nav-link')) {
                        el.classList.add('bg-blue-50', 'text-gray-700');
                    }
                } else if (el.classList.contains('mobile-nav-link')) {
                    el.classList.add('text-gray-600');
                }
            });
        }

        // ========== åˆ‡æ›å€å¡Š ==========
        function showSection(name, evt) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const section = document.getElementById(`section-${name}`);
            if (section) {
                section.classList.remove('hidden');
            }
            
            // æ›´æ–°é›»è…¦ç‰ˆå°èˆªé«˜äº®
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('bg-blue-50', 'text-gray-700');
                l.classList.add('text-gray-600');
            });
            
            if (evt && evt.target) {
                const navLink = evt.target.closest('.nav-link');
                if (navLink) {
                    navLink.classList.add('bg-blue-50', 'text-gray-700');
                    navLink.classList.remove('text-gray-600');
                }
            }
            
            // æ›´æ–°åº•éƒ¨å°èˆªé«˜äº®
            document.querySelectorAll('.bottom-nav-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.section === name) {
                    el.classList.add('active');
                }
            });

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (name === 'watchlist') loadWatchlist();
            if (name === 'sentiment') loadSentimentDetail();
            if (name === 'settings') loadSettings();
        }

        // ========== è¼‰å…¥å„€è¡¨æ¿ ==========
        async function loadDashboard() {
            await loadSentiment();
            await loadWatchlistOverview();
        }

        // ========== è¼‰å…¥å¸‚å ´æƒ…ç·’ ==========
        async function loadSentiment() {
            try {
                const res = await fetch(`${API_BASE}/api/market/sentiment`);
                const data = await res.json();
                
                if (data.success) {
                    if (data.stock) {
                        updateSentimentCard('stock', data.stock);
                    } else {
                        updateSentimentCard('stock', { value: 50, classification: 'neutral' });
                    }
                    
                    if (data.crypto) {
                        updateSentimentCard('crypto', data.crypto);
                    } else {
                        updateSentimentCard('crypto', { value: 50, classification: 'neutral' });
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥æƒ…ç·’å¤±æ•—', e);
                updateSentimentCard('stock', { value: 50, classification: 'neutral' });
                updateSentimentCard('crypto', { value: 50, classification: 'neutral' });
            }
        }

        function updateSentimentCard(type, sentiment) {
            if (!sentiment) return;
            
            const value = sentiment.value;
            
            document.getElementById(`${type}SentimentValue`).textContent = value;
            document.getElementById(`${type}SentimentBar`).style.width = `${value}%`;
            
            const badge = document.getElementById(`${type}SentimentBadge`);
            const bar = document.getElementById(`${type}SentimentBar`);
            
            let badgeClass, barClass, label;
            if (value <= 25) {
                badgeClass = 'bg-red-100 text-red-700';
                barClass = 'bg-red-500';
                label = 'æ¥µåº¦ææ‡¼';
            } else if (value <= 45) {
                badgeClass = 'bg-orange-100 text-orange-700';
                barClass = 'bg-orange-500';
                label = 'ææ‡¼';
            } else if (value <= 55) {
                badgeClass = 'bg-gray-100 text-gray-700';
                barClass = 'bg-gray-500';
                label = 'ä¸­æ€§';
            } else if (value <= 75) {
                badgeClass = 'bg-green-100 text-green-700';
                barClass = 'bg-green-500';
                label = 'è²ªå©ª';
            } else {
                badgeClass = 'bg-emerald-100 text-emerald-700';
                barClass = 'bg-emerald-500';
                label = 'æ¥µåº¦è²ªå©ª';
            }
            
            badge.className = `px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-medium ${badgeClass}`;
            badge.textContent = label;
            bar.className = `h-2 md:h-3 rounded-full transition-all ${barClass}`;
        }

        // ========== è¿½è¹¤æ¸…å–®å¿«è¦½ ==========
        async function loadWatchlistOverview() {
            const container = document.getElementById('dashboardWatchlist');
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                            <p class="text-gray-500 text-sm">å°šç„¡è¿½è¹¤æ¸…å–®</p>
                            <button onclick="showSection('search')" class="mt-2 text-blue-600 text-sm">å‰å¾€æŸ¥è©¢è‚¡ç¥¨</button>
                        </div>
                    `;
                    return;
                }
                
                // åªé¡¯ç¤ºå‰ 5 ç­†
                const items = data.data.slice(0, 5);
                let html = '<div class="space-y-2">';
                
                for (const item of items) {
                    html += `
                        <div class="flex items-center justify-between py-2 border-b last:border-0 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded" onclick="searchSymbol('${item.symbol}')">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-800">${item.symbol}</span>
                                <span class="ml-2 text-xs px-2 py-0.5 rounded ${item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                    ${item.asset_type === 'crypto' ? 'å¹£' : 'è‚¡'}
                                </span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('è¼‰å…¥è¿½è¹¤æ¸…å–®å¤±æ•—', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // ========== è‚¡ç¥¨æŸ¥è©¢ ==========
        function searchStock() {
            const symbol = document.getElementById('searchSymbol').value.trim().toUpperCase();
            if (!symbol) {
                showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            searchSymbol(symbol);
        }

        async function searchSymbol(symbol) {
            const container = document.getElementById('searchResult');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="bg-white rounded-xl shadow p-6 text-center"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500 text-sm">æŸ¥è©¢ä¸­...ï¼ˆé¦–æ¬¡æŸ¥è©¢å¯èƒ½éœ€è¦ 10-30 ç§’ï¼‰</p></div>';
            
            showSection('search');
            document.getElementById('searchSymbol').value = symbol;

            try {
                const isCrypto = ['BTC', 'ETH'].includes(symbol);
                const endpoint = isCrypto ? `/api/crypto/${symbol}` : `/api/stock/${symbol}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                const res = await fetch(`${API_BASE}${endpoint}`, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await res.json();
                
                if (!res.ok) {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">HTTP ${res.status}: ${data.detail || 'æŸ¥è©¢å¤±æ•—'}</div>`;
                    return;
                }
                
                if (!data.success) {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">${data.detail || 'æŸ¥è©¢å¤±æ•—'}</div>`;
                    return;
                }

                currentChartData = data.chart_data;
                renderStockResult(data, isCrypto);
                
            } catch (e) {
                console.error('Search error:', e);
                if (e.name === 'AbortError') {
                    container.innerHTML = '<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">æŸ¥è©¢è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                } else {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">æŸ¥è©¢å¤±æ•—: ${e.message}</div>`;
                }
            }
        }

        function renderStockResult(stock, isCrypto) {
            const container = document.getElementById('searchResult');
            const indicators = stock.indicators || {};
            const ma = indicators.ma || {};
            const rsi = indicators.rsi || {};
            const macd = indicators.macd || {};
            
            const priceChange = stock.change?.day || 0;
            const priceChangeClass = priceChange >= 0 ? 'text-green-600' : 'text-red-600';
            const priceChangeIcon = priceChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            
            const alignmentClass = ma.alignment === 'bullish' ? 'text-green-600' : ma.alignment === 'bearish' ? 'text-red-600' : 'text-gray-600';
            const alignmentText = ma.alignment === 'bullish' ? 'å¤šé ­ ğŸŸ¢' : ma.alignment === 'bearish' ? 'ç©ºé ­ ğŸ”´' : 'ä¸­æ€§';
            
            const rsiStatus = rsi.status === 'overbought' ? 'è¶…è²· âš ï¸' : rsi.status === 'oversold' ? 'è¶…è³£ ğŸŸ¢' : 'ä¸­æ€§';
            const macdStatus = macd.status === 'bullish' ? 'åå¤š ğŸŸ¢' : 'åç©º ğŸ”´';
            
            const html = `
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <!-- åƒ¹æ ¼å€å¡Š -->
                    <div class="p-4 md:p-6 border-b">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">${stock.symbol}</h3>
                                <p class="text-gray-500 text-sm">${stock.name || (isCrypto ? 'åŠ å¯†è²¨å¹£' : 'è‚¡ç¥¨')}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs ${isCrypto ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                ${isCrypto ? 'åŠ å¯†è²¨å¹£' : 'ç¾è‚¡'}
                            </span>
                        </div>
                        <div class="mt-3">
                            <span class="text-3xl md:text-4xl font-bold text-gray-800">$${stock.price?.current?.toLocaleString() || '--'}</span>
                            <span class="ml-2 ${priceChangeClass} text-lg">
                                ${priceChange >= 0 ? '+' : ''}${priceChange?.toFixed(2)}% ${priceChangeIcon}
                            </span>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿç¸½è¦½ -->
                    <div class="p-4 md:p-6 border-b bg-gray-50">
                        <h4 class="font-semibold text-gray-700 mb-3 text-sm">ğŸ“Š å¿«é€Ÿç¸½è¦½</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">å‡ç·šæ’åˆ—</span>
                                <span class="${alignmentClass} font-medium">${alignmentText}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">RSI</span>
                                <span class="font-medium">${rsi.value?.toFixed(0) || '--'} ${rsiStatus}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">MACD</span>
                                <span class="font-medium">${macdStatus}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">è©•åˆ†</span>
                                <span class="font-medium">${stock.score?.rating === 'bullish' ? 'åå¤š' : stock.score?.rating === 'bearish' ? 'åç©º' : 'ä¸­æ€§'} (${stock.score?.buy || 0}/${stock.score?.sell || 0})</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°æŒ‡æ¨™ (å¯æ‘ºç–Š) -->
                    <div class="border-b">
                        <button onclick="toggleCollapsible(this)" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 touch-target">
                            <span class="font-medium text-gray-700">â–¼ å±•é–‹è©³ç´°æŒ‡æ¨™</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div class="collapsible-content">
                            <div class="px-4 pb-4 space-y-3">
                                <!-- MA è©³ç´° -->
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <div class="p-3 rounded-lg ${ma.price_vs_ma20 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                                        <p class="text-gray-500 text-xs">MA20</p>
                                        <p class="font-semibold">${ma.ma20?.toFixed(2) || '--'}</p>
                                        <p class="text-xs ${ma.price_vs_ma20 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                            ${ma.price_vs_ma20 === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š âœ“' : 'åƒ¹æ ¼åœ¨ä¸‹'}
                                        </p>
                                    </div>
                                    <div class="p-3 rounded-lg ${ma.price_vs_ma50 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                                        <p class="text-gray-500 text-xs">MA50</p>
                                        <p class="font-semibold">${ma.ma50?.toFixed(2) || '--'}</p>
                                        <p class="text-xs ${ma.price_vs_ma50 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                            ${ma.price_vs_ma50 === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š âœ“' : 'åƒ¹æ ¼åœ¨ä¸‹'}
                                        </p>
                                    </div>
                                    <div class="p-3 rounded-lg ${ma.price_vs_ma200 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                                        <p class="text-gray-500 text-xs">MA200</p>
                                        <p class="font-semibold">${ma.ma200?.toFixed(2) || '--'}</p>
                                        <p class="text-xs ${ma.price_vs_ma200 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                            ${ma.price_vs_ma200 === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š âœ“' : 'åƒ¹æ ¼åœ¨ä¸‹'}
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- RSI & MACD è©³ç´° -->
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-gray-500 text-xs">RSI (${rsi.period || 14})</p>
                                        <p class="font-semibold">${rsi.value?.toFixed(2) || '--'}</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-gray-500 text-xs">MACD DIF</p>
                                        <p class="font-semibold">${macd.dif?.toFixed(2) || '--'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="p-4 space-y-3">
                        ${stock.chart_data ? `
                        <button onclick="openChartFullscreen('${stock.symbol}', ${stock.price?.current || 0})" 
                            class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium flex items-center justify-center touch-target hover:bg-blue-700">
                            <i class="fas fa-chart-line mr-2"></i>
                            æŸ¥çœ‹å®Œæ•´åœ–è¡¨
                        </button>
                        ` : ''}
                        <button onclick="quickAddToWatchlist('${stock.symbol}', '${isCrypto ? 'crypto' : 'stock'}')" 
                            class="w-full py-3 border-2 border-orange-500 text-orange-600 rounded-lg font-medium flex items-center justify-center touch-target hover:bg-orange-50">
                            <i class="fas fa-star mr-2"></i>
                            åŠ å…¥è¿½è¹¤æ¸…å–®
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function toggleCollapsible(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('i');
            content.classList.toggle('open');
            icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : '';
            btn.querySelector('span').textContent = content.classList.contains('open') ? 'â–² æ”¶åˆè©³ç´°æŒ‡æ¨™' : 'â–¼ å±•é–‹è©³ç´°æŒ‡æ¨™';
        }

        // ========== å…¨è¢å¹•åœ–è¡¨ ==========
        function openChartFullscreen(symbol, price) {
            if (!currentChartData) {
                showToast('æ²’æœ‰åœ–è¡¨è³‡æ–™');
                return;
            }
            
            document.getElementById('chartFullscreenTitle').textContent = `${symbol}  $${price.toLocaleString()}`;
            document.getElementById('chartFullscreen').classList.add('open');
            document.body.style.overflow = 'hidden';
            
            // å»¶é²æ¸²æŸ“åœ–è¡¨
            setTimeout(() => {
                renderFullscreenChart(currentChartData, 90);
            }, 100);
        }
        
        function closeChartFullscreen() {
            document.getElementById('chartFullscreen').classList.remove('open');
            document.body.style.overflow = '';
            
            if (fullscreenChartInstance) {
                fullscreenChartInstance.destroy();
                fullscreenChartInstance = null;
            }
        }
        
        function setChartRange(days) {
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.chart-range-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600');
            });
            event.target.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600');
            
            renderFullscreenChart(currentChartData, days);
        }
        
        function renderFullscreenChart(chartData, days) {
            const canvas = document.getElementById('fullscreenChart');
            if (!canvas) return;
            
            if (fullscreenChartInstance) {
                fullscreenChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const dataLength = chartData.dates.length;
            const startIdx = Math.max(0, dataLength - days);
            
            const labels = chartData.dates.slice(startIdx).map((d, i) => {
                if (i % Math.ceil(days / 6) === 0) return d.slice(5);
                return '';
            });
            
            fullscreenChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç›¤åƒ¹',
                            data: chartData.prices.slice(startIdx),
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA20',
                            data: chartData.ma20.slice(startIdx),
                            borderColor: '#10B981',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA50',
                            data: chartData.ma50.slice(startIdx),
                            borderColor: '#F59E0B',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA200',
                            data: chartData.ma200.slice(startIdx),
                            borderColor: '#EF4444',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === null) return null;
                                    return `${context.dataset.label}: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });
        }

        // ========== è¿½è¹¤æ¸…å–® (å¡ç‰‡å¼) ==========
        async function loadWatchlist() {
            const container = document.getElementById('watchlistContent');
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-star text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500 mb-4">å°šç„¡è¿½è¹¤çš„è‚¡ç¥¨</p>
                            <button onclick="showAddWatchlistModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">
                                <i class="fas fa-plus mr-2"></i>æ–°å¢è¿½è¹¤
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="space-y-3">';
                
                for (const item of data.data) {
                    const typeClass = item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                    const typeText = item.asset_type === 'crypto' ? 'å¹£' : 'è‚¡';
                    
                    html += `
                        <div class="stock-card bg-white rounded-xl shadow-sm p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="font-bold text-lg text-gray-800">${item.symbol}</span>
                                    <span class="ml-2 px-2 py-0.5 rounded text-xs ${typeClass}">${typeText}</span>
                                </div>
                                <button onclick="removeFromWatchlist(${item.id})" class="p-2 text-gray-400 hover:text-red-500 touch-target">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            ${item.note ? `<p class="text-gray-500 text-sm mb-2">${item.note}</p>` : ''}
                            <div class="flex items-center justify-between mt-3">
                                <span class="text-gray-400 text-xs">åŠ å…¥æ–¼ ${new Date(item.added_at).toLocaleDateString()}</span>
                                <button onclick="searchSymbol('${item.symbol}')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 touch-target">
                                    æŸ¥çœ‹è©³æƒ…
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('è¼‰å…¥è¿½è¹¤æ¸…å–®å¤±æ•—', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
            }
        }
        
        function showAddWatchlistModal() {
            document.getElementById('addWatchlistModal').classList.remove('hidden');
            document.getElementById('addWatchlistModal').classList.add('flex');
        }
        
        function hideAddWatchlistModal() {
            document.getElementById('addWatchlistModal').classList.add('hidden');
            document.getElementById('addWatchlistModal').classList.remove('flex');
            document.getElementById('addSymbol').value = '';
            document.getElementById('addNote').value = '';
        }
        
        async function addToWatchlist() {
            const symbol = document.getElementById('addSymbol').value.trim().toUpperCase();
            const assetType = document.getElementById('addAssetType').value;
            const note = document.getElementById('addNote').value.trim();
            
            if (!symbol) {
                showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, asset_type: assetType, note })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('å·²åŠ å…¥è¿½è¹¤æ¸…å–®');
                    hideAddWatchlistModal();
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast(data.detail || 'æ–°å¢å¤±æ•—');
                }
            } catch (e) {
                showToast('æ–°å¢å¤±æ•—');
            }
        }
        
        async function quickAddToWatchlist(symbol, assetType) {
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, asset_type: assetType, note: '' })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${symbol} å·²åŠ å…¥è¿½è¹¤æ¸…å–®`);
                    loadWatchlistOverview();
                } else {
                    showToast(data.detail || 'æ–°å¢å¤±æ•—');
                }
            } catch (e) {
                showToast('æ–°å¢å¤±æ•—');
            }
        }
        
        async function removeFromWatchlist(id) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤è¿½è¹¤ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('å·²ç§»é™¤');
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast('ç§»é™¤å¤±æ•—');
                }
            } catch (e) {
                showToast('ç§»é™¤å¤±æ•—');
            }
        }

        // ========== è¨­å®š ==========
        async function loadSettings() {
            const container = document.getElementById('settingsContent');
            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">å¸³è™Ÿè³‡è¨Š</h3>
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <img id="settingsAvatar" class="w-12 h-12 rounded-full mr-4" src="${currentUser?.picture_url || ''}" alt="">
                            <div>
                                <p class="font-medium text-gray-800">${currentUser?.display_name || ''}</p>
                                <p class="text-gray-500 text-sm">LINE ç™»å…¥</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">é—œæ–¼</h3>
                        <div class="p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                            <p>SELA è‡ªå‹•é¸è‚¡ç³»çµ± v0.3.2</p>
                            <p class="mt-1">æŠ€è¡“æŒ‡æ¨™åˆ†æ Â· æ™ºèƒ½é è­¦é€šçŸ¥</p>
                        </div>
                    </div>
                    
                    <button onclick="logout()" class="w-full py-3 border border-red-500 text-red-500 rounded-lg font-medium hover:bg-red-50 touch-target">
                        <i class="fas fa-sign-out-alt mr-2"></i>ç™»å‡º
                    </button>
                </div>
            `;
        }
        
        async function loadSentimentDetail() {
            const container = document.getElementById('sentimentContent');
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="font-semibold text-gray-700 mb-4">å¸‚å ´æƒ…ç·’è§£è®€</h3>
                        <div class="space-y-4 text-sm text-gray-600">
                            <div class="flex items-start">
                                <span class="w-24 flex-shrink-0 font-medium">0-25</span>
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded mr-2">æ¥µåº¦ææ‡¼</span>
                                <span>å¸‚å ´ææ…Œï¼Œå¯èƒ½æ˜¯è²·å…¥æ©Ÿæœƒ</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-24 flex-shrink-0 font-medium">26-45</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded mr-2">ææ‡¼</span>
                                <span>å¸‚å ´åè¬¹æ…</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-24 flex-shrink-0 font-medium">46-55</span>
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded mr-2">ä¸­æ€§</span>
                                <span>è§€æœ›ç‚ºä¸»</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-24 flex-shrink-0 font-medium">56-75</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded mr-2">è²ªå©ª</span>
                                <span>å¸‚å ´åæ¨‚è§€</span>
                            </div>
                            <div class="flex items-start">
                                <span class="w-24 flex-shrink-0 font-medium">76-100</span>
                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded mr-2">æ¥µåº¦è²ªå©ª</span>
                                <span>å¸‚å ´éç†±ï¼Œç•™æ„é¢¨éšª</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== Toast ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', checkAuth);
        
        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
        window.addEventListener('resize', () => {
            deviceInfo.isMobile = window.innerWidth < 768;
        });
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/dashboard.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸ æª”æ¡ˆéå¤§ï¼Œç•¥éå…§å®¹ï¼ˆ171.4 KBï¼‰

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/index.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .brand-orange { background-color: #FA7A35; }
        .brand-orange:hover { background-color: #e86a25; }
        .brand-text { color: #FA7A35; }
        .line-btn { background-color: #06C755; }
        .line-btn:hover { background-color: #05b34c; }
        .touch-target { min-height: 48px; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md">
        <!-- Logo -->
        <div class="text-center mb-6 md:mb-8">
            <img src="/static/logo.png" alt="SELA Logo" class="w-20 h-20 md:w-24 md:h-24 mx-auto mb-3 md:mb-4 rounded-xl">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">SELA è‡ªå‹•é¸è‚¡ç³»çµ±</h1>
            <p class="text-gray-500 mt-2 text-sm md:text-base">æŠ€è¡“æŒ‡æ¨™åˆ†æ Â· æ™ºèƒ½é è­¦é€šçŸ¥</p>
        </div>

        <!-- åŠŸèƒ½ä»‹ç´¹ -->
        <div class="space-y-2 md:space-y-3 mb-6 md:mb-8">
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>ç¾è‚¡å³æ™‚å ±åƒ¹èˆ‡æŠ€è¡“åˆ†æ</span>
            </div>
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>æ¯”ç‰¹å¹£ã€ä»¥å¤ªå¹£åƒ¹æ ¼è¿½è¹¤</span>
            </div>
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>å€‹äººåŒ–è¿½è¹¤æ¸…å–®</span>
            </div>
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>LINE æ¨æ’­æ™ºèƒ½é è­¦</span>
            </div>
        </div>

        <!-- LINE ç™»å…¥æŒ‰éˆ• -->
        <a href="/auth/line" class="line-btn w-full py-3 md:py-4 px-4 rounded-lg text-white font-semibold flex items-center justify-center space-x-2 transition-colors touch-target">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
            </svg>
            <span>ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥</span>
        </a>

        <!-- ç‰ˆæ¬Š -->
        <p class="text-center text-gray-400 text-xs md:text-sm mt-6 md:mt-8">
            Â© 2025 SELA Â· è‡ªå‹•é¸è‚¡ç³»çµ± v0.3.2
        </p>
    </div>

    <script>
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const token = localStorage.getItem('token');
        if (token) {
            window.location.href = '/static/dashboard.html';
        }
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/settings.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * SELA è¨­å®šé é¢ JavaScript
 * ç‰ˆæœ¬: 1.0.0
 * æ—¥æœŸ: 2026-01-12
 */

const INDICATOR_LABELS = {
    show_ma: { name: 'å‡ç·š', icon: 'fas fa-wave-square', color: 'text-blue-500' },
    show_rsi: { name: 'RSI', icon: 'fas fa-tachometer-alt', color: 'text-green-500' },
    show_macd: { name: 'MACD', icon: 'fas fa-signal', color: 'text-purple-500' },
    show_kd: { name: 'KD', icon: 'fas fa-chart-pie', color: 'text-pink-500' },
    show_bollinger: { name: 'å¸ƒæ—é€šé“', icon: 'fas fa-road', color: 'text-indigo-500' },
    show_obv: { name: 'OBV', icon: 'fas fa-database', color: 'text-teal-500' },
    show_volume: { name: 'æˆäº¤é‡', icon: 'fas fa-chart-bar', color: 'text-orange-500' },
};

const ALERT_LABELS = {
    alert_ma_cross: { name: 'å‡ç·šäº¤å‰', icon: 'fas fa-times', color: 'text-blue-500' },
    alert_ma_breakout: { name: 'å‡ç·šçªç ´', icon: 'fas fa-arrow-up', color: 'text-green-500' },
    alert_rsi: { name: 'RSI è¶…è²·/è¶…è³£', icon: 'fas fa-exclamation-triangle', color: 'text-yellow-500' },
    alert_macd: { name: 'MACD äº¤å‰', icon: 'fas fa-exchange-alt', color: 'text-purple-500' },
    alert_kd: { name: 'KD äº¤å‰', icon: 'fas fa-random', color: 'text-pink-500' },
    alert_bollinger: { name: 'å¸ƒæ—çªç ´', icon: 'fas fa-expand-arrows-alt', color: 'text-indigo-500' },
    alert_volume: { name: 'é‡èƒ½ç•°å¸¸', icon: 'fas fa-volume-up', color: 'text-red-500' },
    alert_sentiment: { name: 'æƒ…ç·’æ¥µç«¯', icon: 'fas fa-smile', color: 'text-orange-500' },
};

const TEMPLATE_NAMES = { minimal: 'æ¥µç°¡', standard: 'æ¨™æº–', full: 'å®Œæ•´', short_term: 'çŸ­ç·š' };

const PARAM_RANGES = {
    ma_short: { min: 5, max: 50, step: 1 },
    ma_mid: { min: 20, max: 100, step: 1 },
    ma_long: { min: 100, max: 300, step: 1 },
    rsi_period: { min: 5, max: 30, step: 1 },
    rsi_overbought: { min: 60, max: 90, step: 1 },
    rsi_oversold: { min: 10, max: 40, step: 1 },
    macd_fast: { min: 5, max: 20, step: 1 },
    macd_slow: { min: 15, max: 40, step: 1 },
    macd_signal: { min: 5, max: 15, step: 1 },
    kd_period: { min: 5, max: 20, step: 1 },
    bollinger_period: { min: 10, max: 30, step: 1 },
    bollinger_std: { min: 1, max: 3, step: 0.1 },
    breakout_threshold: { min: 0.5, max: 5, step: 0.1 },
    volume_alert_ratio: { min: 1, max: 5, step: 0.1 },
};

let settingsState = {
    indicators: {},
    alerts: {},
    params: {},
    hasUnsavedChanges: false,
    isLoading: false,
    currentTemplate: null
};

async function initSettingsPage() {
    console.log('[Settings] åˆå§‹åŒ–è¨­å®šé é¢');
    updateSettingsUserInfo();
    await loadAllSettings();
}

async function loadAllSettings() {
    settingsState.isLoading = true;
    showSettingsLoading(true);
    
    try {
        const [indRes, alertRes, paramRes] = await Promise.all([
            apiRequest('/api/settings/indicators'),
            apiRequest('/api/settings/alerts'),
            apiRequest('/api/settings/params'),
        ]);
        
        settingsState.indicators = indRes.data || {};
        settingsState.alerts = alertRes.data || {};
        settingsState.params = paramRes.data || {};
        settingsState.hasUnsavedChanges = false;
        
        renderIndicatorToggles();
        renderAlertToggles();
        renderParamInputs();
        detectCurrentTemplate();
        updateSaveButton();
    } catch (error) {
        console.error('[Settings] è¼‰å…¥è¨­å®šå¤±æ•—:', error);
        showSettingsMessage('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
    } finally {
        settingsState.isLoading = false;
        showSettingsLoading(false);
    }
}

async function saveAllSettings() {
    const btn = document.getElementById('settings-save-btn');
    if (!btn || settingsState.isLoading) return;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å„²å­˜ä¸­...';
    
    try {
        const params = collectParamValues();
        
        await Promise.all([
            apiRequest('/api/settings/indicators', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settingsState.indicators) }),
            apiRequest('/api/settings/alerts', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settingsState.alerts) }),
            apiRequest('/api/settings/params', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) }),
        ]);
        
        settingsState.params = params;
        settingsState.hasUnsavedChanges = false;
        showSettingsMessage('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼', 'success');
        btn.innerHTML = '<i class="fas fa-check"></i> å·²å„²å­˜';
        setTimeout(() => updateSaveButton(), 2000);
    } catch (error) {
        console.error('[Settings] å„²å­˜å¤±æ•—:', error);
        showSettingsMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
        btn.innerHTML = '<i class="fas fa-save"></i> å„²å­˜è¨­å®š';
        btn.disabled = false;
    }
}

async function applyTemplate(templateName) {
    if (settingsState.isLoading) return;
    
    try {
        const res = await apiRequest(`/api/settings/template/${templateName}`, { method: 'POST' });
        if (res.success) {
            showSettingsMessage(`å·²å¥—ç”¨ã€Œ${TEMPLATE_NAMES[templateName]}ã€æ¨¡æ¿`, 'success');
            settingsState.currentTemplate = templateName;
            updateTemplateButtons();
            await loadAllSettings();
        }
    } catch (error) {
        console.error('[Settings] å¥—ç”¨æ¨¡æ¿å¤±æ•—:', error);
        showSettingsMessage('å¥—ç”¨æ¨¡æ¿å¤±æ•—', 'error');
    }
}

function renderIndicatorToggles() {
    const grid = document.getElementById('indicators-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    for (const [key, config] of Object.entries(INDICATOR_LABELS)) {
        const isActive = settingsState.indicators[key] === true;
        const div = document.createElement('div');
        div.className = `toggle-switch ${isActive ? 'active' : ''}`;
        div.onclick = () => toggleIndicator(key);
        div.innerHTML = `<div class="toggle-label"><i class="${config.icon} ${isActive ? config.color : ''}"></i><span>${config.name}</span></div><div class="toggle-dot"></div>`;
        grid.appendChild(div);
    }
}

function renderAlertToggles() {
    const grid = document.getElementById('alerts-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    for (const [key, config] of Object.entries(ALERT_LABELS)) {
        const isActive = settingsState.alerts[key] === true;
        const div = document.createElement('div');
        div.className = `toggle-switch ${isActive ? 'active' : ''}`;
        div.onclick = () => toggleAlert(key);
        div.innerHTML = `<div class="toggle-label"><i class="${config.icon} ${isActive ? config.color : ''}"></i><span>${config.name}</span></div><div class="toggle-dot"></div>`;
        grid.appendChild(div);
    }
}

function renderParamInputs() {
    for (const [key, value] of Object.entries(settingsState.params)) {
        const input = document.getElementById(`param-${key}`);
        if (input) {
            input.value = value;
            const range = PARAM_RANGES[key];
            if (range) { input.min = range.min; input.max = range.max; input.step = range.step; }
        }
    }
}

function toggleIndicator(key) {
    settingsState.indicators[key] = !settingsState.indicators[key];
    markUnsaved();
    renderIndicatorToggles();
    detectCurrentTemplate();
}

function toggleAlert(key) {
    settingsState.alerts[key] = !settingsState.alerts[key];
    markUnsaved();
    renderAlertToggles();
}

function toggleParamsPanel() {
    const content = document.getElementById('params-collapse-content');
    const arrow = document.getElementById('params-collapse-arrow');
    if (content && arrow) { content.classList.toggle('expanded'); arrow.classList.toggle('rotated'); }
}

function collectParamValues() {
    const params = {};
    for (const key of Object.keys(PARAM_RANGES)) {
        const input = document.getElementById(`param-${key}`);
        if (input) { const value = parseFloat(input.value); if (!isNaN(value)) params[key] = value; }
    }
    return params;
}

function onParamChange() { markUnsaved(); }
function markUnsaved() { settingsState.hasUnsavedChanges = true; updateSaveButton(); }

function updateSaveButton() {
    const btn = document.getElementById('settings-save-btn');
    if (!btn) return;
    btn.disabled = false;
    btn.innerHTML = settingsState.hasUnsavedChanges 
        ? '<i class="fas fa-save"></i> å„²å­˜è¨­å®š <span class="unsaved-badge">æœªå„²å­˜</span>'
        : '<i class="fas fa-save"></i> å„²å­˜è¨­å®š';
}

function updateTemplateButtons() {
    document.querySelectorAll('.template-btn').forEach(btn => {
        const template = btn.getAttribute('data-template');
        btn.classList.toggle('active', template === settingsState.currentTemplate);
    });
}

function detectCurrentTemplate() {
    const ind = settingsState.indicators;
    if (ind.show_ma && ind.show_volume && !ind.show_rsi && !ind.show_macd && !ind.show_kd && !ind.show_bollinger && !ind.show_obv) {
        settingsState.currentTemplate = 'minimal';
    } else if (ind.show_ma && ind.show_rsi && ind.show_macd && ind.show_kd && ind.show_bollinger && ind.show_obv && ind.show_volume) {
        settingsState.currentTemplate = 'full';
    } else {
        settingsState.currentTemplate = null;
    }
    updateTemplateButtons();
}

function showSettingsLoading(show) {
    const loading = document.getElementById('settings-loading');
    const content = document.getElementById('settings-content');
    if (loading) loading.classList.toggle('hidden', !show);
    if (content) content.classList.toggle('hidden', show);
}

function showSettingsMessage(text, type) {
    const msg = document.getElementById('settings-message');
    if (!msg) return;
    msg.className = `settings-message ${type}`;
    msg.textContent = text;
    msg.classList.remove('hidden');
    setTimeout(() => msg.classList.add('hidden'), 3000);
}

function updateSettingsUserInfo() {
    try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const avatar = document.getElementById('settings-user-avatar');
        const name = document.getElementById('settings-user-name');
        const level = document.getElementById('settings-user-level');
        if (avatar && user.avatar_url) avatar.src = user.avatar_url;
        if (name) name.textContent = user.display_name || 'ç”¨æˆ¶';
        if (level) level.textContent = user.is_admin ? 'ç®¡ç†å“¡' : 'å…è²»æœƒå“¡';
    } catch (e) { console.error('æ›´æ–°ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', e); }
}

// å°å‡º
window.initSettingsPage = initSettingsPage;
window.saveAllSettings = saveAllSettings;
window.applyTemplate = applyTemplate;
window.toggleIndicator = toggleIndicator;
window.toggleAlert = toggleAlert;
window.toggleParamsPanel = toggleParamsPanel;
window.onParamChange = onParamChange;
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/SELA-Bugä¿®å¾©è¨˜éŒ„.md  â­
> SELA é¸è‚¡ç³»çµ± - Bug ä¿®å¾©è¨˜éŒ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA é¸è‚¡ç³»çµ± - Bug ä¿®å¾©è¨˜éŒ„

> ç‰ˆæœ¬ï¼šv0.3.0  
> æ›´æ–°æ—¥æœŸï¼š2026-01-05

---

## ç›®éŒ„

1. [å‰ç«¯ Bug](#å‰ç«¯-bug)
2. [å¾Œç«¯ Bug](#å¾Œç«¯-bug)
3. [Async/Await å•é¡Œ](#asyncawait-å•é¡Œ)
4. [éƒ¨ç½²æ³¨æ„äº‹é …](#éƒ¨ç½²æ³¨æ„äº‹é …)

---

## å‰ç«¯ Bug

### Bug 1ï¼šshowSection å‡½æ•¸ event æœªå®šç¾©

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Uncaught TypeError: Cannot read properties of null (reading 'classList')
    at showSection (dashboard.html:277:46)
    at searchSymbol (dashboard.html:411:13)
```

**åŸå› **ï¼š
- `showSection` å‡½æ•¸ä½¿ç”¨äº†å…¨åŸŸ `event` å°è±¡
- å¾å°èˆªåˆ—é»æ“Šæ™‚æœ‰ `event`ï¼Œä½†å¾ `searchSymbol` ç­‰å‡½æ•¸èª¿ç”¨æ™‚æ²’æœ‰

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```javascript
function showSection(name) {
    // ...
    event.target.closest('.nav-link').classList.add('bg-blue-50');  // âŒ event æœªå®šç¾©
}
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```javascript
function showSection(name, evt) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    const section = document.getElementById(`section-${name}`);
    if (section) {
        section.classList.remove('hidden');
    }
    
    document.querySelectorAll('.nav-link').forEach(l => {
        l.classList.remove('bg-blue-50', 'text-gray-700');
        l.classList.add('text-gray-600');
    });
    
    // âœ… åªæœ‰é»æ“Šå°èˆªæ™‚æ‰æ›´æ–°é«˜äº®
    if (evt && evt.target) {
        const navLink = evt.target.closest('.nav-link');
        if (navLink) {
            navLink.classList.add('bg-blue-50', 'text-gray-700');
            navLink.classList.remove('text-gray-600');
        }
    }
    // ...
}
```

**HTML èª¿ç”¨ä¹Ÿè¦ä¿®æ”¹**ï¼š
```html
<!-- âŒ éŒ¯èª¤ -->
<a onclick="showSection('dashboard')">

<!-- âœ… æ­£ç¢º -->
<a onclick="showSection('dashboard', event)">
```

---

### Bug 2ï¼šAPI è³‡æ–™æ ¼å¼ä¸ç¬¦

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
TypeError: Cannot read properties of undefined (reading 'stock')
    at loadSentiment (dashboard.html:299:60)
```

**åŸå› **ï¼š
- å‰ç«¯æœŸæœ› `data.data.stock` æ ¼å¼
- å¾Œç«¯ API å¯¦éš›è¿”å› `data.stock` æ ¼å¼

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```javascript
// âŒ å‰ç«¯æœŸæœ›
updateSentimentCard('stock', data.data.stock);
updateSentimentCard('crypto', data.data.crypto);
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```javascript
// âœ… ç¬¦åˆ API å¯¦éš›è¿”å›æ ¼å¼
updateSentimentCard('stock', data.stock);
updateSentimentCard('crypto', data.crypto);
```

**API å¯¦éš›è¿”å›æ ¼å¼**ï¼š
```json
{
  "success": true,
  "stock": { "value": 45, "classification": "neutral" },
  "crypto": { "value": 32, "classification": "fear" }
}
```

---

### Bug 3ï¼šæœå°‹çµæœè³‡æ–™æ ¼å¼

**åŸå› **ï¼š
- å‰ç«¯æœŸæœ› `data.data` åŒ…å«è‚¡ç¥¨è³‡æ–™
- å¾Œç«¯ç›´æ¥è¿”å›è³‡æ–™åœ¨é ‚å±¤

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```javascript
// âŒ éŒ¯èª¤
renderStockResult(data.data, isCrypto);
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```javascript
// âœ… æ­£ç¢º - è³‡æ–™ç›´æ¥åœ¨é ‚å±¤
renderStockResult(data, isCrypto);
```

---

## å¾Œç«¯ Bug

### Bug 4ï¼šæŠ€è¡“æŒ‡æ¨™æ¬„ä½åå¤§å°å¯«ä¸ä¸€è‡´

**åŸå› **ï¼š
- `indicator_service.py` ç”¢ç”Ÿå°å¯«æ¬„ä½åï¼š`ma20`, `rsi`, `macd_dif`
- `stock.py` / `crypto.py` è®€å–å¤§å¯«æ¬„ä½åï¼š`MA20`, `RSI`, `MACD_DIF`

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
# âŒ routers/stock.py ä½¿ç”¨å¤§å¯«
ma20 = float(latest.get('MA20', 0)) if 'MA20' in latest else None
rsi_value = float(latest.get('RSI', 50)) if 'RSI' in latest else 50
macd_dif = float(latest.get('MACD_DIF', 0)) if 'MACD_DIF' in latest else 0
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```python
# âœ… ä½¿ç”¨å°å¯«ï¼Œç¬¦åˆ indicator_service ç”¢ç”Ÿçš„æ¬„ä½å
ma20 = float(latest.get('ma20', 0)) if 'ma20' in latest else None
ma50 = float(latest.get('ma50', 0)) if 'ma50' in latest else None
ma200 = float(latest.get('ma200', 0)) if 'ma200' in latest else None
rsi_value = float(latest.get('rsi', 50)) if 'rsi' in latest else 50
macd_dif = float(latest.get('macd_dif', 0)) if 'macd_dif' in latest else 0
macd_dea = float(latest.get('macd_dea', 0)) if 'macd_dea' in latest else 0
macd_hist = float(latest.get('macd_hist', 0)) if 'macd_hist' in latest else 0
```

**indicator_service.py ç”¢ç”Ÿçš„æ¬„ä½ååƒè€ƒ**ï¼š
```python
df[f"ma{self.ma_short}"]  # ma20
df[f"ma{self.ma_mid}"]    # ma50
df[f"ma{self.ma_long}"]   # ma200
df["rsi"]                  # rsi
df["macd_dif"]            # macd_dif
df["macd_dea"]            # macd_dea
df["macd_hist"]           # macd_hist
df["kd_k"]                # kd_k
df["kd_d"]                # kd_d
```

---

### Bug 5ï¼šæ–¹æ³•åç¨±éŒ¯èª¤

**åŸå› **ï¼šèª¿ç”¨ä¸å­˜åœ¨çš„æ–¹æ³•å

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
# âŒ routers/stock.py
df = yahoo_finance.get_stock_data(symbol, period="1y")  # æ–¹æ³•ä¸å­˜åœ¨

# âŒ routers/crypto.py
df = coingecko.get_historical_data(symbol, days=365)  # æ–¹æ³•ä¸å­˜åœ¨
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```python
# âœ… routers/stock.py - ä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•å
df = yahoo_finance.get_stock_history(symbol, period="1y")

# âœ… routers/crypto.py - ä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•å
df = coingecko.get_ohlc(symbol, days=365)
```

**data_sources å¯ç”¨æ–¹æ³•åƒè€ƒ**ï¼š

| æª”æ¡ˆ | å¯ç”¨æ–¹æ³• |
|------|----------|
| yahoo_finance.py | `get_stock_info()`, `get_stock_history()`, `get_current_price()` |
| coingecko.py | `get_coin_info()`, `get_market_chart()`, `get_ohlc()`, `get_current_price()`, `validate_symbol()` |

---

## Async/Await å•é¡Œ

### Bug 6ï¼šSettings API ç¼ºå°‘ await

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
'coroutine' object has no attribute 'scalar_one_or_none'
```

**åŸå› **ï¼š
- ä½¿ç”¨ `AsyncSession` ä½†æ²’æœ‰ `await` è³‡æ–™åº«æ“ä½œ

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
# âŒ ç¼ºå°‘ await
settings = db.execute(stmt).scalar_one_or_none()
db.commit()
db.refresh(settings)
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```python
# âœ… åŠ ä¸Š await
result = await db.execute(stmt)
settings = result.scalar_one_or_none()
await db.commit()
await db.refresh(settings)
```

---

## éƒ¨ç½²æ³¨æ„äº‹é …

### 1. ç€è¦½å™¨å¿«å–å•é¡Œ

ä¿®æ”¹å‰ç«¯æª”æ¡ˆå¾Œï¼Œç”¨æˆ¶å¯èƒ½çœ‹åˆ°èˆŠç‰ˆæœ¬ã€‚

**è§£æ±ºæ–¹æ³•**ï¼š
- æŒ‰ `Ctrl + Shift + R` å¼·åˆ¶é‡æ–°æ•´ç†
- é–‹å•Ÿç„¡ç—•è¦–çª—æ¸¬è©¦
- åœ¨æª”æ¡ˆååŠ ä¸Šç‰ˆæœ¬è™Ÿï¼š`dashboard.html?v=1.0.1`

### 2. Railway éƒ¨ç½²æª¢æŸ¥

éƒ¨ç½²å¾Œæª¢æŸ¥ log ç¢ºèªï¼š
- å®¹å™¨å•Ÿå‹•æˆåŠŸ
- API ç«¯é»è¿”å› 200 OK
- æ²’æœ‰ 500 éŒ¯èª¤

### 3. API æ¸¬è©¦æ–¹æ³•

ç›´æ¥åœ¨ç€è¦½å™¨æ¸¬è©¦ APIï¼š
```
https://your-domain.railway.app/api/stock/AAPL
https://your-domain.railway.app/api/crypto/BTC
https://your-domain.railway.app/api/market/sentiment
```

### 4. å‰ç«¯ Console èª¿è©¦

æŒ‰ `F12` é–‹å•Ÿé–‹ç™¼è€…å·¥å…·ï¼ŒæŸ¥çœ‹ï¼š
- Console éŒ¯èª¤è¨Šæ¯
- Network è«‹æ±‚ç‹€æ…‹
- API å›æ‡‰å…§å®¹

---

## ä¿®å¾©æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | ä¿®å¾©å…§å®¹ |
|------|----------|
| `static/dashboard.html` | showSection åƒæ•¸ã€API è³‡æ–™æ ¼å¼ |
| `app/routers/stock.py` | æ–¹æ³•åã€æ¬„ä½åå¤§å°å¯« |
| `app/routers/crypto.py` | æ–¹æ³•åã€æ¬„ä½åå¤§å°å¯« |
| `app/routers/settings.py` | async/await å®Œæ•´ç‰ˆ |

---

## å¿«é€Ÿæª¢æŸ¥æ¸…å–®

- [ ] `indicator_service` æ¬„ä½åæ˜¯å°å¯«
- [ ] `routers` è®€å–æ¬„ä½åä¹Ÿç”¨å°å¯«
- [ ] API æ–¹æ³•åèˆ‡ data_sources ä¸€è‡´
- [ ] å‰ç«¯è³‡æ–™æ ¼å¼èˆ‡ API è¿”å›ä¸€è‡´
- [ ] `showSection` ç­‰å‡½æ•¸çš„ event åƒæ•¸å¯é¸
- [ ] AsyncSession çš„æ“ä½œéƒ½æœ‰ await

---

> æ–‡ä»¶ç¶­è­·ï¼šæ¯æ¬¡ä¿®å¾© bug å¾Œæ›´æ–°æ­¤æ–‡ä»¶
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/settings-section.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!-- SELA è¨­å®šé é¢ HTML ç‰‡æ®µ - æ’å…¥åˆ° dashboard.html çš„å…¶ä»– section ä¹‹å¾Œ -->

<section id="section-settings" class="section hidden">
    <div class="max-w-2xl mx-auto p-4">
        
        <div id="settings-loading" class="settings-loading hidden">
            <i class="fas fa-spinner fa-spin"></i>
            <span>è¼‰å…¥è¨­å®šä¸­...</span>
        </div>
        
        <div id="settings-content">
            
            <!-- ç”¨æˆ¶è³‡è¨Š -->
            <div class="user-info-card">
                <div class="flex items-center gap-4">
                    <img id="settings-user-avatar" src="" alt="é ­åƒ" class="user-avatar"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23666%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22>ğŸ‘¤</text></svg>'">
                    <div>
                        <div class="user-name" id="settings-user-name">è¼‰å…¥ä¸­...</div>
                        <div class="user-level">
                            <i class="fas fa-crown text-yellow-400"></i>
                            <span id="settings-user-level">å…è²»æœƒå“¡</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¿«é€Ÿæ¨¡æ¿ -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="fas fa-palette text-orange-500"></i>
                    <h3>å¿«é€Ÿæ¨¡æ¿</h3>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="applyTemplate('minimal')" class="template-btn" data-template="minimal">
                        <i class="fas fa-feather-alt"></i><span>æ¥µç°¡</span>
                    </button>
                    <button onclick="applyTemplate('standard')" class="template-btn" data-template="standard">
                        <i class="fas fa-balance-scale"></i><span>æ¨™æº–</span>
                    </button>
                    <button onclick="applyTemplate('full')" class="template-btn" data-template="full">
                        <i class="fas fa-layer-group"></i><span>å®Œæ•´</span>
                    </button>
                    <button onclick="applyTemplate('short_term')" class="template-btn" data-template="short_term">
                        <i class="fas fa-bolt"></i><span>çŸ­ç·š</span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-3 text-center">é¸æ“‡é è¨­çµ„åˆï¼Œå¿«é€Ÿå¥—ç”¨æŒ‡æ¨™å’Œé€šçŸ¥è¨­å®š</p>
            </div>
            
            <!-- æŒ‡æ¨™é¡¯ç¤º -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="fas fa-chart-line text-blue-500"></i>
                    <h3>æŒ‡æ¨™é¡¯ç¤º</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="indicators-grid"></div>
            </div>
            
            <!-- é€šçŸ¥è¨­å®š -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="fas fa-bell text-yellow-500"></i>
                    <h3>é€šçŸ¥è¨­å®š</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="alerts-grid"></div>
                <p class="text-xs text-gray-500 mt-3"><i class="fas fa-info-circle mr-1"></i>é–‹å•Ÿçš„é€šçŸ¥å°‡é€é LINE æ¨æ’­</p>
            </div>
            
            <!-- é€²éšåƒæ•¸ -->
            <div class="settings-card" style="padding: 0; overflow: hidden;">
                <button onclick="toggleParamsPanel()" class="collapse-header">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-sliders-h text-purple-500"></i>
                        <h3 class="text-base font-bold text-gray-800">é€²éšåƒæ•¸</h3>
                    </div>
                    <i class="fas fa-chevron-down collapse-arrow" id="params-collapse-arrow"></i>
                </button>
                
                <div id="params-collapse-content" class="collapse-content">
                    <div class="collapse-content-inner pt-4">
                        
                        <!-- å‡ç·šåƒæ•¸ -->
                        <div class="mb-5">
                            <div class="param-section-title"><i class="fas fa-wave-square text-blue-500"></i>å‡ç·šé€±æœŸ</div>
                            <div class="grid grid-cols-3 gap-3">
                                <div><label class="param-label">çŸ­æœŸ</label><input type="number" id="param-ma_short" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">ä¸­æœŸ</label><input type="number" id="param-ma_mid" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">é•·æœŸ</label><input type="number" id="param-ma_long" class="param-input" onchange="onParamChange()"></div>
                            </div>
                        </div>
                        
                        <!-- RSI åƒæ•¸ -->
                        <div class="mb-5">
                            <div class="param-section-title"><i class="fas fa-tachometer-alt text-green-500"></i>RSI åƒæ•¸</div>
                            <div class="grid grid-cols-3 gap-3">
                                <div><label class="param-label">é€±æœŸ</label><input type="number" id="param-rsi_period" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">è¶…è²·</label><input type="number" id="param-rsi_overbought" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">è¶…è³£</label><input type="number" id="param-rsi_oversold" class="param-input" onchange="onParamChange()"></div>
                            </div>
                        </div>
                        
                        <!-- MACD åƒæ•¸ -->
                        <div class="mb-5">
                            <div class="param-section-title"><i class="fas fa-signal text-purple-500"></i>MACD åƒæ•¸</div>
                            <div class="grid grid-cols-3 gap-3">
                                <div><label class="param-label">å¿«ç·š</label><input type="number" id="param-macd_fast" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">æ…¢ç·š</label><input type="number" id="param-macd_slow" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">è¨Šè™Ÿ</label><input type="number" id="param-macd_signal" class="param-input" onchange="onParamChange()"></div>
                            </div>
                        </div>
                        
                        <!-- å…¶ä»–åƒæ•¸ -->
                        <div>
                            <div class="param-section-title"><i class="fas fa-cog text-gray-500"></i>å…¶ä»–åƒæ•¸</div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="param-label">KD é€±æœŸ</label><input type="number" id="param-kd_period" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">å¸ƒæ—é€±æœŸ</label><input type="number" id="param-bollinger_period" class="param-input" onchange="onParamChange()"></div>
                                <div><label class="param-label">çªç ´é–€æª»(%)</label><input type="number" id="param-breakout_threshold" class="param-input" step="0.1" onchange="onParamChange()"></div>
                                <div><label class="param-label">é‡æ¯”å€æ•¸</label><input type="number" id="param-volume_alert_ratio" class="param-input" step="0.1" onchange="onParamChange()"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å„²å­˜æŒ‰éˆ• -->
            <button onclick="saveAllSettings()" id="settings-save-btn" class="save-btn">
                <i class="fas fa-save"></i>å„²å­˜è¨­å®š
            </button>
            
            <div id="settings-message" class="settings-message hidden"></div>
            
            <div class="text-center text-xs text-gray-400 mt-6">SELA è‡ªå‹•é¸è‚¡ç³»çµ± v0.9.1</div>
        </div>
    </div>
</section>
```

======================================================================
## ğŸ“ å…¶ä»–æª”æ¡ˆ
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/__init__.py  â­
> Stock Analysis System
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Stock Analysis System
å¤šç”¨æˆ¶è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°
"""
__version__ = "0.1.0"
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/cli.py  â­
> è‚¡ç¥¨åˆ†æç³»çµ± CLI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
#!/usr/bin/env python3
"""
è‚¡ç¥¨åˆ†æç³»çµ± CLI
å‘½ä»¤åˆ—æŸ¥è©¢ä»‹é¢
"""
import sys
import argparse
from datetime import datetime
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.text import Text
from rich import box

from app.database import init_db_sync, get_sync_session
from app.services.stock_service import StockService
from app.services.crypto_service import CryptoService
from app.services.chart_service import chart_service
from app.data_sources.coingecko import CRYPTO_MAP
from app.config import settings

console = Console()

# æ”¯æ´çš„åŠ å¯†è²¨å¹£ä»£è™Ÿ
SUPPORTED_CRYPTO = set(k for k in CRYPTO_MAP.keys() if k not in ("BITCOIN", "ETHEREUM"))


def print_header():
    """é¡¯ç¤ºæ¨™é¡Œ"""
    console.print()
    console.print(Panel.fit(
        "[bold orange1]ğŸ“ˆ è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ±[/bold orange1]\n"
        f"[dim]ç‰ˆæœ¬ {settings.APP_VERSION}[/dim]",
        border_style="orange1",
    ))
    console.print()


def is_crypto(symbol: str) -> bool:
    """åˆ¤æ–·æ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£"""
    return symbol.upper() in SUPPORTED_CRYPTO


def print_stock_analysis(analysis: dict):
    """é¡¯ç¤ºè‚¡ç¥¨åˆ†æå ±å‘Š"""
    symbol = analysis["symbol"]
    name = analysis["name"]
    price_info = analysis["price"]
    change_info = analysis["change"]
    volume_info = analysis.get("volume", {})
    indicators = analysis["indicators"]
    signals = analysis["signals"]
    score = analysis["score"]
    
    # æ¨™é¡Œ
    console.print(Panel(
        f"[bold]{symbol}[/bold] - {name}",
        border_style="blue",
    ))
    
    # åƒ¹æ ¼è³‡è¨Š
    price_table = Table(title="ğŸ’° åƒ¹æ ¼è³‡è¨Š", box=box.ROUNDED, show_header=False)
    price_table.add_column("é …ç›®", style="cyan")
    price_table.add_column("æ•¸å€¼", justify="right")
    
    current_price = price_info["current"]
    price_table.add_row("ç¾åƒ¹", f"[bold green]${current_price:,.2f}[/bold green]")
    
    if price_info.get("high_52w"):
        price_table.add_row("52é€±æœ€é«˜", f"${price_info['high_52w']:,.2f}")
    if price_info.get("low_52w"):
        price_table.add_row("52é€±æœ€ä½", f"${price_info['low_52w']:,.2f}")
    if price_info.get("from_high_pct"):
        pct = price_info["from_high_pct"]
        color = "red" if pct < 0 else "green"
        price_table.add_row("è·é«˜é»", f"[{color}]{pct:+.2f}%[/{color}]")
    if price_info.get("from_low_pct"):
        pct = price_info["from_low_pct"]
        color = "green" if pct > 0 else "red"
        price_table.add_row("è·ä½é»", f"[{color}]{pct:+.2f}%[/{color}]")
    
    console.print(price_table)
    console.print()
    
    # æ¼²è·Œå¹…
    change_table = Table(title="ğŸ“Š æ¼²è·Œå¹…", box=box.ROUNDED)
    change_table.add_column("æ—¥", justify="center")
    change_table.add_column("é€±", justify="center")
    change_table.add_column("æœˆ", justify="center")
    change_table.add_column("å­£", justify="center")
    change_table.add_column("å¹´", justify="center")
    
    def format_change(val):
        if val is None:
            return "-"
        color = "green" if val >= 0 else "red"
        return f"[{color}]{val:+.2f}%[/{color}]"
    
    change_table.add_row(
        format_change(change_info.get("day")),
        format_change(change_info.get("week")),
        format_change(change_info.get("month")),
        format_change(change_info.get("quarter")),
        format_change(change_info.get("year")),
    )
    
    console.print(change_table)
    console.print()
    
    # æˆäº¤é‡
    if volume_info:
        vol_table = Table(title="ğŸ“ˆ æˆäº¤é‡", box=box.ROUNDED, show_header=False)
        vol_table.add_column("é …ç›®", style="cyan")
        vol_table.add_column("æ•¸å€¼", justify="right")
        
        vol_table.add_row("ä»Šæ—¥æˆäº¤é‡", f"{volume_info.get('today', 0):,}")
        if volume_info.get("avg_20d"):
            vol_table.add_row("20æ—¥å‡é‡", f"{volume_info['avg_20d']:,}")
        if volume_info.get("ratio"):
            ratio = volume_info["ratio"]
            color = "yellow" if ratio >= 2.0 else ("green" if ratio >= 1.0 else "dim")
            vol_table.add_row("é‡æ¯”", f"[{color}]{ratio:.2f}[/{color}]")
        
        console.print(vol_table)
        console.print()
    
    # æŠ€è¡“æŒ‡æ¨™
    _print_indicators(indicators)
    
    # è¨Šè™Ÿ
    if signals:
        signal_panel = Panel(
            "\n".join([f"â€¢ {s['description']}" for s in signals]),
            title="âš¡ æœ€æ–°è¨Šè™Ÿ",
            border_style="yellow",
        )
        console.print(signal_panel)
        console.print()
    
    # ç¶œåˆè©•åˆ†
    _print_score(score)
    
    # æ›´æ–°æ™‚é–“
    console.print()
    console.print(f"[dim]æ›´æ–°æ™‚é–“: {analysis.get('updated_at', '-')}[/dim]")


def print_crypto_analysis(analysis: dict):
    """é¡¯ç¤ºåŠ å¯†è²¨å¹£åˆ†æå ±å‘Š"""
    symbol = analysis["symbol"]
    name = analysis["name"]
    price_info = analysis["price"]
    change_info = analysis["change"]
    market_info = analysis.get("market", {})
    indicators = analysis["indicators"]
    signals = analysis["signals"]
    score = analysis["score"]
    
    # æ¨™é¡Œ
    console.print(Panel(
        f"[bold]{symbol}[/bold] - {name} [dim](åŠ å¯†è²¨å¹£)[/dim]",
        border_style="yellow",
    ))
    
    # åƒ¹æ ¼è³‡è¨Š
    price_table = Table(title="ğŸ’° åƒ¹æ ¼è³‡è¨Š", box=box.ROUNDED, show_header=False)
    price_table.add_column("é …ç›®", style="cyan")
    price_table.add_column("æ•¸å€¼", justify="right")
    
    current_price = price_info["current"]
    if current_price >= 1000:
        price_table.add_row("ç¾åƒ¹", f"[bold green]${current_price:,.2f}[/bold green]")
    else:
        price_table.add_row("ç¾åƒ¹", f"[bold green]${current_price:,.4f}[/bold green]")
    
    if price_info.get("ath"):
        price_table.add_row("æ­·å²æœ€é«˜ (ATH)", f"${price_info['ath']:,.2f}")
    if price_info.get("from_ath_pct"):
        pct = price_info["from_ath_pct"]
        color = "red" if pct < 0 else "green"
        price_table.add_row("è· ATH", f"[{color}]{pct:+.2f}%[/{color}]")
    if price_info.get("high_24h"):
        price_table.add_row("24H æœ€é«˜", f"${price_info['high_24h']:,.2f}")
    if price_info.get("low_24h"):
        price_table.add_row("24H æœ€ä½", f"${price_info['low_24h']:,.2f}")
    
    console.print(price_table)
    console.print()
    
    # å¸‚å ´è³‡è¨Š
    if market_info:
        market_table = Table(title="ğŸŒ å¸‚å ´è³‡è¨Š", box=box.ROUNDED, show_header=False)
        market_table.add_column("é …ç›®", style="cyan")
        market_table.add_column("æ•¸å€¼", justify="right")
        
        if market_info.get("market_cap"):
            market_table.add_row("å¸‚å€¼", f"${market_info['market_cap']:,.0f}")
        if market_info.get("market_cap_rank"):
            market_table.add_row("å¸‚å€¼æ’å", f"#{market_info['market_cap_rank']}")
        if market_info.get("volume_24h"):
            market_table.add_row("24H æˆäº¤é‡", f"${market_info['volume_24h']:,.0f}")
        
        console.print(market_table)
        console.print()
    
    # æ¼²è·Œå¹…
    change_table = Table(title="ğŸ“Š æ¼²è·Œå¹…", box=box.ROUNDED)
    change_table.add_column("24H", justify="center")
    change_table.add_column("7D", justify="center")
    change_table.add_column("30D", justify="center")
    change_table.add_column("1Y", justify="center")
    
    def format_change(val):
        if val is None:
            return "-"
        color = "green" if val >= 0 else "red"
        return f"[{color}]{val:+.2f}%[/{color}]"
    
    change_table.add_row(
        format_change(change_info.get("day")),
        format_change(change_info.get("week")),
        format_change(change_info.get("month")),
        format_change(change_info.get("year")),
    )
    
    console.print(change_table)
    console.print()
    
    # æŠ€è¡“æŒ‡æ¨™
    _print_crypto_indicators(indicators)
    
    # è¨Šè™Ÿ
    if signals:
        signal_panel = Panel(
            "\n".join([f"â€¢ {s['description']}" for s in signals]),
            title="âš¡ æœ€æ–°è¨Šè™Ÿ",
            border_style="yellow",
        )
        console.print(signal_panel)
        console.print()
    
    # ç¶œåˆè©•åˆ†
    _print_score(score)
    
    # æ›´æ–°æ™‚é–“
    console.print()
    console.print(f"[dim]æ›´æ–°æ™‚é–“: {analysis.get('updated_at', '-')}[/dim]")


def _print_indicators(indicators: dict):
    """åˆ—å°æŠ€è¡“æŒ‡æ¨™ï¼ˆè‚¡ç¥¨ç‰ˆï¼‰"""
    ind_table = Table(title="ğŸ“ æŠ€è¡“æŒ‡æ¨™", box=box.ROUNDED)
    ind_table.add_column("æŒ‡æ¨™", style="cyan")
    ind_table.add_column("æ•¸å€¼", justify="right")
    ind_table.add_column("ç‹€æ…‹", justify="center")
    
    # MA
    ma = indicators.get("ma", {})
    alignment = ma.get("alignment", "neutral")
    alignment_text = {
        "bullish": "[green]å¤šé ­æ’åˆ—[/green]",
        "bearish": "[red]ç©ºé ­æ’åˆ—[/red]",
        "neutral": "[yellow]ç›¤æ•´[/yellow]",
    }.get(alignment, alignment)
    
    for ma_key in [f"ma{settings.MA_SHORT}", f"ma{settings.MA_MID}", f"ma{settings.MA_LONG}"]:
        val = ma.get(ma_key)
        pos = ma.get(f"price_vs_{ma_key}")
        pos_text = "[green]â–²[/green]" if pos == "above" else "[red]â–¼[/red]" if pos == "below" else ""
        ind_table.add_row(
            ma_key.upper(),
            f"${val:,.2f}" if val else "-",
            pos_text,
        )
    
    ind_table.add_row("æ’åˆ—", "", alignment_text)
    
    # RSI
    rsi = indicators.get("rsi", {})
    rsi_val = rsi.get("value")
    rsi_status = rsi.get("status", "")
    rsi_color = "red" if rsi_status == "overbought" else "green" if rsi_status == "oversold" else "white"
    rsi_status_text = {
        "overbought": "[red]è¶…è²·[/red]",
        "oversold": "[green]è¶…è³£[/green]",
        "neutral": "ä¸­æ€§",
    }.get(rsi_status, rsi_status)
    
    ind_table.add_row(
        "RSI",
        f"[{rsi_color}]{rsi_val:.1f}[/{rsi_color}]" if rsi_val else "-",
        rsi_status_text,
    )
    
    # MACD
    macd = indicators.get("macd", {})
    macd_hist = macd.get("histogram")
    macd_status = macd.get("status", "")
    macd_color = "green" if macd_status == "bullish" else "red"
    
    ind_table.add_row(
        "MACD æŸ±",
        f"[{macd_color}]{macd_hist:.4f}[/{macd_color}]" if macd_hist is not None else "-",
        f"[{macd_color}]{'å¤š' if macd_status == 'bullish' else 'ç©º'}[/{macd_color}]",
    )
    
    # Bollinger
    bb = indicators.get("bollinger", {})
    bb_pos = bb.get("position", "")
    bb_pos_text = {
        "above_upper": "[red]è¶…å‡ºä¸Šè»Œ[/red]",
        "below_lower": "[green]è·Œç ´ä¸‹è»Œ[/green]",
        "upper_half": "é€šé“ä¸ŠåŠ",
        "lower_half": "é€šé“ä¸‹åŠ",
    }.get(bb_pos, bb_pos)
    
    ind_table.add_row(
        "å¸ƒæ—",
        f"â†‘{bb.get('upper'):.2f} â†“{bb.get('lower'):.2f}" if bb.get("upper") else "-",
        bb_pos_text,
    )
    
    console.print(ind_table)
    console.print()


def _print_crypto_indicators(indicators: dict):
    """åˆ—å°æŠ€è¡“æŒ‡æ¨™ï¼ˆåŠ å¯†è²¨å¹£ç‰ˆï¼‰"""
    ind_table = Table(title="ğŸ“ æŠ€è¡“æŒ‡æ¨™", box=box.ROUNDED)
    ind_table.add_column("æŒ‡æ¨™", style="cyan")
    ind_table.add_column("æ•¸å€¼", justify="right")
    ind_table.add_column("ç‹€æ…‹", justify="center")
    
    # MAï¼ˆå¹£åœˆé€±æœŸï¼‰
    ma = indicators.get("ma", {})
    alignment = ma.get("alignment", "neutral")
    alignment_text = {
        "bullish": "[green]å¤šé ­æ’åˆ—[/green]",
        "bearish": "[red]ç©ºé ­æ’åˆ—[/red]",
        "neutral": "[yellow]ç›¤æ•´[/yellow]",
    }.get(alignment, alignment)
    
    for ma_key in ["ma7", "ma25", "ma99"]:
        val = ma.get(ma_key)
        ind_table.add_row(
            ma_key.upper(),
            f"${val:,.2f}" if val else "-",
            "",
        )
    
    ind_table.add_row("æ’åˆ—", "", alignment_text)
    
    # RSI
    rsi = indicators.get("rsi", {})
    rsi_val = rsi.get("value")
    rsi_status = rsi.get("status", "")
    rsi_color = "red" if rsi_status == "overbought" else "green" if rsi_status == "oversold" else "white"
    rsi_status_text = {
        "overbought": "[red]è¶…è²·[/red]",
        "oversold": "[green]è¶…è³£[/green]",
        "neutral": "ä¸­æ€§",
    }.get(rsi_status, rsi_status)
    
    ind_table.add_row(
        "RSI",
        f"[{rsi_color}]{rsi_val:.1f}[/{rsi_color}]" if rsi_val else "-",
        rsi_status_text,
    )
    
    # MACD
    macd = indicators.get("macd", {})
    macd_hist = macd.get("histogram")
    macd_status = macd.get("status", "")
    macd_color = "green" if macd_status == "bullish" else "red"
    
    ind_table.add_row(
        "MACD",
        f"[{macd_color}]{macd_hist:.2f}[/{macd_color}]" if macd_hist is not None else "-",
        f"[{macd_color}]{'å¤š' if macd_status == 'bullish' else 'ç©º'}[/{macd_color}]",
    )
    
    console.print(ind_table)
    console.print()


def _print_score(score: dict):
    """åˆ—å°ç¶œåˆè©•åˆ†"""
    buy_score = score.get("buy_score", 0)
    sell_score = score.get("sell_score", 0)
    rating = score.get("rating", "neutral")
    details = score.get("details", [])
    
    rating_text = {
        "strong_buy": "[bold green]å¼·çƒˆè²·é€² â­â­â­â­â­[/bold green]",
        "buy": "[green]è²·é€² â­â­â­â­[/green]",
        "neutral": "[yellow]ä¸­æ€§ â­â­â­[/yellow]",
        "sell": "[red]è³£å‡º â­â­[/red]",
        "strong_sell": "[bold red]å¼·çƒˆè³£å‡º â­[/bold red]",
        "insufficient_data": "[dim]è³‡æ–™ä¸è¶³[/dim]",
    }.get(rating, rating)
    
    score_content = f"è²·é€²è¨Šè™Ÿ: {buy_score} / è³£å‡ºè¨Šè™Ÿ: {sell_score}\n"
    score_content += f"ç¶œåˆè©•ç­‰: {rating_text}\n\n"
    if details:
        score_content += "\n".join(details)
    
    console.print(Panel(
        score_content,
        title="ğŸ¯ ç¶œåˆè©•åˆ†",
        border_style="magenta",
    ))


def print_sentiment(sentiment: dict):
    """é¡¯ç¤ºå¸‚å ´æƒ…ç·’"""
    console.print(Panel.fit(
        "[bold]ğŸ“Š å¸‚å ´æƒ…ç·’æŒ‡æ•¸[/bold]",
        border_style="cyan",
    ))
    
    sent_table = Table(box=box.ROUNDED)
    sent_table.add_column("å¸‚å ´", style="cyan")
    sent_table.add_column("æŒ‡æ•¸", justify="center")
    sent_table.add_column("ç‹€æ…‹", justify="center")
    sent_table.add_column("å»ºè­°", justify="left")
    
    from app.data_sources.fear_greed import fear_greed as fg_client
    
    for market, data in sentiment.items():
        if not data:
            continue
        
        value = data.get("value", 0)
        classification_zh = data.get("classification_zh", "")
        
        # æ ¹æ“šæ•¸å€¼æ±ºå®šé¡è‰²
        if value <= 25:
            color = "green"
            emoji = "ğŸ˜±"
        elif value <= 45:
            color = "cyan"
            emoji = "ğŸ˜Ÿ"
        elif value <= 55:
            color = "yellow"
            emoji = "ğŸ˜"
        elif value <= 75:
            color = "orange1"
            emoji = "ğŸ˜Š"
        else:
            color = "red"
            emoji = "ğŸ¤‘"
        
        market_name = "ç¾è‚¡" if market == "stock" else "åŠ å¯†è²¨å¹£"
        advice = fg_client.get_sentiment_advice(value)
        
        sent_table.add_row(
            market_name,
            f"[{color}]{value}[/{color}] {emoji}",
            f"[{color}]{classification_zh}[/{color}]",
            advice[:30] + "..." if len(advice) > 30 else advice,
        )
    
    console.print(sent_table)


def cmd_query(args):
    """æŸ¥è©¢è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£"""
    symbol = args.symbol.upper()
    
    db = get_sync_session()
    try:
        if is_crypto(symbol):
            # åŠ å¯†è²¨å¹£
            with console.status(f"[bold green]æ­£åœ¨åˆ†æ {symbol} (åŠ å¯†è²¨å¹£)..."):
                service = CryptoService(db)
                analysis = service.get_crypto_analysis(symbol, force_refresh=args.refresh)
                
                if analysis is None:
                    console.print(f"[red]âŒ æ‰¾ä¸åˆ°åŠ å¯†è²¨å¹£: {symbol}[/red]")
                    return 1
                
                print_crypto_analysis(analysis)
        else:
            # è‚¡ç¥¨
            with console.status(f"[bold green]æ­£åœ¨åˆ†æ {symbol}..."):
                service = StockService(db)
                analysis = service.get_stock_analysis(symbol, force_refresh=args.refresh)
                
                if analysis is None:
                    console.print(f"[red]âŒ æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}[/red]")
                    return 1
                
                print_stock_analysis(analysis)
        
        return 0
    finally:
        db.close()


def cmd_sentiment(args):
    """æŸ¥è©¢å¸‚å ´æƒ…ç·’"""
    with console.status("[bold green]æ­£åœ¨å–å¾—å¸‚å ´æƒ…ç·’..."):
        db = get_sync_session()
        try:
            service = CryptoService(db)
            sentiment = service.get_market_sentiment("all")
            
            if not sentiment:
                console.print("[yellow]âš ï¸ ç„¡æ³•å–å¾—å¸‚å ´æƒ…ç·’è³‡æ–™[/yellow]")
                return 1
            
            print_sentiment(sentiment)
            return 0
        finally:
            db.close()


def cmd_chart(args):
    """ç”Ÿæˆåœ–è¡¨"""
    symbol = args.symbol.upper()
    
    db = get_sync_session()
    try:
        if is_crypto(symbol):
            service = CryptoService(db)
            with console.status(f"[bold green]æ­£åœ¨ç”Ÿæˆ {symbol} åœ–è¡¨..."):
                df = service.get_crypto_data(symbol)
        else:
            service = StockService(db)
            with console.status(f"[bold green]æ­£åœ¨ç”Ÿæˆ {symbol} åœ–è¡¨..."):
                df = service.get_stock_data(symbol)
        
        if df is None:
            console.print(f"[red]âŒ ç„¡æ³•å–å¾—è³‡æ–™: {symbol}[/red]")
            return 1
        
        # ç”Ÿæˆåœ–è¡¨
        chart_path = chart_service.plot_stock_analysis(
            df,
            symbol,
            days=args.days,
            show_kd=args.kd,
        )
        
        console.print(f"[green]âœ… åœ–è¡¨å·²å„²å­˜: {chart_path}[/green]")
        return 0
        
    finally:
        db.close()


def cmd_refresh(args):
    """æ›´æ–°è³‡æ–™"""
    symbol = args.symbol.upper()
    
    db = get_sync_session()
    try:
        if is_crypto(symbol):
            with console.status(f"[bold green]æ­£åœ¨æ›´æ–° {symbol}..."):
                service = CryptoService(db)
                success = service.fetch_and_cache_crypto(symbol)
        else:
            with console.status(f"[bold green]æ­£åœ¨æ›´æ–° {symbol}..."):
                service = StockService(db)
                success = service.fetch_and_cache_stock(symbol)
        
        if success:
            console.print(f"[green]âœ… å·²æ›´æ–° {symbol} è³‡æ–™[/green]")
            return 0
        else:
            console.print(f"[red]âŒ æ›´æ–°å¤±æ•—: {symbol}[/red]")
            return 1
    finally:
        db.close()


def cmd_init(args):
    """åˆå§‹åŒ–è³‡æ–™åº«"""
    with console.status("[bold green]æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«..."):
        init_db_sync()
    console.print("[green]âœ… è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ[/green]")
    return 0


def main():
    """ä¸»ç¨‹å¼"""
    parser = argparse.ArgumentParser(
        description="è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ±",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    
    subparsers = parser.add_subparsers(dest="command", help="å¯ç”¨æŒ‡ä»¤")
    
    # init æŒ‡ä»¤
    init_parser = subparsers.add_parser("init", help="åˆå§‹åŒ–è³‡æ–™åº«")
    init_parser.set_defaults(func=cmd_init)
    
    # query æŒ‡ä»¤
    query_parser = subparsers.add_parser("query", help="æŸ¥è©¢è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£")
    query_parser.add_argument("symbol", help="ä»£è™Ÿ (è‚¡ç¥¨å¦‚ AAPL, åŠ å¯†è²¨å¹£å¦‚ BTC)")
    query_parser.add_argument("-r", "--refresh", action="store_true", help="å¼·åˆ¶æ›´æ–°è³‡æ–™")
    query_parser.set_defaults(func=cmd_query)
    
    # sentiment æŒ‡ä»¤
    sentiment_parser = subparsers.add_parser("sentiment", help="æŸ¥è©¢å¸‚å ´æƒ…ç·’")
    sentiment_parser.set_defaults(func=cmd_sentiment)
    
    # chart æŒ‡ä»¤
    chart_parser = subparsers.add_parser("chart", help="ç”ŸæˆæŠ€è¡“åˆ†æåœ–è¡¨")
    chart_parser.add_argument("symbol", help="ä»£è™Ÿ")
    chart_parser.add_argument("-d", "--days", type=int, default=120, help="é¡¯ç¤ºå¤©æ•¸ (é è¨­ 120)")
    chart_parser.add_argument("--kd", action="store_true", help="é¡¯ç¤º KD æŒ‡æ¨™")
    chart_parser.set_defaults(func=cmd_chart)
    
    # refresh æŒ‡ä»¤
    refresh_parser = subparsers.add_parser("refresh", help="æ›´æ–°è³‡æ–™")
    refresh_parser.add_argument("symbol", help="ä»£è™Ÿ")
    refresh_parser.set_defaults(func=cmd_refresh)
    
    # è§£æåƒæ•¸
    args = parser.parse_args()
    
    print_header()
    
    if not args.command:
        # äº’å‹•æ¨¡å¼
        console.print("[cyan]è¼¸å…¥ä»£è™Ÿé€²è¡ŒæŸ¥è©¢ (è‚¡ç¥¨å¦‚ AAPLï¼ŒåŠ å¯†è²¨å¹£å¦‚ BTC)[/cyan]")
        console.print("[cyan]è¼¸å…¥ 'sentiment' æŸ¥çœ‹å¸‚å ´æƒ…ç·’ï¼Œ'q' é›¢é–‹[/cyan]")
        console.print()
        
        init_db_sync()
        db = get_sync_session()
        stock_service = StockService(db)
        crypto_service = CryptoService(db)
        
        try:
            while True:
                try:
                    user_input = console.input("[bold]ä»£è™Ÿ> [/bold]").strip().upper()
                    
                    if user_input in ("Q", "QUIT", "EXIT"):
                        console.print("[yellow]å†è¦‹ï¼[/yellow]")
                        break
                    
                    if not user_input:
                        continue
                    
                    if user_input == "SENTIMENT":
                        sentiment = crypto_service.get_market_sentiment("all")
                        if sentiment:
                            print_sentiment(sentiment)
                        else:
                            console.print("[yellow]âš ï¸ ç„¡æ³•å–å¾—å¸‚å ´æƒ…ç·’[/yellow]")
                        console.print()
                        continue
                    
                    # æŸ¥è©¢è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£
                    if is_crypto(user_input):
                        with console.status(f"[bold green]æ­£åœ¨åˆ†æ {user_input}..."):
                            analysis = crypto_service.get_crypto_analysis(user_input)
                        if analysis:
                            print_crypto_analysis(analysis)
                        else:
                            console.print(f"[red]âŒ æ‰¾ä¸åˆ°: {user_input}[/red]")
                    else:
                        with console.status(f"[bold green]æ­£åœ¨åˆ†æ {user_input}..."):
                            analysis = stock_service.get_stock_analysis(user_input)
                        if analysis:
                            print_stock_analysis(analysis)
                        else:
                            console.print(f"[red]âŒ æ‰¾ä¸åˆ°: {user_input}[/red]")
                    
                    console.print()
                    
                except KeyboardInterrupt:
                    console.print("\n[yellow]å†è¦‹ï¼[/yellow]")
                    break
        finally:
            db.close()
        
        return 0
    
    # åŸ·è¡ŒæŒ‡ä»¤
    return args.func(args)


if __name__ == "__main__":
    sys.exit(main())
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/__init__.py  â­
> å¤–éƒ¨è³‡æ–™ä¾†æºæ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¤–éƒ¨è³‡æ–™ä¾†æºæ¨¡çµ„
"""
from app.data_sources.yahoo_finance import yahoo_finance
from app.data_sources.coingecko import coingecko
from app.data_sources.fear_greed import fear_greed

__all__ = [
    "yahoo_finance",
    "coingecko",
    "fear_greed",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/coingecko.py  â­
> CoinGecko API è³‡æ–™ä¾†æº
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
CoinGecko API è³‡æ–™ä¾†æº
æŠ“å–åŠ å¯†è²¨å¹£åƒ¹æ ¼è³‡æ–™
"""
import requests
import pandas as pd
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
import logging
import time

logger = logging.getLogger(__name__)

# CoinGecko API åŸºç¤ URL
BASE_URL = "https://api.coingecko.com/api/v3"

# æ”¯æ´çš„åŠ å¯†è²¨å¹£å°æ‡‰
CRYPTO_MAP = {
    "BTC": "bitcoin",
    "ETH": "ethereum",
    "BITCOIN": "bitcoin",
    "ETHEREUM": "ethereum",
}


class CoinGeckoClient:
    """CoinGecko API å®¢æˆ¶ç«¯"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "Accept": "application/json",
        })
        self._last_request_time = 0
        self._min_request_interval = 1.5  # å…è²» API é™åˆ¶ï¼š~30 æ¬¡/åˆ†é˜
    
    def _rate_limit(self):
        """é€Ÿç‡é™åˆ¶"""
        elapsed = time.time() - self._last_request_time
        if elapsed < self._min_request_interval:
            time.sleep(self._min_request_interval - elapsed)
        self._last_request_time = time.time()
    
    def _get(self, endpoint: str, params: dict = None) -> Optional[Dict]:
        """ç™¼é€ GET è«‹æ±‚"""
        self._rate_limit()
        
        try:
            url = f"{BASE_URL}/{endpoint}"
            logger.info(f"CoinGecko API è«‹æ±‚: {url}")
            response = self.session.get(url, params=params, timeout=15)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.Timeout as e:
            logger.error(f"CoinGecko API è«‹æ±‚è¶…æ™‚: {e}")
            return None
        except requests.exceptions.ConnectionError as e:
            logger.error(f"CoinGecko API é€£ç·šå¤±æ•— (å¯èƒ½è¢«ç¶²è·¯é™åˆ¶): {e}")
            return None
        except requests.exceptions.RequestException as e:
            logger.error(f"CoinGecko API è«‹æ±‚å¤±æ•—: {e}")
            return None
    
    def get_coin_id(self, symbol: str) -> Optional[str]:
        """å°‡ä»£è™Ÿè½‰æ›ç‚º CoinGecko ID"""
        symbol = symbol.upper()
        return CRYPTO_MAP.get(symbol)
    
    def get_current_price(self, symbols: List[str]) -> Optional[Dict[str, Any]]:
        """
        å–å¾—å³æ™‚åƒ¹æ ¼
        
        Args:
            symbols: ä»£è™Ÿåˆ—è¡¨ (å¦‚ ["BTC", "ETH"])
            
        Returns:
            {
                "BTC": {"price": 67850, "change_24h": 2.35, ...},
                "ETH": {"price": 3450, "change_24h": 1.82, ...}
            }
        """
        # è½‰æ›ä»£è™Ÿ
        coin_ids = []
        symbol_map = {}
        for symbol in symbols:
            coin_id = self.get_coin_id(symbol)
            if coin_id:
                coin_ids.append(coin_id)
                symbol_map[coin_id] = symbol.upper()
        
        if not coin_ids:
            return None
        
        params = {
            "ids": ",".join(coin_ids),
            "vs_currencies": "usd",
            "include_24hr_change": "true",
            "include_24hr_vol": "true",
            "include_market_cap": "true",
        }
        
        data = self._get("simple/price", params)
        if not data:
            return None
        
        result = {}
        for coin_id, values in data.items():
            symbol = symbol_map.get(coin_id, coin_id.upper())
            result[symbol] = {
                "price": values.get("usd"),
                "change_24h": values.get("usd_24h_change"),
                "volume_24h": values.get("usd_24h_vol"),
                "market_cap": values.get("usd_market_cap"),
            }
        
        return result
    
    def get_coin_info(self, symbol: str) -> Optional[Dict[str, Any]]:
        """
        å–å¾—åŠ å¯†è²¨å¹£è©³ç´°è³‡è¨Š
        
        Args:
            symbol: ä»£è™Ÿ (å¦‚ BTC, ETH)
            
        Returns:
            åŒ…å«åƒ¹æ ¼ã€å¸‚å€¼ã€æ­·å²é«˜é»ç­‰è³‡è¨Š
        """
        coin_id = self.get_coin_id(symbol)
        if not coin_id:
            logger.warning(f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}")
            return None
        
        params = {
            "localization": "false",
            "tickers": "false",
            "community_data": "false",
            "developer_data": "false",
        }
        
        data = self._get(f"coins/{coin_id}", params)
        if not data:
            return None
        
        market_data = data.get("market_data", {})
        
        return {
            "symbol": symbol.upper(),
            "name": data.get("name"),
            "current_price": market_data.get("current_price", {}).get("usd"),
            "market_cap": market_data.get("market_cap", {}).get("usd"),
            "market_cap_rank": market_data.get("market_cap_rank"),
            "total_volume": market_data.get("total_volume", {}).get("usd"),
            "high_24h": market_data.get("high_24h", {}).get("usd"),
            "low_24h": market_data.get("low_24h", {}).get("usd"),
            "price_change_24h": market_data.get("price_change_24h"),
            "price_change_percentage_24h": market_data.get("price_change_percentage_24h"),
            "price_change_percentage_7d": market_data.get("price_change_percentage_7d"),
            "price_change_percentage_30d": market_data.get("price_change_percentage_30d"),
            "price_change_percentage_1y": market_data.get("price_change_percentage_1y"),
            "ath": market_data.get("ath", {}).get("usd"),
            "ath_date": market_data.get("ath_date", {}).get("usd"),
            "ath_change_percentage": market_data.get("ath_change_percentage", {}).get("usd"),
            "atl": market_data.get("atl", {}).get("usd"),
            "atl_date": market_data.get("atl_date", {}).get("usd"),
            "circulating_supply": market_data.get("circulating_supply"),
            "total_supply": market_data.get("total_supply"),
            "last_updated": data.get("last_updated"),
        }
    
    def get_market_chart(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾—æ­·å²åƒ¹æ ¼è³‡æ–™
        
        Args:
            symbol: ä»£è™Ÿ (å¦‚ BTC, ETH)
            days: å¤©æ•¸ (æœ€å¤š 365 å¤©ï¼Œå…è²» API é™åˆ¶)
            
        Returns:
            DataFrame with columns: date, price, volume, market_cap
        """
        coin_id = self.get_coin_id(symbol)
        if not coin_id:
            return None
        
        params = {
            "vs_currency": "usd",
            "days": min(days, 365),  # å…è²» API é™åˆ¶
            "interval": "daily",
        }
        
        data = self._get(f"coins/{coin_id}/market_chart", params)
        if not data:
            return None
        
        # è§£æè³‡æ–™
        prices = data.get("prices", [])
        volumes = data.get("total_volumes", [])
        market_caps = data.get("market_caps", [])
        
        if not prices:
            return None
        
        records = []
        for i, (timestamp, price) in enumerate(prices):
            record = {
                "date": datetime.fromtimestamp(timestamp / 1000).date(),
                "price": price,
                "volume_24h": volumes[i][1] if i < len(volumes) else None,
                "market_cap": market_caps[i][1] if i < len(market_caps) else None,
            }
            records.append(record)
        
        df = pd.DataFrame(records)
        df["symbol"] = symbol.upper()
        
        # ç§»é™¤é‡è¤‡æ—¥æœŸï¼ˆä¿ç•™æœ€å¾Œä¸€ç­†ï¼‰
        df = df.drop_duplicates(subset=["date"], keep="last")
        df = df.sort_values("date").reset_index(drop=True)
        
        return df
    
    def get_ohlc(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾— OHLC è³‡æ–™ï¼ˆKç·šè³‡æ–™ï¼‰
        
        Args:
            symbol: ä»£è™Ÿ
            days: å¤©æ•¸ (1/7/14/30/90/180/365/max)
            
        Returns:
            DataFrame with columns: date, open, high, low, close
        """
        coin_id = self.get_coin_id(symbol)
        if not coin_id:
            return None
        
        # CoinGecko OHLC åªæ”¯æ´ç‰¹å®šå¤©æ•¸
        valid_days = [1, 7, 14, 30, 90, 180, 365]
        days = min(valid_days, key=lambda x: abs(x - days))
        
        params = {
            "vs_currency": "usd",
            "days": days,
        }
        
        data = self._get(f"coins/{coin_id}/ohlc", params)
        if not data:
            return None
        
        records = []
        for item in data:
            timestamp, open_p, high, low, close = item
            records.append({
                "date": datetime.fromtimestamp(timestamp / 1000).date(),
                "open": open_p,
                "high": high,
                "low": low,
                "close": close,
            })
        
        df = pd.DataFrame(records)
        df["symbol"] = symbol.upper()
        
        # ç§»é™¤é‡è¤‡æ—¥æœŸ
        df = df.drop_duplicates(subset=["date"], keep="last")
        df = df.sort_values("date").reset_index(drop=True)
        
        return df
    
    def validate_symbol(self, symbol: str) -> bool:
        """é©—è­‰ä»£è™Ÿæ˜¯å¦æ”¯æ´"""
        return self.get_coin_id(symbol) is not None


# å»ºç«‹å…¨åŸŸå®¢æˆ¶ç«¯å¯¦ä¾‹
coingecko = CoinGeckoClient()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/fear_greed.py  â­
> å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™ä¾†æº
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™ä¾†æº
- CNN Fear & Greed Index (ç¾è‚¡)
- Alternative.me (åŠ å¯†è²¨å¹£)
"""
import requests
from datetime import datetime, date
from typing import Optional, Dict, Any, List
import logging
import re

logger = logging.getLogger(__name__)


class FearGreedClient:
    """å¸‚å ´æƒ…ç·’æŒ‡æ•¸å®¢æˆ¶ç«¯"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        })
    
    # ==================== åŠ å¯†è²¨å¹£æƒ…ç·’ (Alternative.me) ====================
    
    def get_crypto_fear_greed(self, limit: int = 1) -> Optional[Dict[str, Any]]:
        """
        å–å¾—åŠ å¯†è²¨å¹£ Fear & Greed æŒ‡æ•¸
        ä¾†æº: Alternative.me
        
        Args:
            limit: å–å¾—å¤©æ•¸ (1 = åªå–ä»Šå¤©)
            
        Returns:
            {
                "value": 45,
                "classification": "fear",
                "classification_zh": "ææ‡¼",
                "timestamp": "2025-01-05",
                "history": [...]  # å¦‚æœ limit > 1
            }
        """
        try:
            url = "https://api.alternative.me/fng/"
            params = {"limit": limit}
            
            response = self.session.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            if not data.get("data"):
                return self._get_fallback_crypto()
            
            latest = data["data"][0]
            value = int(latest["value"])
            
            result = {
                "value": value,
                "classification": latest.get("value_classification", "").lower().replace(" ", "_"),
                "classification_zh": self._get_classification_zh(value),
                "timestamp": datetime.fromtimestamp(int(latest["timestamp"])).strftime("%Y-%m-%d"),
                "market": "crypto",
            }
            
            # å¦‚æœéœ€è¦æ­·å²è³‡æ–™
            if limit > 1:
                result["history"] = [
                    {
                        "value": int(item["value"]),
                        "classification": item.get("value_classification", "").lower().replace(" ", "_"),
                        "timestamp": datetime.fromtimestamp(int(item["timestamp"])).strftime("%Y-%m-%d"),
                    }
                    for item in data["data"]
                ]
            
            return result
            
        except Exception as e:
            logger.error(f"å–å¾—åŠ å¯†è²¨å¹£æƒ…ç·’æŒ‡æ•¸å¤±æ•—: {e}")
            return self._get_fallback_crypto()
    
    def _get_fallback_crypto(self) -> Dict[str, Any]:
        """åŠ å¯†è²¨å¹£æƒ…ç·’çš„å‚™ç”¨å€¼"""
        return {
            "value": 50,
            "classification": "neutral",
            "classification_zh": "ä¸­æ€§",
            "timestamp": date.today().strftime("%Y-%m-%d"),
            "market": "crypto",
            "is_fallback": True,
        }
    
    # ==================== ç¾è‚¡æƒ…ç·’ (CNN Fear & Greed) ====================
    
    def get_stock_fear_greed(self) -> Optional[Dict[str, Any]]:
        """
        å–å¾—ç¾è‚¡ Fear & Greed æŒ‡æ•¸
        ä¾†æº: CNN Business (é€éç¬¬ä¸‰æ–¹ API æˆ–çˆ¬èŸ²)
        
        Returns:
            {
                "value": 55,
                "classification": "neutral",
                "classification_zh": "ä¸­æ€§",
                "timestamp": "2025-01-05",
            }
        """
        # æ–¹æ³• 1: ä½¿ç”¨ CNN çš„éå®˜æ–¹ API
        result = self._get_cnn_fear_greed_api()
        if result:
            return result
        
        # æ–¹æ³• 2: ä½¿ç”¨å‚™ç”¨è³‡æ–™ä¾†æº
        result = self._get_fear_greed_alternative()
        if result:
            return result
        
        logger.warning("ç„¡æ³•å–å¾—ç¾è‚¡æƒ…ç·’æŒ‡æ•¸ï¼Œä½¿ç”¨å‚™ç”¨å€¼")
        # è¿”å›å‚™ç”¨å€¼è€Œé None
        return {
            "value": 50,
            "classification": "neutral",
            "classification_zh": "ä¸­æ€§",
            "timestamp": date.today().strftime("%Y-%m-%d"),
            "market": "stock",
            "is_fallback": True,
        }
    
    def _get_cnn_fear_greed_api(self) -> Optional[Dict[str, Any]]:
        """å¾ CNN API å–å¾— Fear & Greed"""
        try:
            # CNN çš„éå®˜æ–¹ API ç«¯é»
            url = "https://production.dataviz.cnn.io/index/fearandgreed/graphdata"
            
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            if not data.get("fear_and_greed"):
                return None
            
            fg_data = data["fear_and_greed"]
            value = int(round(fg_data.get("score", 0)))
            
            return {
                "value": value,
                "classification": self._get_classification(value),
                "classification_zh": self._get_classification_zh(value),
                "timestamp": date.today().strftime("%Y-%m-%d"),
                "market": "stock",
                "rating": fg_data.get("rating", ""),
            }
            
        except Exception as e:
            logger.debug(f"CNN API å–å¾—å¤±æ•—: {e}")
            return None
    
    def _get_fear_greed_alternative(self) -> Optional[Dict[str, Any]]:
        """å‚™ç”¨æ–¹æ³•ï¼šä½¿ç”¨å…¶ä»–è³‡æ–™ä¾†æº"""
        try:
            # å¯ä»¥ä½¿ç”¨å…¶ä»–å…¬é–‹ API æˆ–çˆ¬èŸ²
            # é€™è£¡æä¾›ä¸€å€‹æ¨¡æ“¬çš„å‚™ç”¨æ–¹æ¡ˆ
            
            # ä¾‹å¦‚å¾ rapidapi æˆ–å…¶ä»–ä¾†æºå–å¾—
            # ç›®å‰è¿”å› Noneï¼Œè¡¨ç¤ºç„¡æ³•å–å¾—
            return None
            
        except Exception as e:
            logger.debug(f"å‚™ç”¨ä¾†æºå–å¾—å¤±æ•—: {e}")
            return None
    
    # ==================== é€šç”¨æ–¹æ³• ====================
    
    def get_all_sentiment(self) -> Dict[str, Any]:
        """
        å–å¾—æ‰€æœ‰å¸‚å ´æƒ…ç·’
        
        Returns:
            {
                "stock": {...},
                "crypto": {...}
            }
        """
        result = {}
        
        # ç¾è‚¡æƒ…ç·’
        stock_sentiment = self.get_stock_fear_greed()
        if stock_sentiment:
            result["stock"] = stock_sentiment
        
        # åŠ å¯†è²¨å¹£æƒ…ç·’
        crypto_sentiment = self.get_crypto_fear_greed()
        if crypto_sentiment:
            result["crypto"] = crypto_sentiment
        
        return result
    
    def _get_classification(self, value: int) -> str:
        """å–å¾—è‹±æ–‡åˆ†é¡"""
        if value <= 25:
            return "extreme_fear"
        elif value <= 45:
            return "fear"
        elif value <= 55:
            return "neutral"
        elif value <= 75:
            return "greed"
        else:
            return "extreme_greed"
    
    def _get_classification_zh(self, value: int) -> str:
        """å–å¾—ä¸­æ–‡åˆ†é¡"""
        if value <= 25:
            return "æ¥µåº¦ææ‡¼"
        elif value <= 45:
            return "ææ‡¼"
        elif value <= 55:
            return "ä¸­æ€§"
        elif value <= 75:
            return "è²ªå©ª"
        else:
            return "æ¥µåº¦è²ªå©ª"
    
    def get_sentiment_advice(self, value: int) -> str:
        """æ ¹æ“šæƒ…ç·’å€¼å–å¾—å»ºè­°"""
        if value <= 25:
            return "å¸‚å ´æ¥µåº¦ææ‡¼ï¼Œå¯èƒ½æ˜¯è²·å…¥æ©Ÿæœƒï¼Œä½†éœ€è¬¹æ…"
        elif value <= 45:
            return "å¸‚å ´åææ‡¼ï¼Œç•™æ„æ½›åœ¨æ©Ÿæœƒ"
        elif value <= 55:
            return "å¸‚å ´ä¸­æ€§ï¼Œè§€æœ›ç‚ºä¸»"
        elif value <= 75:
            return "å¸‚å ´åæ¨‚è§€ï¼Œç•™æ„é¢¨éšª"
        else:
            return "å¸‚å ´æ¥µåº¦è²ªå©ªï¼Œå¯èƒ½æ˜¯ç²åˆ©äº†çµæ™‚æ©Ÿ"
    
    def get_crypto_fear_greed_history(self, days: int = 365) -> List[Dict[str, Any]]:
        """
        å–å¾—åŠ å¯†è²¨å¹£ Fear & Greed æ­·å²è³‡æ–™
        
        Args:
            days: å–å¾—å¤©æ•¸ï¼ˆæœ€å¤š 365 å¤©ï¼‰
            
        Returns:
            æ­·å²è³‡æ–™åˆ—è¡¨
        """
        try:
            url = "https://api.alternative.me/fng/"
            params = {"limit": min(days, 365)}
            
            response = self.session.get(url, params=params, timeout=15)
            response.raise_for_status()
            data = response.json()
            
            if not data.get("data"):
                return []
            
            history = []
            for item in data["data"]:
                value = int(item["value"])
                history.append({
                    "date": datetime.fromtimestamp(int(item["timestamp"])).strftime("%Y-%m-%d"),
                    "value": value,
                    "classification": item.get("value_classification", "").lower().replace(" ", "_"),
                    "classification_zh": self._get_classification_zh(value),
                })
            
            # åè½‰é †åºï¼Œè®“æœ€èˆŠçš„åœ¨å‰é¢
            history.reverse()
            
            return history
            
        except Exception as e:
            logger.error(f"å–å¾—åŠ å¯†è²¨å¹£æƒ…ç·’æ­·å²å¤±æ•—: {e}")
            return []


# å»ºç«‹å…¨åŸŸå®¢æˆ¶ç«¯å¯¦ä¾‹
fear_greed = FearGreedClient()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/taiwan_stocks.py  â­
> å°è‚¡åç¨±å°ç…§è¡¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å°è‚¡åç¨±å°ç…§è¡¨
ç‰ˆæœ¬: 1.0.0
æ—¥æœŸ: 2026-01-12

è§£æ±º Yahoo Finance API è¿”å›çš„å°è‚¡åç¨± UTF-8 ç·¨ç¢¼å•é¡Œ
"""

# å¸¸è¦‹å°è‚¡åç¨±å°ç…§è¡¨ï¼ˆæ­£ç¢º UTF-8 ç·¨ç¢¼ï¼‰
TAIWAN_STOCK_NAMES = {
    # === ETF ===
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "0057": "å¯Œé‚¦æ‘©å°",
    "006205": "å¯Œé‚¦ä¸Šè­‰",
    "006206": "å…ƒå¤§ä¸Šè­‰50",
    "006208": "å¯Œé‚¦å°50",
    "00631L": "å…ƒå¤§å°ç£50æ­£2",
    "00632R": "å…ƒå¤§å°ç£50å1",
    "00635U": "å…ƒå¤§S&Pé»ƒé‡‘",
    "00636": "åœ‹æ³°ä¸­åœ‹A50",
    "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
    "00639": "å¯Œé‚¦æ·±100",
    "00642U": "å…ƒå¤§S&PçŸ³æ²¹",
    "00645": "å¯Œé‚¦æ—¥æœ¬",
    "00646": "å…ƒå¤§S&P500",
    "00647L": "å…ƒå¤§S&P500æ­£2",
    "00648R": "å…ƒå¤§S&P500å1",
    "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
    "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
    "00657": "åœ‹æ³°æ—¥ç¶“225",
    "00661": "å…ƒå¤§æ—¥ç¶“225",
    "00662": "å¯Œé‚¦NASDAQ",
    "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
    "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
    "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
    "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
    "00670L": "å¯Œé‚¦NASDAQæ­£2",
    "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
    "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
    "00677U": "å¯Œé‚¦VIX",
    "00678": "ç¾¤ç›ŠNBIç”ŸæŠ€",
    "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
    "00681R": "å…ƒå¤§ç¾å‚µ20å1",
    "00682U": "å…ƒå¤§ç¾å‚µ20",
    "00683L": "å…ƒå¤§ç¾å‚µå1",
    "00685L": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šæ­£2",
    "00686R": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šå1",
    "00688L": "åœ‹æ³°20å¹´ç¾å‚µæ­£2",
    "00689R": "åœ‹æ³°20å¹´ç¾å‚µå1",
    "00690": "å…†è±è—ç±Œ30",
    "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
    "00693U": "è¡—å£S&Pé»ƒé‡‘",
    "00696": "å¯Œé‚¦éŠæˆ²å¨›æ¨‚",
    "00700": "å¯Œé‚¦æ–°èˆˆåœ‹ä¼",
    "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
    "00703": "å°æ–°MSCIä¸­åœ‹",
    "00706L": "å…ƒå¤§ç¾å…ƒæŒ‡æ•¸æ­£2",
    "00707R": "å…ƒå¤§ç¾å…ƒæŒ‡æ•¸å1",
    "00708L": "å…ƒå¤§æ­æ´²50æ­£2",
    "00709": "å¯Œé‚¦æ­æ´²",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00714": "ç¾¤ç›Šé“ç“Šç¾åœ‹åœ°ç”¢",
    "00715L": "è¡—å£æŠ•ä¿¡å¸ƒè˜­ç‰¹æ­£2",
    "00717": "å¯Œé‚¦ç¾åœ‹ç‰¹åˆ¥è‚¡",
    "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
    "00731": "å¾©è¯å¯Œæ™‚é«˜æ¯ä½æ³¢",
    "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
    "00735": "åœ‹æ³°è‡ºéŸ“ç§‘æŠ€",
    "00736": "åœ‹æ³°æ–°èˆˆå¸‚å ´",
    "00737": "åœ‹æ³°AI+Robo",
    "00738U": "å…ƒå¤§é“ç“Šç™½éŠ€",
    "00739": "å…ƒå¤§MSCI Aè‚¡",
    "00752": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00753L": "ä¸­ä¿¡ä¸­åœ‹50æ­£2",
    "00757": "çµ±ä¸€FANG+",
    "00762": "å…ƒå¤§å…¨çƒAI",
    "00763U": "è¡—å£é“ç“ŠéŠ…",
    "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
    "00771": "å…ƒå¤§USé«˜æ¯ç‰¹åˆ¥è‚¡",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00851": "å°æ–°å…¨çƒAI",
    "00852L": "åœ‹æ³°ç¾åœ‹è²»åŠæ­£2",
    "00853": "çµ±ä¸€MSCIéŸ“åœ‹",
    "00861": "å…ƒå¤§å…¨çƒæœªä¾†é—œéµç§‘æŠ€",
    "00865B": "åœ‹æ³°USçŸ­æœŸå…¬å‚µ",
    "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
    "00876": "å…ƒå¤§å…¨çƒ5G",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00885": "å¯Œé‚¦è¶Šå—",
    "00886": "å…ƒå¤§å…¨çƒé›²ç«¯æœå‹™",
    "00887": "æ°¸è±å°ç£ESG",
    "00888": "æ°¸è±ç¾åœ‹è²»åŠ",
    "00889": "æ°¸è±å°ç£æ™ºèƒ½è»Š",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00896": "ä¸­ä¿¡ç¶ èƒ½é›»å‹•è»Š",
    "00897": "å¯Œé‚¦åŸºå› å…ç–«ç”ŸæŠ€",
    "00898": "åœ‹æ³°åŸºå› å…ç–«é©å‘½",
    "00899": "å¯Œé‚¦ç¾å‚µ20å¹´",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
    "00902": "ä¸­ä¿¡é›»æ± åŠå„²èƒ½",
    "00903": "å¯Œé‚¦å…ƒå®‡å®™",
    "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
    "00905": "FTè‡ºç£Smart",
    "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
    "00908": "å¯Œé‚¦å…¥æ¯REITs+",
    "00909": "åœ‹æ³°æ•¸ä½æ”¯ä»˜æœå‹™",
    "00910": "ç¬¬ä¸€é‡‘å¤ªç©ºè¡›æ˜Ÿ",
    "00911": "å…†è±æ´²éš›åŠå°é«”",
    "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
    "00913": "å…†è±å°ç£æ™¶åœ“è£½é€ ",
    "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
    "00916": "åœ‹æ³°å…¨çƒå“ç‰Œ50",
    "00917": "ä¸­ä¿¡ç‰¹é¸é‡‘è",
    "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00920": "å¯Œé‚¦å…¨çƒéæŠ•ç­‰å‚µ",
    "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
    "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
    "00923": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00926": "å‡±åŸºåŠå°é«”",
    "00927": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00928": "ä¸­ä¿¡ä¸Šæ«ƒESG30",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
    "00931": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
    "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
    "00933": "åœ‹æ³°10Y+é‡‘èå‚µ",
    "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
    "00935": "é‡æ‘å°ç£æ–°ç§‘æŠ€50",
    "00936": "å°æ–°è‡ºç£ICè¨­è¨ˆ",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
    
    # === å¸¸è¦‹å€‹è‚¡ ===
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    "1216": "çµ±ä¸€",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "1402": "é æ±æ–°",
    "1476": "å„’é´»",
    "2002": "ä¸­é‹¼",
    "2105": "æ­£æ–°",
    "2207": "å’Œæ³°è»Š",
    "2227": "è£•æ—¥è»Š",
    "2301": "å…‰å¯¶ç§‘",
    "2303": "è¯é›»",
    "2308": "å°é”é›»",
    "2317": "é´»æµ·",
    "2324": "ä»å¯¶",
    "2327": "åœ‹å·¨",
    "2330": "å°ç©é›»",
    "2337": "æ—ºå®",
    "2344": "è¯é‚¦é›»",
    "2345": "æ™ºé‚¦",
    "2351": "é †å¾·",
    "2353": "å®ç¢",
    "2354": "é´»æº–",
    "2356": "è‹±æ¥­é”",
    "2357": "è¯ç¢©",
    "2360": "è‡´èŒ‚",
    "2376": "æŠ€å˜‰",
    "2377": "å¾®æ˜Ÿ",
    "2379": "ç‘æ˜±",
    "2382": "å»£é”",
    "2383": "å°å…‰é›»",
    "2385": "ç¾¤å…‰",
    "2388": "å¨ç››",
    "2392": "æ­£å´´",
    "2395": "ç ”è¯",
    "2401": "å‡Œé™½",
    "2402": "æ¯…å˜‰",
    "2408": "å—äºç§‘",
    "2409": "å‹é”",
    "2412": "ä¸­è¯é›»",
    "2454": "è¯ç™¼ç§‘",
    "2474": "å¯æˆ",
    "2492": "è¯æ–°ç§‘",
    "2498": "å®é”é›»",
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2610": "è¯èˆª",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2633": "å°ç£é«˜éµ",
    "2801": "å½°éŠ€",
    "2809": "äº¬åŸéŠ€",
    "2812": "å°ä¸­éŠ€",
    "2816": "æ—ºæ—ºä¿",
    "2823": "ä¸­å£½",
    "2834": "è‡ºä¼éŠ€",
    "2838": "è¯é‚¦éŠ€",
    "2845": "é æ±éŠ€",
    "2867": "ä¸‰å•†å£½",
    "2880": "è¯å—é‡‘",
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2886": "å…†è±é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2889": "åœ‹ç¥¨é‡‘",
    "2890": "æ°¸è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2903": "é ç™¾",
    "2912": "çµ±ä¸€è¶…",
    "3008": "å¤§ç«‹å…‰",
    "3017": "å¥‡é‹",
    "3034": "è¯è© ",
    "3037": "æ¬£èˆˆ",
    "3044": "å¥é¼",
    "3045": "å°ç£å¤§",
    "3231": "ç·¯å‰µ",
    "3443": "å‰µæ„",
    "3481": "ç¾¤å‰µ",
    "3533": "å˜‰æ¾¤",
    "3661": "ä¸–èŠ¯-KY",
    "3665": "è²¿è¯-KY",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "4904": "é å‚³",
    "4938": "å’Œç¢©",
    "5269": "ç¥¥ç¢©",
    "5347": "ä¸–ç•Œ",
    "5871": "ä¸­ç§Ÿ-KY",
    "5876": "ä¸Šæµ·å•†éŠ€",
    "5880": "åˆåº«é‡‘",
    "6005": "ç¾¤ç›Šè­‰",
    "6116": "å½©æ™¶",
    "6176": "ç‘å„€",
    "6239": "åŠ›æˆ",
    "6269": "å°éƒ¡",
    "6285": "å•Ÿç¢",
    "6409": "æ—­éš¼",
    "6415": "çŸ½åŠ›-KY",
    "6446": "è—¥è¯è—¥",
    "6488": "ç’°çƒæ™¶",
    "6505": "å°å¡‘åŒ–",
    "6515": "ç©å´´",
    "6531": "æ„›æ™®",
    "6533": "æ™¶å¿ƒç§‘",
    "6547": "é«˜ç«¯ç–«è‹—",
    "6552": "æ˜“è¯é›»",
    "6558": "èˆˆèƒ½é«˜",
    "6669": "ç·¯ç©",
    "6670": "å¾©ç››æ‡‰ç”¨",
    "6789": "é‡‡éˆº",
    "8046": "å—é›»",
    "8454": "å¯Œé‚¦åª’",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "9941": "è£•è",
    "9945": "æ½¤æ³°æ–°",
}


def get_taiwan_stock_name(symbol: str) -> str:
    """
    å–å¾—å°è‚¡åç¨±
    
    Args:
        symbol: è‚¡ç¥¨ä»£ç¢¼ (ä¾‹å¦‚ "2330" æˆ– "2330.TW")
    
    Returns:
        è‚¡ç¥¨åç¨±ï¼Œè‹¥æ‰¾ä¸åˆ°å‰‡è¿”å›ä»£ç¢¼æœ¬èº«
    """
    stock_code = symbol.replace('.TW', '').replace('.TWO', '').strip()
    return TAIWAN_STOCK_NAMES.get(stock_code, symbol)


def is_taiwan_stock(symbol: str) -> bool:
    """åˆ¤æ–·æ˜¯å¦ç‚ºå°è‚¡"""
    symbol = symbol.upper().strip()
    
    if symbol.endswith('.TW') or symbol.endswith('.TWO'):
        return True
    
    if symbol.isdigit() and 4 <= len(symbol) <= 6:
        return True
    
    return False
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/yahoo_finance.py  â­
> Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â ÃƒÂ¦Ã‚ÂºÃ‚Â
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â ÃƒÂ¦Ã‚ÂºÃ‚Â
ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ yfinance ÃƒÂ¥Ã‚Â¥Ã¢â‚¬â€ÃƒÂ¤Ã‚Â»Ã‚Â¶ÃƒÂ¦Ã…Â Ã¢â‚¬Å“ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ§Ã‚Â¾Ã…Â½ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
"""
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
import logging

logger = logging.getLogger(__name__)

# ÃƒÂ¥Ã‚Â¸Ã‚Â¸ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¥Ã‚ÂÃ‚Â°ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±ÃƒÂ¥Ã‚Â°Ã‚ÂÃƒÂ§Ã¢â‚¬Â¦Ã‚Â§ÃƒÂ¨Ã‚Â¡Ã‚Â¨
TAIWAN_STOCK_NAMES = {
    # ===== æ¬Šå€¼è‚¡ =====
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    # ===== é‡‘èè‚¡ =====
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    "5876": "ä¸Šæµ·å•†éŠ€",
    # ===== é›»å­è‚¡ =====
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "2351": "é †å¾·",
    "2354": "é´»æº–",
    "2360": "è‡´èŒ‚",
    "2385": "ç¾¤å…‰",
    "2388": "å¨ç››",
    "2392": "æ­£å´´",
    "2401": "å‡Œé™½",
    "2402": "æ¯…å˜‰",
    # ===== èˆªé‹/å‚³ç”¢ =====
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    # ===== ç”ŸæŠ€ =====
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ===== ETF =====
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "0057": "å¯Œé‚¦æ‘©å°",
    "006205": "å¯Œé‚¦ä¸Šè­‰",
    "006206": "å…ƒå¤§ä¸Šè­‰50",
    "006208": "å¯Œé‚¦å°50",
    "00631L": "å…ƒå¤§å°ç£50æ­£2",
    "00632R": "å…ƒå¤§å°ç£50å1",
    "00635U": "å…ƒå¤§S&Pé»ƒé‡‘",
    "00636": "åœ‹æ³°ä¸­åœ‹A50",
    "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
    "00639": "å¯Œé‚¦æ·±100",
    "00642U": "å…ƒå¤§S&PçŸ³æ²¹",
    "00645": "å¯Œé‚¦æ—¥æœ¬",
    "00646": "å…ƒå¤§S&P500",
    "00647L": "å…ƒå¤§S&P500æ­£2",
    "00648R": "å…ƒå¤§S&P500å1",
    "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
    "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
    "00657": "åœ‹æ³°æ—¥ç¶“225",
    "00661": "å…ƒå¤§æ—¥ç¶“225",
    "00662": "å¯Œé‚¦NASDAQ",
    "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
    "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
    "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
    "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
    "00670L": "å¯Œé‚¦NASDAQæ­£2",
    "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
    "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
    "00677U": "å¯Œé‚¦VIX",
    "00678": "ç¾¤ç›ŠNBIç”ŸæŠ€",
    "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
    "00681R": "å…ƒå¤§ç¾å‚µ20å1",
    "00682U": "å…ƒå¤§ç¾å‚µ20å¹´",
    "00690": "å…†è±è—ç±Œ30",
    "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
    "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
    "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
    "00757": "çµ±ä¸€FANG+",
    "00762": "å…ƒå¤§å…¨çƒAI",
    "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00851": "å°æ–°å…¨çƒAI",
    "00852L": "åœ‹æ³°ç¾åœ‹è²»åŠæ­£2",
    "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
    "00876": "å…ƒå¤§å…¨çƒ5G",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00885": "å¯Œé‚¦è¶Šå—",
    "00886": "å…ƒå¤§å…¨çƒé›²ç«¯æœå‹™",
    "00887": "æ°¸è±å°ç£ESG",
    "00888": "æ°¸è±ç¾åœ‹è²»åŠ",
    "00889": "æ°¸è±å°ç£æ™ºèƒ½è»Š",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00896": "ä¸­ä¿¡ç¶ èƒ½é›»å‹•è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
    "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
    "00905": "FTè‡ºç£Smart",
    "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
    "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
    "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
    "00916": "åœ‹æ³°å…¨çƒå“ç‰Œ50",
    "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
    "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
    "00923": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
    "00931": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
    "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
    "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
    "00935": "é‡æ‘å°ç£æ–°ç§‘æŠ€50",
    "00936": "å°æ–°è‡ºç£ICè¨­è¨ˆ",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}



class YahooFinanceClient:
    """Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã¢â‚¬Å“Ã‚Â·ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â®Ã‚Â¢ÃƒÂ¦Ã‹â€ Ã‚Â¶ÃƒÂ§Ã‚Â«Ã‚Â¯"""
    
    def __init__(self):
        pass
    
    def get_stock_info(self, symbol: str) -> Optional[Dict[str, Any]]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¥Ã…Â¸Ã‚ÂºÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â 
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸ (ÃƒÂ¥Ã‚Â¦Ã¢â‚¬Å¡ AAPL, TSLA, 2330.TW)
            
        Returns:
            ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â ÃƒÂ¥Ã‚Â­Ã¢â‚¬â€ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¸ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±ÃƒÂ£Ã¢â€šÂ¬Ã‚ÂÃƒÂ¥Ã‚Â¸Ã¢â‚¬Å¡ÃƒÂ¥Ã¢â€šÂ¬Ã‚Â¼ÃƒÂ§Ã‚Â­Ã¢â‚¬Â°
        """
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info or {}
            
            # ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±ÃƒÂ¯Ã‚Â¼Ã…Â¡ÃƒÂ¥Ã¢â‚¬Å¾Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¦Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ longNameÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¶ÃƒÂ¥Ã‚Â¾Ã…â€™ shortName
            name = info.get("longName") or info.get("shortName") or symbol
            
            # ÃƒÂ¥Ã‚Â°Ã‚ÂÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ¥Ã‚ÂÃ‚Â°ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã¢â‚¬Å¾Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¦Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¥Ã…â€œÃ‚Â°ÃƒÂ¦Ã‹Å“Ã‚Â ÃƒÂ¥Ã‚Â°Ã¢â‚¬Å¾ÃƒÂ¨Ã‚Â¡Ã‚Â¨ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±
            if symbol.endswith(".TW") or symbol.endswith(".TWO"):
                # ÃƒÂ¦Ã‚ÂÃ‚ÂÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸ (ÃƒÂ¥Ã…Â½Ã‚Â»ÃƒÂ¦Ã…Â½Ã¢â‚¬Â° .TW ÃƒÂ¦Ã‹â€ Ã¢â‚¬â€œ .TWO)
                stock_code = symbol.replace(".TW", "").replace(".TWO", "")
                # ÃƒÂ¥Ã¢â‚¬Å¾Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¦Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¥Ã…â€œÃ‚Â°ÃƒÂ¦Ã‹Å“Ã‚Â ÃƒÂ¥Ã‚Â°Ã¢â‚¬Å¾ÃƒÂ¨Ã‚Â¡Ã‚Â¨
                if stock_code in TAIWAN_STOCK_NAMES:
                    name = TAIWAN_STOCK_NAMES[stock_code]
                else:
                    # ÃƒÂ¥Ã‹Å“Ã¢â‚¬â€ÃƒÂ¨Ã‚Â©Ã‚Â¦ÃƒÂ¥Ã‚Â¾Ã…Â¾ Yahoo Finance ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚ÂÃ‚Â
                    display_name = info.get("displayName")
                    if display_name:
                        name = display_name
            
            # ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¤Ã‚Â½Ã‚Â¿ info ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚Â®Ã…â€™ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â¹Ã…Â¸ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ÂÃƒÂ¥Ã¢â‚¬ÂºÃ…Â¾ÃƒÂ¥Ã…Â¸Ã‚ÂºÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â 
            return {
                "symbol": info.get("symbol", symbol),
                "name": name,
                "shortName": info.get("shortName", ""),
                "longName": info.get("longName", ""),
                "currency": info.get("currency", "TWD" if symbol.endswith((".TW", ".TWO")) else "USD"),
                "market_cap": info.get("marketCap"),
                "sector": info.get("sector"),
                "industry": info.get("industry"),
                "fifty_two_week_high": info.get("fiftyTwoWeekHigh"),
                "fifty_two_week_low": info.get("fiftyTwoWeekLow"),
            }
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            # ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ¥Ã¢â‚¬Â¡Ã‚ÂºÃƒÂ©Ã…â€™Ã‚Â¯ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã‚Â°Ã‚ÂÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ¥Ã‚ÂÃ‚Â°ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¤Ã‚Â¹Ã…Â¸ÃƒÂ¥Ã‹Å“Ã¢â‚¬â€ÃƒÂ¨Ã‚Â©Ã‚Â¦ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ÂÃƒÂ¥Ã¢â‚¬ÂºÃ…Â¾ÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¥Ã…â€œÃ‚Â°ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±
            if symbol.endswith(".TW") or symbol.endswith(".TWO"):
                stock_code = symbol.replace(".TW", "").replace(".TWO", "")
                name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
                return {
                    "symbol": symbol,
                    "name": name,
                    "shortName": "",
                    "longName": "",
                    "currency": "TWD",
                    "market_cap": None,
                    "sector": None,
                    "industry": None,
                    "fifty_two_week_high": None,
                    "fifty_two_week_low": None,
                }
            return None
    
    def get_stock_history(
        self,
        symbol: str,
        period: str = "1y",
        start: Optional[datetime] = None,
        end: Optional[datetime] = None,
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            period: ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“ (1d, 5d, 1mo, 3mo, 6mo, 1y, 2y, 5y, 10y, ytd, max)
            start: ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Â¹ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¨Ã‹â€ Ã¢â‚¬Â¡ end ÃƒÂ¦Ã‚ÂÃ‚Â­ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¯Ã‚Â¼Ã…â€™period ÃƒÂ¦Ã…â€œÃ†â€™ÃƒÂ¨Ã‚Â¢Ã‚Â«ÃƒÂ¥Ã‚Â¿Ã‚Â½ÃƒÂ§Ã¢â‚¬Â¢Ã‚Â¥ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
            end: ÃƒÂ§Ã‚ÂµÃ‚ÂÃƒÂ¦Ã‚ÂÃ…Â¸ÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â« OHLCV ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrameÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¶ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¯Ã‚Â¼Ã…Â¡
            - close: ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ÃƒÂ§Ã¢â‚¬ÂºÃ‚Â¤ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ©Ã‚Â¡Ã‚Â¯ÃƒÂ§Ã‚Â¤Ã‚ÂºÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
            - adj_close: ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‚Â¾Ã…â€™ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ¥Ã…â€œÃ¢â‚¬â€œÃƒÂ¨Ã‚Â¡Ã‚Â¨ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        """
        try:
            ticker = yf.Ticker(symbol)
            
            # ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼
            if start and end:
                df_raw = ticker.history(start=start, end=end, auto_adjust=False)
            else:
                df_raw = ticker.history(period=period, auto_adjust=False)
            
            if df_raw.empty:
                logger.warning(f"ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¡ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢: {symbol}")
                return None
            
            df_raw = df_raw.reset_index()
            
            # ÃƒÂ¦Ã‚Â¨Ã¢â€Â¢ÃƒÂ¦Ã‚ÂºÃ¢â‚¬â€œÃƒÂ¥Ã…â€™Ã¢â‚¬â€œÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚Â
            date_col = "Date" if "Date" in df_raw.columns else "Datetime"
            
            # ÃƒÂ¥Ã‚Â»Ã‚ÂºÃƒÂ§Ã‚Â«Ã¢â‚¬Â¹ÃƒÂ§Ã‚ÂµÃ‚ÂÃƒÂ¦Ã…Â¾Ã…â€œ DataFrame
            df = pd.DataFrame()
            df["date"] = pd.to_datetime(df_raw[date_col]).dt.date
            df["open"] = df_raw["Open"].values
            df["high"] = df_raw["High"].values
            df["low"] = df_raw["Low"].values
            df["close"] = df_raw["Close"].values
            df["volume"] = df_raw["Volume"].values if "Volume" in df_raw.columns else 0
            
            # ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¤Ã‚Â¸Ã‚Â¦ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
            df = self._detect_and_adjust_splits(df, symbol)
            
            # ÃƒÂ¥Ã…Â Ã‚Â ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¥ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            df["symbol"] = symbol.upper()
            
            return df
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def _detect_and_adjust_splits(self, df: pd.DataFrame, symbol: str) -> pd.DataFrame:
        """
        ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â·ÃƒÂ¥Ã‚Â´Ã¢â‚¬â€œÃƒÂ¤Ã‚Â¸Ã‚Â¦ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã‚ÂÃ‚ÂªÃƒÂ¨Ã¢â€Â¢Ã¢â‚¬Â¢ÃƒÂ§Ã‚ÂÃ¢â‚¬Â ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        
        ÃƒÂ§Ã¢â‚¬Â¢Ã‚Â¶ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã‹â€ Ã‚Â°ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ§Ã‚ÂªÃ‚ÂÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¶ÃƒÂ¤Ã‚Â¸Ã¢â‚¬Â¹ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¨Ã‚Â¶Ã¢â‚¬Â¦ÃƒÂ©Ã‚ÂÃ…Â½ 40%ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã†â€™Ã‚Â½ÃƒÂ¦Ã‹Å“Ã‚Â¯ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°ÃƒÂ¯Ã‚Â¼Ã…â€™
        ÃƒÂ¦Ã…â€œÃ†â€™ÃƒÂ¨Ã¢â‚¬Â¡Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¹Ã¢â‚¬Â¢ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã¢â€šÂ¬Ã¢â‚¬Â¹ÃƒÂ¥Ã‚ÂºÃ‚ÂÃƒÂ¥Ã‹â€ Ã¢â‚¬â€ÃƒÂ©Ã¢â€šÂ¬Ã‚Â£ÃƒÂ§Ã‚ÂºÃ…â€™ÃƒÂ£Ã¢â€šÂ¬Ã¢â‚¬Å¡
        """
        if len(df) < 2:
            df['adj_close'] = df['close'].copy()
            return df
        
        df = df.copy()
        df = df.sort_values('date').reset_index(drop=True)
        
        # ÃƒÂ¨Ã‚Â¨Ã‹â€ ÃƒÂ§Ã‚Â®Ã¢â‚¬â€ÃƒÂ¦Ã‚Â¯Ã‚ÂÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã‚Â¼Ã‚Â²ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¥Ã‚Â¹Ã¢â‚¬Â¦
        df['pct_change'] = df['close'].pct_change()
        
        # ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ©Ã‚Â»Ã…Â¾ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¤Ã‚Â¸Ã¢â‚¬Â¹ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¨Ã‚Â¶Ã¢â‚¬Â¦ÃƒÂ©Ã‚ÂÃ…Â½ 40%ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        split_indices = []
        for i in range(1, len(df)):
            pct = df.loc[i, 'pct_change']
            if pd.notna(pct) and pct < -0.40:
                prev_close = float(df.loc[i-1, 'close'])
                curr_close = float(df.loc[i, 'close'])
                if curr_close > 0:
                    ratio = prev_close / curr_close
                    rounded_ratio = round(ratio)
                    # ÃƒÂ¥Ã‚ÂÃ‚ÂªÃƒÂ¦Ã…â€œÃ¢â‚¬Â°ÃƒÂ¦Ã‚Â¯Ã¢â‚¬ÂÃƒÂ§Ã…Â½Ã¢â‚¬Â¡ÃƒÂ¦Ã…Â½Ã‚Â¥ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ËœÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¦Ã¢â‚¬Â°Ã‚ÂÃƒÂ¨Ã‚ÂªÃ‚ÂÃƒÂ§Ã¢â‚¬Å¡Ã‚ÂºÃƒÂ¦Ã‹Å“Ã‚Â¯ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã‹â€ 2, 3, 4, 5, 10 ÃƒÂ§Ã‚Â­Ã¢â‚¬Â°ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
                    if rounded_ratio >= 2 and abs(ratio - rounded_ratio) < 0.3:
                        split_indices.append({
                            'index': i,
                            'date': df.loc[i, 'date'],
                            'ratio': rounded_ratio,
                            'prev_close': prev_close,
                            'curr_close': curr_close
                        })
                        logger.info(f"{symbol} ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã‹â€ Ã‚Â°ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²: {df.loc[i, 'date']}, ÃƒÂ¦Ã‚Â¯Ã¢â‚¬ÂÃƒÂ§Ã…Â½Ã¢â‚¬Â¡ 1:{rounded_ratio}, ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ {prev_close:.2f} -> ÃƒÂ§Ã‚ÂÃ‚Â¾ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ {curr_close:.2f}")
        
        # ÃƒÂ¥Ã‹â€ Ã‚ÂÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã…â€™Ã¢â‚¬â€œÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‚Â¾Ã…â€™ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼
        df['adj_close'] = df['close'].astype(float)
        
        # ÃƒÂ¥Ã‚Â¾Ã…Â¾ÃƒÂ¦Ã…â€œÃ¢â€šÂ¬ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ËœÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Â¹ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã‚Â¾Ã¢â€šÂ¬ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ§Ã‚Â´Ã‚Â¯ÃƒÂ§Ã‚Â©Ã‚ÂÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â ÃƒÂ¥Ã‚Â­Ã‚ÂÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        if split_indices:
            cumulative_factor = 1.0
            
            for split in reversed(split_indices):
                idx = split['index']
                ratio = split['ratio']
                cumulative_factor *= ratio
                
                # ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ©Ã‚Â»Ã…Â¾ÃƒÂ¤Ã‚Â¹Ã¢â‚¬Â¹ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¦Ã¢â‚¬Â°Ã¢â€šÂ¬ÃƒÂ¦Ã…â€œÃ¢â‚¬Â°ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ close ÃƒÂ©Ã¢â€Â¢Ã‚Â¤ÃƒÂ¤Ã‚Â»Ã‚Â¥ÃƒÂ§Ã‚Â´Ã‚Â¯ÃƒÂ§Ã‚Â©Ã‚ÂÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â ÃƒÂ¥Ã‚Â­Ã‚ÂÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
                df.loc[:idx-1, 'adj_close'] = df.loc[:idx-1, 'close'].astype(float) / cumulative_factor
            
            logger.info(f"{symbol} ÃƒÂ¥Ã‚Â·Ã‚Â²ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ {len(split_indices)} ÃƒÂ¦Ã‚Â¬Ã‚Â¡ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ§Ã‚Â¸Ã‚Â½ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â ÃƒÂ¥Ã‚Â­Ã‚Â: {cumulative_factor}")
        
        # ÃƒÂ§Ã‚Â§Ã‚Â»ÃƒÂ©Ã¢â€Â¢Ã‚Â¤ÃƒÂ¨Ã¢â‚¬Â¡Ã‚Â¨ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚Â
        df = df.drop(columns=['pct_change'], errors='ignore')
        
        return df
    
    def get_current_price(self, symbol: str) -> Optional[Dict[str, Any]]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã‚Â»Ã‚Â¶ÃƒÂ©Ã‚ÂÃ‚Â²ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°ÃƒÂ¥Ã‚Â Ã‚Â±ÃƒÂ¥Ã†â€™Ã‚Â¹
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ§Ã¢â‚¬Â¢Ã‚Â¶ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¥Ã¢â‚¬â„¢Ã…â€™ÃƒÂ¦Ã‚Â¼Ã‚Â²ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¥Ã‚Â­Ã¢â‚¬â€ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¸
        """
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info
            
            if not info:
                return None
            
            # ÃƒÂ¥Ã‹Å“Ã¢â‚¬â€ÃƒÂ¨Ã‚Â©Ã‚Â¦ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼
            current_price = info.get("currentPrice") or info.get("regularMarketPrice")
            previous_close = info.get("previousClose") or info.get("regularMarketPreviousClose")
            
            if not current_price:
                # ÃƒÂ¥Ã‚Â¾Ã…Â¾ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã…â€œÃ¢â€šÂ¬ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â°ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ÃƒÂ§Ã¢â‚¬ÂºÃ‚Â¤ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
                hist = ticker.history(period="5d", auto_adjust=False)
                if not hist.empty:
                    current_price = hist["Close"].iloc[-1]
                    if len(hist) >= 2:
                        previous_close = hist["Close"].iloc[-2]
            
            if not current_price:
                return None
            
            change = current_price - previous_close if previous_close else 0
            change_pct = (change / previous_close * 100) if previous_close else 0
            
            return {
                "symbol": symbol.upper(),
                "price": round(current_price, 2),
                "previous_close": round(previous_close, 2) if previous_close else None,
                "change": round(change, 2),
                "change_pct": round(change_pct, 2),
                "volume": info.get("volume") or info.get("regularMarketVolume"),
            }
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¥Ã‚Â Ã‚Â±ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def validate_symbol(self, symbol: str) -> bool:
        """
        Ã¥Â¿Â«Ã©â‚¬Å¸Ã©Â©â€”Ã¨Â­â€°Ã¨â€šÂ¡Ã§Â¥Â¨Ã¤Â»Â£Ã¨â„¢Å¸Ã¦ËœÂ¯Ã¥ÂÂ¦Ã¦Å“â€°Ã¦â€¢Ë†
        
        Ã¤Â½Â¿Ã§â€Â¨ history API Ã¨â‚¬Å’Ã©ÂÅ¾ infoÃ¯Â¼Å’Ã©â‚¬Å¸Ã¥ÂºÂ¦Ã¥Â¿Â« 5-10 Ã¥â‚¬Â
        
        Args:
            symbol: Ã¨â€šÂ¡Ã§Â¥Â¨Ã¤Â»Â£Ã¨â„¢Å¸
            
        Returns:
            Ã¦ËœÂ¯Ã¥ÂÂ¦Ã§â€šÂºÃ¦Å“â€°Ã¦â€¢Ë†Ã¤Â»Â£Ã¨â„¢Å¸
        """
        try:
            ticker = yf.Ticker(symbol)
            # Ã¥ÂÂªÃ¦Å â€œ 1 Ã¥Â¤Â©Ã¨Â³â€¡Ã¦â€“â„¢Ã¯Â¼Å’Ã¦Â¯â€ info Ã¥Â¿Â«Ã¥Â¾Ë†Ã¥Â¤Å¡
            hist = ticker.history(period="1d")
            return not hist.empty
        except Exception:
            return False
    
    def get_dividends(
        self,
        symbol: str,
        period: str = "10y",
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            period: ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“ (1y, 5y, 10y, max)
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã‚Â¨Ã‹Å“ÃƒÂ©Ã…â€™Ã¢â‚¬Å¾ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrame
        """
        try:
            ticker = yf.Ticker(symbol)
            dividends = ticker.dividends
            
            if dividends.empty:
                logger.info(f"{symbol} ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¡ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã‚Â¨Ã‹Å“ÃƒÂ©Ã…â€™Ã¢â‚¬Å¾")
                return None
            
            # ÃƒÂ¨Ã‚Â½Ã¢â‚¬Â°ÃƒÂ¦Ã‚ÂÃ¢â‚¬ÂºÃƒÂ¦Ã‹â€ Ã‚Â DataFrame
            df = dividends.reset_index()
            df.columns = ["date", "amount"]
            df["date"] = pd.to_datetime(df["date"]).dt.date
            df["symbol"] = symbol.upper()
            
            # ÃƒÂ¦Ã‚Â Ã‚Â¹ÃƒÂ¦Ã¢â‚¬Å“Ã…Â¡ period ÃƒÂ©Ã‚ÂÃ…Â½ÃƒÂ¦Ã‚Â¿Ã‚Â¾
            if period != "max":
                years = int(period.replace("y", ""))
                cutoff_date = datetime.now().date() - timedelta(days=years * 365)
                df = df[df["date"] >= cutoff_date]
            
            return df
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def get_index_data(
        self,
        symbol: str,
        period: str = "10y",
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚Â¸Ã¢â‚¬Å¡ÃƒÂ¥Ã‚Â Ã‚Â´ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
        
        Args:
            symbol: ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸ (^GSPC, ^DJI, ^IXIC)
            period: ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â« OHLCV ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrame
        """
        try:
            ticker = yf.Ticker(symbol)
            df = ticker.history(period=period, auto_adjust=False)
            
            if df.empty:
                logger.warning(f"ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¡ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢: {symbol}")
                return None
            
            # ÃƒÂ©Ã¢â‚¬Â¡Ã‚ÂÃƒÂ¨Ã‚Â¨Ã‚Â­ÃƒÂ§Ã‚Â´Ã‚Â¢ÃƒÂ¥Ã‚Â¼Ã¢â‚¬Â¢
            df = df.reset_index()
            
            # ÃƒÂ¦Ã‚Â¨Ã¢â€Â¢ÃƒÂ¦Ã‚ÂºÃ¢â‚¬â€œÃƒÂ¥Ã…â€™Ã¢â‚¬â€œÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±
            column_mapping = {
                "Date": "date",
                "Datetime": "date",
                "Open": "open",
                "High": "high",
                "Low": "low",
                "Close": "close",
                "Volume": "volume",
            }
            existing_columns = {k: v for k, v in column_mapping.items() if k in df.columns}
            df = df.rename(columns=existing_columns)
            
            # ÃƒÂ§Ã‚Â¢Ã‚ÂºÃƒÂ¤Ã‚Â¿Ã‚ÂÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ¦Ã‹Å“Ã‚Â¯ date ÃƒÂ©Ã‚Â¡Ã…Â¾ÃƒÂ¥Ã…Â¾Ã¢â‚¬Â¹
            df["date"] = pd.to_datetime(df["date"]).dt.date
            
            # ÃƒÂ¨Ã‚Â¨Ã‹â€ ÃƒÂ§Ã‚Â®Ã¢â‚¬â€ÃƒÂ¦Ã‚Â¼Ã‚Â²ÃƒÂ¨Ã‚Â·Ã…â€™
            df["change"] = df["close"].diff()
            df["change_pct"] = df["close"].pct_change() * 100
            
            # ÃƒÂ¥Ã…Â Ã‚Â ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¥ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            df["symbol"] = symbol
            
            # ÃƒÂ¥Ã‚ÂÃ‚ÂªÃƒÂ¤Ã‚Â¿Ã‚ÂÃƒÂ§Ã¢â‚¬Â¢Ã¢â€Â¢ÃƒÂ©Ã…â€œÃ¢â€šÂ¬ÃƒÂ¨Ã‚Â¦Ã‚ÂÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚Â
            keep_columns = ["symbol", "date", "open", "high", "low", "close", "volume", "change", "change_pct"]
            df = df[[c for c in keep_columns if c in df.columns]]
            
            return df
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def get_all_indices(self, period: str = "10y") -> Dict[str, pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã¢â‚¬Â°Ã¢â€šÂ¬ÃƒÂ¦Ã…â€œÃ¢â‚¬Â°ÃƒÂ¤Ã‚Â¸Ã¢â‚¬Â°ÃƒÂ¥Ã‚Â¤Ã‚Â§ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
        
        Returns:
            {symbol: DataFrame}
        """
        indices = ["^GSPC", "^DJI", "^IXIC"]
        result = {}
        
        for symbol in indices:
            df = self.get_index_data(symbol, period)
            if df is not None:
                result[symbol] = df
        
        return result
    
    def get_stock_history_extended(
        self,
        symbol: str,
        years: int = 10,
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¥Ã‚Â»Ã‚Â¶ÃƒÂ¤Ã‚Â¼Ã‚Â¸ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¯ÃƒÂ¦Ã‚ÂÃ‚Â´ÃƒÂ¦Ã¢â‚¬ÂºÃ‚Â´ÃƒÂ©Ã¢â‚¬Â¢Ã‚Â·ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            years: ÃƒÂ¥Ã‚Â¹Ã‚Â´ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ (1, 3, 5, 10)
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â« OHLCV ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrame
        """
        period_map = {
            1: "1y",
            2: "2y",
            3: "3y",  # yfinance ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¯ÃƒÂ¦Ã‚ÂÃ‚Â´ 3yÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ 5y ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¦Ã¢â‚¬ÂºÃ‚Â¿
            5: "5y",
            10: "10y",
        }
        
        period = period_map.get(years, "10y")
        if years == 3:
            period = "5y"  # ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¶ÃƒÂ¥Ã‚Â¾Ã…â€™ÃƒÂ¥Ã…â€œÃ‚Â¨ÃƒÂ§Ã‚Â¨Ã¢â‚¬Â¹ÃƒÂ¥Ã‚Â¼Ã‚ÂÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ©Ã‚ÂÃ…Â½ÃƒÂ¦Ã‚Â¿Ã‚Â¾
        
        df = self.get_stock_history(symbol, period=period)
        
        if df is None:
            return None
        
        # ÃƒÂ¥Ã‚Â¦Ã¢â‚¬Å¡ÃƒÂ¦Ã…Â¾Ã…â€œÃƒÂ¦Ã‹Å“Ã‚Â¯ 3 ÃƒÂ¥Ã‚Â¹Ã‚Â´ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ©Ã…â€œÃ¢â€šÂ¬ÃƒÂ¨Ã‚Â¦Ã‚ÂÃƒÂ©Ã‚ÂÃ…Â½ÃƒÂ¦Ã‚Â¿Ã‚Â¾
        if years == 3:
            cutoff_date = datetime.now().date() - timedelta(days=3 * 365)
            df = df[df["date"] >= cutoff_date]
        
        return df


# ÃƒÂ¥Ã‚Â»Ã‚ÂºÃƒÂ§Ã‚Â«Ã¢â‚¬Â¹ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¨ÃƒÂ¥Ã…Â¸Ã…Â¸ÃƒÂ¥Ã‚Â®Ã‚Â¢ÃƒÂ¦Ã‹â€ Ã‚Â¶ÃƒÂ§Ã‚Â«Ã‚Â¯ÃƒÂ¥Ã‚Â¯Ã‚Â¦ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â¹
yahoo_finance = YahooFinanceClient()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/logging_config.py  â­
> æ—¥èªŒè¨­å®š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ—¥èªŒè¨­å®š
ç¢ºä¿æ‰€æœ‰é‡è¦æ“ä½œéƒ½æœ‰è¨˜éŒ„
"""
import logging
import sys
from datetime import datetime
from pathlib import Path


def setup_logging(log_level: str = "INFO", log_to_file: bool = True):
    """
    è¨­å®šæ—¥èªŒç³»çµ±
    
    Args:
        log_level: æ—¥èªŒç­‰ç´š (DEBUG, INFO, WARNING, ERROR)
        log_to_file: æ˜¯å¦å¯«å…¥æª”æ¡ˆ
    """
    # å»ºç«‹ logs ç›®éŒ„
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)
    
    # æ—¥èªŒæ ¼å¼
    log_format = "%(asctime)s | %(levelname)-8s | %(name)s | %(message)s"
    date_format = "%Y-%m-%d %H:%M:%S"
    
    # å»ºç«‹ formatter
    formatter = logging.Formatter(log_format, datefmt=date_format)
    
    # å–å¾— root logger
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, log_level.upper(), logging.INFO))
    
    # æ¸…é™¤ç¾æœ‰çš„ handlers
    root_logger.handlers.clear()
    
    # Console handler
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    console_handler.setLevel(logging.INFO)
    root_logger.addHandler(console_handler)
    
    if log_to_file:
        # ä¸»è¦æ—¥èªŒæª”ï¼ˆæ‰€æœ‰æ—¥èªŒï¼‰
        today = datetime.now().strftime("%Y-%m-%d")
        main_log_file = log_dir / f"app_{today}.log"
        file_handler = logging.FileHandler(main_log_file, encoding="utf-8")
        file_handler.setFormatter(formatter)
        file_handler.setLevel(logging.DEBUG)
        root_logger.addHandler(file_handler)
        
        # èªè­‰æ—¥èªŒæª”ï¼ˆç™»å…¥/ç™»å‡ºï¼‰
        auth_logger = logging.getLogger("app.services.auth_service")
        auth_log_file = log_dir / f"auth_{today}.log"
        auth_handler = logging.FileHandler(auth_log_file, encoding="utf-8")
        auth_handler.setFormatter(formatter)
        auth_handler.setLevel(logging.INFO)
        auth_logger.addHandler(auth_handler)
        
        # Watchlist æ—¥èªŒæª”
        watchlist_logger = logging.getLogger("app.services.watchlist_service")
        watchlist_log_file = log_dir / f"watchlist_{today}.log"
        watchlist_handler = logging.FileHandler(watchlist_log_file, encoding="utf-8")
        watchlist_handler.setFormatter(formatter)
        watchlist_handler.setLevel(logging.INFO)
        watchlist_logger.addHandler(watchlist_handler)
    
    # è¨­å®šç¬¬ä¸‰æ–¹å¥—ä»¶çš„æ—¥èªŒç­‰ç´š
    logging.getLogger("httpx").setLevel(logging.WARNING)
    logging.getLogger("httpcore").setLevel(logging.WARNING)
    logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)
    logging.getLogger("uvicorn").setLevel(logging.INFO)
    
    root_logger.info("æ—¥èªŒç³»çµ±åˆå§‹åŒ–å®Œæˆ")
    if log_to_file:
        root_logger.info(f"æ—¥èªŒæª”æ¡ˆ: {log_dir.absolute()}")


def get_logger(name: str) -> logging.Logger:
    """å–å¾— logger"""
    return logging.getLogger(name)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/__init__.py  â­
> æ’ç¨‹ä»»å‹™æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ’ç¨‹ä»»å‹™æ¨¡çµ„
"""
from app.tasks.scheduler import scheduler_service, SchedulerService

__all__ = [
    "scheduler_service",
    "SchedulerService",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/price_cache_task.py  â­
> åƒ¹æ ¼å¿«å–æ’ç¨‹ä»»å‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åƒ¹æ ¼å¿«å–æ’ç¨‹ä»»å‹™

æ’ç¨‹é‚è¼¯ï¼š
1. æ¯ 10 åˆ†é˜åŸ·è¡Œ run_update()
   - è‡ªå‹•åˆ¤æ–·å“ªäº›å¸‚å ´é–‹ç›¤
   - åªæ›´æ–°é–‹ç›¤ä¸­çš„å¸‚å ´
   
2. æ”¶ç›¤å¾Œå„åŸ·è¡Œä¸€æ¬¡ï¼ˆç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹ï¼‰
   - å°è‚¡ï¼š13:35
   - ç¾è‚¡ï¼š05:05
"""
import logging
from datetime import datetime
from typing import Dict, Any

from app.database import SyncSessionLocal
from app.services.price_cache_service import PriceCacheService, get_market_status

logger = logging.getLogger(__name__)


class PriceCacheScheduler:
    """åƒ¹æ ¼å¿«å–æ’ç¨‹å™¨"""
    
    def __init__(self):
        self.last_run: datetime = None
        self.last_result: Dict[str, Any] = {}
    
    def run_update(self) -> Dict[str, Any]:
        """
        åŸ·è¡Œåƒ¹æ ¼å¿«å–æ›´æ–°ï¼ˆæ¯ 10 åˆ†é˜ï¼‰
        
        è‡ªå‹•åˆ¤æ–·ï¼š
        - å°è‚¡é–‹ç›¤ (09:00-13:30) â†’ æ›´æ–°å°è‚¡
        - ç¾è‚¡é–‹ç›¤ (21:30-05:00) â†’ æ›´æ–°ç¾è‚¡
        - åŠ å¯†è²¨å¹£ â†’ 24 å°æ™‚æ›´æ–°
        """
        market_status = get_market_status()
        
        # å¦‚æœæ‰€æœ‰è‚¡å¸‚éƒ½æ”¶ç›¤ï¼Œåªæ›´æ–°åŠ å¯†è²¨å¹£
        if not market_status["tw_open"] and not market_status["us_open"]:
            logger.info("å°è‚¡ç¾è‚¡çš†æ”¶ç›¤ï¼Œåªæ›´æ–°åŠ å¯†è²¨å¹£")
        
        return self._do_update(force=False)
    
    def run_force_update(self) -> Dict[str, Any]:
        """
        å¼·åˆ¶æ›´æ–°æ‰€æœ‰å¸‚å ´ï¼ˆç”¨æ–¼æ”¶ç›¤å¾Œæˆ–æ‰‹å‹•è§¸ç™¼ï¼‰
        """
        logger.info("å¼·åˆ¶æ›´æ–°æ‰€æœ‰å¸‚å ´")
        return self._do_update(force=True)
    
    def run_tw_close_update(self) -> Dict[str, Any]:
        """
        å°è‚¡æ”¶ç›¤å¾Œæ›´æ–°ï¼ˆ13:35 åŸ·è¡Œï¼‰
        ç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹
        """
        logger.info("å°è‚¡æ”¶ç›¤ï¼ŒåŸ·è¡Œæœ€çµ‚æ›´æ–°")
        
        db = SyncSessionLocal()
        try:
            service = PriceCacheService(db)
            tracked = service.get_all_tracked_symbols()
            
            if tracked["tw_stocks"]:
                result = service.batch_update_stock_prices(tracked["tw_stocks"])
                logger.info(f"å°è‚¡æ”¶ç›¤æ›´æ–°å®Œæˆ: {result['updated']} æ”¯")
                return result
            return {"updated": 0, "message": "ç„¡å°è‚¡è¿½è¹¤"}
            
        except Exception as e:
            logger.error(f"å°è‚¡æ”¶ç›¤æ›´æ–°å¤±æ•—: {e}")
            return {"error": str(e)}
        finally:
            db.close()
    
    def run_us_close_update(self) -> Dict[str, Any]:
        """
        ç¾è‚¡æ”¶ç›¤å¾Œæ›´æ–°ï¼ˆ05:05 åŸ·è¡Œï¼‰
        ç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹
        """
        logger.info("ç¾è‚¡æ”¶ç›¤ï¼ŒåŸ·è¡Œæœ€çµ‚æ›´æ–°")
        
        db = SyncSessionLocal()
        try:
            service = PriceCacheService(db)
            tracked = service.get_all_tracked_symbols()
            
            if tracked["us_stocks"]:
                result = service.batch_update_stock_prices(tracked["us_stocks"])
                logger.info(f"ç¾è‚¡æ”¶ç›¤æ›´æ–°å®Œæˆ: {result['updated']} æ”¯")
                return result
            return {"updated": 0, "message": "ç„¡ç¾è‚¡è¿½è¹¤"}
            
        except Exception as e:
            logger.error(f"ç¾è‚¡æ”¶ç›¤æ›´æ–°å¤±æ•—: {e}")
            return {"error": str(e)}
        finally:
            db.close()
    
    def _do_update(self, force: bool = False) -> Dict[str, Any]:
        """åŸ·è¡Œæ›´æ–°"""
        logger.info("=" * 50)
        logger.info(f"æ’ç¨‹: é–‹å§‹æ›´æ–°åƒ¹æ ¼å¿«å– (force={force})")
        logger.info(f"æ™‚é–“: {datetime.now()}")
        logger.info("=" * 50)
        
        db = SyncSessionLocal()
        
        try:
            service = PriceCacheService(db)
            result = service.update_all_tracked_prices(force=force)
            
            self.last_run = datetime.now()
            self.last_result = result
            
            logger.info(f"æ’ç¨‹: åƒ¹æ ¼å¿«å–æ›´æ–°å®Œæˆ, å…± {result['total_updated']} ç­†")
            
            return result
            
        except Exception as e:
            logger.error(f"æ’ç¨‹: åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}", exc_info=True)
            return {
                "success": False,
                "error": str(e),
                "timestamp": datetime.now().isoformat(),
            }
        finally:
            db.close()
    
    def get_status(self) -> Dict[str, Any]:
        """å–å¾—æ’ç¨‹ç‹€æ…‹"""
        return {
            "last_run": self.last_run.isoformat() if self.last_run else None,
            "last_result": self.last_result,
            "market_status": get_market_status(),
        }


# å…¨åŸŸå¯¦ä¾‹
price_cache_scheduler = PriceCacheScheduler()


# ============================================================
# APScheduler è¨­å®šç¯„ä¾‹ï¼ˆåŠ åˆ° main.pyï¼‰
# ============================================================

"""
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from app.tasks.price_cache_task import price_cache_scheduler

scheduler = AsyncIOScheduler()

# 1. æ¯ 10 åˆ†é˜åŸ·è¡Œï¼ˆè‡ªå‹•åˆ¤æ–·é–‹ç›¤æ™‚é–“ï¼‰
scheduler.add_job(
    price_cache_scheduler.run_update,
    'interval',
    minutes=10,
    id='price_cache_interval',
    name='åƒ¹æ ¼å¿«å–æ›´æ–°(æ¯10åˆ†é˜)',
)

# 2. å°è‚¡æ”¶ç›¤å¾ŒåŸ·è¡Œä¸€æ¬¡ï¼ˆé€±ä¸€åˆ°é€±äº” 13:35ï¼‰
scheduler.add_job(
    price_cache_scheduler.run_tw_close_update,
    CronTrigger(day_of_week='mon-fri', hour=13, minute=35),
    id='price_cache_tw_close',
    name='å°è‚¡æ”¶ç›¤æ›´æ–°',
)

# 3. ç¾è‚¡æ”¶ç›¤å¾ŒåŸ·è¡Œä¸€æ¬¡ï¼ˆé€±äºŒåˆ°é€±å…­ 05:05ï¼Œå°æ‡‰ç¾è‚¡é€±ä¸€åˆ°é€±äº”ï¼‰
scheduler.add_job(
    price_cache_scheduler.run_us_close_update,
    CronTrigger(day_of_week='tue-sat', hour=5, minute=5),
    id='price_cache_us_close',
    name='ç¾è‚¡æ”¶ç›¤æ›´æ–°',
)

# å•Ÿå‹•æ’ç¨‹
@app.on_event("startup")
async def startup_event():
    scheduler.start()
    # å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡ï¼ˆå¼·åˆ¶æ›´æ–°æ‰€æœ‰ï¼‰
    price_cache_scheduler.run_force_update()

@app.on_event("shutdown")
async def shutdown_event():
    scheduler.shutdown()
"""
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/scheduler.py  â­
> æ’ç¨‹ä»»å‹™æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ’ç¨‹ä»»å‹™æœå‹™
æ¯æ—¥è‡ªå‹•æ›´æ–°è‚¡åƒ¹ã€æŒ‡æ•¸ã€æƒ…ç·’è³‡æ–™ï¼Œä¸¦ç™¼é€è¨Šè™Ÿé€šçŸ¥
"""
import asyncio
from datetime import datetime, date, timedelta
from typing import Dict, Any, List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import select, distinct, and_
import logging

from app.database import SyncSessionLocal, AsyncSessionLocal
from app.models.watchlist import Watchlist
from app.models.stock_price import StockPrice
from app.models.index_price import IndexPrice, INDEX_SYMBOLS
from app.models.market_sentiment import MarketSentiment
from app.models.notification import Notification
from app.models.user import User
from app.models.user_settings import UserAlertSettings
from app.services.market_service import MarketService
from app.services.signal_service import signal_service, SignalType
from app.data_sources.yahoo_finance import yahoo_finance

logger = logging.getLogger(__name__)


class SchedulerService:
    """æ’ç¨‹ä»»å‹™æœå‹™"""
    
    # é‡è¦è¨Šè™Ÿé¡å‹ï¼ˆåªé€šçŸ¥é€™äº›ï¼‰
    IMPORTANT_SIGNAL_TYPES = [
        # äº¤å‰è¨Šè™Ÿ
        SignalType.MA_GOLDEN_CROSS,
        SignalType.MA_DEATH_CROSS,
        SignalType.MACD_GOLDEN_CROSS,
        SignalType.MACD_DEATH_CROSS,
        SignalType.KD_GOLDEN_CROSS,
        SignalType.KD_DEATH_CROSS,
        # RSI æ¥µç«¯å€¼
        SignalType.RSI_OVERBOUGHT,
        SignalType.RSI_OVERSOLD,
    ]
    
    def __init__(self):
        self.last_run: Optional[datetime] = None
        self.last_result: Dict[str, Any] = {}
    
    def _get_db(self) -> Session:
        """å–å¾—è³‡æ–™åº« session"""
        return SyncSessionLocal()
    
    def run_daily_update(self) -> Dict[str, Any]:
        """
        åŸ·è¡Œæ¯æ—¥æ›´æ–°ä»»å‹™
        
        åŒ…å«ï¼š
        1. æ›´æ–°æ‰€æœ‰è¿½è¹¤è‚¡ç¥¨çš„åƒ¹æ ¼
        2. æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
        3. æ›´æ–°å¸‚å ´æƒ…ç·’
        4. åµæ¸¬è¨Šè™Ÿä¸¦ç™¼é€é€šçŸ¥
        
        Returns:
            åŸ·è¡Œçµæœæ‘˜è¦
        """
        logger.info("=" * 50)
        logger.info("é–‹å§‹åŸ·è¡Œæ¯æ—¥æ›´æ–°ä»»å‹™")
        logger.info(f"åŸ·è¡Œæ™‚é–“: {datetime.now()}")
        logger.info("=" * 50)
        
        result = {
            "start_time": datetime.now().isoformat(),
            "stocks_updated": 0,
            "indices_updated": {},
            "sentiment_updated": {},
            "signals_detected": 0,
            "notifications_sent": 0,
            "errors": [],
        }
        
        db = self._get_db()
        
        try:
            # 1. æ›´æ–°è¿½è¹¤è‚¡ç¥¨
            stocks_result = self._update_watchlist_stocks(db)
            result["stocks_updated"] = stocks_result["count"]
            if stocks_result.get("errors"):
                result["errors"].extend(stocks_result["errors"])
            
            # 2. æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
            market_service = MarketService(db)
            indices_result = self._update_indices(market_service)
            result["indices_updated"] = indices_result
            
            # 3. æ›´æ–°å¸‚å ´æƒ…ç·’
            sentiment_result = market_service.update_today_sentiment()
            result["sentiment_updated"] = sentiment_result
            
            # 4. åµæ¸¬è¨Šè™Ÿä¸¦ç™¼é€é€šçŸ¥
            signal_result = self._detect_and_notify(db)
            result["signals_detected"] = signal_result.get("signals_count", 0)
            result["notifications_sent"] = signal_result.get("notifications_sent", 0)
            if signal_result.get("errors"):
                result["errors"].extend(signal_result["errors"])
            
            result["end_time"] = datetime.now().isoformat()
            result["success"] = True
            
            logger.info("=" * 50)
            logger.info("æ¯æ—¥æ›´æ–°ä»»å‹™å®Œæˆ")
            logger.info(f"è‚¡ç¥¨æ›´æ–°: {result['stocks_updated']} æª”")
            logger.info(f"æŒ‡æ•¸æ›´æ–°: {result['indices_updated']}")
            logger.info(f"æƒ…ç·’æ›´æ–°: {result['sentiment_updated']}")
            logger.info(f"è¨Šè™Ÿåµæ¸¬: {result['signals_detected']} å€‹")
            logger.info(f"é€šçŸ¥ç™¼é€: {result['notifications_sent']} äºº")
            logger.info("=" * 50)
            
        except Exception as e:
            logger.error(f"æ¯æ—¥æ›´æ–°ä»»å‹™å¤±æ•—: {e}")
            result["errors"].append(str(e))
            result["success"] = False
        finally:
            db.close()
        
        self.last_run = datetime.now()
        self.last_result = result
        
        return result
    
    def _detect_and_notify(self, db: Session) -> Dict[str, Any]:
        """
        åµæ¸¬è¨Šè™Ÿä¸¦ç™¼é€é€šçŸ¥
        
        æµç¨‹ï¼š
        1. å–å¾—æ‰€æœ‰ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®ï¼ˆè¯é›†ï¼‰
        2. å°æ¯æ”¯è‚¡ç¥¨è¨ˆç®—æŒ‡æ¨™ä¸¦åµæ¸¬è¨Šè™Ÿ
        3. æ ¹æ“šç”¨æˆ¶è¨­å®šç™¼é€é€šçŸ¥
        """
        result = {
            "signals_count": 0,
            "notifications_sent": 0,
            "errors": [],
        }
        
        logger.info("é–‹å§‹åµæ¸¬è¨Šè™Ÿ...")
        
        try:
            # 1. å–å¾—æ‰€æœ‰è¿½è¹¤çš„è‚¡ç¥¨
            stmt = select(distinct(Watchlist.symbol)).where(Watchlist.asset_type == "stock")
            symbols = db.execute(stmt).scalars().all()
            logger.info(f"éœ€è¦åµæ¸¬çš„è‚¡ç¥¨: {len(symbols)} æª”")
            
            # 2. å°æ¯æ”¯è‚¡ç¥¨åµæ¸¬è¨Šè™Ÿ
            all_signals = {}  # {symbol: [signals]}
            
            for symbol in symbols:
                try:
                    signals = self._detect_signals_for_symbol(symbol)
                    
                    # åªä¿ç•™äº¤å‰è¨Šè™Ÿ
                    cross_signals = [s for s in signals if s.signal_type in self.IMPORTANT_SIGNAL_TYPES]
                    
                    if cross_signals:
                        all_signals[symbol] = cross_signals
                        result["signals_count"] += len(cross_signals)
                        logger.info(f"{symbol}: åµæ¸¬åˆ° {len(cross_signals)} å€‹äº¤å‰è¨Šè™Ÿ")
                
                except Exception as e:
                    logger.error(f"åµæ¸¬ {symbol} è¨Šè™Ÿå¤±æ•—: {e}")
                    result["errors"].append(f"{symbol}: {str(e)}")
            
            logger.info(f"å…±åµæ¸¬åˆ° {result['signals_count']} å€‹äº¤å‰è¨Šè™Ÿ")
            
            if not all_signals:
                logger.info("ä»Šæ—¥ç„¡äº¤å‰è¨Šè™Ÿï¼Œä¸ç™¼é€é€šçŸ¥")
                return result
            
            # 3. å–å¾—éœ€è¦é€šçŸ¥çš„ç”¨æˆ¶
            users_to_notify = self._get_users_to_notify(db, all_signals)
            logger.info(f"éœ€è¦é€šçŸ¥çš„ç”¨æˆ¶: {len(users_to_notify)} äºº")
            
            # 4. ç™¼é€é€šçŸ¥
            for user_id, user_data in users_to_notify.items():
                try:
                    success = self._send_notification(db, user_data)
                    if success:
                        result["notifications_sent"] += 1
                except Exception as e:
                    logger.error(f"ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶ {user_id} å¤±æ•—: {e}")
                    result["errors"].append(f"notify user {user_id}: {str(e)}")
            
        except Exception as e:
            logger.error(f"è¨Šè™Ÿåµæ¸¬å¤±æ•—: {e}")
            result["errors"].append(str(e))
        
        return result
    
    def _detect_signals_for_symbol(self, symbol: str) -> List:
        """å°å–®ä¸€è‚¡ç¥¨åµæ¸¬è¨Šè™Ÿ"""
        from app.services.indicator_service import indicator_service, SignalType as IndicatorSignalType
        
        # å–å¾—è‚¡ç¥¨è³‡æ–™
        df = yahoo_finance.get_stock_history(symbol, period="3mo")
        
        if df is None or df.empty:
            return []
        
        # è¨ˆç®—æŒ‡æ¨™
        df = indicator_service.calculate_all_indicators(df)
        
        if df is None or df.empty:
            return []
        
        # å–å¾—è¨Šè™Ÿ
        indicator_signals = indicator_service.get_all_signals(df)
        
        if not indicator_signals:
            return []
        
        # è½‰æ›è¨Šè™Ÿæ ¼å¼ï¼ˆå¾ indicator_service.Signal åˆ° signal_service.Signalï¼‰
        from app.services.signal_service import Signal, SignalType
        
        signals = []
        current_price = float(df.iloc[-1]['close']) if 'close' in df.columns else 0
        
        # è¨Šè™Ÿé¡å‹å°ç…§
        type_mapping = {
            IndicatorSignalType.GOLDEN_CROSS: SignalType.MA_GOLDEN_CROSS,
            IndicatorSignalType.DEATH_CROSS: SignalType.MA_DEATH_CROSS,
            IndicatorSignalType.RSI_OVERBOUGHT: SignalType.RSI_OVERBOUGHT,
            IndicatorSignalType.RSI_OVERSOLD: SignalType.RSI_OVERSOLD,
            IndicatorSignalType.MACD_GOLDEN_CROSS: SignalType.MACD_GOLDEN_CROSS,
            IndicatorSignalType.MACD_DEATH_CROSS: SignalType.MACD_DEATH_CROSS,
            IndicatorSignalType.KD_GOLDEN_CROSS: SignalType.KD_GOLDEN_CROSS,
            IndicatorSignalType.KD_DEATH_CROSS: SignalType.KD_DEATH_CROSS,
            IndicatorSignalType.APPROACHING_BREAKOUT: SignalType.APPROACHING_BREAKOUT,
            IndicatorSignalType.APPROACHING_BREAKDOWN: SignalType.APPROACHING_BREAKDOWN,
        }
        
        for ind_sig in indicator_signals:
            sig_type = type_mapping.get(ind_sig.type)
            if sig_type:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type="stock",
                    signal_type=sig_type,
                    indicator=ind_sig.indicator,
                    message=ind_sig.description,
                    price=current_price,
                    details={},
                    timestamp=datetime.now(),
                ))
        
        return signals
    
    def _get_users_to_notify(self, db: Session, all_signals: Dict) -> Dict:
        """
        å–å¾—éœ€è¦é€šçŸ¥çš„ç”¨æˆ¶
        
        Returns:
            {user_id: {
                "line_user_id": "xxx",
                "display_name": "xxx",
                "signals": [...]
            }}
        """
        users_to_notify = {}
        
        # å–å¾—æ‰€æœ‰ç”¨æˆ¶å’Œä»–å€‘çš„è¿½è¹¤æ¸…å–®
        stmt = select(User).where(User.is_active == True, User.is_blocked == False)
        users = db.execute(stmt).scalars().all()
        
        for user in users:
            # å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
            watchlist_stmt = select(Watchlist.symbol).where(
                Watchlist.user_id == user.id,
                Watchlist.asset_type == "stock"
            )
            user_symbols = set(db.execute(watchlist_stmt).scalars().all())
            
            # å–å¾—ç”¨æˆ¶çš„é€šçŸ¥è¨­å®šï¼ˆæª¢æŸ¥æ˜¯å¦é–‹å•Ÿäº¤å‰é€šçŸ¥ï¼‰
            alert_stmt = select(UserAlertSettings).where(UserAlertSettings.user_id == user.id)
            alert_settings = db.execute(alert_stmt).scalar_one_or_none()
            
            # é è¨­é–‹å•Ÿ MA å’Œ MACD äº¤å‰é€šçŸ¥
            alert_ma = True
            alert_macd = True
            alert_kd = False
            alert_rsi = True  # é è¨­é–‹å•Ÿ RSI
            
            if alert_settings:
                alert_ma = alert_settings.alert_ma_cross
                alert_macd = alert_settings.alert_macd
                alert_kd = alert_settings.alert_kd
                alert_rsi = alert_settings.alert_rsi
            
            # æ‰¾å‡ºç”¨æˆ¶è¿½è¹¤ä¸­æœ‰è¨Šè™Ÿçš„è‚¡ç¥¨
            user_signals = []
            for symbol, signals in all_signals.items():
                if symbol not in user_symbols:
                    continue
                
                for signal in signals:
                    # æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é–‹å•Ÿè©²é¡å‹çš„é€šçŸ¥
                    if signal.signal_type in [SignalType.MA_GOLDEN_CROSS, SignalType.MA_DEATH_CROSS]:
                        if not alert_ma:
                            continue
                    elif signal.signal_type in [SignalType.MACD_GOLDEN_CROSS, SignalType.MACD_DEATH_CROSS]:
                        if not alert_macd:
                            continue
                    elif signal.signal_type in [SignalType.KD_GOLDEN_CROSS, SignalType.KD_DEATH_CROSS]:
                        if not alert_kd:
                            continue
                    elif signal.signal_type in [SignalType.RSI_OVERBOUGHT, SignalType.RSI_OVERSOLD]:
                        if not alert_rsi:
                            continue
                    
                    # æª¢æŸ¥ 24 å°æ™‚å…§æ˜¯å¦å·²é€šçŸ¥é
                    if self._has_recent_notification(db, user.id, symbol, signal.signal_type.value):
                        continue
                    
                    user_signals.append(signal)
            
            if user_signals:
                users_to_notify[user.id] = {
                    "user_id": user.id,
                    "line_user_id": user.line_user_id,
                    "display_name": user.display_name,
                    "signals": user_signals,
                }
        
        return users_to_notify
    
    def _has_recent_notification(self, db: Session, user_id: int, symbol: str, alert_type: str) -> bool:
        """æª¢æŸ¥ 24 å°æ™‚å…§æ˜¯å¦å·²ç™¼é€éç›¸åŒé€šçŸ¥"""
        cutoff = datetime.now() - timedelta(hours=24)
        
        stmt = select(Notification).where(
            Notification.user_id == user_id,
            Notification.symbol == symbol,
            Notification.alert_type == alert_type,
            Notification.triggered_at >= cutoff,
        )
        
        existing = db.execute(stmt).scalar_one_or_none()
        return existing is not None
    
    def _send_notification(self, db: Session, user_data: Dict) -> bool:
        """ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶"""
        from app.services.line_notify_service import line_notify_service
        
        line_user_id = user_data["line_user_id"]
        signals = user_data["signals"]
        
        if not line_user_id or not signals:
            return False
        
        # åˆ†é¡è¨Šè™Ÿ
        bullish = []
        bearish = []
        
        for signal in signals:
            signal_name = signal_service.SIGNAL_NAMES.get(signal.signal_type, str(signal.signal_type))
            item = {
                "symbol": signal.symbol,
                "signal": signal_name,
                "price": signal.price,
                "signal_type": signal.signal_type.value,
            }
            
            # åˆ¤æ–·å¤šç©º
            if signal.signal_type in [
                SignalType.MA_GOLDEN_CROSS, 
                SignalType.MACD_GOLDEN_CROSS, 
                SignalType.KD_GOLDEN_CROSS,
                SignalType.RSI_OVERSOLD,
            ]:
                bullish.append(item)
            else:
                bearish.append(item)
        
        # æ ¼å¼åŒ–è¨Šæ¯
        message = self._format_notification_message(bullish, bearish)
        
        # ç™¼é€è¨Šæ¯ï¼ˆä½¿ç”¨ asyncio åŸ·è¡Œï¼‰
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            success = loop.run_until_complete(
                line_notify_service.push_text_message(line_user_id, message)
            )
            loop.close()
        except Exception as e:
            logger.error(f"ç™¼é€ LINE è¨Šæ¯å¤±æ•—: {e}")
            success = False
        
        # è¨˜éŒ„é€šçŸ¥
        for signal in signals:
            notification = Notification(
                user_id=user_data.get("user_id"),
                symbol=signal.symbol,
                asset_type=signal.asset_type,
                alert_type=signal.signal_type.value,
                indicator=signal.indicator,
                message=signal.message,
                price_at_trigger=signal.price,
                sent=success,
                sent_at=datetime.now() if success else None,
            )
            db.add(notification)
        
        db.commit()
        
        return success
    
    def _format_notification_message(self, bullish: List[Dict], bearish: List[Dict]) -> str:
        """æ ¼å¼åŒ–æ¯æ—¥è¨Šè™Ÿé€šçŸ¥è¨Šæ¯"""
        lines = ["ğŸ“Š SELA é¸è‚¡ç³»çµ± - æ¯æ—¥è¨Šè™Ÿ", ""]
        
        if bullish:
            lines.append("ğŸŸ¢ åå¤šè¨Šè™Ÿ")
            for item in bullish:
                price_str = f" @ ${item['price']:.2f}" if item['price'] > 0 else ""
                lines.append(f"  â€¢ {item['symbol']}{price_str}")
                lines.append(f"    {item['signal']}")
            lines.append("")
        
        if bearish:
            lines.append("ğŸ”´ åç©ºè¨Šè™Ÿ")
            for item in bearish:
                price_str = f" @ ${item['price']:.2f}" if item['price'] > 0 else ""
                lines.append(f"  â€¢ {item['symbol']}{price_str}")
                lines.append(f"    {item['signal']}")
            lines.append("")
        
        if not bullish and not bearish:
            lines.append("ä»Šæ—¥æ‚¨çš„è¿½è¹¤æ¸…å–®ç„¡é‡è¦è¨Šè™Ÿ âœ¨")
            lines.append("")
        
        lines.append(f"â° {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        
        return "\n".join(lines)
    
    def run_signal_detection_only(self) -> Dict[str, Any]:
        """
        åªåŸ·è¡Œè¨Šè™Ÿåµæ¸¬ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
        ç”¨æ–¼æ¸¬è©¦
        """
        logger.info("é–‹å§‹è¨Šè™Ÿåµæ¸¬ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰...")
        
        result = {
            "signals": [],
            "by_symbol": {},
        }
        
        db = self._get_db()
        
        try:
            stmt = select(distinct(Watchlist.symbol)).where(Watchlist.asset_type == "stock")
            symbols = db.execute(stmt).scalars().all()
            
            for symbol in symbols:
                try:
                    signals = self._detect_signals_for_symbol(symbol)
                    cross_signals = [s for s in signals if s.signal_type in self.IMPORTANT_SIGNAL_TYPES]
                    
                    if cross_signals:
                        result["by_symbol"][symbol] = [
                            {
                                "type": s.signal_type.value,
                                "message": s.message,
                                "price": s.price,
                            }
                            for s in cross_signals
                        ]
                        result["signals"].extend(cross_signals)
                
                except Exception as e:
                    logger.error(f"{symbol} åµæ¸¬å¤±æ•—: {e}")
        
        finally:
            db.close()
        
        return result

    def _update_watchlist_stocks(self, db: Session) -> Dict[str, Any]:
        """
        æ›´æ–°æ‰€æœ‰è¿½è¹¤æ¸…å–®ä¸­çš„è‚¡ç¥¨
        """
        result = {"count": 0, "errors": []}
        
        # å–å¾—æ‰€æœ‰ä¸é‡è¤‡çš„è¿½è¹¤è‚¡ç¥¨
        stmt = select(distinct(Watchlist.symbol)).where(Watchlist.asset_type == "stock")
        symbols = db.execute(stmt).scalars().all()
        
        logger.info(f"éœ€è¦æ›´æ–°çš„è‚¡ç¥¨: {len(symbols)} æª”")
        
        for symbol in symbols:
            try:
                # å¾ Yahoo Finance æŠ“å–æœ€æ–°è³‡æ–™
                df = yahoo_finance.get_stock_history(symbol, period="5d")
                
                if df is None or df.empty:
                    logger.warning(f"ç„¡æ³•å–å¾— {symbol} çš„è³‡æ–™")
                    result["errors"].append(f"{symbol}: ç„¡è³‡æ–™")
                    continue
                
                # å„²å­˜åˆ°è³‡æ–™åº«
                count = self._save_stock_prices(db, df)
                result["count"] += 1
                logger.debug(f"{symbol} æ›´æ–°å®Œæˆï¼Œæ–°å¢ {count} ç­†")
                
            except Exception as e:
                logger.error(f"æ›´æ–° {symbol} å¤±æ•—: {e}")
                result["errors"].append(f"{symbol}: {str(e)}")
        
        return result
    
    def _save_stock_prices(self, db: Session, df) -> int:
        """å„²å­˜è‚¡ç¥¨åƒ¹æ ¼"""
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            stmt = select(StockPrice).where(
                and_(
                    StockPrice.symbol == row["symbol"],
                    StockPrice.date == row["date"],
                )
            )
            existing = db.execute(stmt).scalar_one_or_none()
            
            if existing:
                existing.open = row["open"]
                existing.high = row["high"]
                existing.low = row["low"]
                existing.close = row["close"]
                existing.volume = row["volume"]
            else:
                price = StockPrice(
                    symbol=row["symbol"],
                    date=row["date"],
                    open=row["open"],
                    high=row["high"],
                    low=row["low"],
                    close=row["close"],
                    volume=row["volume"],
                )
                db.add(price)
                count += 1
        
        db.commit()
        return count
    
    def _update_indices(self, market_service: MarketService) -> Dict[str, int]:
        """
        æ›´æ–°ä¸‰å¤§æŒ‡æ•¸ï¼ˆåªæ›´æ–°æœ€è¿‘ 5 å¤©ï¼‰
        """
        result = {}
        
        for symbol in INDEX_SYMBOLS.keys():
            try:
                df = yahoo_finance.get_index_data(symbol, period="5d")
                if df is not None:
                    count = market_service.save_index_data(df, symbol)
                    result[symbol] = count
                else:
                    result[symbol] = 0
            except Exception as e:
                logger.error(f"æ›´æ–°æŒ‡æ•¸ {symbol} å¤±æ•—: {e}")
                result[symbol] = -1
        
        return result
    
    def initialize_historical_data(self, years: int = 10) -> Dict[str, Any]:
        """
        åˆå§‹åŒ–æ­·å²è³‡æ–™ï¼ˆé¦–æ¬¡åŸ·è¡Œæ™‚ä½¿ç”¨ï¼‰
        
        åŒ…å«ï¼š
        1. ä¸‰å¤§æŒ‡æ•¸ 10 å¹´æ­·å²
        2. å¹£åœˆæƒ…ç·’ 365 å¤©æ­·å²
        
        Args:
            years: æŒ‡æ•¸æ­·å²å¹´æ•¸
            
        Returns:
            åŸ·è¡Œçµæœ
        """
        logger.info("=" * 50)
        logger.info("é–‹å§‹åˆå§‹åŒ–æ­·å²è³‡æ–™")
        logger.info("=" * 50)
        
        result = {
            "start_time": datetime.now().isoformat(),
            "indices": {},
            "crypto_sentiment": 0,
            "errors": [],
        }
        
        db = self._get_db()
        
        try:
            market_service = MarketService(db)
            
            # 1. åˆå§‹åŒ–ä¸‰å¤§æŒ‡æ•¸
            logger.info(f"åˆå§‹åŒ–ä¸‰å¤§æŒ‡æ•¸ ({years} å¹´è³‡æ–™)...")
            indices_result = market_service.fetch_and_save_all_indices(period=f"{years}y")
            result["indices"] = indices_result
            
            # 2. åˆå§‹åŒ–å¹£åœˆæƒ…ç·’æ­·å²
            logger.info("åˆå§‹åŒ–å¹£åœˆæƒ…ç·’æ­·å² (365 å¤©)...")
            crypto_count = market_service.fetch_and_save_crypto_history(days=365)
            result["crypto_sentiment"] = crypto_count
            
            result["success"] = True
            result["end_time"] = datetime.now().isoformat()
            
            logger.info("=" * 50)
            logger.info("æ­·å²è³‡æ–™åˆå§‹åŒ–å®Œæˆ")
            logger.info(f"æŒ‡æ•¸: {result['indices']}")
            logger.info(f"å¹£åœˆæƒ…ç·’: {result['crypto_sentiment']} ç­†")
            logger.info("=" * 50)
            
        except Exception as e:
            logger.error(f"åˆå§‹åŒ–å¤±æ•—: {e}")
            result["errors"].append(str(e))
            result["success"] = False
        finally:
            db.close()
        
        return result
    
    def get_status(self) -> Dict[str, Any]:
        """å–å¾—æ’ç¨‹ç‹€æ…‹"""
        return {
            "last_run": self.last_run.isoformat() if self.last_run else None,
            "last_result": self.last_result,
        }


# å»ºç«‹å…¨åŸŸæ’ç¨‹æœå‹™å¯¦ä¾‹
scheduler_service = SchedulerService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ dashboard-patch-example.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!--
================================================================================
SELA dashboard.html è£œä¸ç¯„ä¾‹
ç‰ˆæœ¬: 1.0.0

æ­¤æª”æ¡ˆå±•ç¤ºéœ€è¦åœ¨ dashboard.html ä¸­é€²è¡Œçš„æ‰€æœ‰ä¿®æ”¹
è«‹ä¾ç…§æ¨™è¨˜ä½ç½®å°‡ç›¸æ‡‰ä»£ç¢¼åŠ å…¥åˆ°æ‚¨çš„ dashboard.html ä¸­
================================================================================
-->

<!-- ========================================================================
     ä½ç½® 1: <head> å€å¡Šå…§ï¼Œåœ¨å…¶ä»– CSS ä¹‹å¾ŒåŠ å…¥
     ======================================================================== -->

<!-- åœ¨ç¾æœ‰ <link> æ¨™ç±¤ä¹‹å¾ŒåŠ å…¥ -->
<link rel="stylesheet" href="/static/css/settings.css">


<!-- ========================================================================
     ä½ç½® 2: æ¡Œé¢ç‰ˆå°èˆªåˆ—ï¼Œåœ¨ç¾æœ‰å°èˆªé€£çµä¹‹å¾ŒåŠ å…¥
     é€šå¸¸åœ¨ <nav> å…§çš„é€£çµå€åŸŸ
     ======================================================================== -->

<!-- è¨­å®šé é¢å°èˆªé€£çµ -->
<a onclick="showSection('settings', event)" 
   class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer">
    <i class="fas fa-cog mr-2"></i>
    è¨­å®š
</a>


<!-- ========================================================================
     ä½ç½® 3: æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªåˆ—
     é€šå¸¸åœ¨å›ºå®šåœ¨åº•éƒ¨çš„å°èˆªå€åŸŸ
     ======================================================================== -->

<!-- è¨­å®šé é¢åº•éƒ¨å°èˆªæŒ‰éˆ• -->
<button onclick="showSection('settings', event)" 
        class="nav-tab flex flex-col items-center py-2 px-3 text-gray-500 hover:text-orange-500 transition-colors">
    <i class="fas fa-cog text-lg"></i>
    <span class="text-xs mt-1">è¨­å®š</span>
</button>


<!-- ========================================================================
     ä½ç½® 4: åœ¨å…¶ä»– <section> ä¹‹å¾Œã€</main> ä¹‹å‰åŠ å…¥è¨­å®šé é¢
     è«‹å°‡ settings-section.html çš„å®Œæ•´å…§å®¹è²¼åœ¨æ­¤è™•
     ======================================================================== -->

<section id="section-settings" class="section hidden">
    <!-- å¾ settings-section.html è¤‡è£½å®Œæ•´å…§å®¹åˆ°é€™è£¡ -->
</section>


<!-- ========================================================================
     ä½ç½® 5: åœ¨ </body> ä¹‹å‰ï¼Œå…¶ä»– <script> ä¹‹å¾ŒåŠ å…¥
     ======================================================================== -->

<!-- è¨­å®šé é¢è…³æœ¬ -->
<script src="/static/js/settings.js"></script>


<!-- ========================================================================
     ä½ç½® 6: JavaScript ä¿®æ”¹ - æ›´æ–° showSection å‡½æ•¸
     åœ¨ç¾æœ‰çš„ showSection å‡½æ•¸ä¸­åŠ å…¥ä»¥ä¸‹é‚è¼¯
     ======================================================================== -->

<script>
// ä¿®æ”¹ç¾æœ‰çš„ showSection å‡½æ•¸ï¼ŒåŠ å…¥è¨­å®šé é¢æ”¯æ´

function showSection(name, evt) {
    // éš±è—æ‰€æœ‰ section
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    
    // é¡¯ç¤ºç›®æ¨™ section
    const section = document.getElementById(`section-${name}`);
    if (section) {
        section.classList.remove('hidden');
    }
    
    // æ›´æ–°å°èˆªåˆ—é«˜äº®
    document.querySelectorAll('.nav-link').forEach(l => {
        l.classList.remove('bg-blue-50', 'text-gray-700');
        l.classList.add('text-gray-600');
    });
    
    // åªæœ‰é»æ“Šå°èˆªæ™‚æ‰æ›´æ–°é«˜äº®
    if (evt && evt.target) {
        const navLink = evt.target.closest('.nav-link');
        if (navLink) {
            navLink.classList.add('bg-blue-50', 'text-gray-700');
            navLink.classList.remove('text-gray-600');
        }
    }
    
    // æ›´æ–°æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªé«˜äº®
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('text-orange-500');
        tab.classList.add('text-gray-500');
    });
    if (evt && evt.target) {
        const navTab = evt.target.closest('.nav-tab');
        if (navTab) {
            navTab.classList.remove('text-gray-500');
            navTab.classList.add('text-orange-500');
        }
    }
    
    // ==================== æ–°å¢ï¼šè¨­å®šé é¢åˆå§‹åŒ– ====================
    if (name === 'settings') {
        // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
        updateSettingsUserInfo();
        // è¼‰å…¥è¨­å®š
        if (typeof initSettingsPage === 'function') {
            initSettingsPage();
        }
    }
    // ============================================================
    
    // å…¶ä»–é é¢ç‰¹å®šé‚è¼¯...
    if (name === 'dashboard') {
        // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
    } else if (name === 'watchlist') {
        // è¼‰å…¥è¿½è¹¤æ¸…å–®
    }
}

// æ–°å¢ï¼šæ›´æ–°è¨­å®šé é¢çš„ç”¨æˆ¶è³‡è¨Š
function updateSettingsUserInfo() {
    try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        const avatar = document.getElementById('settings-user-avatar');
        const name = document.getElementById('settings-user-name');
        const level = document.getElementById('settings-user-level');
        
        if (avatar && user.avatar_url) {
            avatar.src = user.avatar_url;
        }
        if (name) {
            name.textContent = user.display_name || 'ç”¨æˆ¶';
        }
        if (level) {
            level.textContent = user.is_admin ? 'ç®¡ç†å“¡' : 'å…è²»æœƒå“¡';
        }
    } catch (e) {
        console.error('æ›´æ–°ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', e);
    }
}
</script>


<!-- ========================================================================
     å®Œæ•´çš„å°èˆªåˆ—ç¯„ä¾‹ï¼ˆä¾›åƒè€ƒï¼‰
     ======================================================================== -->

<!-- æ¡Œé¢ç‰ˆå°èˆªåˆ—ç¯„ä¾‹ -->
<nav class="hidden md:flex flex-col space-y-1 p-4">
    <a onclick="showSection('dashboard', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer bg-blue-50 text-gray-700">
        <i class="fas fa-home mr-2"></i>
        é¦–é 
    </a>
    <a onclick="showSection('watchlist', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer">
        <i class="fas fa-star mr-2"></i>
        è¿½è¹¤æ¸…å–®
    </a>
    <a onclick="showSection('compare', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer">
        <i class="fas fa-chart-bar mr-2"></i>
        å ±é…¬æ¯”è¼ƒ
    </a>
    <!-- æ–°å¢çš„è¨­å®šé€£çµ -->
    <a onclick="showSection('settings', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer">
        <i class="fas fa-cog mr-2"></i>
        è¨­å®š
    </a>
</nav>

<!-- æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªåˆ—ç¯„ä¾‹ -->
<nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-2 z-50">
    <button onclick="showSection('dashboard', event)" class="nav-tab flex flex-col items-center py-2 px-3 text-orange-500">
        <i class="fas fa-home text-lg"></i>
        <span class="text-xs mt-1">é¦–é </span>
    </button>
    <button onclick="showSection('watchlist', event)" class="nav-tab flex flex-col items-center py-2 px-3 text-gray-500 hover:text-orange-500 transition-colors">
        <i class="fas fa-star text-lg"></i>
        <span class="text-xs mt-1">è¿½è¹¤</span>
    </button>
    <button onclick="showSection('compare', event)" class="nav-tab flex flex-col items-center py-2 px-3 text-gray-500 hover:text-orange-500 transition-colors">
        <i class="fas fa-chart-bar text-lg"></i>
        <span class="text-xs mt-1">æ¯”è¼ƒ</span>
    </button>
    <!-- æ–°å¢çš„è¨­å®šæŒ‰éˆ• -->
    <button onclick="showSection('settings', event)" class="nav-tab flex flex-col items-center py-2 px-3 text-gray-500 hover:text-orange-500 transition-colors">
        <i class="fas fa-cog text-lg"></i>
        <span class="text-xs mt-1">è¨­å®š</span>
    </button>
</nav>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ fixes/taiwan_stock_names_fix.py  â­
> ============================================================
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
# ============================================================
# ä¿®å¾©: TAIWAN_STOCK_NAMES äº‚ç¢¼å•é¡Œ
# ä½ç½®: app/data_sources/yahoo_finance.py
# 
# å•é¡Œ: Bundle æ–‡ä»¶ä¸­çš„ä¸­æ–‡åç¨±å·²ç¶“æ˜¯äº‚ç¢¼
# è§£æ±º: ç”¨ä»¥ä¸‹æ­£ç¢ºçš„å­—å…¸æ›¿æ›
# ============================================================

# æ‰¾åˆ° yahoo_finance.py ä¸­çš„ TAIWAN_STOCK_NAMES = { ... }
# æ•´å€‹æ›¿æ›ç‚ºä»¥ä¸‹å…§å®¹:

TAIWAN_STOCK_NAMES = {
    # æ¬Šå€¼è‚¡
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    # é‡‘èè‚¡
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    # é›»å­è‚¡
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    "5876": "ä¸Šæµ·å•†éŠ€",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ETF
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "006208": "å¯Œé‚¦å°50",
    "00646": "å…ƒå¤§S&P500",
    "00662": "å¯Œé‚¦NASDAQ",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}


# ============================================================
# åŒæ¨£éœ€è¦ä¿®å¾© price_cache_service.py ä¸­çš„ TAIWAN_STOCK_NAMES
# ä½ç½®: app/services/price_cache_service.py
# ç”¨ç›¸åŒçš„å­—å…¸æ›¿æ›
# ============================================================
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ railway.json  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ RAILWAY_SETUP.md  â­
> Railway PostgreSQL è¨­å®šæŒ‡å—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# Railway PostgreSQL è¨­å®šæŒ‡å—

## æ­¥é©Ÿ 1ï¼šåœ¨ Railway æ·»åŠ  PostgreSQL

1. é€²å…¥ä½ çš„ Railway å°ˆæ¡ˆ
2. é»æ“Š **New** â†’ **Database** â†’ **Add PostgreSQL**
3. ç­‰å¾…è³‡æ–™åº«å»ºç«‹å®Œæˆ

## æ­¥é©Ÿ 2ï¼šå–å¾—è³‡æ–™åº«é€£ç·šå­—ä¸²

1. é»æ“Šæ–°å»ºç«‹çš„ PostgreSQL æœå‹™
2. é€²å…¥ **Variables** æ¨™ç±¤
3. è¤‡è£½ `DATABASE_URL` çš„å€¼

æ ¼å¼é¡ä¼¼ï¼š
```
postgres://username:password@host:port/database
```

## æ­¥é©Ÿ 3ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸

åœ¨ä½ çš„ **Web Service** (ä¸æ˜¯ PostgreSQL) ä¸­è¨­å®šï¼š

1. é»æ“Š Web Service â†’ **Variables**
2. æ·»åŠ ä»¥ä¸‹è®Šæ•¸ï¼š

```bash
# è³‡æ–™åº« (å¾ PostgreSQL æœå‹™è¤‡è£½)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# æˆ–ç›´æ¥è²¼ä¸Šå®Œæ•´çš„é€£ç·šå­—ä¸²
# DATABASE_URL=postgres://username:password@host:port/database

# æ‡‰ç”¨ç¨‹å¼
APP_ENV=production
DEBUG=false

# LINE Login
LINE_LOGIN_CHANNEL_ID=ä½ çš„_channel_id
LINE_LOGIN_CHANNEL_SECRET=ä½ çš„_channel_secret
LINE_LOGIN_CALLBACK_URL=https://ä½ çš„ç¶²åŸŸ/auth/line/callback

# JWT
JWT_SECRET_KEY=ä½ çš„éš¨æ©Ÿå¯†é‘°
JWT_EXPIRE_DAYS=7
```

### ä½¿ç”¨ Railway çš„è®Šæ•¸å¼•ç”¨ï¼ˆæ¨è–¦ï¼‰

Railway æ”¯æ´åœ¨åŒä¸€å°ˆæ¡ˆå…§å¼•ç”¨å…¶ä»–æœå‹™çš„è®Šæ•¸ï¼š

```bash
DATABASE_URL=${{Postgres.DATABASE_URL}}
```

é€™æ¨£ç•¶è³‡æ–™åº«é€£ç·šè³‡è¨Šè®Šæ›´æ™‚ï¼Œæœƒè‡ªå‹•æ›´æ–°ã€‚

## æ­¥é©Ÿ 4ï¼šéƒ¨ç½²

```bash
# æ›´æ–°ä»£ç¢¼
git add .
git commit -m "feat: add PostgreSQL support"
git push
```

Railway æœƒè‡ªå‹•åµæ¸¬åˆ°è®Šæ›´ä¸¦é‡æ–°éƒ¨ç½²ã€‚

## æ­¥é©Ÿ 5ï¼šé©—è­‰

1. ç­‰å¾…éƒ¨ç½²å®Œæˆ
2. æª¢æŸ¥æ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   Starting SELA è‡ªå‹•é¸è‚¡ç³»çµ± v0.3.x
   Database initialized
   ```

3. è¨ªå•ä½ çš„ç¶²ç«™æ¸¬è©¦åŠŸèƒ½

## è³‡æ–™åº«è¡¨æ ¼

ç³»çµ±æœƒè‡ªå‹•å»ºç«‹ä»¥ä¸‹è¡¨æ ¼ï¼š

| è¡¨æ ¼ | èªªæ˜ |
|------|------|
| users | ç”¨æˆ¶è³‡æ–™ (LINE Login) |
| watchlists | è¿½è¹¤æ¸…å–® |
| stock_prices | è‚¡åƒ¹å¿«å– |
| crypto_prices | å¹£åƒ¹å¿«å– |
| market_sentiment | å¸‚å ´æƒ…ç·’ |
| user_indicator_settings | ç”¨æˆ¶æŒ‡æ¨™è¨­å®š |
| user_alert_settings | ç”¨æˆ¶é€šçŸ¥è¨­å®š |
| user_indicator_params | ç”¨æˆ¶åƒæ•¸è¨­å®š |
| notifications | é€šçŸ¥è¨˜éŒ„ |

## æ³¨æ„äº‹é …

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šè¡¨æ ¼æœƒè‡ªå‹•å»ºç«‹ï¼Œä¸éœ€è¦æ‰‹å‹•åŸ·è¡Œ migration

2. **postgres:// vs postgresql://**ï¼š
   - Railway ä½¿ç”¨ `postgres://`
   - SQLAlchemy éœ€è¦ `postgresql://`
   - ç¨‹å¼å·²è‡ªå‹•è™•ç†è½‰æ›

3. **é€£ç·šæ± **ï¼š
   - ä½¿ç”¨ `NullPool` é¿å…é€£ç·šå•é¡Œ
   - é©åˆ Railway çš„ serverless ç’°å¢ƒ

## æ•…éšœæ’é™¤

### é€£ç·šå¤±æ•—
- ç¢ºèª DATABASE_URL æ­£ç¢º
- ç¢ºèª PostgreSQL æœå‹™æ­£åœ¨é‹è¡Œ

### è¡¨æ ¼ä¸å­˜åœ¨
- æª¢æŸ¥æ—¥èªŒç¢ºèª "Database initialized" è¨Šæ¯
- å˜—è©¦é‡æ–°éƒ¨ç½²

### SSL éŒ¯èª¤
å¦‚æœé‡åˆ° SSL éŒ¯èª¤ï¼Œåœ¨ DATABASE_URL å¾Œé¢åŠ ä¸Šï¼š
```
?sslmode=require
```
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ runtime.txt  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```text
python-3.11.0
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ scripts/åŒ¯æ•´å­ç¨‹å¼.py  â­
> å°ˆæ¡ˆæ•´åˆå·¥å…· - æŠŠè³‡æ–™å¤¾çµæ§‹å’Œç¨‹å¼ç¢¼æ•´åˆæˆå–®ä¸€æª”æ¡ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
#!/usr/bin/env python3
"""
å°ˆæ¡ˆæ•´åˆå·¥å…· - æŠŠè³‡æ–™å¤¾çµæ§‹å’Œç¨‹å¼ç¢¼æ•´åˆæˆå–®ä¸€æª”æ¡ˆ
ç”¨é€”ï¼šä¸Šå‚³åˆ° Claude å°ˆæ¡ˆä½œç‚º context
"""

import os
from pathlib import Path
from datetime import datetime

# ===== è¨­å®š =====
IGNORE_DIRS = {'.git', '__pycache__', '.venv', 'venv', 'node_modules', '.idea', '.vscode', 'dist', 'build', '__MACOSX'}
IGNORE_FILES = {'.DS_Store', 'Thumbs.db', '.gitignore', '*.pyc', '*.pyo'}
CODE_EXTENSIONS = {'.py', '.js', '.ts', '.html', '.css', '.json', '.yaml', '.yml', '.md', '.txt', '.sql', '.sh', '.env.example'}
MAX_FILE_SIZE = 100 * 1024  # 100KBï¼Œè¶…éçš„æª”æ¡ˆåªé¡¯ç¤ºè·¯å¾‘ä¸é¡¯ç¤ºå…§å®¹


def should_ignore(path: Path) -> bool:
    """åˆ¤æ–·æ˜¯å¦è¦å¿½ç•¥æ­¤è·¯å¾‘"""
    if path.name in IGNORE_DIRS or path.name in IGNORE_FILES:
        return True
    if path.name.startswith('.') and path.name not in {'.env.example'}:
        return True
    return False


def generate_tree(root: Path, prefix: str = "") -> list[str]:
    """ç”¢ç”Ÿç›®éŒ„æ¨¹ç‹€åœ–"""
    lines = []
    items = sorted(root.iterdir(), key=lambda x: (x.is_file(), x.name.lower()))
    items = [x for x in items if not should_ignore(x)]
    
    for i, item in enumerate(items):
        is_last = i == len(items) - 1
        connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
        
        if item.is_dir():
            lines.append(f"{prefix}{connector}{item.name}/")
            extension = "    " if is_last else "â”‚   "
            lines.extend(generate_tree(item, prefix + extension))
        else:
            lines.append(f"{prefix}{connector}{item.name}")
    
    return lines


def collect_files(root: Path) -> list[Path]:
    """æ”¶é›†æ‰€æœ‰ç¨‹å¼ç¢¼æª”æ¡ˆ"""
    files = []
    for path in root.rglob('*'):
        if path.is_file() and not should_ignore(path):
            # æª¢æŸ¥çˆ¶ç›®éŒ„æ˜¯å¦åœ¨å¿½ç•¥æ¸…å–®
            if any(p.name in IGNORE_DIRS for p in path.parents):
                continue
            if path.suffix.lower() in CODE_EXTENSIONS or path.name in {'Dockerfile', 'Makefile', 'requirements.txt', 'Procfile'}:
                files.append(path)
    return sorted(files, key=lambda x: str(x).lower())


def bundle_project(target_dir: str, output_file: str = None):
    """ä¸»ç¨‹å¼ï¼šæ•´åˆå°ˆæ¡ˆ"""
    root = Path(target_dir).resolve()
    
    if not root.exists():
        print(f"âŒ æ‰¾ä¸åˆ°è³‡æ–™å¤¾: {root}")
        return
    
    if output_file is None:
        output_file = f"{root.name}_bundle.txt"
    
    output_path = Path(output_file).resolve()
    
    with open(output_path, 'w', encoding='utf-8') as out:
        # æ¨™é¡Œ
        out.write(f"{'='*70}\n")
        out.write(f"å°ˆæ¡ˆåç¨±: {root.name}\n")
        out.write(f"æ•´åˆæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        out.write(f"{'='*70}\n\n")
        
        # ç›®éŒ„çµæ§‹
        out.write("## ç›®éŒ„çµæ§‹\n\n")
        out.write("```\n")
        out.write(f"{root.name}/\n")
        for line in generate_tree(root):
            out.write(f"{line}\n")
        out.write("```\n\n")
        
        # æª”æ¡ˆå…§å®¹
        out.write(f"{'='*70}\n")
        out.write("## æª”æ¡ˆå…§å®¹\n")
        out.write(f"{'='*70}\n\n")
        
        files = collect_files(root)
        
        for filepath in files:
            rel_path = filepath.relative_to(root)
            out.write(f"\n{'â”€'*70}\n")
            out.write(f"### {rel_path}\n")
            out.write(f"{'â”€'*70}\n\n")
            
            # æª¢æŸ¥æª”æ¡ˆå¤§å°
            if filepath.stat().st_size > MAX_FILE_SIZE:
                out.write(f"ï¼ˆæª”æ¡ˆéå¤§ï¼Œç•¥éå…§å®¹ï¼š{filepath.stat().st_size / 1024:.1f} KBï¼‰\n")
                continue
            
            try:
                content = filepath.read_text(encoding='utf-8')
                # æ ¹æ“šå‰¯æª”ååŠ ä¸Š code block
                lang = filepath.suffix.lstrip('.') or 'text'
                if lang == 'txt':
                    lang = 'text'
                out.write(f"```{lang}\n")
                out.write(content)
                if not content.endswith('\n'):
                    out.write('\n')
                out.write("```\n")
            except UnicodeDecodeError:
                out.write("ï¼ˆäºŒé€²ä½æª”æ¡ˆï¼Œç•¥éï¼‰\n")
            except Exception as e:
                out.write(f"ï¼ˆè®€å–éŒ¯èª¤ï¼š{e}ï¼‰\n")
        
        # çµ±è¨ˆ
        out.write(f"\n{'='*70}\n")
        out.write(f"## çµ±è¨ˆ\n")
        out.write(f"å…± {len(files)} å€‹æª”æ¡ˆ\n")
        out.write(f"{'='*70}\n")
    
    print(f"âœ… å®Œæˆï¼è¼¸å‡ºæª”æ¡ˆ: {output_path}")
    print(f"   å…±æ•´åˆ {len(files)} å€‹æª”æ¡ˆ")


if __name__ == "__main__":
    import sys
    
    if len(sys.argv) < 2:
        # é è¨­ä½¿ç”¨ç›®å‰ç›®éŒ„
        target = "."
    else:
        target = sys.argv[1]
    
    output = sys.argv[2] if len(sys.argv) > 2 else None
    bundle_project(target, output)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ åŒ¯æ•´å°ˆæ¡ˆ V2 .py  â­
> å°ˆæ¡ˆæ•´åˆå·¥å…· v2 - æ™ºèƒ½åˆ†å±¤æ•´ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
#!/usr/bin/env python3
"""
å°ˆæ¡ˆæ•´åˆå·¥å…· v2 - æ™ºèƒ½åˆ†å±¤æ•´ç†
ç”¨é€”ï¼šä¸Šå‚³åˆ° Claude å°ˆæ¡ˆä½œç‚º contextï¼Œçµæ§‹åŒ–ä¾¿æ–¼é–±è®€
"""

import os
import re
from pathlib import Path
from datetime import datetime
from collections import defaultdict

# ===== è¨­å®š =====
IGNORE_DIRS = {'.git', '__pycache__', '.venv', 'venv', 'node_modules', '.idea', '.vscode', 'dist', 'build', '__MACOSX', '.pytest_cache', 'htmlcov'}
IGNORE_FILES = {'.DS_Store', 'Thumbs.db', '*.pyc', '*.pyo', '*.so', '*.egg-info'}
CODE_EXTENSIONS = {'.py', '.js', '.ts', '.jsx', '.tsx', '.html', '.css', '.json', '.yaml', '.yml', '.md', '.txt', '.sql', '.sh', '.env.example', '.toml'}
MAX_FILE_SIZE = 100 * 1024  # 100KB

# ===== åˆ†å±¤å®šç¾© =====
# å„ªå…ˆé †åºï¼šæ•¸å­—è¶Šå°è¶Šå‰é¢
LAYER_RULES = {
    # ç¬¬ 1 å±¤ï¼šå°ˆæ¡ˆæ¦‚è¿°
    'overview': {
        'order': 1,
        'title': 'ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°',
        'patterns': ['README*', 'CHANGELOG*', 'LICENSE*', 'docs/*', 'doc/*'],
        'files': {
            # åŸºæœ¬
            'readme.md', 'readme.txt', 'changelog.md', 'license', 'license.md',
            # é–‹ç™¼æ–‡æª”
            'troubleshooting.md', 'trouble_shooting.md', 'faq.md',
            'architecture.md', 'design.md', 'structure.md',
            'setup.md', 'install.md', 'installation.md',
            'development.md', 'dev.md', 'dev_notes.md', 'notes.md',
            'deployment.md', 'deploy.md',
            'contributing.md', 'contribute.md',
            'api.md', 'api_docs.md', 'endpoints.md',
            'todo.md', 'roadmap.md', 'plan.md',
            'guide.md', 'usage.md', 'manual.md',
            # ä¸­æ–‡å¸¸è¦‹
            'èªªæ˜.md', 'é–‹ç™¼ç­†è¨˜.md', 'å•é¡Œæ’è§£.md', 'æ¶æ§‹.md',
        },
    },
    # ç¬¬ 2 å±¤ï¼šè¨­å®šæª”
    'config': {
        'order': 2,
        'title': 'âš™ï¸ è¨­å®šæª”',
        'patterns': ['*.toml', '*.yaml', '*.yml', '.env*', 'config/*', 'settings/*'],
        'files': {'pyproject.toml', 'package.json', 'requirements.txt', 'dockerfile', 'docker-compose.yml', 'makefile', 'procfile', '.env.example', 'config.py', 'settings.py'},
    },
    # ç¬¬ 3 å±¤ï¼šé€²å…¥é»
    'entry': {
        'order': 3,
        'title': 'ğŸš€ ç¨‹å¼é€²å…¥é»',
        'patterns': [],
        'files': {'main.py', 'app.py', 'index.py', 'server.py', 'run.py', 'index.js', 'index.ts', 'app.js', 'server.js'},
    },
    # ç¬¬ 4 å±¤ï¼šè·¯ç”±/API
    'api': {
        'order': 4,
        'title': 'ğŸŒ API / è·¯ç”±',
        'patterns': ['routes/*', 'routers/*', 'api/*', 'endpoints/*', 'views/*'],
        'files': {'routes.py', 'router.py', 'api.py', 'urls.py'},
    },
    # ç¬¬ 5 å±¤ï¼šè³‡æ–™æ¨¡å‹
    'models': {
        'order': 5,
        'title': 'ğŸ“¦ è³‡æ–™æ¨¡å‹',
        'patterns': ['models/*', 'schemas/*', 'entities/*', 'types/*'],
        'files': {'models.py', 'schemas.py', 'database.py', 'db.py'},
    },
    # ç¬¬ 6 å±¤ï¼šæ ¸å¿ƒé‚è¼¯
    'core': {
        'order': 6,
        'title': 'ğŸ§  æ ¸å¿ƒé‚è¼¯',
        'patterns': ['core/*', 'services/*', 'handlers/*', 'controllers/*', 'lib/*'],
        'files': {'service.py', 'services.py', 'handler.py', 'controller.py'},
    },
    # ç¬¬ 7 å±¤ï¼šå·¥å…·/è¼”åŠ©
    'utils': {
        'order': 7,
        'title': 'ğŸ”§ å·¥å…· / è¼”åŠ©',
        'patterns': ['utils/*', 'helpers/*', 'common/*', 'shared/*'],
        'files': {'utils.py', 'helpers.py', 'common.py', 'tools.py'},
    },
    # ç¬¬ 8 å±¤ï¼šå‰ç«¯/éœæ…‹
    'frontend': {
        'order': 8,
        'title': 'ğŸ¨ å‰ç«¯ / éœæ…‹è³‡æº',
        'patterns': ['static/*', 'public/*', 'templates/*', 'assets/*', 'frontend/*', 'src/*'],
        'files': set(),
        'extensions': {'.html', '.css', '.js', '.jsx', '.tsx', '.vue', '.svelte'},
    },
    # ç¬¬ 9 å±¤ï¼šæ¸¬è©¦
    'tests': {
        'order': 9,
        'title': 'ğŸ§ª æ¸¬è©¦',
        'patterns': ['tests/*', 'test/*', '__tests__/*', 'spec/*'],
        'files': set(),
    },
    # ç¬¬ 10 å±¤ï¼šå…¶ä»–
    'other': {
        'order': 99,
        'title': 'ğŸ“ å…¶ä»–æª”æ¡ˆ',
        'patterns': [],
        'files': set(),
    },
}


def should_ignore(path: Path) -> bool:
    """åˆ¤æ–·æ˜¯å¦è¦å¿½ç•¥æ­¤è·¯å¾‘"""
    name = path.name
    if name in IGNORE_DIRS or name in IGNORE_FILES:
        return True
    if name.startswith('.') and name not in {'.env.example', '.gitignore'}:
        return True
    for pattern in IGNORE_FILES:
        if '*' in pattern and name.endswith(pattern.replace('*', '')):
            return True
    return False


def match_pattern(rel_path: str, patterns: list) -> bool:
    """æª¢æŸ¥è·¯å¾‘æ˜¯å¦ç¬¦åˆ pattern"""
    rel_lower = rel_path.lower()
    for pattern in patterns:
        pattern_lower = pattern.lower()
        if pattern_lower.endswith('/*'):
            # è³‡æ–™å¤¾ pattern
            folder = pattern_lower[:-2]
            if rel_lower.startswith(folder + '/') or ('/' + folder + '/') in rel_lower:
                return True
        elif '*' in pattern_lower:
            # è¬ç”¨å­—å…ƒ
            regex = pattern_lower.replace('*', '.*')
            if re.match(regex, rel_lower):
                return True
        else:
            if rel_lower == pattern_lower:
                return True
    return False


def classify_file(filepath: Path, root: Path) -> str:
    """åˆ†é¡æª”æ¡ˆåˆ°å°æ‡‰å±¤ç´š"""
    rel_path = str(filepath.relative_to(root))
    filename = filepath.name.lower()
    ext = filepath.suffix.lower()
    
    for layer_id, layer in LAYER_RULES.items():
        # 1. æª¢æŸ¥æª”å
        if filename in layer['files']:
            return layer_id
        
        # 2. æª¢æŸ¥è·¯å¾‘ pattern
        if match_pattern(rel_path, layer['patterns']):
            return layer_id
        
        # 3. æª¢æŸ¥å‰¯æª”åï¼ˆåƒ… frontend å±¤ï¼‰
        if layer_id == 'frontend' and ext in layer.get('extensions', set()):
            # ä½†è¦æ’é™¤å·²ç¶“è¢«å…¶ä»–è¦å‰‡åŒ¹é…çš„
            if '/static/' in rel_path.lower() or '/templates/' in rel_path.lower() or '/public/' in rel_path.lower():
                return layer_id
    
    # ç‰¹æ®Šåˆ¤æ–·ï¼štest æª”æ¡ˆ
    if 'test' in filename or filename.startswith('test_') or filename.endswith('_test.py'):
        return 'tests'
    
    return 'other'


def generate_tree(root: Path, prefix: str = "") -> list[str]:
    """ç”¢ç”Ÿç›®éŒ„æ¨¹ç‹€åœ–"""
    lines = []
    try:
        items = sorted(root.iterdir(), key=lambda x: (x.is_file(), x.name.lower()))
    except PermissionError:
        return lines
    
    items = [x for x in items if not should_ignore(x)]
    
    for i, item in enumerate(items):
        is_last = i == len(items) - 1
        connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
        
        if item.is_dir():
            lines.append(f"{prefix}{connector}{item.name}/")
            extension = "    " if is_last else "â”‚   "
            lines.extend(generate_tree(item, prefix + extension))
        else:
            lines.append(f"{prefix}{connector}{item.name}")
    
    return lines


def collect_files(root: Path) -> list[Path]:
    """æ”¶é›†æ‰€æœ‰ç¨‹å¼ç¢¼æª”æ¡ˆ"""
    files = []
    for path in root.rglob('*'):
        if path.is_file() and not should_ignore(path):
            if any(p.name in IGNORE_DIRS for p in path.parents):
                continue
            if path.suffix.lower() in CODE_EXTENSIONS or path.name.lower() in {'dockerfile', 'makefile', 'requirements.txt', 'procfile', 'license'}:
                files.append(path)
    return files


def estimate_importance(filepath: Path, layer: str) -> str:
    """ä¼°ç®—æª”æ¡ˆé‡è¦åº¦"""
    filename = filepath.name.lower()
    
    # é«˜é‡è¦åº¦
    if layer in ('entry', 'overview'):
        return 'â­â­â­'
    if layer == 'config' and filename in {'pyproject.toml', 'package.json', 'requirements.txt'}:
        return 'â­â­â­'
    if layer == 'api':
        return 'â­â­â­'
    if layer == 'models':
        return 'â­â­'
    if layer == 'core':
        return 'â­â­â­'
    
    # ä¸­é‡è¦åº¦
    if layer in ('config', 'models'):
        return 'â­â­'
    
    # ä½é‡è¦åº¦
    if layer in ('utils', 'tests', 'other'):
        return 'â­'
    if layer == 'frontend':
        return 'â­'
    
    return 'â­'


def get_file_description(filepath: Path) -> str:
    """å˜—è©¦å¾æª”æ¡ˆå–å¾—æè¿°ï¼ˆdocstring æˆ–ç¬¬ä¸€è¡Œè¨»è§£ï¼‰"""
    try:
        content = filepath.read_text(encoding='utf-8')
        lines = content.split('\n')
        
        # Python docstring
        if filepath.suffix == '.py':
            for i, line in enumerate(lines[:10]):
                if '"""' in line or "'''" in line:
                    # å–®è¡Œ docstring
                    match = re.search(r'["\'\s]{3}(.+?)["\'\s]{3}', line)
                    if match:
                        return match.group(1).strip()[:60]
                    # å¤šè¡Œ docstring
                    for j in range(i+1, min(i+5, len(lines))):
                        if lines[j].strip() and not lines[j].strip().startswith(('"""', "'''")):
                            return lines[j].strip()[:60]
                    break
        
        # ç¬¬ä¸€è¡Œè¨»è§£
        for line in lines[:5]:
            line = line.strip()
            if line.startswith('#') and len(line) > 2:
                return line[1:].strip()[:60]
            if line.startswith('//') and len(line) > 3:
                return line[2:].strip()[:60]
            if line.startswith('/*'):
                return line[2:].replace('*/', '').strip()[:60]
    except:
        pass
    return ''


def bundle_project(target_dir: str, output_file: str = None, split_output: bool = False):
    """ä¸»ç¨‹å¼ï¼šæ•´åˆå°ˆæ¡ˆ"""
    root = Path(target_dir).resolve()
    
    if not root.exists():
        print(f"âŒ æ‰¾ä¸åˆ°è³‡æ–™å¤¾: {root}")
        return
    
    if output_file is None:
        timestamp = datetime.now().strftime('%Y%m%d_%H%M')
        output_file = f"{root.name}_bundle_{timestamp}.txt"
    
    output_path = Path(output_file).resolve()
    
    # æ”¶é›†ä¸¦åˆ†é¡æª”æ¡ˆ
    all_files = collect_files(root)
    layers = defaultdict(list)
    
    for f in all_files:
        layer = classify_file(f, root)
        layers[layer].append(f)
    
    # æ’åºæ¯å±¤å…§çš„æª”æ¡ˆ
    for layer in layers:
        layers[layer].sort(key=lambda x: str(x).lower())
    
    # é–‹å§‹è¼¸å‡º
    with open(output_path, 'w', encoding='utf-8') as out:
        # ===== æ¨™é¡Œ =====
        out.write(f"{'='*70}\n")
        out.write(f"# å°ˆæ¡ˆï¼š{root.name}\n")
        out.write(f"# æ•´åˆæ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        out.write(f"# æª”æ¡ˆæ•¸é‡ï¼š{len(all_files)}\n")
        out.write(f"{'='*70}\n\n")
        
        # ===== ç›®éŒ„çµæ§‹ =====
        out.write("## ğŸ“‚ ç›®éŒ„çµæ§‹\n\n")
        out.write("```\n")
        out.write(f"{root.name}/\n")
        for line in generate_tree(root):
            out.write(f"{line}\n")
        out.write("```\n\n")
        
        # ===== æª”æ¡ˆç´¢å¼• =====
        out.write(f"{'='*70}\n")
        out.write("## ğŸ“‘ æª”æ¡ˆç´¢å¼•\n\n")
        out.write("| å±¤ç´š | æª”æ¡ˆ | èªªæ˜ | é‡è¦åº¦ |\n")
        out.write("|------|------|------|--------|\n")
        
        sorted_layers = sorted(LAYER_RULES.items(), key=lambda x: x[1]['order'])
        for layer_id, layer_info in sorted_layers:
            if layer_id not in layers:
                continue
            for f in layers[layer_id]:
                rel = f.relative_to(root)
                desc = get_file_description(f)
                importance = estimate_importance(f, layer_id)
                layer_emoji = layer_info['title'].split()[0]
                out.write(f"| {layer_emoji} | `{rel}` | {desc} | {importance} |\n")
        out.write("\n")
        
        # ===== åˆ†å±¤å…§å®¹ =====
        for layer_id, layer_info in sorted_layers:
            if layer_id not in layers:
                continue
            
            out.write(f"\n{'='*70}\n")
            out.write(f"## {layer_info['title']}\n")
            out.write(f"{'='*70}\n")
            
            for filepath in layers[layer_id]:
                rel_path = filepath.relative_to(root)
                importance = estimate_importance(filepath, layer_id)
                desc = get_file_description(filepath)
                
                out.write(f"\n{'â”€'*70}\n")
                out.write(f"### ğŸ“„ {rel_path}  {importance}\n")
                if desc:
                    out.write(f"> {desc}\n")
                out.write(f"{'â”€'*70}\n\n")
                
                # æª¢æŸ¥æª”æ¡ˆå¤§å°
                if filepath.stat().st_size > MAX_FILE_SIZE:
                    out.write(f"âš ï¸ æª”æ¡ˆéå¤§ï¼Œç•¥éå…§å®¹ï¼ˆ{filepath.stat().st_size / 1024:.1f} KBï¼‰\n")
                    continue
                
                try:
                    content = filepath.read_text(encoding='utf-8')
                    lang = filepath.suffix.lstrip('.') or 'text'
                    lang_map = {'txt': 'text', 'yml': 'yaml'}
                    lang = lang_map.get(lang, lang)
                    
                    out.write(f"```{lang}\n")
                    out.write(content)
                    if not content.endswith('\n'):
                        out.write('\n')
                    out.write("```\n")
                except UnicodeDecodeError:
                    out.write("âš ï¸ äºŒé€²ä½æª”æ¡ˆï¼Œç•¥é\n")
                except Exception as e:
                    out.write(f"âš ï¸ è®€å–éŒ¯èª¤ï¼š{e}\n")
        
        # ===== çµ±è¨ˆ =====
        out.write(f"\n{'='*70}\n")
        out.write("## ğŸ“Š çµ±è¨ˆ\n\n")
        for layer_id, layer_info in sorted_layers:
            if layer_id in layers:
                out.write(f"- {layer_info['title']}ï¼š{len(layers[layer_id])} å€‹æª”æ¡ˆ\n")
        out.write(f"\n**ç¸½è¨ˆï¼š{len(all_files)} å€‹æª”æ¡ˆ**\n")
        out.write(f"{'='*70}\n")
    
    print(f"âœ… å®Œæˆï¼è¼¸å‡ºæª”æ¡ˆ: {output_path}")
    print(f"   å…±æ•´åˆ {len(all_files)} å€‹æª”æ¡ˆ")
    print(f"\nğŸ“Š åˆ†å±¤çµ±è¨ˆ:")
    for layer_id, layer_info in sorted_layers:
        if layer_id in layers:
            print(f"   {layer_info['title']}ï¼š{len(layers[layer_id])} å€‹")


if __name__ == "__main__":
    import sys
    
    print("=" * 50)
    print("ğŸ“¦ å°ˆæ¡ˆæ•´åˆå·¥å…· v2")
    print("=" * 50)
    
    if len(sys.argv) < 2:
        target = "."
        print(f"ä½¿ç”¨ç›®å‰ç›®éŒ„: {Path(target).resolve()}")
    else:
        target = sys.argv[1]
    
    output = sys.argv[2] if len(sys.argv) > 2 else None
    bundle_project(target, output)
```

======================================================================
## ğŸ“Š çµ±è¨ˆ

- ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°ï¼š9 å€‹æª”æ¡ˆ
- âš™ï¸ è¨­å®šæª”ï¼š4 å€‹æª”æ¡ˆ
- ğŸš€ ç¨‹å¼é€²å…¥é»ï¼š1 å€‹æª”æ¡ˆ
- ğŸŒ API / è·¯ç”±ï¼š10 å€‹æª”æ¡ˆ
- ğŸ“¦ è³‡æ–™æ¨¡å‹ï¼š15 å€‹æª”æ¡ˆ
- ğŸ§  æ ¸å¿ƒé‚è¼¯ï¼š14 å€‹æª”æ¡ˆ
- ğŸ¨ å‰ç«¯ / éœæ…‹è³‡æºï¼š11 å€‹æª”æ¡ˆ
- ğŸ“ å…¶ä»–æª”æ¡ˆï¼š18 å€‹æª”æ¡ˆ

**ç¸½è¨ˆï¼š82 å€‹æª”æ¡ˆ**
======================================================================
