# SELA 自動選股系統 - 交班紀錄
**日期**: 2026-01-15 23:30
**版本**: v0.8.2

---

## ✅ 本次已完成修正

### 1. 股票詳情技術指標消失問題
**問題**: 查詢股票時只返回快取的簡化資料，沒有圖表和完整指標
**原因**: `stock.py` 的快取邏輯錯誤，快取命中時直接返回簡化資料
**修正**: 
- 移除股票詳情查詢的快取返回邏輯
- 永遠從 Yahoo Finance 取得完整資料（含圖表、所有指標）
- 查詢完成後自動更新價格快取（供追蹤清單使用）
**檔案**: `app/routers/stock.py`

### 2. 訂閱按鈕沒反應
**問題**: 點擊訂閱/取消訂閱按鈕無反應
**原因**: `onclick` 未正確綁定到全域函數
**修正**: 改用 `window.toggleSubscription` 確保函數可被呼叫
**檔案**: `static/js/subscription.js`

### 3. 訂閱精選日期顯示錯誤
**問題**: 顯示的是抓取日期而非文章發佈日期
**修正**: 優先使用 `article_date`（文章發佈日），而非 `first_seen_at`
**檔案**: `static/js/subscription.js`

### 4. 管理員工具缺少「更新訂閱」功能
**問題**: 設定頁面沒有手動觸發訂閱抓取的按鈕
**修正**: 
- 在 `settings.js` 新增 `adminFetchSubscriptions()` 函數
- 在 `dashboard.html` 新增「管理員工具」區塊，包含三個按鈕：
  - 更新價格快取
  - 更新匯率
  - 抓取訂閱精選（回溯30天）
**檔案**: `static/js/settings.js`, `static/dashboard.html`

### 5. 追蹤清單 MA20 排序消失
**問題**: 排序選項沒有 MA20 距離
**修正**: 新增「MA20距離」排序選項，計算價格與 MA20 的差距百分比
**檔案**: `static/js/watchlist.js`

### 6. 快速新增追蹤提示消失
**問題**: 從訂閱精選點「+」加入追蹤沒有提示
**修正**: 在 `watchlist.js` 新增 `quickAddToWatchlist()` 函數並導出到全域
**檔案**: `static/js/watchlist.js`

---

## 📦 已產出的檔案

| 檔案 | 用途 | 部署位置 |
|------|------|----------|
| `stock.py` | 後端股票查詢修正 | `app/routers/stock.py` |
| `frontend_fix_20260115.zip` | 前端修正包 | 解壓到 `static/` |

### frontend_fix_20260115.zip 內容
```
js/subscription.js   ← 訂閱功能修正
js/settings.js       ← 管理員工具函數
js/watchlist.js      ← MA20排序 + quickAdd
dashboard.html       ← 管理員工具區塊
```

---

## ⚠️ 已知問題（未修）

### 1. Railway 部署卡住
- 現象: "Taking a snapshot of the code" 卡住 24+ 分鐘
- 解法: 取消重新部署，或檢查 Railway 狀態 https://status.railway.app

### 2. index_service 模組不存在
```
ModuleNotFoundError: No module named 'app.services.index_service'
```
- 位置: `app/routers/admin.py` 第 967 行
- 影響: `/api/admin/update-indices` API 會報錯
- 建議: 確認是否需要此功能，若不需要可移除相關 import

### 3. 訂閱精選沒有自動更新
- 原因: 排程可能沒有正確執行
- 解法: 已加入手動觸發按鈕，管理員可在「設定」頁面手動抓取

---

## 📋 待辦事項 (P1)

| # | 項目 | 狀態 |
|---|------|------|
| 1 | 訂閱精選前端 Tab | ✅ 已完成基本功能 |
| 2 | 追蹤清單匯出匯入 | 待開發 |
| 3 | 持股交易匯出匯入 | 待開發 |
| 4 | 追蹤清單分組 Tag | 待開發 |
| 5 | 到價提醒變色 | ✅ 已完成 |
| 6 | stock_info 種子表 | 待開發 |

---

## 🔧 部署步驟

### 後端
```bash
# 替換 stock.py
cp stock.py app/routers/stock.py
```

### 前端
```bash
# 解壓前端修正包
unzip frontend_fix_20260115.zip -d static/
```

### 部署後驗證
1. 查詢股票 → 應顯示完整技術指標和圖表
2. 追蹤清單 → 排序應有「MA20距離」選項
3. 訂閱精選 → 點「+」應顯示「XXX 已加入追蹤清單」
4. 設定頁面 → 應看到「管理員工具」區塊
5. 管理員工具 → 點「抓取訂閱精選」應抓取最新文章

---

## 📝 備註

- Railway 免費方案每月約 500 小時，注意用量
- 資料庫遷移必須透過 `database.py` 的 `run_migrations()` 執行
- LINE Login 多環境部署需在 LINE Developers Console 添加對應 Callback URL
