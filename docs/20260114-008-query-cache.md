# æŸ¥è©¢çµæœå¿«å–åŠŸèƒ½

> æ–‡ä»¶ç·¨è™Ÿ: 20260114-008-query-cache  
> å»ºç«‹æ—¥æœŸ: 2026-01-14

## åŠŸèƒ½èªªæ˜

å°‡æŸ¥è©¢éçš„è‚¡ç¥¨/åŠ å¯†è²¨å¹£è‡ªå‹•å¯«å…¥ `StockPriceCache` å¿«å–è¡¨ã€‚

### ç‰¹é»
- âœ… æŸ¥è©¢éçš„è‚¡ç¥¨æœƒè¢«å¿«å–
- âœ… æ‰€æœ‰ç”¨æˆ¶å…±ç”¨å¿«å–
- âŒ ä¸æœƒè‡ªå‹•æ›´æ–°ï¼ˆåªæœ‰è¿½è¹¤æ¸…å–®æ‰æœƒï¼‰
- âŒ ç®¡ç†å“¡ç™»å…¥åªæ›´æ–°è¿½è¹¤æ¸…å–®çš„è‚¡ç¥¨

---

## æ–°å¢æª”æ¡ˆ

### `app/services/cache_helper.py`

å·²åŒ…å«åœ¨ zip ä¸­ï¼Œç›´æ¥éƒ¨ç½²å³å¯ã€‚

---

## ä¿®æ”¹ç¾æœ‰æª”æ¡ˆ

### 1. `app/routers/stock.py`

åœ¨ `get_stock_analysis` å‡½æ•¸çš„ `return` èªå¥**ä¹‹å‰**åŠ å…¥ï¼š

```python
# === åœ¨ return ä¹‹å‰åŠ å…¥ä»¥ä¸‹ä»£ç¢¼ ===

# ğŸ†• å°‡æŸ¥è©¢çµæœå¯«å…¥å¿«å–
from app.services.cache_helper import cache_stock_price

day_change = calc_change(1)
prev_close = float(df.iloc[-2]['close_raw']) if len(df) > 1 else None
change_amount = current_price - prev_close if prev_close else None

cache_stock_price(
    symbol=symbol,
    name=stock_name,
    price=current_price,
    prev_close=prev_close,
    change=change_amount,
    change_pct=day_change,
    volume=volume_today
)

# === åŠ å…¥çµæŸ ===

return {
    "success": True,
    ...
```

å®Œæ•´ä½ç½®åƒè€ƒï¼ˆç´„åœ¨ç¬¬ 180-200 è¡Œï¼‰ï¼š

```python
        logger.info(f"{symbol} æŸ¥è©¢å®Œæˆï¼Œè©•åˆ†: {rating}")
        
        # ç¢ºä¿ name æ­£ç¢ºç²å–
        stock_name = ""
        if info:
            stock_name = info.get("name", "")
        if not stock_name:
            from app.data_sources.yahoo_finance import TAIWAN_STOCK_NAMES
            stock_code = symbol.replace(".TW", "").replace(".TWO", "")
            stock_name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
        
        # ğŸ†• === åŠ å…¥å¿«å–ä»£ç¢¼ START ===
        from app.services.cache_helper import cache_stock_price
        
        day_change = calc_change(1)
        prev_close = float(df.iloc[-2]['close_raw']) if len(df) > 1 else None
        change_amount = current_price - prev_close if prev_close else None
        
        cache_stock_price(
            symbol=symbol,
            name=stock_name,
            price=current_price,
            prev_close=prev_close,
            change=change_amount,
            change_pct=day_change,
            volume=volume_today
        )
        # ğŸ†• === åŠ å…¥å¿«å–ä»£ç¢¼ END ===
        
        return {
            "success": True,
            "symbol": symbol,
            ...
```

---

### 2. `app/routers/crypto.py`

åœ¨ `get_crypto_analysis` å‡½æ•¸çš„ `return` èªå¥**ä¹‹å‰**åŠ å…¥ï¼š

```python
# === åœ¨ return ä¹‹å‰åŠ å…¥ä»¥ä¸‹ä»£ç¢¼ ===

# ğŸ†• å°‡æŸ¥è©¢çµæœå¯«å…¥å¿«å–
from app.services.cache_helper import cache_crypto_price

cache_crypto_price(
    symbol=symbol,
    name=info.get("name", symbol) if info else symbol,
    price=current_price,
    change_pct=calc_change(1),
    volume=info.get("total_volume") if info else None
)

# === åŠ å…¥çµæŸ ===

return {
    "success": True,
    ...
```

---

## é©—è­‰æ–¹å¼

1. æŸ¥è©¢ä¸€å€‹æ–°è‚¡ç¥¨ï¼ˆå¦‚ NVDAï¼‰
2. æª¢æŸ¥è³‡æ–™åº«ï¼š
   ```sql
   SELECT * FROM stock_price_cache WHERE symbol = 'NVDA';
   ```
3. æ‡‰è©²çœ‹åˆ°å‰›æ‰æŸ¥è©¢çš„åƒ¹æ ¼å·²è¢«å¿«å–

---

## è³‡æ–™æµç¨‹

```
ç”¨æˆ¶æŸ¥è©¢ AAPL
    â”‚
    â”œâ”€â–º Yahoo Finance API å–å¾—è³‡æ–™
    â”‚
    â”œâ”€â–º è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
    â”‚
    â”œâ”€â–º ğŸ†• å¯«å…¥ StockPriceCacheï¼ˆæ–°å¢ï¼‰
    â”‚
    â””â”€â–º å›å‚³çµæœçµ¦å‰ç«¯


ç®¡ç†å“¡ç™»å…¥
    â”‚
    â””â”€â–º æ›´æ–°è¿½è¹¤æ¸…å–®çš„è‚¡ç¥¨ï¼ˆå¾ Watchlist è¡¨æ’ˆï¼‰
        â”‚
        â””â”€â–º ä¸æœƒæ›´æ–°ã€ŒåªæŸ¥è©¢éã€çš„è‚¡ç¥¨ âœ“
```

---

## æ³¨æ„äº‹é …

1. `cache_helper.py` ä½¿ç”¨ try-except åŒ…è£ï¼Œå¿«å–å¤±æ•—ä¸å½±éŸ¿æŸ¥è©¢
2. å¿«å–å¯«å…¥æ˜¯åŒæ­¥çš„ï¼Œä½†å¾ˆå¿«ï¼ˆå–®æ¬¡è³‡æ–™åº« upsertï¼‰
3. å¦‚æœæœªä¾†éœ€è¦éåŒæ­¥ï¼Œå¯æ”¹ç”¨ `background_tasks.add_task()`
