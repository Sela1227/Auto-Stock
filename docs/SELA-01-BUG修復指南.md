# ðŸ”§ SELA Bug ä¿®å¾©æŒ‡å—

> ç‰ˆæœ¬: v0.9.1  
> æœ€å¾Œæ›´æ–°: 2026-01-12  
> é©ç”¨å°ˆæ¡ˆ: SELA å¤šç”¨æˆ¶é¸è‚¡åˆ†æžç³»çµ±

---

## ðŸ“‹ ä¿®å¾©æ¸…å–®ç¸½è¦½

| # | å•é¡Œ | å„ªå…ˆç´š | ç‹€æ…‹ |
|---|------|--------|------|
| 1 | å°è‚¡åç¨±é¡¯ç¤ºäº‚ç¢¼ | **ç·Šæ€¥** | å¾…ä¿®å¾© |
| 2 | BRK.B ç­‰å«é»žè™Ÿè‚¡ç¥¨æœå°‹å¤±æ•— | é«˜ | å¾…ä¿®å¾© |
| 3 | FIG ç­‰æ–° IPO è‚¡ç¥¨æ‰¾ä¸åˆ°æ•¸æ“š | é«˜ | å¾…ä¿®å¾© |

---

## ðŸ”´ Bug #1: å°è‚¡åç¨±ç·¨ç¢¼ä¿®å¾©ï¼ˆç·Šæ€¥ï¼‰

### å•é¡Œæè¿°

Bundle æ–‡ä»¶ä¸­çš„ `TAIWAN_STOCK_NAMES` å­—å…¸å·²ç¶“æ˜¯äº‚ç¢¼ï¼Œå°Žè‡´å°è‚¡åç¨±ç„¡æ³•æ­£ç¢ºé¡¯ç¤ºã€‚

**å•é¡Œç¾è±¡ï¼š**
```python
# ç¾åœ¨çš„ç‹€æ…‹ï¼ˆå·²æå£žï¼‰:
"2330": "ÃƒÂ¥Ã‚Ã‚Â°ÃƒÂ§Ã‚Â©Ã‚ÃƒÂ©Ã¢â‚¬ÂºÃ‚Â»"  # æ‡‰è©²æ˜¯ã€Œå°ç©é›»ã€
"0050": "Ã¥â€¦Æ’Ã¥Â¤Â§Ã¥Â°Ã§Â£50"        # æ‡‰è©²æ˜¯ã€Œå…ƒå¤§å°ç£50ã€
```

**åŽŸå› ï¼š** åœ¨æŸæ¬¡æª”æ¡ˆè™•ç†æ™‚ï¼ŒUTF-8 ç·¨ç¢¼è¢«ç ´å£žäº†ã€‚

### éœ€è¦ä¿®å¾©çš„æª”æ¡ˆ

| æª”æ¡ˆ | ä½ç½® | é‡è¦æ€§ |
|------|------|--------|
| `yahoo_finance.py` | `app/data_sources/` | **å¿…é ˆä¿®å¾©** |
| `price_cache_service.py` | `app/services/` | éœ€è¦ä¿®å¾© |

### ä¿®å¾©æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: ä¿®å¾© yahoo_finance.py

æ‰¾åˆ° `app/data_sources/yahoo_finance.py` ä¸­çš„ `TAIWAN_STOCK_NAMES = {...}`ï¼Œ**æ•´å€‹æ›¿æ›ç‚ºä»¥ä¸‹å…§å®¹ï¼š**

```python
TAIWAN_STOCK_NAMES = {
    # æ¬Šå€¼è‚¡
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äºž",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºžæ³¥",
    # é‡‘èžè‚¡
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "çŽ‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    # é›»å­è‚¡
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æŽ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘žæ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºžç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©Ž",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜Ž",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•èž",
    "5876": "ä¸Šæµ·å•†éŠ€",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘žå„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ETF
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­åž‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘èž",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "006208": "å¯Œé‚¦å°50",
    "00646": "å…ƒå¤§S&P500",
    "00662": "å¯Œé‚¦NASDAQ",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½Žæ³¢",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00891": "ä¸­ä¿¡é—œéµåŠå°Žé«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°Žé«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}
```

#### æ­¥é©Ÿ 2: åŒæ¨£ä¿®å¾© price_cache_service.py

æ‰¾åˆ° `app/services/price_cache_service.py` ä¸­çš„ `TAIWAN_STOCK_NAMES = {...}`ï¼Œç”¨ç›¸åŒçš„å­—å…¸æ›¿æ›ã€‚

#### æ­¥é©Ÿ 3: ç¢ºä¿ç·¨ç¢¼æ­£ç¢º

å„²å­˜æ™‚ç¢ºèªç·¨è¼¯å™¨ä½¿ç”¨ **UTF-8 without BOM** ç·¨ç¢¼ã€‚

### é©—è­‰æ–¹å¼

1. é–‹å•Ÿæ¯”è¼ƒé é¢
2. é¸æ“‡å°è‚¡ï¼ˆå¦‚ `2330.TW`ï¼‰
3. ç¢ºèªåç¨±é¡¯ç¤ºç‚ºã€Œå°ç©é›»ã€è€Œéžäº‚ç¢¼

### é é˜²æŽªæ–½

```bash
# Git è¨­å®š
git config --global core.quotepath false

# é¿å…ä½¿ç”¨ Windows è¨˜äº‹æœ¬ç·¨è¼¯ Python æª”æ¡ˆ
# æŽ¨è–¦ä½¿ç”¨ VS Code ä¸¦è¨­å®šç·¨ç¢¼ç‚º UTF-8
```

---

## ðŸŸ¡ Bug #2 & #3: è‚¡ç¥¨æœå°‹ä¿®å¾©

### å•é¡Œæè¿°

| è‚¡ç¥¨ | å•é¡Œç¾è±¡ | æ ¹æœ¬åŽŸå›  |
|------|----------|---------|
| BRK.B | æœå°‹è¿”å›ž 404 | URL ä¸­ `.B` è¢«è§£æžç‚ºå‰¯æª”å + Yahoo æ ¼å¼å•é¡Œ |
| FIG | æ‰¾ä¸åˆ°è‚¡ç¥¨ | 2024 IPO æ–°è‚¡ï¼Œåªæœ‰ 1 å¹´æ•¸æ“šï¼Œä½†ç³»çµ±è¦æ±‚ 10 å¹´ |

### éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ

- `app/routers/stock.py`

### ä¿®å¾©æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: ä¿®æ”¹è·¯ç”±å®šç¾©

æ‰¾åˆ°ç´„ç¬¬ **3706 è¡Œ**ï¼š

```python
# âŒ åŽŸæœ¬
@router.get("/{symbol}", summary="æŸ¥è©¢è‚¡ç¥¨")

# âœ… æ”¹ç‚º
@router.get("/{symbol:path}", summary="æŸ¥è©¢è‚¡ç¥¨")
```

#### æ­¥é©Ÿ 2: æ–°å¢žè‚¡ç¥¨ä»£ç¢¼è®Šé«”å‡½æ•¸

åœ¨ `normalize_tw_symbol` å‡½æ•¸å¾Œé¢åŠ å…¥ï¼š

```python
def get_symbol_variants(symbol: str) -> list:
    """
    ç”¢ç”Ÿè‚¡ç¥¨ä»£ç¢¼çš„è®Šé«”åˆ—è¡¨
    BRK.B -> ["BRK.B", "BRK-B"]
    """
    variants = [symbol]
    
    # å« `.` ä½†ä¸æ˜¯å°è‚¡ï¼Œä¹Ÿå˜—è©¦ `-` æ ¼å¼
    if '.' in symbol and not symbol.endswith('.TW') and not symbol.endswith('.TWO'):
        variants.append(symbol.replace('.', '-'))
    
    # å« `-`ï¼Œä¹Ÿå˜—è©¦ `.` æ ¼å¼
    if '-' in symbol:
        variants.append(symbol.replace('-', '.'))
    
    return variants
```

#### æ­¥é©Ÿ 3: ä¿®æ”¹æ­·å²æ•¸æ“šæŠ“å–é‚è¼¯

æ‰¾åˆ°ç´„ç¬¬ **3722-3741 è¡Œ**ï¼Œå°‡åŽŸæœ¬çš„ç¨‹å¼ç¢¼æ›¿æ›ç‚ºï¼š

```python
df = None
used_period = None
actual_symbol = symbol

# ç”¢ç”Ÿä»£ç¢¼è®Šé«”ï¼ˆBRK.B -> BRK-Bï¼‰
symbol_variants = get_symbol_variants(symbol)

# å˜—è©¦ä¸åŒæœŸé–“ï¼ˆè§£æ±ºæ–°è‚¡å•é¡Œï¼‰
periods = ["10y", "5y", "2y", "1y", "6mo", "3mo"]

for try_symbol in symbol_variants:
    if df is not None and len(df) >= 20:
        break
    for period in periods:
        logger.info(f"å˜—è©¦ {try_symbol} æœŸé–“ {period}...")
        df = yahoo_finance.get_stock_history(try_symbol, period=period)
        if df is not None and len(df) >= 20:
            used_period = period
            actual_symbol = try_symbol
            logger.info(f"æˆåŠŸ: {try_symbol} ä½¿ç”¨ {period}ï¼Œå…± {len(df)} ç­†")
            break

# å°è‚¡ .TW -> .TWO å˜—è©¦
if (df is None or len(df) < 20) and symbol.endswith('.TW'):
    two_symbol = symbol.replace('.TW', '.TWO')
    for period in periods:
        df = yahoo_finance.get_stock_history(two_symbol, period=period)
        if df is not None and len(df) >= 20:
            actual_symbol = two_symbol
            used_period = period
            break

if df is None or len(df) < 20:
    tried = ", ".join(set(symbol_variants))
    raise HTTPException(
        status_code=404,
        detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦: {tried}ï¼‰"
    )

# ä½¿ç”¨å¯¦éš›æ‰¾åˆ°çš„ symbol
symbol = actual_symbol
```

### é©—è­‰æ–¹å¼

| è¼¸å…¥ | é æœŸè¡Œç‚º |
|------|---------|
| `BRK.B` | è‡ªå‹•å˜—è©¦ BRK.B å’Œ BRK-B |
| `BRK-B` | è‡ªå‹•å˜—è©¦ BRK-B å’Œ BRK.B |
| `FIG` | è‡ªå‹•å˜—è©¦è¼ƒçŸ­æœŸé–“ï¼ˆ1y, 6moï¼‰|
| `AAPL` | æ­£å¸¸ï¼ˆ10yï¼‰|
| `2330` | æ­£å¸¸ï¼ˆè‡ªå‹•åŠ  .TWï¼‰|

### ç‰¹æ®Šè‚¡ç¥¨ä»£ç¢¼å°ç…§

| å…¬å¸ | Yahoo æ ¼å¼ | èªªæ˜Ž |
|------|-----------|------|
| Berkshire A | BRK-A æˆ– BRK.A | ç³»çµ±æœƒè‡ªå‹•å˜—è©¦å…©ç¨® |
| Berkshire B | BRK-B æˆ– BRK.B | ç³»çµ±æœƒè‡ªå‹•å˜—è©¦å…©ç¨® |
| Figma | FIG | 2024 IPOï¼Œéœ€ç”¨çŸ­æœŸé–“ |

---

## âš ï¸ é€šç”¨æ³¨æ„äº‹é …

1. **å‚™ä»½ç¾æœ‰æª”æ¡ˆå†ä¿®æ”¹**
2. **æ‰€æœ‰ Python æª”æ¡ˆå¿…é ˆä½¿ç”¨ UTF-8 ç·¨ç¢¼å„²å­˜**
3. **ä¿®æ”¹å¾Œé€²è¡Œå®Œæ•´æ¸¬è©¦**
4. **éƒ¨ç½²å‘½ä»¤ï¼š**

```bash
git add .
git commit -m "fix: å°è‚¡åç¨±ç·¨ç¢¼ + è‚¡ç¥¨æœå°‹ BRK.B/FIG"
git push
```

---

## âœ… å®Œæˆç¢ºèªæ¸…å–®

- [ ] yahoo_finance.py ä¸­çš„ TAIWAN_STOCK_NAMES å·²ä¿®å¾©
- [ ] price_cache_service.py ä¸­çš„ TAIWAN_STOCK_NAMES å·²ä¿®å¾©
- [ ] stock.py è·¯ç”±æ”¹ç‚º `{symbol:path}`
- [ ] get_symbol_variants å‡½æ•¸å·²åŠ å…¥
- [ ] æ­·å²æ•¸æ“šæŠ“å–é‚è¼¯å·²æ›´æ–°
- [ ] å°è‚¡åç¨±é¡¯ç¤ºæ­£å¸¸
- [ ] BRK.B æœå°‹æ­£å¸¸
- [ ] FIG æœå°‹æ­£å¸¸
