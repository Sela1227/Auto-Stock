# SELA é¸è‚¡ç³»çµ±é–‹ç™¼è¨˜éŒ„ - 2026-01-17

## ğŸ“‹ æœ¬æ¬¡é–‹ç™¼æ¦‚è¿°

æœ¬æ¬¡æ•´åˆäº†å¤šä»½æ–‡ä»¶ï¼Œä¸¦å®Œæˆä»¥ä¸‹ä¸»è¦ä»»å‹™ï¼š
1. **æ•ˆèƒ½å„ªåŒ–**ï¼šå¯¦ä½œå¸‚å ´æ„ŸçŸ¥å¿«å–ï¼ˆMarket-Aware Cachingï¼‰
2. **åœ–è¡¨åŠŸèƒ½ä¿®å¾©**ï¼šä¿®å¾©å…¨è¢å¹•åœ–è¡¨çš„å¤šå€‹ Bug
3. **å‰æ¬¡äº¤ç­ä¿®å¾©**ï¼šè‚¡ç¥¨è©³æƒ…ã€è¨‚é–±åŠŸèƒ½ã€ç®¡ç†å“¡å·¥å…·

---

## ğŸš€ ä»»å‹™ä¸€ï¼šå¸‚å ´æ„ŸçŸ¥å¿«å–å„ªåŒ–

### èƒŒæ™¯å•é¡Œ

åŸæœ¬ç³»çµ±æ¯æ¬¡æŸ¥è©¢è‚¡ç¥¨éƒ½æœƒå‘¼å« Yahoo Finance APIï¼Œå³ä½¿åœ¨éäº¤æ˜“æ™‚é–“ï¼ˆå¦‚å°è‚¡æ”¶ç›¤å¾Œï¼‰ï¼Œå°è‡´ï¼š
- ä¸å¿…è¦çš„ API å‘¼å«
- å›æ‡‰æ™‚é–“é•·ï¼ˆ1-3 ç§’ï¼‰
- æµªè²»è³‡æºå’Œå¯èƒ½è§¸ç™¼ API é™åˆ¶

### è§£æ±ºæ–¹æ¡ˆ

å¯¦ä½œæ™ºæ…§å¿«å–åˆ¤æ–·é‚è¼¯ï¼š
- **å¸‚å ´é–‹ç›¤ä¸­**ï¼šæ­£å¸¸å‘¼å« API æ›´æ–°æ•¸æ“š
- **å¸‚å ´å·²æ”¶ç›¤**ï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°å¿«å–æ•¸æ“šï¼Œé›¶ API å‘¼å«

### å¯¦ä½œæª”æ¡ˆ

| æª”æ¡ˆ | è·¯å¾‘ | èªªæ˜ |
|-----|------|------|
| `price_cache_service.py` | `app/services/` | æ–°å¢æ™ºæ…§å¿«å–åˆ¤æ–·å‡½æ•¸ |
| `stock.py` | `app/routers/` | ä¿®æ”¹æŸ¥è©¢ç«¯é»ä½¿ç”¨æ™ºæ…§å¿«å– |
| `watchlist.py` | `app/routers/` | æ–°å¢å¸‚å ´ç‹€æ…‹å›å‚³ |
| `crypto.py` | `app/routers/` | ä¿®å¾©åŠ å¯†è²¨å¹£å¿«å– |

### æ–°å¢å‡½æ•¸

```python
# price_cache_service.py

def get_symbol_market(symbol: str) -> str:
    """åˆ¤æ–·è‚¡ç¥¨æ‰€å±¬å¸‚å ´ (tw/us/crypto)"""
    
def is_market_open_for_symbol(symbol: str) -> bool:
    """åˆ¤æ–·è©²è‚¡ç¥¨çš„å¸‚å ´æ˜¯å¦é–‹ç›¤"""
    
def get_cached_price_smart(symbol: str) -> Tuple[dict, bool]:
    """æ™ºæ…§å–å¾—å¿«å–åƒ¹æ ¼
    Returns: (cache_data, needs_update)
    - å¸‚å ´é—œé–‰ + æœ‰è³‡æ–™ â†’ (data, False) ä¸éœ€æ›´æ–°
    - å¸‚å ´é–‹ç›¤ + è³‡æ–™éæœŸ â†’ (data, True) éœ€è¦æ›´æ–°
    """
```

### æ•ˆèƒ½æå‡

| å ´æ™¯ | èˆŠç‰ˆ | æ–°ç‰ˆ | æå‡ |
|-----|------|------|------|
| éé–‹ç›¤æŸ¥è©¢å°è‚¡ | 1-3 ç§’ | < 100ms | **10-30x** |
| éé–‹ç›¤è¼‰å…¥è¿½è¹¤æ¸…å–® | 500ms-2s | < 50ms | **10-40x** |
| é–‹ç›¤ä¸­æŸ¥è©¢ | ä¸è®Š | ä¸è®Š | - |

### API è®Šæ›´

```json
// GET /api/stock/{symbol} æ–°å¢æ¬„ä½
{
  "market_open": false  // å¸‚å ´æ˜¯å¦é–‹ç›¤
}

// GET /api/watchlist/with-prices æ–°å¢æ¬„ä½
{
  "market_status": {
    "tw_open": false,
    "us_open": true,
    "crypto_open": true
  }
}
```

---

## ğŸ”§ ä»»å‹™äºŒï¼šåœ–è¡¨åŠŸèƒ½ä¿®å¾©

### å•é¡Œ 1ï¼šæ™‚é–“ç¯„åœæŒ‰éˆ•ç„¡æ³•é»æ“Š

#### ç¾è±¡
é»æ“Š 1Mã€3Mã€6Mã€1Y ç­‰æŒ‰éˆ•æ²’æœ‰åæ‡‰ï¼Œåœ–è¡¨ä¸æœƒåˆ‡æ›æ™‚é–“ç¯„åœã€‚

#### åŸå› åˆ†æ
1. `chartFullscreen` æ¨¡æ¿ä¸­çš„æŒ‰éˆ•**æ²’æœ‰ `onclick` äº‹ä»¶**
2. åŸæœ¬ä¾è³´ `document.addEventListener('click')` çš„äº‹ä»¶å§”æ´¾ï¼Œä½†è¢«å…¶ä»– JS è¦†è“‹

#### ä¿®å¾©æ–¹æ¡ˆ
```html
<button type="button" onclick="setChartRange(22)" class="chart-range-btn" data-days="22">1M</button>
```

åŒæ™‚ä½¿ç”¨ **capture æ¨¡å¼**çš„äº‹ä»¶ç›£è½ç¢ºä¿æœ€é«˜å„ªå…ˆç´šï¼š
```javascript
document.addEventListener('click', function(e) {
    var btn = e.target.closest('.chart-range-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        var days = parseInt(btn.getAttribute('data-days'));
        setChartRange(days);
    }
}, true);  // true = capture æ¨¡å¼
```

### å•é¡Œ 2ï¼šMA å‡ç·šä¸é¡¯ç¤º

#### åŸå› åˆ†æ
åŸå§‹ `renderFullscreenChart` å‡½æ•¸ç›´æ¥å° `chartData.ma20` å‘¼å« `.slice()`ï¼Œæ²’æœ‰æª¢æŸ¥æ˜¯å¦å­˜åœ¨ã€‚

#### ä¿®å¾©æ–¹æ¡ˆ

```javascript
// å®‰å…¨åˆ‡ç‰‡å‡½æ•¸
function safeSlice(arr, start) {
    if (!arr || !Array.isArray(arr)) return [];
    return arr.slice(start);
}

// æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•¸æ“š
function hasValid(arr) {
    if (!arr || arr.length === 0) return false;
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] !== null && arr[i] !== undefined && !isNaN(arr[i])) {
            return true;
        }
    }
    return false;
}
```

### å•é¡Œ 3ï¼šåœ–ä¾‹ç„¡æ³•é»æ“Šåˆ‡æ›

#### ä¿®å¾©æ–¹æ¡ˆ
```javascript
plugins: {
    legend: {
        onClick: function(e, legendItem, legend) {
            var index = legendItem.datasetIndex;
            var ci = legend.chart;
            var meta = ci.getDatasetMeta(index);
            meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
            ci.update();
        }
    }
}
```

### å•é¡Œ 4ï¼šå¤šå€‹ JS æª”æ¡ˆå‡½æ•¸è¦†è“‹

#### ä¿®å¾©æ–¹æ¡ˆ

ä½¿ç”¨ `Object.defineProperty` é–å®šå‡½æ•¸ï¼š
```javascript
function install() {
    delete window.setChartRange;
    Object.defineProperty(window, 'setChartRange', {
        value: _setRange,
        writable: false,
        configurable: true
    });
}

// å¤šæ¬¡åŸ·è¡Œç¢ºä¿æˆåŠŸ
setTimeout(install, 100);
setTimeout(install, 500);
setTimeout(install, 1000);
```

---

## âœ… å‰æ¬¡äº¤ç­å·²ä¿®æ­£é …ç›® (2026-01-15)

### 1. è‚¡ç¥¨è©³æƒ…æŠ€è¡“æŒ‡æ¨™æ¶ˆå¤±å•é¡Œ
- **å•é¡Œ**: æŸ¥è©¢è‚¡ç¥¨æ™‚åªè¿”å›å¿«å–çš„ç°¡åŒ–è³‡æ–™
- **ä¿®æ­£**: ç§»é™¤è‚¡ç¥¨è©³æƒ…æŸ¥è©¢çš„å¿«å–è¿”å›é‚è¼¯ï¼Œæ°¸é å¾ Yahoo Finance å–å¾—å®Œæ•´è³‡æ–™
- **æª”æ¡ˆ**: `app/routers/stock.py`

### 2. è¨‚é–±æŒ‰éˆ•æ²’åæ‡‰
- **å•é¡Œ**: onclick æœªæ­£ç¢ºç¶å®šåˆ°å…¨åŸŸå‡½æ•¸
- **ä¿®æ­£**: æ”¹ç”¨ `window.toggleSubscription`
- **æª”æ¡ˆ**: `static/js/subscription.js`

### 3. è¨‚é–±ç²¾é¸æ—¥æœŸé¡¯ç¤ºéŒ¯èª¤
- **å•é¡Œ**: é¡¯ç¤ºçš„æ˜¯æŠ“å–æ—¥æœŸè€Œéæ–‡ç« ç™¼ä½ˆæ—¥æœŸ
- **ä¿®æ­£**: å„ªå…ˆä½¿ç”¨ `article_date`
- **æª”æ¡ˆ**: `static/js/subscription.js`

### 4. ç®¡ç†å“¡å·¥å…·ç¼ºå°‘ã€Œæ›´æ–°è¨‚é–±ã€åŠŸèƒ½
- **ä¿®æ­£**: æ–°å¢ `adminFetchSubscriptions()` å‡½æ•¸
- **æª”æ¡ˆ**: `static/js/settings.js`, `static/dashboard.html`

### 5. è¿½è¹¤æ¸…å–® MA20 æ’åºæ¶ˆå¤±
- **ä¿®æ­£**: æ–°å¢ã€ŒMA20è·é›¢ã€æ’åºé¸é …
- **æª”æ¡ˆ**: `static/js/watchlist.js`

### 6. å¿«é€Ÿæ–°å¢è¿½è¹¤æç¤ºæ¶ˆå¤±
- **ä¿®æ­£**: æ–°å¢ `quickAddToWatchlist()` å‡½æ•¸ä¸¦å°å‡ºåˆ°å…¨åŸŸ
- **æª”æ¡ˆ**: `static/js/watchlist.js`

---

## âš ï¸ å·²çŸ¥å•é¡Œï¼ˆæœªä¿®ï¼‰

### 1. Railway éƒ¨ç½²å¡ä½
- ç¾è±¡: "Taking a snapshot of the code" å¡ä½ 24+ åˆ†é˜
- è§£æ³•: å–æ¶ˆé‡æ–°éƒ¨ç½²ï¼Œæˆ–æª¢æŸ¥ Railway ç‹€æ…‹ https://status.railway.app

### 2. index_service æ¨¡çµ„ä¸å­˜åœ¨
```
ModuleNotFoundError: No module named 'app.services.index_service'
```
- ä½ç½®: `app/routers/admin.py` ç¬¬ 967 è¡Œ
- å»ºè­°: ç¢ºèªæ˜¯å¦éœ€è¦æ­¤åŠŸèƒ½ï¼Œè‹¥ä¸éœ€è¦å¯ç§»é™¤ç›¸é—œ import

### 3. è¨‚é–±ç²¾é¸æ²’æœ‰è‡ªå‹•æ›´æ–°
- åŸå› : æ’ç¨‹å¯èƒ½æ²’æœ‰æ­£ç¢ºåŸ·è¡Œ
- è§£æ³•: å·²åŠ å…¥æ‰‹å‹•è§¸ç™¼æŒ‰éˆ•

---

## ğŸ“¦ å·²ç”¢å‡ºçš„æª”æ¡ˆ

### æ•ˆèƒ½å„ªåŒ–
| æª”æ¡ˆ | è·¯å¾‘ |
|-----|------|
| `price_cache_service.py` | `app/services/` |
| `stock.py` | `app/routers/` |
| `watchlist.py` | `app/routers/` |
| `crypto.py` | `app/routers/` |

### åœ–è¡¨ä¿®å¾©
| æª”æ¡ˆ | è·¯å¾‘ |
|-----|------|
| `chart-fix-final.js` | `static/js/` |
| `fix_chart.py` | `static/`ï¼ˆè‡ªå‹•ä¿®å¾©è…³æœ¬ï¼‰ |

### å‰ç«¯ä¿®æ­£åŒ… (frontend_fix_20260115.zip)
```
js/subscription.js   â† è¨‚é–±åŠŸèƒ½ä¿®æ­£
js/settings.js       â† ç®¡ç†å“¡å·¥å…·å‡½æ•¸
js/watchlist.js      â† MA20æ’åº + quickAdd
dashboard.html       â† ç®¡ç†å“¡å·¥å…·å€å¡Š
```

---

## ğŸ”§ éƒ¨ç½²æ­¥é©Ÿ

### å¾Œç«¯
```bash
# æ›¿æ› stock.py
cp stock.py app/routers/stock.py
```

### å‰ç«¯
```bash
# è§£å£“å‰ç«¯ä¿®æ­£åŒ…
unzip frontend_fix_20260115.zip -d static/

# ç¢ºä¿åœ–è¡¨ä¿®å¾©è…³æœ¬åœ¨æœ€å¾Œè¼‰å…¥
# åœ¨ dashboard.html çš„ </body> ä¹‹å‰åŠ å…¥ï¼š
# <script src="/static/js/chart-fix-final.js"></script>
```

### éƒ¨ç½²å¾Œé©—è­‰
1. æŸ¥è©¢è‚¡ç¥¨ â†’ æ‡‰é¡¯ç¤ºå®Œæ•´æŠ€è¡“æŒ‡æ¨™å’Œåœ–è¡¨
2. è¿½è¹¤æ¸…å–® â†’ æ’åºæ‡‰æœ‰ã€ŒMA20è·é›¢ã€é¸é …
3. è¨‚é–±ç²¾é¸ â†’ é»ã€Œ+ã€æ‡‰é¡¯ç¤ºã€ŒXXX å·²åŠ å…¥è¿½è¹¤æ¸…å–®ã€
4. è¨­å®šé é¢ â†’ æ‡‰çœ‹åˆ°ã€Œç®¡ç†å“¡å·¥å…·ã€å€å¡Š
5. ç®¡ç†å“¡å·¥å…· â†’ é»ã€ŒæŠ“å–è¨‚é–±ç²¾é¸ã€æ‡‰æŠ“å–æœ€æ–°æ–‡ç« 
6. åœ–è¡¨åŠŸèƒ½ â†’ æ™‚é–“ç¯„åœæŒ‰éˆ•å¯é»æ“Š
7. MA å‡ç·š â†’ æ‡‰æ­£å¸¸é¡¯ç¤ºåœ¨åœ–è¡¨ä¸­

---

## ğŸ“ ç¶“é©—ç¸½çµ

### å‰ç«¯é™¤éŒ¯æŠ€å·§

1. **å–„ç”¨ console.log åŠ ä¸Šå‰ç¶´**ï¼š
```javascript
console.log('ğŸ“Š [FINAL] _render days=' + days);
```

2. **æª¢æŸ¥æ•¸æ“šæ˜¯å¦æ­£ç¢ºå‚³é**ï¼š
```javascript
console.log(window.currentChartData);
```

3. **ä½¿ç”¨ capture æ¨¡å¼è™•ç†äº‹ä»¶è¦†è“‹å•é¡Œ**ï¼š
```javascript
document.addEventListener('click', handler, true);  // true = capture
```

### å¾Œç«¯å¿«å–ç­–ç•¥

1. **å€åˆ†å¸‚å ´é–‹ç›¤ç‹€æ…‹**ï¼šä¸åŒå¸‚å ´æœ‰ä¸åŒäº¤æ˜“æ™‚é–“
2. **å¿«å–å¤±æ•ˆç­–ç•¥**ï¼šé–‹ç›¤ä¸­ 5 åˆ†é˜å¤±æ•ˆï¼Œæ”¶ç›¤å¾Œç„¡é™æœŸæœ‰æ•ˆ
3. **å„ªå…ˆä½¿ç”¨æ°¸ä¹…å„²å­˜**ï¼šå…ˆæŸ¥ `stock_prices` è¡¨ï¼Œå†è€ƒæ…® API

### éƒ¨ç½²æ³¨æ„äº‹é …

1. **Railway ç„¡æ³•ç›´æ¥åŸ·è¡Œ SQL**ï¼šæ‰€æœ‰é·ç§»å¿…é ˆé€é `run_migrations()` å‡½æ•¸
2. **æ¸…é™¤ç€è¦½å™¨å¿«å–**ï¼šå‰ç«¯ä¿®æ”¹å¾Œå¿…é ˆ `Ctrl+Shift+R`
3. **å‚™ä»½åŸå§‹æª”æ¡ˆ**ï¼šä¿®æ”¹å‰å…ˆå‚™ä»½

---

## ğŸ”® å¾ŒçºŒå»ºè­°

1. **æ•´åˆ JS æª”æ¡ˆ**ï¼šè€ƒæ…®å°‡ `search-chart.js`ã€`search-render.js`ã€`chart-fix.js` æ•´åˆæˆå–®ä¸€æª”æ¡ˆ
2. **å‰ç«¯æ¡†æ¶åŒ–**ï¼šè€ƒæ…®ä½¿ç”¨ Vue æˆ– React é‡æ§‹å‰ç«¯
3. **å¢åŠ å–®å…ƒæ¸¬è©¦**ï¼šç‚ºå¿«å–é‚è¼¯å’Œå¸‚å ´åˆ¤æ–·å‡½æ•¸å¢åŠ æ¸¬è©¦
4. **ç›£æ§ API å‘¼å«**ï¼šåŠ å…¥ç›£æ§è¿½è¹¤ API å‘¼å«æ¬¡æ•¸

---

## ğŸ“‹ å¾…è¾¦äº‹é … (P1)

| # | é …ç›® | ç‹€æ…‹ |
|---|------|------|
| 1 | è¿½è¹¤æ¸…å–®è¼‰å…¥æ…¢è¨ºæ–· | å¾…è™•ç† |
| 2 | è¨‚é–±ç²¾é¸å‰ç«¯ Tab | âœ… åŸºæœ¬åŠŸèƒ½å®Œæˆ |
| 3 | è¿½è¹¤æ¸…å–®åŒ¯å‡ºåŒ¯å…¥ | å¾…é–‹ç™¼ |
| 4 | æŒè‚¡äº¤æ˜“åŒ¯å‡ºåŒ¯å…¥ | å¾…é–‹ç™¼ |
| 5 | stock_info ç¨®å­è¡¨ | å¾…é–‹ç™¼ |
| 6 | åˆ°åƒ¹æé†’è®Šè‰² | âœ… å·²å®Œæˆ |

---

## ğŸ“ å‚™è¨»

- Railway å…è²»æ–¹æ¡ˆæ¯æœˆç´„ 500 å°æ™‚ï¼Œæ³¨æ„ç”¨é‡
- è³‡æ–™åº«é·ç§»å¿…é ˆé€é `database.py` çš„ `run_migrations()` åŸ·è¡Œ
- LINE Login å¤šç’°å¢ƒéƒ¨ç½²éœ€åœ¨ LINE Developers Console æ·»åŠ å°æ‡‰ Callback URL
