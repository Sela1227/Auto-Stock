# ğŸ“‹ SELA äº¤æ˜“ API ä¿®å¾©è¨˜éŒ„

> **æ—¥æœŸ**: 2026-01-17  
> **ç‰ˆæœ¬**: v0.8.3  
> **ç‹€æ…‹**: âœ… å·²ä¿®å¾©

---

## å•é¡Œæ¦‚è¿°

æ–°å¢å°è‚¡/ç¾è‚¡äº¤æ˜“æ™‚ï¼Œé€£çºŒé‡åˆ°ä¸‰å€‹ HTTP éŒ¯èª¤ï¼š

```
405 Method Not Allowed â†’ 422 Unprocessable Entity â†’ 500 Internal Server Error
```

---

## å•é¡Œ 1ï¼š405 Method Not Allowed

### ç¾è±¡
```
POST /api/portfolio/transactions/tw HTTP/1.1" 405 Method Not Allowed
```

### åŸå› åˆ†æ

| é …ç›® | å…§å®¹ |
|------|------|
| **å¾Œç«¯è·¯ç”±å®šç¾©** | `@router.post("/transactions")` |
| **å‰ç«¯è«‹æ±‚è·¯å¾‘** | `/api/portfolio/transactions/tw` âŒ |
| **å•é¡Œ** | å‰ç«¯å¤šåŠ äº† `/tw` å’Œ `/us` å¾Œç¶´ |

### éŒ¯èª¤ç¨‹å¼ç¢¼ (transaction.js)
```javascript
// å°è‚¡
res = await apiRequest('/api/portfolio/transactions/tw', { method: 'POST', body });
// ç¾è‚¡
res = await apiRequest('/api/portfolio/transactions/us', { method: 'POST', body });
```

### ä¿®å¾©æ–¹å¼
```javascript
// çµ±ä¸€ä½¿ç”¨ä¸å¸¶å¾Œç¶´çš„è·¯å¾‘
res = await apiRequest('/api/portfolio/transactions', { method: 'POST', body });
```

---

## å•é¡Œ 2ï¼š422 Unprocessable Entity

### ç¾è±¡
```
POST /api/portfolio/transactions HTTP/1.1" 422 Unprocessable Entity
```

### åŸå› åˆ†æ

| é …ç›® | å…§å®¹ |
|------|------|
| **å¾Œç«¯ Schema** | `market: str = Field(..., pattern="^(tw\|us)$")` (å¿…å¡«) |
| **å‰ç«¯ body** | æ²’æœ‰ `market` æ¬„ä½ âŒ |

### éŒ¯èª¤ç¨‹å¼ç¢¼ (transaction.js)
```javascript
const body = {
    symbol,
    name,
    transaction_type: type,  // ç¼ºå°‘ market!
    quantity,
    price,
    // ...
};
```

### ä¿®å¾©æ–¹å¼
```javascript
// å°è‚¡
const body = {
    symbol,
    name,
    market: 'tw',  // âœ… æ–°å¢
    transaction_type: type,
    quantity,
    price,
    // ...
};

// ç¾è‚¡
const body = {
    symbol,
    name,
    market: 'us',  // âœ… æ–°å¢
    transaction_type: type,
    quantity,
    price,
    // ...
};
```

---

## å•é¡Œ 3ï¼š500 Internal Server Error

### ç¾è±¡
```
POST /api/portfolio/transactions HTTP/1.1" 500 Internal Server Error
TypeError: PortfolioService.create_transaction() got an unexpected keyword argument 'broker_id'
```

### åŸå› åˆ†æ

| é …ç›® | å…§å®¹ |
|------|------|
| **Router å±¤** | å‚³å…¥ `broker_id=data.broker_id` |
| **Service å±¤** | `create_transaction()` æ–¹æ³•æ²’æœ‰ `broker_id` åƒæ•¸ âŒ |

### éŒ¯èª¤ç¨‹å¼ç¢¼ (portfolio_service.py)
```python
async def create_transaction(
    self,
    user_id: int,
    symbol: str,
    market: str,
    # ... å…¶ä»–åƒæ•¸
    note: Optional[str] = None,
    # ç¼ºå°‘ broker_id!
) -> PortfolioTransaction:
```

### ä¿®å¾©æ–¹å¼
```python
async def create_transaction(
    self,
    user_id: int,
    symbol: str,
    market: str,
    # ... å…¶ä»–åƒæ•¸
    note: Optional[str] = None,
    broker_id: Optional[int] = None,  # âœ… æ–°å¢
) -> PortfolioTransaction:
    
    # å»ºç«‹äº¤æ˜“ç´€éŒ„æ™‚ä¹Ÿè¦å‚³å…¥
    transaction = PortfolioTransaction(
        # ... å…¶ä»–æ¬„ä½
        note=note,
        broker_id=broker_id,  # âœ… æ–°å¢
    )
```

---

## ä¿®å¾©æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | ä¿®å¾©å…§å®¹ |
|------|---------|
| `static/js/transaction.js` | ç§»é™¤ API è·¯å¾‘çš„ `/tw`ã€`/us` å¾Œç¶´ |
| `static/js/transaction.js` | å°è‚¡ body åŠ å…¥ `market: 'tw'` |
| `static/js/transaction.js` | ç¾è‚¡ body åŠ å…¥ `market: 'us'` |
| `app/services/portfolio_service.py` | `create_transaction()` åŠ å…¥ `broker_id` åƒæ•¸ |

---

## ä¿®å¾©è…³æœ¬

### å‰ç«¯ä¿®å¾© (fix_transaction_market.py)
```bash
python3 fix_transaction_market.py
```

ä¿®å¾©å…§å®¹ï¼š
- ç§»é™¤ API è·¯å¾‘å¾Œç¶´
- åŠ å…¥ `market` æ¬„ä½

### å¾Œç«¯ä¿®å¾© (fix_portfolio_service.py)
```bash
python3 fix_portfolio_service.py
```

ä¿®å¾©å…§å®¹ï¼š
- æ–¹æ³•ç°½ååŠ å…¥ `broker_id: Optional[int] = None`
- `PortfolioTransaction` å»ºæ§‹æ™‚å‚³å…¥ `broker_id`

---

## é©—è­‰æ­¥é©Ÿ

1. åŸ·è¡Œä¿®å¾©è…³æœ¬
2. éƒ¨ç½²åˆ° Railway
3. æ¸¬è©¦æ–°å¢å°è‚¡äº¤æ˜“ â†’ æ‡‰è¿”å› 200 OK
4. æ¸¬è©¦æ–°å¢ç¾è‚¡äº¤æ˜“ â†’ æ‡‰è¿”å› 200 OK
5. ç¢ºèªäº¤æ˜“ç´€éŒ„æ­£ç¢ºå¯«å…¥è³‡æ–™åº«

---

## ç¶“é©—ç¸½çµ

### HTTP éŒ¯èª¤å°ç…§è¡¨

| éŒ¯èª¤ç¢¼ | å«ç¾© | å¸¸è¦‹åŸå›  |
|--------|------|----------|
| 405 | Method Not Allowed | è·¯å¾‘ä¸åŒ¹é…ã€HTTP æ–¹æ³•éŒ¯èª¤ |
| 422 | Unprocessable Entity | Schema é©—è­‰å¤±æ•—ã€ç¼ºå°‘å¿…å¡«æ¬„ä½ |
| 500 | Internal Server Error | å¾Œç«¯ç¨‹å¼éŒ¯èª¤ã€åƒæ•¸ä¸åŒ¹é… |

### æ–°åŠŸèƒ½é–‹ç™¼æª¢æŸ¥æ¸…å–®

ç•¶æ–°å¢éœ€è¦å‰å¾Œç«¯é…åˆçš„æ¬„ä½æ™‚ï¼Œç¢ºèªä»¥ä¸‹éƒ½å·²åŒæ­¥ï¼š

- [ ] å¾Œç«¯ Pydantic Schema (TransactionCreate)
- [ ] å¾Œç«¯ SQLAlchemy Model (PortfolioTransaction)
- [ ] å¾Œç«¯ Service æ–¹æ³•åƒæ•¸
- [ ] å‰ç«¯ API è«‹æ±‚ body
- [ ] è³‡æ–™åº«é·ç§» (å¦‚æœ‰æ–°å¢æ¬„ä½)

### é™¤éŒ¯æŠ€å·§

```bash
# æŸ¥çœ‹ Railway å³æ™‚æ—¥èªŒ
railway logs

# éæ¿¾ç‰¹å®š API éŒ¯èª¤
cat logs.json | python3 -c "import json,sys; [print(l['message']) for l in json.load(sys.stdin) if '422' in l['message'] or '405' in l['message'] or '500' in l['message']]"
```

---

## ç›¸é—œæ–‡ä»¶

| æ–‡ä»¶ | èªªæ˜ |
|------|------|
| SELA_é–‹ç™¼æŒ‡å—.md | Bug ä¿®å¾©æŒ‡å— |
| SELA_åˆ¸å•†åŠŸèƒ½éƒ¨ç½²æŒ‡å—.md | åˆ¸å•†åŠŸèƒ½å®Œæ•´éƒ¨ç½² |
| SELA_å¾…è¾¦è¿½è¹¤.md | å¾…è¾¦æ¸…å–® |

---

## æ›´æ–°è¨˜éŒ„

| æ—¥æœŸ | æ›´æ–°å…§å®¹ |
|------|----------|
| 2026-01-17 | åˆå§‹è¨˜éŒ„ï¼Œä¿®å¾© 405 â†’ 422 â†’ 500 ä¸‰é€£éŒ¯ |
