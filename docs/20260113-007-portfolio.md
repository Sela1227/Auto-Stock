# 💼 SELA 更新包 - 投資組合管理

> 文件編號: 20260113-007-portfolio  
> 建立日期: 2026-01-13  
> 功能: 功能 2 - 個人交易管理

---

## 📦 檔案清單

```
app/
├── main.py              ← 覆蓋（註冊 portfolio_router）
├── models/
│   ├── __init__.py      ← 覆蓋（匯出新 Model）
│   └── portfolio.py     ← 新增
├── routers/
│   ├── __init__.py      ← 覆蓋（匯出新 Router）
│   └── portfolio.py     ← 新增
└── services/
    └── portfolio_service.py  ← 新增

static/
└── dashboard.html       ← 覆蓋（含 BTC 卡片 + 投資組合頁面）
```

---

## ✨ 新增功能

### 1. 投資組合頁面

位置：側邊欄「投資組合」選項

**功能特色：**
- 持股總覽（分台股/美股）
- 交易紀錄管理（新增/編輯/刪除）
- 投資摘要（總投入、現值、損益、報酬率）
- 未實現損益即時計算（從價格快取讀取）
- 已實現損益追蹤

### 2. BTC 價格卡片

位置：儀表板頁面，恐懼貪婪指數下方

**功能特色：**
- 即時 BTC 價格
- 24h/週/月漲跌幅
- 動態背景色
- 每 60 秒自動更新

---

## 🗄️ 資料庫

新增兩張表（首次啟動自動建立）：

### portfolio_transactions（交易紀錄）
| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INTEGER | 主鍵 |
| user_id | INTEGER | 用戶 ID |
| symbol | VARCHAR(20) | 股票代碼 |
| name | VARCHAR(100) | 股票名稱 |
| market | VARCHAR(10) | tw / us |
| transaction_type | VARCHAR(10) | buy / sell |
| quantity | INTEGER | 股數 |
| price | NUMERIC(12,4) | 成交價 |
| fee | NUMERIC(10,2) | 手續費 |
| tax | NUMERIC(10,2) | 交易稅 |
| transaction_date | DATE | 交易日期 |
| note | TEXT | 備註 |

### portfolio_holdings（持股彙總）
| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INTEGER | 主鍵 |
| user_id | INTEGER | 用戶 ID |
| symbol | VARCHAR(20) | 股票代碼 |
| name | VARCHAR(100) | 股票名稱 |
| market | VARCHAR(10) | tw / us |
| total_shares | INTEGER | 總持股 |
| avg_cost | NUMERIC(12,4) | 平均成本 |
| total_invested | NUMERIC(14,2) | 總投入 |
| realized_profit | NUMERIC(14,2) | 已實現損益 |

---

## 📡 新增 API

### 交易紀錄

| Method | Endpoint | 說明 |
|--------|----------|------|
| POST | `/api/portfolio/transactions` | 新增交易 |
| GET | `/api/portfolio/transactions` | 交易列表 |
| GET | `/api/portfolio/transactions/{id}` | 單筆交易 |
| PUT | `/api/portfolio/transactions/{id}` | 更新交易 |
| DELETE | `/api/portfolio/transactions/{id}` | 刪除交易 |

### 持股與摘要

| Method | Endpoint | 說明 |
|--------|----------|------|
| GET | `/api/portfolio/holdings` | 持股列表（含現價） |
| GET | `/api/portfolio/summary` | 投資摘要 |

---

## 🔧 整合方式

1. 將 `app/` 目錄下的檔案複製到專案對應位置
2. 將 `static/dashboard.html` 覆蓋專案中的同名檔案
3. 重新部署（資料庫表會自動建立）

---

## ✅ 驗收清單

### 投資組合
- [x] 側邊欄顯示「投資組合」選項
- [x] 持股總覽（台股/美股分開）
- [x] 顯示現價和未實現損益
- [x] 新增交易 Modal
- [x] 編輯/刪除交易
- [x] 投資摘要統計

### BTC 卡片
- [x] 儀表板顯示 BTC 價格
- [x] 漲跌幅顯示
- [x] 動態背景色
- [x] 自動更新

---

## 📝 注意事項

1. **價格來源**：持股現價來自 `stock_price_cache` 表，需確保價格快取排程正常運作
2. **損益計算**：採用「先進先出」(FIFO) 方式計算已實現損益
3. **資料隔離**：每個用戶只能看到自己的交易紀錄
