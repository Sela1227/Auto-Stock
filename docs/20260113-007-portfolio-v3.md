# 💼 SELA 更新包 - 個人投資記錄 v3

> 文件編號: 20260113-007-portfolio-v3  
> 建立日期: 2026-01-13  
> 功能: 功能 2 - 個人交易管理 + 待辦完成

---

## 📦 檔案清單

```
app/
├── main.py                          ← 覆蓋（註冊 router + 匯率排程）
├── models/
│   ├── __init__.py                  ← 覆蓋
│   └── portfolio.py                 ← 新增
├── routers/
│   ├── __init__.py                  ← 覆蓋
│   ├── admin.py                     ← 覆蓋（含三個更新 API）
│   └── portfolio.py                 ← 新增
└── services/
    ├── exchange_rate_service.py     ← 新增
    └── portfolio_service.py         ← 新增

static/
└── dashboard.html                   ← 覆蓋
```

---

## ✅ 待辦完成

### 1. BTC 卡片移到第一項 ✓
儀表板頂部第一個元素現在是比特幣價格卡片

### 2. 管理員登入觸發全部更新 ✓
管理員登入後自動觸發：
- 四大指數更新 (`/api/admin/update-indices`)
- 價格快取更新 (`/api/admin/update-price-cache`)
- BTC 價格更新（前端載入）
- 匯率更新 (`/api/admin/update-exchange-rate`)

### 3. 投資總覽分三區 ✓
- 🔴 **台股區**：現值、損益、報酬率、持股數（NT$）
- 🔵 **美股區**：現值、損益、報酬率、持股數（USD）
- 🟣 **合計區**：總現值、總損益、報酬率、總持股（TWD，美股 × 匯率）

---

## ✨ 功能特色

### 1. 台美股分開管理
- 台股區塊：獨立「新增」按鈕，自動加 `.TW` 後綴
- 美股區塊：獨立「新增」按鈕
- 各自統計損益

### 2. 匯率自動更新
- 每天 3 次自動抓取（09:00、12:00、17:00）
- 來源：Yahoo Finance (TWD=X)
- 預設值：32.5（抓取失敗時使用）

### 3. 總覽加總
- 台股 + (美股 × 匯率) = 總計 (TWD)
- 顯示總現值、總損益、報酬率

### 4. 台股張數輸入
- 張數 + 零股 分開輸入
- 自動計算總股數
- 顯示：「1張500股」格式

### 5. 股票名稱自動帶入
- 輸入代碼後 0.5 秒自動查詢
- 名稱欄位唯讀
- 查無股票時無法送出

### 6. 追蹤清單買賣按鈕
- 每個追蹤項目新增「買」「賣」按鈕
- 點擊後自動開啟對應市場 Modal
- 自動帶入代碼和名稱

---

## 🗄️ 資料庫

新增三張表（首次啟動自動建立）：

### portfolio_transactions（交易紀錄）
| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INTEGER | 主鍵 |
| user_id | INTEGER | 用戶 ID |
| symbol | VARCHAR(20) | 股票代碼 |
| name | VARCHAR(100) | 股票名稱 |
| market | VARCHAR(10) | tw / us |
| transaction_type | VARCHAR(10) | buy / sell |
| quantity | INTEGER | 總股數 |
| price | NUMERIC(12,4) | 成交價 |
| fee | NUMERIC(10,2) | 手續費 |
| tax | NUMERIC(10,2) | 交易稅 |
| transaction_date | DATE | 交易日期 |
| note | TEXT | 備註 |

### portfolio_holdings（持股彙總）
| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INTEGER | 主鍵 |
| user_id | INTEGER | 用戶 ID |
| symbol | VARCHAR(20) | 股票代碼 |
| name | VARCHAR(100) | 股票名稱 |
| market | VARCHAR(10) | tw / us |
| total_shares | INTEGER | 總持股 |
| avg_cost | NUMERIC(12,4) | 平均成本 |
| total_invested | NUMERIC(14,2) | 總投入 |
| realized_profit | NUMERIC(14,2) | 已實現損益 |

### exchange_rates（匯率）
| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INTEGER | 主鍵 |
| from_currency | VARCHAR(10) | USD |
| to_currency | VARCHAR(10) | TWD |
| rate | FLOAT | 匯率 |
| updated_at | DATETIME | 更新時間 |

---

## 📡 API 端點

### 匯率
| Method | Endpoint | 說明 |
|--------|----------|------|
| GET | `/api/portfolio/exchange-rate` | 取得匯率 |
| PUT | `/api/portfolio/exchange-rate` | 手動設定匯率 |

### 交易紀錄
| Method | Endpoint | 說明 |
|--------|----------|------|
| POST | `/api/portfolio/transactions` | 新增交易 |
| GET | `/api/portfolio/transactions` | 交易列表 |
| GET | `/api/portfolio/transactions/{id}` | 單筆交易 |
| PUT | `/api/portfolio/transactions/{id}` | 更新交易 |
| DELETE | `/api/portfolio/transactions/{id}` | 刪除交易 |

### 持股與摘要
| Method | Endpoint | 說明 |
|--------|----------|------|
| GET | `/api/portfolio/holdings` | 持股列表（含現價） |
| GET | `/api/portfolio/summary` | 投資摘要（含匯率換算） |

---

## 🔧 整合方式

1. 將 `app/` 目錄下的檔案複製到專案對應位置
2. 將 `static/dashboard.html` 覆蓋專案中的同名檔案
3. 重新部署（資料庫表會自動建立）

---

## ⏰ 排程任務

| 時間 | 任務 |
|------|------|
| 每 10 分鐘 | 價格快取更新 |
| 週一~五 13:35 | 台股收盤更新 |
| 週二~六 05:05 | 美股收盤更新 |
| **每天 09:00** | 匯率更新（早） |
| **每天 12:00** | 匯率更新（中） |
| **每天 17:00** | 匯率更新（晚） |

---

## ✅ 驗收清單

### 個人投資記錄
- [x] 側邊欄顯示「個人投資記錄」
- [x] 台股/美股分開區塊
- [x] 各自有「新增」按鈕
- [x] 台股：張數 + 零股輸入
- [x] 美股：股數輸入
- [x] 股票代碼自動查詢名稱
- [x] 名稱欄位唯讀
- [x] 投資總覽（匯率換算）
- [x] 持股總覽 / 台股紀錄 / 美股紀錄 三個 Tab

### 追蹤清單
- [x] 每個項目新增「買」「賣」按鈕
- [x] 點擊自動開啟對應 Modal
- [x] 自動帶入代碼和名稱

### 匯率
- [x] 每天 3 次自動更新
- [x] 總覽顯示匯率和更新時間

### BTC 卡片
- [x] 儀表板顯示 BTC 價格
- [x] 動態背景色
