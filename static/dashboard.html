<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SELA Ëá™ÂãïÈÅ∏ËÇ°Á≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="/static/js/utils.js"></script>
</head>
<body class="bg-gray-100">
    <!-- ËºâÂÖ•Áï´Èù¢ -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center z-50">
        <div class="text-center">
            <img src="/static/logo.png" alt="SELA" class="w-24 h-24 mx-auto mb-4 rounded-xl">
            <p class="text-white text-lg">ËºâÂÖ•‰∏≠...</p>
            <i class="fas fa-spinner fa-spin text-white text-2xl mt-4"></i>
        </div>
    </div>

    <!-- ‰∏ªÊáâÁî®Á®ãÂºèÂÖßÂÆπ -->
    <div id="app-content">
        
        <!-- ===== ÊâãÊ©üÁâàÂÅ¥ÈÇäÈÅ∏ÂñÆÈÅÆÁΩ© ===== -->
        <div id="sidebarOverlay" class="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>
        
        <!-- ===== ÊâãÊ©üÁâàÂÅ¥ÈÇäÈÅ∏ÂñÆ ===== -->
        <aside id="mobileSidebar" class="mobile-sidebar">
            <div class="p-4 border-b flex items-center justify-between">
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-10 h-10 rounded-lg mr-2">
                    <span class="font-bold text-lg">SELA</span>
                </div>
                <button onclick="closeMobileSidebar()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#" onclick="mobileNavTo('dashboard')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-700 bg-blue-50 rounded-lg touch-target" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i>
                    <span>ÂÑÄË°®Êùø</span>
                </a>
                <a href="#" onclick="mobileNavTo('search')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="search">
                    <i class="fas fa-search mr-3 w-5"></i>
                    <span>ËÇ°Á•®Êü•Ë©¢</span>
                </a>
                <a href="#" onclick="mobileNavTo('watchlist')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="watchlist">
                    <i class="fas fa-star mr-3 w-5"></i>
                    <span>ËøΩËπ§Ê∏ÖÂñÆ</span>
                </a>
                <a href="#" onclick="mobileNavTo('sentiment')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="sentiment">
                    <i class="fas fa-heart-pulse mr-3 w-5"></i>
                    <span>ÊÅêÊáºË≤™Â©™</span>
                </a>
                <a href="#" onclick="mobileNavTo('compare')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="compare">
                    <i class="fas fa-chart-line mr-3 w-5"></i>
                    <span>Ëµ∞Âã¢ÊØîËºÉ</span>
                </a>
                <a href="#" onclick="mobileNavTo('portfolio')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="portfolio">
                    <i class="fas fa-wallet mr-3 w-5"></i>
                    <span>ÂÄã‰∫∫ÊäïË≥áË®òÈåÑ</span>
                </a>
                <a href="#" onclick="mobileNavTo('subscription')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="subscription">
                    <i class="fas fa-satellite-dish mr-3 w-5"></i>
                    <span>Ë®ÇÈñ±Á≤æÈÅ∏</span>
                </a>
                <a href="/static/compare.html" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target">
                    <i class="fas fa-trophy mr-3 w-5"></i>
                    <span>Â†±ÈÖ¨ÁéáÊØîËºÉ</span>
                </a>
                <a href="#" onclick="mobileNavTo('settings')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="settings">
                    <i class="fas fa-cog mr-3 w-5"></i>
                    <span>Ë®≠ÂÆö</span>
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <img id="sidebarAvatar" class="w-10 h-10 rounded-full mr-3" src="" alt="">
                        <span id="sidebarUserName" class="text-gray-700 font-medium"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-400 mb-2">
                    ÈñíÁΩÆÁôªÂá∫: <span id="sidebarTimer">5:00</span>
                </div>
                <button onclick="logout()" class="w-full py-2 text-red-500 hover:bg-red-50 rounded-lg flex items-center justify-center touch-target">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>ÁôªÂá∫</span>
                </button>
            </div>
        </aside>
        
        <!-- ===== È†ÇÈÉ®Â∞éË¶ΩÂàó ===== -->
        <nav class="top-nav bg-white shadow-sm border-b">
            <div class="px-4 h-14 flex items-center justify-between">
                <!-- ÊâãÊ©üÁâà: Êº¢Â†°ÈÅ∏ÂñÆÊåâÈàï -->
                <button onclick="openMobileSidebar()" class="mobile-header-menu p-2 -ml-2 text-gray-600 touch-target">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <!-- Logo -->
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-8 h-8 rounded-lg mr-2">
                    <span class="font-bold text-lg text-gray-800 hidden sm:inline">Ëá™ÂãïÈÅ∏ËÇ°Á≥ªÁµ±</span>
                    <span class="font-bold text-lg text-gray-800 sm:hidden">SELA</span>
                </div>
                
                <!-- Âè≥ÂÅ¥Ë≥áË®ä -->
                <div class="flex items-center space-x-2">
                    <span id="sessionTimer" class="text-xs text-gray-400 hidden sm:inline"></span>
                    <!-- ÁÆ°ÁêÜÂì°ÂÖ•Âè£ -->
                    <a id="adminLink" href="/static/admin.html" class="text-orange-500 hover:text-orange-600 hidden p-2" title="ÁÆ°ÁêÜÂæåÂè∞">
                        <i class="fas fa-user-shield"></i>
                    </a>
                    <span id="userName" class="text-gray-600 text-sm hidden md:inline"></span>
                    <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="">
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 hidden sm:inline p-2" title="ÁôªÂá∫">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- ===== ÈõªËÖ¶ÁâàÂÅ¥ÈÇäÊ¨Ñ ===== -->
        <aside class="desktop-sidebar bg-white shadow-sm">
            <nav class="p-4 space-y-2">
                <a href="#" onclick="showSection('dashboard', event)" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-blue-50 rounded-lg" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>ÂÑÄË°®Êùø</span>
                </a>
                <a href="#" onclick="showSection('search', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="search">
                    <i class="fas fa-search mr-3"></i>
                    <span>ËÇ°Á•®Êü•Ë©¢</span>
                </a>
                <a href="#" onclick="showSection('watchlist', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="watchlist">
                    <i class="fas fa-star mr-3"></i>
                    <span>ËøΩËπ§Ê∏ÖÂñÆ</span>
                </a>
                <a href="#" onclick="showSection('sentiment', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="sentiment">
                    <i class="fas fa-heart-pulse mr-3"></i>
                    <span>ÊÅêÊáºË≤™Â©™</span>
                </a>
                <a href="#" onclick="showSection('compare', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="compare">
                    <i class="fas fa-chart-line mr-3"></i>
                    <span>Ëµ∞Âã¢ÊØîËºÉ</span>
                </a>
                <a href="#" onclick="showSection('portfolio', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="portfolio">
                    <i class="fas fa-wallet mr-3"></i>
                    <span>ÂÄã‰∫∫ÊäïË≥áË®òÈåÑ</span>
                </a>
                <a href="#" onclick="showSection('subscription', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="subscription">
                    <i class="fas fa-satellite-dish mr-3"></i>
                    <span>Ë®ÇÈñ±Á≤æÈÅ∏</span>
                </a>
                <a href="/static/compare.html" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-trophy mr-3"></i>
                    <span>Â†±ÈÖ¨ÁéáÊØîËºÉ</span>
                </a>
                <a href="#" onclick="showSection('settings', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="settings">
                    <i class="fas fa-cog mr-3"></i>
                    <span>Ë®≠ÂÆö</span>
                </a>
                <!-- ÁÆ°ÁêÜÂì°ÂÖ•Âè£ (È†êË®≠Èö±Ëóè) -->
                <a id="adminSidebarLink" href="/static/admin.html" class="hidden flex items-center px-4 py-2 text-orange-500 hover:bg-orange-50 rounded-lg mt-4 border-t pt-4">
                    <i class="fas fa-user-shield mr-3"></i>
                    <span>ÁÆ°ÁêÜÂæåÂè∞</span>
                </a>
            </nav>
        </aside>

        <!-- ===== ‰∏ªÂçÄÂüü ===== -->
        <main class="main-content">
            
            <!-- ===== ÂÑÄË°®ÊùøÂçÄÂ°ä ===== -->
            <section id="section-dashboard" class="section">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">ÂÑÄË°®Êùø</h2>
                
                <!-- ===== ÊØîÁâπÂπ£ÂÉπÊ†ºÂç°ÁâáÔºàÁ¨¨‰∏ÄÈ†ÖÔºâ===== -->
                <div class="mb-4 md:mb-6">
                    <div id="btc-price-card" class="bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl p-4 md:p-5 text-white shadow-lg cursor-pointer hover:shadow-xl transition-all duration-300 relative overflow-hidden" onclick="showSection('search', event); setTimeout(() => { document.getElementById('searchSymbol').value='BTC'; searchStock(); }, 100);">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <i class="fab fa-bitcoin text-xl"></i>
                                    <span class="text-sm font-medium opacity-90">Bitcoin</span>
                                    <span id="btc-update-indicator" class="w-2 h-2 rounded-full bg-white/50 animate-pulse hidden"></span>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold truncate" id="btc-price">$--,---</div>
                            </div>
                            <div class="text-right flex-shrink-0 ml-3">
                                <div class="text-lg md:text-xl font-semibold" id="btc-change">--%</div>
                                <div class="text-xs opacity-75">24h</div>
                            </div>
                            <div class="ml-3 md:ml-4 flex-shrink-0 opacity-20">
                                <i class="fab fa-bitcoin text-5xl md:text-6xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊåáÊï∏Âç°Áâá (4ÂÄã) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 md:mb-6">
                    <!-- S&P 500 -->
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^GSPC', 'S&P 500')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-line text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">S&P 500</h3>
                                    <p class="text-xs text-gray-400">^GSPC</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-GSPC-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-GSPC-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-GSPC-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    
                    <!-- ÈÅìÁìäÂ∑•Ê•≠ -->
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^DJI', 'ÈÅìÁìäÂ∑•Ê•≠')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-industry text-green-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">ÈÅìÁìäÂ∑•Ê•≠</h3>
                                    <p class="text-xs text-gray-400">^DJI</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-DJI-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-DJI-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-DJI-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    
                    <!-- Á¥çÊñØÈÅîÂÖã -->
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^IXIC', 'Á¥çÊñØÈÅîÂÖã')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-microchip text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">Á¥çÊñØÈÅîÂÖã</h3>
                                    <p class="text-xs text-gray-400">^IXIC</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-IXIC-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-IXIC-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-IXIC-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    
                    <!-- Âè∞ËÇ°Âä†Ê¨ä -->
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^TWII', 'Âè∞ËÇ°Âä†Ê¨ä')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-landmark text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">Âè∞ËÇ°Âä†Ê¨ä</h3>
                                    <p class="text-xs text-gray-400">^TWII</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-TWII-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-TWII-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-TWII-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                </div>
                
                <!-- ÊÅêÊáºË≤™Â©™ÊåáÊï∏Âç°Áâá -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                    <!-- ÁæéËÇ°ÊÅêÊáºË≤™Â©™ÊåáÊï∏ -->
                    <div class="bg-white rounded-xl shadow p-4 md:p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="openSentimentModal('stock', 'ÁæéËÇ°ÊÅêÊáºË≤™Â©™ÊåáÊï∏')">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700 text-sm md:text-base">
                                <i class="fas fa-flag-usa mr-2 text-blue-500"></i>ÁæéËÇ°ÊÅêÊáºË≤™Â©™ÊåáÊï∏
                            </h3>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <!-- Á∞°ÊΩîÂÑÄË°®Áõ§ -->
                        <div class="fear-greed-gauge" id="stockGauge">
                            <svg viewBox="0 0 200 115" class="gauge-svg">
                                <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                                <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                                <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                                <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                                <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                                <text x="8" y="105" class="gauge-tick-text">0</text>
                                <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                                <text x="188" y="105" class="gauge-tick-text">100</text>
                                <g id="stockNeedleGroup" class="gauge-needle-group">
                                    <polygon class="gauge-needle" points="100,25 97,100 103,100" />
                                </g>
                                <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                            </svg>
                        </div>
                        <div class="text-center mt-2">
                            <span id="stockGaugeValue" class="text-4xl font-bold text-gray-800">--</span>
                        </div>
                        <p id="stockSentimentStatus" class="text-center font-semibold text-lg mt-1"></p>
                        <p id="stockSentimentTime" class="text-xs text-gray-400 text-center mt-1"></p>
                        <p class="text-xs text-blue-500 text-center mt-2"><i class="fas fa-chart-line mr-1"></i>ÈªûÊìäÊü•ÁúãËµ∞Âã¢</p>
                    </div>
                    
                    <!-- Âπ£ÂúàÊÅêÊáºË≤™Â©™ÊåáÊï∏ -->
                    <div class="bg-white rounded-xl shadow p-4 md:p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="openSentimentModal('crypto', 'Âπ£ÂúàÊÅêÊáºË≤™Â©™ÊåáÊï∏')">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700 text-sm md:text-base">
                                <i class="fab fa-bitcoin mr-2 text-orange-500"></i>Âπ£ÂúàÊÅêÊáºË≤™Â©™ÊåáÊï∏
                            </h3>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <!-- Á∞°ÊΩîÂÑÄË°®Áõ§ -->
                        <div class="fear-greed-gauge" id="cryptoGauge">
                            <svg viewBox="0 0 200 115" class="gauge-svg">
                                <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                                <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                                <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                                <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                                <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                                <text x="8" y="105" class="gauge-tick-text">0</text>
                                <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                                <text x="188" y="105" class="gauge-tick-text">100</text>
                                <g id="cryptoNeedleGroup" class="gauge-needle-group">
                                    <polygon class="gauge-needle" points="100,25 97,100 103,100" />
                                </g>
                                <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                            </svg>
                        </div>
                        <div class="text-center mt-2">
                            <span id="cryptoGaugeValue" class="text-4xl font-bold text-gray-800">--</span>
                        </div>
                        <p id="cryptoSentimentStatus" class="text-center font-semibold text-lg mt-1"></p>
                        <p id="cryptoSentimentTime" class="text-xs text-gray-400 text-center mt-1"></p>
                        <p class="text-xs text-blue-500 text-center mt-2"><i class="fas fa-chart-line mr-1"></i>ÈªûÊìäÊü•ÁúãËµ∞Âã¢</p>
                    </div>
                </div>

                <!-- ËøΩËπ§Ê∏ÖÂñÆÂø´Ë¶Ω -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">ËøΩËπ§Ê∏ÖÂñÆ</h3>
                        <a href="#" onclick="showSection('watchlist')" class="text-blue-600 text-sm hover:underline">Êü•ÁúãÂÖ®ÈÉ®</a>
                    </div>
                    <div id="dashboardWatchlist">
                        <p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>
            </section>

            <!-- ===== ËÇ°Á•®Êü•Ë©¢ÂçÄÂ°ä ===== -->
            <section id="section-search" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">ËÇ°Á•®Êü•Ë©¢</h2>
                
                <!-- ÊêúÂ∞ãÊ°Ü -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4 md:mb-6">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="searchSymbol" placeholder="Ëº∏ÂÖ•ËÇ°Á•®‰ª£ËôüÔºàÂ¶Ç AAPL„ÄÅ2330Ôºâ" 
                            class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                            onkeypress="if(event.key==='Enter')searchStock()">
                        <button onclick="searchStock()" class="brand-orange text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center touch-target">
                            <i class="fas fa-search mr-2"></i>
                            <span>Êü•Ë©¢</span>
                        </button>
                    </div>
                    <p class="text-gray-500 text-xs md:text-sm mt-2">ÊîØÊè¥ÁæéËÇ°„ÄÅÂè∞ËÇ° (Ëº∏ÂÖ•Á¥îÊï∏Â≠óÂ¶Ç 2330) ÂèäÂä†ÂØÜË≤®Âπ£ (BTC, ETH)</p>
                </div>
                
                <!-- ÊêúÂ∞ãÁµêÊûú -->
                <div id="searchResult" class="hidden"></div>
            </section>

            <!-- ===== ËøΩËπ§Ê∏ÖÂñÆÂçÄÂ°ä ===== -->
            <section id="section-watchlist" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">ËøΩËπ§Ê∏ÖÂñÆ</h2>
                    <div class="flex items-center gap-2">
                        <!-- üÜï ÂåØÂá∫ÂåØÂÖ•ÊåâÈàï -->
                        <div class="relative">
                            <button onclick="toggleWatchlistMenu()" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-lg border hover:bg-gray-50" title="ÂåØÂá∫ÂåØÂÖ•">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <div id="watchlistMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50">
                                <button onclick="exportWatchlist('json')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-download mr-2 text-blue-500"></i>ÂåØÂá∫ JSON
                                </button>
                                <button onclick="exportWatchlist('csv')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv mr-2 text-green-500"></i>ÂåØÂá∫ CSV
                                </button>
                                <hr class="my-1">
                                <button onclick="showImportWatchlistModal()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-upload mr-2 text-orange-500"></i>ÂåØÂÖ•Ê∏ÖÂñÆ
                                </button>
                            </div>
                        </div>
                        <button onclick="showAddWatchlistModal()" class="brand-orange text-white px-4 py-2 rounded-lg font-medium flex items-center touch-target">
                            <i class="fas fa-plus mr-2"></i>
                            <span class="hidden sm:inline">Êñ∞Â¢û</span>
                        </button>
                    </div>
                </div>
                <div id="watchlistContent">
                    <p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                </div>
            </section>

            <!-- ===== Â∏ÇÂ†¥ÊÉÖÁ∑íÂçÄÂ°ä ===== -->
            <section id="section-sentiment" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">ÊÅêÊáºË≤™Â©™ÊåáÊï∏</h2>
                <div id="sentimentContent">
                    <p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                </div>
            </section>

            <!-- ===== Ëµ∞Âã¢ÊØîËºÉÂçÄÂ°ä ===== -->
            <section id="section-compare" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">Ëµ∞Âã¢ÊØîËºÉ</h2>
                
                <!-- Ëº∏ÂÖ•ÂçÄ -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-blue-500"></i>
                        ÈÅ∏ÊìáÊØîËºÉÊ®ôÁöÑ
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">Ëº∏ÂÖ•ËÇ°Á•®‰ª£ËôüÊàñÊåáÊï∏ÔºàÊúÄÂ§ö 5 ÂÄãÔºâÔºå‰ª•ÈÄóËôüÂàÜÈöî</p>
                    
                    <!-- Âø´ÈÄüÈÅ∏Êìá -->
                    <div class="mb-4">
                        <span class="text-sm text-gray-600 mr-2">Âø´ÈÄüÈÅ∏ÊìáÔºö</span>
                        <button onclick="addCompareSymbol('^GSPC')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">S&P 500</button>
                        <button onclick="addCompareSymbol('^DJI')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">ÈÅìÁìä</button>
                        <button onclick="addCompareSymbol('^IXIC')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">Á¥çÊñØÈÅîÂÖã</button>
                        <button onclick="addCompareSymbol('^TWII')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">Âè∞ËÇ°Âä†Ê¨ä</button>
                        <button onclick="addCompareSymbol('AAPL')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">AAPL</button>
                        <button onclick="addCompareSymbol('MSFT')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">MSFT</button>
                        <button onclick="addCompareSymbol('NVDA')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">NVDA</button>
                        <button onclick="addCompareSymbol('TSLA')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">TSLA</button>
                        <button onclick="addCompareSymbol('2330.TW')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">Âè∞Á©çÈõª</button>
                        <button onclick="addCompareSymbol('2317.TW')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">È¥ªÊµ∑</button>
                        <button onclick="addCompareSymbol('BTC-USD')" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded mr-1 mb-1">BTC</button>
                        <button onclick="addCompareSymbol('ETH-USD')" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded mr-1 mb-1">ETH</button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="compareSymbols" placeholder="‰æã: AAPL, MSFT, ^GSPC" 
                               class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <select id="compareDays" class="px-4 py-2 border rounded-lg bg-white">
                            <option value="30">1 ÂÄãÊúà</option>
                            <option value="90" selected>3 ÂÄãÊúà</option>
                            <option value="180">6 ÂÄãÊúà</option>
                            <option value="365">1 Âπ¥</option>
                        </select>
                        <button onclick="loadCompareChart()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-chart-line mr-2"></i>ÊØîËºÉ
                        </button>
                    </div>
                    
                    <!-- Â∑≤ÈÅ∏Ê®ôÁöÑ -->
                    <div id="selectedSymbols" class="flex flex-wrap gap-2 mt-3"></div>
                </div>
                
                <!-- ÂúñË°®ÂçÄ -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <div id="compareChartContainer" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-chart-line mr-2 text-green-500"></i>
                                Ëµ∞Âã¢ÊØîËºÉÂúñ
                            </h3>
                            <span class="text-sm text-gray-500">Ëµ∑ÂßãÊó• = 100%</span>
                        </div>
                        <div class="relative" style="height: 400px;">
                            <canvas id="compareChart"></canvas>
                        </div>
                    </div>
                    <div id="compareChartPlaceholder" class="text-center py-12">
                        <i class="fas fa-chart-line text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">ÈÅ∏ÊìáÊ®ôÁöÑÂæåÈ°ØÁ§∫ÊØîËºÉÂúñË°®</p>
                    </div>
                    <div id="compareChartLoading" class="hidden text-center py-12">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-4"></i>
                        <p class="text-gray-500">ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>
                
                <!-- ÊØîËºÉÁµêÊûúË°®Ê†º -->
                <div id="compareResultTable" class="bg-white rounded-xl shadow p-4 md:p-6 hidden">
                    <h3 class="font-semibold text-gray-700 mb-4">
                        <i class="fas fa-table mr-2 text-purple-500"></i>
                        ÊØîËºÉÁµêÊûú
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-2 px-3">Ê®ôÁöÑ</th>
                                    <th class="text-right py-2 px-3">Ëµ∑ÂßãÂÉπ</th>
                                    <th class="text-right py-2 px-3">ÊúÄÊñ∞ÂÉπ</th>
                                    <th class="text-right py-2 px-3">Êº≤Ë∑åÂπÖ</th>
                                </tr>
                            </thead>
                            <tbody id="compareTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ===== ÂÄã‰∫∫ÊäïË≥áË®òÈåÑÂçÄÂ°ä ===== -->
            <section id="section-portfolio" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">ÂÄã‰∫∫ÊäïË≥áË®òÈåÑ</h2>
                    <!-- üÜï ÂåØÂá∫ÂåØÂÖ•ÊåâÈàï -->
                    <div class="relative">
                        <button onclick="togglePortfolioMenu()" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-lg border hover:bg-gray-50" title="ÂåØÂá∫ÂåØÂÖ•">
                            <i class="fas fa-exchange-alt mr-1"></i>
                            <span class="hidden sm:inline text-sm">ÂåØÂá∫ÂåØÂÖ•</span>
                        </button>
                        <div id="portfolioMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border z-50">
                            <div class="px-3 py-2 text-xs text-gray-400 border-b">ÂåØÂá∫‰∫§ÊòìÁ¥ÄÈåÑ</div>
                            <button onclick="exportPortfolio('json', null)" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-download mr-2 text-blue-500"></i>ÂÖ®ÈÉ® (JSON)
                            </button>
                            <button onclick="exportPortfolio('csv', 'tw')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-file-csv mr-2 text-red-500"></i>Âè∞ËÇ° (CSV)
                            </button>
                            <button onclick="exportPortfolio('csv', 'us')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-file-csv mr-2 text-blue-500"></i>ÁæéËÇ° (CSV)
                            </button>
                            <hr class="my-1">
                            <div class="px-3 py-2 text-xs text-gray-400 border-b">ÂåØÂÖ•‰∫§ÊòìÁ¥ÄÈåÑ</div>
                            <button onclick="showImportPortfolioModal()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-upload mr-2 text-orange-500"></i>ÂåØÂÖ•Á¥ÄÈåÑ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊäïË≥áÁ∏ΩË¶ΩÔºà‰∏âÂçÄÔºöÂè∞ËÇ°„ÄÅÁæéËÇ°„ÄÅÂêàË®àÔºâ-->
                <div class="space-y-3 mb-4 md:mb-6">
                    <!-- Âè∞ËÇ°Áµ±Ë®à -->
                    <div class="bg-gradient-to-r from-red-500 to-rose-500 rounded-xl p-4 text-white">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-landmark mr-2"></i>
                            <h3 class="font-semibold">Âè∞ËÇ°</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ÁèæÂÄº</p>
                                <p id="twCurrentValue" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ÊêçÁõä</p>
                                <p id="twProfit" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">Â†±ÈÖ¨Áéá</p>
                                <p id="twReturnRate" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ÊåÅËÇ°Êï∏</p>
                                <p id="twPositions" class="font-bold">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÁæéËÇ°Áµ±Ë®à -->
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-4 text-white">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-flag-usa mr-2"></i>
                            <h3 class="font-semibold">ÁæéËÇ°</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ÁèæÂÄº (USD)</p>
                                <p id="usCurrentValue" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ÊêçÁõä</p>
                                <p id="usProfit" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">Â†±ÈÖ¨Áéá</p>
                                <p id="usReturnRate" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ÊåÅËÇ°Êï∏</p>
                                <p id="usPositions" class="font-bold">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂêàË®àÔºàTWDÔºâ-->
                    <div class="bg-gradient-to-r from-purple-600 to-violet-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <i class="fas fa-calculator mr-2"></i>
                                <h3 class="font-semibold">ÂêàË®à (TWD)</h3>
                            </div>
                            <div class="text-xs opacity-80">
                                <span>ÂåØÁéá: 1 USD = </span>
                                <span id="exchangeRateValue">--</span>
                                <span> TWD</span>
                                <span id="exchangeRateTime" class="ml-1 opacity-60"></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">Á∏ΩÁèæÂÄº</p>
                                <p id="totalValueTwd" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">Á∏ΩÊêçÁõä</p>
                                <p id="totalProfitTwd" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">Â†±ÈÖ¨Áéá</p>
                                <p id="totalReturnRate" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">Á∏ΩÊåÅËÇ°</p>
                                <p id="totalPositions" class="font-bold">--</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂàÜÈ†ÅÊ®ôÁ±§ -->
                <div class="flex border-b mb-4 overflow-x-auto">
                    <button onclick="switchPortfolioTab('holdings')" id="tabHoldings" class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap">
                        ÊåÅËÇ°Á∏ΩË¶Ω
                    </button>
                    <button onclick="switchPortfolioTab('tw-transactions')" id="tabTwTransactions" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
                        Âè∞ËÇ°Á¥ÄÈåÑ
                    </button>
                    <button onclick="switchPortfolioTab('us-transactions')" id="tabUsTransactions" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
                        ÁæéËÇ°Á¥ÄÈåÑ
                    </button>
                </div>
                
                <!-- ÊåÅËÇ°ÂÖßÂÆπ -->
                <div id="portfolioHoldings" class="space-y-4">
                    <!-- Âè∞ËÇ° -->
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-2">
                                    <i class="fas fa-landmark text-red-600 text-sm"></i>
                                </span>
                                <div>
                                    <h3 class="font-semibold text-gray-700">Âè∞ËÇ°</h3>
                                    <p id="twSummaryLine" class="text-xs text-gray-500">--</p>
                                </div>
                            </div>
                            <button onclick="showAddTwModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>Êñ∞Â¢û
                            </button>
                        </div>
                        <div id="holdingsTW" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                        </div>
                    </div>
                    
                    <!-- ÁæéËÇ° -->
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-2">
                                    <i class="fas fa-flag-usa text-blue-600 text-sm"></i>
                                </span>
                                <div>
                                    <h3 class="font-semibold text-gray-700">ÁæéËÇ°</h3>
                                    <p id="usSummaryLine" class="text-xs text-gray-500">--</p>
                                </div>
                            </div>
                            <button onclick="showAddUsModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>Êñ∞Â¢û
                            </button>
                        </div>
                        <div id="holdingsUS" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Âè∞ËÇ°‰∫§ÊòìÁ¥ÄÈåÑ -->
                <div id="portfolioTwTransactions" class="hidden">
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-landmark text-red-500 mr-2"></i>Âè∞ËÇ°‰∫§ÊòìÁ¥ÄÈåÑ
                            </h3>
                            <button onclick="showAddTwModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>Êñ∞Â¢û
                            </button>
                        </div>
                        <div id="twTransactionList" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                        </div>
                    </div>
                </div>
                
                <!-- ÁæéËÇ°‰∫§ÊòìÁ¥ÄÈåÑ -->
                <div id="portfolioUsTransactions" class="hidden">
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-flag-usa text-blue-500 mr-2"></i>ÁæéËÇ°‰∫§ÊòìÁ¥ÄÈåÑ
                            </h3>
                            <button onclick="showAddUsModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>Êñ∞Â¢û
                            </button>
                        </div>
                        <div id="usTransactionList" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                        </div>
                    </div>
                </div>
            </section>

            
            <!-- ===== Ë®ÇÈñ±Á≤æÈÅ∏ÂçÄÂ°ä ===== -->
            <section id="section-subscription" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">üì° Ë®ÇÈñ±Á≤æÈÅ∏</h2>
                    <button onclick="refreshSubscriptionPicks()" class="text-gray-500 hover:text-gray-700 p-2" title="ÈáçÊñ∞Êï¥ÁêÜ">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <!-- Ë®ÇÈñ±‰æÜÊ∫êÂç°Áâá -->
                <div id="subscriptionSourcesCard" class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-rss mr-2 text-orange-500"></i>
                        Ë®ÇÈñ±‰æÜÊ∫ê
                    </h3>
                    <div id="subscriptionSourcesList">
                        <p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>
                
                <!-- Á≤æÈÅ∏ËÇ°Á•®ÂàóË°® -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between">
                        <span>
                            <i class="fas fa-fire mr-2 text-red-500"></i>
                            Á≤æÈÅ∏ËÇ°Á•®
                        </span>
                        <span id="subscriptionPicksCount" class="text-sm text-gray-400"></span>
                    </h3>
                    <div id="subscriptionPicksList">
                        <p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>
            </section>

            <!-- ===== Ë®≠ÂÆöÂçÄÂ°ä ===== -->
            <section id="section-settings" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">Ë®≠ÂÆö</h2>
                
                <!-- Âø´ÈÄüÊ®°Êùø -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-magic mr-2 text-purple-500"></i>
                        Âø´ÈÄüÂ•óÁî®Ê®°Êùø
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="templateButtons">
                        <button onclick="applyTemplate('minimal')" data-template="minimal" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all">
                            <i class="fas fa-minus-circle text-gray-400 mr-1"></i>Ê•µÁ∞°
                        </button>
                        <button onclick="applyTemplate('standard')" data-template="standard" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all border-blue-500 bg-blue-50 text-blue-600">
                            <i class="fas fa-check-circle text-blue-500 mr-1"></i>Ê®ôÊ∫ñ
                        </button>
                        <button onclick="applyTemplate('full')" data-template="full" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all">
                            <i class="fas fa-layer-group text-green-500 mr-1"></i>ÂÆåÊï¥
                        </button>
                        <button onclick="applyTemplate('short_term')" data-template="short_term" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all">
                            <i class="fas fa-bolt text-yellow-500 mr-1"></i>Áü≠Á∑ö
                        </button>
                    </div>
                </div>

                <!-- ÊåáÊ®ôÈ°ØÁ§∫Ë®≠ÂÆö -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                        ÊåáÊ®ôÈ°ØÁ§∫Ë®≠ÂÆö
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">ÈÅ∏ÊìáÂú®ËÇ°Á•®ÂàÜÊûê‰∏≠Ë¶ÅÈ°ØÁ§∫ÁöÑÊäÄË°ìÊåáÊ®ô</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_ma" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">ÂùáÁ∑ö MA</span>
                                <span class="block text-xs text-gray-500">20/50/200Êó•</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_rsi" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">RSI</span>
                                <span class="block text-xs text-gray-500">Áõ∏Â∞çÂº∑Âº±ÊåáÊ®ô</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_macd" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">MACD</span>
                                <span class="block text-xs text-gray-500">ÊåáÊï∏Âπ≥ÊªëÁï∞Âêå</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_kd" class="indicator-toggle w-5 h-5 text-blue-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">KD</span>
                                <span class="block text-xs text-gray-500">Èö®Ê©üÊåáÊ®ô</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_bollinger" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">Â∏ÉÊûóÈÄöÈÅì</span>
                                <span class="block text-xs text-gray-500">Bollinger Bands</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_obv" class="indicator-toggle w-5 h-5 text-blue-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">OBV</span>
                                <span class="block text-xs text-gray-500">ËÉΩÈáèÊΩÆÊåáÊ®ô</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_volume" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">Êàê‰∫§Èáè</span>
                                <span class="block text-xs text-gray-500">Volume</span>
                            </span>
                        </label>
                    </div>
                    <button onclick="saveIndicatorSettings()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-save mr-2"></i>ÂÑ≤Â≠òÊåáÊ®ôË®≠ÂÆö
                    </button>
                </div>

                <!-- ÈÄöÁü•Ë®≠ÂÆö -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-bell mr-2 text-yellow-500"></i>
                        ÈÄöÁü•Ë®≠ÂÆö
                        <span class="ml-2 text-xs text-gray-400">(Âç≥Â∞áÊé®Âá∫)</span>
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">ÈÅ∏ÊìáË¶ÅÊé•Êî∂ÁöÑÊäÄË°ìË®äËôüÈÄöÁü•</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_ma_cross" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">ÂùáÁ∑ö‰∫§Âèâ</span>
                                <span class="block text-xs text-gray-500">ÈªÉÈáë‰∫§Âèâ/Ê≠ª‰∫°‰∫§Âèâ</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_ma_breakout" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">ÂùáÁ∑öÁ™ÅÁ†¥</span>
                                <span class="block text-xs text-gray-500">ÂÉπÊ†ºÁ©øË∂äÂùáÁ∑ö</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_rsi" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">RSI Ë∂ÖË≤∑Ë∂ÖË≥£</span>
                                <span class="block text-xs text-gray-500">ÈÄ≤ÂÖ•Ê•µÁ´ØÂçÄÂüü</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_macd" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">MACD ‰∫§Âèâ</span>
                                <span class="block text-xs text-gray-500">DIF Á©øË∂ä MACD</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_kd" class="alert-toggle w-5 h-5 text-yellow-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">KD ‰∫§Âèâ</span>
                                <span class="block text-xs text-gray-500">K Á©øË∂ä D</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_bollinger" class="alert-toggle w-5 h-5 text-yellow-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">Â∏ÉÊûóÁ™ÅÁ†¥</span>
                                <span class="block text-xs text-gray-500">Ëß∏Âèä‰∏ä‰∏ãËªå</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_volume" class="alert-toggle w-5 h-5 text-yellow-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">ÈáèËÉΩÁï∞Â∏∏</span>
                                <span class="block text-xs text-gray-500">Êàê‰∫§ÈáèÊö¥Â¢û</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_sentiment" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">ÊÉÖÁ∑íÊ•µÁ´Ø</span>
                                <span class="block text-xs text-gray-500">Ê•µÂ∫¶ÊÅêÊáº/Ë≤™Â©™</span>
                            </span>
                        </label>
                    </div>
                    <button onclick="saveAlertSettings()" class="mt-4 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                        <i class="fas fa-save mr-2"></i>ÂÑ≤Â≠òÈÄöÁü•Ë®≠ÂÆö
                    </button>
                </div>

                <!-- ÊåáÊ®ôÂèÉÊï∏ -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-green-500"></i>
                        ÊåáÊ®ôÂèÉÊï∏Ë™øÊï¥
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">Ëá™Ë®ÇÊäÄË°ìÊåáÊ®ôÁöÑË®àÁÆóÂèÉÊï∏</p>
                    
                    <!-- ÂùáÁ∑öÂèÉÊï∏ -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">ÂùáÁ∑öÈÄ±Êúü</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Áü≠ÊúüÂùáÁ∑ö</label>
                                <input type="number" id="ma_short" value="20" min="5" max="50" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">‰∏≠ÊúüÂùáÁ∑ö</label>
                                <input type="number" id="ma_mid" value="50" min="20" max="100" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Èï∑ÊúüÂùáÁ∑ö</label>
                                <input type="number" id="ma_long" value="200" min="50" max="300" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <!-- RSI ÂèÉÊï∏ -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">RSI ÂèÉÊï∏</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">RSI ÈÄ±Êúü</label>
                                <input type="number" id="rsi_period" value="14" min="5" max="30" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ë∂ÖË≤∑ÈñÄÊ™ª</label>
                                <input type="number" id="rsi_overbought" value="70" min="60" max="90" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ë∂ÖË≥£ÈñÄÊ™ª</label>
                                <input type="number" id="rsi_oversold" value="30" min="10" max="40" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <!-- MACD ÂèÉÊï∏ -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">MACD ÂèÉÊï∏</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Âø´Á∑öÈÄ±Êúü</label>
                                <input type="number" id="macd_fast" value="12" min="5" max="20" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ÊÖ¢Á∑öÈÄ±Êúü</label>
                                <input type="number" id="macd_slow" value="26" min="15" max="40" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ë®äËôüÁ∑ö</label>
                                <input type="number" id="macd_signal" value="9" min="5" max="15" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂÖ∂‰ªñÂèÉÊï∏ -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">ÂÖ∂‰ªñÂèÉÊï∏</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">KD ÈÄ±Êúü</label>
                                <input type="number" id="kd_period" value="9" min="5" max="20" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Â∏ÉÊûóÈÄ±Êúü</label>
                                <input type="number" id="bollinger_period" value="20" min="10" max="30" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Á™ÅÁ†¥È†êË≠¶%</label>
                                <input type="number" id="breakout_threshold" value="2.0" min="0.5" max="5" step="0.5" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ÈáèÊØîË≠¶Êàí</label>
                                <input type="number" id="volume_alert_ratio" value="2.0" min="1.5" max="5" step="0.5" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="saveParamSettings()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            <i class="fas fa-save mr-2"></i>ÂÑ≤Â≠òÂèÉÊï∏
                        </button>
                        <button onclick="resetParams()" class="px-4 py-2 border text-gray-600 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-undo mr-2"></i>ÊÅ¢Âæ©È†êË®≠
                        </button>
                    </div>
                </div>

                <!-- Â∏≥ËôüË≥áË®ä -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-user mr-2 text-gray-500"></i>
                        Â∏≥ËôüË≥áË®ä
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-500">Áî®Êà∂ÂêçÁ®±</span>
                            <span id="settingsUserName" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-500">ÊúÉÂì°Á≠âÁ¥ö</span>
                            <span id="settingsMemberLevel" class="font-medium text-orange-500">‰∏ÄËà¨ÊúÉÂì°</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-500">Á≥ªÁµ±ÁâàÊú¨</span>
                            <span class="font-medium">v0.5.3</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="mt-4 w-full py-3 border border-red-500 text-red-500 rounded-lg font-medium hover:bg-red-50">
                        <i class="fas fa-sign-out-alt mr-2"></i>ÁôªÂá∫
                    </button>
                </div>
            </section>
            
        </main>

        <!-- ===== ÊâãÊ©üÁâàÂ∫ïÈÉ®Â∞éËà™Âàó ===== -->
        <nav class="mobile-bottom-nav">
            <a href="#" onclick="mobileNavTo('dashboard')" class="bottom-nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>È¶ñÈ†Å</span>
            </a>
            <a href="#" onclick="mobileNavTo('search')" class="bottom-nav-item" data-section="search">
                <i class="fas fa-search"></i>
                <span>Êü•Ë©¢</span>
            </a>
            <a href="#" onclick="mobileNavTo('watchlist')" class="bottom-nav-item" data-section="watchlist">
                <i class="fas fa-star"></i>
                <span>ËøΩËπ§</span>
            </a>
            <a href="#" onclick="mobileNavTo('sentiment')" class="bottom-nav-item" data-section="sentiment">
                <i class="fas fa-heart-pulse"></i>
                <span>ÊÉÖÁ∑í</span>
            </a>
            <a href="#" onclick="mobileNavTo('settings')" class="bottom-nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Ë®≠ÂÆö</span>
            </a>
        </nav>

    </div><!-- end app-content -->

    <!-- ===== ÂÖ®Ëû¢ÂπïÂúñË°® ===== -->
    <div id="chartFullscreen" class="chart-fullscreen">
        <!-- ÂúñË°®ÂÆπÂô® -->
        <div class="chart-container h-full flex flex-col">
            <!-- Ê©´ÊîæÊèêÈÜíÊ©´Ê¢ù (ÊâãÊ©üÁõ¥Á´ãÊôÇÈ°ØÁ§∫) -->
            <div class="rotate-banner">
                üì± Ê©´ÂêëÊîæÁΩÆÊâãÊ©üÂèØÁç≤ÂæóÊõ¥Â•ΩÁöÑÂúñË°®È´îÈ©ó
            </div>
            <div class="flex items-center justify-between p-3 border-b bg-white">
                <button onclick="closeChartFullscreen()" class="p-2 text-gray-600 touch-target">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <span id="chartFullscreenTitle" class="font-bold text-lg"></span>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 p-4 bg-gray-50" style="min-height: 200px;">
                <canvas id="fullscreenChart"></canvas>
            </div>
            <div class="flex items-center justify-center gap-2 p-3 bg-white border-t" id="chartRangeButtons">
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="22">1M</button>
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target active" data-days="65">3M</button>
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="130">6M</button>
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="252">1Y</button>
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="756">3Y</button>
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="1260">5Y</button>
                <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="99999">MAX</button>
            </div>
        </div>
    </div>
    
    <!-- ===== ÊåáÊï∏ÂúñË°® Modal ===== -->
    <div id="indexChartModal" class="chart-fullscreen">
        <div class="chart-container h-full flex flex-col">
            <div class="rotate-banner">
                üì± Ê©´ÂêëÊîæÁΩÆÊâãÊ©üÂèØÁç≤ÂæóÊõ¥Â•ΩÁöÑÂúñË°®È´îÈ©ó
            </div>
            <div class="flex items-center justify-between p-3 border-b bg-white">
                <button onclick="closeIndexModal()" class="p-2 text-gray-600 touch-target">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <span id="indexModalTitle" class="font-bold text-lg"></span>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 p-4 bg-gray-50" style="min-height: 200px;">
                <canvas id="indexModalChart"></canvas>
            </div>
            <div class="flex items-center justify-center gap-2 p-3 bg-white border-t">
                <button type="button" onclick="loadIndexModalChart(30)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target">1M</button>
                <button type="button" onclick="loadIndexModalChart(90)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target">3M</button>
                <button type="button" onclick="loadIndexModalChart(365)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target active">1Y</button>
                <button type="button" onclick="loadIndexModalChart(1825)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target">5Y</button>
            </div>
        </div>
    </div>
    
    <!-- ===== ÊÉÖÁ∑íÂúñË°® Modal ===== -->
    <div id="sentimentChartModal" class="chart-fullscreen">
        <div class="chart-container h-full flex flex-col">
            <div class="rotate-banner">
                üì± Ê©´ÂêëÊîæÁΩÆÊâãÊ©üÂèØÁç≤ÂæóÊõ¥Â•ΩÁöÑÂúñË°®È´îÈ©ó
            </div>
            <div class="flex items-center justify-between p-3 border-b bg-white">
                <button onclick="closeSentimentModal()" class="p-2 text-gray-600 touch-target">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <span id="sentimentModalTitle" class="font-bold text-lg"></span>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 p-4 bg-gray-50" style="min-height: 200px;">
                <canvas id="sentimentModalChart"></canvas>
            </div>
            <div class="flex items-center justify-center gap-2 p-3 bg-white border-t">
                <button type="button" onclick="loadSentimentModalChart(30)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target">1M</button>
                <button type="button" onclick="loadSentimentModalChart(90)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target">3M</button>
                <button type="button" onclick="loadSentimentModalChart(180)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target active">6M</button>
                <button type="button" onclick="loadSentimentModalChart(365)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target">1Y</button>
            </div>
        </div>
    </div>

    <!-- ===== Âπ¥ÂåñÂ†±ÈÖ¨Áéá Modal ===== -->
    <div id="returnsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-percentage text-green-600 mr-2"></i>
                    <span id="returnsModalTitle">Âπ¥ÂåñÂ†±ÈÖ¨Áéá</span>
                </h3>
                <button onclick="closeReturnsModal()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="returnsModalContent" class="p-4">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
                    <p class="mt-2 text-gray-500">Ë®àÁÆó‰∏≠...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Âè∞ËÇ°‰∫§Êòì Modal ===== -->
    <div id="twTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-landmark text-red-500 mr-2"></i>
                    <span id="twModalTitle">Êñ∞Â¢ûÂè∞ËÇ°‰∫§Êòì</span>
                </h3>
                <button onclick="closeTwModal()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="hidden" id="twEditId">
                
                <!-- ‰∫§ÊòìÈ°ûÂûã -->
                <div class="flex gap-2 mb-4">
                    <button type="button" onclick="setTwType('buy')" id="twBtnBuy" class="flex-1 py-2 rounded-lg font-medium transition-all bg-green-500 text-white">
                        <i class="fas fa-arrow-down mr-1"></i>Ë≤∑ÂÖ•
                    </button>
                    <button type="button" onclick="setTwType('sell')" id="twBtnSell" class="flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600">
                        <i class="fas fa-arrow-up mr-1"></i>Ë≥£Âá∫
                    </button>
                </div>
                <input type="hidden" id="twTxType" value="buy">
                
                <!-- ËÇ°Á•®‰ª£Á¢º -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ËÇ°Á•®‰ª£Á¢º <span class="text-red-500">*</span></label>
                    <input type="text" id="twSymbol" placeholder="‰æã: 2330" 
                           oninput="lookupTwStock()"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                </div>
                
                <!-- ËÇ°Á•®ÂêçÁ®±ÔºàÂîØËÆÄÔºâ -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ËÇ°Á•®ÂêçÁ®±</label>
                    <div id="twNameDisplay" class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-600 min-h-[42px] flex items-center">
                        <span class="text-gray-400">Ëº∏ÂÖ•‰ª£Á¢ºËá™ÂãïÂ∏∂ÂÖ•</span>
                    </div>
                    <input type="hidden" id="twName">
                </div>
                
                <!-- Êï∏ÈáèÔºöÂºµ + Èõ∂ËÇ° -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">Êï∏Èáè <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <input type="number" id="twLots" placeholder="0" min="0"
                                   oninput="updateTwQuantity()"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 pr-10">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">Âºµ</span>
                        </div>
                        <div class="relative">
                            <input type="number" id="twOddLot" placeholder="0" min="0" max="999"
                                   oninput="updateTwQuantity()"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 pr-12">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">Èõ∂ËÇ°</span>
                        </div>
                    </div>
                    <p id="twQuantityDisplay" class="text-xs text-gray-500 mt-1">= 0 ËÇ°</p>
                </div>
                
                <!-- Êàê‰∫§ÂÉπÂíåÊâãÁ∫åË≤ª -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2 text-sm">Êàê‰∫§ÂÉπ <span class="text-red-500">*</span></label>
                        <input type="number" id="twPrice" placeholder="850" step="0.01" min="0.01"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2 text-sm">ÊâãÁ∫åË≤ª</label>
                        <input type="number" id="twFee" placeholder="0" step="1" min="0"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                    </div>
                </div>
                
                <!-- ‰∫§ÊòìÁ®Ö -->
                <div class="mb-4" id="twTaxField">
                    <label class="block text-gray-700 mb-2 text-sm">‰∫§ÊòìÁ®ÖÔºàË≥£Âá∫Ôºâ</label>
                    <input type="number" id="twTax" placeholder="0" step="1" min="0"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                </div>
                
                <!-- ‰∫§ÊòìÊó•Êúü -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">‰∫§ÊòìÊó•Êúü <span class="text-red-500">*</span></label>
                    <input type="date" id="twDate" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                </div>
                
                <!-- ÂÇôË®ª -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ÂÇôË®ª</label>
                    <input type="text" id="twNote" placeholder="ÈÅ∏Â°´" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                </div>
                
                <!-- ÈÄÅÂá∫ -->
                <button onclick="submitTwTransaction()" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">
                    <i class="fas fa-check mr-2"></i>Á¢∫Ë™ç
                </button>
            </div>
        </div>
    </div>

    <!-- ===== ÁæéËÇ°‰∫§Êòì Modal ===== -->
    <div id="usTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-flag-usa text-blue-500 mr-2"></i>
                    <span id="usModalTitle">Êñ∞Â¢ûÁæéËÇ°‰∫§Êòì</span>
                </h3>
                <button onclick="closeUsModal()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="hidden" id="usEditId">
                
                <!-- ‰∫§ÊòìÈ°ûÂûã -->
                <div class="flex gap-2 mb-4">
                    <button type="button" onclick="setUsType('buy')" id="usBtnBuy" class="flex-1 py-2 rounded-lg font-medium transition-all bg-green-500 text-white">
                        <i class="fas fa-arrow-down mr-1"></i>Ë≤∑ÂÖ•
                    </button>
                    <button type="button" onclick="setUsType('sell')" id="usBtnSell" class="flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600">
                        <i class="fas fa-arrow-up mr-1"></i>Ë≥£Âá∫
                    </button>
                </div>
                <input type="hidden" id="usTxType" value="buy">
                
                <!-- ËÇ°Á•®‰ª£Á¢º -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ËÇ°Á•®‰ª£Á¢º <span class="text-red-500">*</span></label>
                    <input type="text" id="usSymbol" placeholder="‰æã: AAPL" 
                           oninput="lookupUsStock()"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 uppercase">
                </div>
                
                <!-- ËÇ°Á•®ÂêçÁ®±ÔºàÂîØËÆÄÔºâ -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ËÇ°Á•®ÂêçÁ®±</label>
                    <div id="usNameDisplay" class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-600 min-h-[42px] flex items-center">
                        <span class="text-gray-400">Ëº∏ÂÖ•‰ª£Á¢ºËá™ÂãïÂ∏∂ÂÖ•</span>
                    </div>
                    <input type="hidden" id="usName">
                </div>
                
                <!-- ËÇ°Êï∏ -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ËÇ°Êï∏ <span class="text-red-500">*</span></label>
                    <input type="number" id="usQuantity" placeholder="10" min="1"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Êàê‰∫§ÂÉπÂíåÊâãÁ∫åË≤ª -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2 text-sm">Êàê‰∫§ÂÉπ (USD) <span class="text-red-500">*</span></label>
                        <input type="number" id="usPrice" placeholder="185.50" step="0.01" min="0.01"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2 text-sm">ÊâãÁ∫åË≤ª</label>
                        <input type="number" id="usFee" placeholder="0" step="0.01" min="0"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- ‰∫§ÊòìÁ®Ö -->
                <div class="mb-4" id="usTaxField">
                    <label class="block text-gray-700 mb-2 text-sm">‰∫§ÊòìÁ®ÖÔºàË≥£Âá∫Ôºâ</label>
                    <input type="number" id="usTax" placeholder="0" step="0.01" min="0"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- ‰∫§ÊòìÊó•Êúü -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">‰∫§ÊòìÊó•Êúü <span class="text-red-500">*</span></label>
                    <input type="date" id="usDate" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- ÂÇôË®ª -->
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 text-sm">ÂÇôË®ª</label>
                    <input type="text" id="usNote" placeholder="ÈÅ∏Â°´" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- ÈÄÅÂá∫ -->
                <button onclick="submitUsTransaction()" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                    <i class="fas fa-check mr-2"></i>Á¢∫Ë™ç
                </button>
            </div>
        </div>
    </div>

    <!-- ===== Êñ∞Â¢ûËøΩËπ§Ê∏ÖÂñÆ Modal ===== -->
    <div id="addWatchlistModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Êñ∞Â¢ûËøΩËπ§</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">ËÇ°Á•®/Âä†ÂØÜË≤®Âπ£‰ª£Ëôü</label>
                    <input type="text" id="addSymbol" placeholder="Â¶Ç AAPL„ÄÅBTC" 
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">È°ûÂûã</label>
                    <select id="addAssetType" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                        <option value="stock">ËÇ°Á•®</option>
                        <option value="crypto">Âä†ÂØÜË≤®Âπ£</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">ÂÇôË®ªÔºàÈÅ∏Â°´Ôºâ</label>
                    <input type="text" id="addNote" placeholder="Ëá™Ë®ÇÂÇôË®ª" 
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideAddWatchlistModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">ÂèñÊ∂à</button>
                <button onclick="addToWatchlist()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 touch-target">Êñ∞Â¢û</button>
            </div>
        </div>
    </div>

    <!-- ===== üÜï ÂåØÂÖ•ËøΩËπ§Ê∏ÖÂñÆ Modal ===== -->
    <div id="importWatchlistModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-upload mr-2 text-orange-500"></i>ÂåØÂÖ•ËøΩËπ§Ê∏ÖÂñÆ
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">ÈÅ∏ÊìáÊ™îÊ°à (JSON Êàñ CSV)</label>
                    <input type="file" id="importWatchlistFile" accept=".json,.csv" onchange="previewWatchlistFile(this)"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                </div>
                <div id="importWatchlistPreview" class="min-h-[60px]"></div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        CSV Ê†ºÂºèÈúÄÂåÖÂê´ symbol Ê¨Ñ‰ΩçÔºåÂèØÈÅ∏ asset_type, note, target_price
                    </p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideImportWatchlistModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">ÂèñÊ∂à</button>
                <button onclick="importWatchlist()" class="flex-1 px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 touch-target">ÂåØÂÖ•</button>
            </div>
        </div>
    </div>

    <!-- ===== üÜï ÂåØÂÖ•ÊåÅËÇ°‰∫§Êòì Modal ===== -->
    <div id="importPortfolioModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-upload mr-2 text-orange-500"></i>ÂåØÂÖ•‰∫§ÊòìÁ¥ÄÈåÑ
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">ÈÅ∏ÊìáÊ™îÊ°à (JSON Êàñ CSV)</label>
                    <input type="file" id="importPortfolioFile" accept=".json,.csv" onchange="previewPortfolioFile(this)"
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                </div>
                <div id="importPortfolioPreview" class="min-h-[60px]"></div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        ÂøÖÂ°´Ê¨Ñ‰Ωç: symbol, quantity, price, transaction_date (YYYY-MM-DD)<br>
                        ÂèØÈÅ∏Ê¨Ñ‰Ωç: name, market (tw/us), transaction_type (buy/sell), fee, tax, note
                    </p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideImportPortfolioModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">ÂèñÊ∂à</button>
                <button onclick="importPortfolio()" class="flex-1 px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 touch-target">ÂåØÂÖ•</button>
            </div>
        </div>
    </div>

    <!-- ===== üÜï ÁõÆÊ®ôÂÉπË®≠ÂÆö Modal ===== -->
    <div id="targetPriceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
                <i class="fas fa-crosshairs mr-2 text-yellow-500"></i>Ë®≠ÂÆöÁõÆÊ®ôÂÉπ
            </h3>
            <div class="space-y-4">
                <div class="text-center">
                    <span id="targetPriceSymbol" class="text-2xl font-bold text-gray-800"></span>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 text-sm">ÁõÆÊ®ôÂÉπÊ†º</label>
                    <input type="number" id="targetPriceInput" step="0.01" placeholder="Ëº∏ÂÖ•ÁõÆÊ®ôÂÉπÊ†º" 
                        class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-yellow-500 text-base text-center text-lg">
                </div>
                <p class="text-xs text-gray-500 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Áï∂ÁèæÂÉπÈÅîÂà∞ÊàñË∂ÖÈÅéÁõÆÊ®ôÂÉπÊôÇÔºåÊúÉ‰ª•ÈªÉËâ≤È´ò‰∫ÆÊèêÈÜí
                </p>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideTargetPriceModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">ÂèñÊ∂à</button>
                <button onclick="clearTargetPrice()" class="px-4 py-3 text-red-500 hover:bg-red-50 rounded-lg touch-target">Ê∏ÖÈô§</button>
                <button onclick="saveTargetPrice()" class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 touch-target">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- ===== Toast ÈÄöÁü• ===== -->
    <div id="toast" class="fixed bottom-20 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-auto bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity text-center">
        <span id="toastMessage"></span>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let currentChartData = null;
        let fullscreenChartInstance = null;
        
        // ========== API Ë´ãÊ±ÇÂ∞ÅË£ùÔºàÂ∏∂Ë∫´‰ªΩÈ©óË≠âÔºâ==========
        async function apiRequest(endpoint, options = {}) {
            // Á¢∫‰øùÊúâ token
            if (!token) {
                console.error('API Ë´ãÊ±ÇÂ§±Êïó: ÁÑ° token');
                clearAllUserData();
                window.location.href = '/static/index.html';
                throw new Error('Êú™ÁôªÂÖ•');
            }
            
            // Ë®≠ÂÆö headers
            const headers = {
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };
            
            if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });
                
                // Â¶ÇÊûú 401ÔºåË°®Á§∫ token ÁÑ°Êïà
                if (res.status === 401) {
                    console.error('Token ÁÑ°ÊïàÔºåÈáçÊñ∞ÁôªÂÖ•');
                    clearAllUserData();
                    window.location.href = '/static/index.html';
                    throw new Error('Token ÁÑ°Êïà');
                }
                
                return res;
            } catch (e) {
                console.error(`API Ë´ãÊ±ÇÂ§±Êïó ${endpoint}:`, e);
                throw e;
            }
        }
        
        // ========== Ë®≠ÂÇôÊ™¢Ê∏¨ ==========
        const deviceInfo = {
            isMobile: window.innerWidth < 768,
            isTouch: 'ontouchstart' in window,
            isLineApp: /Line\//i.test(navigator.userAgent),
            isIOS: /iPhone|iPad/i.test(navigator.userAgent),
            isAndroid: /Android/i.test(navigator.userAgent),
        };
        
        console.log('Device info:', deviceInfo);
        
        // ========== Ëá™ÂãïÁôªÂá∫ÂäüËÉΩ ==========
        // üÜï Ê†πÊìöÁî®Êà∂ËßíËâ≤Ë®≠ÂÆö‰∏çÂêåÁöÑÈñíÁΩÆÊôÇÈñì
        // ‰∏ÄËà¨Áî®Êà∂Ôºö10 ÂàÜÈêòÔºåÁÆ°ÁêÜÂì°Ôºö1 Â∞èÊôÇ
        function getSessionTimeout() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const isAdmin = user.is_admin === true;
            return isAdmin ? 60 * 60 * 1000 : 10 * 60 * 1000;  // 60ÂàÜÈêò or 10ÂàÜÈêò
        }
        
        let sessionTimer = null;
        let lastActivity = Date.now();
        
        function resetSessionTimer() {
            lastActivity = Date.now();
        }
        
        function checkSessionTimeout() {
            const SESSION_TIMEOUT = getSessionTimeout();
            const elapsed = Date.now() - lastActivity;
            const remaining = SESSION_TIMEOUT - elapsed;
            
            // ÂèñÂæóÁî®Êà∂ËßíËâ≤Áî®ÊñºÈ°ØÁ§∫
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const isAdmin = user.is_admin === true;
            const timeoutMinutes = isAdmin ? 60 : 10;
            
            if (remaining <= 0) {
                showToast(`ÈñíÁΩÆË∂ÖÈÅé ${timeoutMinutes} ÂàÜÈêòÔºåÂ∑≤Ëá™ÂãïÁôªÂá∫`);
                setTimeout(() => logout(), 1500);
            } else {
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                const timerEl = document.getElementById('sessionTimer');
                const sidebarTimerEl = document.getElementById('sidebarTimer');
                if (timerEl) timerEl.textContent = `ÈñíÁΩÆÁôªÂá∫: ${timeStr}`;
                if (sidebarTimerEl) sidebarTimerEl.textContent = timeStr;
            }
        }
        
        function startSessionMonitor() {
            ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetSessionTimer, { passive: true });
            });
            sessionTimer = setInterval(checkSessionTimeout, 1000);
        }
        
        function stopSessionMonitor() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }
        
        // ========== ÁôªÂÖ•È©óË≠â ==========
        async function checkAuth() {
            if (!token) {
                console.log('ÁÑ° tokenÔºåË∑≥ËΩâÁôªÂÖ•È†Å');
                clearAllUserData();
                window.location.href = '/static/index.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    console.error('Token È©óË≠âÂ§±ÊïóÔºåÁãÄÊÖãÁ¢º:', res.status);
                    throw new Error('Unauthorized');
                }
                
                const serverUser = await res.json();
                
                // ‚òÖ‚òÖ‚òÖ ÈáçË¶ÅÔºöÈ©óË≠âÊú¨Âú∞Áî®Êà∂Ëàá‰º∫ÊúçÂô®Áî®Êà∂‰∏ÄËá¥ ‚òÖ‚òÖ‚òÖ
                const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                if (storedUser.id && storedUser.id !== serverUser.id) {
                    console.error('Áî®Êà∂ ID ‰∏ç‰∏ÄËá¥! Êú¨Âú∞:', storedUser.id, '‰º∫ÊúçÂô®:', serverUser.id);
                    console.error('ÂèØËÉΩÊòØË≥áÊñôÈåØ‰∫ÇÔºåÂº∑Âà∂ÈáçÊñ∞ÁôªÂÖ•');
                    clearAllUserData();
                    window.location.href = '/static/index.html';
                    return;
                }
                
                if (storedUser.line_user_id && storedUser.line_user_id !== serverUser.line_user_id) {
                    console.error('LINE ID ‰∏ç‰∏ÄËá¥! Êú¨Âú∞:', storedUser.line_user_id, '‰º∫ÊúçÂô®:', serverUser.line_user_id);
                    console.error('ÂèØËÉΩÊòØË≥áÊñôÈåØ‰∫ÇÔºåÂº∑Âà∂ÈáçÊñ∞ÁôªÂÖ•');
                    clearAllUserData();
                    window.location.href = '/static/index.html';
                    return;
                }
                
                currentUser = serverUser;
                
                // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÑ≤ÔºàÁ¢∫‰øùËàá‰º∫ÊúçÂô®ÂêåÊ≠•Ôºâ
                localStorage.setItem('user', JSON.stringify({
                    id: serverUser.id,
                    display_name: serverUser.display_name,
                    picture_url: serverUser.picture_url || '',
                    line_user_id: serverUser.line_user_id,
                    is_admin: serverUser.is_admin || false
                }));
                
                console.log('ÁôªÂÖ•È©óË≠âÊàêÂäü: Áî®Êà∂ ID =', serverUser.id, ', LINE ID =', serverUser.line_user_id);
                
                // Êõ¥Êñ∞Áî®Êà∂Ë≥áË®ä
                document.getElementById('userName').textContent = currentUser.display_name;
                document.getElementById('userAvatar').src = currentUser.picture_url || 'https://via.placeholder.com/40';
                document.getElementById('sidebarUserName').textContent = currentUser.display_name;
                document.getElementById('sidebarAvatar').src = currentUser.picture_url || 'https://via.placeholder.com/40';
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°ÔºåÈ°ØÁ§∫ÁÆ°ÁêÜÂÖ•Âè£
                if (currentUser.is_admin) {
                    document.getElementById('adminLink').classList.remove('hidden');
                    const adminSidebarLink = document.getElementById('adminSidebarLink');
                    if (adminSidebarLink) adminSidebarLink.classList.remove('hidden');
                    
                    // üÜï ÁÆ°ÁêÜÂì°ÁôªÂÖ•ÊôÇËß∏ÁôºÂÖ®ÈÉ®Êõ¥Êñ∞
                    triggerAdminUpdates();
                }
                
                // È°ØÁ§∫‰∏ªÂÖßÂÆπ
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                
                startSessionMonitor();
                loadDashboard();
            } catch (e) {
                console.error('È©óË≠âÂ§±Êïó:', e);
                clearAllUserData();
                window.location.href = '/static/index.html';
            }
        }
        
        // ‚òÖ‚òÖ‚òÖ Ê∏ÖÈô§ÊâÄÊúâÁî®Êà∂Ë≥áÊñô ‚òÖ‚òÖ‚òÖ
        function clearAllUserData() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('login_time');
            sessionStorage.clear();
            currentUser = null;
            token = null;
        }

        function logout() {
            stopSessionMonitor();
            clearAllUserData();
            window.location.href = '/static/index.html';
        }

        // ========== ÊâãÊ©üÁâàÈÅ∏ÂñÆ ==========
        function openMobileSidebar() {
            document.getElementById('mobileSidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileSidebar() {
            document.getElementById('mobileSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
            document.body.style.overflow = '';
        }
        
        function mobileNavTo(section) {
            closeMobileSidebar();
            showSection(section);
            
            // Êõ¥Êñ∞Â∫ïÈÉ®Â∞éËà™ÂíåÂÅ¥ÈÇäÈÅ∏ÂñÆÈ´ò‰∫Æ
            document.querySelectorAll('.bottom-nav-item, .mobile-nav-link').forEach(el => {
                el.classList.remove('active', 'bg-blue-50', 'text-gray-700');
                if (el.dataset.section === section) {
                    el.classList.add('active');
                    if (el.classList.contains('mobile-nav-link')) {
                        el.classList.add('bg-blue-50', 'text-gray-700');
                    }
                } else if (el.classList.contains('mobile-nav-link')) {
                    el.classList.add('text-gray-600');
                }
            });
        }

        // ========== ÂàáÊèõÂçÄÂ°ä ==========
        function showSection(name, evt) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const section = document.getElementById(`section-${name}`);
            if (section) {
                section.classList.remove('hidden');
            }
            
            // Êõ¥Êñ∞ÈõªËÖ¶ÁâàÂ∞éËà™È´ò‰∫Æ
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('bg-blue-50', 'text-gray-700');
                l.classList.add('text-gray-600');
            });
            
            if (evt && evt.target) {
                const navLink = evt.target.closest('.nav-link');
                if (navLink) {
                    navLink.classList.add('bg-blue-50', 'text-gray-700');
                    navLink.classList.remove('text-gray-600');
                }
            }
            
            // Êõ¥Êñ∞Â∫ïÈÉ®Â∞éËà™È´ò‰∫Æ
            document.querySelectorAll('.bottom-nav-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.section === name) {
                    el.classList.add('active');
                }
            });

            // ËºâÂÖ•Â∞çÊáâË≥áÊñô
            if (name === 'watchlist') loadWatchlist();
            if (name === 'sentiment') loadSentimentDetail();
            if (name === 'settings') loadSettings();
            if (name === 'portfolio') loadPortfolio();
            if (name === 'subscription') loadSubscriptionData();
        }

        // ========== ËºâÂÖ•ÂÑÄË°®Êùø ==========
        // ========== ÁÆ°ÁêÜÂì°ÁôªÂÖ•Ëß∏ÁôºÊõ¥Êñ∞ ==========
        async function triggerAdminUpdates() {
            console.log('üîÑ ÁÆ°ÁêÜÂì°ÁôªÂÖ•ÔºåËß∏ÁôºÂÖ®ÈÉ®Êõ¥Êñ∞...');
            
            try {
                // 1. Êõ¥Êñ∞ÂõõÂ§ßÊåáÊï∏
                fetch(`${API_BASE}/api/admin/update-indices`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()).then(d => {
                    console.log('‚úÖ ÂõõÂ§ßÊåáÊï∏Êõ¥Êñ∞:', d.success ? 'ÊàêÂäü' : 'Â§±Êïó');
                }).catch(e => console.error('‚ùå ÂõõÂ§ßÊåáÊï∏Êõ¥Êñ∞Â§±Êïó:', e));
                
                // 2. Êõ¥Êñ∞ËøΩËπ§Ê∏ÖÂñÆÂÉπÊ†ºÂø´Âèñ
                fetch(`${API_BASE}/api/admin/update-price-cache`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()).then(d => {
                    console.log('‚úÖ ÂÉπÊ†ºÂø´ÂèñÊõ¥Êñ∞:', d.success ? 'ÊàêÂäü' : 'Â§±Êïó');
                }).catch(e => console.error('‚ùå ÂÉπÊ†ºÂø´ÂèñÊõ¥Êñ∞Â§±Êïó:', e));
                
                // 3. Êõ¥Êñ∞ BTC ÂÉπÊ†ºÔºàÈÄèÈÅéÂâçÁ´ØÈáçÊñ∞ËºâÂÖ•Ôºâ
                loadBtcPrice();
                console.log('‚úÖ BTC ÂÉπÊ†ºÊõ¥Êñ∞Ëß∏Áôº');
                
                // 4. Êõ¥Êñ∞ÂåØÁéá
                fetch(`${API_BASE}/api/admin/update-exchange-rate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()).then(d => {
                    console.log('‚úÖ ÂåØÁéáÊõ¥Êñ∞:', d.success ? 'ÊàêÂäü' : 'Â§±Êïó');
                }).catch(e => console.error('‚ùå ÂåØÁéáÊõ¥Êñ∞Â§±Êïó:', e));
                
            } catch (e) {
                console.error('ÁÆ°ÁêÜÂì°Êõ¥Êñ∞Ëß∏ÁôºÂ§±Êïó:', e);
            }
        }

        async function loadDashboard() {
            await loadIndices();
            await loadSentiment();
            await loadBtcPrice();  // üÜï BTC ÂÉπÊ†º
            await loadWatchlistOverview();
        }
        
        // ========== BTC ÂÉπÊ†º ==========
        let btcRefreshInterval = null;
        
        async function loadBtcPrice() {
            const priceEl = document.getElementById('btc-price');
            const changeEl = document.getElementById('btc-change');
            const cardEl = document.getElementById('btc-price-card');
            const indicatorEl = document.getElementById('btc-update-indicator');

            if (!priceEl || !changeEl) return;

            try {
                if (indicatorEl) indicatorEl.classList.remove('hidden');

                // üÜï Áõ¥Êé•Áî® CoinGecko Simple API ÂèñÂç≥ÊôÇÂÉπÊ†º
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
                const data = await res.json();
                
                console.log('[BTC] CoinGecko ÂõûÊáâ:', data);

                if (data.bitcoin) {
                    const price = data.bitcoin.usd || 0;
                    const dayChange = data.bitcoin.usd_24h_change || 0;
                    
                    console.log('[BTC] Âç≥ÊôÇÂÉπÊ†º:', price, '24hËÆäÂåñ:', dayChange);

                    if (price > 0) {
                        priceEl.textContent = '$' + price.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

                        const prefix = dayChange >= 0 ? '+' : '';
                        changeEl.textContent = `${prefix}${dayChange.toFixed(2)}%`;
                        
                        changeEl.classList.remove('text-green-200', 'text-red-200');
                        changeEl.classList.add(dayChange >= 0 ? 'text-green-200' : 'text-red-200');

                        if (cardEl) {
                            cardEl.classList.remove('from-orange-500', 'to-yellow-500', 'from-green-500', 'to-emerald-500', 'from-red-500', 'to-rose-500');
                            if (dayChange >= 3) {
                                cardEl.classList.add('from-green-500', 'to-emerald-500');
                            } else if (dayChange <= -3) {
                                cardEl.classList.add('from-red-500', 'to-rose-500');
                            } else {
                                cardEl.classList.add('from-orange-500', 'to-yellow-500');
                            }
                        }
                    } else {
                        console.warn('[BTC] ÂÉπÊ†ºÁÇ∫ 0 ÊàñÁÑ°Êïà');
                        priceEl.textContent = 'ËºâÂÖ•‰∏≠...';
                    }
                } else {
                    console.error('[BTC] CoinGecko ÂõûÊáâÁÑ°Êïà:', data);
                }
            } catch (e) {
                console.error('[BTC] ËºâÂÖ•Â§±Êïó:', e);
                // Â§±ÊïóÊôÇÂòóË©¶Áî®ÂæåÁ´Ø API ‰ΩúÁÇ∫ÂÇôÊè¥
                try {
                    const backupRes = await fetch(`${API_BASE}/api/crypto/BTC`);
                    const backupData = await backupRes.json();
                    if (backupData.success && backupData.price?.current) {
                        priceEl.textContent = '$' + backupData.price.current.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                        const change = backupData.change?.day || 0;
                        changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                    }
                } catch (backupErr) {
                    console.error('[BTC] ÂÇôÊè¥ API ‰πüÂ§±Êïó:', backupErr);
                }
            } finally {
                if (indicatorEl) setTimeout(() => indicatorEl.classList.add('hidden'), 500);
            }
            
            if (!btcRefreshInterval) {
                btcRefreshInterval = setInterval(loadBtcPrice, 60000);
            }
        }
        
        // ========== ‰∏âÂ§ßÊåáÊï∏ ==========
        let indexCharts = {};  // Â≠òÊîæ Chart.js ÂØ¶‰æã
        
        async function loadIndices() {
            try {
                console.log('ÈñãÂßãËºâÂÖ•ÊåáÊï∏...');
                const res = await fetch(`${API_BASE}/api/market/indices`);
                const data = await res.json();
                console.log('ÊåáÊï∏ API ÂõûÊáâ:', data);
                
                if (data.success && data.data && data.data.indices) {
                    const indices = data.data.indices;
                    console.log('ÊåáÊï∏Ë≥áÊñô:', indices);
                    
                    // S&P 500
                    if (indices['^GSPC']) {
                        updateIndexCard('GSPC', indices['^GSPC']);
                    } else {
                        console.warn('ÁÑ° S&P 500 Ë≥áÊñô');
                    }
                    
                    // ÈÅìÁìäÂ∑•Ê•≠
                    if (indices['^DJI']) {
                        updateIndexCard('DJI', indices['^DJI']);
                    } else {
                        console.warn('ÁÑ°ÈÅìÁìäË≥áÊñô');
                    }
                    
                    // Á¥çÊñØÈÅîÂÖã
                    if (indices['^IXIC']) {
                        updateIndexCard('IXIC', indices['^IXIC']);
                    } else {
                        console.warn('ÁÑ°Á¥çÊñØÈÅîÂÖãË≥áÊñô');
                    }
                    
                    // Âè∞ËÇ°Âä†Ê¨ä
                    if (indices['^TWII']) {
                        updateIndexCard('TWII', indices['^TWII']);
                    } else {
                        console.warn('ÁÑ°Âè∞ËÇ°Âä†Ê¨äË≥áÊñô');
                    }
                } else {
                    console.error('ÊåáÊï∏ API ÂõûÊáâÊ†ºÂºèÈåØË™§:', data);
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊåáÊï∏Â§±Êïó', e);
            }
        }
        
        function updateIndexCard(symbol, data) {
            const priceEl = document.getElementById(`index-${symbol}-price`);
            const changeEl = document.getElementById(`index-${symbol}-change`);
            const dateEl = document.getElementById(`index-${symbol}-date`);
            
            if (priceEl) {
                priceEl.textContent = data.close ? data.close.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
            }
            
            if (changeEl && data.change_pct !== undefined) {
                const isPositive = data.change_pct >= 0;
                changeEl.textContent = `${isPositive ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.change_pct).toFixed(2)}%`;
                changeEl.className = `text-sm font-medium ${isPositive ? 'text-green-600' : 'text-red-600'}`;
            }
            
            if (dateEl && data.date) {
                dateEl.textContent = `Êõ¥Êñ∞: ${data.date}`;
            }
        }
        
        // ========== ÊåáÊï∏ÂúñË°® Modal ==========
        let indexModalChart = null;
        let currentIndexSymbol = '';
        let currentIndexName = '';
        
        function openIndexModal(symbol, name) {
            currentIndexSymbol = symbol;
            currentIndexName = name;
            document.getElementById('indexModalTitle').textContent = name;
            document.getElementById('indexChartModal').classList.add('open');
            document.body.style.overflow = 'hidden';
            loadIndexModalChart(365);  // È†êË®≠ËºâÂÖ• 1 Âπ¥
        }
        
        function closeIndexModal() {
            document.getElementById('indexChartModal').classList.remove('open');
            document.body.style.overflow = '';
        }
        
        async function loadIndexModalChart(days) {
            const canvas = document.getElementById('indexModalChart');
            if (!canvas) return;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.index-modal-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === '1M' && days === 30) btn.classList.add('active');
                if (btn.textContent === '3M' && days === 90) btn.classList.add('active');
                if (btn.textContent === '1Y' && days === 365) btn.classList.add('active');
                if (btn.textContent === '5Y' && days === 1825) btn.classList.add('active');
            });
            
            try {
                const res = await fetch(`${API_BASE}/api/market/indices/${currentIndexSymbol}/history?days=${days}`);
                const data = await res.json();
                
                if (data.success && data.data && data.data.history) {
                    const history = data.data.history;
                    const labels = history.map(h => h.date);
                    const prices = history.map(h => h.close);
                    
                    // Èä∑ÊØÄËàäÂúñË°®
                    if (indexModalChart) {
                        indexModalChart.destroy();
                    }
                    
                    // Ê±∫ÂÆöÈ°èËâ≤
                    const cleanSymbol = currentIndexSymbol.replace('^', '');
                    const color = cleanSymbol === 'GSPC' ? '#3B82F6' : cleanSymbol === 'DJI' ? '#10B981' : '#8B5CF6';
                    
                    // Âª∫Á´ãÊñ∞ÂúñË°®
                    const ctx = canvas.getContext('2d');
                    indexModalChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: currentIndexName,
                                data: prices,
                                borderColor: color,
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.1,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    ticks: {
                                        maxTicksLimit: 8,
                                        font: { size: 11 }
                                    },
                                    grid: { display: false }
                                },
                                y: {
                                    display: true,
                                    ticks: {
                                        font: { size: 11 },
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    },
                                    grid: { color: '#F3F4F6' }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊåáÊï∏Ëµ∞Âã¢Â§±Êïó', e);
            }
        }

        // ========== ËºâÂÖ•Â∏ÇÂ†¥ÊÉÖÁ∑í ==========
        async function loadSentiment() {
            try {
                const res = await fetch(`${API_BASE}/api/market/sentiment`);
                const data = await res.json();
                
                if (data.success) {
                    if (data.stock) {
                        updateSentimentCard('stock', data.stock);
                    } else {
                        updateSentimentCard('stock', { value: 50, classification: 'neutral' });
                    }
                    
                    if (data.crypto) {
                        updateSentimentCard('crypto', data.crypto);
                    } else {
                        updateSentimentCard('crypto', { value: 50, classification: 'neutral' });
                    }
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊÉÖÁ∑íÂ§±Êïó', e);
                updateSentimentCard('stock', { value: 50, classification: 'neutral' });
                updateSentimentCard('crypto', { value: 50, classification: 'neutral' });
            }
        }

        function updateSentimentCard(type, sentiment) {
            if (!sentiment) return;
            
            const value = sentiment.value;
            
            // Êõ¥Êñ∞Êï∏ÂÄºÈ°ØÁ§∫
            const gaugeValue = document.getElementById(`${type}GaugeValue`);
            if (gaugeValue) gaugeValue.textContent = value;
            
            // Ë®àÁÆóÊåáÈáùËßíÂ∫¶ (0 = -90Â∫¶, 100 = 90Â∫¶)
            const angle = -90 + (value / 100) * 180;
            
            // Êõ¥Êñ∞ÊåáÈáù (Êñ∞Áâà‰ΩøÁî® NeedleGroup)
            const needleGroup = document.getElementById(`${type}NeedleGroup`);
            if (needleGroup) {
                needleGroup.style.transform = `rotate(${angle}deg)`;
            }
            
            // Ê†πÊìöÊï∏ÂÄºÊ±∫ÂÆöÁãÄÊÖãÊñáÂ≠óÂíåÈ°èËâ≤
            let label, colorClass;
            if (value <= 25) {
                label = 'Extreme Fear';
                colorClass = 'text-red-600';
            } else if (value <= 45) {
                label = 'Fear';
                colorClass = 'text-orange-500';
            } else if (value <= 55) {
                label = 'Neutral';
                colorClass = 'text-gray-500';
            } else if (value <= 75) {
                label = 'Greed';
                colorClass = 'text-green-500';
            } else {
                label = 'Extreme Greed';
                colorClass = 'text-emerald-600';
            }
            
            // Êõ¥Êñ∞ÁãÄÊÖãÊñáÂ≠ó
            const statusEl = document.getElementById(`${type}SentimentStatus`);
            if (statusEl) {
                statusEl.textContent = label;
                statusEl.className = `text-center font-semibold mt-1 ${colorClass}`;
            }
            
            // Êõ¥Êñ∞ÊôÇÈñìÊà≥
            const timeEl = document.getElementById(`${type}SentimentTime`);
            if (timeEl && sentiment.updated_at) {
                const date = new Date(sentiment.updated_at);
                timeEl.textContent = `Last updated ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            } else if (timeEl) {
                timeEl.textContent = '';
            }
        }
        
        // ========== ÊÉÖÁ∑íÂúñË°® Modal ==========
        let sentimentModalChart = null;
        let currentSentimentMarket = '';
        let currentSentimentName = '';
        
        function openSentimentModal(market, name) {
            currentSentimentMarket = market;
            currentSentimentName = name;
            document.getElementById('sentimentModalTitle').textContent = name;
            document.getElementById('sentimentChartModal').classList.add('open');
            document.body.style.overflow = 'hidden';
            loadSentimentModalChart(180);  // È†êË®≠ËºâÂÖ• 6 ÂÄãÊúà
        }
        
        function closeSentimentModal() {
            document.getElementById('sentimentChartModal').classList.remove('open');
            document.body.style.overflow = '';
        }
        
        async function loadSentimentModalChart(days) {
            const canvas = document.getElementById('sentimentModalChart');
            if (!canvas) return;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.sentiment-modal-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === '1M' && days === 30) btn.classList.add('active');
                if (btn.textContent === '3M' && days === 90) btn.classList.add('active');
                if (btn.textContent === '6M' && days === 180) btn.classList.add('active');
                if (btn.textContent === '1Y' && days === 365) btn.classList.add('active');
            });
            
            try {
                const res = await fetch(`${API_BASE}/api/market/sentiment/${currentSentimentMarket}/history?days=${days}`);
                const data = await res.json();
                
                if (data.success && data.data && data.data.history) {
                    const history = data.data.history;
                    const labels = history.map(h => h.date);
                    const values = history.map(h => h.value);
                    
                    // Èä∑ÊØÄËàäÂúñË°®
                    if (sentimentModalChart) {
                        sentimentModalChart.destroy();
                    }
                    
                    // Âª∫Á´ãÊñ∞ÂúñË°®
                    const ctx = canvas.getContext('2d');
                    
                    // Âª∫Á´ãÊº∏Â±§ËÉåÊôØ
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, 'rgba(34, 197, 94, 0.3)');  // Á∂†Ëâ≤ÔºàË≤™Â©™Ôºâ
                    gradient.addColorStop(0.5, 'rgba(234, 179, 8, 0.2)');  // ÈªÉËâ≤Ôºà‰∏≠ÊÄßÔºâ
                    gradient.addColorStop(1, 'rgba(239, 68, 68, 0.3)');  // Á¥ÖËâ≤ÔºàÊÅêÊáºÔºâ
                    
                    const color = currentSentimentMarket === 'stock' ? '#3B82F6' : '#F97316';
                    
                    sentimentModalChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: currentSentimentName,
                                data: values,
                                borderColor: color,
                                backgroundColor: gradient,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.3,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const v = context.parsed.y;
                                            let status = '';
                                            if (v <= 25) status = '(Extreme Fear)';
                                            else if (v <= 45) status = '(Fear)';
                                            else if (v <= 55) status = '(Neutral)';
                                            else if (v <= 75) status = '(Greed)';
                                            else status = '(Extreme Greed)';
                                            return `${v} ${status}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    ticks: {
                                        maxTicksLimit: 8,
                                        font: { size: 11 }
                                    },
                                    grid: { display: false }
                                },
                                y: {
                                    display: true,
                                    min: 0,
                                    max: 100,
                                    ticks: {
                                        font: { size: 11 },
                                        stepSize: 25,
                                        callback: function(value) {
                                            if (value === 0) return '0 Fear';
                                            if (value === 50) return '50';
                                            if (value === 100) return '100 Greed';
                                            return value;
                                        }
                                    },
                                    grid: { color: '#F3F4F6' }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊÉÖÁ∑íËµ∞Âã¢Â§±Êïó', e);
            }
        }

        // ========== Ëµ∞Âã¢ÊØîËºÉ ==========
        let compareChart = null;
        const compareColors = [
            '#3B82F6', // Ëóç
            '#EF4444', // Á¥Ö
            '#10B981', // Á∂†
            '#F59E0B', // Ê©ô
            '#8B5CF6', // Á¥´
        ];
        
        function addCompareSymbol(symbol) {
            const input = document.getElementById('compareSymbols');
            const current = input.value.trim();
            const symbols = current ? current.split(',').map(s => s.trim().toUpperCase()) : [];
            
            if (!symbols.includes(symbol.toUpperCase())) {
                if (symbols.length >= 5) {
                    showToast('ÊúÄÂ§öÂè™ËÉΩÊØîËºÉ 5 ÂÄãÊ®ôÁöÑ');
                    return;
                }
                symbols.push(symbol.toUpperCase());
                input.value = symbols.join(', ');
                updateSelectedSymbols();
            }
        }
        
        function removeCompareSymbol(symbol) {
            const input = document.getElementById('compareSymbols');
            const current = input.value.trim();
            const symbols = current ? current.split(',').map(s => s.trim().toUpperCase()) : [];
            const filtered = symbols.filter(s => s !== symbol.toUpperCase());
            input.value = filtered.join(', ');
            updateSelectedSymbols();
        }
        
        function updateSelectedSymbols() {
            const input = document.getElementById('compareSymbols');
            const container = document.getElementById('selectedSymbols');
            const current = input.value.trim();
            const symbols = current ? current.split(',').map(s => s.trim().toUpperCase()).filter(s => s) : [];
            
            if (symbols.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = symbols.map((s, i) => `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm" 
                      style="background-color: ${compareColors[i % compareColors.length]}20; color: ${compareColors[i % compareColors.length]}; border: 1px solid ${compareColors[i % compareColors.length]}">
                    ${s}
                    <button onclick="removeCompareSymbol('${s}')" class="ml-2 hover:opacity-70">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }
        
        // Áõ£ËÅΩËº∏ÂÖ•ËÆäÂåñ
        document.getElementById('compareSymbols')?.addEventListener('input', updateSelectedSymbols);
        
        async function loadCompareChart() {
            const input = document.getElementById('compareSymbols');
            const days = document.getElementById('compareDays').value;
            const symbols = input.value.trim();
            
            if (!symbols) {
                showToast('Ë´ãËº∏ÂÖ•Ëá≥Â∞ë‰∏ÄÂÄãËÇ°Á•®‰ª£Ëôü');
                return;
            }
            
            // È°ØÁ§∫ËºâÂÖ•‰∏≠
            document.getElementById('compareChartPlaceholder').classList.add('hidden');
            document.getElementById('compareChartContainer').classList.add('hidden');
            document.getElementById('compareChartLoading').classList.remove('hidden');
            document.getElementById('compareResultTable').classList.add('hidden');
            
            try {
                const res = await apiRequest(`/api/stock/compare/history?symbols=${encodeURIComponent(symbols)}&days=${days}`);
                const data = await res.json();
                
                console.log('ÊØîËºÉÁµêÊûú:', data);
                
                if (!data.success) {
                    throw new Error(data.detail || 'ÂèñÂæóË≥áÊñôÂ§±Êïó');
                }
                
                const stocks = data.data.stocks;
                const symbolList = Object.keys(stocks);
                
                if (symbolList.length === 0) {
                    throw new Error('Êâæ‰∏çÂà∞‰ªª‰ΩïÊúâÊïàË≥áÊñô');
                }
                
                // Ê∫ñÂÇôÂúñË°®Ë≥áÊñô
                const datasets = [];
                let tableHtml = '';
                
                symbolList.forEach((sym, idx) => {
                    const stock = stocks[sym];
                    const color = compareColors[idx % compareColors.length];
                    
                    datasets.push({
                        label: `${stock.name} (${sym})`,
                        data: stock.data.map(d => ({ x: d.date, y: d.value })),
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.1,
                        fill: false,
                    });
                    
                    // Ë°®Ê†ºË≥áÊñô
                    const changeClass = stock.change_pct >= 0 ? 'text-green-600' : 'text-red-600';
                    const changeIcon = stock.change_pct >= 0 ? '‚ñ≤' : '‚ñº';
                    tableHtml += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-3">
                                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                                <span class="font-medium">${stock.name}</span>
                                <span class="text-gray-400 text-xs ml-1">${sym}</span>
                            </td>
                            <td class="text-right py-2 px-3">${stock.start_price.toLocaleString()}</td>
                            <td class="text-right py-2 px-3">${stock.end_price.toLocaleString()}</td>
                            <td class="text-right py-2 px-3 ${changeClass} font-medium">
                                ${changeIcon} ${Math.abs(stock.change_pct).toFixed(2)}%
                            </td>
                        </tr>
                    `;
                });
                
                // Áπ™Ë£ΩÂúñË°®
                const ctx = document.getElementById('compareChart').getContext('2d');
                
                if (compareChart) {
                    compareChart.destroy();
                }
                
                compareChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { usePointStyle: true, boxWidth: 8 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day', displayFormats: { day: 'MM/dd' } },
                                grid: { display: false },
                                ticks: { maxTicksLimit: 8 }
                            },
                            y: {
                                grid: { color: '#F3F4F6' },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(0) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Êõ¥Êñ∞ UI
                document.getElementById('compareChartLoading').classList.add('hidden');
                document.getElementById('compareChartContainer').classList.remove('hidden');
                document.getElementById('compareTableBody').innerHTML = tableHtml;
                document.getElementById('compareResultTable').classList.remove('hidden');
                
            } catch (e) {
                console.error('Ëµ∞Âã¢ÊØîËºÉÂ§±Êïó:', e);
                document.getElementById('compareChartLoading').classList.add('hidden');
                document.getElementById('compareChartPlaceholder').classList.remove('hidden');
                showToast(e.message || 'ËºâÂÖ•Â§±Êïó');
            }
        }

        // ========== ËøΩËπ§Ê∏ÖÂñÆÂø´Ë¶Ω ==========
        async function loadWatchlistOverview() {
            const container = document.getElementById('dashboardWatchlist');
            
            // È©óË≠âÁï∂ÂâçÁî®Êà∂
            if (!currentUser || !currentUser.id) {
                console.error('loadWatchlistOverview: Áî®Êà∂Êú™ÁôªÂÖ•');
                container.innerHTML = '<p class="text-red-500 text-center py-4">Ë´ãÂÖàÁôªÂÖ•</p>';
                return;
            }
            
            console.log(`=== ËºâÂÖ•ËøΩËπ§Ê∏ÖÂñÆÂø´Ë¶Ω ===`);
            
            try {
                // ‚òÖ ‰ΩøÁî®Âø´Âèñ API
                const res = await apiRequest('/api/watchlist/with-prices');
                const data = await res.json();
                
                if (!data.success) {
                    console.error('API ÂõûÂÇ≥Â§±Êïó:', data);
                    container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
                    return;
                }
                
                if (!data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                            <p class="text-gray-500 text-sm">Â∞öÁÑ°ËøΩËπ§Ê∏ÖÂñÆ</p>
                            <button onclick="showSection('search')" class="mt-2 text-blue-600 text-sm">ÂâçÂæÄÊü•Ë©¢ËÇ°Á•®</button>
                        </div>
                    `;
                    return;
                }
                
                // Âè™È°ØÁ§∫Ââç 5 Á≠Ü
                const items = data.data.slice(0, 5);
                let html = '<div class="space-y-2">';
                
                for (const item of items) {
                    const change = item.change_pct || 0;
                    const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                    
                    const priceText = item.price !== null && item.price !== undefined
                        ? `$${item.price.toLocaleString()}`
                        : '--';
                    
                    const changeText = item.price !== null && item.price !== undefined
                        ? `<span class="${changeClass} text-sm ml-1">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`
                        : '';
                    
                    // Âà§Êñ∑Â∏ÇÂ†¥È°ûÂûãÔºàÁî®ÊñºË≤∑Ë≥£ÊåâÈàïÔºâ
                    const isCrypto = item.asset_type === 'crypto';
                    const isTw = item.symbol.includes('.TW') || /^\d+$/.test(item.symbol);
                    const market = isTw ? 'tw' : 'us';
                    
                    // Ë≤∑Ë≥£ÊåâÈàïÔºàÂä†ÂØÜË≤®Âπ£‰∏çÈ°ØÁ§∫Ôºâ
                    const tradeButtons = isCrypto ? '' : `
                        <div class="flex gap-1 ml-2">
                            <button onclick="event.stopPropagation(); quickTrade('${item.symbol}', '${item.name || ''}', '${market}', 'buy')" 
                                    class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200" title="Ë≤∑ÂÖ•">
                                Ë≤∑
                            </button>
                            <button onclick="event.stopPropagation(); quickTrade('${item.symbol}', '${item.name || ''}', '${market}', 'sell')" 
                                    class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" title="Ë≥£Âá∫">
                                Ë≥£
                            </button>
                        </div>
                    `;
                    
                    html += `
                        <div class="flex items-center justify-between py-2 border-b last:border-0 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded"
                             onclick="searchSymbol('${item.symbol}')">
                            <div class="flex items-center">
                                <span class="font-medium text-gray-800 w-20">${item.symbol}</span>
                                <span class="text-xs px-2 py-0.5 rounded ${item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                    ${item.asset_type === 'crypto' ? 'Âπ£' : 'ËÇ°'}
                                </span>
                            </div>
                            <div class="flex items-center">
                                <div class="text-right">
                                    <span class="text-gray-700 font-medium">${priceText}</span>
                                    ${changeText}
                                </div>
                                ${tradeButtons}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Â¶ÇÊûúË∂ÖÈÅé 5 Á≠ÜÔºåÈ°ØÁ§∫„ÄåÊü•ÁúãÂÖ®ÈÉ®„Äç
                if (data.data.length > 5) {
                    html += `
                        <div class="text-center mt-3">
                            <button onclick="showSection('watchlist')" class="text-blue-600 text-sm hover:underline">
                                Êü•ÁúãÂÖ®ÈÉ® (${data.data.length})
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error('ËºâÂÖ•ËøΩËπ§Ê∏ÖÂñÆÂ§±Êïó', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
            }
        }

        // ========== ËÇ°Á•®Êü•Ë©¢ ==========
        function searchStock() {
            let symbol = document.getElementById('searchSymbol').value.trim().toUpperCase();
            if (!symbol) {
                showToast('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü');
                return;
            }
            
            // Áõ¥Êé•ÂÇ≥ÈÅûÂéüÂßãËº∏ÂÖ•ÔºåËÆì searchSymbol ËôïÁêÜ
            searchSymbol(symbol);
        }

        async function searchSymbol(symbol) {
            const container = document.getElementById('searchResult');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="bg-white rounded-xl shadow p-6 text-center"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500 text-sm">Êü•Ë©¢‰∏≠...ÔºàÈ¶ñÊ¨°Êü•Ë©¢ÂèØËÉΩÈúÄË¶Å 10-30 ÁßíÔºâ</p></div>';
            
            showSection('search');
            document.getElementById('searchSymbol').value = symbol;

            try {
                // Âà§Êñ∑Ë≥áÁî¢È°ûÂûã
                const upperSymbol = symbol.toUpperCase();
                const isCrypto = ['BTC', 'ETH', 'BITCOIN', 'ETHEREUM'].includes(upperSymbol);
                // Á¥îÊï∏Â≠ó = Âè∞ËÇ°ÔºåÊàñÂ∑≤Á∂ìÊúâ .TW ÂæåÁ∂¥
                const isTaiwan = /^\d{4,6}$/.test(symbol) || upperSymbol.endsWith('.TW');
                
                let endpoint;
                let querySymbol = upperSymbol;
                
                if (isCrypto) {
                    endpoint = `/api/crypto/${upperSymbol}`;
                } else if (isTaiwan) {
                    // Á¢∫‰øùÊúâ .TW ÂæåÁ∂¥
                    querySymbol = upperSymbol.endsWith('.TW') ? upperSymbol : `${symbol}.TW`;
                    endpoint = `/api/stock/${querySymbol}`;
                } else {
                    endpoint = `/api/stock/${upperSymbol}`;
                }
                
                console.log(`Êü•Ë©¢: ${endpoint}, È°ûÂûã: ${isCrypto ? 'Âä†ÂØÜË≤®Âπ£' : isTaiwan ? 'Âè∞ËÇ°' : 'ÁæéËÇ°'}`);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                const res = await fetch(`${API_BASE}${endpoint}`, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await res.json();
                console.log('API ÂõûÊáâ:', data);
                
                if (!res.ok) {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        <p class="font-medium">Êü•Ë©¢Â§±Êïó</p>
                        <p class="text-sm mt-2">${data.detail || 'HTTP ' + res.status}</p>
                        ${isCrypto ? '<p class="text-xs mt-2 text-gray-500">Ê≥®ÊÑèÔºöÂä†ÂØÜË≤®Âπ£Êü•Ë©¢ÂèØËÉΩÂõ† API ÈôêÂà∂Êö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®</p>' : ''}
                    </div>`;
                    return;
                }
                
                if (!data.success) {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">${data.detail || 'Êü•Ë©¢Â§±Êïó'}</div>`;
                    return;
                }

                currentChartData = data.chart_data;
                renderStockResult(data, isCrypto, isTaiwan);
                
            } catch (e) {
                console.error('Search error:', e);
                if (e.name === 'AbortError') {
                    container.innerHTML = '<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">Êü•Ë©¢Ë∂ÖÊôÇÔºåË´ãÁ®çÂæåÂÜçË©¶</div>';
                } else {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">Êü•Ë©¢Â§±Êïó: ${e.message}</div>`;
                }
            }
        }

        function renderStockResult(stock, isCrypto, isTaiwan = false) {
            const container = document.getElementById('searchResult');
            const indicators = stock.indicators || {};
            const ma = indicators.ma || {};
            const rsi = indicators.rsi || {};
            const macd = indicators.macd || {};
            
            const priceChange = stock.change?.day || 0;
            const priceChangeClass = priceChange >= 0 ? 'text-green-600' : 'text-red-600';
            const priceChangeIcon = priceChange >= 0 ? 'üìà' : 'üìâ';
            
            const alignmentClass = ma.alignment === 'bullish' ? 'text-green-600' : ma.alignment === 'bearish' ? 'text-red-600' : 'text-gray-600';
            const alignmentText = ma.alignment === 'bullish' ? 'Â§öÈ†≠ üü¢' : ma.alignment === 'bearish' ? 'Á©∫È†≠ üî¥' : '‰∏≠ÊÄß';
            
            const rsiStatus = rsi.status === 'overbought' ? 'Ë∂ÖË≤∑ ‚ö†Ô∏è' : rsi.status === 'oversold' ? 'Ë∂ÖË≥£ üü¢' : '‰∏≠ÊÄß';
            const macdStatus = macd.status === 'bullish' ? 'ÂÅèÂ§ö üü¢' : 'ÂÅèÁ©∫ üî¥';
            
            // Âà§Êñ∑Â∏ÇÂ†¥È°ûÂûãÊ®ôÁ±§
            let marketLabel, marketClass;
            if (isCrypto) {
                marketLabel = 'Âä†ÂØÜË≤®Âπ£';
                marketClass = 'bg-purple-100 text-purple-700';
            } else if (isTaiwan) {
                marketLabel = 'Âè∞ËÇ°';
                marketClass = 'bg-orange-100 text-orange-700';
            } else {
                marketLabel = 'ÁæéËÇ°';
                marketClass = 'bg-blue-100 text-blue-700';
            }
            
            const html = `
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <!-- ÂÉπÊ†ºÂçÄÂ°ä -->
                    <div class="p-4 md:p-6 border-b">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">${stock.symbol}</h3>
                                <p class="text-gray-500 text-sm">${stock.name || marketLabel}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs ${marketClass}">
                                ${marketLabel}
                            </span>
                        </div>
                        <div class="mt-3">
                            <span class="text-3xl md:text-4xl font-bold text-gray-800">$${stock.price?.current?.toLocaleString() || '--'}</span>
                            <span class="ml-2 ${priceChangeClass} text-lg">
                                ${priceChange >= 0 ? '+' : ''}${priceChange?.toFixed(2)}% ${priceChangeIcon}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Âø´ÈÄüÁ∏ΩË¶Ω -->
                    <div class="p-4 md:p-6 border-b bg-gray-50">
                        <h4 class="font-semibold text-gray-700 mb-3 text-sm">üìä Âø´ÈÄüÁ∏ΩË¶Ω</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">ÂùáÁ∑öÊéíÂàó</span>
                                <span class="${alignmentClass} font-medium">${alignmentText}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">RSI</span>
                                <span class="font-medium">${rsi.value?.toFixed(0) || '--'} ${rsiStatus}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">MACD</span>
                                <span class="font-medium">${macdStatus}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Ë©ïÂàÜ</span>
                                <span class="font-medium">${stock.score?.rating === 'bullish' ? 'ÂÅèÂ§ö' : stock.score?.rating === 'bearish' ? 'ÂÅèÁ©∫' : '‰∏≠ÊÄß'} (${stock.score?.buy || 0}/${stock.score?.sell || 0})</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Âπ¥ÂåñÂ†±ÈÖ¨Áéá (CAGR) -->
                    ${stock.cagr ? `
                    <div class="p-4 md:p-6 border-b">
                        <h4 class="font-semibold text-gray-700 mb-3 text-sm">üìà Âπ¥ÂåñÂ†±ÈÖ¨Áéá (CAGR)</h4>
                        <div class="grid grid-cols-4 gap-2 text-center">
                            <div class="p-2 rounded-lg ${stock.cagr.cagr_1y > 0 ? 'bg-green-50' : stock.cagr.cagr_1y < 0 ? 'bg-red-50' : 'bg-gray-50'}">
                                <p class="text-gray-500 text-xs">1 Âπ¥</p>
                                <p class="font-bold ${stock.cagr.cagr_1y > 0 ? 'text-green-600' : stock.cagr.cagr_1y < 0 ? 'text-red-600' : 'text-gray-600'}">
                                    ${stock.cagr.cagr_1y !== null ? (stock.cagr.cagr_1y > 0 ? '+' : '') + stock.cagr.cagr_1y + '%' : '--'}
                                </p>
                            </div>
                            <div class="p-2 rounded-lg ${stock.cagr.cagr_3y > 0 ? 'bg-green-50' : stock.cagr.cagr_3y < 0 ? 'bg-red-50' : 'bg-gray-50'}">
                                <p class="text-gray-500 text-xs">3 Âπ¥</p>
                                <p class="font-bold ${stock.cagr.cagr_3y > 0 ? 'text-green-600' : stock.cagr.cagr_3y < 0 ? 'text-red-600' : 'text-gray-600'}">
                                    ${stock.cagr.cagr_3y !== null ? (stock.cagr.cagr_3y > 0 ? '+' : '') + stock.cagr.cagr_3y + '%' : '--'}
                                </p>
                            </div>
                            <div class="p-2 rounded-lg ${stock.cagr.cagr_5y > 0 ? 'bg-green-50' : stock.cagr.cagr_5y < 0 ? 'bg-red-50' : 'bg-gray-50'}">
                                <p class="text-gray-500 text-xs">5 Âπ¥</p>
                                <p class="font-bold ${stock.cagr.cagr_5y > 0 ? 'text-green-600' : stock.cagr.cagr_5y < 0 ? 'text-red-600' : 'text-gray-600'}">
                                    ${stock.cagr.cagr_5y !== null ? (stock.cagr.cagr_5y > 0 ? '+' : '') + stock.cagr.cagr_5y + '%' : '--'}
                                </p>
                            </div>
                            <div class="p-2 rounded-lg ${stock.cagr.cagr_10y > 0 ? 'bg-green-50' : stock.cagr.cagr_10y < 0 ? 'bg-red-50' : 'bg-gray-50'}">
                                <p class="text-gray-500 text-xs">10 Âπ¥</p>
                                <p class="font-bold ${stock.cagr.cagr_10y > 0 ? 'text-green-600' : stock.cagr.cagr_10y < 0 ? 'text-red-600' : 'text-gray-600'}">
                                    ${stock.cagr.cagr_10y !== null ? (stock.cagr.cagr_10y > 0 ? '+' : '') + stock.cagr.cagr_10y + '%' : '--'}
                                </p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-center">Âπ¥ÂåñË§áÂêàÊàêÈï∑ÁéáÔºåÂèçÊò†Èï∑ÊúüÊäïË≥áÂõûÂ†±</p>
                    </div>
                    ` : ''}
                    
                    <!-- Ë©≥Á¥∞ÊåáÊ®ô (ÂèØÊë∫Áñä) -->
                    <div class="border-b">
                        <button onclick="toggleCollapsible(this)" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 touch-target">
                            <span class="font-medium text-gray-700">‚ñº Â±ïÈñãË©≥Á¥∞ÊåáÊ®ô</span>
                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div class="collapsible-content">
                            <div class="px-4 pb-4 space-y-3">
                                <!-- MA Ë©≥Á¥∞ -->
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <div class="p-3 rounded-lg ${ma.price_vs_ma20 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                                        <p class="text-gray-500 text-xs">MA20</p>
                                        <p class="font-semibold">${ma.ma20?.toFixed(2) || '--'}</p>
                                        <p class="text-xs ${ma.price_vs_ma20 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                            ${ma.price_vs_ma20 === 'above' ? 'ÂÉπÊ†ºÂú®‰∏ä ‚úì' : 'ÂÉπÊ†ºÂú®‰∏ã'}
                                        </p>
                                    </div>
                                    <div class="p-3 rounded-lg ${ma.price_vs_ma50 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                                        <p class="text-gray-500 text-xs">MA50</p>
                                        <p class="font-semibold">${ma.ma50?.toFixed(2) || '--'}</p>
                                        <p class="text-xs ${ma.price_vs_ma50 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                            ${ma.price_vs_ma50 === 'above' ? 'ÂÉπÊ†ºÂú®‰∏ä ‚úì' : 'ÂÉπÊ†ºÂú®‰∏ã'}
                                        </p>
                                    </div>
                                    <div class="p-3 rounded-lg ${ma.price_vs_ma200 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                                        <p class="text-gray-500 text-xs">MA200</p>
                                        <p class="font-semibold">${ma.ma200?.toFixed(2) || '--'}</p>
                                        <p class="text-xs ${ma.price_vs_ma200 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                            ${ma.price_vs_ma200 === 'above' ? 'ÂÉπÊ†ºÂú®‰∏ä ‚úì' : 'ÂÉπÊ†ºÂú®‰∏ã'}
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- RSI & MACD Ë©≥Á¥∞ -->
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-gray-500 text-xs">RSI (${rsi.period || 14})</p>
                                        <p class="font-semibold">${rsi.value?.toFixed(2) || '--'}</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-gray-500 text-xs">MACD DIF</p>
                                        <p class="font-semibold">${macd.dif?.toFixed(2) || '--'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Êìç‰ΩúÊåâÈàï -->
                    <div class="p-4 pb-28 md:pb-4 space-y-3">
                        ${stock.chart_data ? `
                        <button onclick="openChartFullscreen('${stock.symbol}', ${stock.price?.current || 0})" 
                            class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium flex items-center justify-center touch-target hover:bg-blue-700">
                            <i class="fas fa-chart-line mr-2"></i>
                            Êü•ÁúãÂÆåÊï¥ÂúñË°®
                        </button>
                        ` : ''}
                        <button onclick="loadReturnsModal('${stock.symbol}')" 
                            class="w-full py-3 bg-green-600 text-white rounded-lg font-medium flex items-center justify-center touch-target hover:bg-green-700">
                            <i class="fas fa-percentage mr-2"></i>
                            Âπ¥ÂåñÂ†±ÈÖ¨Áéá
                        </button>
                        <button onclick="quickAddToWatchlist('${stock.symbol}', '${isCrypto ? 'crypto' : 'stock'}')" 
                            class="w-full py-3 border-2 border-orange-500 text-orange-600 rounded-lg font-medium flex items-center justify-center touch-target hover:bg-orange-50">
                            <i class="fas fa-star mr-2"></i>
                            Âä†ÂÖ•ËøΩËπ§Ê∏ÖÂñÆ
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function toggleCollapsible(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('i');
            content.classList.toggle('open');
            icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : '';
            btn.querySelector('span').textContent = content.classList.contains('open') ? '‚ñ≤ Êî∂ÂêàË©≥Á¥∞ÊåáÊ®ô' : '‚ñº Â±ïÈñãË©≥Á¥∞ÊåáÊ®ô';
        }

        // ========== ÂÖ®Ëû¢ÂπïÂúñË°® ==========
        function openChartFullscreen(symbol, price) {
            if (!currentChartData) {
                showToast('Ê≤íÊúâÂúñË°®Ë≥áÊñô');
                return;
            }
            
            document.getElementById('chartFullscreenTitle').textContent = `${symbol}  $${price.toLocaleString()}`;
            document.getElementById('chartFullscreen').classList.add('open');
            document.body.style.overflow = 'hidden';
            
            // Âª∂ÈÅ≤Ê∏≤ÊüìÂúñË°®
            setTimeout(() => {
                renderFullscreenChart(currentChartData, 65);
            }, 100);
        }
        
        function closeChartFullscreen() {
            document.getElementById('chartFullscreen').classList.remove('open');
            document.body.style.overflow = '';
            
            if (fullscreenChartInstance) {
                fullscreenChartInstance.destroy();
                fullscreenChartInstance = null;
            }
        }
        
        function setChartRange(days, btn) {
            console.log('setChartRange called:', days);
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('.chart-range-btn').forEach(b => {
                b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600', 'active');
                b.classList.add('border-gray-300');
            });
            if (btn) {
                btn.classList.remove('border-gray-300');
                btn.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600', 'active');
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂúñË°®
            if (currentChartData && currentChartData.dates && currentChartData.dates.length > 0) {
                renderFullscreenChart(currentChartData, days);
            } else {
                console.warn('No chart data available');
            }
        }
        
        // ÂàùÂßãÂåñÂúñË°®ÊåâÈàï‰∫ã‰ª∂ (‰ΩøÁî®ÂÖ®Â±Ä‰∫ã‰ª∂‰ª£ÁêÜÔºåÁ¢∫‰øùÊ©´ÁΩÆ‰πüËÉΩÁî®)
        function initChartRangeButtons() {
            // ÁßªÈô§ËàäÁöÑÁõ£ËÅΩÂô®ÈÅøÂÖçÈáçË§á
            document.removeEventListener('click', handleChartButtonClick);
            document.removeEventListener('touchstart', handleChartButtonTouch);
            
            // Ê∑ªÂä†Êñ∞ÁöÑÁõ£ËÅΩÂô®
            document.addEventListener('click', handleChartButtonClick);
            document.addEventListener('touchstart', handleChartButtonTouch, { passive: false });
        }
        
        function handleChartButtonClick(e) {
            const btn = e.target.closest('.chart-range-btn');
            if (btn && btn.dataset.days) {
                e.preventDefault();
                e.stopPropagation();
                const days = parseInt(btn.dataset.days, 10);
                console.log('Chart button clicked:', days);
                setChartRange(days, btn);
            }
        }
        
        function handleChartButtonTouch(e) {
            const btn = e.target.closest('.chart-range-btn');
            if (btn && btn.dataset.days) {
                e.preventDefault();
                const days = parseInt(btn.dataset.days, 10);
                console.log('Chart button touched:', days);
                setChartRange(days, btn);
            }
        }
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', initChartRangeButtons);
        
        // Ëû¢ÂπïÊóãËΩâÊôÇÈáçÊñ∞ÂàùÂßãÂåñ
        window.addEventListener('orientationchange', function() {
            setTimeout(initChartRangeButtons, 100);
        });
        
        function renderFullscreenChart(chartData, days) {
            const canvas = document.getElementById('fullscreenChart');
            if (!canvas) return;
            
            if (fullscreenChartInstance) {
                fullscreenChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const dataLength = chartData.dates.length;
            const startIdx = Math.max(0, dataLength - days);
            
            // Ê†πÊìö‰∫§ÊòìÊó•Êï∏Ê±∫ÂÆöÊó•ÊúüÊ†ºÂºè
            // 22=1M, 65=3M, 130=6M, 252=1Y, 756=3Y, 1260=5Y
            const formatDate = (d) => {
                if (days <= 130) {
                    return d.slice(5);  // MM-DDÔºà6 ÂÄãÊúà‰ª•ÂÖßÔºâ
                } else {
                    return d.slice(2, 7).replace('-', '/');  // YY/MMÔºà1 Âπ¥‰ª•‰∏äÔºâ
                }
            };
            
            // ÊâÄÊúâÊó•ÊúüÈÉΩÊ†ºÂºèÂåñÔºåËÆì Chart.js Ëá™ÂãïÊ±∫ÂÆöÈ°ØÁ§∫Âì™‰∫õ
            const labels = chartData.dates.slice(startIdx).map(d => formatDate(d));
            
            fullscreenChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Êî∂Áõ§ÂÉπ',
                            data: chartData.prices.slice(startIdx),
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA20',
                            data: chartData.ma20.slice(startIdx),
                            borderColor: '#EF4444',  // Á¥ÖËâ≤
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA50',
                            data: chartData.ma50.slice(startIdx),
                            borderColor: '#10B981',  // Á∂†Ëâ≤
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA200',
                            data: chartData.ma200.slice(startIdx),
                            borderColor: '#EAB308',  // ÈªÉËâ≤
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: 'MA250',
                            data: chartData.ma250 ? chartData.ma250.slice(startIdx) : [],
                            borderColor: '#A855F7',  // Ê∑∫Á¥´Ëâ≤
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === null) return null;
                                    return `${context.dataset.label}: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: days <= 60 ? 8 : 10,
                                maxRotation: 0,
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if (!label) return '';
                                    return label;
                                }
                            }
                        },
                        y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });
        }

        // ========== ËøΩËπ§Ê∏ÖÂñÆÊéíÂ∫èË®≠ÂÆö ==========
        let watchlistSortMode = localStorage.getItem('watchlist_sort') || 'custom';
        let watchlistData = [];  // Á∑©Â≠òÊ∏ÖÂñÆË≥áÊñô
        
        const SORT_OPTIONS = {
            custom: { label: 'Ëá™Ë®Ç', icon: 'fa-clock' },
            symbol: { label: '‰ª£Á¢º', icon: 'fa-sort-alpha-down' },
            change_desc: { label: 'Êº≤ÂπÖ‚Üì', icon: 'fa-arrow-up' },
            change_asc: { label: 'Ë∑åÂπÖ‚Üì', icon: 'fa-arrow-down' },
            ma20: { label: 'MA20', icon: 'fa-chart-line' },
        };
        
        function setWatchlistSort(mode) {
            watchlistSortMode = mode;
            localStorage.setItem('watchlist_sort', mode);
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            const activeBtn = document.getElementById(`sort-btn-${mode}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìÔºà‰ΩøÁî®Á∑©Â≠òË≥áÊñôÔºå‰∏çÈáçÊñ∞ÂëºÂè´ APIÔºâ
            if (watchlistData.length > 0) {
                renderWatchlistCards(watchlistData);
            }
        }
        
        function sortWatchlistData(data) {
            const sorted = [...data];
            
            switch (watchlistSortMode) {
                case 'symbol':
                    sorted.sort((a, b) => a.symbol.localeCompare(b.symbol));
                    break;
                case 'change_desc':
                    sorted.sort((a, b) => (b.change_pct || 0) - (a.change_pct || 0));
                    break;
                case 'change_asc':
                    sorted.sort((a, b) => (a.change_pct || 0) - (b.change_pct || 0));
                    break;
                case 'ma20':
                    // MA20 ÊéíÂ∫èÔºöÁ´ô‰∏ä(Ê≠£Â∑Æ) > Êé•Ëøë(Â∞èÂ∑Æ) > Ë∑åÁ†¥(Ë≤†Â∑Æ) > ÁÑ°Ë≥áÊñô
                    sorted.sort((a, b) => {
                        const scoreA = getMa20Score(a);
                        const scoreB = getMa20Score(b);
                        return scoreB - scoreA;
                    });
                    break;
                case 'custom':
                default:
                    sorted.sort((a, b) => new Date(b.added_at) - new Date(a.added_at));
                    break;
            }
            
            return sorted;
        }
        
        // Ë®àÁÆó MA20 ÂàÜÊï∏ÔºàÁî®ÊñºÊéíÂ∫èÔºâ
        function getMa20Score(item) {
            if (!item.price || !item.ma20) return -999;  // ÁÑ°Ë≥áÊñôÊîæÊúÄÂæå
            const diff = (item.price - item.ma20) / item.ma20 * 100;
            return diff;  // Áõ¥Êé•Áî®ÁôæÂàÜÊØîÂ∑ÆÂÄºÊéíÂ∫è
        }
        
        // ÂèñÂæó MA20 ÁãÄÊÖãÊ®ôÁ±§
        function getMa20Badge(item) {
            if (!item.price || !item.ma20) {
                return '';
            }
            const diff = (item.price - item.ma20) / item.ma20 * 100;
            if (diff > 3) {
                return '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">‚ñ≤MA20</span>';
            } else if (diff > 0) {
                return '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-green-50 text-green-600">Á´ô‰∏äMA20</span>';
            } else if (diff > -3) {
                return '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700">Ê∏¨MA20</span>';
            } else {
                return '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">‚ñºMA20</span>';
            }
        }
        
        function renderSortControls() {
            return `
                <div class="flex items-center gap-2 mb-4 overflow-x-auto pb-2">
                    <span class="text-sm text-gray-500 whitespace-nowrap">ÊéíÂ∫èÔºö</span>
                    ${Object.entries(SORT_OPTIONS).map(([key, opt]) => `
                        <button onclick="setWatchlistSort('${key}')" 
                                id="sort-btn-${key}"
                                class="sort-btn px-3 py-1.5 text-sm rounded-full whitespace-nowrap transition-all
                                       ${watchlistSortMode === key 
                                           ? 'bg-blue-600 text-white' 
                                           : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                            <i class="fas ${opt.icon} mr-1"></i>${opt.label}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        function renderWatchlistCards(data) {
            const container = document.getElementById('watchlistContent');
            if (!container) return;
            
            watchlistData = data;
            const sortedData = sortWatchlistData(data);
            
            let html = renderSortControls();
            html += '<div class="space-y-3">';
            
            for (const item of sortedData) {
                const typeClass = item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                const typeText = item.asset_type === 'crypto' ? 'Âπ£' : 'ËÇ°';
                
                // üÜï Âà∞ÂÉπÊèêÈÜíËÆäËâ≤
                const hasTarget = item.target_price !== null && item.target_price !== undefined;
                const targetReached = item.target_reached === true;
                const cardBorderClass = targetReached 
                    ? 'border-yellow-500 ring-2 ring-yellow-300' 
                    : (item.asset_type === 'crypto' ? 'border-purple-500' : 'border-blue-500');
                
                let priceInfo = '';
                if (item.price !== null && item.price !== undefined) {
                    const change = item.change_pct || 0;
                    const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                    const changeIcon = change >= 0 ? '‚ñ≤' : '‚ñº';
                    const ma20Badge = getMa20Badge(item);
                    
                    // üÜï ÁõÆÊ®ôÂÉπÈ°ØÁ§∫
                    let targetBadge = '';
                    if (hasTarget) {
                        if (targetReached) {
                            targetBadge = `<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700 animate-pulse">
                                <i class="fas fa-bell mr-1"></i>Â∑≤ÈÅîÊ®ô $${item.target_price.toLocaleString()}
                            </span>`;
                        } else {
                            const diff = ((item.target_price - item.price) / item.price * 100).toFixed(1);
                            targetBadge = `<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">
                                <i class="fas fa-crosshairs mr-1"></i>ÁõÆÊ®ô $${item.target_price.toLocaleString()} (${diff > 0 ? '+' : ''}${diff}%)
                            </span>`;
                        }
                    }
                    
                    priceInfo = `
                        <div class="flex items-baseline gap-2 mt-2 flex-wrap">
                            <span class="text-xl font-bold text-gray-800">$${item.price.toLocaleString()}</span>
                            <span class="${changeClass} text-sm font-medium">${changeIcon} ${Math.abs(change).toFixed(2)}%</span>
                            ${ma20Badge}
                            ${targetBadge}
                        </div>
                    `;
                } else {
                    priceInfo = `<div class="flex items-baseline gap-2 mt-2"><span class="text-gray-400 text-sm">ÂÉπÊ†ºÊõ¥Êñ∞‰∏≠...</span></div>`;
                }
                
                const nameDisplay = item.name ? `<span class="text-gray-500 text-sm ml-2">${item.name}</span>` : '';
                const isCrypto = item.asset_type === 'crypto';
                const isTw = item.symbol.includes('.TW') || /^\d+$/.test(item.symbol);
                const market = isTw ? 'tw' : 'us';
                
                const tradeButtons = isCrypto ? '' : `
                    <div class="flex gap-2 mr-2">
                        <button onclick="quickTrade('${item.symbol}', '${item.name || ''}', '${market}', 'buy')" 
                                class="px-3 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 touch-target">
                            <i class="fas fa-arrow-down mr-1"></i>Ë≤∑ÂÖ•
                        </button>
                        <button onclick="quickTrade('${item.symbol}', '${item.name || ''}', '${market}', 'sell')" 
                                class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 touch-target">
                            <i class="fas fa-arrow-up mr-1"></i>Ë≥£Âá∫
                        </button>
                    </div>
                `;
                
                // üÜï Ë®≠ÂÆöÁõÆÊ®ôÂÉπÊåâÈàï
                const targetPriceBtn = `
                    <button onclick="showTargetPriceModal(${item.id}, '${item.symbol}', ${item.target_price || 'null'})" 
                            class="px-3 py-2 ${hasTarget ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'} rounded-lg text-sm hover:bg-yellow-200 touch-target mr-2"
                            title="${hasTarget ? '‰øÆÊîπÁõÆÊ®ôÂÉπ' : 'Ë®≠ÂÆöÁõÆÊ®ôÂÉπ'}">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                `;
                
                html += `
                    <div class="stock-card bg-white rounded-xl shadow-sm p-4 border-l-4 ${cardBorderClass}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center flex-wrap">
                                    <span class="font-bold text-lg text-gray-800">${item.symbol}</span>
                                    <span class="ml-2 px-2 py-0.5 rounded text-xs ${typeClass}">${typeText}</span>
                                    ${targetReached ? '<span class="ml-2 px-2 py-0.5 rounded text-xs bg-yellow-500 text-white"><i class="fas fa-bell"></i> Âà∞ÂÉπ</span>' : ''}
                                    ${nameDisplay}
                                </div>
                                ${priceInfo}
                                ${item.note ? `<p class="text-gray-500 text-sm mt-2 italic"><i class="fas fa-sticky-note mr-1"></i>${item.note}</p>` : ''}
                            </div>
                            <button onclick="removeFromWatchlist('${item.symbol}')" class="p-2 text-gray-400 hover:text-red-500 touch-target">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-3 border-t flex-wrap gap-2">
                            <span class="text-gray-400 text-xs"><i class="fas fa-clock mr-1"></i>Âä†ÂÖ•Êñº ${new Date(item.added_at).toLocaleDateString()}</span>
                            <div class="flex items-center">
                                ${targetPriceBtn}
                                ${tradeButtons}
                                <button onclick="searchSymbol('${item.symbol}')" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 touch-target">
                                    <i class="fas fa-chart-line mr-1"></i>Ë©≥Á¥∞ÂàÜÊûê
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ========== ËøΩËπ§Ê∏ÖÂñÆ (Âç°ÁâáÂºè) - ÂÑ™ÂåñÁâàÔºö‰∏¶Ë°åËºâÂÖ• ==========
        async function loadWatchlist() {
            const container = document.getElementById('watchlistContent');
            
            if (!currentUser || !currentUser.id) {
                console.error('loadWatchlist: Áî®Êà∂Êú™ÁôªÂÖ•');
                container.innerHTML = '<p class="text-red-500 text-center py-4">Ë´ãÂÖàÁôªÂÖ•</p>';
                return;
            }
            
            console.log(`ËºâÂÖ•ËøΩËπ§Ê∏ÖÂñÆÈ†ÅÈù¢: user_id=${currentUser.id}`);
            
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-500">ËºâÂÖ•‰∏≠...</p>
                </div>
            `;
            
            try {
                const res = await apiRequest('/api/watchlist/with-prices');
                const data = await res.json();
                
                console.log(`ËøΩËπ§Ê∏ÖÂñÆ(Âê´ÂÉπÊ†º)ÂõûÊáâ: Êï∏Èáè=${data.data?.length || 0}`);
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-star text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500 mb-4">Â∞öÁÑ°ËøΩËπ§ÁöÑËÇ°Á•®</p>
                            <button onclick="showAddWatchlistModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Êñ∞Â¢ûËøΩËπ§
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // üÜï ‰ΩøÁî®ÊéíÂ∫èÊ∏≤ÊüìÂáΩÊï∏
                renderWatchlistCards(data.data);
                
            } catch (e) {
                console.error('ËºâÂÖ•ËøΩËπ§Ê∏ÖÂñÆÂ§±Êïó', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
            }
        }
        
        // ‰øùÁïôËàäÂáΩÊï∏‰ª•ÂÇô‰∏çÊôÇ‰πãÈúÄÔºàÂø´Âèñ API Â§±ÊïóÊôÇÂèØÁî®Ôºâ
        async function loadItemPrice(item) {
            const priceContainer = document.getElementById(`price-${item.symbol.replace('.', '-')}`);
            if (!priceContainer) return;
            
            try {
                const endpoint = item.asset_type === 'crypto' 
                    ? `/api/crypto/${item.symbol}`
                    : `/api/stock/${item.symbol}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ÁßíË∂ÖÊôÇ
                
                const priceRes = await fetch(`${API_BASE}${endpoint}`, { 
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);
                
                if (priceRes.ok) {
                    const priceData = await priceRes.json();
                    if (priceData.success) {
                        // API ÂõûÂÇ≥Ê†ºÂºèÔºöË≥áÊñôÁõ¥Êé•Âú®È†ÇÂ±§
                        const price = priceData.price?.current;
                        const change = priceData.change?.day || priceData.change_24h || 0;
                        const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                        const changeIcon = change >= 0 ? '‚ñ≤' : '‚ñº';
                        
                        priceContainer.innerHTML = `
                            <span class="text-xl font-bold text-gray-800">$${price?.toLocaleString() || '--'}</span>
                            <span class="${changeClass} text-sm font-medium">${changeIcon} ${Math.abs(change).toFixed(2)}%</span>
                        `;
                        console.log(`${item.symbol} ÂÉπÊ†ºËºâÂÖ•ÂÆåÊàê: $${price}`);
                        return;
                    }
                }
                
                priceContainer.innerHTML = `<span class="text-gray-400 text-sm">--</span>`;
                
            } catch (e) {
                if (e.name === 'AbortError') {
                    priceContainer.innerHTML = `<span class="text-gray-400 text-sm">Ë∂ÖÊôÇ</span>`;
                } else {
                    priceContainer.innerHTML = `<span class="text-gray-400 text-sm">--</span>`;
                }
                console.log(`${item.symbol} ÂÉπÊ†ºËºâÂÖ•Â§±Êïó:`, e.message);
            }
        }
        
        function showAddWatchlistModal() {
            document.getElementById('addWatchlistModal').classList.remove('hidden');
            document.getElementById('addWatchlistModal').classList.add('flex');
        }
        
        function hideAddWatchlistModal() {
            document.getElementById('addWatchlistModal').classList.add('hidden');
            document.getElementById('addWatchlistModal').classList.remove('flex');
            document.getElementById('addSymbol').value = '';
            document.getElementById('addNote').value = '';
        }
        
        async function addToWatchlist() {
            const symbol = document.getElementById('addSymbol').value.trim().toUpperCase();
            const assetType = document.getElementById('addAssetType').value;
            const note = document.getElementById('addNote').value.trim();
            
            if (!symbol) {
                showToast('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü');
                return;
            }
            
            // È©óË≠âÁï∂ÂâçÁî®Êà∂
            if (!currentUser || !currentUser.id) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            console.log(`Êñ∞Â¢ûËøΩËπ§: user_id=${currentUser.id}, symbol=${symbol}`);
            
            try {
                const res = await apiRequest('/api/watchlist', {
                    method: 'POST',
                    body: { symbol, asset_type: assetType, note }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    console.log(`ËøΩËπ§Êñ∞Â¢ûÊàêÂäü: user_id=${currentUser.id}, symbol=${symbol}`);
                    showToast('Â∑≤Âä†ÂÖ•ËøΩËπ§Ê∏ÖÂñÆ');
                    hideAddWatchlistModal();
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó');
                }
            } catch (e) {
                console.error('Êñ∞Â¢ûËøΩËπ§Â§±Êïó:', e);
                showToast('Êñ∞Â¢ûÂ§±Êïó');
            }
        }
        
        async function quickAddToWatchlist(symbol, assetType) {
            // È©óË≠âÁï∂ÂâçÁî®Êà∂
            if (!currentUser || !currentUser.id) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            console.log(`Âø´ÈÄüÊñ∞Â¢ûËøΩËπ§: user_id=${currentUser.id}, symbol=${symbol}`);
            
            try {
                const res = await apiRequest('/api/watchlist', {
                    method: 'POST',
                    body: { symbol, asset_type: assetType, note: '' }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    console.log(`ËøΩËπ§Êñ∞Â¢ûÊàêÂäü: user_id=${currentUser.id}, symbol=${symbol}`);
                    showToast(`${symbol} Â∑≤Âä†ÂÖ•ËøΩËπ§Ê∏ÖÂñÆ`);
                    loadWatchlistOverview();
                } else {
                    showToast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó');
                }
            } catch (e) {
                console.error('Âø´ÈÄüÊñ∞Â¢ûËøΩËπ§Â§±Êïó:', e);
                showToast('Êñ∞Â¢ûÂ§±Êïó');
            }
        }
        
        async function removeFromWatchlist(symbol) {
            if (!confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§ ${symbol} ÁöÑËøΩËπ§Ôºü`)) return;
            
            // È©óË≠âÁï∂ÂâçÁî®Êà∂
            if (!currentUser || !currentUser.id) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            console.log(`ÁßªÈô§ËøΩËπ§: user_id=${currentUser.id}, symbol=${symbol}`);
            
            try {
                const res = await apiRequest(`/api/watchlist/${symbol}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    console.log(`ËøΩËπ§ÁßªÈô§ÊàêÂäü: user_id=${currentUser.id}, symbol=${symbol}`);
                    showToast(`${symbol} Â∑≤ÁßªÈô§`);
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast(data.detail || 'ÁßªÈô§Â§±Êïó');
                }
            } catch (e) {
                console.error('ÁßªÈô§Â§±Êïó:', e);
                showToast('ÁßªÈô§Â§±Êïó');
            }
        }

        // ========== Ë®≠ÂÆö ==========
        let currentSettings = {
            indicators: {},
            alerts: {},
            params: {}
        };
        
        async function loadSettings() {
            // È©óË≠âÁï∂ÂâçÁî®Êà∂
            if (!currentUser || !currentUser.id) {
                console.error('loadSettings: Áî®Êà∂Êú™ÁôªÂÖ•');
                return;
            }
            
            console.log(`ËºâÂÖ•Ë®≠ÂÆö: user_id=${currentUser.id}`);
            
            // ËºâÂÖ•Áî®Êà∂Ë≥áË®ä
            document.getElementById('settingsUserName').textContent = currentUser.display_name || '-';
            // ÊúÉÂì°Á≠âÁ¥ö (‰πãÂæåÂèØÂæûÁî®Êà∂Ë≥áÊñôÂèñÂæó)
            const levelEl = document.getElementById('settingsMemberLevel');
            if (levelEl) {
                const level = currentUser.membership_level || 'free';
                const levelNames = { 'free': '‰∏ÄËà¨ÊúÉÂì°', 'premium': 'È´òÁ¥öÊúÉÂì°', 'diamond': 'ÈëΩÁü≥ÊúÉÂì°', 'admin': 'ÁÆ°ÁêÜÂì°' };
                const levelColors = { 'free': 'text-gray-600', 'premium': 'text-blue-600', 'diamond': 'text-purple-600', 'admin': 'text-orange-600' };
                levelEl.textContent = levelNames[level] || '‰∏ÄËà¨ÊúÉÂì°';
                levelEl.className = `font-medium ${levelColors[level] || 'text-gray-600'}`;
            }
            
            // ËºâÂÖ•ÊåáÊ®ôË®≠ÂÆö
            try {
                const indRes = await apiRequest('/api/settings/indicators');
                const indData = await indRes.json();
                if (indData.success && indData.data) {
                    currentSettings.indicators = indData.data;
                    applyIndicatorSettings(indData.data);
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊåáÊ®ôË®≠ÂÆöÂ§±Êïó', e);
            }
            
            // ËºâÂÖ•ÈÄöÁü•Ë®≠ÂÆö
            try {
                const alertRes = await apiRequest('/api/settings/alerts');
                const alertData = await alertRes.json();
                if (alertData.success && alertData.data) {
                    currentSettings.alerts = alertData.data;
                    applyAlertSettings(alertData.data);
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÈÄöÁü•Ë®≠ÂÆöÂ§±Êïó', e);
            }
            
            // ËºâÂÖ•ÂèÉÊï∏Ë®≠ÂÆö
            try {
                const paramRes = await apiRequest('/api/settings/params');
                const paramData = await paramRes.json();
                if (paramData.success && paramData.data) {
                    currentSettings.params = paramData.data;
                    applyParamSettings(paramData.data);
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÂèÉÊï∏Ë®≠ÂÆöÂ§±Êïó', e);
            }
        }
        
        function applyIndicatorSettings(data) {
            const fields = ['show_ma', 'show_rsi', 'show_macd', 'show_kd', 'show_bollinger', 'show_obv', 'show_volume'];
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el) el.checked = data[field] ?? false;
            });
        }
        
        function applyAlertSettings(data) {
            const fields = ['alert_ma_cross', 'alert_ma_breakout', 'alert_rsi', 'alert_macd', 'alert_kd', 'alert_bollinger', 'alert_volume', 'alert_sentiment'];
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el) el.checked = data[field] ?? false;
            });
        }
        
        function applyParamSettings(data) {
            const fields = ['ma_short', 'ma_mid', 'ma_long', 'rsi_period', 'rsi_overbought', 'rsi_oversold', 
                           'macd_fast', 'macd_slow', 'macd_signal', 'kd_period', 'bollinger_period',
                           'breakout_threshold', 'volume_alert_ratio'];
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el && data[field] !== undefined) el.value = data[field];
            });
        }
        
        async function saveIndicatorSettings() {
            if (!currentUser) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            const data = {
                show_ma: document.getElementById('show_ma').checked,
                show_rsi: document.getElementById('show_rsi').checked,
                show_macd: document.getElementById('show_macd').checked,
                show_kd: document.getElementById('show_kd').checked,
                show_bollinger: document.getElementById('show_bollinger').checked,
                show_obv: document.getElementById('show_obv').checked,
                show_volume: document.getElementById('show_volume').checked,
            };
            
            console.log(`ÂÑ≤Â≠òÊåáÊ®ôË®≠ÂÆö: user_id=${currentUser.id}`);
            
            try {
                const res = await apiRequest('/api/settings/indicators', {
                    method: 'PUT',
                    body: data
                });
                const result = await res.json();
                if (result.success) {
                    showToast('ÊåáÊ®ôË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                    currentSettings.indicators = result.data;
                } else {
                    showToast('ÂÑ≤Â≠òÂ§±Êïó: ' + (result.error?.message || 'Êú™Áü•ÈåØË™§'));
                }
            } catch (e) {
                console.error('ÂÑ≤Â≠òÊåáÊ®ôË®≠ÂÆöÂ§±Êïó', e);
                showToast('ÂÑ≤Â≠òÂ§±Êïó');
            }
        }
        
        async function saveAlertSettings() {
            if (!currentUser) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            const data = {
                alert_ma_cross: document.getElementById('alert_ma_cross').checked,
                alert_ma_breakout: document.getElementById('alert_ma_breakout').checked,
                alert_rsi: document.getElementById('alert_rsi').checked,
                alert_macd: document.getElementById('alert_macd').checked,
                alert_kd: document.getElementById('alert_kd').checked,
                alert_bollinger: document.getElementById('alert_bollinger').checked,
                alert_volume: document.getElementById('alert_volume').checked,
                alert_sentiment: document.getElementById('alert_sentiment').checked,
            };
            
            console.log(`ÂÑ≤Â≠òÈÄöÁü•Ë®≠ÂÆö: user_id=${currentUser.id}`);
            
            try {
                const res = await apiRequest('/api/settings/alerts', {
                    method: 'PUT',
                    body: data
                });
                const result = await res.json();
                if (result.success) {
                    showToast('ÈÄöÁü•Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                    currentSettings.alerts = result.data;
                } else {
                    showToast('ÂÑ≤Â≠òÂ§±Êïó: ' + (result.error?.message || 'Êú™Áü•ÈåØË™§'));
                }
            } catch (e) {
                console.error('ÂÑ≤Â≠òÈÄöÁü•Ë®≠ÂÆöÂ§±Êïó', e);
                showToast('ÂÑ≤Â≠òÂ§±Êïó');
            }
        }
        
        async function saveParamSettings() {
            if (!currentUser) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            const data = {
                ma_short: parseInt(document.getElementById('ma_short').value),
                ma_mid: parseInt(document.getElementById('ma_mid').value),
                ma_long: parseInt(document.getElementById('ma_long').value),
                rsi_period: parseInt(document.getElementById('rsi_period').value),
                rsi_overbought: parseInt(document.getElementById('rsi_overbought').value),
                rsi_oversold: parseInt(document.getElementById('rsi_oversold').value),
                macd_fast: parseInt(document.getElementById('macd_fast').value),
                macd_slow: parseInt(document.getElementById('macd_slow').value),
                macd_signal: parseInt(document.getElementById('macd_signal').value),
                kd_period: parseInt(document.getElementById('kd_period').value),
                bollinger_period: parseInt(document.getElementById('bollinger_period').value),
                breakout_threshold: parseFloat(document.getElementById('breakout_threshold').value),
                volume_alert_ratio: parseFloat(document.getElementById('volume_alert_ratio').value),
            };
            
            console.log(`ÂÑ≤Â≠òÂèÉÊï∏Ë®≠ÂÆö: user_id=${currentUser.id}`);
            
            try {
                const res = await apiRequest('/api/settings/params', {
                    method: 'PUT',
                    body: data
                });
                const result = await res.json();
                if (result.success) {
                    showToast('ÂèÉÊï∏Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                    currentSettings.params = result.data;
                } else {
                    showToast('ÂÑ≤Â≠òÂ§±Êïó: ' + (result.error?.message || 'Êú™Áü•ÈåØË™§'));
                }
            } catch (e) {
                console.error('ÂÑ≤Â≠òÂèÉÊï∏Ë®≠ÂÆöÂ§±Êïó', e);
                showToast('ÂÑ≤Â≠òÂ§±Êïó');
            }
        }
        
        function resetParams() {
            // ÊÅ¢Âæ©È†êË®≠ÂÄº
            document.getElementById('ma_short').value = 20;
            document.getElementById('ma_mid').value = 50;
            document.getElementById('ma_long').value = 200;
            document.getElementById('rsi_period').value = 14;
            document.getElementById('rsi_overbought').value = 70;
            document.getElementById('rsi_oversold').value = 30;
            document.getElementById('macd_fast').value = 12;
            document.getElementById('macd_slow').value = 26;
            document.getElementById('macd_signal').value = 9;
            document.getElementById('kd_period').value = 9;
            document.getElementById('bollinger_period').value = 20;
            document.getElementById('breakout_threshold').value = 2.0;
            document.getElementById('volume_alert_ratio').value = 2.0;
            showToast('Â∑≤ÊÅ¢Âæ©È†êË®≠ÂÄºÔºåË´ãÊåâÂÑ≤Â≠òÂ•óÁî®');
        }
        
        async function applyTemplate(templateName) {
            if (!currentUser) {
                showToast('Ë´ãÂÖàÁôªÂÖ•');
                return;
            }
            
            console.log(`Â•óÁî®Ê®°Êùø: user_id=${currentUser.id}, template=${templateName}`);
            
            try {
                const res = await apiRequest(`/api/settings/template/${templateName}`, {
                    method: 'POST'
                });
                const result = await res.json();
                if (result.success) {
                    showToast(`Â∑≤Â•óÁî®„Äå${getTemplateName(templateName)}„ÄçÊ®°Êùø`);
                    // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
                    updateTemplateButtonStyle(templateName);
                    // ÈáçÊñ∞ËºâÂÖ•Ë®≠ÂÆö
                    await loadSettings();
                } else {
                    showToast('Â•óÁî®Â§±Êïó: ' + (result.error?.message || 'Êú™Áü•ÈåØË™§'));
                }
            } catch (e) {
                console.error('Â•óÁî®Ê®°ÊùøÂ§±Êïó', e);
                showToast('Â•óÁî®Â§±Êïó');
            }
        }
        
        function updateTemplateButtonStyle(selectedTemplate) {
            const buttons = document.querySelectorAll('#templateButtons .template-btn');
            buttons.forEach(btn => {
                const template = btn.getAttribute('data-template');
                if (template === selectedTemplate) {
                    // ÈÅ∏‰∏≠Ê®£Âºè
                    btn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
                    btn.classList.remove('border-gray-200');
                } else {
                    // Êú™ÈÅ∏‰∏≠Ê®£Âºè
                    btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                    btn.classList.add('border-gray-200');
                }
            });
        }
        
        function getTemplateName(key) {
            const names = {
                'minimal': 'Ê•µÁ∞°',
                'standard': 'Ê®ôÊ∫ñ',
                'full': 'ÂÆåÊï¥',
                'short_term': 'Áü≠Á∑ö'
            };
            return names[key] || key;
        }
        
        async function loadSentimentDetail() {
            const container = document.getElementById('sentimentContent');
            
            // ÂÖàÂòóË©¶ÂèñÂæóÊÉÖÁ∑íË≥áÊñô
            let stockData = { value: 50, classification: 'neutral' };
            let cryptoData = { value: 50, classification: 'neutral' };
            
            try {
                const res = await fetch(`${API_BASE}/api/market/sentiment`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.stock) stockData = data.stock;
                    if (data.crypto) cryptoData = data.crypto;
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊÉÖÁ∑íË≥áÊñôÂ§±Êïó', e);
            }
            
            // ÁîüÊàêÁ∞°ÊΩîÂÑÄË°®Áõ§ SVG HTML
            function createGaugeSVG(id, value) {
                const angle = -90 + (value / 100) * 180;
                
                let label, colorClass;
                if (value <= 25) {
                    label = 'Extreme Fear';
                    colorClass = 'text-red-600';
                } else if (value <= 45) {
                    label = 'Fear';
                    colorClass = 'text-orange-500';
                } else if (value <= 55) {
                    label = 'Neutral';
                    colorClass = 'text-gray-500';
                } else if (value <= 75) {
                    label = 'Greed';
                    colorClass = 'text-green-500';
                } else {
                    label = 'Extreme Greed';
                    colorClass = 'text-emerald-600';
                }
                
                return `
                    <div class="fear-greed-gauge">
                        <svg viewBox="0 0 200 115" class="gauge-svg">
                            <!-- ÂºßÂΩ¢ËÉåÊôØÂçÄÊÆµ -->
                            <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                            <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                            <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                            <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                            <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                            
                            <!-- ÂàªÂ∫¶Êï∏Â≠ó -->
                            <text x="8" y="105" class="gauge-tick-text">0</text>
                            <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                            <text x="188" y="105" class="gauge-tick-text">100</text>
                            
                            <!-- ÊåáÈáù -->
                            <g class="gauge-needle-group" style="transform: rotate(${angle}deg); transform-origin: 100px 100px;">
                                <polygon class="gauge-needle" points="100,25 97,100 103,100" />
                            </g>
                            <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                        </svg>
                    </div>
                    <div class="text-center mt-2">
                        <span class="text-4xl font-bold text-gray-800">${value}</span>
                    </div>
                    <p class="text-center font-semibold text-lg mt-1 ${colorClass}">${label}</p>
                `;
            }
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- ÁæéËÇ°ÊÉÖÁ∑í -->
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="font-semibold text-gray-700 mb-4 text-center">ÁæéËÇ°ÊÉÖÁ∑íÊåáÊï∏ (Fear & Greed)</h3>
                        ${createGaugeSVG('stock-detail', stockData.value)}
                    </div>
                    
                    <!-- Âπ£ÂúàÊÉÖÁ∑í -->
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="font-semibold text-gray-700 mb-4 text-center">Âπ£ÂúàÊÉÖÁ∑íÊåáÊï∏</h3>
                        ${createGaugeSVG('crypto-detail', cryptoData.value)}
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="font-semibold text-gray-700 mb-4">Â∏ÇÂ†¥ÊÉÖÁ∑íËß£ËÆÄ</h3>
                    <div class="space-y-4 text-sm text-gray-600">
                        <div class="flex items-start">
                            <span class="w-24 flex-shrink-0 font-medium">0-25</span>
                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded mr-2">Ê•µÂ∫¶ÊÅêÊáº</span>
                            <span>Â∏ÇÂ†¥ÊÅêÊÖåÔºåÂèØËÉΩÊòØË≤∑ÂÖ•Ê©üÊúÉ</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-24 flex-shrink-0 font-medium">26-45</span>
                            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded mr-2">ÊÅêÊáº</span>
                            <span>Â∏ÇÂ†¥ÂÅèË¨πÊÖé</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-24 flex-shrink-0 font-medium">46-55</span>
                            <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded mr-2">‰∏≠ÊÄß</span>
                            <span>ËßÄÊúõÁÇ∫‰∏ª</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-24 flex-shrink-0 font-medium">56-75</span>
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded mr-2">Ë≤™Â©™</span>
                            <span>Â∏ÇÂ†¥ÂÅèÊ®ÇËßÄ</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-24 flex-shrink-0 font-medium">76-100</span>
                            <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded mr-2">Ê•µÂ∫¶Ë≤™Â©™</span>
                            <span>Â∏ÇÂ†¥ÈÅéÁÜ±ÔºåÁïôÊÑèÈ¢®Èö™</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== Âπ¥ÂåñÂ†±ÈÖ¨Áéá Modal ==========
        async function loadReturnsModal(symbol) {
            const modal = document.getElementById('returnsModal');
            const content = document.getElementById('returnsModalContent');
            const title = document.getElementById('returnsModalTitle');
            
            title.textContent = `${symbol} Âπ¥ÂåñÂ†±ÈÖ¨Áéá`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
                    <p class="mt-2 text-gray-500">Ë®àÁÆó‰∏≠...ÔºàÂê´ÈÖçÊÅØÂÜçÊäïÂÖ•Ôºâ</p>
                </div>
            `;
            
            try {
                const res = await apiRequest(`/api/stock/${symbol}/returns`);
                const data = await res.json();
                
                console.log('Âπ¥ÂåñÂ†±ÈÖ¨Áéá:', data);
                
                if (!data.success) {
                    throw new Error(data.detail || 'Ë®àÁÆóÂ§±Êïó');
                }
                
                renderReturnsModal(data.data);
                
            } catch (e) {
                console.error('ËºâÂÖ•Âπ¥ÂåñÂ†±ÈÖ¨ÁéáÂ§±Êïó:', e);
                content.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                        <p>${e.message || 'ËºâÂÖ•Â§±Êïó'}</p>
                    </div>
                `;
            }
        }
        
        function renderReturnsModal(data) {
            const content = document.getElementById('returnsModalContent');
            const periods = ['1Y', '3Y', '5Y', '10Y'];
            
            let html = `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-600 text-sm">${data.name}</p>
                    <p class="text-2xl font-bold text-gray-800">$${data.current_price.toLocaleString()}</p>
                    <p class="text-xs text-gray-400">${data.current_date}</p>
                </div>
                
                <div class="space-y-3">
            `;
            
            for (const period of periods) {
                const ret = data.returns[period];
                
                if (!ret) {
                    html += `
                        <div class="p-3 bg-gray-100 rounded-lg opacity-50">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-600">${period}</span>
                                <span class="text-gray-400 text-sm">Ë≥áÊñô‰∏çË∂≥</span>
                            </div>
                        </div>
                    `;
                    continue;
                }
                
                const cagr = ret.cagr;
                const cagrClass = cagr >= 0 ? 'text-green-600' : 'text-red-600';
                const cagrIcon = cagr >= 0 ? '‚ñ≤' : '‚ñº';
                const cagrBg = cagr >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                
                html += `
                    <div class="p-4 bg-white border rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-lg text-gray-800">${period}</span>
                            <span class="text-xs text-gray-400">${ret.start_date} ~ ‰ªä</span>
                        </div>
                        
                        <div class="p-4 ${cagrBg} rounded-lg border text-center mb-3">
                            <p class="text-xs text-gray-500 mb-1">Âπ¥ÂåñÂ†±ÈÖ¨Áéá (CAGR)</p>
                            <p class="text-3xl font-bold ${cagrClass}">${cagrIcon} ${cagr !== null ? Math.abs(cagr).toFixed(2) + '%' : '--'}</p>
                        </div>
                        
                        <div class="flex justify-between text-xs text-gray-500 border-t pt-2">
                            <span>Ëµ∑ÂßãÂÉπ: $${ret.start_price.toLocaleString()}</span>
                            <span>ÈÖçÊÅØ ${ret.dividend_count} Ê¨°</span>
                            <span>Á∏ΩÈÖçÊÅØ: $${ret.total_dividends.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        CAGR Âü∫Êñº Yahoo Finance Èô§Ê¨äÊÅØË™øÊï¥ÂæåÂÉπÊ†ºË®àÁÆóÔºå<br>
                        Â∑≤ÂåÖÂê´ÈÖçÊÅØÂÜçÊäïÂÖ•ÁöÑË§áÂà©ÊïàÊûú
                    </p>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function closeReturnsModal() {
            const modal = document.getElementById('returnsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // ========== ÂÄã‰∫∫ÊäïË≥áË®òÈåÑ ==========
        let currentPortfolioTab = 'holdings';
        let twLookupTimer = null;
        let usLookupTimer = null;
        
        function switchPortfolioTab(tab) {
            currentPortfolioTab = tab;
            
            // Êõ¥Êñ∞Ê®ôÁ±§Ê®£Âºè
            const tabs = ['Holdings', 'TwTransactions', 'UsTransactions'];
            tabs.forEach(t => {
                const el = document.getElementById('tab' + t);
                if (el) {
                    el.className = tab === t.charAt(0).toLowerCase() + t.slice(1).replace('Transactions', '-transactions')
                        ? 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap'
                        : 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap';
                }
            });
            
            document.getElementById('tabHoldings').className = tab === 'holdings'
                ? 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap'
                : 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap';
            document.getElementById('tabTwTransactions').className = tab === 'tw-transactions'
                ? 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap'
                : 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap';
            document.getElementById('tabUsTransactions').className = tab === 'us-transactions'
                ? 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap'
                : 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap';
            
            // È°ØÁ§∫Â∞çÊáâÂÖßÂÆπ
            document.getElementById('portfolioHoldings').classList.toggle('hidden', tab !== 'holdings');
            document.getElementById('portfolioTwTransactions').classList.toggle('hidden', tab !== 'tw-transactions');
            document.getElementById('portfolioUsTransactions').classList.toggle('hidden', tab !== 'us-transactions');
            
            // ËºâÂÖ•Ë≥áÊñô
            if (tab === 'holdings') loadHoldings();
            else if (tab === 'tw-transactions') loadTransactions('tw');
            else if (tab === 'us-transactions') loadTransactions('us');
        }
        
        async function loadPortfolio() {
            await loadPortfolioSummary();
            await loadHoldings();
        }
        
        async function loadPortfolioSummary() {
            try {
                const res = await apiRequest('/api/portfolio/summary');
                const data = await res.json();
                
                if (data.success) {
                    const s = data.data;
                    
                    // ÂåØÁéá
                    document.getElementById('exchangeRateValue').textContent = s.exchange_rate?.toFixed(2) || '--';
                    if (s.exchange_rate_updated_at) {
                        const time = new Date(s.exchange_rate_updated_at).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
                        document.getElementById('exchangeRateTime').textContent = `(${time})`;
                    }
                    
                    // ===== Âè∞ËÇ°ÂçÄ =====
                    const twValue = s.tw?.current_value || 0;
                    document.getElementById('twCurrentValue').textContent = twValue > 0 
                        ? `NT$${Math.round(twValue).toLocaleString()}` : '--';
                    
                    const twProfit = (s.tw?.realized_profit || 0) + (s.tw?.unrealized_profit || 0);
                    const twProfitEl = document.getElementById('twProfit');
                    twProfitEl.textContent = twValue > 0 
                        ? `${twProfit >= 0 ? '+' : ''}NT$${Math.round(Math.abs(twProfit)).toLocaleString()}` : '--';
                    twProfitEl.className = twProfit >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    
                    const twReturn = s.tw?.return_rate;
                    const twReturnEl = document.getElementById('twReturnRate');
                    if (twReturn !== null && twReturn !== undefined) {
                        twReturnEl.textContent = `${twReturn >= 0 ? '+' : ''}${twReturn.toFixed(2)}%`;
                        twReturnEl.className = twReturn >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    } else {
                        twReturnEl.textContent = '--';
                    }
                    
                    document.getElementById('twPositions').textContent = s.tw?.positions || 0;
                    
                    // ===== ÁæéËÇ°ÂçÄ =====
                    const usValue = s.us?.current_value || 0;
                    document.getElementById('usCurrentValue').textContent = usValue > 0 
                        ? `$${Math.round(usValue).toLocaleString()}` : '--';
                    
                    const usProfit = (s.us?.realized_profit || 0) + (s.us?.unrealized_profit || 0);
                    const usProfitEl = document.getElementById('usProfit');
                    usProfitEl.textContent = usValue > 0 
                        ? `${usProfit >= 0 ? '+' : ''}$${Math.round(Math.abs(usProfit)).toLocaleString()}` : '--';
                    usProfitEl.className = usProfit >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    
                    const usReturn = s.us?.return_rate;
                    const usReturnEl = document.getElementById('usReturnRate');
                    if (usReturn !== null && usReturn !== undefined) {
                        usReturnEl.textContent = `${usReturn >= 0 ? '+' : ''}${usReturn.toFixed(2)}%`;
                        usReturnEl.className = usReturn >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    } else {
                        usReturnEl.textContent = '--';
                    }
                    
                    document.getElementById('usPositions').textContent = s.us?.positions || 0;
                    
                    // ===== ÂêàË®àÂçÄÔºàTWDÔºâ=====
                    document.getElementById('totalValueTwd').textContent = s.total?.current_value_twd 
                        ? `NT$${Math.round(s.total.current_value_twd).toLocaleString()}` : '--';
                    
                    const totalProfit = s.total?.total_profit_twd || 0;
                    const totalProfitEl = document.getElementById('totalProfitTwd');
                    totalProfitEl.textContent = `${totalProfit >= 0 ? '+' : ''}NT$${Math.round(Math.abs(totalProfit)).toLocaleString()}`;
                    totalProfitEl.className = totalProfit >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    
                    const totalReturn = s.total?.return_rate;
                    const totalReturnEl = document.getElementById('totalReturnRate');
                    if (totalReturn !== null && totalReturn !== undefined) {
                        totalReturnEl.textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%`;
                        totalReturnEl.className = totalReturn >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    } else {
                        totalReturnEl.textContent = '--';
                    }
                    
                    document.getElementById('totalPositions').textContent = s.total?.positions || 0;
                    
                    // Âè∞ËÇ°/ÁæéËÇ°ÊåÅËÇ°ÂçÄÊëòË¶ÅÔºà‰øùÁïôÂéüÊúâÂäüËÉΩÔºâ
                    document.getElementById('twSummaryLine').innerHTML = s.tw?.positions > 0
                        ? `${s.tw.positions} Ê™î ¬∑ ÊêçÁõä <span class="${twProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${twProfit >= 0 ? '+' : ''}NT$${Math.round(Math.abs(twProfit)).toLocaleString()}</span>`
                        : 'Â∞öÁÑ°ÊåÅËÇ°';
                    
                    document.getElementById('usSummaryLine').innerHTML = s.us?.positions > 0
                        ? `${s.us.positions} Ê™î ¬∑ ÊêçÁõä <span class="${usProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${usProfit >= 0 ? '+' : ''}$${Math.round(Math.abs(usProfit)).toLocaleString()}</span>`
                        : 'Â∞öÁÑ°ÊåÅËÇ°';
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊäïË≥áÊëòË¶ÅÂ§±Êïó:', e);
            }
        }
        
        async function loadHoldings() {
            const twContainer = document.getElementById('holdingsTW');
            const usContainer = document.getElementById('holdingsUS');
            
            try {
                const res = await apiRequest('/api/portfolio/holdings');
                const data = await res.json();
                
                if (data.success) {
                    // Âè∞ËÇ°
                    if (data.data.tw && data.data.tw.length > 0) {
                        twContainer.innerHTML = data.data.tw.map(h => renderHoldingCard(h, 'tw')).join('');
                    } else {
                        twContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Â∞öÁÑ°Âè∞ËÇ°ÊåÅËÇ°</p>';
                    }
                    
                    // ÁæéËÇ°
                    if (data.data.us && data.data.us.length > 0) {
                        usContainer.innerHTML = data.data.us.map(h => renderHoldingCard(h, 'us')).join('');
                    } else {
                        usContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Â∞öÁÑ°ÁæéËÇ°ÊåÅËÇ°</p>';
                    }
                }
            } catch (e) {
                console.error('ËºâÂÖ•ÊåÅËÇ°Â§±Êïó:', e);
                twContainer.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
                usContainer.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
            }
        }
        
        function renderHoldingCard(h, market) {
            const profitClass = (h.unrealized_profit || 0) >= 0 ? 'text-green-600' : 'text-red-600';
            const profitPrefix = (h.unrealized_profit || 0) >= 0 ? '+' : '';
            const currency = market === 'tw' ? 'NT$' : '$';
            
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer" 
                     onclick="searchSymbol('${h.symbol}')">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <span class="font-semibold text-gray-800">${h.symbol}</span>
                            <span class="text-gray-500 text-sm ml-2 truncate">${h.name || ''}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${h.quantity_display} @ ${currency}${h.avg_cost?.toFixed(2) || '--'}
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-3">
                        <div class="font-semibold text-gray-800">${currency}${h.current_price?.toLocaleString() || '--'}</div>
                        <div class="text-sm ${profitClass}">
                            ${h.unrealized_profit !== null ? `${profitPrefix}${currency}${Math.abs(h.unrealized_profit).toLocaleString()}` : '--'}
                            ${h.unrealized_profit_pct !== null ? `(${profitPrefix}${h.unrealized_profit_pct.toFixed(1)}%)` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadTransactions(market) {
            const container = document.getElementById(market === 'tw' ? 'twTransactionList' : 'usTransactionList');
            
            try {
                const res = await apiRequest(`/api/portfolio/transactions?market=${market}&limit=50`);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(t => renderTransactionCard(t)).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">Â∞öÁÑ°‰∫§ÊòìÁ¥ÄÈåÑ</p>';
                }
            } catch (e) {
                console.error('ËºâÂÖ•‰∫§ÊòìÁ¥ÄÈåÑÂ§±Êïó:', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
            }
        }
        
        function renderTransactionCard(t) {
            const isBuy = t.transaction_type === 'buy';
            const typeClass = isBuy ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            const typeText = isBuy ? 'Ë≤∑ÂÖ•' : 'Ë≥£Âá∫';
            const currency = t.market === 'tw' ? 'NT$' : '$';
            
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${typeClass}">${typeText}</span>
                            <span class="font-semibold text-gray-800">${t.symbol}</span>
                            <span class="text-gray-500 text-sm truncate">${t.name || ''}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${t.transaction_date} ¬∑ ${t.quantity_display} @ ${currency}${t.price}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-3">
                        <span class="font-semibold text-gray-800">${currency}${Math.round(t.total_amount).toLocaleString()}</span>
                        <button onclick="edit${t.market === 'tw' ? 'Tw' : 'Us'}Transaction(${t.id})" class="p-1 text-gray-400 hover:text-blue-500">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTransaction(${t.id}, '${t.market}')" class="p-1 text-gray-400 hover:text-red-500">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ===== Âè∞ËÇ° Modal =====
        function showAddTwModal() {
            document.getElementById('twEditId').value = '';
            document.getElementById('twModalTitle').textContent = 'Êñ∞Â¢ûÂè∞ËÇ°‰∫§Êòì';
            setTwType('buy');
            document.getElementById('twSymbol').value = '';
            document.getElementById('twName').value = '';
            document.getElementById('twNameDisplay').innerHTML = '<span class="text-gray-400">Ëº∏ÂÖ•‰ª£Á¢ºËá™ÂãïÂ∏∂ÂÖ•</span>';
            document.getElementById('twLots').value = '';
            document.getElementById('twOddLot').value = '';
            document.getElementById('twQuantityDisplay').textContent = '= 0 ËÇ°';
            document.getElementById('twPrice').value = '';
            document.getElementById('twFee').value = '';
            document.getElementById('twTax').value = '';
            document.getElementById('twDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('twNote').value = '';
            
            document.getElementById('twTransactionModal').classList.remove('hidden');
            document.getElementById('twTransactionModal').classList.add('flex');
        }
        
        function closeTwModal() {
            document.getElementById('twTransactionModal').classList.add('hidden');
            document.getElementById('twTransactionModal').classList.remove('flex');
        }
        
        function setTwType(type) {
            document.getElementById('twTxType').value = type;
            if (type === 'buy') {
                document.getElementById('twBtnBuy').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-green-500 text-white';
                document.getElementById('twBtnSell').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600';
                document.getElementById('twTaxField').classList.add('opacity-50');
            } else {
                document.getElementById('twBtnBuy').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600';
                document.getElementById('twBtnSell').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-red-500 text-white';
                document.getElementById('twTaxField').classList.remove('opacity-50');
            }
        }
        
        function updateTwQuantity() {
            const lots = parseInt(document.getElementById('twLots').value) || 0;
            const oddLot = parseInt(document.getElementById('twOddLot').value) || 0;
            const total = lots * 1000 + oddLot;
            document.getElementById('twQuantityDisplay').textContent = `= ${total.toLocaleString()} ËÇ°`;
        }
        
        function lookupTwStock() {
            clearTimeout(twLookupTimer);
            const symbol = document.getElementById('twSymbol').value.trim();
            
            if (!symbol || symbol.length < 4) {
                document.getElementById('twNameDisplay').innerHTML = '<span class="text-gray-400">Ëº∏ÂÖ•‰ª£Á¢ºËá™ÂãïÂ∏∂ÂÖ•</span>';
                document.getElementById('twName').value = '';
                return;
            }
            
            document.getElementById('twNameDisplay').innerHTML = '<span class="text-gray-400"><i class="fas fa-spinner fa-spin mr-1"></i>Êü•Ë©¢‰∏≠...</span>';
            
            twLookupTimer = setTimeout(async () => {
                try {
                    const fullSymbol = symbol.includes('.') ? symbol : `${symbol}.TW`;
                    const res = await fetch(`${API_BASE}/api/stock/${fullSymbol}`);
                    const data = await res.json();
                    
                    if (data.success && data.stock?.name) {
                        document.getElementById('twName').value = data.stock.name;
                        document.getElementById('twNameDisplay').innerHTML = `<span class="text-gray-800">${data.stock.name}</span>`;
                    } else {
                        document.getElementById('twName').value = '';
                        document.getElementById('twNameDisplay').innerHTML = '<span class="text-red-500">Êü•ÁÑ°Ê≠§ËÇ°Á•®</span>';
                    }
                } catch (e) {
                    console.error('Êü•Ë©¢Âè∞ËÇ°Â§±Êïó:', e);
                    document.getElementById('twNameDisplay').innerHTML = '<span class="text-red-500">Êü•Ë©¢Â§±Êïó</span>';
                }
            }, 500);
        }
        
        async function submitTwTransaction() {
            const id = document.getElementById('twEditId').value;
            const symbol = document.getElementById('twSymbol').value.trim().toUpperCase();
            const name = document.getElementById('twName').value.trim();
            const lots = parseInt(document.getElementById('twLots').value) || 0;
            const oddLot = parseInt(document.getElementById('twOddLot').value) || 0;
            const quantity = lots * 1000 + oddLot;
            const price = parseFloat(document.getElementById('twPrice').value);
            const fee = parseFloat(document.getElementById('twFee').value) || 0;
            const tax = parseFloat(document.getElementById('twTax').value) || 0;
            const txDate = document.getElementById('twDate').value;
            const note = document.getElementById('twNote').value.trim();
            const txType = document.getElementById('twTxType').value;
            
            if (!symbol) { showToast('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Á¢º'); return; }
            if (!name) { showToast('Ë´ãÁ≠âÂæÖËÇ°Á•®ÂêçÁ®±ËºâÂÖ•'); return; }
            if (quantity <= 0) { showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÊï∏Èáè'); return; }
            if (!price || price <= 0) { showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÂÉπÊ†º'); return; }
            if (!txDate) { showToast('Ë´ãÈÅ∏Êìá‰∫§ÊòìÊó•Êúü'); return; }
            
            const payload = {
                symbol: symbol.includes('.') ? symbol : `${symbol}.TW`,
                name,
                market: 'tw',
                transaction_type: txType,
                quantity,
                price,
                fee,
                tax,
                transaction_date: txDate,
                note: note || null,
            };
            
            try {
                let res;
                if (id) {
                    res = await apiRequest(`/api/portfolio/transactions/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                } else {
                    res = await apiRequest('/api/portfolio/transactions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                }
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(id ? '‰∫§ÊòìÂ∑≤Êõ¥Êñ∞' : '‰∫§ÊòìÂ∑≤Êñ∞Â¢û');
                    closeTwModal();
                    loadPortfolio();
                    if (currentPortfolioTab === 'tw-transactions') loadTransactions('tw');
                } else {
                    showToast(data.detail || 'Êìç‰ΩúÂ§±Êïó');
                }
            } catch (e) {
                console.error('Âè∞ËÇ°‰∫§ÊòìÊìç‰ΩúÂ§±Êïó:', e);
                showToast('Êìç‰ΩúÂ§±Êïó');
            }
        }
        
        async function editTwTransaction(id) {
            try {
                const res = await apiRequest(`/api/portfolio/transactions/${id}`);
                const data = await res.json();
                
                if (data.success) {
                    const t = data.data;
                    document.getElementById('twEditId').value = t.id;
                    document.getElementById('twModalTitle').textContent = 'Á∑®ËºØÂè∞ËÇ°‰∫§Êòì';
                    setTwType(t.transaction_type);
                    
                    const symbol = t.symbol.replace('.TW', '').replace('.TWO', '');
                    document.getElementById('twSymbol').value = symbol;
                    document.getElementById('twName').value = t.name || '';
                    document.getElementById('twNameDisplay').innerHTML = t.name ? `<span class="text-gray-800">${t.name}</span>` : '<span class="text-gray-400">--</span>';
                    
                    const lots = Math.floor(t.quantity / 1000);
                    const oddLot = t.quantity % 1000;
                    document.getElementById('twLots').value = lots || '';
                    document.getElementById('twOddLot').value = oddLot || '';
                    updateTwQuantity();
                    
                    document.getElementById('twPrice').value = t.price;
                    document.getElementById('twFee').value = t.fee || '';
                    document.getElementById('twTax').value = t.tax || '';
                    document.getElementById('twDate').value = t.transaction_date;
                    document.getElementById('twNote').value = t.note || '';
                    
                    document.getElementById('twTransactionModal').classList.remove('hidden');
                    document.getElementById('twTransactionModal').classList.add('flex');
                }
            } catch (e) {
                console.error('ËºâÂÖ•‰∫§ÊòìÂ§±Êïó:', e);
                showToast('ËºâÂÖ•Â§±Êïó');
            }
        }
        
        // ===== ÁæéËÇ° Modal =====
        function showAddUsModal() {
            document.getElementById('usEditId').value = '';
            document.getElementById('usModalTitle').textContent = 'Êñ∞Â¢ûÁæéËÇ°‰∫§Êòì';
            setUsType('buy');
            document.getElementById('usSymbol').value = '';
            document.getElementById('usName').value = '';
            document.getElementById('usNameDisplay').innerHTML = '<span class="text-gray-400">Ëº∏ÂÖ•‰ª£Á¢ºËá™ÂãïÂ∏∂ÂÖ•</span>';
            document.getElementById('usQuantity').value = '';
            document.getElementById('usPrice').value = '';
            document.getElementById('usFee').value = '';
            document.getElementById('usTax').value = '';
            document.getElementById('usDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('usNote').value = '';
            
            document.getElementById('usTransactionModal').classList.remove('hidden');
            document.getElementById('usTransactionModal').classList.add('flex');
        }
        
        function closeUsModal() {
            document.getElementById('usTransactionModal').classList.add('hidden');
            document.getElementById('usTransactionModal').classList.remove('flex');
        }
        
        function setUsType(type) {
            document.getElementById('usTxType').value = type;
            if (type === 'buy') {
                document.getElementById('usBtnBuy').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-green-500 text-white';
                document.getElementById('usBtnSell').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600';
                document.getElementById('usTaxField').classList.add('opacity-50');
            } else {
                document.getElementById('usBtnBuy').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600';
                document.getElementById('usBtnSell').className = 'flex-1 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
                document.getElementById('usTaxField').classList.remove('opacity-50');
            }
        }
        
        function lookupUsStock() {
            clearTimeout(usLookupTimer);
            const symbol = document.getElementById('usSymbol').value.trim().toUpperCase();
            
            if (!symbol || symbol.length < 1) {
                document.getElementById('usNameDisplay').innerHTML = '<span class="text-gray-400">Ëº∏ÂÖ•‰ª£Á¢ºËá™ÂãïÂ∏∂ÂÖ•</span>';
                document.getElementById('usName').value = '';
                return;
            }
            
            document.getElementById('usNameDisplay').innerHTML = '<span class="text-gray-400"><i class="fas fa-spinner fa-spin mr-1"></i>Êü•Ë©¢‰∏≠...</span>';
            
            usLookupTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/stock/${symbol}`);
                    const data = await res.json();
                    
                    if (data.success && data.stock?.name) {
                        document.getElementById('usName').value = data.stock.name;
                        document.getElementById('usNameDisplay').innerHTML = `<span class="text-gray-800">${data.stock.name}</span>`;
                    } else {
                        document.getElementById('usName').value = '';
                        document.getElementById('usNameDisplay').innerHTML = '<span class="text-red-500">Êü•ÁÑ°Ê≠§ËÇ°Á•®</span>';
                    }
                } catch (e) {
                    console.error('Êü•Ë©¢ÁæéËÇ°Â§±Êïó:', e);
                    document.getElementById('usNameDisplay').innerHTML = '<span class="text-red-500">Êü•Ë©¢Â§±Êïó</span>';
                }
            }, 500);
        }
        
        async function submitUsTransaction() {
            const id = document.getElementById('usEditId').value;
            const symbol = document.getElementById('usSymbol').value.trim().toUpperCase();
            const name = document.getElementById('usName').value.trim();
            const quantity = parseInt(document.getElementById('usQuantity').value);
            const price = parseFloat(document.getElementById('usPrice').value);
            const fee = parseFloat(document.getElementById('usFee').value) || 0;
            const tax = parseFloat(document.getElementById('usTax').value) || 0;
            const txDate = document.getElementById('usDate').value;
            const note = document.getElementById('usNote').value.trim();
            const txType = document.getElementById('usTxType').value;
            
            if (!symbol) { showToast('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Á¢º'); return; }
            if (!name) { showToast('Ë´ãÁ≠âÂæÖËÇ°Á•®ÂêçÁ®±ËºâÂÖ•'); return; }
            if (!quantity || quantity <= 0) { showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàËÇ°Êï∏'); return; }
            if (!price || price <= 0) { showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÂÉπÊ†º'); return; }
            if (!txDate) { showToast('Ë´ãÈÅ∏Êìá‰∫§ÊòìÊó•Êúü'); return; }
            
            const payload = {
                symbol,
                name,
                market: 'us',
                transaction_type: txType,
                quantity,
                price,
                fee,
                tax,
                transaction_date: txDate,
                note: note || null,
            };
            
            try {
                let res;
                if (id) {
                    res = await apiRequest(`/api/portfolio/transactions/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                } else {
                    res = await apiRequest('/api/portfolio/transactions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                }
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(id ? '‰∫§ÊòìÂ∑≤Êõ¥Êñ∞' : '‰∫§ÊòìÂ∑≤Êñ∞Â¢û');
                    closeUsModal();
                    loadPortfolio();
                    if (currentPortfolioTab === 'us-transactions') loadTransactions('us');
                } else {
                    showToast(data.detail || 'Êìç‰ΩúÂ§±Êïó');
                }
            } catch (e) {
                console.error('ÁæéËÇ°‰∫§ÊòìÊìç‰ΩúÂ§±Êïó:', e);
                showToast('Êìç‰ΩúÂ§±Êïó');
            }
        }
        
        async function editUsTransaction(id) {
            try {
                const res = await apiRequest(`/api/portfolio/transactions/${id}`);
                const data = await res.json();
                
                if (data.success) {
                    const t = data.data;
                    document.getElementById('usEditId').value = t.id;
                    document.getElementById('usModalTitle').textContent = 'Á∑®ËºØÁæéËÇ°‰∫§Êòì';
                    setUsType(t.transaction_type);
                    
                    document.getElementById('usSymbol').value = t.symbol;
                    document.getElementById('usName').value = t.name || '';
                    document.getElementById('usNameDisplay').innerHTML = t.name ? `<span class="text-gray-800">${t.name}</span>` : '<span class="text-gray-400">--</span>';
                    document.getElementById('usQuantity').value = t.quantity;
                    document.getElementById('usPrice').value = t.price;
                    document.getElementById('usFee').value = t.fee || '';
                    document.getElementById('usTax').value = t.tax || '';
                    document.getElementById('usDate').value = t.transaction_date;
                    document.getElementById('usNote').value = t.note || '';
                    
                    document.getElementById('usTransactionModal').classList.remove('hidden');
                    document.getElementById('usTransactionModal').classList.add('flex');
                }
            } catch (e) {
                console.error('ËºâÂÖ•‰∫§ÊòìÂ§±Êïó:', e);
                showToast('ËºâÂÖ•Â§±Êïó');
            }
        }
        
        // ===== ÂÖ±Áî® =====
        async function deleteTransaction(id, market) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§‰∫§ÊòìÁ¥ÄÈåÑÔºü')) return;
            
            try {
                const res = await apiRequest(`/api/portfolio/transactions/${id}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('‰∫§ÊòìÂ∑≤Âà™Èô§');
                    loadPortfolio();
                    if (currentPortfolioTab === 'tw-transactions' || currentPortfolioTab === 'us-transactions') {
                        loadTransactions(market);
                    }
                } else {
                    showToast(data.detail || 'Âà™Èô§Â§±Êïó');
                }
            } catch (e) {
                console.error('Âà™Èô§‰∫§ÊòìÂ§±Êïó:', e);
                showToast('Âà™Èô§Â§±Êïó');
            }
        }
        
        function quickTrade(symbol, name, market, type) {
            if (market === 'tw') {
                showAddTwModal();
                setTwType(type);
                const cleanSymbol = symbol.replace('.TW', '').replace('.TWO', '');
                document.getElementById('twSymbol').value = cleanSymbol;
                document.getElementById('twName').value = name;
                document.getElementById('twNameDisplay').innerHTML = name ? `<span class="text-gray-800">${name}</span>` : '<span class="text-gray-400">--</span>';
            } else {
                showAddUsModal();
                setUsType(type);
                document.getElementById('usSymbol').value = symbol;
                document.getElementById('usName').value = name;
                document.getElementById('usNameDisplay').innerHTML = name ? `<span class="text-gray-800">${name}</span>` : '<span class="text-gray-400">--</span>';
            }
        }

        // ========== Toast ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }


        // ========== Ë®ÇÈñ±Á≤æÈÅ∏ÂäüËÉΩ ==========
        let subscriptionSources = [];
        let subscribedSourceIds = [];
        
        async function loadSubscriptionData() {
            await loadSubscriptionSources();
            await loadSubscriptionPicks();
        }
        
        async function loadSubscriptionSources() {
            const container = document.getElementById('subscriptionSourcesList');
            
            try {
                // ËºâÂÖ•ÊâÄÊúâË®ÇÈñ±Ê∫ê
                const sourcesRes = await fetch(`${API_BASE}/api/subscription/sources`);
                const sourcesData = await sourcesRes.json();
                
                if (!sourcesData.success) {
                    container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
                    return;
                }
                
                subscriptionSources = sourcesData.data || [];
                
                // ËºâÂÖ•ÊàëÁöÑË®ÇÈñ±
                const myRes = await apiRequest('/api/subscription/my');
                const myData = await myRes.json();
                subscribedSourceIds = myData.success ? (myData.data || []).map(s => s.id) : [];
                
                if (subscriptionSources.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Â∞öÁÑ°Ë®ÇÈñ±‰æÜÊ∫ê</p>';
                    return;
                }
                
                let html = '<div class="space-y-3">';
                for (const source of subscriptionSources) {
                    const isSubscribed = subscribedSourceIds.includes(source.id);
                    const btnClass = isSubscribed 
                        ? 'bg-green-500 text-white' 
                        : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                    const btnText = isSubscribed ? 'Â∑≤Ë®ÇÈñ±' : 'Ë®ÇÈñ±';
                    const btnIcon = isSubscribed ? 'fa-check' : 'fa-plus';
                    
                    html += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-800">${source.name}</span>
                                    <span class="ml-2 px-2 py-0.5 rounded text-xs bg-orange-100 text-orange-700">
                                        ${source.picks_count || 0} Ê™î
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 truncate">${source.description || ''}</p>
                            </div>
                            <button onclick="toggleSubscription(${source.id}, ${isSubscribed})" 
                                    class="ml-3 px-4 py-2 rounded-lg text-sm font-medium transition-all ${btnClass}">
                                <i class="fas ${btnIcon} mr-1"></i>${btnText}
                            </button>
                        </div>
                    `;
                }
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('ËºâÂÖ•Ë®ÇÈñ±‰æÜÊ∫êÂ§±Êïó:', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
            }
        }
        
        async function toggleSubscription(sourceId, isCurrentlySubscribed) {
            try {
                const endpoint = isCurrentlySubscribed 
                    ? `/api/subscription/unsubscribe/${sourceId}`
                    : `/api/subscription/subscribe/${sourceId}`;
                const method = isCurrentlySubscribed ? 'DELETE' : 'POST';
                
                const res = await apiRequest(endpoint, { method });
                const data = await res.json();
                
                if (data.success) {
                    showToast(isCurrentlySubscribed ? 'Â∑≤ÂèñÊ∂àË®ÇÈñ±' : 'Ë®ÇÈñ±ÊàêÂäüÔºÅ');
                    await loadSubscriptionSources();
                    await loadSubscriptionPicks();
                } else {
                    showToast(data.detail || 'Êìç‰ΩúÂ§±Êïó');
                }
            } catch (e) {
                console.error('Ë®ÇÈñ±Êìç‰ΩúÂ§±Êïó:', e);
                showToast('Êìç‰ΩúÂ§±Êïó');
            }
        }
        
        async function loadSubscriptionPicks() {
            const container = document.getElementById('subscriptionPicksList');
            const countEl = document.getElementById('subscriptionPicksCount');
            
            try {
                const res = await apiRequest('/api/subscription/picks');
                const data = await res.json();
                
                if (!data.success) {
                    container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
                    return;
                }
                
                const picks = data.data || [];
                
                if (picks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">Â∞öÁÑ°Á≤æÈÅ∏ËÇ°Á•®</p>
                            <p class="text-gray-400 text-sm mt-1">Ë´ãÂÖàË®ÇÈñ±‰∏äÊñπÁöÑË®ÇÈñ±‰æÜÊ∫ê</p>
                        </div>
                    `;
                    countEl.textContent = '';
                    return;
                }
                
                countEl.textContent = `ÂÖ± ${picks.length} Ê™î`;
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
                for (const pick of picks) {
                    html += renderPickCard(pick);
                }
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('ËºâÂÖ•Á≤æÈÅ∏ËÇ°Á•®Â§±Êïó:', e);
                container.innerHTML = '<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó</p>';
            }
        }
        
        function renderPickCard(pick) {
            const change = pick.change_pct || 0;
            const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
            const changeIcon = change >= 0 ? '‚ñ≤' : '‚ñº';
            const priceText = pick.price ? `$${pick.price.toLocaleString()}` : '--';
            
            const mentionBadge = pick.mention_count > 1 
                ? `<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-700">
                     <i class="fas fa-fire mr-1"></i>${pick.mention_count}Ê¨°ÊèêÂèä
                   </span>` 
                : '';
            
            const sourceBadge = pick.source_name 
                ? `<span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">${pick.source_name}</span>` 
                : '';
            
            return `
                <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-all"
                     onclick="searchSymbol('${pick.symbol}')">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center flex-wrap">
                            <span class="font-bold text-lg text-gray-800">${pick.symbol}</span>
                            ${mentionBadge}
                        </div>
                        ${sourceBadge}
                    </div>
                    <div class="flex items-baseline justify-between">
                        <span class="text-xl font-semibold text-gray-800">${priceText}</span>
                        <span class="${changeClass} text-sm font-medium">
                            ${changeIcon} ${Math.abs(change).toFixed(2)}%
                        </span>
                    </div>
                    <div class="mt-2 text-xs text-gray-400">
                        ÊúÄÂæåÊèêÂèä: ${pick.last_seen_at ? new Date(pick.last_seen_at).toLocaleDateString() : '--'}
                    </div>
                </div>
            `;
        }
        
        async function refreshSubscriptionPicks() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            
            await loadSubscriptionPicks();
            
            setTimeout(() => icon.classList.remove('fa-spin'), 500);
            showToast('Â∑≤Êõ¥Êñ∞');
        }

        // ========== üÜï ËøΩËπ§Ê∏ÖÂñÆÂåØÂá∫ÂåØÂÖ• ==========
        function toggleWatchlistMenu() {
            const menu = document.getElementById('watchlistMenu');
            menu.classList.toggle('hidden');
            // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÈóúÈñâ
            setTimeout(() => {
                document.addEventListener('click', closeWatchlistMenu, { once: true });
            }, 0);
        }
        
        function closeWatchlistMenu(e) {
            const menu = document.getElementById('watchlistMenu');
            if (!menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        }
        
        async function exportWatchlist(format) {
            document.getElementById('watchlistMenu').classList.add('hidden');
            
            try {
                const res = await apiRequest(`/api/watchlist/export?format=${format}`);
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'ÂåØÂá∫Â§±Êïó');
                }
                
                // ‰∏ãËºâÊ™îÊ°à
                const blob = await res.blob();
                const filename = res.headers.get('Content-Disposition')?.split('filename=')[1] || `watchlist.${format}`;
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                
                showToast('ÂåØÂá∫ÊàêÂäüÔºÅ');
            } catch (e) {
                console.error('ÂåØÂá∫Â§±Êïó:', e);
                showToast(e.message || 'ÂåØÂá∫Â§±Êïó');
            }
        }
        
        function showImportWatchlistModal() {
            document.getElementById('watchlistMenu').classList.add('hidden');
            document.getElementById('importWatchlistModal').classList.remove('hidden');
            document.getElementById('importWatchlistModal').classList.add('flex');
        }
        
        function hideImportWatchlistModal() {
            document.getElementById('importWatchlistModal').classList.add('hidden');
            document.getElementById('importWatchlistModal').classList.remove('flex');
            document.getElementById('importWatchlistFile').value = '';
            document.getElementById('importWatchlistPreview').innerHTML = '';
        }
        
        function previewWatchlistFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const preview = document.getElementById('importWatchlistPreview');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let items = [];
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        items = data.items || data;
                    } else if (file.name.endsWith('.csv')) {
                        const lines = content.split('\n').filter(l => l.trim());
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            const obj = {};
                            headers.forEach((h, idx) => obj[h] = values[idx]?.trim());
                            if (obj.symbol) items.push(obj);
                        }
                    }
                    
                    preview.innerHTML = `
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-green-700 font-medium"><i class="fas fa-check-circle mr-2"></i>ÊâæÂà∞ ${items.length} Á≠ÜË≥áÊñô</p>
                            <p class="text-sm text-gray-600 mt-1">‰ª£Ëôü: ${items.slice(0, 5).map(i => i.symbol).join(', ')}${items.length > 5 ? '...' : ''}</p>
                        </div>
                    `;
                    preview.dataset.items = JSON.stringify(items);
                } catch (err) {
                    preview.innerHTML = `<p class="text-red-500"><i class="fas fa-times-circle mr-2"></i>Ê™îÊ°àËß£ÊûêÂ§±Êïó: ${err.message}</p>`;
                }
            };
            
            reader.readAsText(file);
        }
        
        async function importWatchlist() {
            const preview = document.getElementById('importWatchlistPreview');
            const itemsStr = preview.dataset.items;
            
            if (!itemsStr) {
                showToast('Ë´ãÂÖàÈÅ∏ÊìáÊ™îÊ°à');
                return;
            }
            
            try {
                const items = JSON.parse(itemsStr);
                
                const res = await apiRequest('/api/watchlist/import', {
                    method: 'POST',
                    body: { items }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(data.message);
                    hideImportWatchlistModal();
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast(data.detail || 'ÂåØÂÖ•Â§±Êïó');
                }
            } catch (e) {
                console.error('ÂåØÂÖ•Â§±Êïó:', e);
                showToast('ÂåØÂÖ•Â§±Êïó');
            }
        }

        // ========== üÜï ÊåÅËÇ°‰∫§ÊòìÂåØÂá∫ÂåØÂÖ• ==========
        function togglePortfolioMenu() {
            const menu = document.getElementById('portfolioMenu');
            menu.classList.toggle('hidden');
            setTimeout(() => {
                document.addEventListener('click', closePortfolioMenu, { once: true });
            }, 0);
        }
        
        function closePortfolioMenu(e) {
            const menu = document.getElementById('portfolioMenu');
            if (!menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        }
        
        async function exportPortfolio(format, market) {
            document.getElementById('portfolioMenu').classList.add('hidden');
            
            try {
                let url = `/api/portfolio/export?format=${format}`;
                if (market) url += `&market=${market}`;
                
                const res = await apiRequest(url);
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'ÂåØÂá∫Â§±Êïó');
                }
                
                const blob = await res.blob();
                const filename = res.headers.get('Content-Disposition')?.split('filename=')[1] || `portfolio.${format}`;
                
                const dlUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = dlUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(dlUrl);
                
                showToast('ÂåØÂá∫ÊàêÂäüÔºÅ');
            } catch (e) {
                console.error('ÂåØÂá∫Â§±Êïó:', e);
                showToast(e.message || 'ÂåØÂá∫Â§±Êïó');
            }
        }
        
        function showImportPortfolioModal() {
            document.getElementById('portfolioMenu').classList.add('hidden');
            document.getElementById('importPortfolioModal').classList.remove('hidden');
            document.getElementById('importPortfolioModal').classList.add('flex');
        }
        
        function hideImportPortfolioModal() {
            document.getElementById('importPortfolioModal').classList.add('hidden');
            document.getElementById('importPortfolioModal').classList.remove('flex');
            document.getElementById('importPortfolioFile').value = '';
            document.getElementById('importPortfolioPreview').innerHTML = '';
        }
        
        function previewPortfolioFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const preview = document.getElementById('importPortfolioPreview');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let items = [];
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        items = data.items || data;
                    } else if (file.name.endsWith('.csv')) {
                        const lines = content.split('\n').filter(l => l.trim());
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            const obj = {};
                            headers.forEach((h, idx) => obj[h] = values[idx]?.trim());
                            if (obj.symbol && obj.quantity && obj.price) items.push(obj);
                        }
                    }
                    
                    preview.innerHTML = `
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-green-700 font-medium"><i class="fas fa-check-circle mr-2"></i>ÊâæÂà∞ ${items.length} Á≠Ü‰∫§ÊòìÁ¥ÄÈåÑ</p>
                            <p class="text-sm text-gray-600 mt-1">ÂâçÂπæÁ≠Ü: ${items.slice(0, 3).map(i => `${i.symbol} ${i.transaction_type || 'buy'} ${i.quantity}ËÇ°`).join(', ')}${items.length > 3 ? '...' : ''}</p>
                        </div>
                    `;
                    preview.dataset.items = JSON.stringify(items);
                } catch (err) {
                    preview.innerHTML = `<p class="text-red-500"><i class="fas fa-times-circle mr-2"></i>Ê™îÊ°àËß£ÊûêÂ§±Êïó: ${err.message}</p>`;
                }
            };
            
            reader.readAsText(file);
        }
        
        async function importPortfolio() {
            const preview = document.getElementById('importPortfolioPreview');
            const itemsStr = preview.dataset.items;
            
            if (!itemsStr) {
                showToast('Ë´ãÂÖàÈÅ∏ÊìáÊ™îÊ°à');
                return;
            }
            
            try {
                const items = JSON.parse(itemsStr);
                
                const res = await apiRequest('/api/portfolio/import', {
                    method: 'POST',
                    body: { items }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(data.message);
                    hideImportPortfolioModal();
                    loadPortfolio();
                } else {
                    showToast(data.detail || 'ÂåØÂÖ•Â§±Êïó');
                }
            } catch (e) {
                console.error('ÂåØÂÖ•Â§±Êïó:', e);
                showToast('ÂåØÂÖ•Â§±Êïó');
            }
        }

        // ========== üÜï ÁõÆÊ®ôÂÉπË®≠ÂÆö ==========
        let currentTargetItemId = null;
        
        function showTargetPriceModal(itemId, symbol, currentTarget) {
            currentTargetItemId = itemId;
            document.getElementById('targetPriceSymbol').textContent = symbol;
            document.getElementById('targetPriceInput').value = currentTarget || '';
            document.getElementById('targetPriceModal').classList.remove('hidden');
            document.getElementById('targetPriceModal').classList.add('flex');
            document.getElementById('targetPriceInput').focus();
        }
        
        function hideTargetPriceModal() {
            document.getElementById('targetPriceModal').classList.add('hidden');
            document.getElementById('targetPriceModal').classList.remove('flex');
            currentTargetItemId = null;
        }
        
        async function saveTargetPrice() {
            if (!currentTargetItemId) return;
            
            const input = document.getElementById('targetPriceInput');
            const targetPrice = input.value ? parseFloat(input.value) : null;
            
            try {
                const res = await apiRequest(`/api/watchlist/${currentTargetItemId}/target-price`, {
                    method: 'PUT',
                    body: { target_price: targetPrice }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(data.message);
                    hideTargetPriceModal();
                    loadWatchlist();
                } else {
                    showToast(data.detail || 'Ë®≠ÂÆöÂ§±Êïó');
                }
            } catch (e) {
                console.error('Ë®≠ÂÆöÁõÆÊ®ôÂÉπÂ§±Êïó:', e);
                showToast('Ë®≠ÂÆöÂ§±Êïó');
            }
        }
        
        async function clearTargetPrice() {
            if (!currentTargetItemId) return;
            
            document.getElementById('targetPriceInput').value = '';
            await saveTargetPrice();
        }

        // ========== ÂàùÂßãÂåñ ==========
        document.addEventListener('DOMContentLoaded', checkAuth);
        
        // Áõ£ËÅΩË¶ñÁ™óÂ§ßÂ∞èËÆäÂåñ
        window.addEventListener('resize', () => {
            deviceInfo.isMobile = window.innerWidth < 768;
        });
    </script>
</body>
</html>
