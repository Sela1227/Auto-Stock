<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar { transition: transform 0.3s ease; }
        .score-badge { min-width: 2rem; }
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .brand-orange { background-color: #FA7A35; }
        .brand-text { color: #FA7A35; }
        .brand-border { border-color: #FA7A35; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="bg-white shadow-sm border-b fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="brand-orange text-white font-bold px-2 py-1 rounded mr-2">SELA</div>
                    <span class="font-bold text-xl text-gray-800">è‡ªå‹•é¸è‚¡ç³»çµ±</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-gray-600"></span>
                    <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="">
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <div class="pt-16 flex">
        <!-- å´é‚Šæ¬„ -->
        <aside class="w-64 bg-white shadow-sm min-h-screen fixed">
            <nav class="p-4 space-y-2">
                <a href="#" onclick="showSection('dashboard')" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-blue-50 rounded-lg">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>å„€è¡¨æ¿</span>
                </a>
                <a href="#" onclick="showSection('search')" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-search mr-3"></i>
                    <span>è‚¡ç¥¨æŸ¥è©¢</span>
                </a>
                <a href="#" onclick="showSection('watchlist')" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-star mr-3"></i>
                    <span>è¿½è¹¤æ¸…å–®</span>
                </a>
                <a href="#" onclick="showSection('sentiment')" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-heart-pulse mr-3"></i>
                    <span>å¸‚å ´æƒ…ç·’</span>
                </a>
                <a href="#" onclick="showSection('settings')" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-cog mr-3"></i>
                    <span>è¨­å®š</span>
                </a>
            </nav>
        </aside>

        <!-- ä¸»å€åŸŸ -->
        <main class="ml-64 flex-1 p-6">
            <!-- å„€è¡¨æ¿å€å¡Š -->
            <section id="section-dashboard" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">å„€è¡¨æ¿</h2>
                
                <!-- å¸‚å ´æƒ…ç·’å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">ç¾è‚¡æƒ…ç·’æŒ‡æ•¸</h3>
                            <span id="stockSentimentBadge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                        </div>
                        <div class="flex items-center">
                            <span id="stockSentimentValue" class="text-4xl font-bold text-gray-800">--</span>
                            <span class="text-gray-500 ml-2">/ 100</span>
                        </div>
                        <div class="mt-4 bg-gray-200 rounded-full h-3">
                            <div id="stockSentimentBar" class="h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">å¹£åœˆæƒ…ç·’æŒ‡æ•¸</h3>
                            <span id="cryptoSentimentBadge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                        </div>
                        <div class="flex items-center">
                            <span id="cryptoSentimentValue" class="text-4xl font-bold text-gray-800">--</span>
                            <span class="text-gray-500 ml-2">/ 100</span>
                        </div>
                        <div class="mt-4 bg-gray-200 rounded-full h-3">
                            <div id="cryptoSentimentBar" class="h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- è¿½è¹¤æ¸…å–®ç¸½è¦½ -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">è¿½è¹¤æ¸…å–®ç¸½è¦½</h3>
                        <button onclick="loadWatchlistOverview()" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="watchlistOverview" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </section>

            <!-- è‚¡ç¥¨æŸ¥è©¢å€å¡Š -->
            <section id="section-search" class="section hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">è‚¡ç¥¨æŸ¥è©¢</h2>
                
                <!-- æœå°‹æ¬„ -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <input type="text" id="searchSymbol" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ˆå¦‚ AAPLã€TSLAï¼‰æˆ–åŠ å¯†è²¨å¹£ï¼ˆBTCã€ETHï¼‰" 
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onkeypress="if(event.key==='Enter') searchStock()">
                        </div>
                        <button onclick="searchStock()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-search mr-2"></i>æŸ¥è©¢
                        </button>
                    </div>
                    <p class="text-gray-500 text-sm mt-2">æ”¯æ´ç¾è‚¡ä»£è™Ÿå’ŒåŠ å¯†è²¨å¹£ï¼ˆBTCã€ETHï¼‰</p>
                </div>

                <!-- æŸ¥è©¢çµæœ -->
                <div id="searchResult" class="hidden">
                    <!-- æœƒå‹•æ…‹å¡«å…… -->
                </div>
            </section>

            <!-- è¿½è¹¤æ¸…å–®å€å¡Š -->
            <section id="section-watchlist" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">è¿½è¹¤æ¸…å–®</h2>
                    <button onclick="showAddWatchlistModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>æ–°å¢
                    </button>
                </div>
                
                <div id="watchlistContent" class="bg-white rounded-xl shadow">
                    <p class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</p>
                </div>
            </section>

            <!-- å¸‚å ´æƒ…ç·’å€å¡Š -->
            <section id="section-sentiment" class="section hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">å¸‚å ´æƒ…ç·’</h2>
                <div id="sentimentDetail" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- å‹•æ…‹å¡«å…… -->
                </div>
            </section>

            <!-- è¨­å®šå€å¡Š -->
            <section id="section-settings" class="section hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">è¨­å®š</h2>
                
                <!-- æŒ‡æ¨™é¡¯ç¤ºè¨­å®š -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-4">æŒ‡æ¨™é¡¯ç¤ºè¨­å®š</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="indicatorSettings">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                </div>

                <!-- é€šçŸ¥è¨­å®š -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-4">é€šçŸ¥è¨­å®š</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="alertSettings">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                </div>

                <!-- å¿«é€Ÿæ¨¡æ¿ -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="font-semibold text-gray-700 mb-4">å¿«é€Ÿå¥—ç”¨æ¨¡æ¿</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="applyTemplate('minimal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">æ¥µç°¡æ¨¡å¼</button>
                        <button onclick="applyTemplate('standard')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">æ¨™æº–æ¨¡å¼</button>
                        <button onclick="applyTemplate('full')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">å®Œæ•´æ¨¡å¼</button>
                        <button onclick="applyTemplate('short_term')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">çŸ­ç·šæ¨¡å¼</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- æ–°å¢è¿½è¹¤ Modal -->
    <div id="addWatchlistModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">æ–°å¢è¿½è¹¤</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">è‚¡ç¥¨/åŠ å¯†è²¨å¹£ä»£è™Ÿ</label>
                    <input type="text" id="addSymbol" placeholder="å¦‚ AAPLã€BTC" 
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                    <input type="text" id="addNote" placeholder="è‡ªè¨‚å‚™è¨»" 
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideAddWatchlistModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
                <button onclick="addToWatchlist()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity">
        <span id="toastMessage"></span>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            if (!token) {
                window.location.href = '/static/index.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error('Unauthorized');
                
                currentUser = await res.json();
                document.getElementById('userName').textContent = currentUser.display_name;
                document.getElementById('userAvatar').src = currentUser.picture_url || 'https://via.placeholder.com/40';
                
                // è¼‰å…¥è³‡æ–™
                loadDashboard();
            } catch (e) {
                localStorage.removeItem('token');
                window.location.href = '/static/index.html';
            }
        }

        // ç™»å‡º
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/index.html';
        }

        // åˆ‡æ›å€å¡Š
        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('bg-blue-50', 'text-gray-700');
                l.classList.add('text-gray-600');
            });
            event.target.closest('.nav-link').classList.add('bg-blue-50', 'text-gray-700');
            event.target.closest('.nav-link').classList.remove('text-gray-600');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (name === 'watchlist') loadWatchlist();
            if (name === 'sentiment') loadSentimentDetail();
            if (name === 'settings') loadSettings();
        }

        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            await loadSentiment();
            await loadWatchlistOverview();
        }

        // è¼‰å…¥å¸‚å ´æƒ…ç·’
        async function loadSentiment() {
            try {
                const res = await fetch(`${API_BASE}/api/market/sentiment`);
                const data = await res.json();
                
                if (data.success) {
                    updateSentimentCard('stock', data.data.stock);
                    updateSentimentCard('crypto', data.data.crypto);
                }
            } catch (e) {
                console.error('è¼‰å…¥æƒ…ç·’å¤±æ•—', e);
            }
        }

        function updateSentimentCard(type, sentiment) {
            if (!sentiment) return;
            
            const value = sentiment.value;
            const classification = sentiment.classification;
            
            document.getElementById(`${type}SentimentValue`).textContent = value;
            document.getElementById(`${type}SentimentBar`).style.width = `${value}%`;
            
            const badge = document.getElementById(`${type}SentimentBadge`);
            const bar = document.getElementById(`${type}SentimentBar`);
            
            let badgeClass, barClass, label;
            if (value <= 25) {
                badgeClass = 'bg-red-100 text-red-700';
                barClass = 'bg-red-500';
                label = 'æ¥µåº¦ææ‡¼';
            } else if (value <= 45) {
                badgeClass = 'bg-orange-100 text-orange-700';
                barClass = 'bg-orange-500';
                label = 'ææ‡¼';
            } else if (value <= 55) {
                badgeClass = 'bg-gray-100 text-gray-700';
                barClass = 'bg-gray-500';
                label = 'ä¸­æ€§';
            } else if (value <= 75) {
                badgeClass = 'bg-green-100 text-green-700';
                barClass = 'bg-green-500';
                label = 'è²ªå©ª';
            } else {
                badgeClass = 'bg-emerald-100 text-emerald-700';
                barClass = 'bg-emerald-500';
                label = 'æ¥µåº¦è²ªå©ª';
            }
            
            badge.className = `px-3 py-1 rounded-full text-sm font-medium ${badgeClass}`;
            badge.textContent = label;
            bar.className = `h-3 rounded-full transition-all ${barClass}`;
        }

        // è¼‰å…¥è¿½è¹¤æ¸…å–®ç¸½è¦½
        async function loadWatchlistOverview() {
            const container = document.getElementById('watchlistOverview');
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-star text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">å°šç„¡è¿½è¹¤æ¸…å–®</p>
                            <button onclick="showSection('search'); document.getElementById('searchSymbol').focus();" 
                                class="mt-3 text-blue-600 hover:text-blue-800">
                                å‰å¾€æŸ¥è©¢è‚¡ç¥¨
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="divide-y">';
                for (const item of data.data) {
                    html += `
                        <div class="flex items-center justify-between py-3 hover:bg-gray-50 px-2 rounded cursor-pointer"
                            onclick="searchSymbol('${item.symbol}')">
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-800 w-20">${item.symbol}</span>
                                <span class="text-sm px-2 py-0.5 rounded ${item.asset_type === 'crypto' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">
                                    ${item.asset_type === 'crypto' ? 'åŠ å¯†è²¨å¹£' : 'è‚¡ç¥¨'}
                                </span>
                                ${item.note ? `<span class="text-gray-500 text-sm ml-3">${item.note}</span>` : ''}
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    `;
                }
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è‚¡ç¥¨æŸ¥è©¢
        async function searchStock() {
            const symbol = document.getElementById('searchSymbol').value.trim().toUpperCase();
            if (!symbol) {
                showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            searchSymbol(symbol);
        }

        async function searchSymbol(symbol) {
            const container = document.getElementById('searchResult');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="bg-white rounded-xl shadow p-6 text-center"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">æŸ¥è©¢ä¸­...</p></div>';
            
            // åˆ‡æ›åˆ°æœå°‹é 
            showSection('search');
            document.getElementById('searchSymbol').value = symbol;

            try {
                const isCrypto = ['BTC', 'ETH'].includes(symbol);
                const endpoint = isCrypto ? `/api/crypto/${symbol}` : `/api/stock/${symbol}`;
                
                const res = await fetch(`${API_BASE}${endpoint}`);
                const data = await res.json();
                
                if (!data.success) {
                    container.innerHTML = `<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">${data.detail || data.error?.message || 'æŸ¥è©¢å¤±æ•—'}</div>`;
                    return;
                }

                // è³‡æ–™ç›´æ¥åœ¨é ‚å±¤ï¼Œä¸åœ¨ data.data è£¡
                renderStockResult(data, isCrypto);
                
            } catch (e) {
                console.error('Search error:', e);
                container.innerHTML = '<div class="bg-white rounded-xl shadow p-6 text-center text-red-500">æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }

        function renderStockResult(stock, isCrypto) {
            const container = document.getElementById('searchResult');
            const indicators = stock.indicators || {};
            const ma = indicators.ma || {};
            const rsi = indicators.rsi || {};
            const macd = indicators.macd || {};
            
            let html = `
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${stock.symbol}</h3>
                            <p class="text-gray-500">${stock.name || (isCrypto ? 'åŠ å¯†è²¨å¹£' : 'è‚¡ç¥¨')}</p>
                        </div>
                        <button onclick="addToWatchlistDirect('${stock.symbol}')" class="px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">
                            <i class="fas fa-star mr-2"></i>åŠ å…¥è¿½è¹¤
                        </button>
                    </div>
                    
                    <!-- åƒ¹æ ¼è³‡è¨Š -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">ç¾åƒ¹</p>
                            <p class="text-2xl font-bold text-gray-800">$${formatNumber(stock.price?.current)}</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">æ—¥æ¼²è·Œ</p>
                            <p class="text-xl font-bold ${stock.change?.day >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${stock.change?.day >= 0 ? '+' : ''}${stock.change?.day?.toFixed(2) || '--'}%
                            </p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">é€±æ¼²è·Œ</p>
                            <p class="text-xl font-bold ${stock.change?.week >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${stock.change?.week >= 0 ? '+' : ''}${stock.change?.week?.toFixed(2) || '--'}%
                            </p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-500 text-sm">æœˆæ¼²è·Œ</p>
                            <p class="text-xl font-bold ${stock.change?.month >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${stock.change?.month >= 0 ? '+' : ''}${stock.change?.month?.toFixed(2) || '--'}%
                            </p>
                        </div>
                    </div>

                    <!-- æŠ€è¡“æŒ‡æ¨™ -->
                    <h4 class="font-semibold text-gray-700 mb-3">æŠ€è¡“æŒ‡æ¨™</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div class="border rounded-lg p-3">
                            <p class="text-gray-500 text-sm">å‡ç·šæ’åˆ—</p>
                            <p class="font-semibold ${ma.alignment === 'bullish' ? 'text-green-600' : ma.alignment === 'bearish' ? 'text-red-600' : 'text-gray-600'}">
                                ${ma.alignment === 'bullish' ? 'ğŸ“ˆ å¤šé ­æ’åˆ—' : ma.alignment === 'bearish' ? 'ğŸ“‰ ç©ºé ­æ’åˆ—' : 'â¡ï¸ ç›¤æ•´'}
                            </p>
                        </div>
                        <div class="border rounded-lg p-3">
                            <p class="text-gray-500 text-sm">RSI (${rsi.period || 14})</p>
                            <p class="font-semibold ${rsi.value > 70 ? 'text-red-600' : rsi.value < 30 ? 'text-green-600' : 'text-gray-600'}">
                                ${rsi.value?.toFixed(1) || '--'} 
                                <span class="text-sm">${rsi.status === 'overbought' ? 'è¶…è²·' : rsi.status === 'oversold' ? 'è¶…è³£' : 'ä¸­æ€§'}</span>
                            </p>
                        </div>
                        <div class="border rounded-lg p-3">
                            <p class="text-gray-500 text-sm">MACD</p>
                            <p class="font-semibold ${macd.status === 'bullish' ? 'text-green-600' : macd.status === 'bearish' ? 'text-red-600' : 'text-gray-600'}">
                                ${macd.status === 'bullish' ? 'ğŸ“ˆ å¤šæ–¹' : macd.status === 'bearish' ? 'ğŸ“‰ ç©ºæ–¹' : 'â¡ï¸ ä¸­æ€§'}
                            </p>
                        </div>
                    </div>

                    <!-- å‡ç·šè³‡è¨Š -->
                    <h4 class="font-semibold text-gray-700 mb-3">ç§»å‹•å¹³å‡ç·š</h4>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-3 rounded-lg ${ma.price_vs_ma20 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                            <p class="text-gray-500 text-sm">MA20</p>
                            <p class="font-semibold">${ma.ma20?.toFixed(2) || '--'}</p>
                            <p class="text-xs ${ma.price_vs_ma20 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                ${ma.price_vs_ma20 === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š' : 'åƒ¹æ ¼åœ¨ä¸‹'}
                            </p>
                        </div>
                        <div class="text-center p-3 rounded-lg ${ma.price_vs_ma50 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                            <p class="text-gray-500 text-sm">MA50</p>
                            <p class="font-semibold">${ma.ma50?.toFixed(2) || '--'}</p>
                            <p class="text-xs ${ma.price_vs_ma50 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                ${ma.price_vs_ma50 === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š' : 'åƒ¹æ ¼åœ¨ä¸‹'}
                            </p>
                        </div>
                        <div class="text-center p-3 rounded-lg ${ma.price_vs_ma200 === 'above' ? 'bg-green-50' : 'bg-red-50'}">
                            <p class="text-gray-500 text-sm">MA200</p>
                            <p class="font-semibold">${ma.ma200?.toFixed(2) || '--'}</p>
                            <p class="text-xs ${ma.price_vs_ma200 === 'above' ? 'text-green-600' : 'text-red-600'}">
                                ${ma.price_vs_ma200 === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š' : 'åƒ¹æ ¼åœ¨ä¸‹'}
                            </p>
                        </div>
                    </div>

                    <!-- ç¶œåˆè©•åˆ† -->
                    ${stock.score ? `
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">ç¶œåˆè©•åˆ†</p>
                                <p class="text-2xl font-bold">${stock.score.rating === 'bullish' ? 'åå¤š' : stock.score.rating === 'bearish' ? 'åç©º' : 'ä¸­æ€§'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-blue-100">è²·é€²è¨Šè™Ÿ: ${stock.score.buy || 0} | è³£å‡ºè¨Šè™Ÿ: ${stock.score.sell || 0}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // è¼‰å…¥è¿½è¹¤æ¸…å–®
        async function loadWatchlist() {
            const container = document.getElementById('watchlistContent');
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-star text-gray-300 text-5xl mb-4"></i>
                            <p class="text-gray-500 mb-4">å°šç„¡è¿½è¹¤çš„è‚¡ç¥¨</p>
                            <button onclick="showAddWatchlistModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>æ–°å¢è¿½è¹¤
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="divide-y">';
                for (const item of data.data) {
                    html += `
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50">
                            <div class="flex items-center cursor-pointer" onclick="searchSymbol('${item.symbol}')">
                                <span class="font-semibold text-gray-800 w-20">${item.symbol}</span>
                                <span class="text-sm px-2 py-0.5 rounded ${item.asset_type === 'crypto' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">
                                    ${item.asset_type === 'crypto' ? 'åŠ å¯†è²¨å¹£' : 'è‚¡ç¥¨'}
                                </span>
                                ${item.note ? `<span class="text-gray-500 text-sm ml-3">${item.note}</span>` : ''}
                            </div>
                            <button onclick="removeFromWatchlist('${item.symbol}')" class="text-red-500 hover:text-red-700 px-3 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = '<p class="text-red-500 text-center py-8">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // æ–°å¢/åˆªé™¤è¿½è¹¤
        function showAddWatchlistModal() {
            document.getElementById('addWatchlistModal').classList.remove('hidden');
            document.getElementById('addWatchlistModal').classList.add('flex');
            document.getElementById('addSymbol').focus();
        }

        function hideAddWatchlistModal() {
            document.getElementById('addWatchlistModal').classList.add('hidden');
            document.getElementById('addWatchlistModal').classList.remove('flex');
            document.getElementById('addSymbol').value = '';
            document.getElementById('addNote').value = '';
        }

        async function addToWatchlist() {
            const symbol = document.getElementById('addSymbol').value.trim().toUpperCase();
            const note = document.getElementById('addNote').value.trim();
            
            if (!symbol) {
                showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, note })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('æ–°å¢æˆåŠŸï¼');
                    hideAddWatchlistModal();
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast(data.error?.message || 'æ–°å¢å¤±æ•—');
                }
            } catch (e) {
                showToast('æ–°å¢å¤±æ•—');
            }
        }

        async function addToWatchlistDirect(symbol) {
            try {
                const res = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(`å·²å°‡ ${symbol} åŠ å…¥è¿½è¹¤ï¼`);
                } else {
                    showToast(data.error?.message || 'æ–°å¢å¤±æ•—');
                }
            } catch (e) {
                showToast('æ–°å¢å¤±æ•—');
            }
        }

        async function removeFromWatchlist(symbol) {
            if (!confirm(`ç¢ºå®šè¦ç§»é™¤ ${symbol}ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/watchlist/${symbol}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('å·²ç§»é™¤');
                    loadWatchlist();
                    loadWatchlistOverview();
                } else {
                    showToast('ç§»é™¤å¤±æ•—');
                }
            } catch (e) {
                showToast('ç§»é™¤å¤±æ•—');
            }
        }

        // è¼‰å…¥è¨­å®š
        async function loadSettings() {
            try {
                // æŒ‡æ¨™è¨­å®š
                const indRes = await fetch(`${API_BASE}/api/settings/indicators`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const indData = await indRes.json();
                
                if (indData.success) {
                    const settings = indData.data;
                    const container = document.getElementById('indicatorSettings');
                    container.innerHTML = `
                        <label class="flex items-center"><input type="checkbox" ${settings.show_ma ? 'checked' : ''} onchange="updateIndicator('show_ma', this.checked)" class="mr-2"> ç§»å‹•å¹³å‡ç·š</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.show_rsi ? 'checked' : ''} onchange="updateIndicator('show_rsi', this.checked)" class="mr-2"> RSI</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.show_macd ? 'checked' : ''} onchange="updateIndicator('show_macd', this.checked)" class="mr-2"> MACD</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.show_kd ? 'checked' : ''} onchange="updateIndicator('show_kd', this.checked)" class="mr-2"> KD</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.show_bollinger ? 'checked' : ''} onchange="updateIndicator('show_bollinger', this.checked)" class="mr-2"> å¸ƒæ—é€šé“</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.show_obv ? 'checked' : ''} onchange="updateIndicator('show_obv', this.checked)" class="mr-2"> OBV</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.show_volume ? 'checked' : ''} onchange="updateIndicator('show_volume', this.checked)" class="mr-2"> æˆäº¤é‡</label>
                    `;
                }

                // é€šçŸ¥è¨­å®š
                const alertRes = await fetch(`${API_BASE}/api/settings/alerts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const alertData = await alertRes.json();
                
                if (alertData.success) {
                    const settings = alertData.data;
                    const container = document.getElementById('alertSettings');
                    container.innerHTML = `
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_ma_cross ? 'checked' : ''} onchange="updateAlert('alert_ma_cross', this.checked)" class="mr-2"> å‡ç·šäº¤å‰</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_ma_breakout ? 'checked' : ''} onchange="updateAlert('alert_ma_breakout', this.checked)" class="mr-2"> å‡ç·šçªç ´</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_rsi ? 'checked' : ''} onchange="updateAlert('alert_rsi', this.checked)" class="mr-2"> RSI è¶…è²·è¶…è³£</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_macd ? 'checked' : ''} onchange="updateAlert('alert_macd', this.checked)" class="mr-2"> MACD äº¤å‰</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_kd ? 'checked' : ''} onchange="updateAlert('alert_kd', this.checked)" class="mr-2"> KD äº¤å‰</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_bollinger ? 'checked' : ''} onchange="updateAlert('alert_bollinger', this.checked)" class="mr-2"> å¸ƒæ—çªç ´</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_volume ? 'checked' : ''} onchange="updateAlert('alert_volume', this.checked)" class="mr-2"> é‡èƒ½ç•°å¸¸</label>
                        <label class="flex items-center"><input type="checkbox" ${settings.alert_sentiment ? 'checked' : ''} onchange="updateAlert('alert_sentiment', this.checked)" class="mr-2"> æƒ…ç·’æ¥µç«¯</label>
                    `;
                }
            } catch (e) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—', e);
            }
        }

        async function updateIndicator(key, value) {
            try {
                await fetch(`${API_BASE}/api/settings/indicators`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ [key]: value })
                });
                showToast('è¨­å®šå·²æ›´æ–°');
            } catch (e) {
                showToast('æ›´æ–°å¤±æ•—');
            }
        }

        async function updateAlert(key, value) {
            try {
                await fetch(`${API_BASE}/api/settings/alerts`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ [key]: value })
                });
                showToast('è¨­å®šå·²æ›´æ–°');
            } catch (e) {
                showToast('æ›´æ–°å¤±æ•—');
            }
        }

        async function applyTemplate(name) {
            try {
                const res = await fetch(`${API_BASE}/api/settings/template/${name}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(`å·²å¥—ç”¨ã€Œ${name}ã€æ¨¡æ¿`);
                    loadSettings();
                } else {
                    showToast('å¥—ç”¨å¤±æ•—');
                }
            } catch (e) {
                showToast('å¥—ç”¨å¤±æ•—');
            }
        }

        // å¸‚å ´æƒ…ç·’è©³æƒ…
        async function loadSentimentDetail() {
            const container = document.getElementById('sentimentDetail');
            
            try {
                const res = await fetch(`${API_BASE}/api/market/sentiment`);
                const data = await res.json();
                
                if (data.success) {
                    container.innerHTML = `
                        ${renderSentimentDetailCard('ç¾è‚¡å¸‚å ´æƒ…ç·’', data.data.stock)}
                        ${renderSentimentDetailCard('åŠ å¯†è²¨å¹£å¸‚å ´æƒ…ç·’', data.data.crypto)}
                    `;
                }
            } catch (e) {
                container.innerHTML = '<p class="text-red-500">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function renderSentimentDetailCard(title, sentiment) {
            if (!sentiment) return '';
            
            const value = sentiment.value;
            let color, label, suggestion;
            
            if (value <= 25) {
                color = 'red';
                label = 'æ¥µåº¦ææ‡¼';
                suggestion = 'å¸‚å ´æ¥µåº¦æ‚²è§€ï¼Œå¯èƒ½æ˜¯è²·å…¥è‰¯æ©Ÿï¼Œä½†éœ€è¬¹æ…è©•ä¼°';
            } else if (value <= 45) {
                color = 'orange';
                label = 'ææ‡¼';
                suggestion = 'å¸‚å ´åæ‚²è§€ï¼Œå¯è€ƒæ…®é€¢ä½ä½ˆå±€';
            } else if (value <= 55) {
                color = 'gray';
                label = 'ä¸­æ€§';
                suggestion = 'å¸‚å ´æƒ…ç·’å¹³ç©©ï¼Œè§€æœ›ç‚ºä¸»';
            } else if (value <= 75) {
                color = 'green';
                label = 'è²ªå©ª';
                suggestion = 'å¸‚å ´åæ¨‚è§€ï¼Œæ³¨æ„è¿½é«˜é¢¨éšª';
            } else {
                color = 'emerald';
                label = 'æ¥µåº¦è²ªå©ª';
                suggestion = 'å¸‚å ´éåº¦æ¨‚è§€ï¼Œå¯èƒ½æ˜¯ç²åˆ©äº†çµæ™‚æ©Ÿ';
            }

            return `
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="font-semibold text-gray-700 mb-4">${title}</h3>
                    <div class="flex items-center mb-4">
                        <div class="text-5xl font-bold text-${color}-600">${value}</div>
                        <div class="ml-4">
                            <span class="px-3 py-1 bg-${color}-100 text-${color}-700 rounded-full text-sm font-medium">${label}</span>
                        </div>
                    </div>
                    <div class="bg-gray-200 rounded-full h-4 mb-4">
                        <div class="h-4 rounded-full bg-${color}-500 transition-all" style="width: ${value}%"></div>
                    </div>
                    <p class="text-gray-600 text-sm">${suggestion}</p>
                    <p class="text-gray-400 text-xs mt-2">æ›´æ–°æ™‚é–“ï¼š${sentiment.updated_at || '--'}</p>
                </div>
            `;
        }

        // å·¥å…·å‡½æ•¸
        function formatNumber(num) {
            if (num === undefined || num === null) return '--';
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // åˆå§‹åŒ–
        checkAuth();
    </script>
</body>
</html>
