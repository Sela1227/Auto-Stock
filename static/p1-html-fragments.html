<!-- 
P1 功能 HTML 片段
==================
將這些內容加入 dashboard.html

1. 標籤編輯 Modal
2. 標籤指派 Modal  
3. 交易記錄匯入 Modal
4. 標籤管理區塊 (加在設定頁)
-->

<!-- ===== 標籤編輯 Modal ===== -->
<div id="tagEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 id="tagModalTitle" class="text-lg font-bold text-gray-800">
                <i class="fas fa-tag mr-2 text-blue-500"></i>新增標籤
            </h3>
            <button onclick="hideTagEditModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- 標籤名稱 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">標籤名稱</label>
                <input type="text" id="tagNameInput" placeholder="例如：長期持有" maxlength="50"
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- 顏色選擇 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">顏色</label>
                <div class="flex flex-wrap gap-2" id="tagColorOptions">
                    <button type="button" onclick="selectTagColor('#3B82F6')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-blue-500"></button>
                    <button type="button" onclick="selectTagColor('#10B981')" class="w-8 h-8 rounded-full bg-emerald-500 hover:ring-2 hover:ring-offset-2 hover:ring-emerald-500"></button>
                    <button type="button" onclick="selectTagColor('#EF4444')" class="w-8 h-8 rounded-full bg-red-500 hover:ring-2 hover:ring-offset-2 hover:ring-red-500"></button>
                    <button type="button" onclick="selectTagColor('#F59E0B')" class="w-8 h-8 rounded-full bg-amber-500 hover:ring-2 hover:ring-offset-2 hover:ring-amber-500"></button>
                    <button type="button" onclick="selectTagColor('#8B5CF6')" class="w-8 h-8 rounded-full bg-violet-500 hover:ring-2 hover:ring-offset-2 hover:ring-violet-500"></button>
                    <button type="button" onclick="selectTagColor('#EC4899')" class="w-8 h-8 rounded-full bg-pink-500 hover:ring-2 hover:ring-offset-2 hover:ring-pink-500"></button>
                    <button type="button" onclick="selectTagColor('#6366F1')" class="w-8 h-8 rounded-full bg-indigo-500 hover:ring-2 hover:ring-offset-2 hover:ring-indigo-500"></button>
                    <button type="button" onclick="selectTagColor('#06B6D4')" class="w-8 h-8 rounded-full bg-cyan-500 hover:ring-2 hover:ring-offset-2 hover:ring-cyan-500"></button>
                    <button type="button" onclick="selectTagColor('#F97316')" class="w-8 h-8 rounded-full bg-orange-500 hover:ring-2 hover:ring-offset-2 hover:ring-orange-500"></button>
                    <button type="button" onclick="selectTagColor('#6B7280')" class="w-8 h-8 rounded-full bg-gray-500 hover:ring-2 hover:ring-offset-2 hover:ring-gray-500"></button>
                </div>
                <input type="hidden" id="tagColorInput" value="#3B82F6">
            </div>
            
            <!-- 圖示選擇 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">圖示</label>
                <div class="flex flex-wrap gap-2" id="tagIconOptions">
                    <button type="button" onclick="selectTagIcon('fa-tag')" class="w-10 h-10 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-500 flex items-center justify-center">
                        <i class="fas fa-tag"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-star')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-star"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-heart')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-bookmark')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-flag')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-flag"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-folder')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-folder"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-fire')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-fire"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-bolt')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-bolt"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-trophy')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-trophy"></i>
                    </button>
                    <button type="button" onclick="selectTagIcon('fa-coins')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400">
                        <i class="fas fa-coins"></i>
                    </button>
                </div>
                <input type="hidden" id="tagIconInput" value="fa-tag">
            </div>
        </div>
        
        <div class="flex justify-end gap-2 mt-6">
            <button onclick="hideTagEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                取消
            </button>
            <button onclick="saveTagFromModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                <i class="fas fa-check mr-2"></i>儲存
            </button>
        </div>
    </div>
</div>

<!-- ===== 標籤指派 Modal ===== -->
<div id="assignTagModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-tags mr-2 text-blue-500"></i>
                設定標籤 - <span id="assignTagSymbol" class="text-blue-600"></span>
            </h3>
            <button onclick="hideAssignTagModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="assignTagList" class="space-y-2 max-h-80 overflow-y-auto mb-4">
            <p class="text-gray-400 text-center">載入中...</p>
        </div>
        
        <div class="flex justify-end gap-2">
            <button onclick="hideAssignTagModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                取消
            </button>
            <button onclick="saveAssignedTags()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                <i class="fas fa-check mr-2"></i>儲存
            </button>
        </div>
    </div>
</div>

<!-- ===== 交易記錄匯入 Modal ===== -->
<div id="importTransactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-upload mr-2 text-orange-500"></i>匯入交易記錄
            </h3>
            <button onclick="hideImportTransactionsModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <p class="text-sm text-gray-600 mb-2">支援 JSON 或 CSV 格式</p>
            <div class="text-xs text-gray-500 mb-3 p-2 bg-gray-50 rounded">
                <p class="font-medium mb-1">必要欄位：</p>
                <p>symbol, market (tw/us), transaction_type (buy/sell), quantity, price, transaction_date (YYYY-MM-DD)</p>
                <p class="mt-1">選填：name, fee, tax, note</p>
            </div>
            <input type="file" id="importTransactionsFile" accept=".json,.csv" 
                   onchange="previewTransactionsFile(this)"
                   class="w-full px-3 py-2 border rounded-lg cursor-pointer">
        </div>
        
        <div id="importTransactionsPreview" class="mb-4"></div>
        
        <div class="flex justify-end gap-2">
            <button onclick="hideImportTransactionsModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                取消
            </button>
            <button onclick="importTransactions()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                <i class="fas fa-upload mr-2"></i>匯入
            </button>
        </div>
    </div>
</div>

<!-- ===== 標籤管理區塊 (加在設定頁) ===== -->
<!-- 將以下內容加入 section-settings 中 -->
<div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
        <i class="fas fa-tags mr-2 text-blue-500"></i>
        標籤管理
    </h3>
    <p class="text-gray-500 text-sm mb-4">建立標籤來分類追蹤清單中的股票</p>
    <div id="tagManagerContent">
        <p class="text-gray-400 text-center py-4">載入中...</p>
    </div>
</div>

<!-- ===== 標籤選擇輔助函數 ===== -->
<script>
function selectTagColor(color) {
    document.getElementById('tagColorInput').value = color;
    document.querySelectorAll('#tagColorOptions button').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-offset-2');
        const btnColor = btn.style.backgroundColor || btn.className.match(/bg-(\w+)-500/)?.[0];
        if (btn.style.backgroundColor === color || btn.classList.contains(`bg-[${color}]`)) {
            btn.classList.add('ring-2', 'ring-offset-2');
        }
    });
    // 找到對應顏色的按鈕並加上 ring
    const buttons = document.querySelectorAll('#tagColorOptions button');
    buttons.forEach(btn => {
        btn.classList.remove('ring-2', 'ring-offset-2');
    });
    // 透過 style.backgroundColor 比對
    const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? `rgb(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)})` : null;
    };
    buttons.forEach(btn => {
        const computedColor = window.getComputedStyle(btn).backgroundColor;
        if (computedColor === hexToRgb(color)) {
            btn.classList.add('ring-2', 'ring-offset-2');
            btn.style.setProperty('--tw-ring-color', color);
        }
    });
}

function selectTagIcon(icon) {
    document.getElementById('tagIconInput').value = icon;
    document.querySelectorAll('#tagIconOptions button').forEach(btn => {
        btn.classList.remove('border-2', 'border-blue-500', 'bg-blue-50', 'text-blue-500');
        btn.classList.add('border', 'border-gray-200', 'text-gray-400');
    });
    // 找到對應圖示的按鈕
    document.querySelectorAll('#tagIconOptions button').forEach(btn => {
        const iconEl = btn.querySelector('i');
        if (iconEl && iconEl.classList.contains(icon)) {
            btn.classList.remove('border', 'border-gray-200', 'text-gray-400');
            btn.classList.add('border-2', 'border-blue-500', 'bg-blue-50', 'text-blue-500');
        }
    });
}
</script>
