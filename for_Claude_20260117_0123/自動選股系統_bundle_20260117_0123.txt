======================================================================
# å°ˆæ¡ˆï¼šè‡ªå‹•é¸è‚¡ç³»çµ±
# æ•´åˆæ™‚é–“ï¼š2026-01-17 01:23:29
# æª”æ¡ˆæ•¸é‡ï¼š136
======================================================================

## ğŸ“‚ ç›®éŒ„çµæ§‹

```
è‡ªå‹•é¸è‚¡ç³»çµ±/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ data_sources/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ coingecko.py
â”‚   â”‚   â”œâ”€â”€ fear_greed.py
â”‚   â”‚   â”œâ”€â”€ taiwan_stocks.py
â”‚   â”‚   â””â”€â”€ yahoo_finance.py
â”‚   â”œâ”€â”€ dependencies/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ auth.py
â”‚   â”œâ”€â”€ exceptions/
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ comparison.py
â”‚   â”‚   â”œâ”€â”€ crypto_price.py
â”‚   â”‚   â”œâ”€â”€ dividend_history.py
â”‚   â”‚   â”œâ”€â”€ index_price.py
â”‚   â”‚   â”œâ”€â”€ market_sentiment.py
â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â”œâ”€â”€ portfolio.py
â”‚   â”‚   â”œâ”€â”€ price_cache.py
â”‚   â”‚   â”œâ”€â”€ stock_info.py
â”‚   â”‚   â”œâ”€â”€ stock_price.py
â”‚   â”‚   â”œâ”€â”€ subscription.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ user_settings.py
â”‚   â”‚   â”œâ”€â”€ watchlist.py
â”‚   â”‚   â””â”€â”€ watchlist_tag.py
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ admin.py
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ compare.py
â”‚   â”‚   â”œâ”€â”€ crypto.py
â”‚   â”‚   â”œâ”€â”€ market.py
â”‚   â”‚   â”œâ”€â”€ portfolio.py
â”‚   â”‚   â”œâ”€â”€ settings.py
â”‚   â”‚   â”œâ”€â”€ stock.py
â”‚   â”‚   â”œâ”€â”€ stock_info.py
â”‚   â”‚   â”œâ”€â”€ subscription.py
â”‚   â”‚   â”œâ”€â”€ tags.py
â”‚   â”‚   â””â”€â”€ watchlist.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ schemas.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_service.py
â”‚   â”‚   â”œâ”€â”€ cache_helper.py
â”‚   â”‚   â”œâ”€â”€ chart_service.py
â”‚   â”‚   â”œâ”€â”€ compare_service.py
â”‚   â”‚   â”œâ”€â”€ crypto_service.py
â”‚   â”‚   â”œâ”€â”€ exchange_rate_service.py
â”‚   â”‚   â”œâ”€â”€ index_service.py
â”‚   â”‚   â”œâ”€â”€ indicator_service.py
â”‚   â”‚   â”œâ”€â”€ line_notify_service.py
â”‚   â”‚   â”œâ”€â”€ market_service.py
â”‚   â”‚   â”œâ”€â”€ notification_service.py
â”‚   â”‚   â”œâ”€â”€ portfolio_service.py
â”‚   â”‚   â”œâ”€â”€ price_cache_service.py
â”‚   â”‚   â”œâ”€â”€ rss_fetcher.py
â”‚   â”‚   â”œâ”€â”€ signal_service.py
â”‚   â”‚   â”œâ”€â”€ stock_history_service.py
â”‚   â”‚   â”œâ”€â”€ stock_service.py
â”‚   â”‚   â”œâ”€â”€ subscription_service.py
â”‚   â”‚   â””â”€â”€ watchlist_service.py
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ price_cache_task.py
â”‚   â”‚   â”œâ”€â”€ scheduler.py
â”‚   â”‚   â””â”€â”€ subscription_tasks.py
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ migrations.py
â”‚   â”‚   â””â”€â”€ p1_migrations.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cli.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ logging_config.py
â”‚   â””â”€â”€ main.py
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ 20260113-007-portfolio-v2.md
â”‚   â”œâ”€â”€ 20260113-007-portfolio-v3.md
â”‚   â”œâ”€â”€ 20260113-007-portfolio.md
â”‚   â”œâ”€â”€ 20260114-008-query-cache.md
â”‚   â”œâ”€â”€ 20260114-011-subscription-feature.md
â”‚   â”œâ”€â”€ DASHBOARD_OPTIMIZATION.md
â”‚   â”œâ”€â”€ OPTIMIZATION_GUIDE.md
â”‚   â”œâ”€â”€ optimization_report.md
â”‚   â”œâ”€â”€ P0_USAGE.md
â”‚   â”œâ”€â”€ P1_USAGE.md
â”‚   â”œâ”€â”€ P2_USAGE.md
â”‚   â”œâ”€â”€ P3_USAGE.md
â”‚   â”œâ”€â”€ P4_USAGE.md
â”‚   â”œâ”€â”€ RAILWAY_SETUP.md
â”‚   â”œâ”€â”€ README-1.md
â”‚   â”œâ”€â”€ README-2.md
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ SELA-01-BUGä¿®å¾©æŒ‡å—.md
â”‚   â”œâ”€â”€ SELA-02-åŠŸèƒ½æ•´åˆæŒ‡å—.md
â”‚   â”œâ”€â”€ SELA-03-ç³»çµ±è¦æ ¼æ›¸.md
â”‚   â””â”€â”€ SELA-Bugä¿®å¾©è¨˜éŒ„.md
â”œâ”€â”€ for_Claude_20260117_0123/
â”‚   â””â”€â”€ è‡ªå‹•é¸è‚¡ç³»çµ±_bundle_20260117_0123.txt
â”œâ”€â”€ frontend/
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ add_target_price.sql
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ åŒ¯æ•´å­ç¨‹å¼.py
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ dashboard.css
â”‚   â”‚   â””â”€â”€ settings.css
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ search/
â”‚   â”‚   â”‚   â”œâ”€â”€ search-chart.js
â”‚   â”‚   â”‚   â”œâ”€â”€ search-core.js
â”‚   â”‚   â”‚   â””â”€â”€ search-render.js
â”‚   â”‚   â”œâ”€â”€ admin.js
â”‚   â”‚   â”œâ”€â”€ cagr.js
â”‚   â”‚   â”œâ”€â”€ compare.js
â”‚   â”‚   â”œâ”€â”€ core.js
â”‚   â”‚   â”œâ”€â”€ dashboard.js
â”‚   â”‚   â”œâ”€â”€ layout.js
â”‚   â”‚   â”œâ”€â”€ modals.js
â”‚   â”‚   â”œâ”€â”€ portfolio-export-import.js
â”‚   â”‚   â”œâ”€â”€ portfolio.js
â”‚   â”‚   â”œâ”€â”€ returns.js
â”‚   â”‚   â”œâ”€â”€ search.js
â”‚   â”‚   â”œâ”€â”€ sections.js
â”‚   â”‚   â”œâ”€â”€ settings.js
â”‚   â”‚   â”œâ”€â”€ state.js
â”‚   â”‚   â”œâ”€â”€ subscription.js
â”‚   â”‚   â”œâ”€â”€ tags.js
â”‚   â”‚   â”œâ”€â”€ transaction.js
â”‚   â”‚   â”œâ”€â”€ utils.js
â”‚   â”‚   â””â”€â”€ watchlist.js
â”‚   â”œâ”€â”€ admin.html
â”‚   â”œâ”€â”€ compare-nav.js
â”‚   â”œâ”€â”€ compare.html
â”‚   â”œâ”€â”€ dashboard.html
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ logo.png
â”œâ”€â”€ æ›´æ–°æª”/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ BACKEND_CHANGES.md
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ main.py
â”œâ”€â”€ Procfile
â”œâ”€â”€ railway.json
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ ROUTER_CHANGES.md
â”œâ”€â”€ runtime.txt
â”œâ”€â”€ UI_UNIFIED_GUIDE.md
â”œâ”€â”€ äº¤ç­_20260115_2330.md
â””â”€â”€ åŒ¯æ•´å°ˆæ¡ˆ V3.py
```

======================================================================
## ğŸ“‘ æª”æ¡ˆç´¢å¼•

| å±¤ç´š | æª”æ¡ˆ | èªªæ˜ | é‡è¦åº¦ |
|------|------|------|--------|
| ğŸ“‹ | `CHANGELOG.md` | Changelog | â­â­â­ |
| ğŸ“‹ | `docs/20260113-007-portfolio-v2.md` | ğŸ’¼ SELA æ›´æ–°åŒ… - å€‹äººæŠ•è³‡è¨˜éŒ„ | â­â­â­ |
| ğŸ“‹ | `docs/20260113-007-portfolio-v3.md` | ğŸ’¼ SELA æ›´æ–°åŒ… - å€‹äººæŠ•è³‡è¨˜éŒ„ v3 | â­â­â­ |
| ğŸ“‹ | `docs/20260113-007-portfolio.md` | ğŸ’¼ SELA æ›´æ–°åŒ… - æŠ•è³‡çµ„åˆç®¡ç† | â­â­â­ |
| ğŸ“‹ | `docs/20260114-008-query-cache.md` | æŸ¥è©¢çµæœå¿«å–åŠŸèƒ½ | â­â­â­ |
| ğŸ“‹ | `docs/20260114-011-subscription-feature.md` | SELA è¨‚é–±ç²¾é¸åŠŸèƒ½ | â­â­â­ |
| ğŸ“‹ | `docs/DASHBOARD_OPTIMIZATION.md` | ğŸ”§ Dashboard.html å„ªåŒ–èªªæ˜ | â­â­â­ |
| ğŸ“‹ | `docs/OPTIMIZATION_GUIDE.md` | ğŸ”§ SELA Dashboard å®‰å…¨å„ªåŒ–ç‰ˆ | â­â­â­ |
| ğŸ“‹ | `docs/optimization_report.md` | ğŸ”§ SELA ç³»çµ± - ç¨‹å¼ç¢¼å„ªåŒ–åˆ†æå ±å‘Š | â­â­â­ |
| ğŸ“‹ | `docs/P0_USAGE.md` | P0 å„ªåŒ–ä½¿ç”¨èªªæ˜ | â­â­â­ |
| ğŸ“‹ | `docs/P1_USAGE.md` | P1 ç‹€æ…‹ç®¡ç†ä½¿ç”¨èªªæ˜ | â­â­â­ |
| ğŸ“‹ | `docs/P2_USAGE.md` | P2 æ¨¡çµ„æ‹†åˆ† + äº‹ä»¶å§”è¨—ä½¿ç”¨èªªæ˜ | â­â­â­ |
| ğŸ“‹ | `docs/P3_USAGE.md` | P3 äº‹ä»¶å§”è¨— + AppState æ•´åˆä½¿ç”¨èªªæ˜ | â­â­â­ |
| ğŸ“‹ | `docs/P4_USAGE.md` | P4 tags.js + transaction.js å„ªåŒ–ä½¿ç”¨èªªæ˜ | â­â­â­ |
| ğŸ“‹ | `docs/RAILWAY_SETUP.md` | Railway PostgreSQL è¨­å®šæŒ‡å— | â­â­â­ |
| ğŸ“‹ | `docs/README-1.md` | SELA æ›´æ–°åŒ… 20260114 | â­â­â­ |
| ğŸ“‹ | `docs/README-2.md` | SELA æ›´æ–°åŒ… 20260114 - æ’åºåŠŸèƒ½ + MA20 æ”¯æ´ | â­â­â­ |
| ğŸ“‹ | `docs/README.md` | Dashboard å„ªåŒ–ç‰ˆ | â­â­â­ |
| ğŸ“‹ | `docs/SELA-01-BUGä¿®å¾©æŒ‡å—.md` | ğŸ”§ SELA Bug ä¿®å¾©æŒ‡å— | â­â­â­ |
| ğŸ“‹ | `docs/SELA-02-åŠŸèƒ½æ•´åˆæŒ‡å—.md` | ğŸš€ SELA åŠŸèƒ½æ•´åˆæŒ‡å— | â­â­â­ |
| ğŸ“‹ | `docs/SELA-03-ç³»çµ±è¦æ ¼æ›¸.md` | ğŸ“ˆ SELA ç³»çµ±è¦æ ¼æ›¸ï¼ˆç²¾ç°¡ç‰ˆï¼‰ | â­â­â­ |
| ğŸ“‹ | `docs/SELA-Bugä¿®å¾©è¨˜éŒ„.md` | SELA é¸è‚¡ç³»çµ± - Bug ä¿®å¾©è¨˜éŒ„ | â­â­â­ |
| ğŸ“‹ | `README.md` | SELA æ•ˆèƒ½å„ªåŒ–åŒ… v2 | â­â­â­ |
| âš™ï¸ | `app/config.py` | æ‡‰ç”¨ç¨‹å¼è¨­å®šæª” | â­â­ |
| âš™ï¸ | `app/routers/settings.py` | è¨­å®šç®¡ç† API è·¯ç”± | â­â­ |
| âš™ï¸ | `Procfile` |  | â­â­ |
| âš™ï¸ | `requirements.txt` | Core Framework | â­â­â­ |
| ğŸš€ | `app/main.py` | FastAPI ä¸»ç¨‹å¼ | â­â­â­ |
| ğŸš€ | `main.py` | FastAPI ä¸»ç¨‹å¼ | â­â­â­ |
| ğŸŒ | `app/routers/__init__.py` | API è·¯ç”±æ¨¡çµ„ | â­â­â­ |
| ğŸŒ | `app/routers/admin.py` | ç®¡ç†å“¡ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/auth.py` | èªè­‰ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/compare.py` | å ±é…¬ç‡æ¯”è¼ƒ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/crypto.py` | åŠ å¯†è²¨å¹£å’Œå¸‚å ´æƒ…ç·’ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/market.py` | å¸‚å ´è³‡æ–™ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/portfolio.py` | å€‹äººæŠ•è³‡è¨˜éŒ„ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/stock.py` | è‚¡ç¥¨æŸ¥è©¢ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/stock_info.py` | è‚¡ç¥¨è³‡è¨Š API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/subscription.py` | è¨‚é–±ç²¾é¸ API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/tags.py` | æ¨™ç±¤ç®¡ç† API è·¯ç”± | â­â­â­ |
| ğŸŒ | `app/routers/watchlist.py` | è¿½è¹¤æ¸…å–® API è·¯ç”± | â­â­â­ |
| ğŸ“¦ | `app/database.py` | è³‡æ–™åº«é€£ç·šèˆ‡ Session ç®¡ç† | â­â­ |
| ğŸ“¦ | `app/models/__init__.py` | è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/comparison.py` | å ±é…¬ç‡æ¯”è¼ƒçµ„åˆ Model | â­â­ |
| ğŸ“¦ | `app/models/crypto_price.py` | åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/dividend_history.py` | è‚¡ç¥¨é…æ¯æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/index_price.py` | å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/market_sentiment.py` | å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/notification.py` | é€šçŸ¥è¨˜éŒ„è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/portfolio.py` | å€‹äººæŠ•è³‡è¨˜éŒ„æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/price_cache.py` | è‚¡ç¥¨åƒ¹æ ¼å¿«å– Model | â­â­ |
| ğŸ“¦ | `app/models/stock_info.py` | è‚¡ç¥¨åŸºæœ¬è³‡è¨Šè¡¨ | â­â­ |
| ğŸ“¦ | `app/models/stock_price.py` | è‚¡ç¥¨åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/subscription.py` | è¨‚é–±ç²¾é¸ç›¸é—œ Model | â­â­ |
| ğŸ“¦ | `app/models/user.py` | ç”¨æˆ¶è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/user_settings.py` | ç”¨æˆ¶è¨­å®šè³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/watchlist.py` | è¿½è¹¤æ¸…å–®è³‡æ–™æ¨¡å‹ | â­â­ |
| ğŸ“¦ | `app/models/watchlist_tag.py` | è¿½è¹¤æ¸…å–®åˆ†çµ„æ¨™ç±¤ | â­â­ |
| ğŸ“¦ | `app/schemas/__init__.py` | Pydantic Schemas | â­â­ |
| ğŸ“¦ | `app/schemas/schemas.py` | Pydantic Schemas | â­â­ |
| ğŸ§  | `app/services/__init__.py` | å•†æ¥­é‚è¼¯æœå‹™æ¨¡çµ„ | â­â­â­ |
| ğŸ§  | `app/services/auth_service.py` | èªè­‰æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/cache_helper.py` | åƒ¹æ ¼å¿«å–è¼”åŠ©æ¨¡çµ„ | â­â­â­ |
| ğŸ§  | `app/services/chart_service.py` | åœ–è¡¨ç¹ªè£½æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/compare_service.py` | å ±é…¬ç‡æ¯”è¼ƒæœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/crypto_service.py` | åŠ å¯†è²¨å¹£æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/exchange_rate_service.py` | åŒ¯ç‡æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/index_service.py` | æŒ‡æ•¸æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/indicator_service.py` | æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/line_notify_service.py` | LINE Messaging API æ¨æ’­æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/market_service.py` | å¸‚å ´æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/notification_service.py` | é€šçŸ¥ç®¡ç†æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/portfolio_service.py` | æŠ•è³‡çµ„åˆæ¥­å‹™é‚è¼¯æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/price_cache_service.py` | åƒ¹æ ¼å¿«å–æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/rss_fetcher.py` | è¨‚é–±æºçˆ¬èŸ²æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/signal_service.py` | è¨Šè™Ÿåµæ¸¬æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/stock_history_service.py` | è‚¡ç¥¨æ­·å²è³‡æ–™å¿«å–æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/stock_service.py` | è‚¡ç¥¨æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/subscription_service.py` | è¨‚é–±ç²¾é¸æœå‹™ | â­â­â­ |
| ğŸ§  | `app/services/watchlist_service.py` | è¿½è¹¤æ¸…å–®æœå‹™ (Async ç‰ˆæœ¬) | â­â­â­ |
| ğŸ”§ | `app/utils/__init__.py` | å·¥å…·æ¨¡çµ„ | â­ |
| ğŸ”§ | `app/utils/migrations.py` | è³‡æ–™åº«è‡ªå‹•é·ç§» | â­ |
| ğŸ”§ | `app/utils/p1_migrations.py` | P1 åŠŸèƒ½è³‡æ–™åº«é·ç§» | â­ |
| ğŸ¨ | `static/admin.html` |  | â­ |
| ğŸ¨ | `static/compare-nav.js` | * | â­ |
| ğŸ¨ | `static/compare.html` |  | â­ |
| ğŸ¨ | `static/css/dashboard.css` | å¼·åˆ¶ hidden class ç”Ÿæ•ˆ | â­ |
| ğŸ¨ | `static/css/settings.css` | * | â­ |
| ğŸ¨ | `static/dashboard.html` |  | â­ |
| ğŸ¨ | `static/index.html` |  | â­ |
| ğŸ¨ | `static/js/admin.js` | ============================================================ | â­ |
| ğŸ¨ | `static/js/cagr.js` | ============================================================ | â­ |
| ğŸ¨ | `static/js/compare.js` | * | â­ |
| ğŸ¨ | `static/js/core.js` | * | â­ |
| ğŸ¨ | `static/js/dashboard.js` | * | â­ |
| ğŸ¨ | `static/js/layout.js` | * | â­ |
| ğŸ¨ | `static/js/modals.js` | * | â­ |
| ğŸ¨ | `static/js/portfolio-export-import.js` | * | â­ |
| ğŸ¨ | `static/js/portfolio.js` | * | â­ |
| ğŸ¨ | `static/js/returns.js` | * | â­ |
| ğŸ¨ | `static/js/search.js` | * | â­ |
| ğŸ¨ | `static/js/search/search-chart.js` | * | â­ |
| ğŸ¨ | `static/js/search/search-core.js` | * | â­ |
| ğŸ¨ | `static/js/search/search-render.js` | * | â­ |
| ğŸ¨ | `static/js/sections.js` | * | â­ |
| ğŸ¨ | `static/js/settings.js` | * | â­ |
| ğŸ¨ | `static/js/state.js` | * | â­ |
| ğŸ¨ | `static/js/subscription.js` | * | â­ |
| ğŸ¨ | `static/js/tags.js` | * | â­ |
| ğŸ¨ | `static/js/transaction.js` | * | â­ |
| ğŸ¨ | `static/js/utils.js` | * | â­ |
| ğŸ¨ | `static/js/watchlist.js` | * | â­ |
| ğŸ“ | `app/__init__.py` | Stock Analysis System | â­ |
| ğŸ“ | `app/cli.py` | è‚¡ç¥¨åˆ†æç³»çµ± CLI | â­ |
| ğŸ“ | `app/data_sources/__init__.py` | å¤–éƒ¨è³‡æ–™ä¾†æºæ¨¡çµ„ | â­ |
| ğŸ“ | `app/data_sources/coingecko.py` | CoinGecko API è³‡æ–™ä¾†æº | â­ |
| ğŸ“ | `app/data_sources/fear_greed.py` | å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™ä¾†æº | â­ |
| ğŸ“ | `app/data_sources/taiwan_stocks.py` | å°è‚¡åç¨±å°ç…§è¡¨ | â­ |
| ğŸ“ | `app/data_sources/yahoo_finance.py` | Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â ÃƒÂ¦Ã‚ÂºÃ‚Â | â­ |
| ğŸ“ | `app/dependencies/__init__.py` | ä¾è³´æ³¨å…¥æ¨¡çµ„ | â­ |
| ğŸ“ | `app/dependencies/auth.py` | çµ±ä¸€èªè­‰ä¾è³´æ¨¡çµ„ | â­ |
| ğŸ“ | `app/exceptions/__init__.py` | è‡ªè¨‚ç•°å¸¸é¡åˆ¥ | â­ |
| ğŸ“ | `app/logging_config.py` | æ—¥èªŒè¨­å®š | â­ |
| ğŸ“ | `app/tasks/__init__.py` | æ’ç¨‹ä»»å‹™æ¨¡çµ„ | â­ |
| ğŸ“ | `app/tasks/price_cache_task.py` | åƒ¹æ ¼å¿«å–æ’ç¨‹ä»»å‹™ | â­ |
| ğŸ“ | `app/tasks/scheduler.py` | æ’ç¨‹ä»»å‹™æœå‹™ | â­ |
| ğŸ“ | `app/tasks/subscription_tasks.py` | è¨‚é–±ç²¾é¸æ’ç¨‹ä»»å‹™ | â­ |
| ğŸ“ | `BACKEND_CHANGES.md` | P2 å¾Œç«¯ä¿®æ”¹èªªæ˜ | â­ |
| ğŸ“ | `migrations/add_target_price.sql` |  | â­ |
| ğŸ“ | `railway.json` |  | â­ |
| ğŸ“ | `ROUTER_CHANGES.md` | ğŸ“‹ Router ä¿®æ”¹å¿«é€Ÿåƒè€ƒ | â­ |
| ğŸ“ | `runtime.txt` |  | â­ |
| ğŸ“ | `scripts/åŒ¯æ•´å­ç¨‹å¼.py` | å°ˆæ¡ˆæ•´åˆå·¥å…· - æŠŠè³‡æ–™å¤¾çµæ§‹å’Œç¨‹å¼ç¢¼æ•´åˆæˆå–®ä¸€æª”æ¡ˆ | â­ |
| ğŸ“ | `UI_UNIFIED_GUIDE.md` | ğŸ”§ SELA UI çµ±ä¸€ä¿®å¾©æŒ‡å— | â­ |
| ğŸ“ | `äº¤ç­_20260115_2330.md` | SELA è‡ªå‹•é¸è‚¡ç³»çµ± - äº¤ç­ç´€éŒ„ | â­ |
| ğŸ“ | `åŒ¯æ•´å°ˆæ¡ˆ V3.py` | å°ˆæ¡ˆæ•´åˆå·¥å…· v2 - æ™ºèƒ½åˆ†å±¤æ•´ç† | â­ |


======================================================================
## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ CHANGELOG.md  â­â­â­
> Changelog
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# Changelog

æ‰€æœ‰é‡è¦çš„è®Šæ›´éƒ½æœƒè¨˜éŒ„åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚

æ ¼å¼åŸºæ–¼ [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/)ï¼Œ
ç‰ˆæœ¬è™Ÿéµå¾ª [Semantic Versioning](https://semver.org/lang/zh-TW/)ã€‚

## [Unreleased]

### Planned
- Phase 5: éŒ¯èª¤å›å ±ç³»çµ±
- Phase 6: æœƒå“¡æ¬Šé™ç³»çµ±

## [0.8.2] - 2025-01-08

### Added
- **è¨Šè™Ÿåµæ¸¬å¼•æ“ (signal_service.py)**
  - å‡ç·šè¨Šè™Ÿï¼šé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€æ¥è¿‘çªç ´/è·Œç ´
  - RSI è¨Šè™Ÿï¼šè¶…è²· (>70)ã€è¶…è³£ (<30)
  - MACD è¨Šè™Ÿï¼šé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰
  - KD è¨Šè™Ÿï¼šé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰
  - å¸ƒæ—é€šé“è¨Šè™Ÿï¼šçªç ´ä¸Šè»Œã€è·Œç ´ä¸‹è»Œ
  - æˆäº¤é‡è¨Šè™Ÿï¼šé‡æ¯”æš´å¢ (>2 å€)
  - å¸‚å ´æƒ…ç·’è¨Šè™Ÿï¼šæ¥µåº¦ææ‡¼ (<20)ã€æ¥µåº¦è²ªå©ª (>80)

- **LINE æ¨æ’­é€šçŸ¥æœå‹™ (line_notify_service.py)**
  - LINE Messaging API æ•´åˆ
  - å–®ä¸€ç”¨æˆ¶æ¨æ’­ (push_text_message)
  - å¤šç”¨æˆ¶æ¨æ’­ (multicast_text_messageï¼Œæœ€å¤š 500 äºº)
  - Flex Message æ”¯æ´ï¼ˆå¡ç‰‡å¼è¨Šè™Ÿé€šçŸ¥ï¼‰
  - æ¯æ—¥è¨Šè™Ÿå½™æ•´å ±å‘Šæ ¼å¼

- **æ’ç¨‹ä»»å‹™æ•´åˆ (scheduler.py)**
  - è¨Šè™Ÿåµæ¸¬æ•´åˆåˆ°æ¯æ—¥æ›´æ–°ä»»å‹™
  - æ ¹æ“šç”¨æˆ¶è¿½è¹¤æ¸…å–®åµæ¸¬è¨Šè™Ÿ
  - æ ¹æ“šç”¨æˆ¶é€šçŸ¥è¨­å®šéæ¿¾è¨Šè™Ÿ
  - 24 å°æ™‚å…§ä¸é‡è¤‡é€šçŸ¥åŒä¸€è¨Šè™Ÿ
  - é€šçŸ¥è¨˜éŒ„å„²å­˜è‡³ notifications è¡¨

- **ç®¡ç†å¾Œå°è¨Šè™ŸåŠŸèƒ½**
  - POST /api/admin/signal/detect - æ‰‹å‹•åµæ¸¬è¨Šè™Ÿï¼ˆæ¸¬è©¦ï¼‰
  - POST /api/admin/signal/notify - æ‰‹å‹•ç™¼é€é€šçŸ¥
  - POST /api/admin/signal/test-push - æ¸¬è©¦ LINE æ¨æ’­
  - GET /api/admin/signal/status - é€šçŸ¥ç³»çµ±ç‹€æ…‹
  - GET /api/admin/notifications - é€šçŸ¥è¨˜éŒ„æŸ¥è©¢

- **ç®¡ç†å¾Œå°ç™»å…¥çµ±è¨ˆ**
  - é¡¯ç¤ºç¸½ç™»å…¥æ¬¡æ•¸
  - é¡¯ç¤ºæ¯å€‹ç”¨æˆ¶çš„ç™»å…¥æ¬¡æ•¸

### Changed
- **å¹´åŒ–å ±é…¬ç‡ç°¡åŒ–**
  - Yahoo Finance æ­·å²åƒ¹æ ¼ç‚ºé™¤æ¬Šæ¯èª¿æ•´å¾Œåƒ¹æ ¼
  - ç§»é™¤é‡è¤‡çš„ã€Œå«é…æ¯ã€ã€Œé…æ¯å†æŠ•å…¥ã€è¨ˆç®—
  - åªé¡¯ç¤ºå–®ä¸€ã€ŒCAGR (å¹´åŒ–å ±é…¬ç‡)ã€
  - å‰ç«¯ UI ç°¡åŒ–ç‚ºå¤§å­—é¡¯ç¤º CAGR
  - API å›å‚³æ¬„ä½å¾ price_return/total_return/reinvested_return æ”¹ç‚º cagr

### Fixed
- ä¿®æ­£å¹´åŒ–å ±é…¬ç‡å› ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼å°è‡´çš„é‡è¤‡è¨ˆç®—å•é¡Œ

### Added
- **Phase 3: èµ°å‹¢æ¯”è¼ƒåŠŸèƒ½**
  - æ–°å¢ã€Œèµ°å‹¢æ¯”è¼ƒã€é é¢
  - æ”¯æ´æœ€å¤š 5 æ”¯è‚¡ç¥¨/æŒ‡æ•¸åŒæ™‚æ¯”è¼ƒ
  - åƒ¹æ ¼æ­£è¦åŒ–ç‚ºèµ·å§‹æ—¥ = 100%
  - å¿«é€Ÿé¸æ“‡æŒ‰éˆ•ï¼ˆå››å¤§æŒ‡æ•¸ã€ç†±é–€ç¾è‚¡ã€å°è‚¡ã€åŠ å¯†è²¨å¹£ï¼‰
  - æ™‚é–“ç¯„åœé¸æ“‡ï¼š1M / 3M / 6M / 1Y
  - æ¯”è¼ƒçµæœè¡¨æ ¼é¡¯ç¤ºèµ·å§‹åƒ¹ã€æœ€æ–°åƒ¹ã€æ¼²è·Œå¹…
  - API: GET /api/stock/compare/history

- **Phase 4: å¹´åŒ–å ±é…¬ç‡è¨ˆç®—**
  - è‚¡ç¥¨æŸ¥è©¢çµæœæ–°å¢ã€Œå¹´åŒ–å ±é…¬ç‡ã€æŒ‰éˆ•
  - è¨ˆç®— 1Y / 3Y / 5Y / 10Y å¹´åŒ–å ±é…¬ç‡
  - ä¸‰ç¨®è¨ˆç®—æ–¹å¼ï¼š
    - åƒ¹æ ¼å ±é…¬ï¼šç´”è‚¡åƒ¹æ¼²è·Œ
    - å«é…æ¯ï¼šè‚¡åƒ¹ + é…æ¯ï¼ˆä¸å†æŠ•å…¥ï¼‰
    - é…æ¯å†æŠ•å…¥ï¼šé…æ¯ä»¥é™¤æ¯æ—¥è‚¡åƒ¹è²·å…¥æ›´å¤šè‚¡æ•¸
  - é¡¯ç¤ºé…æ¯æ¬¡æ•¸ã€å¹´å‡æ®–åˆ©ç‡
  - API: GET /api/stock/{symbol}/returns

- **å„€è¡¨æ¿æ–°å¢å°è‚¡åŠ æ¬ŠæŒ‡æ•¸**
  - æ”¯æ´ ^TWII å°ç£åŠ æ¬Šè‚¡åƒ¹æŒ‡æ•¸
  - å„€è¡¨æ¿æŒ‡æ•¸å¡ç‰‡å¾ 3 å€‹å¢åŠ åˆ° 4 å€‹
  - èµ°å‹¢æ¯”è¼ƒå¿«é€Ÿé¸æ“‡æ–°å¢å°ç©é›»ã€é´»æµ·

- **ç®¡ç†å¾Œå°ç™»å…¥çµ±è¨ˆ**
  - çµ±è¨ˆå¡ç‰‡æ–°å¢ã€Œç¸½ç™»å…¥æ¬¡æ•¸ã€
  - ç”¨æˆ¶åˆ—è¡¨æ–°å¢ã€Œç™»å…¥æ¬¡æ•¸ã€æ¬„ä½
  - API: /api/admin/stats æ–°å¢ total_logins
  - API: /api/admin/users æ–°å¢ login_count

### Fixed
- **é‡è¦ï¼šä¿®å¾©æ­·å²è‚¡åƒ¹ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼çš„å•é¡Œ**
  - yfinance é è¨­å›å‚³ auto_adjust=Trueï¼ˆé…æ¯èª¿æ•´å¾Œåƒ¹æ ¼ï¼‰
  - æ”¹ç‚º auto_adjust=False å–å¾—åŸå§‹æ”¶ç›¤åƒ¹
  - å½±éŸ¿ï¼šå¹´åŒ–å ±é…¬ç‡ã€æ®–åˆ©ç‡è¨ˆç®—ç¾åœ¨ä½¿ç”¨æ­£ç¢ºçš„æ­·å²åƒ¹æ ¼
- ä¿®å¾©æŒ‡æ•¸æ­·å² API çš„ NaN å€¼ JSON åºåˆ—åŒ–éŒ¯èª¤
- IndexPrice model to_dict() åŠ å…¥ NaN/Infinity æª¢æŸ¥
- market_service save_index_data() å„²å­˜å‰æ¸…ç†ç„¡æ•ˆæ•¸å€¼
- ä¿®å¾©èµ°å‹¢æ¯”è¼ƒåœ–è¡¨éœ€è¦ chartjs-adapter-date-fns
- ä¿®å¾©å¹´åŒ–å ±é…¬ç‡ yearly_detail è®Šæ•¸æœªå®šç¾©éŒ¯èª¤

## [0.7.0] - 2025-01-07

### Added
- **Phase 2: å‰ç«¯é¡¯ç¤ºåŠŸèƒ½**
  - å„€è¡¨æ¿é ‚éƒ¨ä¸‰å¤§æŒ‡æ•¸å¡ç‰‡ï¼ˆS&P 500ã€é“ç“Šå·¥æ¥­ã€ç´æ–¯é”å…‹ï¼‰
  - é»æ“ŠæŒ‡æ•¸å¡ç‰‡é–‹å•Ÿå…¨è¢å¹•èµ°å‹¢åœ–ï¼ˆModal è¦–çª—ï¼‰
  - æŒ‡æ•¸èµ°å‹¢æ”¯æ´ 1M/3M/1Y/5Y æ™‚é–“ç¯„åœåˆ‡æ›
  - ææ‡¼è²ªå©ªæŒ‡æ•¸é»æ“Šé–‹å•Ÿå…¨è¢å¹•æ­·å²èµ°å‹¢åœ–
  - æƒ…ç·’èµ°å‹¢æ”¯æ´ 1M/3M/6M/1Y æ™‚é–“ç¯„åœåˆ‡æ›
  - **ç®¡ç†å¾Œå°å¸‚å ´è³‡æ–™ç®¡ç†å€å¡Š**
    - åˆå§‹åŒ–æ­·å²è³‡æ–™æŒ‰éˆ•
    - æ›´æ–°ä¸‰å¤§æŒ‡æ•¸æŒ‰éˆ•
    - æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸æŒ‰éˆ•
    - åŸ·è¡Œæ¯æ—¥æ›´æ–°æŒ‰éˆ•

### Changed
- ã€Œæƒ…ç·’æŒ‡æ•¸ã€æ›´åç‚ºã€Œææ‡¼è²ªå©ªæŒ‡æ•¸ã€
- åœ–è¡¨æ”¹ç‚º Modal å…¨è¢å¹•é¡¯ç¤ºï¼Œè§£æ±ºå¡ç‰‡å…§åµŒé¡¯ç¤ºå•é¡Œ
- åœ–è¡¨é‚Šè·å¢åŠ ï¼Œæ”¹å–„è§¸æ§é«”é©—

### Fixed
- ä¿®å¾© get_latest_indices å›å‚³æ ¼å¼ï¼ˆList â†’ Dictï¼‰
- åŠ å¼·è³‡æ–™åº«éŒ¯èª¤è™•ç†ï¼Œè‡ªå‹• fallback åˆ° Yahoo Finance API
- ä¿®å¾©æŒ‡æ•¸/æƒ…ç·’èµ°å‹¢åœ–ç„¡æ³•æ­£å¸¸é¡¯ç¤ºçš„å•é¡Œ

## [0.6.1] - 2025-01-07

### Fixed
- **ç”¨æˆ¶èº«ä»½é©—è­‰å¼·åŒ–**
  - ç™»å…¥æ™‚æ¸…é™¤æ‰€æœ‰èˆŠçš„ localStorage/sessionStorage è³‡æ–™ï¼Œé¿å… A ç”¨æˆ¶çœ‹åˆ° B ç”¨æˆ¶è³‡æ–™
  - JWT Token é©—è­‰å¢åŠ  LINE ID ä¸€è‡´æ€§æª¢æŸ¥
  - å‰ç«¯ checkAuth å¢åŠ æœ¬åœ°èˆ‡ä¼ºæœå™¨ç”¨æˆ¶ ID æ¯”å°
  - æ‰€æœ‰ API è«‹æ±‚æ”¹ç”¨çµ±ä¸€çš„ apiRequest å‡½æ•¸ï¼Œè‡ªå‹•å¸¶å…¥é©—è­‰
  - **UserResponse schema åŠ å…¥ is_admin æ¬„ä½**ï¼ˆä¿®å¾©ç®¡ç†å“¡æ¬Šé™æ¶ˆå¤±å•é¡Œï¼‰

- **è¿½è¹¤æ¸…å–®å®‰å…¨æ€§**
  - è¿½è¹¤æ¸…å–®åˆªé™¤æ™‚å¢åŠ  user_id äºŒæ¬¡é©—è­‰
  - æ‰€æœ‰è¿½è¹¤æ¸…å–®æ“ä½œåŠ å…¥è©³ç´° log è¨˜éŒ„
  - å‰ç«¯æ“ä½œå‰æª¢æŸ¥ currentUser æ˜¯å¦å­˜åœ¨

- **æ—¥èªŒç³»çµ±å¼·åŒ–**
  - æ–°å¢ logging_config.py çµ±ä¸€æ—¥èªŒè¨­å®š
  - èªè­‰æœå‹™ (auth_service) å®Œæ•´ç™»å…¥æµç¨‹ log
  - è¿½è¹¤æ¸…å–®æœå‹™ (watchlist_service) æ“ä½œ log
  - æ—¥èªŒæª”æ¡ˆæŒ‰æ—¥æœŸåˆ†é¡å­˜æ”¾æ–¼ logs/ ç›®éŒ„
  - åˆ†é›¢ authã€watchlist å°ˆç”¨æ—¥èªŒæª”

### Changed
- auth_service.py: login_with_line() åŠ å…¥å®Œæ•´ log è¨˜éŒ„
- auth_service.py: get_user_from_token() åŠ å…¥ LINE ID ä¸€è‡´æ€§é©—è­‰
- watchlist_service.py: æ‰€æœ‰æ“ä½œåŠ å…¥è©³ç´° log
- watchlist.py router: æ‰€æœ‰ç«¯é»åŠ å…¥ log è¨˜éŒ„
- dashboard.html: æ–°å¢ apiRequest() çµ±ä¸€ API è«‹æ±‚å‡½æ•¸
- dashboard.html: æ–°å¢ clearAllUserData() æ¸…é™¤ç”¨æˆ¶è³‡æ–™å‡½æ•¸
- main.py: ä½¿ç”¨ logging_config.py åˆå§‹åŒ–æ—¥èªŒç³»çµ±
- schemas.py: UserResponse åŠ å…¥ is_admin æ¬„ä½

### Added
- app/logging_config.py: æ—¥èªŒè¨­å®šæ¨¡çµ„

## [0.6.0] - 2025-01-07

### Added
- **è³‡æ–™åŸºç¤å»ºè¨­ (Phase 1)**
  - ä¸‰å¤§æŒ‡æ•¸æ”¯æ´
    - S&P 500 (^GSPC)
    - é“ç“Šå·¥æ¥­ (^DJI)
    - ç´æ–¯é”å…‹ (^IXIC)
    - IndexPrice è³‡æ–™æ¨¡å‹
    - 10 å¹´æ­·å²è³‡æ–™æ”¯æ´
  - é…æ¯è³‡æ–™
    - DividendHistory è³‡æ–™æ¨¡å‹
    - yfinance é…æ¯æŠ“å–
  - æƒ…ç·’æŒ‡æ•¸æ­·å²
    - å¹£åœˆæƒ…ç·’ 365 å¤©æ­·å²æŠ“å–
    - ç¾è‚¡æƒ…ç·’æ¯æ—¥ç´¯ç©
  - æ’ç¨‹ä»»å‹™æœå‹™ (scheduler.py)
    - æ¯æ—¥è‡ªå‹•æ›´æ–°è‚¡åƒ¹
    - æ¯æ—¥æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
    - æ¯æ—¥æ›´æ–°å¸‚å ´æƒ…ç·’
    - åˆå§‹åŒ–æ­·å²è³‡æ–™åŠŸèƒ½
  - å¸‚å ´æœå‹™ (market_service.py)
    - æŒ‡æ•¸è³‡æ–™å­˜å–
    - æƒ…ç·’è³‡æ–™å­˜å–
    - é…æ¯è³‡æ–™å­˜å–
  - å¸‚å ´ API ç«¯é» (/api/market)
    - GET /indices - å–å¾—ä¸‰å¤§æŒ‡æ•¸
    - GET /indices/{symbol}/history - æŒ‡æ•¸æ­·å²
    - GET /sentiment - å¸‚å ´æƒ…ç·’
    - GET /sentiment/{market}/history - æƒ…ç·’æ­·å²
    - POST /admin/update - æ‰‹å‹•è§¸ç™¼æ›´æ–°
    - POST /admin/initialize - åˆå§‹åŒ–æ­·å²è³‡æ–™
    - POST /admin/update-indices - æ›´æ–°æŒ‡æ•¸
    - POST /admin/update-sentiment - æ›´æ–°æƒ…ç·’
    - POST /admin/init-crypto-sentiment - åˆå§‹åŒ–å¹£åœˆæƒ…ç·’

### Changed
- stock_service.py æ”¯æ´ 10 å¹´æ­·å²è³‡æ–™
- yahoo_finance.py æ–°å¢æŒ‡æ•¸å’Œé…æ¯æŠ“å–æ–¹æ³•
- fear_greed.py æ–°å¢æ­·å²è³‡æ–™æŠ“å–

## [0.5.3] - 2025-01-06

### Fixed
- å¯æŠ˜ç–ŠæŒ‡æ¨™å€å¡Šåœ¨æ¡Œé¢ç‰ˆç„¡æ³•é‹ä½œ
- è¿½è¹¤æ¸…å–®ç¼ºå°‘å³æ™‚åƒ¹æ ¼è³‡è¨Š
- æ¨¡æ¿é¸æ“‡ç„¡è¦–è¦ºå›é¥‹
- è¨­å®šé é¢é¡¯ç¤º LINE IDï¼ˆéš±ç§å•é¡Œï¼‰

### Changed
- è¿½è¹¤æ¸…å–®å¡ç‰‡å¢åŠ å³æ™‚åƒ¹æ ¼å’Œæ¼²è·Œå¹…
- æ¨¡æ¿æŒ‰éˆ•é¸ä¸­ç‹€æ…‹æ¨£å¼
- è¨­å®šé é¢æ”¹é¡¯ç¤ºæœƒå“¡ç­‰ç´š

## [0.3.0] - 2025-01-05

### Added
- ç”¨æˆ¶ç³»çµ±
  - LINE Login æ•´åˆ
  - JWT Token èªè­‰
  - ç”¨æˆ¶è³‡æ–™ç®¡ç†
- è¿½è¹¤æ¸…å–®åŠŸèƒ½
  - æ–°å¢/ç§»é™¤è¿½è¹¤æ¨™çš„
  - è‡ªè¨‚å‚™è¨»
  - è¿½è¹¤æ¸…å–®ç¸½è¦½ (å«å³æ™‚åƒ¹æ ¼)
- å€‹äººåŒ–è¨­å®š
  - æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
  - é€šçŸ¥è¨­å®š
  - æŒ‡æ¨™åƒæ•¸èª¿æ•´
  - é è¨­æ¨¡æ¿ (æ¥µç°¡/æ¨™æº–/å®Œæ•´/çŸ­ç·š)
- FastAPI Web API
  - èªè­‰è·¯ç”± (/auth)
  - è‚¡ç¥¨æŸ¥è©¢ (/api/stock)
  - åŠ å¯†è²¨å¹£æŸ¥è©¢ (/api/crypto)
  - è¿½è¹¤æ¸…å–®ç®¡ç† (/api/watchlist)
  - è¨­å®šç®¡ç† (/api/settings)
  - å¸‚å ´æƒ…ç·’ (/api/market/sentiment)
  - Swagger æ–‡ä»¶ (/docs)
- è³‡æ–™æ¨¡å‹
  - User (ç”¨æˆ¶)
  - Watchlist (è¿½è¹¤æ¸…å–®)
  - UserIndicatorSettings (æŒ‡æ¨™è¨­å®š)
  - UserAlertSettings (é€šçŸ¥è¨­å®š)
  - UserIndicatorParams (åƒæ•¸è¨­å®š)
  - Notification (é€šçŸ¥è¨˜éŒ„)

## [0.2.0] - 2025-01-05

### Added
- åœ–è¡¨ç¹ªè£½æœå‹™ (chart_service.py)
  - åƒ¹æ ¼èµ°å‹¢åœ– + å‡ç·š + å¸ƒæ—é€šé“
  - æˆäº¤é‡æŸ±ç‹€åœ–
  - RSIã€MACDã€KD å­åœ–
  - å‡ç·šäº¤å‰é»æ¨™è¨˜
  - Kç·šåœ–æ”¯æ´
- åŠ å¯†è²¨å¹£æ”¯æ´
  - CoinGecko API æ•´åˆ
  - BTCã€ETH åƒ¹æ ¼è¿½è¹¤
  - å¹£åœˆæŠ€è¡“æŒ‡æ¨™ (MA7/25/99)
- å¸‚å ´æƒ…ç·’æŒ‡æ•¸
  - CNN Fear & Greed Index (ç¾è‚¡)
  - Alternative.me (åŠ å¯†è²¨å¹£)
- CLI æ–°å¢æŒ‡ä»¤
  - `sentiment` - æŸ¥è©¢å¸‚å ´æƒ…ç·’
  - `chart` - ç”ŸæˆæŠ€è¡“åˆ†æåœ–è¡¨
  - æ”¯æ´åŠ å¯†è²¨å¹£æŸ¥è©¢ (BTC, ETH)

### Changed
- CLI äº’å‹•æ¨¡å¼æç¤ºç¬¦æ”¹ç‚º `ä»£è™Ÿ>`
- æ”¯æ´åŒæ™‚æŸ¥è©¢è‚¡ç¥¨å’ŒåŠ å¯†è²¨å¹£

## [0.1.0] - 2025-01-05

### Added
- å°ˆæ¡ˆåˆå§‹åŒ–
- Yahoo Finance è‚¡åƒ¹è³‡æ–™æŠ“å–
- SQLite æœ¬åœ°å¿«å–æ©Ÿåˆ¶
- æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“
  - ç§»å‹•å¹³å‡ç·š (MA20, MA50, MA200)
  - RSI ç›¸å°å¼·å¼±æŒ‡æ¨™
  - MACD æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡
  - KD éš¨æ©ŸæŒ‡æ¨™
  - å¸ƒæ—é€šé“
  - OBV èƒ½é‡æ½®æŒ‡æ¨™
  - æˆäº¤é‡åˆ†æ
- è¨Šè™Ÿåµæ¸¬ç³»çµ±
  - å‡ç·šé»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰
  - æ¥è¿‘çªç ´/è·Œç ´é è­¦
  - RSI è¶…è²·è¶…è³£
  - MACD/KD äº¤å‰
- ç¶œåˆè©•åˆ†ç³»çµ±
- CLI å‘½ä»¤åˆ—æŸ¥è©¢ä»‹é¢
  - äº’å‹•æ¨¡å¼
  - å–®æ¬¡æŸ¥è©¢æŒ‡ä»¤
  - å¼·åˆ¶æ›´æ–°é¸é …
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260113-007-portfolio-v2.md  â­â­â­
> ğŸ’¼ SELA æ›´æ–°åŒ… - å€‹äººæŠ•è³‡è¨˜éŒ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ’¼ SELA æ›´æ–°åŒ… - å€‹äººæŠ•è³‡è¨˜éŒ„

> æ–‡ä»¶ç·¨è™Ÿ: 20260113-007-portfolio-v2  
> å»ºç«‹æ—¥æœŸ: 2026-01-13  
> åŠŸèƒ½: åŠŸèƒ½ 2 - å€‹äººäº¤æ˜“ç®¡ç†ï¼ˆå®Œæ•´ç‰ˆï¼‰

---

## ğŸ“¦ æª”æ¡ˆæ¸…å–®

```
app/
â”œâ”€â”€ main.py                          â† è¦†è“‹ï¼ˆè¨»å†Š router + åŒ¯ç‡æ’ç¨‹ï¼‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py                  â† è¦†è“‹
â”‚   â””â”€â”€ portfolio.py                 â† æ–°å¢
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ __init__.py                  â† è¦†è“‹
â”‚   â””â”€â”€ portfolio.py                 â† æ–°å¢
â””â”€â”€ services/
    â”œâ”€â”€ exchange_rate_service.py     â† æ–°å¢
    â””â”€â”€ portfolio_service.py         â† æ–°å¢

static/
â””â”€â”€ dashboard.html                   â† è¦†è“‹ï¼ˆå« BTC + å€‹äººæŠ•è³‡è¨˜éŒ„ï¼‰
```

---

## âœ¨ åŠŸèƒ½ç‰¹è‰²

### 1. å°ç¾è‚¡åˆ†é–‹ç®¡ç†
- å°è‚¡å€å¡Šï¼šç¨ç«‹ã€Œæ–°å¢ã€æŒ‰éˆ•ï¼Œè‡ªå‹•åŠ  `.TW` å¾Œç¶´
- ç¾è‚¡å€å¡Šï¼šç¨ç«‹ã€Œæ–°å¢ã€æŒ‰éˆ•
- å„è‡ªçµ±è¨ˆæç›Š

### 2. åŒ¯ç‡è‡ªå‹•æ›´æ–°
- æ¯å¤© 3 æ¬¡è‡ªå‹•æŠ“å–ï¼ˆ09:00ã€12:00ã€17:00ï¼‰
- ä¾†æºï¼šYahoo Finance (TWD=X)
- é è¨­å€¼ï¼š32.5ï¼ˆæŠ“å–å¤±æ•—æ™‚ä½¿ç”¨ï¼‰

### 3. ç¸½è¦½åŠ ç¸½
- å°è‚¡ + (ç¾è‚¡ Ã— åŒ¯ç‡) = ç¸½è¨ˆ (TWD)
- é¡¯ç¤ºç¸½ç¾å€¼ã€ç¸½æç›Šã€å ±é…¬ç‡

### 4. å°è‚¡å¼µæ•¸è¼¸å…¥
- å¼µæ•¸ + é›¶è‚¡ åˆ†é–‹è¼¸å…¥
- è‡ªå‹•è¨ˆç®—ç¸½è‚¡æ•¸
- é¡¯ç¤ºï¼šã€Œ1å¼µ500è‚¡ã€æ ¼å¼

### 5. è‚¡ç¥¨åç¨±è‡ªå‹•å¸¶å…¥
- è¼¸å…¥ä»£ç¢¼å¾Œ 0.5 ç§’è‡ªå‹•æŸ¥è©¢
- åç¨±æ¬„ä½å”¯è®€
- æŸ¥ç„¡è‚¡ç¥¨æ™‚ç„¡æ³•é€å‡º

### 6. è¿½è¹¤æ¸…å–®è²·è³£æŒ‰éˆ•
- æ¯å€‹è¿½è¹¤é …ç›®æ–°å¢ã€Œè²·ã€ã€Œè³£ã€æŒ‰éˆ•
- é»æ“Šå¾Œè‡ªå‹•é–‹å•Ÿå°æ‡‰å¸‚å ´ Modal
- è‡ªå‹•å¸¶å…¥ä»£ç¢¼å’Œåç¨±

---

## ğŸ—„ï¸ è³‡æ–™åº«

æ–°å¢ä¸‰å¼µè¡¨ï¼ˆé¦–æ¬¡å•Ÿå‹•è‡ªå‹•å»ºç«‹ï¼‰ï¼š

### portfolio_transactionsï¼ˆäº¤æ˜“ç´€éŒ„ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID |
| symbol | VARCHAR(20) | è‚¡ç¥¨ä»£ç¢¼ |
| name | VARCHAR(100) | è‚¡ç¥¨åç¨± |
| market | VARCHAR(10) | tw / us |
| transaction_type | VARCHAR(10) | buy / sell |
| quantity | INTEGER | ç¸½è‚¡æ•¸ |
| price | NUMERIC(12,4) | æˆäº¤åƒ¹ |
| fee | NUMERIC(10,2) | æ‰‹çºŒè²» |
| tax | NUMERIC(10,2) | äº¤æ˜“ç¨… |
| transaction_date | DATE | äº¤æ˜“æ—¥æœŸ |
| note | TEXT | å‚™è¨» |

### portfolio_holdingsï¼ˆæŒè‚¡å½™ç¸½ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID |
| symbol | VARCHAR(20) | è‚¡ç¥¨ä»£ç¢¼ |
| name | VARCHAR(100) | è‚¡ç¥¨åç¨± |
| market | VARCHAR(10) | tw / us |
| total_shares | INTEGER | ç¸½æŒè‚¡ |
| avg_cost | NUMERIC(12,4) | å¹³å‡æˆæœ¬ |
| total_invested | NUMERIC(14,2) | ç¸½æŠ•å…¥ |
| realized_profit | NUMERIC(14,2) | å·²å¯¦ç¾æç›Š |

### exchange_ratesï¼ˆåŒ¯ç‡ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| from_currency | VARCHAR(10) | USD |
| to_currency | VARCHAR(10) | TWD |
| rate | FLOAT | åŒ¯ç‡ |
| updated_at | DATETIME | æ›´æ–°æ™‚é–“ |

---

## ğŸ“¡ API ç«¯é»

### åŒ¯ç‡
| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/portfolio/exchange-rate` | å–å¾—åŒ¯ç‡ |
| PUT | `/api/portfolio/exchange-rate` | æ‰‹å‹•è¨­å®šåŒ¯ç‡ |

### äº¤æ˜“ç´€éŒ„
| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/portfolio/transactions` | æ–°å¢äº¤æ˜“ |
| GET | `/api/portfolio/transactions` | äº¤æ˜“åˆ—è¡¨ |
| GET | `/api/portfolio/transactions/{id}` | å–®ç­†äº¤æ˜“ |
| PUT | `/api/portfolio/transactions/{id}` | æ›´æ–°äº¤æ˜“ |
| DELETE | `/api/portfolio/transactions/{id}` | åˆªé™¤äº¤æ˜“ |

### æŒè‚¡èˆ‡æ‘˜è¦
| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/portfolio/holdings` | æŒè‚¡åˆ—è¡¨ï¼ˆå«ç¾åƒ¹ï¼‰ |
| GET | `/api/portfolio/summary` | æŠ•è³‡æ‘˜è¦ï¼ˆå«åŒ¯ç‡æ›ç®—ï¼‰ |

---

## ğŸ”§ æ•´åˆæ–¹å¼

1. å°‡ `app/` ç›®éŒ„ä¸‹çš„æª”æ¡ˆè¤‡è£½åˆ°å°ˆæ¡ˆå°æ‡‰ä½ç½®
2. å°‡ `static/dashboard.html` è¦†è“‹å°ˆæ¡ˆä¸­çš„åŒåæª”æ¡ˆ
3. é‡æ–°éƒ¨ç½²ï¼ˆè³‡æ–™åº«è¡¨æœƒè‡ªå‹•å»ºç«‹ï¼‰

---

## â° æ’ç¨‹ä»»å‹™

| æ™‚é–“ | ä»»å‹™ |
|------|------|
| æ¯ 10 åˆ†é˜ | åƒ¹æ ¼å¿«å–æ›´æ–° |
| é€±ä¸€~äº” 13:35 | å°è‚¡æ”¶ç›¤æ›´æ–° |
| é€±äºŒ~å…­ 05:05 | ç¾è‚¡æ”¶ç›¤æ›´æ–° |
| **æ¯å¤© 09:00** | åŒ¯ç‡æ›´æ–°ï¼ˆæ—©ï¼‰ |
| **æ¯å¤© 12:00** | åŒ¯ç‡æ›´æ–°ï¼ˆä¸­ï¼‰ |
| **æ¯å¤© 17:00** | åŒ¯ç‡æ›´æ–°ï¼ˆæ™šï¼‰ |

---

## âœ… é©—æ”¶æ¸…å–®

### å€‹äººæŠ•è³‡è¨˜éŒ„
- [x] å´é‚Šæ¬„é¡¯ç¤ºã€Œå€‹äººæŠ•è³‡è¨˜éŒ„ã€
- [x] å°è‚¡/ç¾è‚¡åˆ†é–‹å€å¡Š
- [x] å„è‡ªæœ‰ã€Œæ–°å¢ã€æŒ‰éˆ•
- [x] å°è‚¡ï¼šå¼µæ•¸ + é›¶è‚¡è¼¸å…¥
- [x] ç¾è‚¡ï¼šè‚¡æ•¸è¼¸å…¥
- [x] è‚¡ç¥¨ä»£ç¢¼è‡ªå‹•æŸ¥è©¢åç¨±
- [x] åç¨±æ¬„ä½å”¯è®€
- [x] æŠ•è³‡ç¸½è¦½ï¼ˆåŒ¯ç‡æ›ç®—ï¼‰
- [x] æŒè‚¡ç¸½è¦½ / å°è‚¡ç´€éŒ„ / ç¾è‚¡ç´€éŒ„ ä¸‰å€‹ Tab

### è¿½è¹¤æ¸…å–®
- [x] æ¯å€‹é …ç›®æ–°å¢ã€Œè²·ã€ã€Œè³£ã€æŒ‰éˆ•
- [x] é»æ“Šè‡ªå‹•é–‹å•Ÿå°æ‡‰ Modal
- [x] è‡ªå‹•å¸¶å…¥ä»£ç¢¼å’Œåç¨±

### åŒ¯ç‡
- [x] æ¯å¤© 3 æ¬¡è‡ªå‹•æ›´æ–°
- [x] ç¸½è¦½é¡¯ç¤ºåŒ¯ç‡å’Œæ›´æ–°æ™‚é–“

### BTC å¡ç‰‡
- [x] å„€è¡¨æ¿é¡¯ç¤º BTC åƒ¹æ ¼
- [x] å‹•æ…‹èƒŒæ™¯è‰²
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260113-007-portfolio-v3.md  â­â­â­
> ğŸ’¼ SELA æ›´æ–°åŒ… - å€‹äººæŠ•è³‡è¨˜éŒ„ v3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ’¼ SELA æ›´æ–°åŒ… - å€‹äººæŠ•è³‡è¨˜éŒ„ v3

> æ–‡ä»¶ç·¨è™Ÿ: 20260113-007-portfolio-v3  
> å»ºç«‹æ—¥æœŸ: 2026-01-13  
> åŠŸèƒ½: åŠŸèƒ½ 2 - å€‹äººäº¤æ˜“ç®¡ç† + å¾…è¾¦å®Œæˆ

---

## ğŸ“¦ æª”æ¡ˆæ¸…å–®

```
app/
â”œâ”€â”€ main.py                          â† è¦†è“‹ï¼ˆè¨»å†Š router + åŒ¯ç‡æ’ç¨‹ï¼‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py                  â† è¦†è“‹
â”‚   â””â”€â”€ portfolio.py                 â† æ–°å¢
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ __init__.py                  â† è¦†è“‹
â”‚   â”œâ”€â”€ admin.py                     â† è¦†è“‹ï¼ˆå«ä¸‰å€‹æ›´æ–° APIï¼‰
â”‚   â””â”€â”€ portfolio.py                 â† æ–°å¢
â””â”€â”€ services/
    â”œâ”€â”€ exchange_rate_service.py     â† æ–°å¢
    â””â”€â”€ portfolio_service.py         â† æ–°å¢

static/
â””â”€â”€ dashboard.html                   â† è¦†è“‹
```

---

## âœ… å¾…è¾¦å®Œæˆ

### 1. BTC å¡ç‰‡ç§»åˆ°ç¬¬ä¸€é … âœ“
å„€è¡¨æ¿é ‚éƒ¨ç¬¬ä¸€å€‹å…ƒç´ ç¾åœ¨æ˜¯æ¯”ç‰¹å¹£åƒ¹æ ¼å¡ç‰‡

### 2. ç®¡ç†å“¡ç™»å…¥è§¸ç™¼å…¨éƒ¨æ›´æ–° âœ“
ç®¡ç†å“¡ç™»å…¥å¾Œè‡ªå‹•è§¸ç™¼ï¼š
- å››å¤§æŒ‡æ•¸æ›´æ–° (`/api/admin/update-indices`)
- åƒ¹æ ¼å¿«å–æ›´æ–° (`/api/admin/update-price-cache`)
- BTC åƒ¹æ ¼æ›´æ–°ï¼ˆå‰ç«¯è¼‰å…¥ï¼‰
- åŒ¯ç‡æ›´æ–° (`/api/admin/update-exchange-rate`)

### 3. æŠ•è³‡ç¸½è¦½åˆ†ä¸‰å€ âœ“
- ğŸ”´ **å°è‚¡å€**ï¼šç¾å€¼ã€æç›Šã€å ±é…¬ç‡ã€æŒè‚¡æ•¸ï¼ˆNT$ï¼‰
- ğŸ”µ **ç¾è‚¡å€**ï¼šç¾å€¼ã€æç›Šã€å ±é…¬ç‡ã€æŒè‚¡æ•¸ï¼ˆUSDï¼‰
- ğŸŸ£ **åˆè¨ˆå€**ï¼šç¸½ç¾å€¼ã€ç¸½æç›Šã€å ±é…¬ç‡ã€ç¸½æŒè‚¡ï¼ˆTWDï¼Œç¾è‚¡ Ã— åŒ¯ç‡ï¼‰

---

## âœ¨ åŠŸèƒ½ç‰¹è‰²

### 1. å°ç¾è‚¡åˆ†é–‹ç®¡ç†
- å°è‚¡å€å¡Šï¼šç¨ç«‹ã€Œæ–°å¢ã€æŒ‰éˆ•ï¼Œè‡ªå‹•åŠ  `.TW` å¾Œç¶´
- ç¾è‚¡å€å¡Šï¼šç¨ç«‹ã€Œæ–°å¢ã€æŒ‰éˆ•
- å„è‡ªçµ±è¨ˆæç›Š

### 2. åŒ¯ç‡è‡ªå‹•æ›´æ–°
- æ¯å¤© 3 æ¬¡è‡ªå‹•æŠ“å–ï¼ˆ09:00ã€12:00ã€17:00ï¼‰
- ä¾†æºï¼šYahoo Finance (TWD=X)
- é è¨­å€¼ï¼š32.5ï¼ˆæŠ“å–å¤±æ•—æ™‚ä½¿ç”¨ï¼‰

### 3. ç¸½è¦½åŠ ç¸½
- å°è‚¡ + (ç¾è‚¡ Ã— åŒ¯ç‡) = ç¸½è¨ˆ (TWD)
- é¡¯ç¤ºç¸½ç¾å€¼ã€ç¸½æç›Šã€å ±é…¬ç‡

### 4. å°è‚¡å¼µæ•¸è¼¸å…¥
- å¼µæ•¸ + é›¶è‚¡ åˆ†é–‹è¼¸å…¥
- è‡ªå‹•è¨ˆç®—ç¸½è‚¡æ•¸
- é¡¯ç¤ºï¼šã€Œ1å¼µ500è‚¡ã€æ ¼å¼

### 5. è‚¡ç¥¨åç¨±è‡ªå‹•å¸¶å…¥
- è¼¸å…¥ä»£ç¢¼å¾Œ 0.5 ç§’è‡ªå‹•æŸ¥è©¢
- åç¨±æ¬„ä½å”¯è®€
- æŸ¥ç„¡è‚¡ç¥¨æ™‚ç„¡æ³•é€å‡º

### 6. è¿½è¹¤æ¸…å–®è²·è³£æŒ‰éˆ•
- æ¯å€‹è¿½è¹¤é …ç›®æ–°å¢ã€Œè²·ã€ã€Œè³£ã€æŒ‰éˆ•
- é»æ“Šå¾Œè‡ªå‹•é–‹å•Ÿå°æ‡‰å¸‚å ´ Modal
- è‡ªå‹•å¸¶å…¥ä»£ç¢¼å’Œåç¨±

---

## ğŸ—„ï¸ è³‡æ–™åº«

æ–°å¢ä¸‰å¼µè¡¨ï¼ˆé¦–æ¬¡å•Ÿå‹•è‡ªå‹•å»ºç«‹ï¼‰ï¼š

### portfolio_transactionsï¼ˆäº¤æ˜“ç´€éŒ„ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID |
| symbol | VARCHAR(20) | è‚¡ç¥¨ä»£ç¢¼ |
| name | VARCHAR(100) | è‚¡ç¥¨åç¨± |
| market | VARCHAR(10) | tw / us |
| transaction_type | VARCHAR(10) | buy / sell |
| quantity | INTEGER | ç¸½è‚¡æ•¸ |
| price | NUMERIC(12,4) | æˆäº¤åƒ¹ |
| fee | NUMERIC(10,2) | æ‰‹çºŒè²» |
| tax | NUMERIC(10,2) | äº¤æ˜“ç¨… |
| transaction_date | DATE | äº¤æ˜“æ—¥æœŸ |
| note | TEXT | å‚™è¨» |

### portfolio_holdingsï¼ˆæŒè‚¡å½™ç¸½ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID |
| symbol | VARCHAR(20) | è‚¡ç¥¨ä»£ç¢¼ |
| name | VARCHAR(100) | è‚¡ç¥¨åç¨± |
| market | VARCHAR(10) | tw / us |
| total_shares | INTEGER | ç¸½æŒè‚¡ |
| avg_cost | NUMERIC(12,4) | å¹³å‡æˆæœ¬ |
| total_invested | NUMERIC(14,2) | ç¸½æŠ•å…¥ |
| realized_profit | NUMERIC(14,2) | å·²å¯¦ç¾æç›Š |

### exchange_ratesï¼ˆåŒ¯ç‡ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| from_currency | VARCHAR(10) | USD |
| to_currency | VARCHAR(10) | TWD |
| rate | FLOAT | åŒ¯ç‡ |
| updated_at | DATETIME | æ›´æ–°æ™‚é–“ |

---

## ğŸ“¡ API ç«¯é»

### åŒ¯ç‡
| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/portfolio/exchange-rate` | å–å¾—åŒ¯ç‡ |
| PUT | `/api/portfolio/exchange-rate` | æ‰‹å‹•è¨­å®šåŒ¯ç‡ |

### äº¤æ˜“ç´€éŒ„
| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/portfolio/transactions` | æ–°å¢äº¤æ˜“ |
| GET | `/api/portfolio/transactions` | äº¤æ˜“åˆ—è¡¨ |
| GET | `/api/portfolio/transactions/{id}` | å–®ç­†äº¤æ˜“ |
| PUT | `/api/portfolio/transactions/{id}` | æ›´æ–°äº¤æ˜“ |
| DELETE | `/api/portfolio/transactions/{id}` | åˆªé™¤äº¤æ˜“ |

### æŒè‚¡èˆ‡æ‘˜è¦
| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/portfolio/holdings` | æŒè‚¡åˆ—è¡¨ï¼ˆå«ç¾åƒ¹ï¼‰ |
| GET | `/api/portfolio/summary` | æŠ•è³‡æ‘˜è¦ï¼ˆå«åŒ¯ç‡æ›ç®—ï¼‰ |

---

## ğŸ”§ æ•´åˆæ–¹å¼

1. å°‡ `app/` ç›®éŒ„ä¸‹çš„æª”æ¡ˆè¤‡è£½åˆ°å°ˆæ¡ˆå°æ‡‰ä½ç½®
2. å°‡ `static/dashboard.html` è¦†è“‹å°ˆæ¡ˆä¸­çš„åŒåæª”æ¡ˆ
3. é‡æ–°éƒ¨ç½²ï¼ˆè³‡æ–™åº«è¡¨æœƒè‡ªå‹•å»ºç«‹ï¼‰

---

## â° æ’ç¨‹ä»»å‹™

| æ™‚é–“ | ä»»å‹™ |
|------|------|
| æ¯ 10 åˆ†é˜ | åƒ¹æ ¼å¿«å–æ›´æ–° |
| é€±ä¸€~äº” 13:35 | å°è‚¡æ”¶ç›¤æ›´æ–° |
| é€±äºŒ~å…­ 05:05 | ç¾è‚¡æ”¶ç›¤æ›´æ–° |
| **æ¯å¤© 09:00** | åŒ¯ç‡æ›´æ–°ï¼ˆæ—©ï¼‰ |
| **æ¯å¤© 12:00** | åŒ¯ç‡æ›´æ–°ï¼ˆä¸­ï¼‰ |
| **æ¯å¤© 17:00** | åŒ¯ç‡æ›´æ–°ï¼ˆæ™šï¼‰ |

---

## âœ… é©—æ”¶æ¸…å–®

### å€‹äººæŠ•è³‡è¨˜éŒ„
- [x] å´é‚Šæ¬„é¡¯ç¤ºã€Œå€‹äººæŠ•è³‡è¨˜éŒ„ã€
- [x] å°è‚¡/ç¾è‚¡åˆ†é–‹å€å¡Š
- [x] å„è‡ªæœ‰ã€Œæ–°å¢ã€æŒ‰éˆ•
- [x] å°è‚¡ï¼šå¼µæ•¸ + é›¶è‚¡è¼¸å…¥
- [x] ç¾è‚¡ï¼šè‚¡æ•¸è¼¸å…¥
- [x] è‚¡ç¥¨ä»£ç¢¼è‡ªå‹•æŸ¥è©¢åç¨±
- [x] åç¨±æ¬„ä½å”¯è®€
- [x] æŠ•è³‡ç¸½è¦½ï¼ˆåŒ¯ç‡æ›ç®—ï¼‰
- [x] æŒè‚¡ç¸½è¦½ / å°è‚¡ç´€éŒ„ / ç¾è‚¡ç´€éŒ„ ä¸‰å€‹ Tab

### è¿½è¹¤æ¸…å–®
- [x] æ¯å€‹é …ç›®æ–°å¢ã€Œè²·ã€ã€Œè³£ã€æŒ‰éˆ•
- [x] é»æ“Šè‡ªå‹•é–‹å•Ÿå°æ‡‰ Modal
- [x] è‡ªå‹•å¸¶å…¥ä»£ç¢¼å’Œåç¨±

### åŒ¯ç‡
- [x] æ¯å¤© 3 æ¬¡è‡ªå‹•æ›´æ–°
- [x] ç¸½è¦½é¡¯ç¤ºåŒ¯ç‡å’Œæ›´æ–°æ™‚é–“

### BTC å¡ç‰‡
- [x] å„€è¡¨æ¿é¡¯ç¤º BTC åƒ¹æ ¼
- [x] å‹•æ…‹èƒŒæ™¯è‰²
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260113-007-portfolio.md  â­â­â­
> ğŸ’¼ SELA æ›´æ–°åŒ… - æŠ•è³‡çµ„åˆç®¡ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ’¼ SELA æ›´æ–°åŒ… - æŠ•è³‡çµ„åˆç®¡ç†

> æ–‡ä»¶ç·¨è™Ÿ: 20260113-007-portfolio  
> å»ºç«‹æ—¥æœŸ: 2026-01-13  
> åŠŸèƒ½: åŠŸèƒ½ 2 - å€‹äººäº¤æ˜“ç®¡ç†

---

## ğŸ“¦ æª”æ¡ˆæ¸…å–®

```
app/
â”œâ”€â”€ main.py              â† è¦†è“‹ï¼ˆè¨»å†Š portfolio_routerï¼‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py      â† è¦†è“‹ï¼ˆåŒ¯å‡ºæ–° Modelï¼‰
â”‚   â””â”€â”€ portfolio.py     â† æ–°å¢
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ __init__.py      â† è¦†è“‹ï¼ˆåŒ¯å‡ºæ–° Routerï¼‰
â”‚   â””â”€â”€ portfolio.py     â† æ–°å¢
â””â”€â”€ services/
    â””â”€â”€ portfolio_service.py  â† æ–°å¢

static/
â””â”€â”€ dashboard.html       â† è¦†è“‹ï¼ˆå« BTC å¡ç‰‡ + æŠ•è³‡çµ„åˆé é¢ï¼‰
```

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. æŠ•è³‡çµ„åˆé é¢

ä½ç½®ï¼šå´é‚Šæ¬„ã€ŒæŠ•è³‡çµ„åˆã€é¸é …

**åŠŸèƒ½ç‰¹è‰²ï¼š**
- æŒè‚¡ç¸½è¦½ï¼ˆåˆ†å°è‚¡/ç¾è‚¡ï¼‰
- äº¤æ˜“ç´€éŒ„ç®¡ç†ï¼ˆæ–°å¢/ç·¨è¼¯/åˆªé™¤ï¼‰
- æŠ•è³‡æ‘˜è¦ï¼ˆç¸½æŠ•å…¥ã€ç¾å€¼ã€æç›Šã€å ±é…¬ç‡ï¼‰
- æœªå¯¦ç¾æç›Šå³æ™‚è¨ˆç®—ï¼ˆå¾åƒ¹æ ¼å¿«å–è®€å–ï¼‰
- å·²å¯¦ç¾æç›Šè¿½è¹¤

### 2. BTC åƒ¹æ ¼å¡ç‰‡

ä½ç½®ï¼šå„€è¡¨æ¿é é¢ï¼Œææ‡¼è²ªå©ªæŒ‡æ•¸ä¸‹æ–¹

**åŠŸèƒ½ç‰¹è‰²ï¼š**
- å³æ™‚ BTC åƒ¹æ ¼
- 24h/é€±/æœˆæ¼²è·Œå¹…
- å‹•æ…‹èƒŒæ™¯è‰²
- æ¯ 60 ç§’è‡ªå‹•æ›´æ–°

---

## ğŸ—„ï¸ è³‡æ–™åº«

æ–°å¢å…©å¼µè¡¨ï¼ˆé¦–æ¬¡å•Ÿå‹•è‡ªå‹•å»ºç«‹ï¼‰ï¼š

### portfolio_transactionsï¼ˆäº¤æ˜“ç´€éŒ„ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID |
| symbol | VARCHAR(20) | è‚¡ç¥¨ä»£ç¢¼ |
| name | VARCHAR(100) | è‚¡ç¥¨åç¨± |
| market | VARCHAR(10) | tw / us |
| transaction_type | VARCHAR(10) | buy / sell |
| quantity | INTEGER | è‚¡æ•¸ |
| price | NUMERIC(12,4) | æˆäº¤åƒ¹ |
| fee | NUMERIC(10,2) | æ‰‹çºŒè²» |
| tax | NUMERIC(10,2) | äº¤æ˜“ç¨… |
| transaction_date | DATE | äº¤æ˜“æ—¥æœŸ |
| note | TEXT | å‚™è¨» |

### portfolio_holdingsï¼ˆæŒè‚¡å½™ç¸½ï¼‰
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID |
| symbol | VARCHAR(20) | è‚¡ç¥¨ä»£ç¢¼ |
| name | VARCHAR(100) | è‚¡ç¥¨åç¨± |
| market | VARCHAR(10) | tw / us |
| total_shares | INTEGER | ç¸½æŒè‚¡ |
| avg_cost | NUMERIC(12,4) | å¹³å‡æˆæœ¬ |
| total_invested | NUMERIC(14,2) | ç¸½æŠ•å…¥ |
| realized_profit | NUMERIC(14,2) | å·²å¯¦ç¾æç›Š |

---

## ğŸ“¡ æ–°å¢ API

### äº¤æ˜“ç´€éŒ„

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/portfolio/transactions` | æ–°å¢äº¤æ˜“ |
| GET | `/api/portfolio/transactions` | äº¤æ˜“åˆ—è¡¨ |
| GET | `/api/portfolio/transactions/{id}` | å–®ç­†äº¤æ˜“ |
| PUT | `/api/portfolio/transactions/{id}` | æ›´æ–°äº¤æ˜“ |
| DELETE | `/api/portfolio/transactions/{id}` | åˆªé™¤äº¤æ˜“ |

### æŒè‚¡èˆ‡æ‘˜è¦

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/portfolio/holdings` | æŒè‚¡åˆ—è¡¨ï¼ˆå«ç¾åƒ¹ï¼‰ |
| GET | `/api/portfolio/summary` | æŠ•è³‡æ‘˜è¦ |

---

## ğŸ”§ æ•´åˆæ–¹å¼

1. å°‡ `app/` ç›®éŒ„ä¸‹çš„æª”æ¡ˆè¤‡è£½åˆ°å°ˆæ¡ˆå°æ‡‰ä½ç½®
2. å°‡ `static/dashboard.html` è¦†è“‹å°ˆæ¡ˆä¸­çš„åŒåæª”æ¡ˆ
3. é‡æ–°éƒ¨ç½²ï¼ˆè³‡æ–™åº«è¡¨æœƒè‡ªå‹•å»ºç«‹ï¼‰

---

## âœ… é©—æ”¶æ¸…å–®

### æŠ•è³‡çµ„åˆ
- [x] å´é‚Šæ¬„é¡¯ç¤ºã€ŒæŠ•è³‡çµ„åˆã€é¸é …
- [x] æŒè‚¡ç¸½è¦½ï¼ˆå°è‚¡/ç¾è‚¡åˆ†é–‹ï¼‰
- [x] é¡¯ç¤ºç¾åƒ¹å’Œæœªå¯¦ç¾æç›Š
- [x] æ–°å¢äº¤æ˜“ Modal
- [x] ç·¨è¼¯/åˆªé™¤äº¤æ˜“
- [x] æŠ•è³‡æ‘˜è¦çµ±è¨ˆ

### BTC å¡ç‰‡
- [x] å„€è¡¨æ¿é¡¯ç¤º BTC åƒ¹æ ¼
- [x] æ¼²è·Œå¹…é¡¯ç¤º
- [x] å‹•æ…‹èƒŒæ™¯è‰²
- [x] è‡ªå‹•æ›´æ–°

---

## ğŸ“ æ³¨æ„äº‹é …

1. **åƒ¹æ ¼ä¾†æº**ï¼šæŒè‚¡ç¾åƒ¹ä¾†è‡ª `stock_price_cache` è¡¨ï¼Œéœ€ç¢ºä¿åƒ¹æ ¼å¿«å–æ’ç¨‹æ­£å¸¸é‹ä½œ
2. **æç›Šè¨ˆç®—**ï¼šæ¡ç”¨ã€Œå…ˆé€²å…ˆå‡ºã€(FIFO) æ–¹å¼è¨ˆç®—å·²å¯¦ç¾æç›Š
3. **è³‡æ–™éš”é›¢**ï¼šæ¯å€‹ç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±çš„äº¤æ˜“ç´€éŒ„
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260114-008-query-cache.md  â­â­â­
> æŸ¥è©¢çµæœå¿«å–åŠŸèƒ½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# æŸ¥è©¢çµæœå¿«å–åŠŸèƒ½

> æ–‡ä»¶ç·¨è™Ÿ: 20260114-008-query-cache  
> å»ºç«‹æ—¥æœŸ: 2026-01-14

## åŠŸèƒ½èªªæ˜

å°‡æŸ¥è©¢éçš„è‚¡ç¥¨/åŠ å¯†è²¨å¹£è‡ªå‹•å¯«å…¥ `StockPriceCache` å¿«å–è¡¨ã€‚

### ç‰¹é»
- âœ… æŸ¥è©¢éçš„è‚¡ç¥¨æœƒè¢«å¿«å–
- âœ… æ‰€æœ‰ç”¨æˆ¶å…±ç”¨å¿«å–
- âŒ ä¸æœƒè‡ªå‹•æ›´æ–°ï¼ˆåªæœ‰è¿½è¹¤æ¸…å–®æ‰æœƒï¼‰
- âŒ ç®¡ç†å“¡ç™»å…¥åªæ›´æ–°è¿½è¹¤æ¸…å–®çš„è‚¡ç¥¨

---

## æ–°å¢æª”æ¡ˆ

### `app/services/cache_helper.py`

å·²åŒ…å«åœ¨ zip ä¸­ï¼Œç›´æ¥éƒ¨ç½²å³å¯ã€‚

---

## ä¿®æ”¹ç¾æœ‰æª”æ¡ˆ

### 1. `app/routers/stock.py`

åœ¨ `get_stock_analysis` å‡½æ•¸çš„ `return` èªå¥**ä¹‹å‰**åŠ å…¥ï¼š

```python
# === åœ¨ return ä¹‹å‰åŠ å…¥ä»¥ä¸‹ä»£ç¢¼ ===

# ğŸ†• å°‡æŸ¥è©¢çµæœå¯«å…¥å¿«å–
from app.services.cache_helper import cache_stock_price

day_change = calc_change(1)
prev_close = float(df.iloc[-2]['close_raw']) if len(df) > 1 else None
change_amount = current_price - prev_close if prev_close else None

cache_stock_price(
    symbol=symbol,
    name=stock_name,
    price=current_price,
    prev_close=prev_close,
    change=change_amount,
    change_pct=day_change,
    volume=volume_today
)

# === åŠ å…¥çµæŸ ===

return {
    "success": True,
    ...
```

å®Œæ•´ä½ç½®åƒè€ƒï¼ˆç´„åœ¨ç¬¬ 180-200 è¡Œï¼‰ï¼š

```python
        logger.info(f"{symbol} æŸ¥è©¢å®Œæˆï¼Œè©•åˆ†: {rating}")
        
        # ç¢ºä¿ name æ­£ç¢ºç²å–
        stock_name = ""
        if info:
            stock_name = info.get("name", "")
        if not stock_name:
            from app.data_sources.yahoo_finance import TAIWAN_STOCK_NAMES
            stock_code = symbol.replace(".TW", "").replace(".TWO", "")
            stock_name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
        
        # ğŸ†• === åŠ å…¥å¿«å–ä»£ç¢¼ START ===
        from app.services.cache_helper import cache_stock_price
        
        day_change = calc_change(1)
        prev_close = float(df.iloc[-2]['close_raw']) if len(df) > 1 else None
        change_amount = current_price - prev_close if prev_close else None
        
        cache_stock_price(
            symbol=symbol,
            name=stock_name,
            price=current_price,
            prev_close=prev_close,
            change=change_amount,
            change_pct=day_change,
            volume=volume_today
        )
        # ğŸ†• === åŠ å…¥å¿«å–ä»£ç¢¼ END ===
        
        return {
            "success": True,
            "symbol": symbol,
            ...
```

---

### 2. `app/routers/crypto.py`

åœ¨ `get_crypto_analysis` å‡½æ•¸çš„ `return` èªå¥**ä¹‹å‰**åŠ å…¥ï¼š

```python
# === åœ¨ return ä¹‹å‰åŠ å…¥ä»¥ä¸‹ä»£ç¢¼ ===

# ğŸ†• å°‡æŸ¥è©¢çµæœå¯«å…¥å¿«å–
from app.services.cache_helper import cache_crypto_price

cache_crypto_price(
    symbol=symbol,
    name=info.get("name", symbol) if info else symbol,
    price=current_price,
    change_pct=calc_change(1),
    volume=info.get("total_volume") if info else None
)

# === åŠ å…¥çµæŸ ===

return {
    "success": True,
    ...
```

---

## é©—è­‰æ–¹å¼

1. æŸ¥è©¢ä¸€å€‹æ–°è‚¡ç¥¨ï¼ˆå¦‚ NVDAï¼‰
2. æª¢æŸ¥è³‡æ–™åº«ï¼š
   ```sql
   SELECT * FROM stock_price_cache WHERE symbol = 'NVDA';
   ```
3. æ‡‰è©²çœ‹åˆ°å‰›æ‰æŸ¥è©¢çš„åƒ¹æ ¼å·²è¢«å¿«å–

---

## è³‡æ–™æµç¨‹

```
ç”¨æˆ¶æŸ¥è©¢ AAPL
    â”‚
    â”œâ”€â–º Yahoo Finance API å–å¾—è³‡æ–™
    â”‚
    â”œâ”€â–º è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
    â”‚
    â”œâ”€â–º ğŸ†• å¯«å…¥ StockPriceCacheï¼ˆæ–°å¢ï¼‰
    â”‚
    â””â”€â–º å›å‚³çµæœçµ¦å‰ç«¯


ç®¡ç†å“¡ç™»å…¥
    â”‚
    â””â”€â–º æ›´æ–°è¿½è¹¤æ¸…å–®çš„è‚¡ç¥¨ï¼ˆå¾ Watchlist è¡¨æ’ˆï¼‰
        â”‚
        â””â”€â–º ä¸æœƒæ›´æ–°ã€ŒåªæŸ¥è©¢éã€çš„è‚¡ç¥¨ âœ“
```

---

## æ³¨æ„äº‹é …

1. `cache_helper.py` ä½¿ç”¨ try-except åŒ…è£ï¼Œå¿«å–å¤±æ•—ä¸å½±éŸ¿æŸ¥è©¢
2. å¿«å–å¯«å…¥æ˜¯åŒæ­¥çš„ï¼Œä½†å¾ˆå¿«ï¼ˆå–®æ¬¡è³‡æ–™åº« upsertï¼‰
3. å¦‚æœæœªä¾†éœ€è¦éåŒæ­¥ï¼Œå¯æ”¹ç”¨ `background_tasks.add_task()`
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/20260114-011-subscription-feature.md  â­â­â­
> SELA è¨‚é–±ç²¾é¸åŠŸèƒ½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA è¨‚é–±ç²¾é¸åŠŸèƒ½

## åŠŸèƒ½èªªæ˜

è‡ªå‹•æŠ“å–ã€Œç¾è‚¡å¤§å”ã€Substack æ–‡ç« ä¸­æåŠçš„è‚¡ç¥¨ä»£ç¢¼ï¼Œç”¨æˆ¶å¯è¨‚é–±æŸ¥çœ‹ã€‚

### ç‰¹é»

- **è‡ªå‹•æŠ“å–**ï¼šæ¯å°æ™‚è‡ªå‹•æŠ“å–æ–°æ–‡ç« 
- **30 å¤©æœ‰æ•ˆæœŸ**ï¼šæ¯æ¬¡è¢«æåŠé‡æ–°è¨ˆç®—ï¼Œç´¯è¨ˆæåŠæ¬¡æ•¸
- **è¨‚é–±åˆ¶**ï¼šç”¨æˆ¶è‡ªé¸æ˜¯å¦è¨‚é–±
- **æ•´åˆåƒ¹æ ¼**ï¼šé¡¯ç¤ºå³æ™‚åƒ¹æ ¼ï¼ˆä¾†è‡ªå¿«å–ï¼‰

---

## æª”æ¡ˆçµæ§‹

```
app/
â”œâ”€â”€ database.py                         # è³‡æ–™åº«ï¼ˆå«é·ç§»ï¼‰
â”œâ”€â”€ models/
â”‚   â””â”€â”€ subscription.py                 # Model: è¨‚é–±æºã€ç²¾é¸ã€ç”¨æˆ¶è¨‚é–±
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ rss_fetcher.py                  # RSS çˆ¬èŸ²
â”‚   â””â”€â”€ subscription_service.py         # è¨‚é–±æœå‹™
â”œâ”€â”€ routers/
â”‚   â””â”€â”€ subscription.py                 # API è·¯ç”±
â””â”€â”€ tasks/
    â””â”€â”€ subscription_tasks.py           # æ’ç¨‹ä»»å‹™
docs/
â””â”€â”€ 20260114-011-subscription-feature.md
```

---

## éƒ¨ç½²æ­¥é©Ÿ

### 1. è¦†è“‹æª”æ¡ˆ

è§£å£“å¾Œè¦†è“‹åˆ°å°ˆæ¡ˆç›®éŒ„

### 2. åœ¨ main.py è¨»å†Šè·¯ç”±

```python
from app.routers import subscription
app.include_router(subscription.router)
```

### 3. åœ¨ main.py åŠ å…¥æ’ç¨‹ä»»å‹™

æ‰¾åˆ° `scheduler` è¨­å®šçš„åœ°æ–¹ï¼ŒåŠ å…¥ï¼š

```python
from app.tasks.subscription_tasks import scheduled_fetch_subscriptions

# æ¯å°æ™‚æŠ“å–è¨‚é–±æº
scheduler.add_job(
    scheduled_fetch_subscriptions,
    'interval',
    hours=1,
    id='subscription_fetch',
    name='è¨‚é–±æºæŠ“å–(æ¯å°æ™‚)',
)
```

### 4. å®‰è£ä¾è³´

```bash
pip install feedparser beautifulsoup4
```

æˆ–åŠ å…¥ `requirements.txt`ï¼š

```
feedparser>=6.0.0
beautifulsoup4>=4.12.0
```

### 5. éƒ¨ç½²å¾Œåˆå§‹åŒ–

è¨ªå•ä¸€æ¬¡ï¼ˆå›æº¯æŠ“å– 30 å¤©ï¼‰ï¼š

```
POST /api/subscription/admin/init
POST /api/subscription/admin/fetch?backfill=true
```

---

## API èªªæ˜

### è¨‚é–±æº

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/api/subscription/sources` | æ‰€æœ‰è¨‚é–±æº |
| GET | `/api/subscription/sources/{slug}` | å–®ä¸€è¨‚é–±æº |

### ç”¨æˆ¶è¨‚é–±

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/api/subscription/my` | æˆ‘çš„è¨‚é–± |
| POST | `/api/subscription/subscribe/{source_id}` | è¨‚é–± |
| DELETE | `/api/subscription/unsubscribe/{source_id}` | å–æ¶ˆè¨‚é–± |

### ç²¾é¸åˆ—è¡¨

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| GET | `/api/subscription/picks` | æˆ‘çš„è¨‚é–±ç²¾é¸ï¼ˆéœ€ç™»å…¥ï¼‰|
| GET | `/api/subscription/picks/{source_slug}` | ç‰¹å®šä¾†æºç²¾é¸ï¼ˆå…¬é–‹ï¼‰|

### ç®¡ç†

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| POST | `/api/subscription/admin/init` | åˆå§‹åŒ–è¨‚é–±æº |
| POST | `/api/subscription/admin/fetch?backfill=true` | å›æº¯æŠ“å– |

---

## è³‡æ–™æµç¨‹

```
æ¯å°æ™‚æ’ç¨‹
    â”‚
    â”œâ”€â–º GET unclestocknotes.substack.com/feed
    â”‚
    â”œâ”€â–º è§£æ RSS æ–‡ç« 
    â”‚
    â”œâ”€â–º æ­£å‰‡æå–è‚¡ç¥¨ä»£ç¢¼
    â”‚   - $AAPL æ ¼å¼ï¼ˆé«˜å¯ä¿¡åº¦ï¼‰
    â”‚   - (AAPL) æ‹¬è™Ÿæ ¼å¼
    â”‚   - å·²çŸ¥ä»£ç¢¼ç™½åå–®
    â”‚
    â”œâ”€â–º éæ¿¾å¸¸è¦‹è©ï¼ˆTHE, AND, ETF...ï¼‰
    â”‚
    â””â”€â–º å¯«å…¥ auto_picks
        - æ–°ä»£ç¢¼ï¼šå»ºç«‹ï¼Œexpires_at = 30å¤©å¾Œ
        - èˆŠä»£ç¢¼ï¼šæ›´æ–° last_seen_atã€é‡ç®— expires_atã€mention_count++
```

---

## æåŠæ¬¡æ•¸èªªæ˜

```
NVDA ç¬¬ä¸€æ¬¡æåŠ (1/14)
â”œâ”€â–º expires_at = 2/14
â”œâ”€â–º mention_count = 1

NVDA ç¬¬äºŒæ¬¡æåŠ (1/20)
â”œâ”€â–º expires_at = 2/20ï¼ˆé‡ç®—ï¼‰
â”œâ”€â–º mention_count = 2

NVDA ç¬¬ä¸‰æ¬¡æåŠ (2/15)
â”œâ”€â–º expires_at = 3/15ï¼ˆé‡ç®—ï¼‰
â”œâ”€â–º mention_count = 3
```

---

## å‰ç«¯æ•´åˆï¼ˆå¾…å®Œæˆï¼‰

ä¹‹å¾Œæœƒåœ¨ dashboard.html æ–°å¢ã€ŒğŸ“¡ è¨‚é–±ç²¾é¸ã€Tab
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/DASHBOARD_OPTIMIZATION.md  â­â­â­
> ğŸ”§ Dashboard.html å„ªåŒ–èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ Dashboard.html å„ªåŒ–èªªæ˜

## å„ªåŒ–æ‘˜è¦

| é …ç›® | åŸå§‹ | å„ªåŒ–å¾Œ | è®ŠåŒ– |
|------|------|--------|------|
| dashboard.html | 1908 è¡Œ | 1419 è¡Œ | **-489 è¡Œ (-26%)** |
| modals.js (æ–°å¢) | - | 628 è¡Œ | æ–°å¢æª”æ¡ˆ |

## è®Šæ›´å…§å®¹

### 1. ç§»é™¤çš„ Modal (ç´„ 500 è¡Œ)
ä»¥ä¸‹ Modal å·²å¾ `dashboard.html` ç§»è‡³ `static/js/modals.js`ï¼š

- `chartFullscreen` - å…¨è¢å¹•åœ–è¡¨
- `indexChartModal` - æŒ‡æ•¸åœ–è¡¨ Modal
- `sentimentChartModal` - æƒ…ç·’åœ–è¡¨ Modal
- `returnsModal` - å¹´åŒ–å ±é…¬ç‡ Modal
- `twTransactionModal` - å°è‚¡äº¤æ˜“ Modal (106 è¡Œ)
- `usTransactionModal` - ç¾è‚¡äº¤æ˜“ Modal (93 è¡Œ)
- `addWatchlistModal` - æ–°å¢è¿½è¹¤æ¸…å–® Modal
- `importWatchlistModal` - åŒ¯å…¥è¿½è¹¤æ¸…å–® Modal
- `importPortfolioModal` - åŒ¯å…¥æŒè‚¡äº¤æ˜“ Modal
- `targetPriceModal` - ç›®æ¨™åƒ¹è¨­å®š Modal
- `toast` - Toast é€šçŸ¥
- `tagEditModal` - æ¨™ç±¤ç·¨è¼¯ Modal
- `assignTagModal` - æ¨™ç±¤æŒ‡æ´¾ Modal

### 2. æ–°å¢æª”æ¡ˆ
- `static/js/modals.js` - Modal å‹•æ…‹ç”Ÿæˆæ¨¡çµ„

### 3. ä¿®æ”¹çš„éƒ¨åˆ†
åœ¨ `dashboard.html` ä¸­ï¼š
- æ–°å¢ `<div id="modal-container"></div>` ä½œç‚º Modal å®¹å™¨
- æ–°å¢ `<script src="/static/js/modals.js"></script>` å¼•ç”¨

## éƒ¨ç½²æ­¥é©Ÿ

1. **è¤‡è£½æ–°æª”æ¡ˆ**
   ```bash
   cp static/js/modals.js å°ˆæ¡ˆç›®éŒ„/static/js/
   ```

2. **æ›¿æ› dashboard.html**
   ```bash
   cp dashboard.html å°ˆæ¡ˆç›®éŒ„/static/dashboard.html
   ```

3. **æ¸¬è©¦åŠŸèƒ½**
   - ç¢ºèªæ‰€æœ‰ Modal å¯ä»¥æ­£å¸¸é–‹å•Ÿå’Œé—œé–‰
   - ç¢ºèªå°è‚¡/ç¾è‚¡äº¤æ˜“åŠŸèƒ½æ­£å¸¸
   - ç¢ºèªæ¨™ç±¤åŠŸèƒ½æ­£å¸¸
   - ç¢ºèªè¿½è¹¤æ¸…å–®åŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½æ­£å¸¸

## æŠ€è¡“èªªæ˜

### modals.js é‹ä½œåŸç†

```javascript
// modals.js åœ¨ DOMContentLoaded æ™‚è‡ªå‹•åˆå§‹åŒ–
// å°‡æ‰€æœ‰ Modal HTML æ³¨å…¥åˆ° #modal-container

window.initAllModals();  // è‡ªå‹•èª¿ç”¨
```

### å„ªé»

1. **å¯ç¶­è­·æ€§æå‡** - Modal é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹ä¸€è™•å³å¯
2. **è¼‰å…¥å„ªåŒ–** - HTML åˆå§‹è¼‰å…¥å¤§å°æ¸›å°‘ 26%
3. **é—œæ³¨é»åˆ†é›¢** - HTML çµæ§‹èˆ‡ Modal æ¨¡æ¿åˆ†é›¢
4. **æŒ‰éœ€è¼‰å…¥** - å¯é€²ä¸€æ­¥å„ªåŒ–ç‚ºæŒ‰éœ€è¼‰å…¥ Modal

## å›æ»¾æ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»¾ï¼Œåªéœ€ï¼š
1. é‚„åŸåŸå§‹çš„ `dashboard.html`
2. ç§»é™¤ `static/js/modals.js`ï¼ˆä¸éœ€è¦åˆªé™¤ï¼Œåªæ˜¯ä¸å†ä½¿ç”¨ï¼‰

---

*å„ªåŒ–æ™‚é–“ï¼š2026-01-16*
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/OPTIMIZATION_GUIDE.md  â­â­â­
> ğŸ”§ SELA Dashboard å®‰å…¨å„ªåŒ–ç‰ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ SELA Dashboard å®‰å…¨å„ªåŒ–ç‰ˆ

## å„ªåŒ–æ‘˜è¦

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | èªªæ˜ |
|------|--------|--------|------|
| dashboard.html | 1,908 è¡Œ | **1,419 è¡Œ** | -26% |
| Modal ä½ç½® | å…§åµŒ HTML | modals.js | å‹•æ…‹è¼‰å…¥ |

æ­¤ç‰ˆæœ¬**ä¿ç•™æ‰€æœ‰åŠŸèƒ½**ï¼Œåƒ…å°‡ Modal HTML ç§»åˆ° JavaScript å‹•æ…‹ç”Ÿæˆã€‚

---

## æª”æ¡ˆçµæ§‹

```
static/
â”œâ”€â”€ dashboard.html    # å„ªåŒ–å¾Œä¸»é é¢ (1,419 è¡Œ)
â””â”€â”€ js/
    â””â”€â”€ modals.js     # æ–°å¢ï¼šModal å‹•æ…‹ç”Ÿæˆ (628 è¡Œ)
```

---

## éƒ¨ç½²æ­¥é©Ÿ

### 1. å‚™ä»½åŸæª”æ¡ˆ
```bash
cp static/dashboard.html static/dashboard.html.backup
```

### 2. è¤‡è£½æ–°æª”æ¡ˆ
```bash
cp static/dashboard.html ä½ çš„å°ˆæ¡ˆ/static/
cp static/js/modals.js ä½ çš„å°ˆæ¡ˆ/static/js/
```

### 3. é©—è­‰
- æ‰€æœ‰ section åŠŸèƒ½æ‡‰æ­£å¸¸é‹ä½œ
- æ‰€æœ‰ Modal å°è©±æ¡†æ‡‰æ­£å¸¸é–‹å•Ÿ/é—œé–‰

---

## ç§»å‡ºçš„ Modal (å…± 13 å€‹)

1. `chartFullscreen` - å…¨è¢å¹•è‚¡ç¥¨åœ–è¡¨
2. `indexChartModal` - æŒ‡æ•¸èµ°å‹¢åœ–
3. `sentimentChartModal` - æƒ…ç·’æŒ‡æ•¸åœ–è¡¨
4. `returnsModal` - å ±é…¬ç‡è©³æƒ…
5. `twTransactionModal` - å°è‚¡äº¤æ˜“è¡¨å–®
6. `usTransactionModal` - ç¾è‚¡äº¤æ˜“è¡¨å–®
7. `addWatchlistModal` - æ–°å¢è¿½è¹¤æ¸…å–®
8. `importWatchlistModal` - åŒ¯å…¥è¿½è¹¤æ¸…å–®
9. `importPortfolioModal` - åŒ¯å…¥æŒè‚¡ç´€éŒ„
10. `targetPriceModal` - ç›®æ¨™åƒ¹è¨­å®š
11. `toast` - Toast é€šçŸ¥
12. `tagEditModal` - æ¨™ç±¤ç·¨è¼¯
13. `assignTagModal` - æŒ‡æ´¾æ¨™ç±¤

---

## å›æ»¾æ–¹æ¡ˆ

```bash
cp static/dashboard.html.backup static/dashboard.html
```

---

*æ›´æ–°æ—¥æœŸï¼š2026-01-16*
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/optimization_report.md  â­â­â­
> ğŸ”§ SELA ç³»çµ± - ç¨‹å¼ç¢¼å„ªåŒ–åˆ†æå ±å‘Š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ SELA ç³»çµ± - ç¨‹å¼ç¢¼å„ªåŒ–åˆ†æå ±å‘Š

> åˆ†ææ—¥æœŸï¼š2026-01-16  
> å°ˆæ¡ˆï¼šè‡ªå‹•é¸è‚¡ç³»çµ± (SELA)

---

## ğŸ“Š è¶…é 500 è¡Œçš„ç¨‹å¼æª”æ¡ˆçµ±è¨ˆ

| å„ªå…ˆç´š | æª”æ¡ˆ | è¡Œæ•¸ | ä¸»è¦å•é¡Œ |
|--------|------|------|----------|
| ğŸ”´ P0 | `static/dashboard.html` | 1908 | å–®ä¸€ HTML åŒ…å«æ‰€æœ‰é é¢ï¼Œé›£ä»¥ç¶­è­· |
| ğŸ”´ P0 | `static/dashboard-mobile.html` | 1333 | èˆ‡ dashboard.html é«˜åº¦é‡è¤‡ |
| ğŸŸ  P1 | `static/js/search.js` | 888 | åŠŸèƒ½éæ–¼é›†ä¸­ï¼Œç¼ºä¹æ¨¡çµ„åŒ– |
| ğŸŸ  P1 | `app/services/indicator_service.py` | 830 | å–®ä¸€ class åŒ…å«æ‰€æœ‰æŒ‡æ¨™è¨ˆç®— |
| ğŸŸ  P1 | `static/js/watchlist.js` | 811 | åŠŸèƒ½éæ–¼é›†ä¸­ |
| ğŸŸ¡ P2 | `app/routers/admin.py` | 690 | Router éæ–¼é¾å¤§ |
| ğŸŸ¡ P2 | `app/cli.py` | 688 | CLI å‘½ä»¤éå¤š |
| ğŸŸ¡ P2 | `static/admin.html` | 677 | å–®ä¸€é é¢éå¤§ |
| ğŸŸ¡ P2 | `static/js/dashboard.js` | 654 | åŠŸèƒ½éæ–¼é›†ä¸­ |
| ğŸŸ¡ P2 | `app/tasks/scheduler.py` | 642 | æ’ç¨‹ä»»å‹™æ··é›œ |
| ğŸŸ¡ P2 | `app/data_sources/yahoo_finance.py` | 621 | è³‡æ–™æºéæ–¼é¾å¤§ |
| ğŸŸ¡ P2 | `app/services/compare_service.py` | 601 | æ¯”è¼ƒæœå‹™éæ–¼è¤‡é›œ |
| ğŸŸ¡ P2 | `static/compare.html` | 597 | é é¢éå¤§ |
| ğŸŸ¡ P2 | `app/routers/watchlist.py` | 591 | Router éæ–¼é¾å¤§ |
| ğŸŸ¢ P3 | `app/services/signal_service.py` | 551 | å¯æ¥å—ï¼Œä½†å»ºè­°æ‹†åˆ† |
| ğŸŸ¢ P3 | `app/services/price_cache_service.py` | 545 | å¯æ¥å—ï¼Œä½†å»ºè­°æ‹†åˆ† |
| ğŸŸ¢ P3 | `app/services/chart_service.py` | 543 | å¯æ¥å— |
| ğŸŸ¢ P3 | `app/services/auth_service.py` | 531 | å¯æ¥å— |
| ğŸŸ¢ P3 | `app/services/stock_service.py` | 501 | å¯æ¥å— |

---

## ğŸ”´ P0 - ç·Šæ€¥å„ªåŒ–ï¼ˆåš´é‡å½±éŸ¿ç¶­è­·æ€§ï¼‰

### 1. `static/dashboard.html` (1908 è¡Œ)

**å•é¡Œåˆ†æï¼š**
- å–®ä¸€ HTML æª”æ¡ˆåŒ…å« 10+ å€‹ä¸åŒé é¢å€å¡Š
- å…§åµŒå¤§é‡ JavaScript å’Œ CSS
- æ¡Œé¢ç‰ˆå’Œæ‰‹æ©Ÿç‰ˆ UI æ··é›œ
- æ¯æ¬¡ä¿®æ”¹éœ€è¦æœå°‹æ•´å€‹æª”æ¡ˆ

**å„ªåŒ–å»ºè­°ï¼š**
```
static/
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ base.html              # åŸºç¤æ¨¡æ¿ï¼ˆhead, å°èˆª, è…³æœ¬å¼•å…¥ï¼‰
â”‚   â”œâ”€â”€ sections/
â”‚   â”‚   â”œâ”€â”€ dashboard.html     # å„€è¡¨æ¿å€å¡Š
â”‚   â”‚   â”œâ”€â”€ search.html        # æœå°‹å€å¡Š
â”‚   â”‚   â”œâ”€â”€ watchlist.html     # è¿½è¹¤æ¸…å–®å€å¡Š
â”‚   â”‚   â”œâ”€â”€ portfolio.html     # æŠ•è³‡çµ„åˆå€å¡Š
â”‚   â”‚   â”œâ”€â”€ compare.html       # æ¯”è¼ƒå€å¡Š
â”‚   â”‚   â”œâ”€â”€ settings.html      # è¨­å®šå€å¡Š
â”‚   â”‚   â””â”€â”€ modals/            # Modal å°è©±æ¡†
â”‚   â”‚       â”œâ”€â”€ add-stock.html
â”‚   â”‚       â”œâ”€â”€ tag-edit.html
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ sidebar.html       # å´é‚Šæ¬„å…ƒä»¶
â”‚       â”œâ”€â”€ navbar.html        # é ‚éƒ¨å°èˆª
â”‚       â””â”€â”€ stock-card.html    # è‚¡ç¥¨å¡ç‰‡å…ƒä»¶
```

**å¯¦ä½œæ–¹å¼ï¼š**
- ä½¿ç”¨ FastAPI çš„ Jinja2 æ¨¡æ¿å¼•æ“
- é€é `{% include %}` çµ„åˆé é¢
- æˆ–ä½¿ç”¨å‰ç«¯æ¡†æ¶å¦‚ Alpine.js çš„å…ƒä»¶ç³»çµ±

---

### 2. `static/dashboard-mobile.html` (1333 è¡Œ)

**å•é¡Œåˆ†æï¼š**
- èˆ‡ `dashboard.html` æœ‰ 70%+ çš„é‡è¤‡ä»£ç¢¼
- æ‰‹æ©Ÿç‰ˆæ‡‰è©²æ˜¯éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œä¸æ˜¯ç¨ç«‹æª”æ¡ˆ
- ä¿®æ”¹åŠŸèƒ½éœ€è¦åŒæ­¥å…©å€‹æª”æ¡ˆ

**å„ªåŒ–å»ºè­°ï¼š**
- **åˆªé™¤æ­¤æª”æ¡ˆ**
- å°‡éŸ¿æ‡‰å¼è¨­è¨ˆæ•´åˆåˆ° `dashboard.html`
- ä½¿ç”¨ Tailwind CSS çš„éŸ¿æ‡‰å¼é¡åˆ¥ (`md:`, `lg:`)
- ä½¿ç”¨ CSS Media Queries è™•ç†å·®ç•°

```html
<!-- æ¡Œé¢ç‰ˆå´é‚Šæ¬„ -->
<aside class="hidden md:block w-64">...</aside>

<!-- æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆª -->
<nav class="fixed bottom-0 md:hidden">...</nav>
```

---

## ğŸŸ  P1 - é‡è¦å„ªåŒ–ï¼ˆå½±éŸ¿é–‹ç™¼æ•ˆç‡ï¼‰

### 3. `static/js/search.js` (888 è¡Œ)

**å•é¡Œåˆ†æï¼š**
- åŒ…å«ï¼šæœå°‹ã€çµæœæ¸²æŸ“ã€å…¨è¢å¹•åœ–è¡¨ã€æˆäº¤é‡åœ–è¡¨ã€MA é€²éšåˆ†æ
- å–®ä¸€ IIFE åŒ…å«æ‰€æœ‰åŠŸèƒ½
- é›£ä»¥ç¨ç«‹æ¸¬è©¦å’Œè¤‡ç”¨

**å„ªåŒ–å»ºè­°ï¼š**
```
static/js/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ search-core.js         # æœå°‹é‚è¼¯ (~150è¡Œ)
â”‚   â”œâ”€â”€ search-render.js       # çµæœæ¸²æŸ“ (~200è¡Œ)
â”‚   â”œâ”€â”€ chart-fullscreen.js    # å…¨è¢å¹•åœ–è¡¨ (~150è¡Œ)
â”‚   â”œâ”€â”€ chart-volume.js        # æˆäº¤é‡åœ–è¡¨ (~100è¡Œ)
â”‚   â””â”€â”€ ma-analysis.js         # MA é€²éšåˆ†æ (~200è¡Œ)
â””â”€â”€ search.js                  # æ•´åˆå…¥å£ (~50è¡Œ)
```

---

### 4. `app/services/indicator_service.py` (830 è¡Œ)

**å•é¡Œåˆ†æï¼š**
- å–®ä¸€ class `IndicatorService` åŒ…å«æ‰€æœ‰æŒ‡æ¨™
- MAã€RSIã€MACDã€KDã€å¸ƒæ—é€šé“ã€OBV å…¨éƒ¨æ··åœ¨ä¸€èµ·
- æ–°å¢æŒ‡æ¨™éœ€è¦ä¿®æ”¹æ­¤å·¨å‹æª”æ¡ˆ

**å„ªåŒ–å»ºè­°ï¼š**
```
app/services/indicators/
â”œâ”€â”€ __init__.py               # çµ±ä¸€å°å‡º
â”œâ”€â”€ base.py                   # åŸºç¤é¡åˆ¥å’Œå…±ç”¨å·¥å…· (~100è¡Œ)
â”œâ”€â”€ ma_indicator.py           # ç§»å‹•å¹³å‡ç·š (~150è¡Œ)
â”œâ”€â”€ rsi_indicator.py          # RSI æŒ‡æ¨™ (~100è¡Œ)
â”œâ”€â”€ macd_indicator.py         # MACD æŒ‡æ¨™ (~100è¡Œ)
â”œâ”€â”€ kd_indicator.py           # KD æŒ‡æ¨™ (~100è¡Œ)
â”œâ”€â”€ bollinger_indicator.py    # å¸ƒæ—é€šé“ (~100è¡Œ)
â”œâ”€â”€ obv_indicator.py          # OBV æŒ‡æ¨™ (~80è¡Œ)
â””â”€â”€ composite_service.py      # çµ„åˆæœå‹™ï¼ˆèª¿ç”¨å„æŒ‡æ¨™ï¼‰(~100è¡Œ)
```

**ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š**
```python
# app/services/indicators/base.py
from abc import ABC, abstractmethod
import pandas as pd

class BaseIndicator(ABC):
    """æŒ‡æ¨™åŸºç¤é¡åˆ¥"""
    
    @abstractmethod
    def calculate(self, df: pd.DataFrame) -> pd.DataFrame:
        pass
    
    @abstractmethod
    def get_signal(self, df: pd.DataFrame) -> dict:
        pass


# app/services/indicators/rsi_indicator.py
class RSIIndicator(BaseIndicator):
    def __init__(self, period: int = 14, overbought: int = 70, oversold: int = 30):
        self.period = period
        self.overbought = overbought
        self.oversold = oversold
    
    def calculate(self, df: pd.DataFrame) -> pd.DataFrame:
        # RSI è¨ˆç®—é‚è¼¯
        ...
```

---

### 5. `static/js/watchlist.js` (811 è¡Œ)

**å„ªåŒ–å»ºè­°ï¼š**
```
static/js/
â”œâ”€â”€ watchlist/
â”‚   â”œâ”€â”€ index.js              # å…¥å£
â”‚   â”œâ”€â”€ list-manager.js       # æ¸…å–®ç®¡ç† CRUD
â”‚   â”œâ”€â”€ price-display.js      # åƒ¹æ ¼é¡¯ç¤ºå’Œæ›´æ–°
â”‚   â”œâ”€â”€ tag-manager.js        # æ¨™ç±¤ç®¡ç†
â”‚   â””â”€â”€ export-import.js      # åŒ¯å‡ºåŒ¯å…¥åŠŸèƒ½
```

---

## ğŸŸ¡ P2 - å»ºè­°å„ªåŒ–ï¼ˆæ”¹å–„ä»£ç¢¼å“è³ªï¼‰

### 6. `app/routers/admin.py` (690 è¡Œ)

**å„ªåŒ–å»ºè­°ï¼š**
```
app/routers/admin/
â”œâ”€â”€ __init__.py              # ä¸»è·¯ç”±æ•´åˆ
â”œâ”€â”€ user_management.py       # ç”¨æˆ¶ç®¡ç† API
â”œâ”€â”€ system_config.py         # ç³»çµ±è¨­å®š API
â”œâ”€â”€ data_management.py       # è³‡æ–™ç®¡ç† API
â””â”€â”€ statistics.py            # çµ±è¨ˆå ±è¡¨ API
```

---

### 7. `app/tasks/scheduler.py` (642 è¡Œ)

**å•é¡Œåˆ†æï¼š**
- åŒ…å«å°è‚¡åç¨±å°ç…§è¡¨ï¼ˆç´„ 200 è¡Œï¼‰
- æ··é›œå¤šç¨®æ’ç¨‹ä»»å‹™
- å°è‚¡åç¨±æ‡‰è©²åœ¨è³‡æ–™åº«æˆ–ç¨ç«‹è¨­å®šæª”

**å„ªåŒ–å»ºè­°ï¼š**
```
app/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ taiwan_stock_names.json  # å°è‚¡åç¨±å°ç…§ï¼ˆç§»å‡ºä»£ç¢¼ï¼‰
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ scheduler.py              # æ’ç¨‹å™¨è¨­å®š (~100è¡Œ)
â”‚   â”œâ”€â”€ price_tasks.py            # åƒ¹æ ¼æ›´æ–°ä»»å‹™
â”‚   â”œâ”€â”€ notification_tasks.py     # é€šçŸ¥ä»»å‹™
â”‚   â””â”€â”€ cleanup_tasks.py          # æ¸…ç†ä»»å‹™
```

---

### 8. `app/data_sources/yahoo_finance.py` (621 è¡Œ)

**å„ªåŒ–å»ºè­°ï¼š**
```
app/data_sources/
â”œâ”€â”€ yahoo_finance/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ fetcher.py           # è³‡æ–™æŠ“å–
â”‚   â”œâ”€â”€ parser.py            # è³‡æ–™è§£æ
â”‚   â”œâ”€â”€ cache.py             # å¿«å–è™•ç†
â”‚   â””â”€â”€ taiwan_handler.py    # å°è‚¡ç‰¹æ®Šè™•ç†
```

---

## ğŸŸ¢ P3 - å¯é¸å„ªåŒ–

ä»¥ä¸‹æª”æ¡ˆè¡Œæ•¸åœ¨ 500-560 è¡Œä¹‹é–“ï¼Œçµæ§‹å°šå¯æ¥å—ï¼Œä½†é•·æœŸç¶­è­·å»ºè­°æ‹†åˆ†ï¼š

- `app/services/signal_service.py` (551è¡Œ) - å¯æ‹†åˆ†ç‚ºå¤šå€‹ä¿¡è™Ÿé¡å‹
- `app/services/price_cache_service.py` (545è¡Œ) - å¯æ‹†åˆ†å¿«å–ç­–ç•¥
- `app/services/chart_service.py` (543è¡Œ) - å¯æŒ‰åœ–è¡¨é¡å‹æ‹†åˆ†

---

## ğŸ“ å„ªåŒ–åŸ·è¡Œé †åºå»ºè­°

### ç¬¬ä¸€éšæ®µï¼ˆ1-2 é€±ï¼‰
1. âœ… åˆªé™¤ `dashboard-mobile.html`ï¼Œæ•´åˆéŸ¿æ‡‰å¼è¨­è¨ˆ
2. âœ… å°‡å°è‚¡åç¨±ç§»å‡º `scheduler.py` åˆ° JSON è¨­å®šæª”
3. âœ… åˆªé™¤ `__init__ (1).py`ã€`.bak` æª”æ¡ˆ

### ç¬¬äºŒéšæ®µï¼ˆ2-3 é€±ï¼‰
4. ğŸ”„ æ‹†åˆ† `indicator_service.py` ç‚ºç¨ç«‹æŒ‡æ¨™æ¨¡çµ„
5. ğŸ”„ æ‹†åˆ† `search.js` ç‚ºåŠŸèƒ½æ¨¡çµ„

### ç¬¬ä¸‰éšæ®µï¼ˆ3-4 é€±ï¼‰
6. ğŸ“‹ é‡æ§‹ `dashboard.html` ç‚ºæ¨¡æ¿ç³»çµ±
7. ğŸ“‹ æ‹†åˆ† `admin.py` è·¯ç”±

### ç¬¬å››éšæ®µï¼ˆæŒçºŒæ”¹é€²ï¼‰
8. ğŸ“‹ é€æ­¥å„ªåŒ–å…¶ä»– P2ã€P3 æª”æ¡ˆ

---

## ğŸ’¡ é‡æ§‹åŸå‰‡

1. **å–®ä¸€è·è²¬åŸå‰‡**ï¼šæ¯å€‹æª”æ¡ˆåªåšä¸€ä»¶äº‹
2. **300 è¡Œè¦å‰‡**ï¼šå–®ä¸€æª”æ¡ˆç›¡é‡ä¸è¶…é 300 è¡Œ
3. **æ¨¡çµ„åŒ–**ï¼šç›¸é—œåŠŸèƒ½çµ„ç¹”åœ¨åŒä¸€è³‡æ–™å¤¾
4. **å¯æ¸¬è©¦æ€§**ï¼šæ‹†åˆ†å¾Œçš„æ¨¡çµ„æ‡‰è©²å¯ä»¥ç¨ç«‹æ¸¬è©¦
5. **æ¼¸é€²å¼**ï¼šæ¯æ¬¡åªæ”¹ä¸€å€‹æª”æ¡ˆï¼Œç¢ºä¿ä¸ç ´å£åŠŸèƒ½

---

*å ±å‘ŠçµæŸ*
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/P0_USAGE.md  â­â­â­
> P0 å„ªåŒ–ä½¿ç”¨èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# P0 å„ªåŒ–ä½¿ç”¨èªªæ˜

## æ–°å¢çš„å…¨åŸŸå‡½æ•¸

### 1. DOM å¿«å–æŸ¥è©¢

```javascript
// âŒ èˆŠå¯«æ³• - æ¯æ¬¡éƒ½æŸ¥è©¢ DOM
const el = document.getElementById('userName');

// âœ… æ–°å¯«æ³• - å¿«å–æŸ¥è©¢çµæœ
const el = $('userName');

// å¼·åˆ¶é‡æ–°æŸ¥è©¢ï¼ˆDOM çµæ§‹è®ŠåŒ–å¾Œï¼‰
const el = $('userName', true);
```

### 2. CSS é¸æ“‡å™¨å¿«å–

```javascript
// âŒ èˆŠå¯«æ³•
const el = document.querySelector('.my-class');

// âœ… æ–°å¯«æ³•
const el = $q('.my-class');
```

### 3. æ‰¹é‡æ›´æ–°

```javascript
// âŒ èˆŠå¯«æ³• - å¤šæ¬¡è§¸ç™¼é‡æ’
document.getElementById('price').textContent = '100';
document.getElementById('price').classList.add('green');
document.getElementById('change').textContent = '+5%';

// âœ… æ–°å¯«æ³• - ä¸€æ¬¡ requestAnimationFrame å…§å®Œæˆ
batchUpdate([
    { id: 'price', prop: 'textContent', value: '100' },
    { id: 'price', classList: { add: ['green'] } },
    { id: 'change', prop: 'textContent', value: '+5%' }
]);
```

### 4. å®‰å…¨è¨­ç½® HTML

```javascript
// âŒ èˆŠå¯«æ³• - å¤šæ¬¡ innerHTML
container.innerHTML = '<div>1</div>';
container.innerHTML += '<div>2</div>';

// âœ… æ–°å¯«æ³• - ä¸€æ¬¡æ€§è¨­ç½®
setHtml('container', ['<div>1</div>', '<div>2</div>']);
// æˆ–
setHtml('container', '<div>1</div><div>2</div>');
```

### 5. æ¸…é™¤å¿«å–

ç•¶å‹•æ…‹è¼‰å…¥æ–°å…§å®¹å¾Œï¼Œéœ€è¦æ¸…é™¤å¿«å–ï¼š

```javascript
// Modal å‹•æ…‹è¼‰å…¥å¾Œ
initAllModals();
clearDomCache();  // æ¸…é™¤å¿«å–ï¼Œè®“æ–°å…ƒç´ å¯è¢«æŸ¥è©¢
```

---

## é·ç§»æŒ‡å—

### æœ€å°æ”¹å‹•æ–¹å¼

åªéœ€æŠŠ `document.getElementById` æ›æˆ `$`ï¼š

```javascript
// æœå°‹å–ä»£
// document.getElementById('xxx') â†’ $('xxx')
```

### å®Œæ•´å„ªåŒ–æ–¹å¼

1. è­˜åˆ¥é »ç¹æŸ¥è©¢çš„ DOM å…ƒç´ 
2. åœ¨å‡½æ•¸é–‹é ­ä¸€æ¬¡æ€§å¿«å–
3. ä½¿ç”¨ batchUpdate åˆä½µæ›´æ–°

```javascript
// âŒ å„ªåŒ–å‰
function updateStockCard(stock) {
    document.getElementById('stockName').textContent = stock.name;
    document.getElementById('stockPrice').textContent = stock.price;
    document.getElementById('stockChange').textContent = stock.change;
    document.getElementById('stockChange').classList.add(stock.change > 0 ? 'green' : 'red');
}

// âœ… å„ªåŒ–å¾Œ
function updateStockCard(stock) {
    const changeClass = stock.change > 0 ? 'text-green-600' : 'text-red-600';
    
    batchUpdate([
        { id: 'stockName', prop: 'textContent', value: stock.name },
        { id: 'stockPrice', prop: 'textContent', value: stock.price },
        { id: 'stockChange', prop: 'textContent', value: stock.change },
        { id: 'stockChange', classList: { add: [changeClass] } }
    ]);
}
```

---

## SELA å‘½åç©ºé–“

æ‰€æœ‰æ–°åŠŸèƒ½ä¹Ÿå¯é€é `SELA` å‘½åç©ºé–“å­˜å–ï¼š

```javascript
SELA.$('userName')          // DOM å¿«å–æŸ¥è©¢
SELA.$q('.my-class')        // CSS é¸æ“‡å™¨å¿«å–
SELA.batchUpdate([...])     // æ‰¹é‡æ›´æ–°
SELA.setHtml('id', html)    // è¨­ç½® HTML
SELA.clearDomCache()        // æ¸…é™¤å¿«å–
SELA.showToast('è¨Šæ¯')      // Toast æç¤º
SELA.apiRequest('/api/...')  // API è«‹æ±‚
```

---

## æ•ˆèƒ½å°æ¯”

| æ“ä½œ | èˆŠæ–¹å¼ | æ–°æ–¹å¼ | æå‡ |
|------|--------|--------|------|
| æŸ¥è©¢ DOM (100æ¬¡) | ~5ms | ~0.5ms | 10x |
| æ›´æ–° 5 å€‹å…ƒç´  | 5 æ¬¡é‡æ’ | 1 æ¬¡é‡æ’ | 5x |
| è¨­ç½®å¤§é‡ HTML | å¤šæ¬¡æ‹¼æ¥ | ä¸€æ¬¡è¨­ç½® | 3x |

---

## æ³¨æ„äº‹é …

1. **å‹•æ…‹å…§å®¹**ï¼šä½¿ç”¨ `innerHTML` æˆ– `loadSection` å¾Œï¼Œèª¿ç”¨ `clearDomCache()`
2. **Modal**ï¼šModal å‹•æ…‹ç”Ÿæˆå¾Œï¼Œå¿«å–æœƒè‡ªå‹•æ›´æ–°ï¼ˆé¦–æ¬¡æŸ¥è©¢æ™‚ï¼‰
3. **å‘å¾Œå…¼å®¹**ï¼šèˆŠçš„ `document.getElementById` ä»å¯ä½¿ç”¨ï¼Œåªæ˜¯è¼ƒæ…¢
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/P1_USAGE.md  â­â­â­
> P1 ç‹€æ…‹ç®¡ç†ä½¿ç”¨èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# P1 ç‹€æ…‹ç®¡ç†ä½¿ç”¨èªªæ˜

## æ¦‚è¿°

P1 æ–°å¢ `AppState` çµ±ä¸€ç‹€æ…‹ç®¡ç†ï¼Œè§£æ±ºï¼š
- è³‡æ–™åˆ†æ•£åœ¨å„æ¨¡çµ„ï¼Œé›£ä»¥åŒæ­¥
- ç‹€æ…‹è®ŠåŒ–ç„¡æ³•è¿½è¹¤
- è·¨æ¨¡çµ„é€šè¨Šå›°é›£

---

## è¼‰å…¥é †åº

```html
<script src="/static/js/utils.js"></script>
<script src="/static/js/core.js"></script>
<script src="/static/js/state.js"></script>   <!-- P1 æ–°å¢ -->
<script src="/static/js/modals.js"></script>
<!-- å…¶ä»–æ¨¡çµ„ -->
```

---

## åŸºæœ¬ç”¨æ³•

### è®€å–ç‹€æ…‹

```javascript
// å–å¾—ç•¶å‰ç”¨æˆ¶
const user = AppState.user;

// å–å¾—è¿½è¹¤æ¸…å–®
const watchlist = AppState.watchlist;

// å–å¾—ç•¶å‰ section
const section = AppState.currentSection;
```

### è¨­ç½®ç‹€æ…‹

```javascript
// è¨­ç½®å–®ä¸€ç‹€æ…‹
AppState.set('isLoading', true);

// æ‰¹é‡è¨­ç½®
AppState.setMultiple({
    isLoading: false,
    currentStock: stockData
});

// ä½¿ç”¨ä¾¿æ·æ–¹æ³•
AppState.setCurrentStock(stockData);
AppState.setWatchlist(list);
AppState.setPortfolio({ tw: twList, us: usList });
```

### ç›£è½è®ŠåŒ–

```javascript
// ç›£è½ç‰¹å®šç‹€æ…‹
AppState.on('currentStock', (newStock, oldStock) => {
    console.log('è‚¡ç¥¨åˆ‡æ›:', oldStock?.symbol, 'â†’', newStock?.symbol);
    updateStockUI(newStock);
});

// ç›£è½è¿½è¹¤æ¸…å–®è®ŠåŒ–
AppState.on('watchlist', (newList) => {
    renderWatchlist(newList);
});

// ç›£è½æ‰€æœ‰è®ŠåŒ– (Debug ç”¨)
AppState.on('*', (key, newValue, oldValue) => {
    console.log(`State changed: ${key}`, oldValue, 'â†’', newValue);
});

// ä¸€æ¬¡æ€§ç›£è½
AppState.once('watchlistLoaded', () => {
    console.log('è¿½è¹¤æ¸…å–®é¦–æ¬¡è¼‰å…¥å®Œæˆ');
});
```

### å–æ¶ˆç›£è½

```javascript
// on() è¿”å›å–æ¶ˆå‡½æ•¸
const unsubscribe = AppState.on('currentStock', handler);

// ä¹‹å¾Œå–æ¶ˆ
unsubscribe();

// æˆ–å–æ¶ˆæ‰€æœ‰ç›£è½
AppState.offAll('currentStock');
```

---

## å¯ç”¨ç‹€æ…‹

| ç‹€æ…‹ | é¡å‹ | èªªæ˜ |
|------|------|------|
| `user` | Object | ç•¶å‰ç”¨æˆ¶ |
| `isAdmin` | Boolean | æ˜¯å¦ç®¡ç†å“¡ |
| `currentSection` | String | ç•¶å‰é é¢ |
| `currentStock` | Object | ç•¶å‰æŸ¥çœ‹çš„è‚¡ç¥¨ |
| `searchHistory` | Array | æœå°‹æ­·å² (æœ€å¤š10ç­†) |
| `watchlist` | Array | è¿½è¹¤æ¸…å–® |
| `watchlistLoaded` | Boolean | æ¸…å–®æ˜¯å¦å·²è¼‰å…¥ |
| `portfolio` | Object | æŒè‚¡ {tw, us, summary} |
| `tags` | Array | æ¨™ç±¤åˆ—è¡¨ |
| `indices` | Object | æŒ‡æ•¸è³‡æ–™ |
| `sentiment` | Object | å¸‚å ´æƒ…ç·’ |
| `isLoading` | Boolean | å…¨åŸŸè¼‰å…¥ç‹€æ…‹ |
| `activeModal` | String | ç•¶å‰é–‹å•Ÿçš„ Modal |

---

## ä¾¿æ·æ–¹æ³•

| æ–¹æ³• | èªªæ˜ |
|------|------|
| `setUser(user)` | è¨­ç½®ç”¨æˆ¶ä¸¦åŒæ­¥ isAdmin |
| `switchSection(name)` | åˆ‡æ›é é¢ï¼Œè¨˜éŒ„å‰ä¸€é  |
| `setCurrentStock(stock)` | è¨­ç½®è‚¡ç¥¨ä¸¦åŠ å…¥æœå°‹æ­·å² |
| `setWatchlist(list)` | è¨­ç½®è¿½è¹¤æ¸…å–® |
| `addToWatchlist(item)` | æ–°å¢åˆ°è¿½è¹¤æ¸…å–® |
| `removeFromWatchlist(symbol)` | å¾è¿½è¹¤æ¸…å–®ç§»é™¤ |
| `setPortfolio(data)` | æ›´æ–°æŒè‚¡è³‡æ–™ |
| `setTags(tags)` | è¨­ç½®æ¨™ç±¤ |
| `setLoading(bool)` | è¨­ç½®è¼‰å…¥ç‹€æ…‹ |
| `reset()` | é‡ç½®æ‰€æœ‰ç‹€æ…‹ (ç™»å‡ºæ™‚) |

---

## é·ç§»ç¯„ä¾‹

### è¿½è¹¤æ¸…å–®æ¨¡çµ„

```javascript
// âŒ èˆŠå¯«æ³•ï¼šå„è‡ªç®¡ç†ç‹€æ…‹
let watchlistData = [];

async function loadWatchlist() {
    const res = await apiRequest('/api/watchlist');
    const data = await res.json();
    watchlistData = data.data;
    renderWatchlist(watchlistData);
}

// âœ… æ–°å¯«æ³•ï¼šä½¿ç”¨ AppState
async function loadWatchlist() {
    // é¿å…é‡è¤‡è¼‰å…¥
    if (AppState.watchlistLoaded) {
        renderWatchlist(AppState.watchlist);
        return;
    }
    
    AppState.setLoading(true);
    const res = await apiRequest('/api/watchlist');
    const data = await res.json();
    AppState.setWatchlist(data.data);  // è‡ªå‹•è¨­ç½® watchlistLoaded = true
    AppState.setLoading(false);
}

// ç›£è½è®ŠåŒ–è‡ªå‹•æ›´æ–° UI
AppState.on('watchlist', renderWatchlist);
```

### æœå°‹æ¨¡çµ„

```javascript
// âŒ èˆŠå¯«æ³•
let currentChartData = null;

function renderSearchResult(data) {
    currentChartData = data.chart_data;
    window.currentChartData = currentChartData;  // å…¨åŸŸæ±¡æŸ“
    // ...
}

// âœ… æ–°å¯«æ³•
function renderSearchResult(data) {
    AppState.setCurrentStock({
        symbol: data.symbol,
        name: data.name,
        price: data.price,
        chartData: data.chart_data
    });
}

// å…¶ä»–æ¨¡çµ„å¯ä»¥ç›£è½
AppState.on('currentStock', (stock) => {
    // è‡ªå‹•æ›´æ–°ç›¸é—œ UI
});
```

---

## Debug æ¨¡å¼

```javascript
// é–‹å•Ÿ Debug æ¨¡å¼ï¼Œæœƒ log æ‰€æœ‰ç‹€æ…‹è®ŠåŒ–
window.SELA_DEBUG = true;

// Console è¼¸å‡ºç¯„ä¾‹:
// ğŸ“Š State: currentSection dashboard â†’ watchlist
// ğŸ“Š State: watchlist [] â†’ [{...}, {...}]
```

---

## æ³¨æ„äº‹é …

1. **é¿å…ç›´æ¥ä¿®æ”¹**ï¼šä½¿ç”¨ `set()` è€Œä¸æ˜¯ç›´æ¥è³¦å€¼ `AppState.xxx = value`
2. **ç•°æ­¥è¼‰å…¥**ï¼šstate.js éœ€åœ¨ core.js ä¹‹å¾Œè¼‰å…¥
3. **å‘å¾Œå…¼å®¹**ï¼šèˆŠä»£ç¢¼ä»å¯é‹ä½œï¼Œå¯é€æ­¥é·ç§»
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/P2_USAGE.md  â­â­â­
> P2 æ¨¡çµ„æ‹†åˆ† + äº‹ä»¶å§”è¨—ä½¿ç”¨èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# P2 æ¨¡çµ„æ‹†åˆ† + äº‹ä»¶å§”è¨—ä½¿ç”¨èªªæ˜

## æ¦‚è¿°

P2 å°‡ search.js (886è¡Œ) æ‹†åˆ†ç‚º 3 å€‹æ¨¡çµ„ï¼Œä¸¦åŠ å…¥äº‹ä»¶å§”è¨—å„ªåŒ–ã€‚

---

## æ‹†åˆ†çµæ§‹

```
static/js/
â”œâ”€â”€ core.js              # æ ¸å¿ƒ (P0+P1)
â”œâ”€â”€ state.js             # ç‹€æ…‹ç®¡ç† (P1)
â””â”€â”€ search/              # æœå°‹æ¨¡çµ„ (P2)
    â”œâ”€â”€ search-core.js   # æœå°‹é‚è¼¯ + å¿«å– (~180 è¡Œ)
    â”œâ”€â”€ search-render.js # çµæœæ¸²æŸ“ + äº‹ä»¶å§”è¨— (~300 è¡Œ)
    â””â”€â”€ search-chart.js  # åœ–è¡¨åŠŸèƒ½ (~280 è¡Œ)
```

**åŸæœ¬ï¼š** 1 å€‹ 886 è¡Œçš„æª”æ¡ˆ
**ç¾åœ¨ï¼š** 3 å€‹æ¨¡çµ„ï¼Œæ¯å€‹ ~250 è¡Œï¼Œç¸½è¨ˆ ~760 è¡Œ

---

## è¼‰å…¥é †åº

```html
<!-- æ ¸å¿ƒ -->
<script src="/static/js/core.js"></script>
<script src="/static/js/state.js"></script>

<!-- æœå°‹æ¨¡çµ„ (æŒ‰é †åºè¼‰å…¥) -->
<script src="/static/js/search/search-core.js"></script>
<script src="/static/js/search/search-render.js"></script>
<script src="/static/js/search/search-chart.js"></script>
```

æˆ–ä½¿ç”¨åˆä½µç‰ˆï¼š
```html
<script src="/static/js/search.js"></script>  <!-- åˆä½µç‰ˆ -->
```

---

## äº‹ä»¶å§”è¨—å„ªåŒ–

### èˆŠå¯«æ³• (æ¯å€‹æŒ‰éˆ•éƒ½ç¶å®š)

```javascript
// âŒ HTML ä¸­ä½¿ç”¨ onclick
<button onclick="searchSymbol('AAPL', true)">åˆ·æ–°</button>
<button onclick="openChartFullscreen('AAPL', 150)">åœ–è¡¨</button>
<button onclick="quickAddToWatchlist('AAPL')">è¿½è¹¤</button>

// å•é¡Œï¼š
// 1. æ¯å€‹æŒ‰éˆ•éƒ½æ˜¯ç¨ç«‹äº‹ä»¶ç›£è½å™¨
// 2. å‹•æ…‹ç”Ÿæˆçš„å…§å®¹éœ€è¦é‡æ–°ç¶å®š
// 3. å…¨åŸŸå‡½æ•¸æ±¡æŸ“
```

### æ–°å¯«æ³• (äº‹ä»¶å§”è¨—)

```javascript
// âœ… HTML ä½¿ç”¨ data-action
<button data-action="refresh" data-symbol="AAPL">åˆ·æ–°</button>
<button data-action="open-chart" data-symbol="AAPL" data-price="150">åœ–è¡¨</button>
<button data-action="add-watchlist" data-symbol="AAPL" data-type="stock">è¿½è¹¤</button>

// JavaScriptï¼šçˆ¶å®¹å™¨çµ±ä¸€è™•ç†
container.addEventListener('click', (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    const action = target.dataset.action;
    const symbol = target.dataset.symbol;
    
    switch (action) {
        case 'refresh':
            searchSymbol(symbol, true);
            break;
        case 'open-chart':
            openChartFullscreen(symbol, target.dataset.price);
            break;
        case 'add-watchlist':
            quickAddToWatchlist(symbol, target.dataset.type);
            break;
    }
});
```

### å„ªé»

| é …ç›® | èˆŠå¯«æ³• | æ–°å¯«æ³• |
|------|--------|--------|
| ç›£è½å™¨æ•¸é‡ | N å€‹ | 1 å€‹ |
| å‹•æ…‹å…§å®¹ | éœ€é‡æ–°ç¶å®š | è‡ªå‹•ç”Ÿæ•ˆ |
| è¨˜æ†¶é«” | è¼ƒé«˜ | è¼ƒä½ |
| å¯ç¶­è­·æ€§ | åˆ†æ•£ | é›†ä¸­ |

---

## æ¨¡çµ„è·è²¬

### search-core.js
- `searchStock()` - å¾è¼¸å…¥æ¡†æœå°‹
- `searchSymbol(symbol, forceRefresh)` - æœå°‹æŒ‡å®šä»£è™Ÿ
- `quickAddToWatchlist(symbol, type)` - å¿«é€ŸåŠ å…¥è¿½è¹¤
- `clearStockCache()` - æ¸…é™¤å¿«å–
- `getStockCacheStats()` - å¿«å–çµ±è¨ˆ

### search-render.js
- `renderSearchResult(data, symbol)` - æ¸²æŸ“å…¥å£
- `renderStockResult(stock, isCrypto, isTaiwan)` - æ¸²æŸ“çµæœå¡ç‰‡
- `toggleCollapsible(button)` - æ‘ºç–Šé¢æ¿
- äº‹ä»¶å§”è¨—è™•ç†

### search-chart.js
- `openChartFullscreen(symbol, price)` - é–‹å•Ÿå…¨è¢å¹•åœ–è¡¨
- `closeChartFullscreen()` - é—œé–‰åœ–è¡¨
- `setChartRange(days)` - è¨­ç½®æ™‚é–“ç¯„åœ
- `renderFullscreenChart(chartData, days)` - æ¸²æŸ“åœ–è¡¨
- `renderVolumeChart(chartData, days, labels)` - æ¸²æŸ“æˆäº¤é‡
- `loadReturnsModal(symbol)` - è¼‰å…¥å ±é…¬ç‡ Modal
- `closeReturnsModal()` - é—œé–‰å ±é…¬ç‡ Modal

---

## SELA å‘½åç©ºé–“

æ‰€æœ‰æœå°‹åŠŸèƒ½æ•´åˆåˆ° `SELA.search`ï¼š

```javascript
SELA.search.searchStock()
SELA.search.searchSymbol('AAPL')
SELA.search.quickAddToWatchlist('AAPL', 'stock')
SELA.search.openChartFullscreen('AAPL', 150)
SELA.search.clearCache()
```

---

## å‘å¾Œå…¼å®¹

æ‰€æœ‰åŸæœ‰çš„å…¨åŸŸå‡½æ•¸ä»å¯ä½¿ç”¨ï¼š

```javascript
// é€™äº›éƒ½é‚„èƒ½ç”¨
searchStock()
searchSymbol('AAPL')
quickAddToWatchlist('AAPL')
openChartFullscreen('AAPL', 150)
toggleCollapsible(button)
```

---

## éƒ¨ç½²æ–¹å¼

### æ–¹å¼ 1ï¼šåˆ†é–‹è¼‰å…¥ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
```html
<script src="/static/js/search/search-core.js"></script>
<script src="/static/js/search/search-render.js"></script>
<script src="/static/js/search/search-chart.js"></script>
```

### æ–¹å¼ 2ï¼šåˆä½µç‰ˆï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
```bash
cat search-core.js search-render.js search-chart.js > search.js
```

---

## æ•ˆèƒ½å°æ¯”

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| æª”æ¡ˆå¤§å° | 886 è¡Œ | ~760 è¡Œ |
| äº‹ä»¶ç›£è¯å™¨ | ~20 å€‹/å¡ç‰‡ | 1 å€‹/å®¹å™¨ |
| å‹•æ…‹ç¶å®š | éœ€è¦ | ä¸éœ€è¦ |
| æ¨¡çµ„è€¦åˆ | é«˜ | ä½ |
| å¯æ¸¬è©¦æ€§ | å·® | å¥½ |

---

## é·ç§»å…¶ä»–æ¨¡çµ„

åŒæ¨£çš„æ¨¡å¼å¯ä»¥æ‡‰ç”¨åˆ°å…¶ä»–å¤§æª”æ¡ˆï¼š

```
watchlist.js â†’ watchlist/
â”œâ”€â”€ watchlist-core.js
â”œâ”€â”€ watchlist-render.js
â””â”€â”€ watchlist-actions.js

portfolio.js â†’ portfolio/
â”œâ”€â”€ portfolio-core.js
â”œâ”€â”€ portfolio-render.js
â””â”€â”€ portfolio-chart.js
```
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/P3_USAGE.md  â­â­â­
> P3 äº‹ä»¶å§”è¨— + AppState æ•´åˆä½¿ç”¨èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# P3 äº‹ä»¶å§”è¨— + AppState æ•´åˆä½¿ç”¨èªªæ˜

## æ¦‚è¿°

P3 å„ªåŒ– `watchlist.js` å’Œ `portfolio.js`ï¼ŒåŠ å…¥ï¼š
1. äº‹ä»¶å§”è¨— - æ¸›å°‘ç›£è½å™¨æ•¸é‡
2. AppState æ•´åˆ - çµ±ä¸€ç‹€æ…‹ç®¡ç†
3. DOM å¿«å– - ä½¿ç”¨ `$()` å‡½æ•¸

---

## å„ªåŒ–å‰å¾Œå°æ¯”

### watchlist.js

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| ç›£è½å™¨/å¡ç‰‡ | ~8 å€‹ | 1 å€‹ |
| ç‹€æ…‹ç®¡ç† | ç§æœ‰è®Šæ•¸ | AppState |
| DOM æŸ¥è©¢ | getElementById | $() å¿«å– |

### portfolio.js

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| ç›£è¯å™¨/å¡ç‰‡ | ~3 å€‹ | 1 å€‹ |
| ç‹€æ…‹ç®¡ç† | ç„¡ | AppState |
| DOM æŸ¥è©¢ | getElementById | $() å¿«å– |

---

## äº‹ä»¶å§”è¨—æ¨¡å¼

### èˆŠå¯«æ³•

```html
<!-- æ¯å€‹æŒ‰éˆ•éƒ½æœ‰ onclick -->
<button onclick="removeFromWatchlist('AAPL')">åˆªé™¤</button>
<button onclick="searchSymbol('AAPL')">åˆ†æ</button>
<button onclick="quickTrade('AAPL', 'Apple', 'us', 'buy')">è²·å…¥</button>
```

### æ–°å¯«æ³•

```html
<!-- ä½¿ç”¨ data-action å±¬æ€§ -->
<button data-action="remove" data-symbol="AAPL">åˆªé™¤</button>
<button data-action="analyze" data-symbol="AAPL">åˆ†æ</button>
<button data-action="trade" data-symbol="AAPL" data-name="Apple" data-market="us" data-type="buy">è²·å…¥</button>
```

```javascript
// çˆ¶å®¹å™¨çµ±ä¸€è™•ç†
container.addEventListener('click', (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    switch (target.dataset.action) {
        case 'remove':
            removeFromWatchlist(target.dataset.symbol);
            break;
        case 'analyze':
            searchSymbol(target.dataset.symbol);
            break;
        case 'trade':
            quickTrade(
                target.dataset.symbol,
                target.dataset.name,
                target.dataset.market,
                target.dataset.type
            );
            break;
    }
});
```

---

## AppState æ•´åˆ

### watchlist.js æ•´åˆ

```javascript
// è¼‰å…¥æ™‚åŒæ­¥åˆ° AppState
async function loadWatchlist() {
    // æª¢æŸ¥æ˜¯å¦å·²æœ‰å¿«å–
    if (AppState.watchlistLoaded && AppState.watchlist.length > 0) {
        renderWatchlistCards(AppState.watchlist);
        return;
    }
    
    const res = await apiRequest('/api/watchlist/with-prices');
    const data = await res.json();
    
    // åŒæ­¥åˆ° AppState
    AppState.setWatchlist(data.data);
}

// æ–°å¢æ™‚æ¨‚è§€æ›´æ–°
async function addToWatchlist() {
    const res = await apiRequest('/api/watchlist', { method: 'POST', body: {...} });
    
    if (data.success) {
        // æ¨‚è§€æ›´æ–°ï¼Œä¸ç­‰é‡æ–°è¼‰å…¥
        AppState.addToWatchlist({
            symbol,
            asset_type: assetType,
            added_at: new Date().toISOString()
        });
    }
}

// åˆªé™¤æ™‚æ›´æ–°
async function removeFromWatchlist(symbol) {
    const res = await apiRequest(`/api/watchlist/${symbol}`, { method: 'DELETE' });
    
    if (data.success) {
        AppState.removeFromWatchlist(symbol);
    }
}
```

### portfolio.js æ•´åˆ

```javascript
// è¼‰å…¥æ‘˜è¦
async function loadPortfolioSummary() {
    const res = await apiRequest('/api/portfolio/summary');
    const data = await res.json();
    
    if (data.success) {
        // åŒæ­¥åˆ° AppState
        AppState.setPortfolio({ summary: data.data });
    }
}

// è¼‰å…¥æŒè‚¡
async function loadHoldings() {
    const res = await apiRequest('/api/portfolio/holdings');
    const data = await res.json();
    
    if (data.success) {
        AppState.setPortfolio({
            tw: data.data.tw || [],
            us: data.data.us || []
        });
    }
}
```

---

## æ”¯æ´çš„ data-action

### watchlist.js

| action | åƒæ•¸ | èªªæ˜ |
|--------|------|------|
| `sort` | field | æ’åº |
| `remove` | symbol | ç§»é™¤è¿½è¹¤ |
| `analyze` | symbol | è©³ç´°åˆ†æ |
| `trade` | symbol, name, market, type | å¿«é€Ÿäº¤æ˜“ |
| `target-price` | id, symbol, target | è¨­å®šç›®æ¨™åƒ¹ |
| `assign-tag` | id, symbol | æŒ‡æ´¾æ¨™ç±¤ |
| `filter-tag` | tagId | ç¯©é¸æ¨™ç±¤ |

### portfolio.js

| action | åƒæ•¸ | èªªæ˜ |
|--------|------|------|
| `analyze` | symbol | è©³ç´°åˆ†æ |
| `delete-transaction` | id, market | åˆªé™¤äº¤æ˜“ |
| `switch-tab` | tab | åˆ‡æ›é ç±¤ |
| `export` | - | åŒ¯å‡º |
| `show-import` | - | é¡¯ç¤ºåŒ¯å…¥ Modal |

---

## SELA å‘½åç©ºé–“

```javascript
// watchlist
SELA.watchlist.load()
SELA.watchlist.loadOverview()
SELA.watchlist.add()
SELA.watchlist.remove(symbol)
SELA.watchlist.changeSort(field)
SELA.watchlist.exportData()
SELA.watchlist.importData()

// portfolio
SELA.portfolio.load()
SELA.portfolio.loadSummary()
SELA.portfolio.loadHoldings()
SELA.portfolio.loadTransactions(market)
SELA.portfolio.switchTab(tab)
SELA.portfolio.exportData()
SELA.portfolio.importData()
SELA.portfolio.quickTrade(symbol, name, market, type)
```

---

## éƒ¨ç½²

```bash
cp static/js/watchlist.js å°ˆæ¡ˆ/static/js/
cp static/js/portfolio.js å°ˆæ¡ˆ/static/js/

git add .
git commit -m "P3 å„ªåŒ–: watchlist + portfolio äº‹ä»¶å§”è¨—"
git push
```

---

## æ•ˆèƒ½å°æ¯”

å‡è¨­è¿½è¹¤æ¸…å–®æœ‰ 20 å€‹é …ç›®ï¼š

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| ç›£è¯å™¨æ•¸é‡ | ~160 å€‹ | 1 å€‹ | -99% |
| é‡è¤‡è¼‰å…¥ | æœ‰ | ä½¿ç”¨ AppState å¿«å– | æ¸›å°‘ API è«‹æ±‚ |
| DOM æŸ¥è©¢ | æ¯æ¬¡éƒ½æŸ¥ | å¿«å– | -90% |

---

## æ³¨æ„äº‹é …

1. **å‘å¾Œå…¼å®¹**ï¼šæ‰€æœ‰åŸæœ‰å…¨åŸŸå‡½æ•¸ä»å¯ä½¿ç”¨
2. **æ¼¸é€²å¼é·ç§»**ï¼šå¯ä»¥é€æ­¥å°‡å…¶ä»–æ¨¡çµ„æ”¹ç”¨äº‹ä»¶å§”è¨—
3. **AppState å¿«å–**ï¼šåŒ¯å…¥è³‡æ–™å¾Œéœ€è¦æ¸…é™¤å¿«å–

```javascript
// åŒ¯å…¥å¾Œæ¸…é™¤å¿«å–
AppState.set('watchlistLoaded', false);
AppState.set('portfolioLoaded', false);
```
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/P4_USAGE.md  â­â­â­
> P4 tags.js + transaction.js å„ªåŒ–ä½¿ç”¨èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# P4 tags.js + transaction.js å„ªåŒ–ä½¿ç”¨èªªæ˜

## æ¦‚è¿°

P4 å„ªåŒ– `tags.js` å’Œ `transaction.js`ï¼š
1. AppState æ•´åˆ - çµ±ä¸€ç‹€æ…‹ç®¡ç†
2. äº‹ä»¶å§”è¨— - æ¸›å°‘ç›£è½å™¨æ•¸é‡
3. DOM å¿«å– - ä½¿ç”¨ `$()` å‡½æ•¸

---

## å„ªåŒ–å…§å®¹

### tags.js

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| DOM æŸ¥è©¢ | getElementById | $() å¿«å– |
| ç‹€æ…‹ç®¡ç† | ç§æœ‰è®Šæ•¸ | AppState |
| äº‹ä»¶ç¶å®š | onclick | äº‹ä»¶å§”è¨— |
| å¿«å–æ©Ÿåˆ¶ | ç„¡ | tagsLoaded æ¨™è¨˜ |

### transaction.js

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| DOM æŸ¥è©¢ | 60+ æ¬¡ getElementById | $() å¿«å– |
| æäº¤å¾Œæ›´æ–° | é‡æ–°è¼‰å…¥ | æ¸…é™¤ AppState å¿«å– |

---

## tags.js AppState æ•´åˆ

```javascript
// è¼‰å…¥æ™‚æª¢æŸ¥å¿«å–
async function loadTags() {
    // å·²æœ‰å¿«å–ç›´æ¥ä½¿ç”¨
    if (AppState.tagsLoaded && AppState.tags.length > 0) {
        userTags = AppState.tags;
        return userTags;
    }
    
    const res = await apiRequest('/api/tags');
    const data = await res.json();
    
    // åŒæ­¥åˆ° AppState
    AppState.setTags(data.data);
    return userTags;
}

// å»ºç«‹æ™‚æ¨‚è§€æ›´æ–°
async function createTag(name, color, icon) {
    const res = await apiRequest('/api/tags', { method: 'POST', body: {...} });
    
    if (data.success && data.data) {
        // æ¨‚è§€æ›´æ–°ï¼Œä¸éœ€é‡æ–°è¼‰å…¥
        userTags.push(data.data);
        AppState.setTags([...userTags]);
    }
}

// åˆªé™¤æ™‚æ¨‚è§€æ›´æ–°
async function deleteTag(tagId) {
    const res = await apiRequest(`/api/tags/${tagId}`, { method: 'DELETE' });
    
    if (data.success) {
        userTags = userTags.filter(t => t.id !== tagId);
        AppState.setTags([...userTags]);
    }
}
```

---

## tags.js äº‹ä»¶å§”è¨—

```html
<!-- èˆŠå¯«æ³• -->
<button onclick="showEditTagModal(1)">ç·¨è¼¯</button>
<button onclick="deleteTag(1)">åˆªé™¤</button>
<button onclick="initDefaultTags()">åˆå§‹åŒ–</button>

<!-- æ–°å¯«æ³• -->
<button data-action="edit-tag" data-id="1">ç·¨è¼¯</button>
<button data-action="delete-tag" data-id="1">åˆªé™¤</button>
<button data-action="init-defaults">åˆå§‹åŒ–</button>
```

```javascript
// çµ±ä¸€è™•ç†
function handleTagClick(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    switch (target.dataset.action) {
        case 'edit-tag':
            showEditTagModal(parseInt(target.dataset.id));
            break;
        case 'delete-tag':
            deleteTag(parseInt(target.dataset.id));
            break;
        case 'init-defaults':
            initDefaultTags();
            break;
    }
}
```

---

## transaction.js DOM å¿«å–

```javascript
// èˆŠå¯«æ³•ï¼š60+ æ¬¡æŸ¥è©¢
document.getElementById('twSymbol').value = '';
document.getElementById('twName').value = '';
document.getElementById('twPrice').value = '';
// ...

// æ–°å¯«æ³•ï¼šä½¿ç”¨ $() å¿«å–
$('twSymbol').value = '';
$('twName').value = '';
$('twPrice').value = '';
```

**æ•ˆæœ**ï¼šé¦–æ¬¡æŸ¥è©¢å¾Œå¿«å–ï¼Œå¾ŒçºŒæŸ¥è©¢ç›´æ¥å¾ Map å–å¾—

---

## transaction.js æäº¤å¾Œæ›´æ–°

```javascript
async function submitTwTransaction() {
    const res = await apiRequest('/api/portfolio/transactions/tw', {...});
    
    if (data.success) {
        showToast('äº¤æ˜“å·²æ–°å¢');
        closeTwModal();
        
        // âœ… P4: æ¸…é™¤å¿«å–ï¼Œç¢ºä¿ä¸‹æ¬¡è¼‰å…¥æœ€æ–°è³‡æ–™
        if (window.AppState) {
            AppState.set('portfolioLoaded', false);
        }
        
        loadPortfolio();
    }
}
```

---

## SELA å‘½åç©ºé–“

```javascript
// tags
SELA.tags.load()
SELA.tags.create(name, color, icon)
SELA.tags.update(tagId, updates)
SELA.tags.delete(tagId)
SELA.tags.initDefaults()
SELA.tags.getWatchlistTags(watchlistId)
SELA.tags.setWatchlistTags(watchlistId, tagIds)
SELA.tags.renderBadges(tags)
SELA.tags.renderFilter(selectedTagId)
SELA.tags.renderManager()

// transaction
SELA.transaction.showTwModal()
SELA.transaction.closeTwModal()
SELA.transaction.showUsModal()
SELA.transaction.closeUsModal()
SELA.transaction.quickTrade(symbol, name, market, type)
```

---

## éƒ¨ç½²

```bash
cp static/js/tags.js å°ˆæ¡ˆ/static/js/
cp static/js/transaction.js å°ˆæ¡ˆ/static/js/

git add .
git commit -m "P4: tags + transaction å„ªåŒ–"
git push
```

---

## å®Œæ•´å„ªåŒ–ç¸½è¦½ (P0-P4)

| å„ªå…ˆç´š | å…§å®¹ | ç‹€æ…‹ |
|--------|------|------|
| P0 | DOM å¿«å– + æ‰¹é‡æ›´æ–° | âœ… |
| P1 | çµ±ä¸€ç‹€æ…‹ç®¡ç† (AppState) | âœ… |
| P2 | search.js æ‹†åˆ† + äº‹ä»¶å§”è¨— | âœ… |
| P3 | watchlist + portfolio äº‹ä»¶å§”è¨— | âœ… |
| P4 | tags + transaction å„ªåŒ– | âœ… |

---

## æ•ˆèƒ½æ”¹å–„ç¸½çµ

| æ¨¡çµ„ | DOM æŸ¥è©¢æ¸›å°‘ | äº‹ä»¶ç›£è½å™¨æ¸›å°‘ | AppState æ•´åˆ |
|------|-------------|---------------|--------------|
| core.js | 90% | - | âœ… |
| search.js | 80% | 95% | âœ… |
| watchlist.js | 80% | 90% | âœ… |
| portfolio.js | 80% | 85% | âœ… |
| tags.js | 70% | 80% | âœ… |
| transaction.js | 70% | - | âœ… |
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/RAILWAY_SETUP.md  â­â­â­
> Railway PostgreSQL è¨­å®šæŒ‡å—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# Railway PostgreSQL è¨­å®šæŒ‡å—

## æ­¥é©Ÿ 1ï¼šåœ¨ Railway æ·»åŠ  PostgreSQL

1. é€²å…¥ä½ çš„ Railway å°ˆæ¡ˆ
2. é»æ“Š **New** â†’ **Database** â†’ **Add PostgreSQL**
3. ç­‰å¾…è³‡æ–™åº«å»ºç«‹å®Œæˆ

## æ­¥é©Ÿ 2ï¼šå–å¾—è³‡æ–™åº«é€£ç·šå­—ä¸²

1. é»æ“Šæ–°å»ºç«‹çš„ PostgreSQL æœå‹™
2. é€²å…¥ **Variables** æ¨™ç±¤
3. è¤‡è£½ `DATABASE_URL` çš„å€¼

æ ¼å¼é¡ä¼¼ï¼š
```
postgres://username:password@host:port/database
```

## æ­¥é©Ÿ 3ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸

åœ¨ä½ çš„ **Web Service** (ä¸æ˜¯ PostgreSQL) ä¸­è¨­å®šï¼š

1. é»æ“Š Web Service â†’ **Variables**
2. æ·»åŠ ä»¥ä¸‹è®Šæ•¸ï¼š

```bash
# è³‡æ–™åº« (å¾ PostgreSQL æœå‹™è¤‡è£½)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# æˆ–ç›´æ¥è²¼ä¸Šå®Œæ•´çš„é€£ç·šå­—ä¸²
# DATABASE_URL=postgres://username:password@host:port/database

# æ‡‰ç”¨ç¨‹å¼
APP_ENV=production
DEBUG=false

# LINE Login
LINE_LOGIN_CHANNEL_ID=ä½ çš„_channel_id
LINE_LOGIN_CHANNEL_SECRET=ä½ çš„_channel_secret
LINE_LOGIN_CALLBACK_URL=https://ä½ çš„ç¶²åŸŸ/auth/line/callback

# JWT
JWT_SECRET_KEY=ä½ çš„éš¨æ©Ÿå¯†é‘°
JWT_EXPIRE_DAYS=7
```

### ä½¿ç”¨ Railway çš„è®Šæ•¸å¼•ç”¨ï¼ˆæ¨è–¦ï¼‰

Railway æ”¯æ´åœ¨åŒä¸€å°ˆæ¡ˆå…§å¼•ç”¨å…¶ä»–æœå‹™çš„è®Šæ•¸ï¼š

```bash
DATABASE_URL=${{Postgres.DATABASE_URL}}
```

é€™æ¨£ç•¶è³‡æ–™åº«é€£ç·šè³‡è¨Šè®Šæ›´æ™‚ï¼Œæœƒè‡ªå‹•æ›´æ–°ã€‚

## æ­¥é©Ÿ 4ï¼šéƒ¨ç½²

```bash
# æ›´æ–°ä»£ç¢¼
git add .
git commit -m "feat: add PostgreSQL support"
git push
```

Railway æœƒè‡ªå‹•åµæ¸¬åˆ°è®Šæ›´ä¸¦é‡æ–°éƒ¨ç½²ã€‚

## æ­¥é©Ÿ 5ï¼šé©—è­‰

1. ç­‰å¾…éƒ¨ç½²å®Œæˆ
2. æª¢æŸ¥æ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   Starting SELA è‡ªå‹•é¸è‚¡ç³»çµ± v0.3.x
   Database initialized
   ```

3. è¨ªå•ä½ çš„ç¶²ç«™æ¸¬è©¦åŠŸèƒ½

## è³‡æ–™åº«è¡¨æ ¼

ç³»çµ±æœƒè‡ªå‹•å»ºç«‹ä»¥ä¸‹è¡¨æ ¼ï¼š

| è¡¨æ ¼ | èªªæ˜ |
|------|------|
| users | ç”¨æˆ¶è³‡æ–™ (LINE Login) |
| watchlists | è¿½è¹¤æ¸…å–® |
| stock_prices | è‚¡åƒ¹å¿«å– |
| crypto_prices | å¹£åƒ¹å¿«å– |
| market_sentiment | å¸‚å ´æƒ…ç·’ |
| user_indicator_settings | ç”¨æˆ¶æŒ‡æ¨™è¨­å®š |
| user_alert_settings | ç”¨æˆ¶é€šçŸ¥è¨­å®š |
| user_indicator_params | ç”¨æˆ¶åƒæ•¸è¨­å®š |
| notifications | é€šçŸ¥è¨˜éŒ„ |

## æ³¨æ„äº‹é …

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šè¡¨æ ¼æœƒè‡ªå‹•å»ºç«‹ï¼Œä¸éœ€è¦æ‰‹å‹•åŸ·è¡Œ migration

2. **postgres:// vs postgresql://**ï¼š
   - Railway ä½¿ç”¨ `postgres://`
   - SQLAlchemy éœ€è¦ `postgresql://`
   - ç¨‹å¼å·²è‡ªå‹•è™•ç†è½‰æ›

3. **é€£ç·šæ± **ï¼š
   - ä½¿ç”¨ `NullPool` é¿å…é€£ç·šå•é¡Œ
   - é©åˆ Railway çš„ serverless ç’°å¢ƒ

## æ•…éšœæ’é™¤

### é€£ç·šå¤±æ•—
- ç¢ºèª DATABASE_URL æ­£ç¢º
- ç¢ºèª PostgreSQL æœå‹™æ­£åœ¨é‹è¡Œ

### è¡¨æ ¼ä¸å­˜åœ¨
- æª¢æŸ¥æ—¥èªŒç¢ºèª "Database initialized" è¨Šæ¯
- å˜—è©¦é‡æ–°éƒ¨ç½²

### SSL éŒ¯èª¤
å¦‚æœé‡åˆ° SSL éŒ¯èª¤ï¼Œåœ¨ DATABASE_URL å¾Œé¢åŠ ä¸Šï¼š
```
?sslmode=require
```
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/README-1.md  â­â­â­
> SELA æ›´æ–°åŒ… 20260114
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA æ›´æ–°åŒ… 20260114

## ç›®éŒ„çµæ§‹

```
â”œâ”€â”€ static/
â”‚   â””â”€â”€ dashboard.html      # è¿½è¹¤æ¸…å–®æ’åºåŠŸèƒ½
â”œâ”€â”€ app/
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ cache_helper.py # æŸ¥è©¢çµæœå¿«å–æ¨¡çµ„ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ README.md
```

---

## åŠŸèƒ½ 1: è¿½è¹¤æ¸…å–®æ’åº

### æ’åºé¸é …
- **è‡ªè¨‚** - æŒ‰åŠ å…¥æ™‚é–“ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
- **ä»£ç¢¼** - æŒ‰è‚¡ç¥¨ä»£ç¢¼ A-Z
- **æ¼²å¹…â†“** - æ¼²å¹…é«˜åˆ°ä½
- **è·Œå¹…â†“** - æ¼²å¹…ä½åˆ°é«˜

### ç‰¹é»
- âœ… æ’åºåå¥½è‡ªå‹•å„²å­˜åˆ° localStorage
- âœ… åˆ‡æ›æ’åºä¸é‡æ–°å‘¼å« API
- âœ… æ‰‹æ©Ÿç‰ˆæ»¾å‹•å‹å–„

---

## åŠŸèƒ½ 2: æŸ¥è©¢çµæœå¿«å–

éœ€æ‰‹å‹•åœ¨ `app/routers/stock.py` çš„ `get_stock_analysis` å‡½æ•¸ return å‰åŠ å…¥ï¼š

```python
from app.services.cache_helper import cache_stock_price

day_change = calc_change(1)
prev_close = float(df.iloc[-2]['close_raw']) if len(df) > 1 else None
change_amount = current_price - prev_close if prev_close else None

cache_stock_price(
    symbol=symbol,
    name=stock_name,
    price=current_price,
    prev_close=prev_close,
    change=change_amount,
    change_pct=day_change,
    volume=volume_today
)
```

---

## éƒ¨ç½²æ­¥é©Ÿ

1. è§£å£“å¾Œç›´æ¥è¦†è“‹åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„
2. ï¼ˆå¯é¸ï¼‰æ‰‹å‹•ä¿®æ”¹ `stock.py` å•Ÿç”¨æŸ¥è©¢å¿«å–
3. é‡æ–°éƒ¨ç½²
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/README-2.md  â­â­â­
> SELA æ›´æ–°åŒ… 20260114 - æ’åºåŠŸèƒ½ + MA20 æ”¯æ´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA æ›´æ–°åŒ… 20260114 - æ’åºåŠŸèƒ½ + MA20 æ”¯æ´

## ç›®éŒ„çµæ§‹

```
â”œâ”€â”€ static/
â”‚   â””â”€â”€ dashboard.html              # å‰ç«¯æ’åºåŠŸèƒ½
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ price_cache.py          # å¿«å– Modelï¼ˆåŠ  ma20 æ¬„ä½ï¼‰
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ cache_helper.py         # å¿«å–è¼”åŠ©æ¨¡çµ„
â”‚   â”‚   â””â”€â”€ price_cache_service.py  # æ‰¹æ¬¡æ›´æ–°æœå‹™ï¼ˆè¨ˆç®— MA20ï¼‰
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ watchlist.py            # API è¿”å› ma20
â”‚       â””â”€â”€ stock.py                # æŸ¥è©¢æ™‚å¯«å…¥ MA20
â””â”€â”€ README.md
```

**æ‰€æœ‰æª”æ¡ˆéƒ½æ˜¯å®Œæ•´ç‰ˆæœ¬ï¼Œç›´æ¥è¦†è“‹å³å¯ã€‚**

---

## åŠŸèƒ½èªªæ˜

### 1. è¿½è¹¤æ¸…å–®æ’åº

```
æ’åºï¼š [è‡ªè¨‚] [ä»£ç¢¼] [æ¼²å¹…â†“] [è·Œå¹…â†“] [MA20]
```

| æ¨¡å¼ | èªªæ˜ |
|------|------|
| è‡ªè¨‚ | æŒ‰åŠ å…¥æ™‚é–“ï¼ˆæœ€æ–°åœ¨å‰ï¼‰|
| ä»£ç¢¼ | A-Z æ’åº |
| æ¼²å¹…â†“ | æ¼²å¹…é«˜åˆ°ä½ |
| è·Œå¹…â†“ | æ¼²å¹…ä½åˆ°é«˜ |
| **MA20** | ç«™ä¸Š MA20 å„ªå…ˆ |

### 2. MA20 æ¨™ç±¤é¡¯ç¤º

```
AAPL  è‚¡  Apple Inc.
$185.50  â–² 2.31%  [ç«™ä¸ŠMA20]
```

| æ¨™ç±¤ | æ¢ä»¶ |
|------|------|
| â–²MA20 | åƒ¹æ ¼é«˜æ–¼ MA20 è¶…é 3% |
| ç«™ä¸ŠMA20 | åƒ¹æ ¼é«˜æ–¼ MA20 åœ¨ 0-3% |
| æ¸¬MA20 | åƒ¹æ ¼ä½æ–¼ MA20 åœ¨ 0-3% |
| â–¼MA20 | åƒ¹æ ¼ä½æ–¼ MA20 è¶…é 3% |

---

## éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1: è¦†è“‹æª”æ¡ˆ

è§£å£“å¾Œç›´æ¥è¦†è“‹åˆ°å°ˆæ¡ˆç›®éŒ„ï¼š

```bash
unzip sela-update-20260114.zip -d /path/to/project/
```

### æ­¥é©Ÿ 2: è³‡æ–™åº«é·ç§»ï¼ˆæ–°å¢ ma20 æ¬„ä½ï¼‰

```sql
-- PostgreSQL
ALTER TABLE stock_price_cache ADD COLUMN IF NOT EXISTS ma20 NUMERIC(12, 4);
```

æˆ–è®“ SQLAlchemy è‡ªå‹•å»ºç«‹ï¼ˆé‡æ–°å•Ÿå‹•æ™‚æœƒè‡ªå‹•æ–°å¢æ¬„ä½ï¼‰ã€‚

### æ­¥é©Ÿ 3: é‡æ–°éƒ¨ç½²

```bash
git add .
git commit -m "feat: è¿½è¹¤æ¸…å–®æ’åº + MA20 æ”¯æ´"
git push
```

---

## é©—è­‰æ–¹å¼

1. æŸ¥è©¢ä¸€å€‹è‚¡ç¥¨ï¼ˆå¦‚ AAPLï¼‰
2. æª¢æŸ¥è³‡æ–™åº«ï¼š
   ```sql
   SELECT symbol, price, ma20 FROM stock_price_cache WHERE symbol = 'AAPL';
   ```
3. ç¢ºèª ma20 æ¬„ä½æœ‰å€¼
4. å‰ç«¯è¿½è¹¤æ¸…å–®æ‡‰é¡¯ç¤º MA20 æ¨™ç±¤
5. MA20 æ’åºåŠŸèƒ½æ­£å¸¸

---

## è³‡æ–™æµç¨‹

```
ç”¨æˆ¶æŸ¥è©¢è‚¡ç¥¨
    â”‚
    â”œâ”€â–º Yahoo Finance å–å¾—æ•¸æ“š
    â”‚
    â”œâ”€â–º è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆå« MA20ï¼‰
    â”‚
    â”œâ”€â–º å¯«å…¥ StockPriceCacheï¼ˆå« MA20ï¼‰
    â”‚
    â””â”€â–º å›å‚³çµæœ


ç®¡ç†å“¡ç™»å…¥ / æ’ç¨‹æ›´æ–°
    â”‚
    â””â”€â–º batch_update_stock_prices
        â”‚
        â”œâ”€â–º å–å¾— 1 å€‹æœˆæ­·å²æ•¸æ“š
        â”‚
        â”œâ”€â–º è¨ˆç®— MA20 = æœ€è¿‘ 20 å¤©æ”¶ç›¤åƒ¹å¹³å‡
        â”‚
        â””â”€â–º å¯«å…¥å¿«å–


è¿½è¹¤æ¸…å–®é é¢
    â”‚
    â””â”€â–º GET /api/watchlist/with-prices
        â”‚
        â””â”€â–º å¾å¿«å–è®€å–ï¼ˆå« ma20 æ¬„ä½ï¼‰
            â”‚
            â””â”€â–º å‰ç«¯æ’åº + é¡¯ç¤ºæ¨™ç±¤
```
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/README.md  â­â­â­
> Dashboard å„ªåŒ–ç‰ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# Dashboard å„ªåŒ–ç‰ˆ

## è®Šæ›´

| é …ç›® | åŸå§‹ | å„ªåŒ–å¾Œ |
|------|------|--------|
| dashboard.html | 1,908 è¡Œ | **1,304 è¡Œ** (-32%) |
| Modal | å…§åµŒ | modals.js å‹•æ…‹è¼‰å…¥ |

## å„ªåŒ–å…§å®¹
- ç§»é™¤ 85 è¡Œè¨»è§£
- ç§»é™¤ 30 å€‹ç©ºè¡Œ
- 18 å€‹ Modal ç§»åˆ° modals.js

## éƒ¨ç½²
```bash
cp static/dashboard.html å°ˆæ¡ˆ/static/
cp static/js/modals.js å°ˆæ¡ˆ/static/js/
```
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/SELA-01-BUGä¿®å¾©æŒ‡å—.md  â­â­â­
> ğŸ”§ SELA Bug ä¿®å¾©æŒ‡å—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ SELA Bug ä¿®å¾©æŒ‡å—

> ç‰ˆæœ¬: v0.9.1  
> æœ€å¾Œæ›´æ–°: 2026-01-12  
> é©ç”¨å°ˆæ¡ˆ: SELA å¤šç”¨æˆ¶é¸è‚¡åˆ†æç³»çµ±

---

## ğŸ“‹ ä¿®å¾©æ¸…å–®ç¸½è¦½

| # | å•é¡Œ | å„ªå…ˆç´š | ç‹€æ…‹ |
|---|------|--------|------|
| 1 | å°è‚¡åç¨±é¡¯ç¤ºäº‚ç¢¼ | **ç·Šæ€¥** | å¾…ä¿®å¾© |
| 2 | BRK.B ç­‰å«é»è™Ÿè‚¡ç¥¨æœå°‹å¤±æ•— | é«˜ | å¾…ä¿®å¾© |
| 3 | FIG ç­‰æ–° IPO è‚¡ç¥¨æ‰¾ä¸åˆ°æ•¸æ“š | é«˜ | å¾…ä¿®å¾© |

---

## ğŸ”´ Bug #1: å°è‚¡åç¨±ç·¨ç¢¼ä¿®å¾©ï¼ˆç·Šæ€¥ï¼‰

### å•é¡Œæè¿°

Bundle æ–‡ä»¶ä¸­çš„ `TAIWAN_STOCK_NAMES` å­—å…¸å·²ç¶“æ˜¯äº‚ç¢¼ï¼Œå°è‡´å°è‚¡åç¨±ç„¡æ³•æ­£ç¢ºé¡¯ç¤ºã€‚

**å•é¡Œç¾è±¡ï¼š**
```python
# ç¾åœ¨çš„ç‹€æ…‹ï¼ˆå·²æå£ï¼‰:
"2330": "ÃƒÂ¥Ã‚Ã‚Â°ÃƒÂ§Ã‚Â©Ã‚ÃƒÂ©Ã¢â‚¬ÂºÃ‚Â»"  # æ‡‰è©²æ˜¯ã€Œå°ç©é›»ã€
"0050": "Ã¥â€¦Æ’Ã¥Â¤Â§Ã¥Â°Ã§Â£50"        # æ‡‰è©²æ˜¯ã€Œå…ƒå¤§å°ç£50ã€
```

**åŸå› ï¼š** åœ¨æŸæ¬¡æª”æ¡ˆè™•ç†æ™‚ï¼ŒUTF-8 ç·¨ç¢¼è¢«ç ´å£äº†ã€‚

### éœ€è¦ä¿®å¾©çš„æª”æ¡ˆ

| æª”æ¡ˆ | ä½ç½® | é‡è¦æ€§ |
|------|------|--------|
| `yahoo_finance.py` | `app/data_sources/` | **å¿…é ˆä¿®å¾©** |
| `price_cache_service.py` | `app/services/` | éœ€è¦ä¿®å¾© |

### ä¿®å¾©æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: ä¿®å¾© yahoo_finance.py

æ‰¾åˆ° `app/data_sources/yahoo_finance.py` ä¸­çš„ `TAIWAN_STOCK_NAMES = {...}`ï¼Œ**æ•´å€‹æ›¿æ›ç‚ºä»¥ä¸‹å…§å®¹ï¼š**

```python
TAIWAN_STOCK_NAMES = {
    # æ¬Šå€¼è‚¡
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    # é‡‘èè‚¡
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    # é›»å­è‚¡
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    "5876": "ä¸Šæµ·å•†éŠ€",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ETF
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "006208": "å¯Œé‚¦å°50",
    "00646": "å…ƒå¤§S&P500",
    "00662": "å¯Œé‚¦NASDAQ",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}
```

#### æ­¥é©Ÿ 2: åŒæ¨£ä¿®å¾© price_cache_service.py

æ‰¾åˆ° `app/services/price_cache_service.py` ä¸­çš„ `TAIWAN_STOCK_NAMES = {...}`ï¼Œç”¨ç›¸åŒçš„å­—å…¸æ›¿æ›ã€‚

#### æ­¥é©Ÿ 3: ç¢ºä¿ç·¨ç¢¼æ­£ç¢º

å„²å­˜æ™‚ç¢ºèªç·¨è¼¯å™¨ä½¿ç”¨ **UTF-8 without BOM** ç·¨ç¢¼ã€‚

### é©—è­‰æ–¹å¼

1. é–‹å•Ÿæ¯”è¼ƒé é¢
2. é¸æ“‡å°è‚¡ï¼ˆå¦‚ `2330.TW`ï¼‰
3. ç¢ºèªåç¨±é¡¯ç¤ºç‚ºã€Œå°ç©é›»ã€è€Œéäº‚ç¢¼

### é é˜²æªæ–½

```bash
# Git è¨­å®š
git config --global core.quotepath false

# é¿å…ä½¿ç”¨ Windows è¨˜äº‹æœ¬ç·¨è¼¯ Python æª”æ¡ˆ
# æ¨è–¦ä½¿ç”¨ VS Code ä¸¦è¨­å®šç·¨ç¢¼ç‚º UTF-8
```

---

## ğŸŸ¡ Bug #2 & #3: è‚¡ç¥¨æœå°‹ä¿®å¾©

### å•é¡Œæè¿°

| è‚¡ç¥¨ | å•é¡Œç¾è±¡ | æ ¹æœ¬åŸå›  |
|------|----------|---------|
| BRK.B | æœå°‹è¿”å› 404 | URL ä¸­ `.B` è¢«è§£æç‚ºå‰¯æª”å + Yahoo æ ¼å¼å•é¡Œ |
| FIG | æ‰¾ä¸åˆ°è‚¡ç¥¨ | 2024 IPO æ–°è‚¡ï¼Œåªæœ‰ 1 å¹´æ•¸æ“šï¼Œä½†ç³»çµ±è¦æ±‚ 10 å¹´ |

### éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ

- `app/routers/stock.py`

### ä¿®å¾©æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: ä¿®æ”¹è·¯ç”±å®šç¾©

æ‰¾åˆ°ç´„ç¬¬ **3706 è¡Œ**ï¼š

```python
# âŒ åŸæœ¬
@router.get("/{symbol}", summary="æŸ¥è©¢è‚¡ç¥¨")

# âœ… æ”¹ç‚º
@router.get("/{symbol:path}", summary="æŸ¥è©¢è‚¡ç¥¨")
```

#### æ­¥é©Ÿ 2: æ–°å¢è‚¡ç¥¨ä»£ç¢¼è®Šé«”å‡½æ•¸

åœ¨ `normalize_tw_symbol` å‡½æ•¸å¾Œé¢åŠ å…¥ï¼š

```python
def get_symbol_variants(symbol: str) -> list:
    """
    ç”¢ç”Ÿè‚¡ç¥¨ä»£ç¢¼çš„è®Šé«”åˆ—è¡¨
    BRK.B -> ["BRK.B", "BRK-B"]
    """
    variants = [symbol]
    
    # å« `.` ä½†ä¸æ˜¯å°è‚¡ï¼Œä¹Ÿå˜—è©¦ `-` æ ¼å¼
    if '.' in symbol and not symbol.endswith('.TW') and not symbol.endswith('.TWO'):
        variants.append(symbol.replace('.', '-'))
    
    # å« `-`ï¼Œä¹Ÿå˜—è©¦ `.` æ ¼å¼
    if '-' in symbol:
        variants.append(symbol.replace('-', '.'))
    
    return variants
```

#### æ­¥é©Ÿ 3: ä¿®æ”¹æ­·å²æ•¸æ“šæŠ“å–é‚è¼¯

æ‰¾åˆ°ç´„ç¬¬ **3722-3741 è¡Œ**ï¼Œå°‡åŸæœ¬çš„ç¨‹å¼ç¢¼æ›¿æ›ç‚ºï¼š

```python
df = None
used_period = None
actual_symbol = symbol

# ç”¢ç”Ÿä»£ç¢¼è®Šé«”ï¼ˆBRK.B -> BRK-Bï¼‰
symbol_variants = get_symbol_variants(symbol)

# å˜—è©¦ä¸åŒæœŸé–“ï¼ˆè§£æ±ºæ–°è‚¡å•é¡Œï¼‰
periods = ["10y", "5y", "2y", "1y", "6mo", "3mo"]

for try_symbol in symbol_variants:
    if df is not None and len(df) >= 20:
        break
    for period in periods:
        logger.info(f"å˜—è©¦ {try_symbol} æœŸé–“ {period}...")
        df = yahoo_finance.get_stock_history(try_symbol, period=period)
        if df is not None and len(df) >= 20:
            used_period = period
            actual_symbol = try_symbol
            logger.info(f"æˆåŠŸ: {try_symbol} ä½¿ç”¨ {period}ï¼Œå…± {len(df)} ç­†")
            break

# å°è‚¡ .TW -> .TWO å˜—è©¦
if (df is None or len(df) < 20) and symbol.endswith('.TW'):
    two_symbol = symbol.replace('.TW', '.TWO')
    for period in periods:
        df = yahoo_finance.get_stock_history(two_symbol, period=period)
        if df is not None and len(df) >= 20:
            actual_symbol = two_symbol
            used_period = period
            break

if df is None or len(df) < 20:
    tried = ", ".join(set(symbol_variants))
    raise HTTPException(
        status_code=404,
        detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}ï¼ˆå·²å˜—è©¦: {tried}ï¼‰"
    )

# ä½¿ç”¨å¯¦éš›æ‰¾åˆ°çš„ symbol
symbol = actual_symbol
```

### é©—è­‰æ–¹å¼

| è¼¸å…¥ | é æœŸè¡Œç‚º |
|------|---------|
| `BRK.B` | è‡ªå‹•å˜—è©¦ BRK.B å’Œ BRK-B |
| `BRK-B` | è‡ªå‹•å˜—è©¦ BRK-B å’Œ BRK.B |
| `FIG` | è‡ªå‹•å˜—è©¦è¼ƒçŸ­æœŸé–“ï¼ˆ1y, 6moï¼‰|
| `AAPL` | æ­£å¸¸ï¼ˆ10yï¼‰|
| `2330` | æ­£å¸¸ï¼ˆè‡ªå‹•åŠ  .TWï¼‰|

### ç‰¹æ®Šè‚¡ç¥¨ä»£ç¢¼å°ç…§

| å…¬å¸ | Yahoo æ ¼å¼ | èªªæ˜ |
|------|-----------|------|
| Berkshire A | BRK-A æˆ– BRK.A | ç³»çµ±æœƒè‡ªå‹•å˜—è©¦å…©ç¨® |
| Berkshire B | BRK-B æˆ– BRK.B | ç³»çµ±æœƒè‡ªå‹•å˜—è©¦å…©ç¨® |
| Figma | FIG | 2024 IPOï¼Œéœ€ç”¨çŸ­æœŸé–“ |

---

## âš ï¸ é€šç”¨æ³¨æ„äº‹é …

1. **å‚™ä»½ç¾æœ‰æª”æ¡ˆå†ä¿®æ”¹**
2. **æ‰€æœ‰ Python æª”æ¡ˆå¿…é ˆä½¿ç”¨ UTF-8 ç·¨ç¢¼å„²å­˜**
3. **ä¿®æ”¹å¾Œé€²è¡Œå®Œæ•´æ¸¬è©¦**
4. **éƒ¨ç½²å‘½ä»¤ï¼š**

```bash
git add .
git commit -m "fix: å°è‚¡åç¨±ç·¨ç¢¼ + è‚¡ç¥¨æœå°‹ BRK.B/FIG"
git push
```

---

## âœ… å®Œæˆç¢ºèªæ¸…å–®

- [ ] yahoo_finance.py ä¸­çš„ TAIWAN_STOCK_NAMES å·²ä¿®å¾©
- [ ] price_cache_service.py ä¸­çš„ TAIWAN_STOCK_NAMES å·²ä¿®å¾©
- [ ] stock.py è·¯ç”±æ”¹ç‚º `{symbol:path}`
- [ ] get_symbol_variants å‡½æ•¸å·²åŠ å…¥
- [ ] æ­·å²æ•¸æ“šæŠ“å–é‚è¼¯å·²æ›´æ–°
- [ ] å°è‚¡åç¨±é¡¯ç¤ºæ­£å¸¸
- [ ] BRK.B æœå°‹æ­£å¸¸
- [ ] FIG æœå°‹æ­£å¸¸
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/SELA-02-åŠŸèƒ½æ•´åˆæŒ‡å—.md  â­â­â­
> ğŸš€ SELA åŠŸèƒ½æ•´åˆæŒ‡å—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸš€ SELA åŠŸèƒ½æ•´åˆæŒ‡å—

> ç‰ˆæœ¬: v0.9.1  
> æœ€å¾Œæ›´æ–°: 2026-01-12  
> é©ç”¨å°ˆæ¡ˆ: SELA å¤šç”¨æˆ¶é¸è‚¡åˆ†æç³»çµ±

---

## ğŸ“‹ åŠŸèƒ½æ¸…å–®ç¸½è¦½

| # | åŠŸèƒ½åç¨± | å„ªå…ˆç´š | è¤‡é›œåº¦ | é ä¼°å·¥æ™‚ | ç‹€æ…‹ |
|---|---------|--------|--------|---------|------|
| 1 | è¨­å®šé é¢ UI | P0 | ä¸­ | 4h | å¾…æ•´åˆ |
| 2 | å„€è¡¨æ¿æ¯”ç‰¹å¹£åƒ¹æ ¼ | P2 | ä½ | 1h | å¾…æ•´åˆ |
| 3 | ç®¡ç†å“¡ç™»å…¥è‡ªå‹•æ›´æ–° | P1 | ä½ | 2h | å¾…é–‹ç™¼ |
| 4 | å€‹äººè²·è³£è‚¡ç¥¨ç®¡ç† | P0 | é«˜ | 8h | å¾…é–‹ç™¼ |
| 5 | åˆ—è¡¨æ¸…å–®æ’åº | P1 | ä¸­ | 3h | å¾…é–‹ç™¼ |

---

# åŠŸèƒ½ 1: è¨­å®šé é¢ UI

## 1.1 åŠŸèƒ½æ¦‚è¿°

æ–°å¢ç”¨æˆ¶è¨­å®šé é¢ UIï¼ŒåŒ…å«ï¼š
- å¿«é€Ÿæ¨¡æ¿ï¼ˆæ¥µç°¡/æ¨™æº–/å®Œæ•´/çŸ­ç·šï¼‰
- æŒ‡æ¨™é¡¯ç¤ºé–‹é—œï¼ˆ7 ç¨®æŠ€è¡“æŒ‡æ¨™ï¼‰
- é€šçŸ¥è¨­å®šé–‹é—œï¼ˆ8 ç¨® LINE æ¨æ’­è­¦å ±ï¼‰
- é€²éšåƒæ•¸èª¿æ•´ï¼ˆ14 ç¨®å¯è‡ªè¨‚åƒæ•¸ï¼‰

## 1.2 æ–°å¢æª”æ¡ˆ

| æª”æ¡ˆ | ä½ç½® | èªªæ˜ |
|------|------|------|
| `settings.css` | `static/css/` | è¨­å®šé é¢æ¨£å¼ |
| `settings.js` | `static/js/` | è¨­å®šé é¢é‚è¼¯ |
| `settings-section.html` | `static/` | HTML ç‰‡æ®µ |

## 1.3 æ•´åˆæ­¥é©Ÿ

### æ­¥é©Ÿ 1: è¤‡è£½éœæ…‹è³‡æº

```bash
cp -r settings-ui-update/static/css /path/to/project/static/
cp -r settings-ui-update/static/js /path/to/project/static/
```

### æ­¥é©Ÿ 2: åœ¨ dashboard.html å¼•å…¥è³‡æº

åœ¨ `<head>` å€å¡Šå…§åŠ å…¥ CSSï¼š

```html
<!-- è¨­å®šé é¢æ¨£å¼ -->
<link rel="stylesheet" href="/static/css/settings.css">
```

åœ¨ `</body>` æ¨™ç±¤ä¹‹å‰åŠ å…¥ JavaScriptï¼š

```html
<!-- è¨­å®šé é¢è…³æœ¬ -->
<script src="/static/js/settings.js"></script>
```

### æ­¥é©Ÿ 3: åŠ å…¥ HTML çµæ§‹

å°‡ `settings-section.html` çš„å…§å®¹è¤‡è£½åˆ° dashboard.html ä¸­ï¼Œæ”¾åœ¨å…¶ä»– section ä¹‹å¾Œï¼š

```html
<!-- ç¾æœ‰çš„ sections -->
<section id="section-dashboard" class="section">...</section>
<section id="section-watchlist" class="section hidden">...</section>
<section id="section-compare" class="section hidden">...</section>

<!-- æ–°å¢ï¼šè¨­å®šé é¢ section -->
<section id="section-settings" class="section hidden">
    <!-- å¾ settings-section.html è¤‡è£½å…§å®¹ -->
</section>
```

### æ­¥é©Ÿ 4: æ–°å¢å°èˆªé€£çµ

**æ¡Œé¢ç‰ˆå°èˆªåˆ—ï¼š**

```html
<a onclick="showSection('settings', event)" 
   class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-blue-50 hover:text-gray-700 rounded-lg transition-colors cursor-pointer">
    <i class="fas fa-cog mr-2"></i>
    è¨­å®š
</a>
```

**æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªï¼š**

```html
<button onclick="showSection('settings', event)" 
        class="nav-tab flex flex-col items-center py-2 px-3 text-gray-500 hover:text-orange-500 transition-colors">
    <i class="fas fa-cog text-lg"></i>
    <span class="text-xs mt-1">è¨­å®š</span>
</button>
```

### æ­¥é©Ÿ 5: æ›´æ–° showSection å‡½æ•¸

åœ¨ç¾æœ‰çš„ `showSection` å‡½æ•¸ä¸­åŠ å…¥ï¼š

```javascript
function showSection(name, evt) {
    // ... åŸæœ‰çš„ section åˆ‡æ›é‚è¼¯ ...
    
    // åˆ‡æ›åˆ°è¨­å®šé æ™‚è¼‰å…¥è¨­å®š
    if (name === 'settings') {
        if (typeof initSettingsPage === 'function') {
            initSettingsPage();
        }
    }
}
```

### æ­¥é©Ÿ 6: æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º

åœ¨ç™»å…¥æˆåŠŸå¾Œï¼Œæ›´æ–°è¨­å®šé é¢çš„ç”¨æˆ¶è³‡è¨Šï¼š

```javascript
function updateSettingsUserInfo() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    const avatar = document.getElementById('settings-user-avatar');
    const name = document.getElementById('settings-user-name');
    const level = document.getElementById('settings-user-level');
    
    if (avatar && user.avatar_url) {
        avatar.src = user.avatar_url;
    }
    if (name) {
        name.textContent = user.display_name || 'ç”¨æˆ¶';
    }
    if (level) {
        level.textContent = user.is_admin ? 'ç®¡ç†å“¡' : 'å…è²»æœƒå“¡';
    }
}

// åœ¨ checkAuth() æˆåŠŸå¾Œèª¿ç”¨
updateSettingsUserInfo();
```

## 1.4 API ä¾è³´

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/settings/indicators` | GET/PUT | æŒ‡æ¨™é¡¯ç¤ºè¨­å®š |
| `/api/settings/alerts` | GET/PUT | é€šçŸ¥è¨­å®š |
| `/api/settings/params` | GET/PUT | åƒæ•¸è¨­å®š |
| `/api/settings/template/{name}` | POST | å¥—ç”¨é è¨­æ¨¡æ¿ |

## 1.5 é©—è­‰æ¸…å–®

- [ ] CSS æª”æ¡ˆå·²è¤‡è£½åˆ° `/static/css/`
- [ ] JS æª”æ¡ˆå·²è¤‡è£½åˆ° `/static/js/`
- [ ] dashboard.html å·²å¼•å…¥ CSS
- [ ] dashboard.html å·²å¼•å…¥ JS
- [ ] HTML section å·²åŠ å…¥
- [ ] å°èˆªé€£çµå·²åŠ å…¥ï¼ˆæ¡Œé¢ç‰ˆ + æ‰‹æ©Ÿç‰ˆï¼‰
- [ ] showSection å‡½æ•¸å·²æ›´æ–°
- [ ] æ¸¬è©¦ï¼šå¯ä»¥åˆ‡æ›åˆ°è¨­å®šé é¢
- [ ] æ¸¬è©¦ï¼šè¨­å®šå¯ä»¥æ­£å¸¸è¼‰å…¥/å„²å­˜
- [ ] æ¸¬è©¦ï¼šæ¨¡æ¿å¯ä»¥æ­£å¸¸å¥—ç”¨

---

# åŠŸèƒ½ 2: å„€è¡¨æ¿æ¯”ç‰¹å¹£åƒ¹æ ¼

## 2.1 åŠŸèƒ½æ¦‚è¿°

åœ¨å„€è¡¨æ¿é é¢æ–°å¢æ¯”ç‰¹å¹£åƒ¹æ ¼å¡ç‰‡ï¼Œä½ç½®åœ¨ææ‡¼è²ªå©ªæŒ‡æ•¸ä¸‹æ–¹ã€‚

**åŠŸèƒ½ç‰¹è‰²ï¼š**
- å³æ™‚ BTC åƒ¹æ ¼ï¼ˆç¾å…ƒï¼‰
- 24h æ¼²è·Œå¹… + é€±/æœˆæ¼²è·Œ
- å‹•æ…‹èƒŒæ™¯è‰²ï¼ˆå¤§æ¼²ç¶ ã€å¤§è·Œç´…ã€å¹³ç›¤æ©˜ï¼‰
- æ¯ 60 ç§’è‡ªå‹•æ›´æ–°
- é»æ“Šè·³è½‰æŸ¥è©¢ BTC è©³æƒ…

## 2.2 UI è¨­è¨ˆ

| ç‹€æ…‹ | èƒŒæ™¯è‰² |
|------|--------|
| å¤§æ¼² (â‰¥3%) | ç¶ è‰²æ¼¸å±¤ |
| å¤§è·Œ (â‰¤-3%) | ç´…è‰²æ¼¸å±¤ |
| å¹³ç›¤ | æ©˜é»ƒæ¼¸å±¤ï¼ˆé è¨­ï¼‰ |

## 2.3 æ•´åˆæ–¹å¼

ç›´æ¥ç”¨æ›´æ–°åŒ…ä¸­çš„ `static/dashboard.html` æ›¿æ›å°ˆæ¡ˆä¸­çš„åŒåæª”æ¡ˆã€‚

**æˆ–æ‰‹å‹•åŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š**

### HTML éƒ¨åˆ†

åœ¨å„€è¡¨æ¿å€å¡ŠåŠ å…¥ï¼š

```html
<!-- æ¯”ç‰¹å¹£åƒ¹æ ¼å¡ç‰‡ -->
<div id="btc-price-card" 
     onclick="searchStock('BTC')" 
     class="bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl p-4 text-white cursor-pointer hover:shadow-lg transition-shadow">
    <div class="flex items-center justify-between">
        <div>
            <div class="text-sm opacity-80">Bitcoin</div>
            <div class="text-2xl font-bold" id="btc-price">$--,---</div>
        </div>
        <div class="text-right">
            <div class="text-lg font-semibold" id="btc-change-24h">--%</div>
            <div class="text-xs opacity-80">24h</div>
        </div>
        <i class="fab fa-bitcoin text-4xl opacity-50"></i>
    </div>
    <div class="mt-2 flex justify-between text-xs opacity-80">
        <span>é€±: <span id="btc-change-week">--%</span></span>
        <span>æœˆ: <span id="btc-change-month">--%</span></span>
    </div>
</div>
```

### JavaScript éƒ¨åˆ†

```javascript
async function loadBtcPrice() {
    try {
        const res = await fetch(`${API_BASE}/api/crypto/BTC`);
        const data = await res.json();
        
        if (data.success) {
            const price = data.price.current;
            const change24h = data.change.day;
            const changeWeek = data.change.week;
            const changeMonth = data.change.month;
            
            // æ›´æ–°åƒ¹æ ¼
            document.getElementById('btc-price').textContent = 
                `$${price.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
            
            // æ›´æ–°æ¼²è·Œå¹…
            const change24hEl = document.getElementById('btc-change-24h');
            change24hEl.textContent = `${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%`;
            
            document.getElementById('btc-change-week').textContent = 
                `${changeWeek >= 0 ? '+' : ''}${changeWeek.toFixed(1)}%`;
            document.getElementById('btc-change-month').textContent = 
                `${changeMonth >= 0 ? '+' : ''}${changeMonth.toFixed(1)}%`;
            
            // å‹•æ…‹èƒŒæ™¯è‰²
            const card = document.getElementById('btc-price-card');
            card.className = card.className.replace(/from-\w+-\d+ to-\w+-\d+/g, '');
            
            if (change24h >= 3) {
                card.classList.add('from-green-500', 'to-emerald-600');
            } else if (change24h <= -3) {
                card.classList.add('from-red-500', 'to-rose-600');
            } else {
                card.classList.add('from-orange-500', 'to-yellow-500');
            }
        }
    } catch (e) {
        console.error('è¼‰å…¥ BTC åƒ¹æ ¼å¤±æ•—:', e);
    }
}

// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
document.addEventListener('DOMContentLoaded', () => {
    loadBtcPrice();
    // æ¯ 60 ç§’æ›´æ–°
    setInterval(loadBtcPrice, 60000);
});
```

## 2.4 API ä¾è³´

```
GET /api/crypto/BTC

Response:
{
    "success": true,
    "price": { "current": 97000 },
    "change": { "day": 2.5, "week": 5.2, "month": 10.3 }
}
```

## 2.5 é©—è­‰æ¸…å–®

- [ ] BTC åƒ¹æ ¼å¡ç‰‡é¡¯ç¤ºåœ¨å„€è¡¨æ¿
- [ ] åƒ¹æ ¼æ ¼å¼åŒ–ï¼ˆåƒåˆ†ä½ï¼‰
- [ ] æ¼²è·Œå¹…æ­£ç¢ºé¡¯ç¤º
- [ ] é¡è‰²æ­£ç¢ºï¼ˆç¶ æ¼²ç´…è·Œï¼‰
- [ ] èƒŒæ™¯è‰²å‹•æ…‹è®ŠåŒ–
- [ ] 60 ç§’è‡ªå‹•æ›´æ–°
- [ ] é»æ“Šè·³è½‰æŸ¥è©¢ BTC
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ‰‹æ©Ÿ/æ¡Œé¢ï¼‰

---

# åŠŸèƒ½ 3: ç®¡ç†å“¡ç™»å…¥è‡ªå‹•æ›´æ–°

## 3.1 åŠŸèƒ½æ¦‚è¿°

ç®¡ç†å“¡ç™»å…¥å¾Œï¼Œè‡ªå‹•åœ¨èƒŒæ™¯è§¸ç™¼ç³»çµ±æ›´æ–°ï¼Œä¸é˜»å¡ç™»å…¥æµç¨‹ã€‚

## 3.2 è§¸ç™¼æ™‚æ©Ÿ

- ç®¡ç†å“¡æˆåŠŸç™»å…¥æ™‚ï¼ˆ`is_admin=True`ï¼‰
- åƒ…è§¸ç™¼ä¸€æ¬¡

## 3.3 æ›´æ–°é …ç›®

```python
AUTO_UPDATE_TASKS = [
    "update_stock_prices",      # æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼å¿«å–
    "update_crypto_prices",     # æ›´æ–°åŠ å¯†è²¨å¹£åƒ¹æ ¼
    "update_market_sentiment",  # æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸
    "cleanup_old_data",         # æ¸…ç†éæœŸæ•¸æ“š
]
```

## 3.4 æŠ€è¡“è¨­è¨ˆ

### å¾Œç«¯ä¿®æ”¹

**æª”æ¡ˆ:** `app/routers/auth.py`

```python
# åœ¨ LINE callback è™•ç†æˆåŠŸç™»å…¥å¾ŒåŠ å…¥

@router.get("/callback")
async def line_callback(..., background_tasks: BackgroundTasks):
    # ... ç¾æœ‰ç™»å…¥é‚è¼¯ ...
    
    # ç®¡ç†å“¡ç™»å…¥è§¸ç™¼è‡ªå‹•æ›´æ–°
    if user.is_admin:
        background_tasks.add_task(trigger_admin_updates, db)
    
    return RedirectResponse(...)


async def trigger_admin_updates(db: Session):
    """ç®¡ç†å“¡ç™»å…¥è§¸ç™¼çš„èƒŒæ™¯æ›´æ–°"""
    from app.services.price_cache_service import PriceCacheService
    
    logger.info("ğŸ”„ ç®¡ç†å“¡ç™»å…¥ï¼Œè§¸ç™¼è‡ªå‹•æ›´æ–°...")
    
    try:
        cache_service = PriceCacheService(db)
        
        # 1. æ›´æ–°æ‰€æœ‰è¿½è¹¤è‚¡ç¥¨åƒ¹æ ¼
        result = cache_service.update_all_prices()
        logger.info(f"è‚¡ç¥¨åƒ¹æ ¼æ›´æ–°: {result}")
        
        # 2. æ›´æ–°å¸‚å ´æƒ…ç·’
        from app.services.market_service import market_service
        market_service.update_fear_greed()
        
        logger.info("âœ… è‡ªå‹•æ›´æ–°å®Œæˆ")
        
    except Exception as e:
        logger.error(f"è‡ªå‹•æ›´æ–°å¤±æ•—: {e}")
```

### API ç«¯é»ï¼ˆå¯é¸ï¼‰

```
POST /api/admin/trigger-update
Authorization: Bearer {admin_token}

Response:
{
    "success": true,
    "message": "æ›´æ–°å·²è§¸ç™¼",
    "tasks": ["stock_prices", "crypto_prices", "market_sentiment"]
}
```

## 3.5 å‰ç«¯æç¤ºï¼ˆå¯é¸ï¼‰

ç™»å…¥å¾Œåœ¨å„€è¡¨æ¿é¡¯ç¤º Toast æç¤ºï¼š

```javascript
if (user.is_admin) {
    showToast('ğŸ”„ ç³»çµ±æ­£åœ¨èƒŒæ™¯æ›´æ–°æ•¸æ“š...', 'info');
}
```

## 3.6 é©—è­‰æ¸…å–®

- [ ] ç®¡ç†å“¡ç™»å…¥å¾Œè‡ªå‹•è§¸ç™¼æ›´æ–°
- [ ] æ›´æ–°åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä¸å½±éŸ¿ç™»å…¥
- [ ] æ›´æ–°æ—¥èªŒæ­£ç¢ºè¨˜éŒ„

---

# åŠŸèƒ½ 4: å€‹äººè²·è³£è‚¡ç¥¨ç®¡ç†

## 4.1 åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ¶å¯è¨˜éŒ„å€‹äººè‚¡ç¥¨è²·è³£äº¤æ˜“ï¼Œè¿½è¹¤æŒè‚¡å’Œæç›Šã€‚

## 4.2 è³‡æ–™åº«è¨­è¨ˆ

### æ–°å¢æª”æ¡ˆ

**æª”æ¡ˆ:** `app/models/portfolio.py`

```python
"""
å€‹äººæŠ•è³‡çµ„åˆæ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, ForeignKey, Index
from sqlalchemy.sql import func
from app.database import Base


class PortfolioTransaction(Base):
    """äº¤æ˜“ç´€éŒ„"""
    
    __tablename__ = "portfolio_transactions"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    
    # è‚¡ç¥¨è³‡è¨Š
    symbol = Column(String(20), nullable=False)           # è‚¡ç¥¨ä»£ç¢¼
    name = Column(String(100))                            # è‚¡ç¥¨åç¨±
    market = Column(String(10), nullable=False)           # tw / us
    
    # äº¤æ˜“è³‡è¨Š
    transaction_type = Column(String(10), nullable=False) # buy / sell
    quantity = Column(Integer, nullable=False)            # è‚¡æ•¸
    price = Column(Numeric(12, 4), nullable=False)        # æˆäº¤åƒ¹
    fee = Column(Numeric(10, 2), default=0)               # æ‰‹çºŒè²»
    tax = Column(Numeric(10, 2), default=0)               # äº¤æ˜“ç¨…ï¼ˆè³£å‡ºæ™‚ï¼‰
    transaction_date = Column(Date, nullable=False)       # äº¤æ˜“æ—¥æœŸ
    
    # å‚™è¨»
    note = Column(String(500))
    
    # æ™‚é–“æˆ³
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    # ç´¢å¼•
    __table_args__ = (
        Index('idx_portfolio_user', 'user_id'),
        Index('idx_portfolio_symbol', 'symbol'),
        Index('idx_portfolio_market', 'market'),
        Index('idx_portfolio_date', 'transaction_date'),
    )
    
    @property
    def total_cost(self) -> float:
        """ç¸½æˆæœ¬ï¼ˆå«æ‰‹çºŒè²»ï¼‰"""
        base = float(self.quantity) * float(self.price)
        if self.transaction_type == "buy":
            return base + float(self.fee or 0)
        else:  # sell
            return base - float(self.fee or 0) - float(self.tax or 0)
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "name": self.name,
            "market": self.market,
            "transaction_type": self.transaction_type,
            "quantity": self.quantity,
            "price": float(self.price),
            "fee": float(self.fee or 0),
            "tax": float(self.tax or 0),
            "total_cost": self.total_cost,
            "transaction_date": self.transaction_date.isoformat() if self.transaction_date else None,
            "note": self.note,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }


class PortfolioHolding(Base):
    """æŒè‚¡å½™ç¸½"""
    
    __tablename__ = "portfolio_holdings"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(20), nullable=False)
    name = Column(String(100))
    market = Column(String(10), nullable=False)
    
    # æŒè‚¡è³‡è¨Š
    total_shares = Column(Integer, default=0)              # ç¸½æŒè‚¡
    avg_cost = Column(Numeric(12, 4), default=0)           # å¹³å‡æˆæœ¬
    total_invested = Column(Numeric(14, 2), default=0)     # ç¸½æŠ•å…¥é‡‘é¡
    realized_profit = Column(Numeric(14, 2), default=0)    # å·²å¯¦ç¾æç›Š
    
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_holding_user_symbol', 'user_id', 'symbol', 'market', unique=True),
    )
```

## 4.3 API è¨­è¨ˆ

**æª”æ¡ˆ:** `app/routers/portfolio.py`

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/api/portfolio/transactions` | å–å¾—äº¤æ˜“ç´€éŒ„ |
| POST | `/api/portfolio/transactions` | æ–°å¢äº¤æ˜“ |
| PUT | `/api/portfolio/transactions/{id}` | ä¿®æ”¹äº¤æ˜“ |
| DELETE | `/api/portfolio/transactions/{id}` | åˆªé™¤äº¤æ˜“ |
| GET | `/api/portfolio/holdings` | å–å¾—æŒè‚¡ç¸½è¦½ |
| GET | `/api/portfolio/holdings/{market}` | å–å¾—ç‰¹å®šå¸‚å ´æŒè‚¡ |
| GET | `/api/portfolio/summary` | å–å¾—æŠ•è³‡æ‘˜è¦ |

### è«‹æ±‚æ ¼å¼

```python
# POST /api/portfolio/transactions
class TransactionCreate(BaseModel):
    symbol: str                     # "2330" æˆ– "AAPL"
    name: Optional[str] = None      # "å°ç©é›»" æˆ– "Apple"
    market: str                     # "tw" æˆ– "us"
    transaction_type: str           # "buy" æˆ– "sell"
    quantity: int                   # è‚¡æ•¸
    price: float                    # æˆäº¤åƒ¹
    fee: Optional[float] = 0        # æ‰‹çºŒè²»
    tax: Optional[float] = 0        # äº¤æ˜“ç¨…
    transaction_date: date          # äº¤æ˜“æ—¥æœŸ
    note: Optional[str] = None      # å‚™è¨»
```

### å›æ‡‰æ ¼å¼

```python
# GET /api/portfolio/summary
{
    "success": true,
    "data": {
        "total_invested": 100000,     # ç¸½æŠ•å…¥
        "current_value": 120000,      # ç¾å€¼
        "unrealized_profit": 20000,   # æœªå¯¦ç¾æç›Š
        "realized_profit": 5000,      # å·²å¯¦ç¾æç›Š
        "total_profit": 25000,        # ç¸½æç›Š
        "return_rate": 25.0,          # å ±é…¬ç‡ %
        "tw_count": 5,                # å°è‚¡æŒè‚¡æ•¸
        "us_count": 3,                # ç¾è‚¡æŒè‚¡æ•¸
    }
}
```

## 4.4 å‰ç«¯é é¢çµæ§‹

```
ğŸ“Š æŠ•è³‡çµ„åˆ
â”œâ”€â”€ ğŸ“ˆ ç¸½è¦½å¡ç‰‡
â”‚   â”œâ”€â”€ ç¸½è³‡ç”¢
â”‚   â”œâ”€â”€ ç¸½æç›Š
â”‚   â””â”€â”€ å ±é…¬ç‡
â”œâ”€â”€ ğŸ”„ Tab åˆ‡æ›
â”‚   â”œâ”€â”€ å°è‚¡
â”‚   â””â”€â”€ ç¾è‚¡
â”œâ”€â”€ ğŸ“‹ æŒè‚¡åˆ—è¡¨
â”‚   â”œâ”€â”€ è‚¡ç¥¨åç¨±
â”‚   â”œâ”€â”€ æŒè‚¡æ•¸
â”‚   â”œâ”€â”€ å¹³å‡æˆæœ¬
â”‚   â”œâ”€â”€ ç¾åƒ¹
â”‚   â””â”€â”€ æç›Š
â””â”€â”€ â• æ–°å¢äº¤æ˜“æŒ‰éˆ•
```

## 4.5 æ–°å¢æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `app/models/portfolio.py` | æŠ•è³‡çµ„åˆè³‡æ–™æ¨¡å‹ |
| `app/routers/portfolio.py` | æŠ•è³‡çµ„åˆ API |
| `app/services/portfolio_service.py` | æŠ•è³‡çµ„åˆæ¥­å‹™é‚è¼¯ |
| `static/js/portfolio.js` | æŠ•è³‡çµ„åˆå‰ç«¯ |
| `static/css/portfolio.css` | æŠ•è³‡çµ„åˆæ¨£å¼ |

## 4.6 é©—è­‰æ¸…å–®

- [ ] å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤äº¤æ˜“ç´€éŒ„
- [ ] å°è‚¡/ç¾è‚¡åˆ†é–‹é¡¯ç¤º
- [ ] æŒè‚¡å’Œæç›Šè¨ˆç®—æ­£ç¢º
- [ ] æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæ­£å¸¸

---

# åŠŸèƒ½ 5: åˆ—è¡¨æ¸…å–®æ’åº

## 5.1 åŠŸèƒ½æ¦‚è¿°

å„ç¨®åˆ—è¡¨æ”¯æ´é»æ“Šæ¬„ä½æ¨™é¡Œæ’åºã€‚

## 5.2 é©ç”¨é é¢

1. è‡ªé¸è‚¡åˆ—è¡¨ï¼ˆ`watchlist`ï¼‰
2. æ¯”è¼ƒé é¢ï¼ˆ`compare`ï¼‰
3. æŠ•è³‡çµ„åˆï¼ˆ`portfolio`ï¼‰

## 5.3 é€šç”¨æ’åºæ¨¡çµ„

**æª”æ¡ˆ:** `static/js/table-sort.js`

```javascript
/**
 * è¡¨æ ¼æ’åºæ¨¡çµ„
 */
class TableSorter {
    constructor(tableId, options = {}) {
        this.table = document.getElementById(tableId);
        this.data = [];
        this.currentSort = { column: null, direction: 'asc' };
        this.options = {
            onSort: options.onSort || null,
            savePreference: options.savePreference !== false,
            storageKey: options.storageKey || `sort_${tableId}`,
        };
        
        this.init();
    }
    
    init() {
        // è¼‰å…¥å„²å­˜çš„åå¥½
        if (this.options.savePreference) {
            const saved = localStorage.getItem(this.options.storageKey);
            if (saved) {
                this.currentSort = JSON.parse(saved);
            }
        }
        
        // ç¶å®šæ¨™é¡Œé»æ“Šäº‹ä»¶
        this.bindHeaders();
    }
    
    bindHeaders() {
        const headers = this.table.querySelectorAll('th[data-sort]');
        headers.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                this.sort(header.dataset.sort);
            });
            
            // åŠ å…¥æ’åºåœ–ç¤º
            const icon = document.createElement('i');
            icon.className = 'fas fa-sort ml-1 opacity-30';
            header.appendChild(icon);
        });
    }
    
    setData(data) {
        this.data = [...data];
        if (this.currentSort.column) {
            this.applySort();
        }
    }
    
    sort(column) {
        // åˆ‡æ›æ–¹å‘
        if (this.currentSort.column === column) {
            this.currentSort.direction = 
                this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.column = column;
            this.currentSort.direction = 'asc';
        }
        
        // å„²å­˜åå¥½
        if (this.options.savePreference) {
            localStorage.setItem(
                this.options.storageKey, 
                JSON.stringify(this.currentSort)
            );
        }
        
        this.applySort();
        this.updateIcons();
    }
    
    applySort() {
        const { column, direction } = this.currentSort;
        
        this.data.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            
            // è™•ç†æ•¸å­—
            if (typeof valA === 'string' && !isNaN(parseFloat(valA))) {
                valA = parseFloat(valA);
                valB = parseFloat(valB);
            }
            
            // è™•ç† null/undefined
            if (valA == null) return 1;
            if (valB == null) return -1;
            
            // æ¯”è¼ƒ
            let result = 0;
            if (typeof valA === 'string') {
                result = valA.localeCompare(valB, 'zh-TW');
            } else {
                result = valA - valB;
            }
            
            return direction === 'asc' ? result : -result;
        });
        
        // è§¸ç™¼å›èª¿
        if (this.options.onSort) {
            this.options.onSort(this.data, this.currentSort);
        }
    }
    
    updateIcons() {
        const headers = this.table.querySelectorAll('th[data-sort]');
        headers.forEach(header => {
            const icon = header.querySelector('i');
            const column = header.dataset.sort;
            
            if (column === this.currentSort.column) {
                icon.className = this.currentSort.direction === 'asc' 
                    ? 'fas fa-sort-up ml-1' 
                    : 'fas fa-sort-down ml-1';
                icon.classList.remove('opacity-30');
            } else {
                icon.className = 'fas fa-sort ml-1 opacity-30';
            }
        });
    }
    
    getData() {
        return this.data;
    }
}

// å°å‡º
window.TableSorter = TableSorter;
```

## 5.4 ä½¿ç”¨ç¯„ä¾‹

### è‡ªé¸è‚¡åˆ—è¡¨

```html
<table id="watchlist-table">
    <thead>
        <tr>
            <th data-sort="symbol">ä»£ç¢¼</th>
            <th data-sort="name">åç¨±</th>
            <th data-sort="price">ç¾åƒ¹</th>
            <th data-sort="change_pct">æ¼²è·Œå¹…</th>
            <th data-sort="volume">æˆäº¤é‡</th>
        </tr>
    </thead>
    <tbody id="watchlist-body"></tbody>
</table>

<script>
const watchlistSorter = new TableSorter('watchlist-table', {
    onSort: (sortedData) => {
        renderWatchlistTable(sortedData);
    },
    storageKey: 'watchlist_sort'
});

// è¼‰å…¥æ•¸æ“šæ™‚
function loadWatchlist(data) {
    watchlistSorter.setData(data);
    renderWatchlistTable(watchlistSorter.getData());
}
</script>
```

### æ¯”è¼ƒé é¢

```html
<table id="compare-table">
    <thead>
        <tr>
            <th>æ’å</th>
            <th data-sort="symbol">æ¨™çš„</th>
            <th data-sort="price">ç¾åƒ¹</th>
            <th data-sort="return_1y">1å¹´</th>
            <th data-sort="return_3y">3å¹´</th>
            <th data-sort="return_5y">5å¹´</th>
        </tr>
    </thead>
</table>
```

## 5.5 é©—è­‰æ¸…å–®

- [ ] é»æ“Šæ¨™é¡Œå¯æ’åº
- [ ] å‡é™åºåˆ‡æ›æ­£å¸¸
- [ ] æ’åºåå¥½è¢«è¨˜ä½
- [ ] æ’åºåœ–ç¤ºæ­£ç¢ºé¡¯ç¤º

---

# ğŸ“… å¯¦ä½œé †åºå»ºè­°

```
Week 1:
â”œâ”€â”€ Day 1: åŠŸèƒ½ 2 (BTC åƒ¹æ ¼) - ç°¡å–®ï¼Œå¿«é€Ÿè¦‹æ•ˆ
â”œâ”€â”€ Day 2: åŠŸèƒ½ 3 (ç®¡ç†å“¡æ›´æ–°) - å¾Œç«¯ç‚ºä¸»
â””â”€â”€ Day 3: åŠŸèƒ½ 5 (æ’åº) - é€šç”¨æ¨¡çµ„ + åŠŸèƒ½ 1 (è¨­å®šé é¢)

Week 2:
â”œâ”€â”€ Day 1-2: åŠŸèƒ½ 4 å¾Œç«¯ (Model + API)
â”œâ”€â”€ Day 3-4: åŠŸèƒ½ 4 å‰ç«¯ (UI + æ•´åˆ)
â””â”€â”€ Day 5: æ¸¬è©¦ + ä¿®å¾©
```

---

# ğŸ“ æ–°å¢/ä¿®æ”¹æª”æ¡ˆç¸½è¦½

## æ–°å¢æª”æ¡ˆ

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `app/models/portfolio.py` | æŠ•è³‡çµ„åˆè³‡æ–™æ¨¡å‹ |
| `app/routers/portfolio.py` | æŠ•è³‡çµ„åˆ API |
| `app/services/portfolio_service.py` | æŠ•è³‡çµ„åˆæ¥­å‹™é‚è¼¯ |
| `static/js/portfolio.js` | æŠ•è³‡çµ„åˆå‰ç«¯ |
| `static/css/portfolio.css` | æŠ•è³‡çµ„åˆæ¨£å¼ |
| `static/js/settings.js` | è¨­å®šé é¢é‚è¼¯ |
| `static/css/settings.css` | è¨­å®šé é¢æ¨£å¼ |
| `static/js/table-sort.js` | é€šç”¨æ’åºæ¨¡çµ„ |

## ä¿®æ”¹æª”æ¡ˆ

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|----------|
| `app/routers/auth.py` | åŠ å…¥ç®¡ç†å“¡è‡ªå‹•æ›´æ–° |
| `app/routers/__init__.py` | è¨»å†Š portfolio router |
| `app/models/__init__.py` | åŒ¯å‡ºæ–°æ¨¡å‹ |
| `static/dashboard.html` | åŠ å…¥ BTC åƒ¹æ ¼ã€è¨­å®šå°èˆªã€æŠ•è³‡çµ„åˆå°èˆª |
| `static/js/watchlist.js` | æ•´åˆæ’åºåŠŸèƒ½ |
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/SELA-03-ç³»çµ±è¦æ ¼æ›¸.md  â­â­â­
> ğŸ“ˆ SELA ç³»çµ±è¦æ ¼æ›¸ï¼ˆç²¾ç°¡ç‰ˆï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ“ˆ SELA ç³»çµ±è¦æ ¼æ›¸ï¼ˆç²¾ç°¡ç‰ˆï¼‰

> ç‰ˆæœ¬: 1.0  
> æœ€å¾Œæ›´æ–°: 2026-01-12  
> å®Œæ•´ç‰ˆæœ¬: stock-analysis-system-spec.md

---

## 1. å°ˆæ¡ˆæ¦‚è¿°

### 1.1 å°ˆæ¡ˆç›®æ¨™

å»ºç«‹ä¸€å€‹æ”¯æ´å¤šç”¨æˆ¶çš„è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°ã€‚

### 1.2 æ ¸å¿ƒç‰¹è‰²

| ç‰¹è‰² | èªªæ˜ |
|------|------|
| å¤šç”¨æˆ¶æ”¯æ´ | LINE ç™»å…¥ï¼Œæ¯äººç¨ç«‹è¿½è¹¤æ¸…å–® |
| å…±äº«è³‡æ–™åº« | è‚¡åƒ¹è³‡æ–™å…±ç”¨ï¼Œæ¸›å°‘ API å‘¼å« |
| å½ˆæ€§æŒ‡æ¨™ | ç”¨æˆ¶å¯è‡ªé¸è¦é¡¯ç¤º/é€šçŸ¥çš„æŒ‡æ¨™ |
| æ™ºèƒ½é è­¦ | çªç ´ã€äº¤å‰ã€æ¥µç«¯å€¼è‡ªå‹•æ¨æ’­ |
| é›™å¸‚å ´ | åŒæ™‚æ”¯æ´ç¾è‚¡èˆ‡åŠ å¯†è²¨å¹£ |

### 1.3 æ”¯æ´è³‡ç”¢

| é¡å‹ | æ¨™çš„ |
|------|------|
| ç¾è‚¡ | æ‰€æœ‰ Yahoo Finance æ”¯æ´çš„è‚¡ç¥¨ä»£è™Ÿ |
| å°è‚¡ | Yahoo Finance å°è‚¡ (.TW / .TWO) |
| åŠ å¯†è²¨å¹£ | BTCï¼ˆæ¯”ç‰¹å¹£ï¼‰ã€ETHï¼ˆä»¥å¤ªå¹£ï¼‰ |

---

## 2. ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ä»‹é¢                              â”‚
â”‚              (Web æ‡‰ç”¨ç¨‹å¼ / LINE Bot)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        API å±¤                                â”‚
â”‚    â”œâ”€ ç”¨æˆ¶é©—è­‰ (LINE Login)                                  â”‚
â”‚    â”œâ”€ è¿½è¹¤æ¸…å–®ç®¡ç†                                           â”‚
â”‚    â”œâ”€ è‚¡ç¥¨/å¹£åœˆæŸ¥è©¢                                          â”‚
â”‚    â””â”€ è¨­å®šç®¡ç†                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      å•†æ¥­é‚è¼¯å±¤                               â”‚
â”‚    â”œâ”€ æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å¼•æ“                                        â”‚
â”‚    â”œâ”€ è¨Šè™Ÿåµæ¸¬å¼•æ“                                           â”‚
â”‚    â”œâ”€ ç¶œåˆè©•åˆ†ç³»çµ±                                           â”‚
â”‚    â””â”€ é€šçŸ¥æ’ç¨‹æœå‹™                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       å¿«å–å±¤                                  â”‚
â”‚    â””â”€ åˆ¤æ–·è®€å–æœ¬åœ°è³‡æ–™åº« æˆ– æŠ“å–å¤–éƒ¨ API                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      è³‡æ–™åº«å±¤                                 â”‚
â”‚    â”œâ”€ å…±äº«è³‡æ–™ (è‚¡åƒ¹ã€å¹£åƒ¹ã€æƒ…ç·’æŒ‡æ•¸)                          â”‚
â”‚    â””â”€ ç§æœ‰è³‡æ–™ (ç”¨æˆ¶ã€è¿½è¹¤æ¸…å–®ã€è¨­å®š)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å¤–éƒ¨è³‡æ–™ä¾†æº                               â”‚
â”‚    â”œâ”€ Yahoo Finance (ç¾è‚¡/å°è‚¡)                              â”‚
â”‚    â”œâ”€ CoinGecko (åŠ å¯†è²¨å¹£)                                   â”‚
â”‚    â”œâ”€ CNN Fear & Greed (ç¾è‚¡æƒ…ç·’)                            â”‚
â”‚    â”œâ”€ Alternative.me (å¹£åœˆæƒ…ç·’)                              â”‚
â”‚    â””â”€ LINE Login API (ç”¨æˆ¶é©—è­‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. è³‡æ–™ä¾†æº

### 3.1 å¤–éƒ¨ API

| ä¾†æº | ç”¨é€” | å–å¾—æ–¹å¼ |
|------|------|----------|
| Yahoo Finance | ç¾è‚¡/å°è‚¡è‚¡åƒ¹ | yfinance Python å¥—ä»¶ |
| CoinGecko | BTC/ETH åƒ¹æ ¼ | å…è²»å…¬é–‹ API |
| CNN Fear & Greed | ç¾è‚¡å¸‚å ´æƒ…ç·’ | ç¶²é çˆ¬èŸ² æˆ– ç¬¬ä¸‰æ–¹ API |
| Alternative.me | å¹£åœˆæƒ…ç·’ | å…è²»å…¬é–‹ API |

### 3.2 è³‡æ–™æ›´æ–°ç­–ç•¥

| è³‡æ–™é¡å‹ | æ›´æ–°é »ç‡ | è§¸ç™¼æ–¹å¼ |
|----------|----------|----------|
| ç¾è‚¡è‚¡åƒ¹ | æ¯æ—¥ä¸€æ¬¡ | ç¾è‚¡æ”¶ç›¤å¾Œ (ç´„ UTC+8 05:00) |
| åŠ å¯†è²¨å¹£ | æ¯å°æ™‚ æˆ– æŸ¥è©¢æ™‚ | æ’ç¨‹ / ç”¨æˆ¶æŸ¥è©¢è§¸ç™¼ |
| æƒ…ç·’æŒ‡æ•¸ | æ¯æ—¥ä¸€æ¬¡ | æ’ç¨‹ä»»å‹™ |

---

## 4. è³‡æ–™åº«è¨­è¨ˆ

### 4.1 å…±äº«è³‡æ–™è¡¨

#### stock_pricesï¼ˆè‚¡ç¥¨åƒ¹æ ¼æ­·å²ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| symbol | VARCHAR(10) | è‚¡ç¥¨ä»£è™Ÿ |
| date | DATE | äº¤æ˜“æ—¥æœŸ |
| open/high/low/close | DECIMAL(12,4) | OHLC åƒ¹æ ¼ |
| volume | BIGINT | æˆäº¤é‡ |
| updated_at | TIMESTAMP | è³‡æ–™æ›´æ–°æ™‚é–“ |

#### crypto_pricesï¼ˆåŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| symbol | VARCHAR(10) | å¹£ç¨®ä»£è™Ÿ |
| date | DATE | æ—¥æœŸ |
| price | DECIMAL(18,8) | åƒ¹æ ¼ (USD) |
| volume_24h | DECIMAL(18,2) | 24 å°æ™‚æˆäº¤é‡ |
| market_cap | DECIMAL(18,2) | å¸‚å€¼ |

#### market_sentimentï¼ˆå¸‚å ´æƒ…ç·’æŒ‡æ•¸ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| date | DATE | æ—¥æœŸ |
| market | VARCHAR(10) | stock / crypto |
| value | INTEGER | æŒ‡æ•¸å€¼ (0-100) |
| classification | VARCHAR(20) | æ–‡å­—åˆ†é¡ |

### 4.2 ç§æœ‰è³‡æ–™è¡¨

#### usersï¼ˆç”¨æˆ¶è³‡æ–™ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| line_user_id | VARCHAR(50) | LINE å”¯ä¸€è­˜åˆ¥ç¢¼ |
| display_name | VARCHAR(100) | LINE é¡¯ç¤ºåç¨± |
| picture_url | VARCHAR(500) | LINE é ­åƒç¶²å€ |
| is_admin | BOOLEAN | æ˜¯å¦ç‚ºç®¡ç†å“¡ |
| created_at | TIMESTAMP | è¨»å†Šæ™‚é–“ |

#### watchlistsï¼ˆè¿½è¹¤æ¸…å–®ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | INTEGER | ä¸»éµ |
| user_id | INTEGER | ç”¨æˆ¶ ID (FK) |
| symbol | VARCHAR(10) | è‚¡ç¥¨/å¹£ç¨®ä»£è™Ÿ |
| asset_type | VARCHAR(10) | stock / crypto |
| note | VARCHAR(200) | è‡ªè¨‚å‚™è¨» |

#### user_indicator_settingsï¼ˆæŒ‡æ¨™é¡¯ç¤ºè¨­å®šï¼‰

| æ¬„ä½ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| user_id | INTEGER | - | ç”¨æˆ¶ ID (PK) |
| show_ma | BOOLEAN | true | é¡¯ç¤ºå‡ç·š |
| show_rsi | BOOLEAN | true | é¡¯ç¤º RSI |
| show_macd | BOOLEAN | true | é¡¯ç¤º MACD |
| show_kd | BOOLEAN | false | é¡¯ç¤º KD |
| show_bollinger | BOOLEAN | true | é¡¯ç¤ºå¸ƒæ—é€šé“ |
| show_obv | BOOLEAN | false | é¡¯ç¤º OBV |
| show_volume | BOOLEAN | true | é¡¯ç¤ºæˆäº¤é‡ |

#### user_alert_settingsï¼ˆé€šçŸ¥è¨­å®šï¼‰

| æ¬„ä½ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| user_id | INTEGER | - | ç”¨æˆ¶ ID (PK) |
| alert_ma_cross | BOOLEAN | true | å‡ç·šäº¤å‰é€šçŸ¥ |
| alert_ma_breakout | BOOLEAN | true | å‡ç·šçªç ´é€šçŸ¥ |
| alert_rsi | BOOLEAN | true | RSI è¶…è²·è¶…è³£é€šçŸ¥ |
| alert_macd | BOOLEAN | true | MACD äº¤å‰é€šçŸ¥ |
| alert_kd | BOOLEAN | false | KD äº¤å‰é€šçŸ¥ |
| alert_bollinger | BOOLEAN | false | å¸ƒæ—çªç ´é€šçŸ¥ |
| alert_volume | BOOLEAN | false | é‡èƒ½ç•°å¸¸é€šçŸ¥ |
| alert_sentiment | BOOLEAN | true | æƒ…ç·’æ¥µç«¯é€šçŸ¥ |

#### user_indicator_paramsï¼ˆæŒ‡æ¨™åƒæ•¸è¨­å®šï¼‰

| æ¬„ä½ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| ma_short | INTEGER | 20 | çŸ­å‡ç·šé€±æœŸ |
| ma_mid | INTEGER | 50 | ä¸­å‡ç·šé€±æœŸ |
| ma_long | INTEGER | 200 | é•·å‡ç·šé€±æœŸ |
| rsi_period | INTEGER | 14 | RSI é€±æœŸ |
| rsi_overbought | INTEGER | 70 | RSI è¶…è²·é–€æª» |
| rsi_oversold | INTEGER | 30 | RSI è¶…è³£é–€æª» |
| macd_fast | INTEGER | 12 | MACD å¿«ç·šé€±æœŸ |
| macd_slow | INTEGER | 26 | MACD æ…¢ç·šé€±æœŸ |
| macd_signal | INTEGER | 9 | MACD è¨Šè™Ÿç·šé€±æœŸ |
| kd_period | INTEGER | 9 | KD é€±æœŸ |
| bollinger_period | INTEGER | 20 | å¸ƒæ—é€šé“é€±æœŸ |
| bollinger_std | DECIMAL | 2.0 | å¸ƒæ—æ¨™æº–å·®å€æ•¸ |

---

## 5. æŠ€è¡“æŒ‡æ¨™

### 5.1 æ”¯æ´çš„æŠ€è¡“æŒ‡æ¨™

| æŒ‡æ¨™ | èªªæ˜ | åˆ¤è®€ |
|------|------|------|
| MA | ç§»å‹•å¹³å‡ç·š (20/50/200) | å¤šé ­/ç©ºé ­æ’åˆ—ã€é»ƒé‡‘/æ­»äº¡äº¤å‰ |
| RSI | ç›¸å°å¼·å¼±æŒ‡æ•¸ | >70 è¶…è²·ã€<30 è¶…è³£ |
| MACD | æŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ | é»ƒé‡‘/æ­»äº¡äº¤å‰ |
| KD | éš¨æ©ŸæŒ‡æ¨™ | >80 è¶…è²·ã€<20 è¶…è³£ |
| å¸ƒæ—é€šé“ | Bollinger Bands | çªç ´ä¸Š/ä¸‹è»Œ |
| OBV | èƒ½é‡æ½® | é‡åƒ¹èƒŒé›¢ |
| æˆäº¤é‡ | é‡æ¯”åˆ†æ | é‡èƒ½ç•°å¸¸ |

### 5.2 ç¶œåˆè©•åˆ†ç³»çµ±

| è¨Šè™Ÿ | åˆ†æ•¸ | èªªæ˜ |
|------|------|------|
| åƒ¹æ ¼ > MA20 | +1 | çŸ­æœŸå¤šé ­ |
| MA20 > MA50 | +1 | ä¸­æœŸå¤šé ­ |
| MA50 > MA200 | +1 | é•·æœŸå¤šé ­ |
| RSI è¶…è²· | -1 | å¯èƒ½å›èª¿ |
| RSI è¶…è³£ | +1 | å¯èƒ½åå½ˆ |
| MACD æ­£å€¼ | +1 | å¤šé ­å‹•èƒ½ |
| KD é»ƒé‡‘äº¤å‰ | +1 | çŸ­ç·šè²·è¨Š |

**è©•ç´šæ¨™æº–ï¼š**
- 3~4 åˆ†ï¼šå¼·å‹¢å¤šé ­
- 1~2 åˆ†ï¼šåå¤š
- 0 åˆ†ï¼šä¸­æ€§
- -1~-2 åˆ†ï¼šåç©º
- -3~-4 åˆ†ï¼šå¼·å‹¢ç©ºé ­

---

## 6. é€šçŸ¥é¡å‹

| alert_type | ä¸­æ–‡ | èªªæ˜ |
|------------|------|------|
| `ma_golden_cross` | å‡ç·šé»ƒé‡‘äº¤å‰ | MA20 ä¸Šç©¿ MA50 |
| `ma_death_cross` | å‡ç·šæ­»äº¡äº¤å‰ | MA20 ä¸‹ç©¿ MA50 |
| `approaching_breakout` | æ¥è¿‘å‘ä¸Šçªç ´ | åƒ¹æ ¼æ¥è¿‘é—œéµé˜»åŠ›ä½ |
| `approaching_breakdown` | æ¥è¿‘å‘ä¸‹è·Œç ´ | åƒ¹æ ¼æ¥è¿‘é—œéµæ”¯æ’ä½ |
| `rsi_overbought` | RSI è¶…è²· | RSI > 70 |
| `rsi_oversold` | RSI è¶…è³£ | RSI < 30 |
| `macd_golden_cross` | MACD é»ƒé‡‘äº¤å‰ | DIF ä¸Šç©¿ DEA |
| `macd_death_cross` | MACD æ­»äº¡äº¤å‰ | DIF ä¸‹ç©¿ DEA |
| `kd_golden_cross` | KD é»ƒé‡‘äº¤å‰ | K ä¸Šç©¿ D |
| `kd_death_cross` | KD æ­»äº¡äº¤å‰ | K ä¸‹ç©¿ D |
| `bollinger_breakout` | å¸ƒæ—ä¸Šè»Œçªç ´ | åƒ¹æ ¼çªç ´ä¸Šè»Œ |
| `bollinger_breakdown` | å¸ƒæ—ä¸‹è»Œè·Œç ´ | åƒ¹æ ¼è·Œç ´ä¸‹è»Œ |
| `volume_surge` | æˆäº¤é‡æš´å¢ | é‡æ¯” > 2.0 |
| `sentiment_extreme_fear` | æ¥µåº¦ææ‡¼ | æƒ…ç·’æŒ‡æ•¸ < 25 |
| `sentiment_extreme_greed` | æ¥µåº¦è²ªå©ª | æƒ…ç·’æŒ‡æ•¸ > 75 |

---

## 7. API è¨­è¨ˆ

### 7.1 ä¸»è¦ç«¯é»

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/api/stock/{symbol}` | æŸ¥è©¢è‚¡ç¥¨è©³æƒ… |
| GET | `/api/crypto/{symbol}` | æŸ¥è©¢åŠ å¯†è²¨å¹£è©³æƒ… |
| GET | `/api/watchlist` | å–å¾—è¿½è¹¤æ¸…å–® |
| POST | `/api/watchlist` | æ–°å¢è¿½è¹¤ |
| DELETE | `/api/watchlist/{id}` | ç§»é™¤è¿½è¹¤ |
| GET | `/api/watchlist/overview` | è¿½è¹¤æ¸…å–®ç¸½è¦½ |
| GET | `/api/sentiment` | å¸‚å ´æƒ…ç·’ |
| GET | `/api/settings/indicators` | å–å¾—æŒ‡æ¨™è¨­å®š |
| PUT | `/api/settings/indicators` | æ›´æ–°æŒ‡æ¨™è¨­å®š |
| GET | `/api/settings/alerts` | å–å¾—é€šçŸ¥è¨­å®š |
| PUT | `/api/settings/alerts` | æ›´æ–°é€šçŸ¥è¨­å®š |

### 7.2 å›æ‡‰æ ¼å¼

```json
{
  "success": true,
  "data": { ... },
  "message": "æ“ä½œæˆåŠŸ"
}
```

**éŒ¯èª¤æ ¼å¼ï¼š**

```json
{
  "success": false,
  "error": {
    "code": "INVALID_SYMBOL",
    "message": "æ‰¾ä¸åˆ°æ­¤è‚¡ç¥¨ä»£è™Ÿ"
  }
}
```

---

## 8. æŠ€è¡“é¸å‹

### 8.1 å¾Œç«¯

| é …ç›® | é¸æ“‡ | ç†ç”± |
|------|------|------|
| èªè¨€ | Python 3.10+ | è±å¯Œçš„é‡‘èåˆ†æå¥—ä»¶ |
| æ¡†æ¶ | FastAPI | ç¾ä»£ã€é«˜æ•ˆèƒ½ã€è‡ªå‹• API æ–‡ä»¶ |
| è³‡æ–™åº« | PostgreSQL | ç©©å®šã€æ”¯æ´å¤šç”¨æˆ¶ä½µç™¼ |
| ORM | SQLAlchemy | æˆç†Ÿç©©å®š |
| ä»»å‹™æ’ç¨‹ | APScheduler | å®šæ™‚æ›´æ–°è³‡æ–™ |

### 8.2 è³‡æ–™è™•ç†

| é …ç›® | å¥—ä»¶ |
|------|------|
| è‚¡åƒ¹æŠ“å– | yfinance |
| æ•¸æ“šè™•ç† | pandas, numpy |
| æŠ€è¡“æŒ‡æ¨™ | pandas-ta |
| åœ–è¡¨ç¹ªè£½ | matplotlib, mplfinance |

### 8.3 éƒ¨ç½²

| é …ç›® | å»ºè­°é¸é … |
|------|----------|
| ä¸»æ©Ÿ | Railway |
| è³‡æ–™åº« | Railway PostgreSQL |
| åŸŸå | Cloudflare |

---

## 9. å°ˆæ¡ˆç›®éŒ„çµæ§‹

```
sela-stock-analysis/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI å…¥å£
â”‚   â”œâ”€â”€ config.py            # è¨­å®šæª”
â”‚   â”œâ”€â”€ database.py          # è³‡æ–™åº«é€£ç·š
â”‚   â”‚
â”‚   â”œâ”€â”€ models/              # è³‡æ–™æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ watchlist.py
â”‚   â”‚   â”œâ”€â”€ stock_price.py
â”‚   â”‚   â”œâ”€â”€ crypto_price.py
â”‚   â”‚   â”œâ”€â”€ sentiment.py
â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â”œâ”€â”€ settings.py
â”‚   â”‚   â””â”€â”€ portfolio.py     # æ–°å¢
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/             # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ stock.py
â”‚   â”‚   â”œâ”€â”€ crypto.py
â”‚   â”‚   â””â”€â”€ settings.py
â”‚   â”‚
â”‚   â”œâ”€â”€ routers/             # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”œâ”€â”€ stock.py
â”‚   â”‚   â”œâ”€â”€ crypto.py
â”‚   â”‚   â”œâ”€â”€ watchlist.py
â”‚   â”‚   â”œâ”€â”€ settings.py
â”‚   â”‚   â””â”€â”€ portfolio.py     # æ–°å¢
â”‚   â”‚
â”‚   â”œâ”€â”€ services/            # å•†æ¥­é‚è¼¯
â”‚   â”‚   â”œâ”€â”€ stock_service.py
â”‚   â”‚   â”œâ”€â”€ crypto_service.py
â”‚   â”‚   â”œâ”€â”€ indicator_service.py
â”‚   â”‚   â”œâ”€â”€ chart_service.py
â”‚   â”‚   â”œâ”€â”€ notification_service.py
â”‚   â”‚   â”œâ”€â”€ line_service.py
â”‚   â”‚   â”œâ”€â”€ price_cache_service.py
â”‚   â”‚   â””â”€â”€ portfolio_service.py  # æ–°å¢
â”‚   â”‚
â”‚   â”œâ”€â”€ data_sources/        # å¤–éƒ¨è³‡æ–™ä¾†æº
â”‚   â”‚   â”œâ”€â”€ yahoo_finance.py
â”‚   â”‚   â”œâ”€â”€ coingecko.py
â”‚   â”‚   â”œâ”€â”€ cnn_fear_greed.py
â”‚   â”‚   â””â”€â”€ alternative_me.py
â”‚   â”‚
â”‚   â””â”€â”€ tasks/               # æ’ç¨‹ä»»å‹™
â”‚       â”œâ”€â”€ update_prices.py
â”‚       â”œâ”€â”€ update_sentiment.py
â”‚       â””â”€â”€ check_alerts.py
â”‚
â”œâ”€â”€ static/                  # å‰ç«¯éœæ…‹æª”æ¡ˆ
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ main.css
â”‚   â”‚   â”œâ”€â”€ settings.css     # æ–°å¢
â”‚   â”‚   â””â”€â”€ portfolio.css    # æ–°å¢
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ main.js
â”‚   â”‚   â”œâ”€â”€ settings.js      # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ portfolio.js     # æ–°å¢
â”‚   â”‚   â””â”€â”€ table-sort.js    # æ–°å¢
â”‚   â””â”€â”€ dashboard.html
â”‚
â”œâ”€â”€ tests/                   # æ¸¬è©¦
â”œâ”€â”€ migrations/              # è³‡æ–™åº«é·ç§»
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

---

## 10. ç’°å¢ƒè®Šæ•¸

```bash
# è³‡æ–™åº«
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# LINE Login
LINE_LOGIN_CHANNEL_ID=your_channel_id
LINE_LOGIN_CHANNEL_SECRET=your_channel_secret
LINE_LOGIN_CALLBACK_URL=https://your-domain.com/auth/line/callback

# LINE Messaging
LINE_MESSAGING_CHANNEL_ACCESS_TOKEN=your_access_token

# JWT
JWT_SECRET_KEY=your_secret_key
JWT_EXPIRE_DAYS=7

# æ‡‰ç”¨ç¨‹å¼
APP_ENV=production
APP_DEBUG=false
```

---

## 11. å¸‚å ´æƒ…ç·’åˆ†ç´š

| æ•¸å€¼ | åˆ†é¡ | æ„ç¾© |
|------|------|------|
| 0-25 | æ¥µåº¦ææ‡¼ | å¯èƒ½è²·é» |
| 26-45 | ææ‡¼ | åè¬¹æ… |
| 46-55 | ä¸­æ€§ | è§€æœ› |
| 56-75 | è²ªå©ª | åæ¨‚è§€ |
| 76-100 | æ¥µåº¦è²ªå©ª | å¯èƒ½è³£é» |

---

> ğŸ’¡ å®Œæ•´æŠ€è¡“è¦æ ¼è«‹åƒè€ƒ `stock-analysis-system-spec.md`
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ docs/SELA-Bugä¿®å¾©è¨˜éŒ„.md  â­â­â­
> SELA é¸è‚¡ç³»çµ± - Bug ä¿®å¾©è¨˜éŒ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA é¸è‚¡ç³»çµ± - Bug ä¿®å¾©è¨˜éŒ„

> ç‰ˆæœ¬ï¼šv0.3.0  
> æ›´æ–°æ—¥æœŸï¼š2026-01-05

---

## ç›®éŒ„

1. [å‰ç«¯ Bug](#å‰ç«¯-bug)
2. [å¾Œç«¯ Bug](#å¾Œç«¯-bug)
3. [Async/Await å•é¡Œ](#asyncawait-å•é¡Œ)
4. [éƒ¨ç½²æ³¨æ„äº‹é …](#éƒ¨ç½²æ³¨æ„äº‹é …)

---

## å‰ç«¯ Bug

### Bug 1ï¼šshowSection å‡½æ•¸ event æœªå®šç¾©

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
Uncaught TypeError: Cannot read properties of null (reading 'classList')
    at showSection (dashboard.html:277:46)
    at searchSymbol (dashboard.html:411:13)
```

**åŸå› **ï¼š
- `showSection` å‡½æ•¸ä½¿ç”¨äº†å…¨åŸŸ `event` å°è±¡
- å¾å°èˆªåˆ—é»æ“Šæ™‚æœ‰ `event`ï¼Œä½†å¾ `searchSymbol` ç­‰å‡½æ•¸èª¿ç”¨æ™‚æ²’æœ‰

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```javascript
function showSection(name) {
    // ...
    event.target.closest('.nav-link').classList.add('bg-blue-50');  // âŒ event æœªå®šç¾©
}
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```javascript
function showSection(name, evt) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    const section = document.getElementById(`section-${name}`);
    if (section) {
        section.classList.remove('hidden');
    }
    
    document.querySelectorAll('.nav-link').forEach(l => {
        l.classList.remove('bg-blue-50', 'text-gray-700');
        l.classList.add('text-gray-600');
    });
    
    // âœ… åªæœ‰é»æ“Šå°èˆªæ™‚æ‰æ›´æ–°é«˜äº®
    if (evt && evt.target) {
        const navLink = evt.target.closest('.nav-link');
        if (navLink) {
            navLink.classList.add('bg-blue-50', 'text-gray-700');
            navLink.classList.remove('text-gray-600');
        }
    }
    // ...
}
```

**HTML èª¿ç”¨ä¹Ÿè¦ä¿®æ”¹**ï¼š
```html
<!-- âŒ éŒ¯èª¤ -->
<a onclick="showSection('dashboard')">

<!-- âœ… æ­£ç¢º -->
<a onclick="showSection('dashboard', event)">
```

---

### Bug 2ï¼šAPI è³‡æ–™æ ¼å¼ä¸ç¬¦

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
TypeError: Cannot read properties of undefined (reading 'stock')
    at loadSentiment (dashboard.html:299:60)
```

**åŸå› **ï¼š
- å‰ç«¯æœŸæœ› `data.data.stock` æ ¼å¼
- å¾Œç«¯ API å¯¦éš›è¿”å› `data.stock` æ ¼å¼

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```javascript
// âŒ å‰ç«¯æœŸæœ›
updateSentimentCard('stock', data.data.stock);
updateSentimentCard('crypto', data.data.crypto);
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```javascript
// âœ… ç¬¦åˆ API å¯¦éš›è¿”å›æ ¼å¼
updateSentimentCard('stock', data.stock);
updateSentimentCard('crypto', data.crypto);
```

**API å¯¦éš›è¿”å›æ ¼å¼**ï¼š
```json
{
  "success": true,
  "stock": { "value": 45, "classification": "neutral" },
  "crypto": { "value": 32, "classification": "fear" }
}
```

---

### Bug 3ï¼šæœå°‹çµæœè³‡æ–™æ ¼å¼

**åŸå› **ï¼š
- å‰ç«¯æœŸæœ› `data.data` åŒ…å«è‚¡ç¥¨è³‡æ–™
- å¾Œç«¯ç›´æ¥è¿”å›è³‡æ–™åœ¨é ‚å±¤

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```javascript
// âŒ éŒ¯èª¤
renderStockResult(data.data, isCrypto);
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```javascript
// âœ… æ­£ç¢º - è³‡æ–™ç›´æ¥åœ¨é ‚å±¤
renderStockResult(data, isCrypto);
```

---

## å¾Œç«¯ Bug

### Bug 4ï¼šæŠ€è¡“æŒ‡æ¨™æ¬„ä½åå¤§å°å¯«ä¸ä¸€è‡´

**åŸå› **ï¼š
- `indicator_service.py` ç”¢ç”Ÿå°å¯«æ¬„ä½åï¼š`ma20`, `rsi`, `macd_dif`
- `stock.py` / `crypto.py` è®€å–å¤§å¯«æ¬„ä½åï¼š`MA20`, `RSI`, `MACD_DIF`

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
# âŒ routers/stock.py ä½¿ç”¨å¤§å¯«
ma20 = float(latest.get('MA20', 0)) if 'MA20' in latest else None
rsi_value = float(latest.get('RSI', 50)) if 'RSI' in latest else 50
macd_dif = float(latest.get('MACD_DIF', 0)) if 'MACD_DIF' in latest else 0
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```python
# âœ… ä½¿ç”¨å°å¯«ï¼Œç¬¦åˆ indicator_service ç”¢ç”Ÿçš„æ¬„ä½å
ma20 = float(latest.get('ma20', 0)) if 'ma20' in latest else None
ma50 = float(latest.get('ma50', 0)) if 'ma50' in latest else None
ma200 = float(latest.get('ma200', 0)) if 'ma200' in latest else None
rsi_value = float(latest.get('rsi', 50)) if 'rsi' in latest else 50
macd_dif = float(latest.get('macd_dif', 0)) if 'macd_dif' in latest else 0
macd_dea = float(latest.get('macd_dea', 0)) if 'macd_dea' in latest else 0
macd_hist = float(latest.get('macd_hist', 0)) if 'macd_hist' in latest else 0
```

**indicator_service.py ç”¢ç”Ÿçš„æ¬„ä½ååƒè€ƒ**ï¼š
```python
df[f"ma{self.ma_short}"]  # ma20
df[f"ma{self.ma_mid}"]    # ma50
df[f"ma{self.ma_long}"]   # ma200
df["rsi"]                  # rsi
df["macd_dif"]            # macd_dif
df["macd_dea"]            # macd_dea
df["macd_hist"]           # macd_hist
df["kd_k"]                # kd_k
df["kd_d"]                # kd_d
```

---

### Bug 5ï¼šæ–¹æ³•åç¨±éŒ¯èª¤

**åŸå› **ï¼šèª¿ç”¨ä¸å­˜åœ¨çš„æ–¹æ³•å

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
# âŒ routers/stock.py
df = yahoo_finance.get_stock_data(symbol, period="1y")  # æ–¹æ³•ä¸å­˜åœ¨

# âŒ routers/crypto.py
df = coingecko.get_historical_data(symbol, days=365)  # æ–¹æ³•ä¸å­˜åœ¨
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```python
# âœ… routers/stock.py - ä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•å
df = yahoo_finance.get_stock_history(symbol, period="1y")

# âœ… routers/crypto.py - ä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•å
df = coingecko.get_ohlc(symbol, days=365)
```

**data_sources å¯ç”¨æ–¹æ³•åƒè€ƒ**ï¼š

| æª”æ¡ˆ | å¯ç”¨æ–¹æ³• |
|------|----------|
| yahoo_finance.py | `get_stock_info()`, `get_stock_history()`, `get_current_price()` |
| coingecko.py | `get_coin_info()`, `get_market_chart()`, `get_ohlc()`, `get_current_price()`, `validate_symbol()` |

---

## Async/Await å•é¡Œ

### Bug 6ï¼šSettings API ç¼ºå°‘ await

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
'coroutine' object has no attribute 'scalar_one_or_none'
```

**åŸå› **ï¼š
- ä½¿ç”¨ `AsyncSession` ä½†æ²’æœ‰ `await` è³‡æ–™åº«æ“ä½œ

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
# âŒ ç¼ºå°‘ await
settings = db.execute(stmt).scalar_one_or_none()
db.commit()
db.refresh(settings)
```

**ä¿®å¾©ä»£ç¢¼**ï¼š
```python
# âœ… åŠ ä¸Š await
result = await db.execute(stmt)
settings = result.scalar_one_or_none()
await db.commit()
await db.refresh(settings)
```

---

## éƒ¨ç½²æ³¨æ„äº‹é …

### 1. ç€è¦½å™¨å¿«å–å•é¡Œ

ä¿®æ”¹å‰ç«¯æª”æ¡ˆå¾Œï¼Œç”¨æˆ¶å¯èƒ½çœ‹åˆ°èˆŠç‰ˆæœ¬ã€‚

**è§£æ±ºæ–¹æ³•**ï¼š
- æŒ‰ `Ctrl + Shift + R` å¼·åˆ¶é‡æ–°æ•´ç†
- é–‹å•Ÿç„¡ç—•è¦–çª—æ¸¬è©¦
- åœ¨æª”æ¡ˆååŠ ä¸Šç‰ˆæœ¬è™Ÿï¼š`dashboard.html?v=1.0.1`

### 2. Railway éƒ¨ç½²æª¢æŸ¥

éƒ¨ç½²å¾Œæª¢æŸ¥ log ç¢ºèªï¼š
- å®¹å™¨å•Ÿå‹•æˆåŠŸ
- API ç«¯é»è¿”å› 200 OK
- æ²’æœ‰ 500 éŒ¯èª¤

### 3. API æ¸¬è©¦æ–¹æ³•

ç›´æ¥åœ¨ç€è¦½å™¨æ¸¬è©¦ APIï¼š
```
https://your-domain.railway.app/api/stock/AAPL
https://your-domain.railway.app/api/crypto/BTC
https://your-domain.railway.app/api/market/sentiment
```

### 4. å‰ç«¯ Console èª¿è©¦

æŒ‰ `F12` é–‹å•Ÿé–‹ç™¼è€…å·¥å…·ï¼ŒæŸ¥çœ‹ï¼š
- Console éŒ¯èª¤è¨Šæ¯
- Network è«‹æ±‚ç‹€æ…‹
- API å›æ‡‰å…§å®¹

---

## ä¿®å¾©æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | ä¿®å¾©å…§å®¹ |
|------|----------|
| `static/dashboard.html` | showSection åƒæ•¸ã€API è³‡æ–™æ ¼å¼ |
| `app/routers/stock.py` | æ–¹æ³•åã€æ¬„ä½åå¤§å°å¯« |
| `app/routers/crypto.py` | æ–¹æ³•åã€æ¬„ä½åå¤§å°å¯« |
| `app/routers/settings.py` | async/await å®Œæ•´ç‰ˆ |

---

## å¿«é€Ÿæª¢æŸ¥æ¸…å–®

- [ ] `indicator_service` æ¬„ä½åæ˜¯å°å¯«
- [ ] `routers` è®€å–æ¬„ä½åä¹Ÿç”¨å°å¯«
- [ ] API æ–¹æ³•åèˆ‡ data_sources ä¸€è‡´
- [ ] å‰ç«¯è³‡æ–™æ ¼å¼èˆ‡ API è¿”å›ä¸€è‡´
- [ ] `showSection` ç­‰å‡½æ•¸çš„ event åƒæ•¸å¯é¸
- [ ] AsyncSession çš„æ“ä½œéƒ½æœ‰ await

---

> æ–‡ä»¶ç¶­è­·ï¼šæ¯æ¬¡ä¿®å¾© bug å¾Œæ›´æ–°æ­¤æ–‡ä»¶
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ README.md  â­â­â­
> SELA æ•ˆèƒ½å„ªåŒ–åŒ… v2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA æ•ˆèƒ½å„ªåŒ–åŒ… v2

## ğŸš€ æ•ˆèƒ½æ”¹å–„ç¸½è¦½

### 1. è¿½è¹¤æ¸…å–®è¼‰å…¥ï¼ˆN+1 å•é¡Œä¿®å¾©ï¼‰
| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| API è«‹æ±‚æ•¸ | 1 + N æ¬¡ | 1 æ¬¡ | -95% |
| è¼‰å…¥æ™‚é–“ | 2-5 ç§’ | < 200ms | -90%+ |

### 2. è©³ç´°åˆ†æï¼ˆå‰ç«¯å¿«å–å„ªåŒ–ï¼‰
| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| å¿«å–æ™‚é–“ | 5 åˆ†é˜ | 30 åˆ†é˜ | +500% |
| é é¢åˆ·æ–° | å¿«å–æ¶ˆå¤± | ä¿ç•™ | âœ… |

### 3. è©³ç´°åˆ†æï¼ˆå¾Œç«¯æ­·å²è³‡æ–™å¿«å–ï¼‰â­ æ–°å¢
| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| é¦–æ¬¡æŸ¥è©¢ | 10-30 ç§’ | 10-30 ç§’ | ç›¸åŒ |
| **åŒæ—¥é‡æŸ¥** | 10-30 ç§’ | **< 500ms** | **-98%** |
| **éš”æ—¥æŸ¥è©¢** | 10-30 ç§’ | **1-3 ç§’** | **-90%** |

## ğŸ“ æª”æ¡ˆèªªæ˜

```
sela_update/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ database.py                   # è³‡æ–™åº«é€£ç·šï¼ˆå«é·ç§»ï¼‰â­
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ watchlist.py              # è¿½è¹¤æ¸…å–® API
â”‚   â”‚   â””â”€â”€ stock.py                  # è‚¡ç¥¨æŸ¥è©¢ API â­
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ stock_history_service.py  # æ­·å²å¿«å–æœå‹™ â­
â”œâ”€â”€ static/
â”‚   â””â”€â”€ js/
â”‚       â”œâ”€â”€ watchlist.js              # è¿½è¹¤æ¸…å–®å‰ç«¯
â”‚       â””â”€â”€ search/
â”‚           â””â”€â”€ search-core.js        # æœå°‹æ ¸å¿ƒ
â””â”€â”€ README.md
```

## ğŸ“ éƒ¨ç½²æ­¥é©Ÿ

### ç›´æ¥è¦†è“‹åŸæª”æ¡ˆï¼Œé‡æ–°éƒ¨ç½²å³å¯ï¼

ç³»çµ±å•Ÿå‹•æ™‚æœƒè‡ªå‹•å»ºç«‹ `stock_prices` è¡¨ï¼ˆé·ç§»å·²æ•´åˆåœ¨ database.pyï¼‰

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### æ­·å²è³‡æ–™å¿«å–ç­–ç•¥
1. **é¦–æ¬¡æŸ¥è©¢**ï¼šå¾ Yahoo Finance æŠ“å– 10 å¹´è³‡æ–™ï¼Œå­˜å…¥ PostgreSQL
2. **åŒæ—¥é‡æŸ¥**ï¼šç›´æ¥å¾è³‡æ–™åº«è®€å–ï¼Œä¸èª¿ç”¨å¤–éƒ¨ API
3. **éš”æ—¥æŸ¥è©¢**ï¼šåªè£œæŠ“ç¼ºå¤±çš„æ—¥æœŸï¼ˆ1-N å¤©ï¼‰ï¼Œåˆä½µè¿”å›

### æ–°å¢ API
- `GET /api/stock/cache/stats` - æŸ¥çœ‹å¿«å–çµ±è¨ˆ
- `DELETE /api/stock/cache/{symbol}` - æ¸…é™¤æŒ‡å®šè‚¡ç¥¨å¿«å–

### è³‡æ–™åº«è®Šæ›´
æ–°å¢ `stock_prices` è¡¨ï¼š
- `symbol` - è‚¡ç¥¨ä»£è™Ÿ
- `date` - æ—¥æœŸ
- `open/high/low/close` - OHLC åƒ¹æ ¼
- `volume` - æˆäº¤é‡
- å”¯ä¸€ç´¢å¼•ï¼š`(symbol, date)`

## âš ï¸ æ³¨æ„äº‹é …

1. é¦–æ¬¡æŸ¥è©¢æ¯æ”¯è‚¡ç¥¨ä»éœ€ 10-30 ç§’ï¼ˆå»ºç«‹å¿«å–ï¼‰
2. å¿«å–æœƒæŒçºŒç´¯ç©ï¼Œé•·æœŸä½¿ç”¨å¾Œè³‡æ–™åº«æœƒå¢å¤§
3. å¯é€é `DELETE /api/stock/cache/{symbol}` æ¸…é™¤ç‰¹å®šè‚¡ç¥¨å¿«å–
```

======================================================================
## âš™ï¸ è¨­å®šæª”
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/config.py  â­â­
> æ‡‰ç”¨ç¨‹å¼è¨­å®šæª”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ‡‰ç”¨ç¨‹å¼è¨­å®šæª”
"""
from pydantic_settings import BaseSettings
from pathlib import Path
from typing import Optional, List


class Settings(BaseSettings):
    """æ‡‰ç”¨ç¨‹å¼è¨­å®š"""
    
    # æ‡‰ç”¨ç¨‹å¼
    APP_NAME: str = "SELA è‡ªå‹•é¸è‚¡ç³»çµ±"
    APP_VERSION: str = "0.8.2"  # Phase 4 è¨Šè™Ÿåµæ¸¬ + LINE æ¨æ’­
    APP_ENV: str = "development"
    DEBUG: bool = True
    
    # è³‡æ–™åº«
    DATABASE_URL: str = "sqlite+aiosqlite:///./stock_analysis.db"
    
    # LINE Login (éšæ®µå››)
    LINE_LOGIN_CHANNEL_ID: Optional[str] = None
    LINE_LOGIN_CHANNEL_SECRET: Optional[str] = None
    LINE_LOGIN_CALLBACK_URL: Optional[str] = None
    
    # LINE Messaging (éšæ®µå…­)
    LINE_MESSAGING_CHANNEL_ACCESS_TOKEN: Optional[str] = None
    
    # JWT (éšæ®µå››)
    JWT_SECRET_KEY: str = "your-secret-key-change-in-production"
    JWT_EXPIRE_DAYS: int = 7  # ä¿ç•™å‘å¾Œç›¸å®¹
    
    # ğŸ†• Token éæœŸæ™‚é–“ï¼ˆåˆ†é˜ï¼‰
    JWT_EXPIRE_MINUTES_USER: int = 10      # ä¸€èˆ¬ç”¨æˆ¶ 10 åˆ†é˜
    JWT_EXPIRE_MINUTES_ADMIN: int = 60     # ç®¡ç†å“¡ 1 å°æ™‚
    
    # ç®¡ç†å“¡è¨­å®š
    # åˆå§‹ç®¡ç†å“¡çš„ LINE User IDï¼ˆç”¨é€—è™Ÿåˆ†éš”å¤šå€‹ï¼‰
    ADMIN_LINE_USER_IDS: str = "U0f094e89838337e64ba0ca2f68161f3a"
    
    # è³‡æ–™æ›´æ–°è¨­å®š
    STOCK_DATA_CACHE_HOURS: int = 4  # è‚¡åƒ¹è³‡æ–™å¿«å–æ™‚é–“ï¼ˆå°æ™‚ï¼‰
    CRYPTO_DATA_CACHE_MINUTES: int = 15  # å¹£åƒ¹è³‡æ–™å¿«å–æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
    HISTORY_DEFAULT_YEARS: int = 10  # æ­·å²è³‡æ–™é è¨­å¹´æ•¸
    
    # æŠ€è¡“æŒ‡æ¨™é è¨­åƒæ•¸
    MA_SHORT: int = 20
    MA_MID: int = 50
    MA_LONG: int = 200
    RSI_PERIOD: int = 14
    RSI_OVERBOUGHT: int = 70
    RSI_OVERSOLD: int = 30
    MACD_FAST: int = 12
    MACD_SLOW: int = 26
    MACD_SIGNAL: int = 9
    KD_PERIOD: int = 9
    BOLLINGER_PERIOD: int = 20
    BOLLINGER_STD: float = 2.0
    
    # é€šçŸ¥è¨­å®š
    BREAKOUT_THRESHOLD: float = 2.0  # çªç ´é è­¦é–€æª» (%)
    VOLUME_ALERT_RATIO: float = 2.0  # é‡æ¯”è­¦æˆ’å€æ•¸
    
    def get_admin_line_ids(self) -> List[str]:
        """å–å¾—ç®¡ç†å“¡ LINE User ID åˆ—è¡¨"""
        if not self.ADMIN_LINE_USER_IDS:
            return []
        return [x.strip() for x in self.ADMIN_LINE_USER_IDS.split(",") if x.strip()]
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"


# å…¨åŸŸè¨­å®šå¯¦ä¾‹
settings = Settings()

# å°ˆæ¡ˆè·¯å¾‘
BASE_DIR = Path(__file__).resolve().parent.parent
DATA_DIR = BASE_DIR / "data"
CHARTS_DIR = BASE_DIR / "charts"

# ç¢ºä¿ç›®éŒ„å­˜åœ¨
DATA_DIR.mkdir(exist_ok=True)
CHARTS_DIR.mkdir(exist_ok=True)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/settings.py  â­â­
> è¨­å®šç®¡ç† API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨­å®šç®¡ç† API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
"""
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from app.database import get_async_session
from app.models.user import User
from app.models.user_settings import (
    UserIndicatorSettings,
    UserAlertSettings,
    UserIndicatorParams,
)
from app.schemas.schemas import (
    IndicatorSettingsUpdate,
    IndicatorSettingsResponse,
    AlertSettingsUpdate,
    AlertSettingsResponse,
    IndicatorParamsUpdate,
    IndicatorParamsResponse,
    ResponseBase,
)

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_current_user

router = APIRouter(prefix="/api/settings", tags=["è¨­å®š"])


# ==================== æŒ‡æ¨™é¡¯ç¤ºè¨­å®š ====================

@router.get("/indicators", summary="å–å¾—æŒ‡æ¨™é¡¯ç¤ºè¨­å®š", response_model=IndicatorSettingsResponse)
async def get_indicator_settings(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
    """
    stmt = select(UserIndicatorSettings).where(
        UserIndicatorSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        # å»ºç«‹é è¨­è¨­å®š
        settings = UserIndicatorSettings.create_default(user.id)
        db.add(settings)
        await db.commit()
        await db.refresh(settings)
    
    return IndicatorSettingsResponse(
        success=True,
        data=settings.to_dict(),
    )


@router.put("/indicators", summary="æ›´æ–°æŒ‡æ¨™é¡¯ç¤ºè¨­å®š", response_model=IndicatorSettingsResponse)
async def update_indicator_settings(
    data: IndicatorSettingsUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°ç”¨æˆ¶çš„æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
    """
    stmt = select(UserIndicatorSettings).where(
        UserIndicatorSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        settings = UserIndicatorSettings.create_default(user.id)
        db.add(settings)
    
    # æ›´æ–°è¨­å®š
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(settings, key, value)
    
    await db.commit()
    await db.refresh(settings)
    
    return IndicatorSettingsResponse(
        success=True,
        message="è¨­å®šå·²æ›´æ–°",
        data=settings.to_dict(),
    )


# ==================== é€šçŸ¥è¨­å®š ====================

@router.get("/alerts", summary="å–å¾—é€šçŸ¥è¨­å®š", response_model=AlertSettingsResponse)
async def get_alert_settings(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„é€šçŸ¥è¨­å®š
    """
    stmt = select(UserAlertSettings).where(
        UserAlertSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        settings = UserAlertSettings.create_default(user.id)
        db.add(settings)
        await db.commit()
        await db.refresh(settings)
    
    return AlertSettingsResponse(
        success=True,
        data=settings.to_dict(),
    )


@router.put("/alerts", summary="æ›´æ–°é€šçŸ¥è¨­å®š", response_model=AlertSettingsResponse)
async def update_alert_settings(
    data: AlertSettingsUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°ç”¨æˆ¶çš„é€šçŸ¥è¨­å®š
    """
    stmt = select(UserAlertSettings).where(
        UserAlertSettings.user_id == user.id
    )
    result = await db.execute(stmt)
    settings = result.scalar_one_or_none()
    
    if not settings:
        settings = UserAlertSettings.create_default(user.id)
        db.add(settings)
    
    # æ›´æ–°è¨­å®š
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(settings, key, value)
    
    await db.commit()
    await db.refresh(settings)
    
    return AlertSettingsResponse(
        success=True,
        message="è¨­å®šå·²æ›´æ–°",
        data=settings.to_dict(),
    )


# ==================== æŒ‡æ¨™åƒæ•¸è¨­å®š ====================

@router.get("/params", summary="å–å¾—æŒ‡æ¨™åƒæ•¸", response_model=IndicatorParamsResponse)
async def get_indicator_params(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„æŒ‡æ¨™åƒæ•¸è¨­å®š
    """
    stmt = select(UserIndicatorParams).where(
        UserIndicatorParams.user_id == user.id
    )
    result = await db.execute(stmt)
    params = result.scalar_one_or_none()
    
    if not params:
        params = UserIndicatorParams.create_default(user.id)
        db.add(params)
        await db.commit()
        await db.refresh(params)
    
    return IndicatorParamsResponse(
        success=True,
        data=params.to_dict(),
    )


@router.put("/params", summary="æ›´æ–°æŒ‡æ¨™åƒæ•¸", response_model=IndicatorParamsResponse)
async def update_indicator_params(
    data: IndicatorParamsUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°ç”¨æˆ¶çš„æŒ‡æ¨™åƒæ•¸è¨­å®š
    
    å¯è‡ªè¨‚åƒæ•¸åŒ…æ‹¬ï¼š
    - å‡ç·šé€±æœŸ (ma_short, ma_mid, ma_long)
    - RSI åƒæ•¸ (rsi_period, rsi_overbought, rsi_oversold)
    - MACD åƒæ•¸ (macd_fast, macd_slow, macd_signal)
    - KD é€±æœŸ (kd_period)
    - å¸ƒæ—é€šé“ (bollinger_period, bollinger_std)
    - è­¦æˆ’å€¼ (breakout_threshold, volume_alert_ratio)
    """
    stmt = select(UserIndicatorParams).where(
        UserIndicatorParams.user_id == user.id
    )
    result = await db.execute(stmt)
    params = result.scalar_one_or_none()
    
    if not params:
        params = UserIndicatorParams.create_default(user.id)
        db.add(params)
    
    # æ›´æ–°åƒæ•¸
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(params, key, value)
    
    await db.commit()
    await db.refresh(params)
    
    return IndicatorParamsResponse(
        success=True,
        message="åƒæ•¸å·²æ›´æ–°",
        data=params.to_dict(),
    )


# ==================== é è¨­æ¨¡æ¿ ====================

TEMPLATES = {
    "minimal": {
        "indicators": {
            "show_ma": True,
            "show_rsi": False,
            "show_macd": False,
            "show_kd": False,
            "show_bollinger": False,
            "show_obv": False,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": False,
            "alert_macd": False,
            "alert_kd": False,
            "alert_bollinger": False,
            "alert_volume": False,
            "alert_sentiment": False,
        },
    },
    "standard": {
        "indicators": {
            "show_ma": True,
            "show_rsi": True,
            "show_macd": True,
            "show_kd": False,
            "show_bollinger": True,
            "show_obv": False,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": True,
            "alert_macd": True,
            "alert_kd": False,
            "alert_bollinger": False,
            "alert_volume": False,
            "alert_sentiment": True,
        },
    },
    "full": {
        "indicators": {
            "show_ma": True,
            "show_rsi": True,
            "show_macd": True,
            "show_kd": True,
            "show_bollinger": True,
            "show_obv": True,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": True,
            "alert_macd": True,
            "alert_kd": True,
            "alert_bollinger": True,
            "alert_volume": True,
            "alert_sentiment": True,
        },
    },
    "short_term": {
        "indicators": {
            "show_ma": True,
            "show_rsi": True,
            "show_macd": True,
            "show_kd": True,
            "show_bollinger": True,
            "show_obv": False,
            "show_volume": True,
        },
        "alerts": {
            "alert_ma_cross": True,
            "alert_ma_breakout": True,
            "alert_rsi": True,
            "alert_macd": True,
            "alert_kd": True,
            "alert_bollinger": True,
            "alert_volume": True,
            "alert_sentiment": False,
        },
        "params": {
            "ma_short": 5,
            "ma_mid": 10,
            "ma_long": 20,
        },
    },
}


@router.post("/template/{template_name}", summary="å¥—ç”¨é è¨­æ¨¡æ¿", response_model=ResponseBase)
async def apply_template(
    template_name: str,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å¥—ç”¨é è¨­è¨­å®šæ¨¡æ¿
    
    å¯ç”¨æ¨¡æ¿ï¼š
    - **minimal**: æ¥µç°¡ (åªé¡¯ç¤ºå‡ç·šå’Œæˆäº¤é‡)
    - **standard**: æ¨™æº– (é è¨­ï¼Œå«ä¸»è¦æŒ‡æ¨™)
    - **full**: å®Œæ•´ (é¡¯ç¤ºæ‰€æœ‰æŒ‡æ¨™)
    - **short_term**: çŸ­ç·š (ä½¿ç”¨è¼ƒçŸ­çš„å‡ç·šé€±æœŸ)
    """
    if template_name not in TEMPLATES:
        raise HTTPException(
            status_code=400,
            detail=f"ä¸å­˜åœ¨çš„æ¨¡æ¿: {template_name}"
        )
    
    template = TEMPLATES[template_name]
    
    # æ›´æ–°æŒ‡æ¨™è¨­å®š
    if "indicators" in template:
        stmt = select(UserIndicatorSettings).where(
            UserIndicatorSettings.user_id == user.id
        )
        result = await db.execute(stmt)
        ind_settings = result.scalar_one_or_none()
        if not ind_settings:
            ind_settings = UserIndicatorSettings.create_default(user.id)
            db.add(ind_settings)
        
        for key, value in template["indicators"].items():
            setattr(ind_settings, key, value)
    
    # æ›´æ–°é€šçŸ¥è¨­å®š
    if "alerts" in template:
        stmt = select(UserAlertSettings).where(
            UserAlertSettings.user_id == user.id
        )
        result = await db.execute(stmt)
        alert_settings = result.scalar_one_or_none()
        if not alert_settings:
            alert_settings = UserAlertSettings.create_default(user.id)
            db.add(alert_settings)
        
        for key, value in template["alerts"].items():
            setattr(alert_settings, key, value)
    
    # æ›´æ–°åƒæ•¸è¨­å®š
    if "params" in template:
        stmt = select(UserIndicatorParams).where(
            UserIndicatorParams.user_id == user.id
        )
        result = await db.execute(stmt)
        params = result.scalar_one_or_none()
        if not params:
            params = UserIndicatorParams.create_default(user.id)
            db.add(params)
        
        for key, value in template["params"].items():
            setattr(params, key, value)
    
    await db.commit()
    
    return ResponseBase(
        success=True,
        message=f"å·²å¥—ç”¨æ¨¡æ¿: {template_name}",
    )
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ Procfile  â­â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```text
web: uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ requirements.txt  â­â­â­
> Core Framework
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```text
# Core Framework
fastapi>=0.109.0
uvicorn[standard]>=0.27.0
python-dotenv>=1.0.0

# Database
sqlalchemy>=2.0.0
aiosqlite>=0.19.0
greenlet>=3.0.0
asyncpg>=0.29.0        # PostgreSQL async driver
psycopg2-binary>=2.9.9  # PostgreSQL sync driver

# Data Sources
yfinance>=0.2.36
requests>=2.31.0

# Data Processing
pandas>=2.2.0
numpy>=1.26.0
# pandas-ta>=0.3.14b  # å·²åœ¨ indicator_service.py æ‰‹å‹•å¯¦ä½œæŒ‡æ¨™è¨ˆç®—

# Chart Generation
matplotlib>=3.8.0
mplfinance>=0.12.9b7

# Authentication
python-jose[cryptography]>=3.3.0
httpx>=0.26.0

# Utilities
pydantic>=2.5.0
pydantic-settings>=2.1.0
rich>=13.7.0  # CLI ç¾åŒ–è¼¸å‡º

# Testing
pytest>=8.0.0
pytest-asyncio>=0.23.0
apscheduler>=3.10.0
feedparser
```

======================================================================
## ğŸš€ ç¨‹å¼é€²å…¥é»
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/main.py  â­â­â­
> FastAPI ä¸»ç¨‹å¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
FastAPI ä¸»ç¨‹å¼
è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ± API

ğŸ”§ ä¿®å¾©ç‰ˆæœ¬ - 2026-01-16
- åŠ å…¥å¸‚å ´æƒ…ç·’æ’ç¨‹æ›´æ–°ï¼ˆæ¯å¤© 3 æ¬¡ï¼‰
- å•Ÿå‹•æ™‚åˆå§‹åŒ– sentiment
- ğŸ·ï¸ åŠ å…¥ tags_router
- ğŸ“Š åŠ å…¥ stock_info_router
"""
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import RedirectResponse
import logging
import os
from datetime import datetime

from app.config import settings
from app.database import init_db
from app.logging_config import setup_logging

# åˆå§‹åŒ–æ—¥èªŒç³»çµ±ï¼ˆåœ¨å…¶ä»– import ä¹‹å‰ï¼‰
setup_logging(
    log_level="DEBUG" if settings.DEBUG else "INFO",
    log_to_file=True
)

# ç¢ºä¿æ‰€æœ‰ models è¢«è¼‰å…¥ï¼Œé€™æ¨£ Base.metadata æ‰æœƒåŒ…å«æ‰€æœ‰è¡¨æ ¼
from app.models import (
    User, Watchlist, StockPrice, CryptoPrice, 
    MarketSentiment, Notification,
    UserIndicatorSettings, UserAlertSettings, UserIndicatorParams,
    IndexPrice, DividendHistory,
    Comparison,
    StockPriceCache,
    PortfolioTransaction, PortfolioHolding, ExchangeRate,
    # P1: æ¨™ç±¤å’Œè‚¡ç¥¨è³‡è¨Š
    UserTag, watchlist_tags,
    StockInfo,
)
from app.models.user import LoginLog, TokenBlacklist, SystemConfig

from app.routers import (
    auth_router,
    stock_router,
    crypto_router,
    watchlist_router,
    settings_router,
    admin_router,
    compare_router,
    portfolio_router,
)
from app.routers.market import router as market_router
from app.routers.subscription import router as subscription_router  # ğŸ“¡ è¨‚é–±ç²¾é¸
from app.routers.tags import router as tags_router  # ğŸ·ï¸ æ¨™ç±¤ç®¡ç†
from app.routers.stock_info import router as stock_info_router  # ğŸ“Š è‚¡ç¥¨è³‡è¨Š

# æ’ç¨‹å™¨
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

logger = logging.getLogger(__name__)

# å»ºç«‹æ’ç¨‹å™¨
scheduler = AsyncIOScheduler()


# ============================================================
# ğŸ†• äº¤æ˜“æ™‚é–“åˆ¤æ–·ï¼ˆå„ªåŒ–ç‰ˆï¼‰
# ============================================================

def is_tw_market_hours() -> bool:
    """åˆ¤æ–·æ˜¯å¦åœ¨å°è‚¡äº¤æ˜“æ™‚é–“ï¼ˆé€±ä¸€åˆ°é€±äº” 09:00-13:30 å°åŒ—æ™‚é–“ï¼‰"""
    from datetime import timezone, timedelta
    tw_tz = timezone(timedelta(hours=8))
    now = datetime.now(tw_tz)
    
    # é€±æœ«ä¸é–‹ç›¤
    if now.weekday() >= 5:
        return False
    
    # 09:00 - 13:30
    market_open = now.replace(hour=9, minute=0, second=0, microsecond=0)
    market_close = now.replace(hour=13, minute=30, second=0, microsecond=0)
    
    return market_open <= now <= market_close


def is_us_market_hours() -> bool:
    """åˆ¤æ–·æ˜¯å¦åœ¨ç¾è‚¡äº¤æ˜“æ™‚é–“ï¼ˆé€±ä¸€åˆ°é€±äº” 21:30-05:00 å°åŒ—æ™‚é–“ï¼‰"""
    from datetime import timezone, timedelta
    tw_tz = timezone(timedelta(hours=8))
    now = datetime.now(tw_tz)
    
    # é€±æœ«ä¸é–‹ç›¤ï¼ˆé€±å…­ 05:00 å¾Œã€é€±æ—¥å…¨å¤©ï¼‰
    if now.weekday() == 6:  # é€±æ—¥
        return False
    if now.weekday() == 5 and now.hour >= 5:  # é€±å…­ 05:00 å¾Œ
        return False
    
    # 21:30 - 05:00 (è·¨æ—¥)
    hour = now.hour
    minute = now.minute
    
    if hour >= 21 and minute >= 30:
        return True
    if hour >= 22:
        return True
    if hour < 5:
        return True
    
    return False


def is_any_market_open() -> bool:
    """åˆ¤æ–·æ˜¯å¦æœ‰ä»»ä½•å¸‚å ´é–‹ç›¤"""
    return is_tw_market_hours() or is_us_market_hours()


# ============================================================
# åƒ¹æ ¼å¿«å–æ›´æ–°å‡½æ•¸ï¼ˆå„ªåŒ–ç‰ˆï¼‰
# ============================================================

def update_price_cache():
    """
    æ’ç¨‹ä»»å‹™ï¼šæ›´æ–°åƒ¹æ ¼å¿«å–
    ğŸ†• å„ªåŒ–ï¼šåªåœ¨äº¤æ˜“æ™‚é–“åŸ·è¡Œ
    """
    # æª¢æŸ¥æ˜¯å¦æœ‰å¸‚å ´é–‹ç›¤
    if not is_any_market_open():
        logger.debug("[æ’ç¨‹] éäº¤æ˜“æ™‚é–“ï¼Œè·³éåƒ¹æ ¼æ›´æ–°")
        return
    
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService

    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°åƒ¹æ ¼å¿«å–...")
    db = SyncSessionLocal()
    try:
        service = PriceCacheService(db)
        result = service.update_all(force=False)
        logger.info(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–æ›´æ–°å®Œæˆ: {result['total_updated']} ç­†")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


def update_price_cache_force():
    """å¼·åˆ¶æ›´æ–°æ‰€æœ‰åƒ¹æ ¼ï¼ˆæ”¶ç›¤å¾Œï¼‰"""
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService

    logger.info("[æ’ç¨‹] å¼·åˆ¶æ›´æ–°æ‰€æœ‰åƒ¹æ ¼å¿«å–...")
    db = SyncSessionLocal()
    try:
        service = PriceCacheService(db)
        result = service.update_all(force=True)
        logger.info(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–å¼·åˆ¶æ›´æ–°å®Œæˆ: {result['total_updated']} ç­†")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–å¼·åˆ¶æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


# ============================================================
# åŒ¯ç‡æ›´æ–°å‡½æ•¸
# ============================================================

def update_exchange_rate():
    """æ’ç¨‹ä»»å‹™ï¼šæ›´æ–° USD/TWD åŒ¯ç‡"""
    from app.database import SyncSessionLocal
    from app.services.exchange_rate_service import update_exchange_rate_sync

    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°åŒ¯ç‡...")
    db = SyncSessionLocal()
    try:
        rate = update_exchange_rate_sync(db)
        logger.info(f"[æ’ç¨‹] åŒ¯ç‡æ›´æ–°å®Œæˆ: USD/TWD = {rate:.4f}")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åŒ¯ç‡æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


# ============================================================
# ğŸ“¡ è¨‚é–±æºæŠ“å–å‡½æ•¸
# ============================================================

def fetch_subscription_sources():
    """æ’ç¨‹ä»»å‹™ï¼šæŠ“å–è¨‚é–±æºæ›´æ–°"""
    from app.database import SyncSessionLocal
    from app.services.subscription_service import SubscriptionService

    logger.info("[æ’ç¨‹] é–‹å§‹æŠ“å–è¨‚é–±æº...")
    db = SyncSessionLocal()
    try:
        service = SubscriptionService(db)
        result = service.fetch_all_sources(backfill=False)
        logger.info(f"[æ’ç¨‹] è¨‚é–±æºæŠ“å–å®Œæˆ: {result}")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] è¨‚é–±æºæŠ“å–å¤±æ•—: {e}")
    finally:
        db.close()


# ============================================================
# ğŸ†• å¸‚å ´æƒ…ç·’æ›´æ–°å‡½æ•¸ï¼ˆæ–°å¢ï¼‰
# ============================================================

def update_market_sentiment():
    """
    æ’ç¨‹ä»»å‹™ï¼šæ›´æ–°å¸‚å ´æƒ…ç·’æŒ‡æ•¸
    æ¯å¤©åŸ·è¡Œ 3 æ¬¡ï¼Œå°‡å¤–éƒ¨ API è³‡æ–™å­˜å…¥è³‡æ–™åº«
    è§£æ±ºå‰ç«¯æ¯æ¬¡è¼‰å…¥éƒ½è¦ç­‰å¾…å¤–éƒ¨ API çš„å•é¡Œ
    """
    from app.database import SyncSessionLocal
    from app.services.market_service import MarketService

    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°å¸‚å ´æƒ…ç·’...")
    db = SyncSessionLocal()
    try:
        market_service = MarketService(db)
        result = market_service.update_today_sentiment()
        logger.info(f"[æ’ç¨‹] å¸‚å ´æƒ…ç·’æ›´æ–°å®Œæˆ: {result}")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] å¸‚å ´æƒ…ç·’æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


@asynccontextmanager
async def lifespan(app: FastAPI):
    """æ‡‰ç”¨ç¨‹å¼ç”Ÿå‘½é€±æœŸç®¡ç†"""
    # å•Ÿå‹•æ™‚
    logger.info(f"Starting {settings.APP_NAME} v{settings.APP_VERSION}")

    # â˜…â˜…â˜… è¨ºæ–·è³‡æ–™åº«é€£ç·š â˜…â˜…â˜…
    from app.database import database_url, is_postgres
    db_type = "PostgreSQL" if is_postgres(database_url) else "SQLite"
    logger.info(f"â˜…â˜…â˜… Database Type: {db_type} â˜…â˜…â˜…")
    if is_postgres(database_url):
        # éš±è—å¯†ç¢¼
        safe_url = database_url.split("@")[-1] if "@" in database_url else database_url
        logger.info(f"â˜…â˜…â˜… Database Host: {safe_url} â˜…â˜…â˜…")
    else:
        logger.warning("âš ï¸ ä½¿ç”¨ SQLiteï¼è³‡æ–™æœƒåœ¨é‡æ–°éƒ¨ç½²å¾Œéºå¤±ï¼")
        logger.warning("âš ï¸ è«‹è¨­å®š DATABASE_URL ç’°å¢ƒè®Šæ•¸æŒ‡å‘ PostgreSQL")

    await init_db()
    logger.info("Database initialized")

    # ============================================================
    # ğŸ†• å„ªåŒ–å¾Œçš„æ’ç¨‹è¨­å®š
    # ============================================================

    # åƒ¹æ ¼å¿«å–ï¼šæ¯ 30 åˆ†é˜ï¼ˆåŸæœ¬ 10 åˆ†é˜ï¼‰
    # å…§éƒ¨æœƒåˆ¤æ–·äº¤æ˜“æ™‚é–“ï¼Œéäº¤æ˜“æ™‚é–“è‡ªå‹•è·³é
    scheduler.add_job(
        update_price_cache,
        'interval',
        minutes=30,  # ğŸ†• å¾ 10 åˆ†é˜æ”¹ç‚º 30 åˆ†é˜
        id='price_cache_update',
        name='åƒ¹æ ¼å¿«å–æ›´æ–°(æ¯30åˆ†é˜)',
    )

    # å°è‚¡æ”¶ç›¤å¾Œï¼ˆé€±ä¸€åˆ°é€±äº” 13:35ï¼‰
    scheduler.add_job(
        update_price_cache_force,
        CronTrigger(day_of_week='mon-fri', hour=13, minute=35),
        id='tw_close_update',
        name='å°è‚¡æ”¶ç›¤æ›´æ–°',
    )

    # ç¾è‚¡æ”¶ç›¤å¾Œï¼ˆé€±äºŒåˆ°é€±å…­ 05:05ï¼‰
    scheduler.add_job(
        update_price_cache_force,
        CronTrigger(day_of_week='tue-sat', hour=5, minute=5),
        id='us_close_update',
        name='ç¾è‚¡æ”¶ç›¤æ›´æ–°',
    )

    # ============================================================
    # åŒ¯ç‡æ’ç¨‹ï¼ˆæ¯å¤© 2 æ¬¡ï¼š09:00ã€17:00ï¼‰
    # ğŸ†• å¾ 3 æ¬¡æ”¹ç‚º 2 æ¬¡
    # ============================================================

    scheduler.add_job(
        update_exchange_rate,
        CronTrigger(hour=9, minute=0),
        id='exchange_rate_morning',
        name='åŒ¯ç‡æ›´æ–°(æ—©)',
    )

    scheduler.add_job(
        update_exchange_rate,
        CronTrigger(hour=17, minute=0),
        id='exchange_rate_evening',
        name='åŒ¯ç‡æ›´æ–°(æ™š)',
    )

    # ============================================================
    # ğŸ“¡ è¨‚é–±æºæ’ç¨‹
    # ğŸ†• å¾æ¯å°æ™‚æ”¹ç‚ºæ¯å¤© 3 æ¬¡ï¼ˆ08:00ã€12:00ã€20:00ï¼‰
    # ============================================================

    scheduler.add_job(
        fetch_subscription_sources,
        CronTrigger(hour=8, minute=0),
        id='subscription_fetch_morning',
        name='è¨‚é–±æºæŠ“å–(æ—©)',
    )

    scheduler.add_job(
        fetch_subscription_sources,
        CronTrigger(hour=12, minute=0),
        id='subscription_fetch_noon',
        name='è¨‚é–±æºæŠ“å–(ä¸­)',
    )

    scheduler.add_job(
        fetch_subscription_sources,
        CronTrigger(hour=20, minute=0),
        id='subscription_fetch_evening',
        name='è¨‚é–±æºæŠ“å–(æ™š)',
    )

    # ============================================================
    # ğŸ†• å¸‚å ´æƒ…ç·’æ’ç¨‹ï¼ˆæ¯å¤© 3 æ¬¡ï¼š08:30, 14:30, 20:30ï¼‰
    # è§£æ±ºå‰ç«¯æ¯æ¬¡è¼‰å…¥éƒ½è¦ç­‰å¾…å¤–éƒ¨ API çš„å•é¡Œ
    # ============================================================

    scheduler.add_job(
        update_market_sentiment,
        CronTrigger(hour=8, minute=30),
        id='sentiment_update_morning',
        name='å¸‚å ´æƒ…ç·’æ›´æ–°(æ—©)',
    )

    scheduler.add_job(
        update_market_sentiment,
        CronTrigger(hour=14, minute=30),
        id='sentiment_update_afternoon',
        name='å¸‚å ´æƒ…ç·’æ›´æ–°(åˆ)',
    )

    scheduler.add_job(
        update_market_sentiment,
        CronTrigger(hour=20, minute=30),
        id='sentiment_update_evening',
        name='å¸‚å ´æƒ…ç·’æ›´æ–°(æ™š)',
    )

    # å•Ÿå‹•æ’ç¨‹å™¨
    scheduler.start()
    logger.info("æ’ç¨‹å™¨å·²å•Ÿå‹•ï¼ˆå„ªåŒ–ç‰ˆï¼šåƒ¹æ ¼å¿«å–30åˆ†é˜ + äº¤æ˜“æ™‚é–“åˆ¤æ–· + æƒ…ç·’æ’ç¨‹ï¼‰")

    # ğŸ†• å•Ÿå‹•æ™‚åªæ›´æ–°åŒ¯ç‡ï¼Œåƒ¹æ ¼è®“æ’ç¨‹è™•ç†ï¼ˆæ¸›å°‘å•Ÿå‹•è² æ“”ï¼‰
    try:
        update_exchange_rate()
        # åªåœ¨äº¤æ˜“æ™‚é–“æ‰æ›´æ–°åƒ¹æ ¼
        if is_any_market_open():
            update_price_cache()
    except Exception as e:
        logger.error(f"å•Ÿå‹•æ™‚æ›´æ–°å¤±æ•—: {e}")

    # ğŸ†• å•Ÿå‹•æ™‚åˆå§‹åŒ– sentimentï¼ˆå¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„æˆ–éæœŸï¼‰
    try:
        update_market_sentiment()
        logger.info("âœ… å•Ÿå‹•æ™‚ sentiment åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        logger.error(f"å•Ÿå‹•æ™‚ sentiment åˆå§‹åŒ–å¤±æ•—: {e}")

    yield

    # é—œé–‰æ™‚
    scheduler.shutdown()
    logger.info("Shutting down...")


# å»ºç«‹ FastAPI æ‡‰ç”¨ç¨‹å¼
app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description="""
## ğŸ“ˆ SELA è‡ªå‹•é¸è‚¡ç³»çµ± API

å¤šç”¨æˆ¶è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°

### åŠŸèƒ½ç‰¹è‰²

- **æŠ€è¡“æŒ‡æ¨™**: MA, RSI, MACD, KD, å¸ƒæ—é€šé“, OBV
- **æ™ºèƒ½è¨Šè™Ÿ**: é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ã€çªç ´é è­¦
- **ç¶œåˆè©•åˆ†**: å¤šæŒ‡æ¨™å…±æŒ¯åˆ†æ
- **å¸‚å ´æƒ…ç·’**: CNN Fear & Greed / Alternative.me
- **åœ–è¡¨ç”Ÿæˆ**: å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨
- **å ±é…¬ç‡æ¯”è¼ƒ**: å¤šæ¨™çš„å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒ
- **å€‹äººæŠ•è³‡è¨˜éŒ„**: äº¤æ˜“ç´€éŒ„ã€æŒè‚¡ç®¡ç†ã€æç›Šè¿½è¹¤
- **è¨‚é–±ç²¾é¸**: è‡ªå‹•è¿½è¹¤æŠ•è³‡å°ˆå®¶ç²¾é¸è‚¡ç¥¨ ğŸ“¡

### èªè­‰æ–¹å¼

ä½¿ç”¨ LINE Login ç™»å…¥ï¼Œå–å¾— JWT Token å¾Œåœ¨ Header å¸¶å…¥ï¼š
```
Authorization: Bearer {token}
```
    """,
    docs_url="/docs",
    redoc_url="/redoc",
    lifespan=lifespan,
)

# CORS è¨­å®š
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # æ­£å¼ç’°å¢ƒæ‡‰é™åˆ¶ä¾†æº
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# è¨»å†Šè·¯ç”±
app.include_router(auth_router)
app.include_router(stock_router)
app.include_router(crypto_router)
app.include_router(watchlist_router)
app.include_router(settings_router)
app.include_router(admin_router)
app.include_router(market_router)
app.include_router(compare_router)
app.include_router(portfolio_router)
app.include_router(subscription_router)  # ğŸ“¡ è¨‚é–±ç²¾é¸
app.include_router(tags_router)  # ğŸ·ï¸ æ¨™ç±¤ç®¡ç†
app.include_router(stock_info_router)  # ğŸ“Š è‚¡ç¥¨è³‡è¨Š

# æ›è¼‰éœæ…‹æª”æ¡ˆ
static_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "static")
if os.path.exists(static_path):
    app.mount("/static", StaticFiles(directory=static_path, html=True), name="static")


# æ ¹è·¯å¾‘ - é‡å°å‘åˆ°ç™»å…¥é 
@app.get("/", tags=["ç³»çµ±"])
async def root():
    """é‡å°å‘åˆ°é¦–é """
    return RedirectResponse(url="/static/index.html")


# API ç‹€æ…‹
@app.get("/api", tags=["ç³»çµ±"])
async def api_root():
    """API æ ¹è·¯å¾‘"""
    return {
        "name": settings.APP_NAME,
        "version": settings.APP_VERSION,
        "status": "running",
        "docs": "/docs",
    }


# å¥åº·æª¢æŸ¥
@app.get("/health", tags=["ç³»çµ±"])
async def health_check():
    """å¥åº·æª¢æŸ¥"""
    return {
        "status": "healthy",
        "version": settings.APP_VERSION,
    }


# ğŸ†• æ’ç¨‹ç‹€æ…‹ API
@app.get("/api/admin/scheduler-status", tags=["ç®¡ç†"])
async def scheduler_status():
    """æŸ¥çœ‹æ’ç¨‹å™¨ç‹€æ…‹"""
    jobs = []
    for job in scheduler.get_jobs():
        jobs.append({
            "id": job.id,
            "name": job.name,
            "next_run": job.next_run_time.isoformat() if job.next_run_time else None,
        })
    
    return {
        "running": scheduler.running,
        "jobs": jobs,
        "market_status": {
            "tw_open": is_tw_market_hours(),
            "us_open": is_us_market_hours(),
            "any_open": is_any_market_open(),
        }
    }


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ main.py  â­â­â­
> FastAPI ä¸»ç¨‹å¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
FastAPI ä¸»ç¨‹å¼
è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ± API

ğŸ”§ ä¿®å¾©ç‰ˆæœ¬ - 2026-01-16
- åŠ å…¥å¸‚å ´æƒ…ç·’æ’ç¨‹æ›´æ–°ï¼ˆæ¯å¤© 3 æ¬¡ï¼‰
- å•Ÿå‹•æ™‚åˆå§‹åŒ– sentiment
- ğŸ·ï¸ åŠ å…¥ tags_router
- ğŸ“Š åŠ å…¥ stock_info_router
"""
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import RedirectResponse
import logging
import os
from datetime import datetime

from app.config import settings
from app.database import init_db
from app.logging_config import setup_logging

# åˆå§‹åŒ–æ—¥èªŒç³»çµ±ï¼ˆåœ¨å…¶ä»– import ä¹‹å‰ï¼‰
setup_logging(
    log_level="DEBUG" if settings.DEBUG else "INFO",
    log_to_file=True
)

# ç¢ºä¿æ‰€æœ‰ models è¢«è¼‰å…¥ï¼Œé€™æ¨£ Base.metadata æ‰æœƒåŒ…å«æ‰€æœ‰è¡¨æ ¼
from app.models import (
    User, Watchlist, StockPrice, CryptoPrice, 
    MarketSentiment, Notification,
    UserIndicatorSettings, UserAlertSettings, UserIndicatorParams,
    IndexPrice, DividendHistory,
    Comparison,
    StockPriceCache,
    PortfolioTransaction, PortfolioHolding, ExchangeRate,
    # P1: æ¨™ç±¤å’Œè‚¡ç¥¨è³‡è¨Š
    UserTag, watchlist_tags,
    StockInfo,
)
from app.models.user import LoginLog, TokenBlacklist, SystemConfig

from app.routers import (
    auth_router,
    stock_router,
    crypto_router,
    watchlist_router,
    settings_router,
    admin_router,
    compare_router,
    portfolio_router,
)
from app.routers.market import router as market_router
from app.routers.subscription import router as subscription_router  # ğŸ“¡ è¨‚é–±ç²¾é¸
from app.routers.tags import router as tags_router  # ğŸ·ï¸ æ¨™ç±¤ç®¡ç†
from app.routers.stock_info import router as stock_info_router  # ğŸ“Š è‚¡ç¥¨è³‡è¨Š

# æ’ç¨‹å™¨
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

logger = logging.getLogger(__name__)

# å»ºç«‹æ’ç¨‹å™¨
scheduler = AsyncIOScheduler()


# ============================================================
# ğŸ†• äº¤æ˜“æ™‚é–“åˆ¤æ–·ï¼ˆå„ªåŒ–ç‰ˆï¼‰
# ============================================================

def is_tw_market_hours() -> bool:
    """åˆ¤æ–·æ˜¯å¦åœ¨å°è‚¡äº¤æ˜“æ™‚é–“ï¼ˆé€±ä¸€åˆ°é€±äº” 09:00-13:30 å°åŒ—æ™‚é–“ï¼‰"""
    from datetime import timezone, timedelta
    tw_tz = timezone(timedelta(hours=8))
    now = datetime.now(tw_tz)
    
    # é€±æœ«ä¸é–‹ç›¤
    if now.weekday() >= 5:
        return False
    
    # 09:00 - 13:30
    market_open = now.replace(hour=9, minute=0, second=0, microsecond=0)
    market_close = now.replace(hour=13, minute=30, second=0, microsecond=0)
    
    return market_open <= now <= market_close


def is_us_market_hours() -> bool:
    """åˆ¤æ–·æ˜¯å¦åœ¨ç¾è‚¡äº¤æ˜“æ™‚é–“ï¼ˆé€±ä¸€åˆ°é€±äº” 21:30-05:00 å°åŒ—æ™‚é–“ï¼‰"""
    from datetime import timezone, timedelta
    tw_tz = timezone(timedelta(hours=8))
    now = datetime.now(tw_tz)
    
    # é€±æœ«ä¸é–‹ç›¤ï¼ˆé€±å…­ 05:00 å¾Œã€é€±æ—¥å…¨å¤©ï¼‰
    if now.weekday() == 6:  # é€±æ—¥
        return False
    if now.weekday() == 5 and now.hour >= 5:  # é€±å…­ 05:00 å¾Œ
        return False
    
    # 21:30 - 05:00 (è·¨æ—¥)
    hour = now.hour
    minute = now.minute
    
    if hour >= 21 and minute >= 30:
        return True
    if hour >= 22:
        return True
    if hour < 5:
        return True
    
    return False


def is_any_market_open() -> bool:
    """åˆ¤æ–·æ˜¯å¦æœ‰ä»»ä½•å¸‚å ´é–‹ç›¤"""
    return is_tw_market_hours() or is_us_market_hours()


# ============================================================
# åƒ¹æ ¼å¿«å–æ›´æ–°å‡½æ•¸ï¼ˆå„ªåŒ–ç‰ˆï¼‰
# ============================================================

def update_price_cache():
    """
    æ’ç¨‹ä»»å‹™ï¼šæ›´æ–°åƒ¹æ ¼å¿«å–
    ğŸ†• å„ªåŒ–ï¼šåªåœ¨äº¤æ˜“æ™‚é–“åŸ·è¡Œ
    """
    # æª¢æŸ¥æ˜¯å¦æœ‰å¸‚å ´é–‹ç›¤
    if not is_any_market_open():
        logger.debug("[æ’ç¨‹] éäº¤æ˜“æ™‚é–“ï¼Œè·³éåƒ¹æ ¼æ›´æ–°")
        return
    
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService

    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°åƒ¹æ ¼å¿«å–...")
    db = SyncSessionLocal()
    try:
        service = PriceCacheService(db)
        result = service.update_all(force=False)
        logger.info(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–æ›´æ–°å®Œæˆ: {result['total_updated']} ç­†")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


def update_price_cache_force():
    """å¼·åˆ¶æ›´æ–°æ‰€æœ‰åƒ¹æ ¼ï¼ˆæ”¶ç›¤å¾Œï¼‰"""
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService

    logger.info("[æ’ç¨‹] å¼·åˆ¶æ›´æ–°æ‰€æœ‰åƒ¹æ ¼å¿«å–...")
    db = SyncSessionLocal()
    try:
        service = PriceCacheService(db)
        result = service.update_all(force=True)
        logger.info(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–å¼·åˆ¶æ›´æ–°å®Œæˆ: {result['total_updated']} ç­†")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åƒ¹æ ¼å¿«å–å¼·åˆ¶æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


# ============================================================
# åŒ¯ç‡æ›´æ–°å‡½æ•¸
# ============================================================

def update_exchange_rate():
    """æ’ç¨‹ä»»å‹™ï¼šæ›´æ–° USD/TWD åŒ¯ç‡"""
    from app.database import SyncSessionLocal
    from app.services.exchange_rate_service import update_exchange_rate_sync

    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°åŒ¯ç‡...")
    db = SyncSessionLocal()
    try:
        rate = update_exchange_rate_sync(db)
        logger.info(f"[æ’ç¨‹] åŒ¯ç‡æ›´æ–°å®Œæˆ: USD/TWD = {rate:.4f}")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] åŒ¯ç‡æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


# ============================================================
# ğŸ“¡ è¨‚é–±æºæŠ“å–å‡½æ•¸
# ============================================================

def fetch_subscription_sources():
    """æ’ç¨‹ä»»å‹™ï¼šæŠ“å–è¨‚é–±æºæ›´æ–°"""
    from app.database import SyncSessionLocal
    from app.services.subscription_service import SubscriptionService

    logger.info("[æ’ç¨‹] é–‹å§‹æŠ“å–è¨‚é–±æº...")
    db = SyncSessionLocal()
    try:
        service = SubscriptionService(db)
        result = service.fetch_all_sources(backfill=False)
        logger.info(f"[æ’ç¨‹] è¨‚é–±æºæŠ“å–å®Œæˆ: {result}")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] è¨‚é–±æºæŠ“å–å¤±æ•—: {e}")
    finally:
        db.close()


# ============================================================
# ğŸ†• å¸‚å ´æƒ…ç·’æ›´æ–°å‡½æ•¸ï¼ˆæ–°å¢ï¼‰
# ============================================================

def update_market_sentiment():
    """
    æ’ç¨‹ä»»å‹™ï¼šæ›´æ–°å¸‚å ´æƒ…ç·’æŒ‡æ•¸
    æ¯å¤©åŸ·è¡Œ 3 æ¬¡ï¼Œå°‡å¤–éƒ¨ API è³‡æ–™å­˜å…¥è³‡æ–™åº«
    è§£æ±ºå‰ç«¯æ¯æ¬¡è¼‰å…¥éƒ½è¦ç­‰å¾…å¤–éƒ¨ API çš„å•é¡Œ
    """
    from app.database import SyncSessionLocal
    from app.services.market_service import MarketService

    logger.info("[æ’ç¨‹] é–‹å§‹æ›´æ–°å¸‚å ´æƒ…ç·’...")
    db = SyncSessionLocal()
    try:
        market_service = MarketService(db)
        result = market_service.update_today_sentiment()
        logger.info(f"[æ’ç¨‹] å¸‚å ´æƒ…ç·’æ›´æ–°å®Œæˆ: {result}")
    except Exception as e:
        logger.error(f"[æ’ç¨‹] å¸‚å ´æƒ…ç·’æ›´æ–°å¤±æ•—: {e}")
    finally:
        db.close()


@asynccontextmanager
async def lifespan(app: FastAPI):
    """æ‡‰ç”¨ç¨‹å¼ç”Ÿå‘½é€±æœŸç®¡ç†"""
    # å•Ÿå‹•æ™‚
    logger.info(f"Starting {settings.APP_NAME} v{settings.APP_VERSION}")

    # â˜…â˜…â˜… è¨ºæ–·è³‡æ–™åº«é€£ç·š â˜…â˜…â˜…
    from app.database import database_url, is_postgres
    db_type = "PostgreSQL" if is_postgres(database_url) else "SQLite"
    logger.info(f"â˜…â˜…â˜… Database Type: {db_type} â˜…â˜…â˜…")
    if is_postgres(database_url):
        # éš±è—å¯†ç¢¼
        safe_url = database_url.split("@")[-1] if "@" in database_url else database_url
        logger.info(f"â˜…â˜…â˜… Database Host: {safe_url} â˜…â˜…â˜…")
    else:
        logger.warning("âš ï¸ ä½¿ç”¨ SQLiteï¼è³‡æ–™æœƒåœ¨é‡æ–°éƒ¨ç½²å¾Œéºå¤±ï¼")
        logger.warning("âš ï¸ è«‹è¨­å®š DATABASE_URL ç’°å¢ƒè®Šæ•¸æŒ‡å‘ PostgreSQL")

    await init_db()
    logger.info("Database initialized")

    # ============================================================
    # ğŸ†• å„ªåŒ–å¾Œçš„æ’ç¨‹è¨­å®š
    # ============================================================

    # åƒ¹æ ¼å¿«å–ï¼šæ¯ 30 åˆ†é˜ï¼ˆåŸæœ¬ 10 åˆ†é˜ï¼‰
    # å…§éƒ¨æœƒåˆ¤æ–·äº¤æ˜“æ™‚é–“ï¼Œéäº¤æ˜“æ™‚é–“è‡ªå‹•è·³é
    scheduler.add_job(
        update_price_cache,
        'interval',
        minutes=30,  # ğŸ†• å¾ 10 åˆ†é˜æ”¹ç‚º 30 åˆ†é˜
        id='price_cache_update',
        name='åƒ¹æ ¼å¿«å–æ›´æ–°(æ¯30åˆ†é˜)',
    )

    # å°è‚¡æ”¶ç›¤å¾Œï¼ˆé€±ä¸€åˆ°é€±äº” 13:35ï¼‰
    scheduler.add_job(
        update_price_cache_force,
        CronTrigger(day_of_week='mon-fri', hour=13, minute=35),
        id='tw_close_update',
        name='å°è‚¡æ”¶ç›¤æ›´æ–°',
    )

    # ç¾è‚¡æ”¶ç›¤å¾Œï¼ˆé€±äºŒåˆ°é€±å…­ 05:05ï¼‰
    scheduler.add_job(
        update_price_cache_force,
        CronTrigger(day_of_week='tue-sat', hour=5, minute=5),
        id='us_close_update',
        name='ç¾è‚¡æ”¶ç›¤æ›´æ–°',
    )

    # ============================================================
    # åŒ¯ç‡æ’ç¨‹ï¼ˆæ¯å¤© 2 æ¬¡ï¼š09:00ã€17:00ï¼‰
    # ğŸ†• å¾ 3 æ¬¡æ”¹ç‚º 2 æ¬¡
    # ============================================================

    scheduler.add_job(
        update_exchange_rate,
        CronTrigger(hour=9, minute=0),
        id='exchange_rate_morning',
        name='åŒ¯ç‡æ›´æ–°(æ—©)',
    )

    scheduler.add_job(
        update_exchange_rate,
        CronTrigger(hour=17, minute=0),
        id='exchange_rate_evening',
        name='åŒ¯ç‡æ›´æ–°(æ™š)',
    )

    # ============================================================
    # ğŸ“¡ è¨‚é–±æºæ’ç¨‹
    # ğŸ†• å¾æ¯å°æ™‚æ”¹ç‚ºæ¯å¤© 3 æ¬¡ï¼ˆ08:00ã€12:00ã€20:00ï¼‰
    # ============================================================

    scheduler.add_job(
        fetch_subscription_sources,
        CronTrigger(hour=8, minute=0),
        id='subscription_fetch_morning',
        name='è¨‚é–±æºæŠ“å–(æ—©)',
    )

    scheduler.add_job(
        fetch_subscription_sources,
        CronTrigger(hour=12, minute=0),
        id='subscription_fetch_noon',
        name='è¨‚é–±æºæŠ“å–(ä¸­)',
    )

    scheduler.add_job(
        fetch_subscription_sources,
        CronTrigger(hour=20, minute=0),
        id='subscription_fetch_evening',
        name='è¨‚é–±æºæŠ“å–(æ™š)',
    )

    # ============================================================
    # ğŸ†• å¸‚å ´æƒ…ç·’æ’ç¨‹ï¼ˆæ¯å¤© 3 æ¬¡ï¼š08:30, 14:30, 20:30ï¼‰
    # è§£æ±ºå‰ç«¯æ¯æ¬¡è¼‰å…¥éƒ½è¦ç­‰å¾…å¤–éƒ¨ API çš„å•é¡Œ
    # ============================================================

    scheduler.add_job(
        update_market_sentiment,
        CronTrigger(hour=8, minute=30),
        id='sentiment_update_morning',
        name='å¸‚å ´æƒ…ç·’æ›´æ–°(æ—©)',
    )

    scheduler.add_job(
        update_market_sentiment,
        CronTrigger(hour=14, minute=30),
        id='sentiment_update_afternoon',
        name='å¸‚å ´æƒ…ç·’æ›´æ–°(åˆ)',
    )

    scheduler.add_job(
        update_market_sentiment,
        CronTrigger(hour=20, minute=30),
        id='sentiment_update_evening',
        name='å¸‚å ´æƒ…ç·’æ›´æ–°(æ™š)',
    )

    # å•Ÿå‹•æ’ç¨‹å™¨
    scheduler.start()
    logger.info("æ’ç¨‹å™¨å·²å•Ÿå‹•ï¼ˆå„ªåŒ–ç‰ˆï¼šåƒ¹æ ¼å¿«å–30åˆ†é˜ + äº¤æ˜“æ™‚é–“åˆ¤æ–· + æƒ…ç·’æ’ç¨‹ï¼‰")

    # ğŸ†• å•Ÿå‹•æ™‚åªæ›´æ–°åŒ¯ç‡ï¼Œåƒ¹æ ¼è®“æ’ç¨‹è™•ç†ï¼ˆæ¸›å°‘å•Ÿå‹•è² æ“”ï¼‰
    try:
        update_exchange_rate()
        # åªåœ¨äº¤æ˜“æ™‚é–“æ‰æ›´æ–°åƒ¹æ ¼
        if is_any_market_open():
            update_price_cache()
    except Exception as e:
        logger.error(f"å•Ÿå‹•æ™‚æ›´æ–°å¤±æ•—: {e}")

    # ğŸ†• å•Ÿå‹•æ™‚åˆå§‹åŒ– sentimentï¼ˆå¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„æˆ–éæœŸï¼‰
    try:
        update_market_sentiment()
        logger.info("âœ… å•Ÿå‹•æ™‚ sentiment åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        logger.error(f"å•Ÿå‹•æ™‚ sentiment åˆå§‹åŒ–å¤±æ•—: {e}")

    yield

    # é—œé–‰æ™‚
    scheduler.shutdown()
    logger.info("Shutting down...")


# å»ºç«‹ FastAPI æ‡‰ç”¨ç¨‹å¼
app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description="""
## ğŸ“ˆ SELA è‡ªå‹•é¸è‚¡ç³»çµ± API

å¤šç”¨æˆ¶è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°

### åŠŸèƒ½ç‰¹è‰²

- **æŠ€è¡“æŒ‡æ¨™**: MA, RSI, MACD, KD, å¸ƒæ—é€šé“, OBV
- **æ™ºèƒ½è¨Šè™Ÿ**: é»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ã€çªç ´é è­¦
- **ç¶œåˆè©•åˆ†**: å¤šæŒ‡æ¨™å…±æŒ¯åˆ†æ
- **å¸‚å ´æƒ…ç·’**: CNN Fear & Greed / Alternative.me
- **åœ–è¡¨ç”Ÿæˆ**: å®Œæ•´æŠ€è¡“åˆ†æåœ–è¡¨
- **å ±é…¬ç‡æ¯”è¼ƒ**: å¤šæ¨™çš„å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒ
- **å€‹äººæŠ•è³‡è¨˜éŒ„**: äº¤æ˜“ç´€éŒ„ã€æŒè‚¡ç®¡ç†ã€æç›Šè¿½è¹¤
- **è¨‚é–±ç²¾é¸**: è‡ªå‹•è¿½è¹¤æŠ•è³‡å°ˆå®¶ç²¾é¸è‚¡ç¥¨ ğŸ“¡

### èªè­‰æ–¹å¼

ä½¿ç”¨ LINE Login ç™»å…¥ï¼Œå–å¾— JWT Token å¾Œåœ¨ Header å¸¶å…¥ï¼š
```
Authorization: Bearer {token}
```
    """,
    docs_url="/docs",
    redoc_url="/redoc",
    lifespan=lifespan,
)

# CORS è¨­å®š
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # æ­£å¼ç’°å¢ƒæ‡‰é™åˆ¶ä¾†æº
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# è¨»å†Šè·¯ç”±
app.include_router(auth_router)
app.include_router(stock_router)
app.include_router(crypto_router)
app.include_router(watchlist_router)
app.include_router(settings_router)
app.include_router(admin_router)
app.include_router(market_router)
app.include_router(compare_router)
app.include_router(portfolio_router)
app.include_router(subscription_router)  # ğŸ“¡ è¨‚é–±ç²¾é¸
app.include_router(tags_router)  # ğŸ·ï¸ æ¨™ç±¤ç®¡ç†
app.include_router(stock_info_router)  # ğŸ“Š è‚¡ç¥¨è³‡è¨Š

# æ›è¼‰éœæ…‹æª”æ¡ˆ
static_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "static")
if os.path.exists(static_path):
    app.mount("/static", StaticFiles(directory=static_path, html=True), name="static")


# æ ¹è·¯å¾‘ - é‡å°å‘åˆ°ç™»å…¥é 
@app.get("/", tags=["ç³»çµ±"])
async def root():
    """é‡å°å‘åˆ°é¦–é """
    return RedirectResponse(url="/static/index.html")


# API ç‹€æ…‹
@app.get("/api", tags=["ç³»çµ±"])
async def api_root():
    """API æ ¹è·¯å¾‘"""
    return {
        "name": settings.APP_NAME,
        "version": settings.APP_VERSION,
        "status": "running",
        "docs": "/docs",
    }


# å¥åº·æª¢æŸ¥
@app.get("/health", tags=["ç³»çµ±"])
async def health_check():
    """å¥åº·æª¢æŸ¥"""
    return {
        "status": "healthy",
        "version": settings.APP_VERSION,
    }


# ğŸ†• æ’ç¨‹ç‹€æ…‹ API
@app.get("/api/admin/scheduler-status", tags=["ç®¡ç†"])
async def scheduler_status():
    """æŸ¥çœ‹æ’ç¨‹å™¨ç‹€æ…‹"""
    jobs = []
    for job in scheduler.get_jobs():
        jobs.append({
            "id": job.id,
            "name": job.name,
            "next_run": job.next_run_time.isoformat() if job.next_run_time else None,
        })
    
    return {
        "running": scheduler.running,
        "jobs": jobs,
        "market_status": {
            "tw_open": is_tw_market_hours(),
            "us_open": is_us_market_hours(),
            "any_open": is_any_market_open(),
        }
    }


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

======================================================================
## ğŸŒ API / è·¯ç”±
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/__init__.py  â­â­â­
> API è·¯ç”±æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
API è·¯ç”±æ¨¡çµ„
"""
from app.routers.auth import router as auth_router
from app.routers.stock import router as stock_router
from app.routers.crypto import router as crypto_router
from app.routers.watchlist import router as watchlist_router
from app.routers.settings import router as settings_router
from app.routers.admin import router as admin_router
from app.routers.compare import router as compare_router
from app.routers.portfolio import router as portfolio_router  # ğŸ†• å€‹äººæŠ•è³‡è¨˜éŒ„

__all__ = [
    "auth_router",
    "stock_router",
    "crypto_router",
    "watchlist_router",
    "settings_router",
    "admin_router",
    "compare_router",
    "portfolio_router",  # ğŸ†• å€‹äººæŠ•è³‡è¨˜éŒ„
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/admin.py  â­â­â­
> ç®¡ç†å“¡ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ç®¡ç†å“¡ API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
"""
from fastapi import APIRouter, Depends, HTTPException, Query, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, update, delete
from sqlalchemy.orm import selectinload
from typing import Optional
from datetime import datetime, timedelta
import logging

from app.database import get_async_session
from app.models.user import User, LoginLog, TokenBlacklist, SystemConfig
from app.services.exchange_rate_service import update_exchange_rate_sync
from app.config import settings

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_admin_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/admin", tags=["ç®¡ç†å“¡"])


@router.get("/stats", summary="ç³»çµ±çµ±è¨ˆ")
async def get_stats(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç³»çµ±çµ±è¨ˆè³‡æ–™"""
    # ç”¨æˆ¶çµ±è¨ˆ
    total_users = await db.scalar(select(func.count(User.id)))
    active_users = await db.scalar(select(func.count(User.id)).where(User.is_active == True))
    blocked_users = await db.scalar(select(func.count(User.id)).where(User.is_blocked == True))
    admin_users = await db.scalar(select(func.count(User.id)).where(User.is_admin == True))
    
    # ç¸½ç™»å…¥æ¬¡æ•¸
    total_logins = await db.scalar(
        select(func.count(LoginLog.id))
        .where(LoginLog.action == "login")
    )
    
    # ä»Šæ—¥ç™»å…¥
    today = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)
    today_logins = await db.scalar(
        select(func.count(LoginLog.id))
        .where(LoginLog.action == "login")
        .where(LoginLog.created_at >= today)
    )
    
    # è¿‘ 7 å¤©æ´»èºç”¨æˆ¶
    week_ago = datetime.utcnow() - timedelta(days=7)
    weekly_active = await db.scalar(
        select(func.count(func.distinct(LoginLog.user_id)))
        .where(LoginLog.created_at >= week_ago)
    )
    
    return {
        "success": True,
        "stats": {
            "total_users": total_users or 0,
            "active_users": active_users or 0,
            "blocked_users": blocked_users or 0,
            "admin_users": admin_users or 0,
            "total_logins": total_logins or 0,
            "today_logins": today_logins or 0,
            "weekly_active_users": weekly_active or 0,
        }
    }


@router.get("/users", summary="ç”¨æˆ¶åˆ—è¡¨")
async def list_users(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    search: Optional[str] = None,
    blocked_only: bool = False,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç”¨æˆ¶åˆ—è¡¨ï¼ˆå«ç™»å…¥æ¬¡æ•¸ï¼‰"""
    query = select(User).order_by(User.last_login.desc())
    
    # æœå°‹
    if search:
        query = query.where(
            (User.display_name.ilike(f"%{search}%")) |
            (User.email.ilike(f"%{search}%")) |
            (User.line_user_id.ilike(f"%{search}%"))
        )
    
    # åªé¡¯ç¤ºå°é–ç”¨æˆ¶
    if blocked_only:
        query = query.where(User.is_blocked == True)
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    users = result.scalars().all()
    
    # å–å¾—æ¯å€‹ç”¨æˆ¶çš„ç™»å…¥æ¬¡æ•¸
    user_ids = [u.id for u in users]
    login_counts = {}
    if user_ids:
        login_count_result = await db.execute(
            select(LoginLog.user_id, func.count(LoginLog.id).label('count'))
            .where(LoginLog.user_id.in_(user_ids))
            .where(LoginLog.action == "login")
            .group_by(LoginLog.user_id)
        )
        for row in login_count_result:
            login_counts[row.user_id] = row.count
    
    # çµ„åˆçµæœ
    users_data = []
    for u in users:
        user_dict = u.to_dict()
        user_dict["login_count"] = login_counts.get(u.id, 0)
        users_data.append(user_dict)
    
    return {
        "success": True,
        "users": users_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }


@router.get("/users/{user_id}", summary="ç”¨æˆ¶è©³æƒ…")
async def get_user_detail(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç”¨æˆ¶è©³ç´°è³‡è¨Š"""
    result = await db.execute(
        select(User).where(User.id == user_id)
    )
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    # å–å¾—æœ€è¿‘ç™»å…¥è¨˜éŒ„
    logs_result = await db.execute(
        select(LoginLog)
        .where(LoginLog.user_id == user_id)
        .order_by(LoginLog.created_at.desc())
        .limit(20)
    )
    logs = logs_result.scalars().all()
    
    return {
        "success": True,
        "user": user.to_dict(),
        "recent_logs": [log.to_dict() for log in logs],
    }


@router.get("/logs", summary="ç™»å…¥æ—¥èªŒ")
async def list_logs(
    page: int = Query(1, ge=1),
    page_size: int = Query(50, ge=1, le=100),
    user_id: Optional[int] = None,
    action: Optional[str] = None,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç™»å…¥æ—¥èªŒ"""
    query = select(LoginLog).order_by(LoginLog.created_at.desc())
    
    if user_id:
        query = query.where(LoginLog.user_id == user_id)
    
    if action:
        query = query.where(LoginLog.action == action)
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    logs = result.scalars().all()
    
    # å–å¾—ç”¨æˆ¶åç¨±
    user_ids = list(set(log.user_id for log in logs))
    if user_ids:
        users_result = await db.execute(
            select(User).where(User.id.in_(user_ids))
        )
        users_map = {u.id: u.display_name for u in users_result.scalars().all()}
    else:
        users_map = {}
    
    logs_data = []
    for log in logs:
        log_dict = log.to_dict()
        log_dict["user_name"] = users_map.get(log.user_id, "Unknown")
        logs_data.append(log_dict)
    
    return {
        "success": True,
        "logs": logs_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }


@router.post("/users/{user_id}/block", summary="å°é–ç”¨æˆ¶")
async def block_user(
    user_id: int,
    reason: str = Query("", description="å°é–åŸå› "),
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å°é–ç”¨æˆ¶"""
    if user_id == admin.id:
        raise HTTPException(status_code=400, detail="ä¸èƒ½å°é–è‡ªå·±")
    
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    if user.is_admin:
        raise HTTPException(status_code=400, detail="ä¸èƒ½å°é–ç®¡ç†å“¡")
    
    user.is_blocked = True
    user.block_reason = reason
    
    # è¨˜éŒ„æ“ä½œ
    log = LoginLog(
        user_id=user_id,
        action="blocked",
        ip_address=None,
        user_agent=f"By admin: {admin.display_name}",
    )
    db.add(log)
    
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²å°é–ç”¨æˆ¶: {user.display_name}",
    }


@router.post("/users/{user_id}/unblock", summary="è§£é™¤å°é–")
async def unblock_user(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è§£é™¤ç”¨æˆ¶å°é–"""
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    user.is_blocked = False
    user.block_reason = None
    
    # è¨˜éŒ„æ“ä½œ
    log = LoginLog(
        user_id=user_id,
        action="unblocked",
        ip_address=None,
        user_agent=f"By admin: {admin.display_name}",
    )
    db.add(log)
    
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²è§£é™¤å°é–: {user.display_name}",
    }


@router.post("/users/{user_id}/set-admin", summary="è¨­å®šç®¡ç†å“¡")
async def set_admin(
    user_id: int,
    is_admin: bool = Query(..., description="æ˜¯å¦ç‚ºç®¡ç†å“¡"),
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è¨­å®šæˆ–å–æ¶ˆç®¡ç†å“¡æ¬Šé™"""
    if user_id == admin.id and not is_admin:
        raise HTTPException(status_code=400, detail="ä¸èƒ½å–æ¶ˆè‡ªå·±çš„ç®¡ç†å“¡æ¬Šé™")
    
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    user.is_admin = is_admin
    
    # è¨˜éŒ„æ“ä½œ
    action = "promoted_to_admin" if is_admin else "demoted_from_admin"
    log = LoginLog(
        user_id=user_id,
        action=action,
        ip_address=None,
        user_agent=f"By admin: {admin.display_name}",
    )
    db.add(log)
    
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²{'è¨­å®š' if is_admin else 'å–æ¶ˆ'} {user.display_name} çš„ç®¡ç†å“¡æ¬Šé™",
    }


@router.delete("/users/{user_id}", summary="åˆªé™¤ç”¨æˆ¶")
async def delete_user(
    user_id: int,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤ç”¨æˆ¶ï¼ˆåƒ…é™æ¸¬è©¦ç’°å¢ƒï¼‰"""
    if user_id == admin.id:
        raise HTTPException(status_code=400, detail="ä¸èƒ½åˆªé™¤è‡ªå·±")
    
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ¶ä¸å­˜åœ¨")
    
    if user.is_admin:
        raise HTTPException(status_code=400, detail="ä¸èƒ½åˆªé™¤ç®¡ç†å“¡")
    
    # åˆªé™¤ç›¸é—œè³‡æ–™
    await db.execute(delete(LoginLog).where(LoginLog.user_id == user_id))
    await db.delete(user)
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²åˆªé™¤ç”¨æˆ¶: {user.display_name}",
    }


# ============================================================
# ç³»çµ±è¨­å®š
# ============================================================

@router.get("/config", summary="å–å¾—ç³»çµ±è¨­å®š")
async def get_config(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç³»çµ±è¨­å®š"""
    result = await db.execute(select(SystemConfig))
    configs = result.scalars().all()
    
    return {
        "success": True,
        "configs": {c.key: c.value for c in configs},
    }


@router.put("/config/{key}", summary="æ›´æ–°ç³»çµ±è¨­å®š")
async def update_config(
    key: str,
    value: str = Query(..., description="è¨­å®šå€¼"),
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ›´æ–°ç³»çµ±è¨­å®š"""
    result = await db.execute(
        select(SystemConfig).where(SystemConfig.key == key)
    )
    config = result.scalar_one_or_none()
    
    if config:
        config.value = value
    else:
        config = SystemConfig(key=key, value=value)
        db.add(config)
    
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²æ›´æ–°è¨­å®š: {key}",
    }


# ============================================================
# è¨Šè™Ÿé€šçŸ¥ç®¡ç†
# ============================================================

@router.post("/signal/send-now", summary="ç«‹å³ç™¼é€è¨Šè™Ÿé€šçŸ¥")
async def send_signal_now(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    ç«‹å³åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ä¸¦ç™¼é€é€šçŸ¥
    """
    from app.tasks.scheduler import scheduler_service
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} è§¸ç™¼ç«‹å³ç™¼é€è¨Šè™Ÿé€šçŸ¥")
    
    try:
        result = scheduler_service.run_signal_notification()
        
        return {
            "success": True,
            "signals_detected": result.get("signals_count", 0),
            "notifications_sent": result.get("notifications_sent", 0),
            "errors": result.get("errors", []),
            "message": f"åµæ¸¬åˆ° {result.get('signals_count', 0)} å€‹è¨Šè™Ÿï¼Œç™¼é€ {result.get('notifications_sent', 0)} å‰‡é€šçŸ¥"
        }
    except Exception as e:
        logger.error(f"è¨Šè™Ÿé€šçŸ¥å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/signal/test-push", summary="æ¸¬è©¦ LINE æ¨æ’­")
async def test_line_push(
    message: str = Query("é€™æ˜¯æ¸¬è©¦è¨Šæ¯", description="æ¸¬è©¦è¨Šæ¯å…§å®¹"),
    admin: User = Depends(get_admin_user),
):
    """
    æ¸¬è©¦ LINE æ¨æ’­åŠŸèƒ½
    ç™¼é€æ¸¬è©¦è¨Šæ¯çµ¦ç®¡ç†å“¡è‡ªå·±
    """
    from app.services.line_notify_service import line_notify_service
    
    if not line_notify_service.enabled:
        return {
            "success": False,
            "message": "LINE Messaging API æœªå•Ÿç”¨ï¼Œè«‹è¨­å®š LINE_MESSAGING_CHANNEL_ACCESS_TOKEN"
        }
    
    try:
        test_message = f"ğŸ“Š SELA ç³»çµ±æ¸¬è©¦\n\n{message}\n\nâ° {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        
        success = await line_notify_service.push_text_message(admin.line_user_id, test_message)
        
        return {
            "success": success,
            "message": "æ¸¬è©¦è¨Šæ¯å·²ç™¼é€" if success else "ç™¼é€å¤±æ•—",
            "line_user_id": admin.line_user_id[:10] + "..."
        }
    except Exception as e:
        logger.error(f"æ¸¬è©¦æ¨æ’­å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/signal/status", summary="é€šçŸ¥ç³»çµ±ç‹€æ…‹")
async def get_signal_status(
    admin: User = Depends(get_admin_user),
):
    """
    å–å¾—è¨Šè™Ÿé€šçŸ¥ç³»çµ±ç‹€æ…‹
    """
    from app.services.line_notify_service import line_notify_service
    from app.tasks.scheduler import scheduler_service
    
    return {
        "success": True,
        "status": {
            "line_messaging_enabled": line_notify_service.enabled,
            "line_messaging_token_set": bool(settings.LINE_MESSAGING_CHANNEL_ACCESS_TOKEN),
            "scheduler_last_run": scheduler_service.last_run.isoformat() if scheduler_service.last_run else None,
            "scheduler_last_result": scheduler_service.last_result,
        }
    }


@router.post("/signal/detect", summary="æ‰‹å‹•åµæ¸¬è¨Šè™Ÿ")
async def detect_signals_manual(
    admin: User = Depends(get_admin_user),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
    ç”¨æ–¼æ¸¬è©¦è¨Šè™Ÿåµæ¸¬é‚è¼¯
    """
    from app.tasks.scheduler import scheduler_service
    
    try:
        result = scheduler_service.run_signal_detection_only()
        
        return {
            "success": True,
            "message": f"åµæ¸¬å®Œæˆï¼Œå…± {len(result.get('signals', []))} å€‹è¨Šè™Ÿ",
            "signals_by_symbol": result.get("by_symbol", {}),
            "total_signals": len(result.get("signals", [])),
        }
    except Exception as e:
        logger.error(f"è¨Šè™Ÿåµæ¸¬å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/signal/notify", summary="æ‰‹å‹•ç™¼é€é€šçŸ¥")
async def send_notifications_manual(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ‰‹å‹•åŸ·è¡Œè¨Šè™Ÿåµæ¸¬ä¸¦ç™¼é€é€šçŸ¥
    ç­‰åŒæ–¼æ¯æ—¥æ’ç¨‹ä»»å‹™
    """
    from app.tasks.scheduler import scheduler_service
    
    try:
        result = scheduler_service.run_daily_update()
        
        return {
            "success": result.get("success", False),
            "message": "æ¯æ—¥æ›´æ–°ä»»å‹™å·²åŸ·è¡Œ",
            "result": {
                "stocks_updated": result.get("stocks_updated", 0),
                "signals_detected": result.get("signals_detected", 0),
                "notifications_sent": result.get("notifications_sent", 0),
                "errors": result.get("errors", []),
            }
        }
    except Exception as e:
        logger.error(f"é€šçŸ¥ä»»å‹™å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/notifications", summary="é€šçŸ¥è¨˜éŒ„")
async def list_notifications(
    page: int = Query(1, ge=1),
    page_size: int = Query(50, ge=1, le=100),
    user_id: Optional[int] = None,
    symbol: Optional[str] = None,
    sent_only: bool = False,
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—é€šçŸ¥è¨˜éŒ„
    """
    from app.models.notification import Notification
    
    query = select(Notification).order_by(Notification.triggered_at.desc())
    
    if user_id:
        query = query.where(Notification.user_id == user_id)
    
    if symbol:
        query = query.where(Notification.symbol == symbol.upper())
    
    if sent_only:
        query = query.where(Notification.sent == True)
    
    # è¨ˆç®—ç¸½æ•¸
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)
    
    # åˆ†é 
    query = query.offset((page - 1) * page_size).limit(page_size)
    result = await db.execute(query)
    notifications = result.scalars().all()
    
    # å–å¾—ç”¨æˆ¶åç¨±
    user_ids = list(set(n.user_id for n in notifications))
    users_map = {}
    if user_ids:
        users_result = await db.execute(select(User).where(User.id.in_(user_ids)))
        users_map = {u.id: u.display_name for u in users_result.scalars().all()}
    
    notifications_data = []
    for n in notifications:
        n_dict = n.to_dict()
        n_dict["user_name"] = users_map.get(n.user_id, "Unknown")
        notifications_data.append(n_dict)
    
    return {
        "success": True,
        "notifications": notifications_data,
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total": total or 0,
            "total_pages": ((total or 0) + page_size - 1) // page_size,
        }
    }


# ============================================================
# ç®¡ç†å“¡è§¸ç™¼æ›´æ–° API
# ============================================================

@router.post("/update-exchange-rate", summary="æ›´æ–°åŒ¯ç‡")
async def admin_update_exchange_rate(
    admin: User = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    ç®¡ç†å“¡æ‰‹å‹•è§¸ç™¼ USD/TWD åŒ¯ç‡æ›´æ–°
    """
    from app.database import SyncSessionLocal
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} è§¸ç™¼åŒ¯ç‡æ›´æ–°")
    
    try:
        sync_db = SyncSessionLocal()
        try:
            rate = update_exchange_rate_sync(sync_db)
            return {
                "success": True,
                "message": f"åŒ¯ç‡å·²æ›´æ–°: USD/TWD = {rate:.4f}",
                "rate": rate,
            }
        finally:
            sync_db.close()
    except Exception as e:
        logger.error(f"åŒ¯ç‡æ›´æ–°å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/update-indices", summary="æ›´æ–°å››å¤§æŒ‡æ•¸")
async def admin_update_indices(
    admin: User = Depends(get_admin_user),
):
    """
    ç®¡ç†å“¡æ‰‹å‹•è§¸ç™¼å››å¤§æŒ‡æ•¸æ›´æ–°
    """
    from app.services.index_service import update_all_indices
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} è§¸ç™¼å››å¤§æŒ‡æ•¸æ›´æ–°")
    
    try:
        result = update_all_indices()
        return {
            "success": True,
            "message": "å››å¤§æŒ‡æ•¸å·²æ›´æ–°",
            "updated": result.get("updated", 0),
            "errors": result.get("errors", []),
        }
    except Exception as e:
        logger.error(f"å››å¤§æŒ‡æ•¸æ›´æ–°å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/update-price-cache", summary="æ›´æ–°åƒ¹æ ¼å¿«å–")
async def admin_update_price_cache(
    admin: User = Depends(get_admin_user),
):
    """
    ç®¡ç†å“¡æ‰‹å‹•è§¸ç™¼è¿½è¹¤æ¸…å–®åƒ¹æ ¼å¿«å–æ›´æ–°
    """
    from app.database import SyncSessionLocal
    from app.services.price_cache_service import PriceCacheService
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} è§¸ç™¼åƒ¹æ ¼å¿«å–æ›´æ–°")
    
    try:
        sync_db = SyncSessionLocal()
        try:
            service = PriceCacheService(sync_db)
            result = service.update_all(force=True)
            return {
                "success": True,
                "message": "åƒ¹æ ¼å¿«å–å·²æ›´æ–°",
                "total_updated": result.get("total_updated", 0),
                "errors": result.get("errors", []),
            }
        finally:
            sync_db.close()
    except Exception as e:
        logger.error(f"åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/auth.py  â­â­â­
> èªè­‰ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
èªè­‰ API è·¯ç”±
LINE Login æ•´åˆ
"""
from fastapi import APIRouter, Depends, HTTPException, Query, Request, BackgroundTasks
from fastapi.responses import RedirectResponse
from sqlalchemy.ext.asyncio import AsyncSession
import secrets
import hashlib
import hmac
import time
import urllib.parse
import logging

from app.database import get_async_session
from app.services.auth_service import AuthService
from app.schemas.schemas import LoginResponse, UserResponse, ErrorResponse
from app.config import settings

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/auth", tags=["èªè­‰"])

# ç‰ˆæœ¬æ¨™è­˜
AUTH_VERSION = "2.1.0-admin-update"


# ============================================================
# ğŸ†• ç®¡ç†å“¡ç™»å…¥è‡ªå‹•æ›´æ–°
# ============================================================

async def trigger_admin_updates():
    """
    ç®¡ç†å“¡ç™»å…¥è§¸ç™¼çš„èƒŒæ™¯æ›´æ–°
    - æ›´æ–°æ‰€æœ‰è¿½è¹¤è‚¡ç¥¨åƒ¹æ ¼
    - æ›´æ–°å¸‚å ´æƒ…ç·’æŒ‡æ•¸
    """
    from app.database import SessionLocal
    
    logger.info("ğŸ”„ ç®¡ç†å“¡ç™»å…¥ï¼Œè§¸ç™¼è‡ªå‹•æ›´æ–°...")
    
    try:
        db = SessionLocal()
        
        # 1. æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼å¿«å–
        try:
            from app.services.price_cache_service import PriceCacheService
            cache_service = PriceCacheService(db)
            result = cache_service.update_all_prices()
            logger.info(f"âœ… è‚¡ç¥¨åƒ¹æ ¼æ›´æ–°å®Œæˆ: {result}")
        except Exception as e:
            logger.error(f"âŒ è‚¡ç¥¨åƒ¹æ ¼æ›´æ–°å¤±æ•—: {e}")
        
        # 2. æ›´æ–°å¸‚å ´æƒ…ç·’
        try:
            from app.services.market_service import market_service
            market_service.update_fear_greed()
            logger.info("âœ… å¸‚å ´æƒ…ç·’æ›´æ–°å®Œæˆ")
        except Exception as e:
            logger.error(f"âŒ å¸‚å ´æƒ…ç·’æ›´æ–°å¤±æ•—: {e}")
        
        # 3. æŠ“å–è¨‚é–±ç²¾é¸ï¼ˆå¦‚æœæœ‰ï¼‰
        try:
            from app.services.subscription_service import SubscriptionService
            sub_service = SubscriptionService(db)
            sub_result = sub_service.fetch_all_sources(backfill=False)
            logger.info(f"âœ… è¨‚é–±ç²¾é¸æ›´æ–°å®Œæˆ: {sub_result}")
        except Exception as e:
            logger.warning(f"âš ï¸ è¨‚é–±ç²¾é¸æ›´æ–°è·³é: {e}")
        
        db.close()
        logger.info("ğŸ‰ ç®¡ç†å“¡è‡ªå‹•æ›´æ–°å…¨éƒ¨å®Œæˆ")
        
    except Exception as e:
        logger.error(f"âŒ ç®¡ç†å“¡è‡ªå‹•æ›´æ–°å¤±æ•—: {e}")


@router.get("/version", summary="èªè­‰æ¨¡çµ„ç‰ˆæœ¬")
async def auth_version():
    """å›å‚³èªè­‰æ¨¡çµ„ç‰ˆæœ¬ï¼Œç”¨æ–¼ç¢ºèªéƒ¨ç½²"""
    return {
        "auth_version": AUTH_VERSION,
        "state_method": "HMAC",
        "jwt_key_set": bool(settings.JWT_SECRET_KEY and settings.JWT_SECRET_KEY != "your-secret-key-change-in-production"),
        "admin_auto_update": True,  # ğŸ†•
    }


def create_state_token() -> str:
    """å»ºç«‹ state token (HMAC ç°½åï¼Œæœ‰æ•ˆæœŸ 10 åˆ†é˜)"""
    # æ ¼å¼: timestamp.nonce.signature
    timestamp = str(int(time.time()))
    nonce = secrets.token_hex(8)  # 16 å­—å…ƒ

    # ç°½å
    message = f"{timestamp}.{nonce}"
    signature = hmac.new(
        settings.JWT_SECRET_KEY.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()[:16]  # åªå–å‰ 16 å­—å…ƒ

    state = f"{timestamp}.{nonce}.{signature}"
    logger.info(f"Created state: {state}")
    return state


def verify_state_token(state: str) -> bool:
    """é©—è­‰ state token"""
    logger.info(f"Verifying state: {state}")
    try:
        parts = state.split(".")
        logger.info(f"State parts count: {len(parts)}")

        if len(parts) != 3:
            logger.warning(f"Invalid state format, expected 3 parts, got {len(parts)}")
            return False

        timestamp, nonce, signature = parts
        logger.info(f"timestamp={timestamp}, nonce={nonce}, signature={signature}")

        # æª¢æŸ¥æ˜¯å¦éæœŸ (10 åˆ†é˜)
        time_diff = int(time.time()) - int(timestamp)
        logger.info(f"Time difference: {time_diff} seconds")
        if time_diff > 600:
            logger.warning(f"State expired, time_diff={time_diff}")
            return False

        # é©—è­‰ç°½å
        message = f"{timestamp}.{nonce}"
        expected_signature = hmac.new(
            settings.JWT_SECRET_KEY.encode(),
            message.encode(),
            hashlib.sha256
        ).hexdigest()[:16]

        logger.info(f"Expected signature: {expected_signature}")
        result = hmac.compare_digest(signature, expected_signature)
        logger.info(f"Signature match: {result}")

        return result
    except Exception as e:
        logger.error(f"State verification error: {e}")
        return False


@router.get("/line", summary="LINE ç™»å…¥")
async def line_login():
    """
    å°å‘ LINE ç™»å…¥æˆæ¬Šé é¢
    """
    if not settings.LINE_LOGIN_CHANNEL_ID:
        raise HTTPException(
            status_code=500,
            detail="LINE Login å°šæœªè¨­å®š"
        )

    # ç”¢ç”Ÿ state
    state = create_state_token()

    # URL encode callback URL
    callback_url = urllib.parse.quote(settings.LINE_LOGIN_CALLBACK_URL, safe='')

    # å»ºç«‹æˆæ¬Š URL
    auth_url = (
        "https://access.line.me/oauth2/v2.1/authorize"
        f"?response_type=code"
        f"&client_id={settings.LINE_LOGIN_CHANNEL_ID}"
        f"&redirect_uri={callback_url}"
        f"&state={state}"
        f"&scope=profile%20openid%20email"
    )

    logger.info(f"Redirecting to LINE with state: {state}")

    return RedirectResponse(url=auth_url)


@router.get("/line/callback", summary="LINE ç™»å…¥å›èª¿")
async def line_callback(
    request: Request,
    background_tasks: BackgroundTasks,  # ğŸ†• åŠ å…¥ BackgroundTasks
    code: str = Query(..., description="æˆæ¬Šç¢¼"),
    state: str = Query(..., description="State"),
    db: AsyncSession = Depends(get_async_session),
):
    """
    LINE ç™»å…¥å›èª¿è™•ç†
    
    - é©—è­‰ state
    - ç”¨ code æ›å– access token
    - å–å¾—ç”¨æˆ¶è³‡æ–™
    - å»ºç«‹/æ›´æ–°ç”¨æˆ¶
    - ğŸ†• ç®¡ç†å“¡ç™»å…¥æ™‚è§¸ç™¼èƒŒæ™¯æ›´æ–°
    - å›å‚³ HTML é é¢å„²å­˜ Token ä¸¦è·³è½‰
    """
    from fastapi.responses import HTMLResponse

    # é©—è­‰ state (ä½¿ç”¨ JWT é©—è­‰)
    if not verify_state_token(state):
        raise HTTPException(
            status_code=400,
            detail="Invalid state"
        )

    # å–å¾—å®¢æˆ¶ç«¯è³‡è¨Š
    client_ip = request.client.host if request.client else None
    user_agent = request.headers.get("user-agent")

    # åŸ·è¡Œç™»å…¥æµç¨‹
    auth_service = AuthService(db)
    result = await auth_service.login_with_line(code, client_ip, user_agent)

    if not result:
        # å¯èƒ½æ˜¯è¢«å°é–çš„ç”¨æˆ¶
        html_content = """
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
            <style>
                body {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                .card {
                    background: white;
                    padding: 3rem;
                    border-radius: 1rem;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    text-align: center;
                }
                h2 { color: #dc2626; margin: 0 0 1rem; }
                p { color: #64748b; margin: 0; }
                a { color: #3b82f6; }
            </style>
        </head>
        <body>
            <div class="card">
                <h2>âš ï¸ ç™»å…¥å¤±æ•—</h2>
                <p>æ‚¨çš„å¸³è™Ÿå·²è¢«åœç”¨æˆ–ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤</p>
                <p style="margin-top: 1rem;"><a href="/static/index.html">è¿”å›é¦–é </a></p>
            </div>
        </body>
        </html>
        """
        return HTMLResponse(content=html_content, status_code=403)

    # å›å‚³ HTML é é¢ï¼Œå°‡ Token å­˜å…¥ localStorage ä¸¦è·³è½‰åˆ°å„€è¡¨æ¿
    token = result["token"]
    user = result["user"]

    # è¨˜éŒ„ç™»å…¥æˆåŠŸçš„ log
    logger.info(f"=== ç™»å…¥æˆåŠŸï¼Œæº–å‚™è·³è½‰ ===")
    logger.info(f"ç”¨æˆ¶ ID: {user.id}, LINE ID: {user.line_user_id}, åç¨±: {user.display_name}")

    # ğŸ†• ç®¡ç†å“¡ç™»å…¥è§¸ç™¼è‡ªå‹•æ›´æ–°
    is_admin = getattr(user, 'is_admin', False)
    if is_admin:
        logger.info(f"ğŸ”‘ ç®¡ç†å“¡ {user.display_name} ç™»å…¥ï¼Œè§¸ç™¼èƒŒæ™¯æ›´æ–°")
        background_tasks.add_task(trigger_admin_updates)

    html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
        <style>
            body {{
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }}
            .card {{
                background: white;
                padding: 3rem;
                border-radius: 1rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                text-align: center;
            }}
            .logo {{
                background-color: #FA7A35;
                color: white;
                font-weight: bold;
                font-size: 1.5rem;
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                display: inline-block;
                margin-bottom: 1.5rem;
            }}
            .spinner {{
                width: 50px;
                height: 50px;
                border: 4px solid #e2e8f0;
                border-top: 4px solid #FA7A35;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 1.5rem;
            }}
            @keyframes spin {{
                0% {{ transform: rotate(0deg); }}
                100% {{ transform: rotate(360deg); }}
            }}
            h2 {{ color: #1e293b; margin: 0 0 0.5rem; }}
            p {{ color: #64748b; margin: 0; }}
            .admin-badge {{
                background: #fef3c7;
                color: #92400e;
                padding: 0.25rem 0.75rem;
                border-radius: 1rem;
                font-size: 0.75rem;
                margin-top: 0.5rem;
                display: inline-block;
            }}
        </style>
    </head>
    <body>
        <div class="card">
            <div class="logo">SELA</div>
            <div class="spinner"></div>
            <h2>ç™»å…¥æˆåŠŸï¼</h2>
            <p>æ­¡è¿å›ä¾†ï¼Œ{user.display_name}</p>
            {'<div class="admin-badge">ğŸ”„ ç®¡ç†å“¡æ¨¡å¼ - æ­£åœ¨èƒŒæ™¯æ›´æ–°æ•¸æ“š</div>' if is_admin else ''}
        </div>
        <script>
            // â˜…â˜…â˜… é‡è¦ï¼šå…ˆæ¸…é™¤æ‰€æœ‰èˆŠè³‡æ–™ï¼Œé¿å… A ç”¨æˆ¶çœ‹åˆ° B ç”¨æˆ¶çš„è³‡æ–™ â˜…â˜…â˜…
            localStorage.clear();
            sessionStorage.clear();
            
            // è¨­å®šæ–°çš„ç”¨æˆ¶è³‡æ–™
            localStorage.setItem('token', '{token}');
            localStorage.setItem('user', JSON.stringify({{
                id: {user.id},
                display_name: "{user.display_name}",
                picture_url: "{user.picture_url or ''}",
                line_user_id: "{user.line_user_id}",
                is_admin: {'true' if is_admin else 'false'}
            }}));
            localStorage.setItem('login_time', new Date().toISOString());
            
            console.log('ç™»å…¥æˆåŠŸ: ç”¨æˆ¶ ID = {user.id}, LINE ID = {user.line_user_id}, ç®¡ç†å“¡ = {str(is_admin).lower()}');
            
            setTimeout(function() {{
                window.location.href = '/static/dashboard.html';
            }}, 1500);
        </script>
    </body>
    </html>
    """

    return HTMLResponse(content=html_content)


@router.post("/logout", summary="ç™»å‡º")
async def logout():
    """
    ç™»å‡ºï¼ˆå‰ç«¯æ¸…é™¤ Token å³å¯ï¼‰
    """
    return {"success": True, "message": "å·²ç™»å‡º"}


@router.get("/me", summary="å–å¾—ç•¶å‰ç”¨æˆ¶", response_model=UserResponse)
async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç•¶å‰ç™»å…¥ç”¨æˆ¶è³‡è¨Š
    
    éœ€è¦åœ¨ Header å¸¶å…¥ Authorization: Bearer {token}
    """
    # å¾ Header å–å¾— Token
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )

    token = auth_header.split(" ")[1]

    # é©—è­‰ Token ä¸¦å–å¾—ç”¨æˆ¶
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)

    if not user:
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )

    return UserResponse.model_validate(user)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/compare.py  â­â­â­
> å ±é…¬ç‡æ¯”è¼ƒ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å ±é…¬ç‡æ¯”è¼ƒ API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
"""
from typing import List, Optional
from datetime import datetime

from fastapi import APIRouter, Depends, HTTPException, Query, Request
from pydantic import BaseModel, Field
from sqlalchemy.ext.asyncio import AsyncSession
import logging

from app.database import get_async_session
from app.services.compare_service import compare_service, ComparisonCRUD
from app.models.user import User

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_current_user, get_optional_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/compare", tags=["Compare"])


# ==================== Schemas ====================

class CompareRequest(BaseModel):
    """æ¯”è¼ƒè«‹æ±‚"""
    symbols: List[str] = Field(..., min_length=1, max_length=5, description="æ¨™çš„ä»£è™Ÿåˆ—è¡¨")
    periods: List[str] = Field(default=["1y", "3y", "5y", "10y"], description="æ™‚é–“é€±æœŸ")
    custom_range: Optional[dict] = Field(default=None, description="è‡ªè¨‚å€é–“ {start, end}")
    benchmark: str = Field(default="^GSPC", description="åŸºæº–æŒ‡æ•¸")
    sort_by: str = Field(default="5y", description="æ’åºä¾æ“š")
    sort_order: str = Field(default="desc", pattern="^(asc|desc)$", description="æ’åºæ–¹å‘")


class SaveComparisonRequest(BaseModel):
    """å„²å­˜æ¯”è¼ƒçµ„åˆè«‹æ±‚"""
    name: str = Field(..., min_length=1, max_length=100, description="çµ„åˆåç¨±")
    symbols: List[str] = Field(..., min_length=1, max_length=5, description="æ¨™çš„ä»£è™Ÿåˆ—è¡¨")
    benchmark: str = Field(default="^GSPC", description="åŸºæº–æŒ‡æ•¸")


class UpdateComparisonRequest(BaseModel):
    """æ›´æ–°æ¯”è¼ƒçµ„åˆè«‹æ±‚"""
    name: Optional[str] = Field(default=None, max_length=100)
    symbols: Optional[List[str]] = Field(default=None, max_length=5)
    benchmark: Optional[str] = Field(default=None)


# ==================== å…¬é–‹ API ====================

@router.post("/cagr", summary="è¨ˆç®—å¹´åŒ–å ±é…¬ç‡æ¯”è¼ƒ")
async def compare_cagr(request: CompareRequest):
    """
    æ¯”è¼ƒå¤šå€‹æ¨™çš„çš„å¹´åŒ–å ±é…¬ç‡ (CAGR)
    
    - æ”¯æ´è‚¡ç¥¨ã€åŠ å¯†è²¨å¹£ã€æŒ‡æ•¸æ··åˆæ¯”è¼ƒ
    - æœ€å¤š 5 å€‹æ¨™çš„
    - å¯é¸æ™‚é–“é€±æœŸï¼š1å¹´ã€3å¹´ã€5å¹´ã€10å¹´ã€è‡ªè¨‚å€é–“
    """
    result = await compare_service.compare_cagr(
        symbols=request.symbols,
        periods=request.periods,
        custom_range=request.custom_range,
        benchmark=request.benchmark,
        sort_by=request.sort_by,
        sort_order=request.sort_order,
    )
    
    if not result.get("success"):
        raise HTTPException(status_code=400, detail=result.get("error", "æ¯”è¼ƒå¤±æ•—"))
    
    return result


@router.get("/presets", summary="å–å¾—é è¨­çµ„åˆåˆ—è¡¨")
async def get_presets():
    """å–å¾—æ‰€æœ‰é è¨­æ¯”è¼ƒçµ„åˆ"""
    presets = compare_service.get_presets()
    return {
        "success": True,
        "presets": presets,
    }


@router.get("/presets/{preset_id}", summary="å–å¾—é è¨­çµ„åˆè©³æƒ…")
async def get_preset_detail(preset_id: str):
    """å–å¾—é è¨­çµ„åˆçš„è©³ç´°å…§å®¹"""
    preset = compare_service.get_preset_detail(preset_id)
    
    if not preset:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²é è¨­çµ„åˆ")
    
    return {
        "success": True,
        "preset": preset,
    }


@router.get("/benchmarks", summary="å–å¾—åŸºæº–æŒ‡æ•¸é¸é …")
async def get_benchmarks():
    """å–å¾—å¯ç”¨çš„åŸºæº–æŒ‡æ•¸é¸é …"""
    benchmarks = compare_service.get_benchmark_options()
    return {
        "success": True,
        "benchmarks": [
            {"symbol": k, "name": v}
            for k, v in benchmarks.items()
        ],
    }


# ==================== ç”¨æˆ¶å„²å­˜çš„çµ„åˆ API ====================

@router.get("/saved", summary="å–å¾—æˆ‘çš„æ¯”è¼ƒçµ„åˆ")
async def get_saved_comparisons(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç•¶å‰ç”¨æˆ¶å„²å­˜çš„æ‰€æœ‰æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    comparisons = await crud.get_user_comparisons(user.id)
    
    return {
        "success": True,
        "comparisons": [c.to_dict() for c in comparisons],
    }


@router.post("/saved", summary="å„²å­˜æ¯”è¼ƒçµ„åˆ")
async def save_comparison(
    request: SaveComparisonRequest,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å„²å­˜æ–°çš„æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    
    # æª¢æŸ¥ç”¨æˆ¶å·²æœ‰çš„çµ„åˆæ•¸é‡ï¼ˆé™åˆ¶æœ€å¤š 10 å€‹ï¼‰
    existing = await crud.get_user_comparisons(user.id)
    if len(existing) >= 10:
        raise HTTPException(status_code=400, detail="æœ€å¤šåªèƒ½å„²å­˜ 10 å€‹æ¯”è¼ƒçµ„åˆ")
    
    # æ­£è¦åŒ– symbols
    symbols = [s.upper().strip() for s in request.symbols]
    
    comparison = await crud.create_comparison(
        user_id=user.id,
        name=request.name,
        symbols=symbols,
        benchmark=request.benchmark,
    )
    
    return {
        "success": True,
        "message": "æ¯”è¼ƒçµ„åˆå·²å„²å­˜",
        "comparison": comparison.to_dict(),
    }


@router.get("/saved/{comparison_id}", summary="å–å¾—å–®ä¸€æ¯”è¼ƒçµ„åˆ")
async def get_saved_comparison(
    comparison_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—å–®ä¸€æ¯”è¼ƒçµ„åˆè©³æƒ…"""
    crud = ComparisonCRUD(db)
    comparison = await crud.get_comparison(comparison_id, user.id)
    
    if not comparison:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²æ¯”è¼ƒçµ„åˆ")
    
    return {
        "success": True,
        "comparison": comparison.to_dict(),
    }


@router.put("/saved/{comparison_id}", summary="æ›´æ–°æ¯”è¼ƒçµ„åˆ")
async def update_saved_comparison(
    comparison_id: int,
    request: UpdateComparisonRequest,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ›´æ–°å„²å­˜çš„æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    
    # æ­£è¦åŒ– symbols
    symbols = None
    if request.symbols:
        symbols = [s.upper().strip() for s in request.symbols]
    
    comparison = await crud.update_comparison(
        comparison_id=comparison_id,
        user_id=user.id,
        name=request.name,
        symbols=symbols,
        benchmark=request.benchmark,
    )
    
    if not comparison:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²æ¯”è¼ƒçµ„åˆ")
    
    return {
        "success": True,
        "message": "æ¯”è¼ƒçµ„åˆå·²æ›´æ–°",
        "comparison": comparison.to_dict(),
    }


@router.delete("/saved/{comparison_id}", summary="åˆªé™¤æ¯”è¼ƒçµ„åˆ")
async def delete_saved_comparison(
    comparison_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤å„²å­˜çš„æ¯”è¼ƒçµ„åˆ"""
    crud = ComparisonCRUD(db)
    deleted = await crud.delete_comparison(comparison_id, user.id)
    
    if not deleted:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²æ¯”è¼ƒçµ„åˆ")
    
    return {
        "success": True,
        "message": "æ¯”è¼ƒçµ„åˆå·²åˆªé™¤",
    }


# ==================== å¿«é€Ÿæ¯”è¼ƒ (çµåˆ preset + è¨ˆç®—) ====================

@router.get("/quick/{preset_id}", summary="å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ")
async def quick_compare_preset(
    preset_id: str,
    benchmark: str = Query(default="^GSPC", description="åŸºæº–æŒ‡æ•¸"),
    sort_by: str = Query(default="5y", description="æ’åºä¾æ“š"),
):
    """
    å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ
    ç›´æ¥è¼‰å…¥é è¨­çµ„åˆä¸¦è¨ˆç®— CAGR
    """
    preset = compare_service.get_preset_detail(preset_id)
    
    if not preset:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²é è¨­çµ„åˆ")
    
    result = await compare_service.compare_cagr(
        symbols=preset["symbols"],
        periods=["1y", "3y", "5y", "10y"],
        benchmark=benchmark,
        sort_by=sort_by,
        sort_order="desc",
    )
    
    result["preset"] = preset
    return result
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/crypto.py  â­â­â­
> åŠ å¯†è²¨å¹£å’Œå¸‚å ´æƒ…ç·’ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŠ å¯†è²¨å¹£å’Œå¸‚å ´æƒ…ç·’ API è·¯ç”±
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import FileResponse
import pandas as pd
import logging

from app.schemas.schemas import MarketSentimentResponse

router = APIRouter(tags=["åŠ å¯†è²¨å¹£"])
logger = logging.getLogger(__name__)

# åŠ å¯†è²¨å¹£å°æ‡‰çš„ Yahoo Finance ä»£è™Ÿ
CRYPTO_YAHOO_MAP = {
    "BTC": "BTC-USD",
    "ETH": "ETH-USD",
    "BITCOIN": "BTC-USD",
    "ETHEREUM": "ETH-USD",
}


@router.get("/api/crypto/{symbol}", summary="æŸ¥è©¢åŠ å¯†è²¨å¹£")
async def get_crypto_analysis(
    symbol: str,
    refresh: bool = Query(False, description="æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™"),
):
    """
    æŸ¥è©¢å–®ä¸€åŠ å¯†è²¨å¹£çš„æŠ€è¡“åˆ†æå ±å‘Š
    
    - **symbol**: åŠ å¯†è²¨å¹£ä»£è™Ÿ (BTC, ETH)
    - **refresh**: æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™
    """
    from app.data_sources.coingecko import coingecko
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.indicator_service import indicator_service
    
    symbol = symbol.upper()
    logger.info(f"é–‹å§‹æŸ¥è©¢åŠ å¯†è²¨å¹£: {symbol}")
    
    # é©—è­‰ä»£è™Ÿ
    yahoo_symbol = CRYPTO_YAHOO_MAP.get(symbol)
    if not yahoo_symbol and not coingecko.validate_symbol(symbol):
        logger.warning(f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}")
        raise HTTPException(
            status_code=400,
            detail=f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}ï¼Œç›®å‰åƒ…æ”¯æ´ BTC å’Œ ETH"
        )
    
    df = None
    info = None
    data_source = None
    
    # å„ªå…ˆå˜—è©¦ CoinGecko
    try:
        logger.info(f"å˜—è©¦å¾ CoinGecko å–å¾— {symbol} è³‡æ–™...")
        df = coingecko.get_ohlc(symbol, days=365)
        if df is not None and not df.empty:
            info = coingecko.get_coin_info(symbol)
            data_source = "CoinGecko"
            logger.info(f"æˆåŠŸå¾ CoinGecko å–å¾— {len(df)} ç­†è³‡æ–™")
    except Exception as e:
        logger.warning(f"CoinGecko API å¤±æ•—: {e}")
    
    # å¦‚æœ CoinGecko å¤±æ•—ï¼Œä½¿ç”¨ Yahoo Finance å‚™ç”¨
    if df is None or df.empty:
        yahoo_symbol = CRYPTO_YAHOO_MAP.get(symbol, f"{symbol}-USD")
        logger.info(f"CoinGecko å¤±æ•—ï¼Œå˜—è©¦ Yahoo Finance: {yahoo_symbol}")
        
        try:
            df = yahoo_finance.get_stock_history(yahoo_symbol, period="1y")
            if df is not None and not df.empty:
                data_source = "Yahoo Finance"
                logger.info(f"æˆåŠŸå¾ Yahoo Finance å–å¾— {len(df)} ç­†è³‡æ–™")
                # å¾ Yahoo Finance å–å¾—åŸºæœ¬è³‡è¨Š
                try:
                    yf_info = yahoo_finance.get_stock_info(yahoo_symbol)
                    if yf_info:
                        info = {
                            "name": yf_info.get("shortName") or yf_info.get("name") or symbol,
                            "market_cap": yf_info.get("market_cap") or yf_info.get("marketCap"),
                            "total_volume": yf_info.get("total_volume"),
                        }
                except Exception as e:
                    logger.warning(f"å–å¾— Yahoo Finance info å¤±æ•—: {e}")
                    info = {"name": symbol}
        except Exception as e:
            logger.error(f"Yahoo Finance ä¹Ÿå¤±æ•—: {e}")
    
    # å¦‚æœå…©å€‹éƒ½å¤±æ•—
    if df is None or df.empty:
        raise HTTPException(
            status_code=503,
            detail=f"ç„¡æ³•å–å¾— {symbol} è³‡æ–™ã€‚CoinGecko å’Œ Yahoo Finance éƒ½ç„¡æ³•é€£æ¥ã€‚è«‹ç¨å¾Œå†è©¦ã€‚"
        )
    
    logger.info(f"ä½¿ç”¨ {data_source} è³‡æ–™ï¼Œå…± {len(df)} ç­†")
    
    # ç¢ºä¿æœ‰å¿…è¦çš„æ¬„ä½ (åœ¨ try å¡Šå¤–é¢å…ˆè™•ç†)
    if 'volume' not in df.columns:
        df['volume'] = 0
        logger.warning(f"{symbol} æ²’æœ‰ volume è³‡æ–™ï¼Œå·²å¡«å…¥ 0")
    
    # ç¢ºä¿ volume ä¸æ˜¯ None æˆ– NaN
    df['volume'] = df['volume'].fillna(0).astype(float)
    
    try:
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        df = indicator_service.calculate_all_indicators(df)
        
        # å–å¾—æœ€æ–°è³‡æ–™
        latest = df.iloc[-1]
        current_price = float(latest['close'])
        
        # æ¼²è·Œå¹…è¨ˆç®—
        def calc_change(days):
            try:
                if len(df) > days:
                    old_price = float(df.iloc[-days-1]['close'])
                    return round((current_price - old_price) / old_price * 100, 2)
            except:
                pass
            return None
        
        # å‡ç·šè³‡è¨Š (åŠ å¯†è²¨å¹£ç”¨ MA7/25/99)
        ma7 = float(df['close'].tail(7).mean()) if len(df) >= 7 else None
        ma25 = float(df['close'].tail(25).mean()) if len(df) >= 25 else None
        ma99 = float(df['close'].tail(99).mean()) if len(df) >= 99 else None
        
        # åˆ¤æ–·å‡ç·šæ’åˆ—
        alignment = "neutral"
        if ma7 and ma25 and ma99:
            if current_price > ma7 > ma25 > ma99:
                alignment = "bullish"
            elif current_price < ma7 < ma25 < ma99:
                alignment = "bearish"
        
        # RSI (å°å¯«: rsi)
        rsi_value = float(latest.get('rsi', 50)) if 'rsi' in latest else 50
        rsi_status = "overbought" if rsi_value > 70 else "oversold" if rsi_value < 30 else "neutral"
        
        # MACD (å°å¯«: macd_dif, macd_dea)
        macd_dif = float(latest.get('macd_dif', 0)) if 'macd_dif' in latest else 0
        macd_dea = float(latest.get('macd_dea', 0)) if 'macd_dea' in latest else 0
        macd_status = "bullish" if macd_dif > macd_dea else "bearish"
        
        # ç¶œåˆè©•åˆ†
        buy_score = 0
        sell_score = 0
        
        if alignment == "bullish":
            buy_score += 1
        elif alignment == "bearish":
            sell_score += 1
        
        if rsi_value < 30:
            buy_score += 1
        elif rsi_value > 70:
            sell_score += 1
        
        if macd_status == "bullish":
            buy_score += 1
        else:
            sell_score += 1
        
        rating = "bullish" if buy_score > sell_score else "bearish" if sell_score > buy_score else "neutral"
        
        return {
            "success": True,
            "symbol": symbol,
            "name": info.get("name", symbol) if info else symbol,
            "asset_type": "crypto",
            "price": {
                "current": current_price,
                "ath": info.get("ath") if info else None,
                "from_ath_pct": info.get("ath_change_percentage") if info else None,
            },
            "change": {
                "day": calc_change(1),
                "week": calc_change(7),
                "month": calc_change(30),
                "year": calc_change(365),
            },
            "market": {
                "market_cap": info.get("market_cap") if info else None,
                "market_cap_rank": info.get("market_cap_rank") if info else None,
                "volume_24h": info.get("total_volume") if info else None,
            },
            "indicators": {
                "ma": {
                    "ma7": ma7,
                    "ma25": ma25,
                    "ma99": ma99,
                    "alignment": alignment,
                    "price_vs_ma7": "above" if ma7 and current_price > ma7 else "below",
                    "price_vs_ma25": "above" if ma25 and current_price > ma25 else "below",
                    "price_vs_ma99": "above" if ma99 and current_price > ma99 else "below",
                },
                "rsi": {
                    "value": rsi_value,
                    "period": 14,
                    "status": rsi_status,
                },
                "macd": {
                    "dif": macd_dif,
                    "macd": macd_dea,
                    "status": macd_status,
                },
            },
            "score": {
                "buy": buy_score,
                "sell": sell_score,
                "rating": rating,
            },
            "chart_data": {
                "dates": [str(d) for d in df['date'].tail(365).tolist()] if 'date' in df.columns else [],
                "prices": [float(p) for p in df['close'].tail(365).tolist()] if 'close' in df.columns else [],
                "ma20": [float(v) if not pd.isna(v) else None for v in df['ma20'].tail(365).tolist()] if 'ma20' in df.columns else [],
                "ma50": [float(v) if not pd.isna(v) else None for v in df['ma50'].tail(365).tolist()] if 'ma50' in df.columns else [],
                "ma200": [float(v) if not pd.isna(v) else None for v in df['ma200'].tail(365).tolist()] if 'ma200' in df.columns else [],
                "ma250": [float(v) if not pd.isna(v) else None for v in df['ma250'].tail(365).tolist()] if 'ma250' in df.columns else [],
            },
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æŸ¥è©¢ {symbol} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"æŸ¥è©¢å¤±æ•—: {str(e)}"
        )


@router.get("/api/crypto/{symbol}/chart", summary="å–å¾—åŠ å¯†è²¨å¹£åœ–è¡¨")
async def get_crypto_chart(
    symbol: str,
    days: int = Query(120, ge=30, le=365, description="é¡¯ç¤ºå¤©æ•¸"),
):
    """
    ç”ŸæˆåŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æåœ–è¡¨
    
    - **symbol**: åŠ å¯†è²¨å¹£ä»£è™Ÿ (BTC, ETH)
    - **days**: é¡¯ç¤ºå¤©æ•¸ (30-365)
    
    å›å‚³ PNG åœ–ç‰‡
    """
    from app.data_sources.coingecko import coingecko
    from app.services.chart_service import chart_service
    
    symbol = symbol.upper()
    
    df = coingecko.get_ohlc(symbol, days=days)
    
    if df is None or df.empty:
        raise HTTPException(
            status_code=404,
            detail=f"æ‰¾ä¸åˆ°åŠ å¯†è²¨å¹£: {symbol}"
        )
    
    # å–å¾—åç¨±
    info = coingecko.get_coin_info(symbol)
    name = info.get("name", "") if info else ""
    
    # ç”Ÿæˆåœ–è¡¨
    chart_path = chart_service.plot_stock_analysis(
        df,
        symbol=symbol,
        name=name,
        days=days,
        show_kd=False,
    )
    
    return FileResponse(
        chart_path,
        media_type="image/png",
        filename=f"{symbol}_chart.png",
    )


@router.get("/api/market/sentiment", summary="å–å¾—å¸‚å ´æƒ…ç·’", response_model=MarketSentimentResponse)
async def get_market_sentiment(
    market: str = Query("all", description="å¸‚å ´é¡å‹ (stock, crypto, all)"),
):
    """
    å–å¾—å¸‚å ´æƒ…ç·’æŒ‡æ•¸
    
    - **market**: å¸‚å ´é¡å‹
      - `stock`: ç¾è‚¡ CNN Fear & Greed Index
      - `crypto`: åŠ å¯†è²¨å¹£ Alternative.me
      - `all`: å…©è€…éƒ½å–å¾—
    
    æƒ…ç·’æŒ‡æ•¸ç¯„åœ 0-100ï¼š
    - 0-25: æ¥µåº¦ææ‡¼
    - 26-45: ææ‡¼
    - 46-55: ä¸­æ€§
    - 56-75: è²ªå©ª
    - 76-100: æ¥µåº¦è²ªå©ª
    """
    from app.data_sources.fear_greed import fear_greed
    
    result = {}
    
    if market in ("all", "stock"):
        stock_sentiment = fear_greed.get_stock_fear_greed()
        if stock_sentiment:
            result["stock"] = stock_sentiment
    
    if market in ("all", "crypto"):
        crypto_sentiment = fear_greed.get_crypto_fear_greed()
        if crypto_sentiment:
            result["crypto"] = crypto_sentiment
    
    return MarketSentimentResponse(
        success=True,
        stock=result.get("stock"),
        crypto=result.get("crypto"),
    )
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/market.py  â­â­â­
> å¸‚å ´è³‡æ–™ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´è³‡æ–™ API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
"""
from fastapi import APIRouter, Depends, HTTPException, Query, Request
from sqlalchemy.orm import Session
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional
import logging

from app.database import get_db, get_async_session
from app.services.market_service import MarketService
from app.tasks.scheduler import scheduler_service
from app.models.index_price import INDEX_SYMBOLS

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_optional_user, get_admin_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/market", tags=["market"])


# ==================== ä¸‰å¤§æŒ‡æ•¸ ====================

@router.get("/indices")
async def get_indices(
    db: Session = Depends(get_db),
):
    """
    å–å¾—ä¸‰å¤§æŒ‡æ•¸æœ€æ–°è³‡æ–™
    
    Returns:
        - S&P 500 (^GSPC)
        - é“ç“Šå·¥æ¥­ (^DJI)
        - ç´æ–¯é”å…‹ (^IXIC)
    """
    try:
        market_service = MarketService(db)
        indices = market_service.get_latest_indices()
        
        return {
            "success": True,
            "data": {
                "indices": indices,
                "symbols": INDEX_SYMBOLS,
            }
        }
    except Exception as e:
        logger.error(f"å–å¾—æŒ‡æ•¸å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/indices/{symbol}/history")
async def get_index_history(
    symbol: str,
    days: int = Query(default=365, ge=1, le=3650),
    db: Session = Depends(get_db),
):
    """
    å–å¾—æŒ‡æ•¸æ­·å²è³‡æ–™
    
    Args:
        symbol: æŒ‡æ•¸ä»£è™Ÿ (^GSPC, ^DJI, ^IXIC)
        days: å¤©æ•¸ (é è¨­ 365ï¼Œæœ€å¤š 3650)
    """
    # é©—è­‰ symbol
    if symbol not in INDEX_SYMBOLS:
        raise HTTPException(
            status_code=400,
            detail=f"ç„¡æ•ˆçš„æŒ‡æ•¸ä»£è™Ÿï¼Œå¯ç”¨: {list(INDEX_SYMBOLS.keys())}"
        )
    
    try:
        market_service = MarketService(db)
        history = market_service.get_index_history(symbol, days)
        
        return {
            "success": True,
            "data": {
                "symbol": symbol,
                "name": INDEX_SYMBOLS[symbol]["name"],
                "name_zh": INDEX_SYMBOLS[symbol]["name_zh"],
                "days": days,
                "count": len(history),
                "history": history,
            }
        }
    except Exception as e:
        logger.error(f"å–å¾—æŒ‡æ•¸æ­·å²å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ==================== å¸‚å ´æƒ…ç·’ ====================

@router.get("/sentiment")
async def get_sentiment(
    db: Session = Depends(get_db),
):
    """
    å–å¾—å¸‚å ´æƒ…ç·’ï¼ˆç¾è‚¡ + å¹£åœˆï¼‰
    """
    try:
        market_service = MarketService(db)
        sentiment = market_service.get_latest_sentiment()
        
        return {
            "success": True,
            "data": sentiment,
        }
    except Exception as e:
        logger.error(f"å–å¾—æƒ…ç·’å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/sentiment/{market}/history")
async def get_sentiment_history(
    market: str,
    days: int = Query(default=365, ge=1, le=365),
    db: Session = Depends(get_db),
):
    """
    å–å¾—æƒ…ç·’æ­·å²è³‡æ–™
    
    Args:
        market: å¸‚å ´é¡å‹ (stock, crypto)
        days: å¤©æ•¸ (é è¨­ 365ï¼Œæœ€å¤š 365)
    """
    if market not in ["stock", "crypto"]:
        raise HTTPException(
            status_code=400,
            detail="ç„¡æ•ˆçš„å¸‚å ´é¡å‹ï¼Œå¯ç”¨: stock, crypto"
        )
    
    try:
        market_service = MarketService(db)
        history = market_service.get_sentiment_history(market, days)
        
        return {
            "success": True,
            "data": {
                "market": market,
                "days": days,
                "count": len(history),
                "history": history,
            }
        }
    except Exception as e:
        logger.error(f"å–å¾—æƒ…ç·’æ­·å²å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ==================== ç®¡ç†å“¡åŠŸèƒ½ï¼šæ’ç¨‹ä»»å‹™ ====================

@router.post("/admin/update")
async def trigger_daily_update(
    current_user = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] æ‰‹å‹•è§¸ç™¼æ¯æ—¥æ›´æ–°
    """
    try:
        result = scheduler_service.run_daily_update()
        
        return {
            "success": result.get("success", False),
            "data": result,
        }
    except Exception as e:
        logger.error(f"åŸ·è¡Œæ›´æ–°å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/initialize")
async def initialize_historical_data(
    years: int = Query(default=10, ge=1, le=10),
    current_user = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] åˆå§‹åŒ–æ­·å²è³‡æ–™
    
    é¦–æ¬¡éƒ¨ç½²æ™‚åŸ·è¡Œï¼ŒæŠ“å–ï¼š
    - ä¸‰å¤§æŒ‡æ•¸ N å¹´æ­·å²
    - å¹£åœˆæƒ…ç·’ 365 å¤©æ­·å²
    """
    try:
        result = scheduler_service.initialize_historical_data(years=years)
        
        return {
            "success": result.get("success", False),
            "data": result,
        }
    except Exception as e:
        logger.error(f"åˆå§‹åŒ–å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/update-indices")
async def update_indices(
    period: str = Query(default="5d", pattern="^(5d|1mo|3mo|1y|5y|10y)$"),
    current_user = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] æ›´æ–°ä¸‰å¤§æŒ‡æ•¸è³‡æ–™
    """
    try:
        market_service = MarketService(db)
        result = market_service.fetch_and_save_all_indices(period=period)
        
        return {
            "success": True,
            "data": {
                "period": period,
                "indices": result,
            }
        }
    except Exception as e:
        logger.error(f"æ›´æ–°æŒ‡æ•¸å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/update-sentiment")
async def update_sentiment(
    current_user = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] æ›´æ–°ä»Šæ—¥å¸‚å ´æƒ…ç·’
    """
    try:
        market_service = MarketService(db)
        result = market_service.update_today_sentiment()
        
        return {
            "success": True,
            "data": result,
        }
    except Exception as e:
        logger.error(f"æ›´æ–°æƒ…ç·’å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/admin/init-crypto-sentiment")
async def init_crypto_sentiment(
    days: int = Query(default=365, ge=1, le=365),
    current_user = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """
    [ç®¡ç†å“¡] åˆå§‹åŒ–å¹£åœˆæƒ…ç·’æ­·å²
    """
    try:
        market_service = MarketService(db)
        count = market_service.fetch_and_save_crypto_history(days=days)
        
        return {
            "success": True,
            "data": {
                "days_requested": days,
                "records_added": count,
            }
        }
    except Exception as e:
        logger.error(f"åˆå§‹åŒ–å¹£åœˆæƒ…ç·’å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/admin/scheduler-status")
async def get_scheduler_status(
    current_user = Depends(get_admin_user),
):
    """
    [ç®¡ç†å“¡] å–å¾—æ’ç¨‹ç‹€æ…‹
    """
    return {
        "success": True,
        "data": scheduler_service.get_status(),
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/portfolio.py  â­â­â­
> å€‹äººæŠ•è³‡è¨˜éŒ„ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å€‹äººæŠ•è³‡è¨˜éŒ„ API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
"""
from datetime import date, datetime
from typing import Optional, List
from pydantic import BaseModel, Field
import logging
import json
import csv
import io

from fastapi import APIRouter, Depends, HTTPException, Request, Query
from fastapi.responses import StreamingResponse
from sqlalchemy.ext.asyncio import AsyncSession

from app.database import get_async_session
from app.services.portfolio_service import PortfolioService
from app.services.exchange_rate_service import get_exchange_rate, set_exchange_rate
from app.models.user import User

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_current_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/portfolio", tags=["å€‹äººæŠ•è³‡è¨˜éŒ„"])


# ============================================================
# Pydantic Schemas
# ============================================================

class TransactionCreate(BaseModel):
    """æ–°å¢äº¤æ˜“è«‹æ±‚"""
    symbol: str = Field(..., min_length=1, max_length=20, description="è‚¡ç¥¨ä»£ç¢¼")
    name: Optional[str] = Field(None, max_length=100, description="è‚¡ç¥¨åç¨±")
    market: str = Field(..., pattern="^(tw|us)$", description="å¸‚å ´ (tw/us)")
    transaction_type: str = Field(..., pattern="^(buy|sell)$", description="äº¤æ˜“é¡å‹ (buy/sell)")
    quantity: int = Field(..., gt=0, description="è‚¡æ•¸ï¼ˆå°è‚¡ï¼šå¼µÃ—1000 + é›¶è‚¡ï¼‰")
    price: float = Field(..., gt=0, description="æˆäº¤åƒ¹")
    fee: Optional[float] = Field(0, ge=0, description="æ‰‹çºŒè²»")
    tax: Optional[float] = Field(0, ge=0, description="äº¤æ˜“ç¨…")
    transaction_date: date = Field(..., description="äº¤æ˜“æ—¥æœŸ")
    note: Optional[str] = Field(None, max_length=500, description="å‚™è¨»")


class TransactionUpdate(BaseModel):
    """æ›´æ–°äº¤æ˜“è«‹æ±‚"""
    symbol: Optional[str] = Field(None, min_length=1, max_length=20)
    name: Optional[str] = Field(None, max_length=100)
    market: Optional[str] = Field(None, pattern="^(tw|us)$")
    transaction_type: Optional[str] = Field(None, pattern="^(buy|sell)$")
    quantity: Optional[int] = Field(None, gt=0)
    price: Optional[float] = Field(None, gt=0)
    fee: Optional[float] = Field(None, ge=0)
    tax: Optional[float] = Field(None, ge=0)
    transaction_date: Optional[date] = None
    note: Optional[str] = Field(None, max_length=500)


class ExchangeRateUpdate(BaseModel):
    """æ›´æ–°åŒ¯ç‡è«‹æ±‚"""
    rate: float = Field(..., gt=0, description="USD/TWD åŒ¯ç‡")


class TransactionImportItem(BaseModel):
    symbol: str
    name: Optional[str] = None
    market: str = "tw"
    transaction_type: str = "buy"
    quantity: int
    price: float
    fee: Optional[float] = 0
    tax: Optional[float] = 0
    transaction_date: str  # YYYY-MM-DD format
    note: Optional[str] = None


class TransactionImportRequest(BaseModel):
    items: List[TransactionImportItem]


# ============================================================
# åŒ¯å‡ºåŒ¯å…¥ API
# ============================================================

@router.get("/export", summary="åŒ¯å‡ºäº¤æ˜“è¨˜éŒ„")
async def export_transactions(
    format: str = "json",
    market: Optional[str] = Query(None, pattern="^(tw|us)$"),
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    åŒ¯å‡ºç”¨æˆ¶çš„äº¤æ˜“è¨˜éŒ„
    
    - format: json æˆ– csv
    - market: é¸æ“‡æ€§ç¯©é¸å¸‚å ´ (tw/us)
    """
    logger.info(f"API: åŒ¯å‡ºäº¤æ˜“è¨˜éŒ„ - user_id={user.id}, format={format}, market={market}")

    try:
        service = PortfolioService(db)
        transactions = await service.get_transactions(
            user_id=user.id,
            market=market,
            limit=9999,
            offset=0,
        )

        if not transactions:
            raise HTTPException(status_code=404, detail="äº¤æ˜“è¨˜éŒ„ç‚ºç©º")

        # æº–å‚™åŒ¯å‡ºè³‡æ–™
        export_data = []
        for t in transactions:
            export_data.append({
                "symbol": t.symbol,
                "name": t.name or "",
                "market": t.market,
                "transaction_type": t.transaction_type,
                "quantity": t.quantity,
                "price": float(t.price),
                "fee": float(t.fee) if t.fee else 0,
                "tax": float(t.tax) if t.tax else 0,
                "transaction_date": t.transaction_date.isoformat() if t.transaction_date else "",
                "note": t.note or "",
            })

        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        market_suffix = f"_{market}" if market else ""

        if format.lower() == "csv":
            # CSV æ ¼å¼
            output = io.StringIO()
            fieldnames = ["symbol", "name", "market", "transaction_type", "quantity", 
                         "price", "fee", "tax", "transaction_date", "note"]
            writer = csv.DictWriter(output, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(export_data)
            
            return StreamingResponse(
                iter([output.getvalue()]),
                media_type="text/csv",
                headers={
                    "Content-Disposition": f"attachment; filename=portfolio{market_suffix}_{timestamp}.csv"
                }
            )
        else:
            # JSON æ ¼å¼
            json_str = json.dumps({
                "export_time": datetime.now().isoformat(),
                "market": market,
                "total": len(export_data),
                "items": export_data
            }, ensure_ascii=False, indent=2)
            
            return StreamingResponse(
                iter([json_str]),
                media_type="application/json",
                headers={
                    "Content-Disposition": f"attachment; filename=portfolio{market_suffix}_{timestamp}.json"
                }
            )

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"åŒ¯å‡ºäº¤æ˜“è¨˜éŒ„å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/import", summary="åŒ¯å…¥äº¤æ˜“è¨˜éŒ„")
async def import_transactions(
    data: TransactionImportRequest,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    åŒ¯å…¥äº¤æ˜“è¨˜éŒ„
    
    - é€ç­†æ–°å¢äº¤æ˜“è¨˜éŒ„
    - è¿”å›æˆåŠŸ/å¤±æ•—çš„çµ±è¨ˆ
    """
    logger.info(f"API: åŒ¯å…¥äº¤æ˜“è¨˜éŒ„ - user_id={user.id}, items={len(data.items)}")

    try:
        service = PortfolioService(db)
        added = []
        errors = []

        for item in data.items:
            try:
                # è§£ææ—¥æœŸ
                trans_date = datetime.strptime(item.transaction_date, "%Y-%m-%d").date()
                
                transaction = await service.create_transaction(
                    user_id=user.id,
                    symbol=item.symbol.upper().strip(),
                    name=item.name,
                    market=item.market,
                    transaction_type=item.transaction_type,
                    quantity=item.quantity,
                    price=item.price,
                    fee=item.fee or 0,
                    tax=item.tax or 0,
                    transaction_date=trans_date,
                    note=item.note,
                )
                added.append({
                    "id": transaction.id,
                    "symbol": transaction.symbol,
                    "transaction_type": transaction.transaction_type,
                })
            except Exception as e:
                errors.append({
                    "symbol": item.symbol,
                    "date": item.transaction_date,
                    "error": str(e)
                })

        return {
            "success": True,
            "message": f"åŒ¯å…¥å®Œæˆï¼šæˆåŠŸ {len(added)} ç­†ï¼Œå¤±æ•— {len(errors)} ç­†",
            "data": {
                "added": added,
                "errors": errors,
                "total_added": len(added),
                "total_errors": len(errors),
            }
        }

    except Exception as e:
        logger.error(f"åŒ¯å…¥äº¤æ˜“è¨˜éŒ„å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# åŒ¯ç‡ API
# ============================================================

@router.get("/exchange-rate", summary="å–å¾—åŒ¯ç‡")
async def get_rate(
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç›®å‰çš„ USD/TWD åŒ¯ç‡"""
    rate_info = await get_exchange_rate(db)
    return {
        "success": True,
        "data": rate_info,
    }


@router.put("/exchange-rate", summary="è¨­å®šåŒ¯ç‡")
async def update_rate(
    data: ExchangeRateUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ‰‹å‹•è¨­å®š USD/TWD åŒ¯ç‡"""
    rate_info = await set_exchange_rate(db, data.rate)
    return {
        "success": True,
        "message": "åŒ¯ç‡å·²æ›´æ–°",
        "data": rate_info,
    }


# ============================================================
# äº¤æ˜“ç´€éŒ„ API
# ============================================================

@router.post("/transactions", summary="æ–°å¢äº¤æ˜“ç´€éŒ„")
async def create_transaction(
    data: TransactionCreate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ–°å¢ä¸€ç­†è‚¡ç¥¨äº¤æ˜“ç´€éŒ„
    
    - **symbol**: è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ AAPLã€2330ï¼‰
    - **market**: å¸‚å ´é¡å‹ï¼ˆtw=å°è‚¡, us=ç¾è‚¡ï¼‰
    - **transaction_type**: buy=è²·å…¥, sell=è³£å‡º
    - **quantity**: ç¸½è‚¡æ•¸ï¼ˆå°è‚¡ï¼šå¼µÃ—1000 + é›¶è‚¡ï¼‰
    - **price**: æˆäº¤åƒ¹
    - **fee**: æ‰‹çºŒè²»ï¼ˆå¯é¸ï¼‰
    - **tax**: äº¤æ˜“ç¨…ï¼ˆå¯é¸ï¼Œè³£å‡ºæ™‚ï¼‰
    """
    logger.info(f"æ–°å¢äº¤æ˜“: user={user.id}, {data.transaction_type} {data.quantity} {data.symbol}")
    
    try:
        service = PortfolioService(db)
        transaction = await service.create_transaction(
            user_id=user.id,
            symbol=data.symbol,
            name=data.name,
            market=data.market,
            transaction_type=data.transaction_type,
            quantity=data.quantity,
            price=data.price,
            fee=data.fee or 0,
            tax=data.tax or 0,
            transaction_date=data.transaction_date,
            note=data.note,
        )
        
        return {
            "success": True,
            "message": "äº¤æ˜“ç´€éŒ„å·²æ–°å¢",
            "data": transaction.to_dict(),
        }
        
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        logger.error(f"æ–°å¢äº¤æ˜“å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="æ–°å¢äº¤æ˜“å¤±æ•—")


@router.get("/transactions", summary="å–å¾—äº¤æ˜“ç´€éŒ„")
async def get_transactions(
    market: Optional[str] = Query(None, pattern="^(tw|us)$", description="ç¯©é¸å¸‚å ´"),
    symbol: Optional[str] = Query(None, description="ç¯©é¸è‚¡ç¥¨"),
    limit: int = Query(100, ge=1, le=500, description="ç­†æ•¸ä¸Šé™"),
    offset: int = Query(0, ge=0, description="åç§»é‡"),
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç”¨æˆ¶çš„äº¤æ˜“ç´€éŒ„åˆ—è¡¨"""
    try:
        service = PortfolioService(db)
        transactions = await service.get_transactions(
            user_id=user.id,
            market=market,
            symbol=symbol,
            limit=limit,
            offset=offset,
        )
        
        return {
            "success": True,
            "data": [t.to_dict() for t in transactions],
            "total": len(transactions),
        }
        
    except Exception as e:
        logger.error(f"å–å¾—äº¤æ˜“ç´€éŒ„å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="å–å¾—äº¤æ˜“ç´€éŒ„å¤±æ•—")


@router.get("/transactions/{transaction_id}", summary="å–å¾—å–®ç­†äº¤æ˜“")
async def get_transaction(
    transaction_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—å–®ç­†äº¤æ˜“ç´€éŒ„è©³æƒ…"""
    service = PortfolioService(db)
    transaction = await service.get_transaction(transaction_id, user.id)
    
    if not transaction:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°äº¤æ˜“ç´€éŒ„")
    
    return {
        "success": True,
        "data": transaction.to_dict(),
    }


@router.put("/transactions/{transaction_id}", summary="æ›´æ–°äº¤æ˜“ç´€éŒ„")
async def update_transaction(
    transaction_id: int,
    data: TransactionUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ›´æ–°äº¤æ˜“ç´€éŒ„"""
    logger.info(f"æ›´æ–°äº¤æ˜“: user={user.id}, id={transaction_id}")
    
    try:
        service = PortfolioService(db)
        
        # åªå‚³å…¥æœ‰å€¼çš„æ¬„ä½
        update_data = {k: v for k, v in data.dict().items() if v is not None}
        
        transaction = await service.update_transaction(
            transaction_id=transaction_id,
            user_id=user.id,
            **update_data,
        )
        
        if not transaction:
            raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°äº¤æ˜“ç´€éŒ„")
        
        return {
            "success": True,
            "message": "äº¤æ˜“ç´€éŒ„å·²æ›´æ–°",
            "data": transaction.to_dict(),
        }
        
    except HTTPException:
        raise
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        logger.error(f"æ›´æ–°äº¤æ˜“å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="æ›´æ–°äº¤æ˜“å¤±æ•—")


@router.delete("/transactions/{transaction_id}", summary="åˆªé™¤äº¤æ˜“ç´€éŒ„")
async def delete_transaction(
    transaction_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤äº¤æ˜“ç´€éŒ„"""
    logger.info(f"åˆªé™¤äº¤æ˜“: user={user.id}, id={transaction_id}")
    
    service = PortfolioService(db)
    success = await service.delete_transaction(transaction_id, user.id)
    
    if not success:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°äº¤æ˜“ç´€éŒ„")
    
    return {
        "success": True,
        "message": "äº¤æ˜“ç´€éŒ„å·²åˆªé™¤",
    }


# ============================================================
# æŒè‚¡ API
# ============================================================

@router.get("/holdings", summary="å–å¾—æŒè‚¡ç¸½è¦½")
async def get_holdings(
    market: Optional[str] = Query(None, pattern="^(tw|us)$", description="ç¯©é¸å¸‚å ´"),
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„æŒè‚¡åˆ—è¡¨ï¼ˆå«ç¾åƒ¹å’Œæç›Šï¼‰
    
    - ç¾åƒ¹ä¾†è‡ªåƒ¹æ ¼å¿«å–
    - åŒ…å«æœªå¯¦ç¾æç›Šè¨ˆç®—
    """
    try:
        service = PortfolioService(db)
        holdings = await service.get_holdings_with_prices(user.id, market)
        
        # åˆ†é¡
        tw_holdings = [h for h in holdings if h['market'] == 'tw' and h['total_shares'] > 0]
        us_holdings = [h for h in holdings if h['market'] == 'us' and h['total_shares'] > 0]
        
        return {
            "success": True,
            "data": {
                "tw": tw_holdings,
                "us": us_holdings,
            },
            "total": len(tw_holdings) + len(us_holdings),
        }
        
    except Exception as e:
        logger.error(f"å–å¾—æŒè‚¡å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="å–å¾—æŒè‚¡å¤±æ•—")


@router.get("/summary", summary="å–å¾—æŠ•è³‡æ‘˜è¦")
async def get_summary(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—æŠ•è³‡çµ„åˆæ‘˜è¦çµ±è¨ˆ
    
    åŒ…å«ï¼š
    - åŒ¯ç‡è³‡è¨Š
    - å°è‚¡çµ±è¨ˆ
    - ç¾è‚¡çµ±è¨ˆ
    - ç¸½è¨ˆï¼ˆæ›ç®— TWDï¼‰
    """
    try:
        service = PortfolioService(db)
        summary = await service.get_summary(user.id)
        
        return {
            "success": True,
            "data": summary,
        }
        
    except Exception as e:
        logger.error(f"å–å¾—æŠ•è³‡æ‘˜è¦å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail="å–å¾—æŠ•è³‡æ‘˜è¦å¤±æ•—")
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/stock.py  â­â­â­
> è‚¡ç¥¨æŸ¥è©¢ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨æŸ¥è©¢ API è·¯ç”±

ğŸš€ æ•ˆèƒ½å„ªåŒ–ç‰ˆ - 2026-01-16
- æ­·å²è³‡æ–™å­˜å…¥ PostgreSQL
- ä¿®æ­£è·¯ç”±é †åºï¼ˆå…·é«”è·¯ç”±åœ¨å‰ï¼‰
- ä¿®æ­£ returns API æ ¼å¼ç¬¦åˆå‰ç«¯æœŸæœ›
- ä¿®æ­£ CAGR è¨ˆç®—ä½¿ç”¨å¯¦éš›å¤©æ•¸
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import FileResponse
import logging
import pandas as pd
from datetime import datetime, date, timedelta

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/stock", tags=["è‚¡ç¥¨"])


def normalize_tw_symbol(symbol: str) -> str:
    """æ¨™æº–åŒ–å°è‚¡ä»£è™Ÿ"""
    symbol = symbol.strip().upper()
    
    if '.' in symbol or symbol.startswith('^'):
        return symbol
    
    if symbol.isdigit() and 4 <= len(symbol) <= 6:
        return f"{symbol}.TW"
    
    if len(symbol) >= 5 and symbol[:-1].isdigit() and symbol[-1] in ('L', 'R', 'U'):
        return f"{symbol}.TW"
    
    return symbol


def _get_stock_df(symbol: str, years: int = 10, force_refresh: bool = False):
    """
    å–å¾—è‚¡ç¥¨ DataFrameï¼ˆå¸¶å¿«å–ï¼‰
    
    Returns:
        (df, symbol, data_source)
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.stock_history_service import StockHistoryService
    from app.database import SyncSessionLocal
    
    df = None
    data_source = "yahoo"
    
    try:
        db = SyncSessionLocal()
        try:
            history_service = StockHistoryService(db)
            df, data_source = history_service.get_stock_history(symbol, years=years, force_refresh=force_refresh)
            
            if (df is None or df.empty) and symbol.endswith('.TW'):
                two_symbol = symbol.replace('.TW', '.TWO')
                df, data_source = history_service.get_stock_history(two_symbol, years=years, force_refresh=force_refresh)
                if df is not None and not df.empty:
                    symbol = two_symbol
        finally:
            db.close()
    except Exception as e:
        logger.warning(f"å¿«å–æœå‹™ç•°å¸¸: {e}")
        df = yahoo_finance.get_stock_history(symbol, period=f"{years}y")
        if (df is None or df.empty) and symbol.endswith('.TW'):
            two_symbol = symbol.replace('.TW', '.TWO')
            df = yahoo_finance.get_stock_history(two_symbol, period=f"{years}y")
            if df is not None and not df.empty:
                symbol = two_symbol
        data_source = "yahoo"
    
    return df, symbol, data_source


# ============================================================
# ğŸ”´ é‡è¦ï¼šéœæ…‹è·¯ç”±å¿…é ˆæ”¾åœ¨å‹•æ…‹è·¯ç”±ä¹‹å‰ï¼
# ============================================================

@router.get("/cache/stats", summary="å¿«å–çµ±è¨ˆ")
async def get_cache_stats(symbol: str = Query(None)):
    """å–å¾—æ­·å²è³‡æ–™å¿«å–çµ±è¨ˆ"""
    from app.services.stock_history_service import StockHistoryService
    from app.database import SyncSessionLocal
    
    try:
        db = SyncSessionLocal()
        try:
            stats = StockHistoryService(db).get_cache_stats(symbol)
        finally:
            db.close()
        return {"success": True, "data": stats}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/compare/history", summary="èµ°å‹¢æ¯”è¼ƒ")
async def compare_stocks(
    symbols: str = Query(..., description="è‚¡ç¥¨ä»£è™Ÿï¼Œé€—è™Ÿåˆ†éš”ï¼Œæœ€å¤š 5 å€‹"),
    days: int = Query(90, ge=7, le=365, description="æ¯”è¼ƒå¤©æ•¸"),
):
    """å–å¾—å¤šæ”¯è‚¡ç¥¨çš„æ­£è¦åŒ–èµ°å‹¢è³‡æ–™"""
    from app.data_sources.yahoo_finance import yahoo_finance
    import math
    
    symbol_list = [normalize_tw_symbol(s.strip()) for s in symbols.split(",") if s.strip()]
    
    if len(symbol_list) < 1:
        raise HTTPException(status_code=400, detail="è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ä»£è™Ÿ")
    if len(symbol_list) > 5:
        raise HTTPException(status_code=400, detail="æœ€å¤šæ¯”è¼ƒ 5 å€‹æ¨™çš„")
    
    result = {}
    
    for symbol in symbol_list:
        try:
            if symbol.startswith("^"):
                df = yahoo_finance.get_index_data(symbol, period="2y")
            else:
                df, symbol, _ = _get_stock_df(symbol, years=2)
            
            if df is None or df.empty:
                continue
            
            df.columns = [c.lower() for c in df.columns]
            if 'date' not in df.columns:
                df['date'] = df.index
            
            df = df.tail(days).copy()
            if len(df) < 5:
                continue
            
            price_col = "adj_close" if "adj_close" in df.columns else "close"
            start_price = df.iloc[0][price_col]
            if start_price == 0 or pd.isna(start_price):
                continue
            
            df["normalized"] = (df[price_col] / start_price) * 100
            df = df.dropna(subset=["normalized"])
            
            if symbol.startswith("^"):
                from app.models.index_price import INDEX_SYMBOLS
                info = INDEX_SYMBOLS.get(symbol, {})
                name = info.get("name_zh", symbol)
            else:
                info = yahoo_finance.get_stock_info(symbol)
                name = info.get("name", symbol) if info else symbol
            
            history = []
            for _, row in df.iterrows():
                val = row["normalized"]
                if not (math.isnan(val) or math.isinf(val)):
                    history.append({"date": str(row["date"]), "value": round(val, 2)})
            
            if history:
                result[symbol] = {"name": name, "history": history}
                
        except Exception as e:
            logger.error(f"è™•ç† {symbol} éŒ¯èª¤: {e}")
    
    if not result:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™")
    
    return {"success": True, "days": days, "data": result}


# ============================================================
# ğŸ”´ å¸¶è·¯å¾‘åƒæ•¸çš„å­è·¯ç”±ï¼ˆå¿…é ˆåœ¨ /{symbol} ä¹‹å‰ï¼‰
# ============================================================

@router.get("/{symbol}/returns", summary="å¹´åŒ–å ±é…¬ç‡")
async def get_stock_returns(symbol: str):
    """
    è¨ˆç®—è‚¡ç¥¨çš„å¹´åŒ–å ±é…¬ç‡ (CAGR)
    
    è¿”å›æ ¼å¼ç¬¦åˆå‰ç«¯ returns.js æœŸæœ›
    """
    from app.data_sources.yahoo_finance import yahoo_finance
    
    symbol = normalize_tw_symbol(symbol)
    logger.info(f"è¨ˆç®—å¹´åŒ–å ±é…¬ç‡: {symbol}")
    
    df, symbol, _ = _get_stock_df(symbol, years=10, force_refresh=False)
    
    if df is None or df.empty:
        raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
    
    try:
        df.columns = [c.lower() for c in df.columns]
        
        # ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼è¨ˆç®—å ±é…¬
        price_col = 'adj_close' if 'adj_close' in df.columns else 'close'
        
        # ç¢ºä¿ date æ¬„ä½å­˜åœ¨
        if 'date' not in df.columns:
            df['date'] = df.index
        
        total_records = len(df)
        current_price = float(df.iloc[-1][price_col])
        current_date = str(df.iloc[-1]['date'])
        
        logger.info(f"{symbol} è³‡æ–™ç­†æ•¸: {total_records}, ç•¶å‰åƒ¹æ ¼: {current_price}")
        
        # å–å¾—è‚¡ç¥¨åç¨±
        info = yahoo_finance.get_stock_info(symbol)
        stock_name = info.get("name", symbol) if info else symbol
        if not stock_name:
            from app.data_sources.yahoo_finance import TAIWAN_STOCK_NAMES
            stock_code = symbol.replace(".TW", "").replace(".TWO", "")
            stock_name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
        
        # è¨ˆç®—å„æœŸé–“å ±é…¬ç‡ï¼ˆç¬¦åˆå‰ç«¯æœŸæœ›æ ¼å¼ï¼‰
        # ä½¿ç”¨å¯¦éš›å¤©æ•¸è¨ˆç®—ï¼Œä¸å‡è¨­æ¯å¹´ 252 å¤©
        def calc_period_return(target_years):
            # æ¯å¹´ç´„ 252 å€‹äº¤æ˜“æ—¥
            target_days = target_years * 252
            
            # å¦‚æœè³‡æ–™ä¸è¶³ç›®æ¨™å¤©æ•¸çš„ 80%ï¼Œå‰‡è¿”å› None
            min_required = int(target_days * 0.8)
            if total_records < min_required:
                logger.info(f"{symbol} {target_years}Y: è³‡æ–™ä¸è¶³ ({total_records} < {min_required})")
                return None
            
            # å–å¯¦éš›å¯ç”¨çš„å¤©æ•¸ï¼ˆæœ€å¤šæ˜¯ç›®æ¨™å¤©æ•¸ï¼‰
            actual_days = min(target_days, total_records - 1)
            start_idx = -actual_days - 1
            
            start_row = df.iloc[start_idx]
            start_price = float(start_row[price_col])
            start_date = str(start_row['date'])
            
            if start_price <= 0:
                return None
            
            # è¨ˆç®—å¯¦éš›å¹´æ•¸
            try:
                if isinstance(df.iloc[-1]['date'], str):
                    end_dt = datetime.strptime(str(df.iloc[-1]['date'])[:10], '%Y-%m-%d')
                    start_dt = datetime.strptime(str(start_row['date'])[:10], '%Y-%m-%d')
                else:
                    end_dt = pd.to_datetime(df.iloc[-1]['date'])
                    start_dt = pd.to_datetime(start_row['date'])
                actual_years = (end_dt - start_dt).days / 365.25
            except:
                actual_years = actual_days / 252  # å›é€€æ–¹æ¡ˆ
            
            if actual_years < 0.5:  # è‡³å°‘éœ€è¦åŠå¹´
                return None
            
            # è¨ˆç®— CAGR
            cagr = ((current_price / start_price) ** (1 / actual_years) - 1) * 100
            
            return {
                "cagr": round(cagr, 2),
                "start_date": start_date[:10] if len(start_date) > 10 else start_date,
                "start_price": round(start_price, 2),
                "end_price": round(current_price, 2),
                "dividend_count": 0,  # é…æ¯æ¬¡æ•¸ï¼ˆadj_close å·²åŒ…å«ï¼‰
                "total_dividends": 0.0,  # ç¸½é…æ¯ï¼ˆå·²åæ˜ åœ¨åƒ¹æ ¼ä¸­ï¼‰
                "actual_years": round(actual_years, 2),
            }
        
        returns = {}
        for period_name, years in [("1Y", 1), ("3Y", 3), ("5Y", 5), ("10Y", 10)]:
            result = calc_period_return(years)
            if result:
                returns[period_name] = result
        
        return {
            "success": True,
            "data": {
                "symbol": symbol,
                "name": stock_name,
                "current_price": round(current_price, 2),
                "current_date": current_date[:10] if len(current_date) > 10 else current_date,
                "total_records": total_records,
                "returns": returns,
            }
        }
        
    except Exception as e:
        logger.error(f"è¨ˆç®— {symbol} å¹´åŒ–å ±é…¬ç‡å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"è¨ˆç®—å¤±æ•—: {str(e)}")


@router.get("/{symbol}/chart", summary="å–å¾—è‚¡ç¥¨åœ–è¡¨")
async def get_stock_chart(
    symbol: str,
    days: int = Query(120, ge=30, le=365, description="é¡¯ç¤ºå¤©æ•¸"),
):
    """ç”Ÿæˆè‚¡ç¥¨æŠ€è¡“åˆ†æåœ–è¡¨"""
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.indicator_service import indicator_service
    from app.services.chart_service import chart_service
    
    symbol = normalize_tw_symbol(symbol)
    logger.info(f"ç”Ÿæˆåœ–è¡¨: {symbol}, days={days}")
    
    df, symbol, _ = _get_stock_df(symbol, years=2, force_refresh=False)
    
    if df is None or df.empty:
        raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
    
    df.columns = [c.lower() for c in df.columns]
    
    if 'adj_close' in df.columns:
        df['close'] = df['adj_close']
    
    if 'date' not in df.columns:
        df['date'] = df.index
    
    # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
    df = indicator_service.calculate_all_indicators(df)
    
    info = yahoo_finance.get_stock_info(symbol)
    name = info.get("name", "") if info else ""
    
    chart_path = chart_service.plot_stock_analysis(
        df,
        symbol=symbol,
        name=name,
        days=days,
        show_kd=False,
    )
    
    logger.info(f"åœ–è¡¨ç”Ÿæˆå®Œæˆ: {chart_path}")
    
    return FileResponse(chart_path, media_type="image/png", filename=f"{symbol}_chart.png")


@router.delete("/cache/{symbol}", summary="æ¸…é™¤å¿«å–")
async def clear_cache(symbol: str):
    """æ¸…é™¤æŒ‡å®šè‚¡ç¥¨çš„å¿«å–"""
    from app.services.stock_history_service import StockHistoryService
    from app.database import SyncSessionLocal
    
    try:
        db = SyncSessionLocal()
        try:
            count = StockHistoryService(db).clear_cache(symbol)
        finally:
            db.close()
        return {"success": True, "deleted_count": count}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# ğŸ”´ æœ€é€šç”¨çš„è·¯ç”±æ”¾æœ€å¾Œ
# ============================================================

@router.get("/{symbol}", summary="æŸ¥è©¢è‚¡ç¥¨")
async def get_stock_analysis(
    symbol: str,
    refresh: bool = Query(False, description="æ˜¯å¦å¼·åˆ¶æ›´æ–°è³‡æ–™"),
):
    """æŸ¥è©¢å–®ä¸€è‚¡ç¥¨çš„æŠ€è¡“åˆ†æå ±å‘Š"""
    from app.data_sources.yahoo_finance import yahoo_finance
    from app.services.indicator_service import indicator_service
    from app.services.price_cache_service import PriceCacheService
    from app.database import SyncSessionLocal
    
    symbol = normalize_tw_symbol(symbol)
    original_symbol = symbol
    logger.info(f"é–‹å§‹æŸ¥è©¢è‚¡ç¥¨: {symbol}, refresh={refresh}")
    
    df, symbol, data_source = _get_stock_df(symbol, years=10, force_refresh=refresh)
    
    if df is None or df.empty:
        raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {original_symbol}")
    
    logger.info(f"å–å¾— {len(df)} ç­†è³‡æ–™ï¼Œä¾†æº: {data_source}")
    
    try:
        df.columns = [c.lower() for c in df.columns]
        df['close_raw'] = df['close'].copy()
        
        if 'adj_close' in df.columns:
            df['close'] = df['adj_close']
        
        if 'date' not in df.columns:
            df['date'] = df.index
        
        df = indicator_service.calculate_all_indicators(df)
        
        latest = df.iloc[-1]
        current_price = float(latest.get('close_raw', latest['close']))
        
        info = yahoo_finance.get_stock_info(symbol)
        
        close_col = 'close_raw' if 'close_raw' in df.columns else 'close'
        high_52w = float(df[close_col].tail(252).max()) if len(df) >= 252 else float(df[close_col].max())
        low_52w = float(df[close_col].tail(252).min()) if len(df) >= 252 else float(df[close_col].min())
        
        current_price_adj = float(latest['close'])
        def calc_change(days):
            if len(df) > days:
                old = float(df.iloc[-days-1]['close'])
                return round((current_price_adj - old) / old * 100, 2)
            return None
        
        ma20 = float(latest['ma20']) if 'ma20' in latest and pd.notna(latest.get('ma20')) else None
        ma50 = float(latest['ma50']) if 'ma50' in latest and pd.notna(latest.get('ma50')) else None
        ma200 = float(latest['ma200']) if 'ma200' in latest and pd.notna(latest.get('ma200')) else None
        
        alignment = "neutral"
        if ma20 and ma50 and ma200:
            if current_price_adj > ma20 > ma50 > ma200:
                alignment = "bullish"
            elif current_price_adj < ma20 < ma50 < ma200:
                alignment = "bearish"
        
        rsi_value = float(latest['rsi']) if 'rsi' in latest and pd.notna(latest.get('rsi')) else 50
        rsi_status = "overbought" if rsi_value > 70 else "oversold" if rsi_value < 30 else "neutral"
        
        macd_dif = float(latest['macd_dif']) if 'macd_dif' in latest and pd.notna(latest.get('macd_dif')) else 0
        macd_dea = float(latest['macd_dea']) if 'macd_dea' in latest and pd.notna(latest.get('macd_dea')) else 0
        macd_hist = float(latest['macd_hist']) if 'macd_hist' in latest and pd.notna(latest.get('macd_hist')) else 0
        macd_status = "bullish" if macd_dif > macd_dea else "bearish"
        
        volume_today = int(latest['volume']) if pd.notna(latest.get('volume')) else 0
        volume_avg = int(df['volume'].tail(20).mean()) if 'volume' in df.columns else 0
        volume_ratio = round(volume_today / volume_avg, 2) if volume_avg > 0 else 1.0
        
        buy_score = 0
        sell_score = 0
        if alignment == "bullish": buy_score += 1
        elif alignment == "bearish": sell_score += 1
        if rsi_value < 30: buy_score += 1
        elif rsi_value > 70: sell_score += 1
        if macd_status == "bullish": buy_score += 1
        else: sell_score += 1
        rating = "bullish" if buy_score > sell_score else "bearish" if sell_score > buy_score else "neutral"
        
        stock_name = info.get("name", "") if info else ""
        if not stock_name:
            from app.data_sources.yahoo_finance import TAIWAN_STOCK_NAMES
            stock_code = symbol.replace(".TW", "").replace(".TWO", "")
            stock_name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
        
        # æ›´æ–°åƒ¹æ ¼å¿«å–
        try:
            db = SyncSessionLocal()
            try:
                day_change = calc_change(1)
                prev_close = float(df.iloc[-2][close_col]) if len(df) > 1 else None
                change_amount = current_price - prev_close if prev_close else None
                
                cache_service = PriceCacheService(db)
                cache_service._upsert_cache(
                    symbol=symbol, name=stock_name, price=current_price,
                    prev_close=prev_close, change=change_amount, change_pct=day_change,
                    volume=volume_today, asset_type="stock", ma20=ma20,
                )
                db.commit()
            finally:
                db.close()
        except Exception as e:
            logger.warning(f"åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}")
        
        # åœ–è¡¨è³‡æ–™ - ç¢ºä¿æœ‰è¶³å¤ è³‡æ–™
        df_chart = df.tail(1500)
        
        # ç¢ºä¿ chart_data æœ‰æ•ˆ
        chart_data = None
        if len(df_chart) > 0:
            chart_data = {
                "dates": [str(d) for d in df_chart['date'].tolist()],
                "prices": [float(p) if pd.notna(p) else None for p in df_chart['close'].tolist()],
                "ma20": [float(v) if pd.notna(v) else None for v in df_chart['ma20'].tolist()] if 'ma20' in df_chart.columns else [],
                "ma50": [float(v) if pd.notna(v) else None for v in df_chart['ma50'].tolist()] if 'ma50' in df_chart.columns else [],
                "ma200": [float(v) if pd.notna(v) else None for v in df_chart['ma200'].tolist()] if 'ma200' in df_chart.columns else [],
                "ma250": [float(v) if pd.notna(v) else None for v in df_chart['ma250'].tolist()] if 'ma250' in df_chart.columns else [],
                "volume": [int(v) if pd.notna(v) else 0 for v in df_chart['volume'].tolist()] if 'volume' in df_chart.columns else [],
            }
            logger.info(f"chart_data æº–å‚™å®Œæˆ: {len(chart_data['dates'])} ç­†")
        
        return {
            "success": True,
            "symbol": symbol,
            "name": stock_name,
            "asset_type": "stock",
            "price": {
                "current": current_price,
                "high_52w": high_52w,
                "low_52w": low_52w,
                "from_high_pct": round((current_price - high_52w) / high_52w * 100, 2),
                "from_low_pct": round((current_price - low_52w) / low_52w * 100, 2),
            },
            "change": {
                "day": calc_change(1),
                "week": calc_change(5),
                "month": calc_change(20),
                "quarter": calc_change(60),
                "year": calc_change(250),
            },
            "volume": {"today": volume_today, "avg_20d": volume_avg, "ratio": volume_ratio},
            "indicators": {
                "ma": {
                    "ma20": ma20, "ma50": ma50, "ma200": ma200,
                    "alignment": alignment,
                    "price_vs_ma20": "above" if ma20 and current_price > ma20 else "below" if ma20 else None,
                    "price_vs_ma50": "above" if ma50 and current_price > ma50 else "below" if ma50 else None,
                    "price_vs_ma200": "above" if ma200 and current_price > ma200 else "below" if ma200 else None,
                },
                "rsi": {"value": rsi_value, "period": 14, "status": rsi_status},
                "macd": {"dif": macd_dif, "macd": macd_dea, "histogram": macd_hist, "status": macd_status},
            },
            "score": {"buy": buy_score, "sell": sell_score, "rating": rating},
            "chart_data": chart_data,
            "from_cache": data_source in ('cache', 'partial'),
            "data_source": data_source,
            "total_records": len(df),
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"è™•ç† {symbol} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"æŸ¥è©¢å¤±æ•—: {str(e)}")
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/stock_info.py  â­â­â­
> è‚¡ç¥¨è³‡è¨Š API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨è³‡è¨Š API è·¯ç”±
==================
stock_info ç¨®å­è¡¨æŸ¥è©¢èˆ‡ç®¡ç†

P1 åŠŸèƒ½
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, or_
from typing import Optional, List
from pydantic import BaseModel, Field
import logging

from app.database import get_db, get_async_session
from app.models.stock_info import StockInfo, DEFAULT_STOCK_INFO
from app.dependencies import get_admin_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/stock-info", tags=["è‚¡ç¥¨è³‡è¨Š"])


# ============================================================
# Schemas
# ============================================================

class StockInfoCreate(BaseModel):
    symbol: str = Field(..., min_length=1, max_length=20)
    name: Optional[str] = Field(None, max_length=100)
    name_zh: Optional[str] = Field(None, max_length=100)
    market: str = Field(default="us", pattern="^(us|tw|crypto)$")
    exchange: Optional[str] = Field(None, max_length=20)
    sector: Optional[str] = Field(None, max_length=50)
    industry: Optional[str] = Field(None, max_length=50)
    is_popular: bool = False


class StockInfoUpdate(BaseModel):
    name: Optional[str] = Field(None, max_length=100)
    name_zh: Optional[str] = Field(None, max_length=100)
    market: Optional[str] = Field(None, pattern="^(us|tw|crypto)$")
    exchange: Optional[str] = Field(None, max_length=20)
    sector: Optional[str] = Field(None, max_length=50)
    industry: Optional[str] = Field(None, max_length=50)
    is_popular: Optional[bool] = None
    is_active: Optional[bool] = None


# ============================================================
# å…¬é–‹ API
# ============================================================

@router.get("/search", summary="æœå°‹è‚¡ç¥¨")
async def search_stocks(
    q: str = Query(..., min_length=1, description="æœå°‹é—œéµå­—"),
    market: Optional[str] = Query(None, pattern="^(us|tw|crypto)$"),
    limit: int = Query(20, ge=1, le=100),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æœå°‹è‚¡ç¥¨è³‡è¨Š
    - æ”¯æ´ä»£è™Ÿã€åç¨±ã€ä¸­æ–‡åç¨±æ¨¡ç³Šæœå°‹
    - å¯ç¯©é¸å¸‚å ´
    """
    q_upper = q.upper()
    q_like = f"%{q}%"
    
    stmt = select(StockInfo).where(
        StockInfo.is_active == True,
        or_(
            StockInfo.symbol.ilike(q_like),
            StockInfo.name.ilike(q_like),
            StockInfo.name_zh.ilike(q_like),
        )
    )
    
    if market:
        stmt = stmt.where(StockInfo.market == market)
    
    # å„ªå…ˆé¡¯ç¤ºå®Œå…¨åŒ¹é…
    stmt = stmt.order_by(
        (StockInfo.symbol == q_upper).desc(),
        StockInfo.is_popular.desc(),
        StockInfo.symbol
    ).limit(limit)
    
    result = await db.execute(stmt)
    stocks = result.scalars().all()
    
    return {
        "success": True,
        "query": q,
        "data": [s.to_dict() for s in stocks],
        "total": len(stocks),
    }


@router.get("/popular", summary="ç†±é–€è‚¡ç¥¨")
async def get_popular_stocks(
    market: Optional[str] = Query(None, pattern="^(us|tw|crypto)$"),
    limit: int = Query(20, ge=1, le=50),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç†±é–€è‚¡ç¥¨åˆ—è¡¨"""
    stmt = select(StockInfo).where(
        StockInfo.is_active == True,
        StockInfo.is_popular == True
    )
    
    if market:
        stmt = stmt.where(StockInfo.market == market)
    
    stmt = stmt.order_by(StockInfo.symbol).limit(limit)
    
    result = await db.execute(stmt)
    stocks = result.scalars().all()
    
    return {
        "success": True,
        "data": [s.to_dict() for s in stocks],
        "total": len(stocks),
    }


@router.get("/by-market/{market}", summary="ä¾å¸‚å ´å–å¾—è‚¡ç¥¨")
async def get_stocks_by_market(
    market: str,
    sector: Optional[str] = None,
    limit: int = Query(100, ge=1, le=500),
    offset: int = Query(0, ge=0),
    db: AsyncSession = Depends(get_async_session),
):
    """ä¾å¸‚å ´å–å¾—è‚¡ç¥¨åˆ—è¡¨"""
    if market not in ("us", "tw", "crypto"):
        raise HTTPException(status_code=400, detail="ç„¡æ•ˆçš„å¸‚å ´")
    
    stmt = select(StockInfo).where(
        StockInfo.is_active == True,
        StockInfo.market == market
    )
    
    if sector:
        stmt = stmt.where(StockInfo.sector == sector)
    
    stmt = stmt.order_by(StockInfo.is_popular.desc(), StockInfo.symbol)
    stmt = stmt.offset(offset).limit(limit)
    
    result = await db.execute(stmt)
    stocks = result.scalars().all()
    
    return {
        "success": True,
        "market": market,
        "data": [s.to_dict() for s in stocks],
        "total": len(stocks),
    }


@router.get("/sectors", summary="å–å¾—ç”¢æ¥­åˆ†é¡")
async def get_sectors(
    market: Optional[str] = Query(None, pattern="^(us|tw|crypto)$"),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—æ‰€æœ‰ç”¢æ¥­åˆ†é¡"""
    from sqlalchemy import func, distinct
    
    stmt = select(distinct(StockInfo.sector)).where(
        StockInfo.is_active == True,
        StockInfo.sector.isnot(None)
    )
    
    if market:
        stmt = stmt.where(StockInfo.market == market)
    
    result = await db.execute(stmt)
    sectors = [row[0] for row in result.all() if row[0]]
    
    return {
        "success": True,
        "sectors": sorted(sectors),
    }


@router.get("/{symbol}", summary="å–å¾—è‚¡ç¥¨è³‡è¨Š")
async def get_stock_info(
    symbol: str,
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—å–®ä¸€è‚¡ç¥¨çš„è©³ç´°è³‡è¨Š"""
    stmt = select(StockInfo).where(
        StockInfo.symbol == symbol.upper()
    )
    result = await db.execute(stmt)
    stock = result.scalar_one_or_none()
    
    if not stock:
        raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
    
    return {
        "success": True,
        "data": stock.to_dict(),
    }


# ============================================================
# ç®¡ç†å“¡ API
# ============================================================

@router.post("/admin/init", summary="åˆå§‹åŒ–ç¨®å­è³‡æ–™")
async def init_stock_info(
    admin = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆå§‹åŒ–é è¨­è‚¡ç¥¨è³‡è¨Š"""
    added = 0
    skipped = 0
    
    for stock_data in DEFAULT_STOCK_INFO:
        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        stmt = select(StockInfo).where(StockInfo.symbol == stock_data["symbol"])
        result = await db.execute(stmt)
        if result.scalar_one_or_none():
            skipped += 1
            continue
        
        stock = StockInfo(**stock_data)
        db.add(stock)
        added += 1
    
    await db.commit()
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} åˆå§‹åŒ–è‚¡ç¥¨è³‡è¨Š: æ–°å¢ {added}, è·³é {skipped}")
    
    return {
        "success": True,
        "message": f"åˆå§‹åŒ–å®Œæˆï¼šæ–°å¢ {added} ç­†ï¼Œè·³é {skipped} ç­†",
        "added": added,
        "skipped": skipped,
    }


@router.post("/admin/add", summary="æ–°å¢è‚¡ç¥¨è³‡è¨Š")
async def add_stock_info(
    data: StockInfoCreate,
    admin = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ–°å¢è‚¡ç¥¨è³‡è¨Š"""
    symbol = data.symbol.upper()
    
    # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    stmt = select(StockInfo).where(StockInfo.symbol == symbol)
    result = await db.execute(stmt)
    if result.scalar_one_or_none():
        raise HTTPException(status_code=400, detail=f"è‚¡ç¥¨ {symbol} å·²å­˜åœ¨")
    
    stock = StockInfo(
        symbol=symbol,
        name=data.name,
        name_zh=data.name_zh,
        market=data.market,
        exchange=data.exchange,
        sector=data.sector,
        industry=data.industry,
        is_popular=data.is_popular,
    )
    db.add(stock)
    await db.commit()
    await db.refresh(stock)
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} æ–°å¢è‚¡ç¥¨: {symbol}")
    
    return {
        "success": True,
        "message": f"å·²æ–°å¢ {symbol}",
        "data": stock.to_dict(),
    }


@router.put("/admin/{symbol}", summary="æ›´æ–°è‚¡ç¥¨è³‡è¨Š")
async def update_stock_info(
    symbol: str,
    data: StockInfoUpdate,
    admin = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ›´æ–°è‚¡ç¥¨è³‡è¨Š"""
    stmt = select(StockInfo).where(StockInfo.symbol == symbol.upper())
    result = await db.execute(stmt)
    stock = result.scalar_one_or_none()
    
    if not stock:
        raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
    
    # æ›´æ–°æ¬„ä½
    update_data = data.dict(exclude_unset=True)
    for key, value in update_data.items():
        setattr(stock, key, value)
    
    await db.commit()
    await db.refresh(stock)
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} æ›´æ–°è‚¡ç¥¨: {symbol}")
    
    return {
        "success": True,
        "message": f"å·²æ›´æ–° {symbol}",
        "data": stock.to_dict(),
    }


@router.delete("/admin/{symbol}", summary="åˆªé™¤è‚¡ç¥¨è³‡è¨Š")
async def delete_stock_info(
    symbol: str,
    admin = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤è‚¡ç¥¨è³‡è¨Š"""
    stmt = select(StockInfo).where(StockInfo.symbol == symbol.upper())
    result = await db.execute(stmt)
    stock = result.scalar_one_or_none()
    
    if not stock:
        raise HTTPException(status_code=404, detail=f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
    
    await db.delete(stock)
    await db.commit()
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} åˆªé™¤è‚¡ç¥¨: {symbol}")
    
    return {
        "success": True,
        "message": f"å·²åˆªé™¤ {symbol}",
    }


@router.post("/admin/batch-add", summary="æ‰¹æ¬¡æ–°å¢è‚¡ç¥¨")
async def batch_add_stocks(
    stocks: List[StockInfoCreate],
    admin = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ‰¹æ¬¡æ–°å¢è‚¡ç¥¨è³‡è¨Š"""
    added = []
    errors = []
    
    for stock_data in stocks:
        symbol = stock_data.symbol.upper()
        
        try:
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(StockInfo).where(StockInfo.symbol == symbol)
            result = await db.execute(stmt)
            if result.scalar_one_or_none():
                errors.append({"symbol": symbol, "error": "å·²å­˜åœ¨"})
                continue
            
            stock = StockInfo(
                symbol=symbol,
                name=stock_data.name,
                name_zh=stock_data.name_zh,
                market=stock_data.market,
                exchange=stock_data.exchange,
                sector=stock_data.sector,
                industry=stock_data.industry,
                is_popular=stock_data.is_popular,
            )
            db.add(stock)
            added.append(symbol)
        except Exception as e:
            errors.append({"symbol": symbol, "error": str(e)})
    
    await db.commit()
    
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} æ‰¹æ¬¡æ–°å¢è‚¡ç¥¨: æˆåŠŸ {len(added)}, å¤±æ•— {len(errors)}")
    
    return {
        "success": True,
        "message": f"æ‰¹æ¬¡æ–°å¢å®Œæˆï¼šæˆåŠŸ {len(added)} ç­†ï¼Œå¤±æ•— {len(errors)} ç­†",
        "added": added,
        "errors": errors,
    }


@router.get("/admin/stats", summary="è‚¡ç¥¨è³‡è¨Šçµ±è¨ˆ")
async def get_stock_info_stats(
    admin = Depends(get_admin_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—è‚¡ç¥¨è³‡è¨Šçµ±è¨ˆ"""
    from sqlalchemy import func
    
    # ç¸½æ•¸
    total_stmt = select(func.count(StockInfo.id))
    total = await db.scalar(total_stmt)
    
    # ä¾å¸‚å ´çµ±è¨ˆ
    market_stmt = (
        select(StockInfo.market, func.count(StockInfo.id))
        .group_by(StockInfo.market)
    )
    market_result = await db.execute(market_stmt)
    by_market = {row[0]: row[1] for row in market_result.all()}
    
    # ç†±é–€è‚¡æ•¸é‡
    popular_stmt = select(func.count(StockInfo.id)).where(StockInfo.is_popular == True)
    popular = await db.scalar(popular_stmt)
    
    return {
        "success": True,
        "stats": {
            "total": total or 0,
            "by_market": by_market,
            "popular": popular or 0,
        }
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/subscription.py  â­â­â­
> è¨‚é–±ç²¾é¸ API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨‚é–±ç²¾é¸ API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
"""
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.orm import Session
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List, Optional
import logging

from app.database import get_db, get_async_session
from app.services.subscription_service import SubscriptionService
from app.models.subscription import SubscriptionSource, AutoPick
from app.models.price_cache import StockPriceCache

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_current_user, get_admin_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/subscription", tags=["è¨‚é–±ç²¾é¸"])


# ============================================================
# è¨‚é–±æº
# ============================================================

@router.get("/sources", summary="å–å¾—æ‰€æœ‰è¨‚é–±æº")
def get_sources(db: Session = Depends(get_db)):
    """å–å¾—æ‰€æœ‰å¯è¨‚é–±çš„ä¾†æº"""
    from datetime import datetime
    
    service = SubscriptionService(db)
    sources = service.get_all_sources(enabled_only=True)
    
    # è¨ˆç®—æ¯å€‹ä¾†æºçš„æœ‰æ•ˆç²¾é¸æ•¸é‡
    results = []
    for source in sources:
        source_dict = source.to_dict()
        # è¨ˆç®—æœªéæœŸçš„ç²¾é¸æ•¸é‡
        picks_count = db.query(AutoPick).filter(
            AutoPick.source_id == source.id,
            AutoPick.expires_at > datetime.now()
        ).count()
        source_dict["picks_count"] = picks_count
        results.append(source_dict)
    
    return {
        "success": True,
        "data": results,
    }


@router.get("/sources/{slug}", summary="å–å¾—å–®ä¸€è¨‚é–±æº")
def get_source(slug: str, db: Session = Depends(get_db)):
    """å–å¾—å–®ä¸€è¨‚é–±æºè©³æƒ…"""
    service = SubscriptionService(db)
    source = service.get_source_by_slug(slug)
    
    if not source:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¨‚é–±æº")
    
    return {
        "success": True,
        "data": source.to_dict(),
    }


# ============================================================
# ç”¨æˆ¶è¨‚é–±
# ============================================================

@router.get("/my", summary="æˆ‘çš„è¨‚é–±")
async def get_my_subscriptions(
    user = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """å–å¾—ç”¨æˆ¶è¨‚é–±çš„ä¾†æº"""
    service = SubscriptionService(db)
    sources = service.get_user_subscriptions(user.id)
    
    return {
        "success": True,
        "data": [s.to_dict() for s in sources],
    }


@router.post("/subscribe/{source_id}", summary="è¨‚é–±ä¾†æº")
async def subscribe_source(
    source_id: int,
    user = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """è¨‚é–±æŒ‡å®šä¾†æº"""
    service = SubscriptionService(db)
    
    # æª¢æŸ¥ä¾†æºæ˜¯å¦å­˜åœ¨
    source = db.query(SubscriptionSource).filter(
        SubscriptionSource.id == source_id
    ).first()
    if not source:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¨‚é–±æº")
    
    result = service.subscribe(user.id, source_id)
    
    if not result:
        return {
            "success": True,
            "message": "å·²ç¶“è¨‚é–±éäº†",
        }
    
    return {
        "success": True,
        "message": f"æˆåŠŸè¨‚é–± {source.name}",
    }


@router.delete("/unsubscribe/{source_id}", summary="å–æ¶ˆè¨‚é–±")
async def unsubscribe_source(
    source_id: int,
    user = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """å–æ¶ˆè¨‚é–±æŒ‡å®šä¾†æº"""
    service = SubscriptionService(db)
    result = service.unsubscribe(user.id, source_id)
    
    if not result:
        raise HTTPException(status_code=404, detail="æœªè¨‚é–±æ­¤ä¾†æº")
    
    return {
        "success": True,
        "message": "å·²å–æ¶ˆè¨‚é–±",
    }


# ============================================================
# ç²¾é¸åˆ—è¡¨
# ============================================================

@router.get("/picks", summary="æˆ‘çš„è¨‚é–±ç²¾é¸")
async def get_my_picks(
    user = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """
    å–å¾—ç”¨æˆ¶è¨‚é–±çš„æ‰€æœ‰ç²¾é¸
    åŒ…å«åƒ¹æ ¼è³‡è¨Šï¼ˆå¾å¿«å–ï¼‰
    """
    service = SubscriptionService(db)
    picks = service.get_user_picks(user.id)
    
    if not picks:
        return {
            "success": True,
            "data": [],
            "message": "å°šæœªè¨‚é–±ä»»ä½•ä¾†æºï¼Œæˆ–ç›®å‰æ²’æœ‰ç²¾é¸",
        }
    
    # å–å¾—åƒ¹æ ¼å¿«å–
    symbols = [p["symbol"] for p in picks]
    cache_map = {}
    
    if symbols:
        caches = db.query(StockPriceCache).filter(
            StockPriceCache.symbol.in_(symbols)
        ).all()
        cache_map = {c.symbol: c for c in caches}
    
    # çµ„åˆåƒ¹æ ¼
    for pick in picks:
        cache = cache_map.get(pick["symbol"])
        pick["price"] = float(cache.price) if cache and cache.price else None
        pick["change_pct"] = float(cache.change_pct) if cache and cache.change_pct else None
        pick["price_updated_at"] = cache.updated_at.isoformat() if cache and cache.updated_at else None
    
    return {
        "success": True,
        "data": picks,
        "total": len(picks),
    }


@router.get("/picks/{source_slug}", summary="ç‰¹å®šä¾†æºçš„ç²¾é¸")
def get_source_picks(
    source_slug: str,
    db: Session = Depends(get_db),
):
    """å–å¾—ç‰¹å®šä¾†æºçš„æ‰€æœ‰ç²¾é¸ï¼ˆå…¬é–‹ï¼‰"""
    service = SubscriptionService(db)
    source = service.get_source_by_slug(source_slug)
    
    if not source:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¨‚é–±æº")
    
    picks = service.get_active_picks(source_id=source.id)
    
    # å–å¾—åƒ¹æ ¼
    symbols = [p.symbol for p in picks]
    cache_map = {}
    if symbols:
        caches = db.query(StockPriceCache).filter(
            StockPriceCache.symbol.in_(symbols)
        ).all()
        cache_map = {c.symbol: c for c in caches}
    
    results = []
    for pick in picks:
        pick_dict = pick.to_dict()
        cache = cache_map.get(pick.symbol)
        pick_dict["price"] = float(cache.price) if cache and cache.price else None
        pick_dict["change_pct"] = float(cache.change_pct) if cache and cache.change_pct else None
        results.append(pick_dict)
    
    return {
        "success": True,
        "source": source.to_dict(),
        "data": results,
        "total": len(results),
    }


# ============================================================
# ç®¡ç† APIï¼ˆç®¡ç†å“¡ç”¨ï¼‰
# ============================================================

@router.post("/admin/fetch", summary="æ‰‹å‹•æŠ“å–")
async def admin_fetch(
    backfill: bool = False,
    admin = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """
    æ‰‹å‹•è§¸ç™¼æŠ“å–
    - backfill=True: å›æº¯ 30 å¤©
    - backfill=False: åªæŠ“æ–°çš„
    """
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} è§¸ç™¼è¨‚é–±æºæŠ“å– (backfill={backfill})")
    
    service = SubscriptionService(db)
    result = service.fetch_all_sources(backfill=backfill)
    
    return {
        "success": True,
        "message": "æŠ“å–å®Œæˆ",
        "data": result,
    }


@router.post("/admin/init", summary="åˆå§‹åŒ–è¨‚é–±æº")
async def admin_init(
    admin = Depends(get_admin_user),
    db: Session = Depends(get_db),
):
    """åˆå§‹åŒ–é è¨­è¨‚é–±æº"""
    logger.info(f"ç®¡ç†å“¡ {admin.display_name} åˆå§‹åŒ–è¨‚é–±æº")
    
    service = SubscriptionService(db)
    service.init_default_sources()
    
    return {
        "success": True,
        "message": "åˆå§‹åŒ–å®Œæˆ",
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/tags.py  â­â­â­
> æ¨™ç±¤ç®¡ç† API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ¨™ç±¤ç®¡ç† API è·¯ç”±
==================
è¿½è¹¤æ¸…å–®åˆ†çµ„ Tag åŠŸèƒ½

P1 åŠŸèƒ½
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete
from typing import List, Optional
from pydantic import BaseModel, Field
import logging

from app.database import get_async_session
from app.models.user import User
from app.models.watchlist import Watchlist
from app.models.watchlist_tag import UserTag, watchlist_tags, TAG_COLORS, TAG_ICONS, DEFAULT_TAGS
from app.dependencies import get_current_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/tags", tags=["æ¨™ç±¤ç®¡ç†"])


# ============================================================
# Schemas
# ============================================================

class TagCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=50)
    color: str = Field(default="#3B82F6", pattern="^#[0-9A-Fa-f]{6}$")
    icon: str = Field(default="fa-tag", max_length=50)


class TagUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=50)
    color: Optional[str] = Field(None, pattern="^#[0-9A-Fa-f]{6}$")
    icon: Optional[str] = Field(None, max_length=50)
    sort_order: Optional[int] = None


class WatchlistTagAssign(BaseModel):
    tag_ids: List[int] = Field(..., description="æ¨™ç±¤ ID åˆ—è¡¨")


# ============================================================
# æ¨™ç±¤ CRUD
# ============================================================

@router.get("", summary="å–å¾—æˆ‘çš„æ¨™ç±¤")
async def get_my_tags(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—ç”¨æˆ¶çš„æ‰€æœ‰æ¨™ç±¤"""
    stmt = (
        select(UserTag)
        .where(UserTag.user_id == user.id)
        .order_by(UserTag.sort_order, UserTag.id)
    )
    result = await db.execute(stmt)
    tags = result.scalars().all()
    
    return {
        "success": True,
        "data": [t.to_dict() for t in tags],
        "total": len(tags),
    }


@router.post("", summary="å»ºç«‹æ¨™ç±¤")
async def create_tag(
    data: TagCreate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å»ºç«‹æ–°æ¨™ç±¤"""
    # æª¢æŸ¥æ˜¯å¦è¶…éé™åˆ¶ (æœ€å¤š 20 å€‹)
    count_stmt = select(UserTag).where(UserTag.user_id == user.id)
    count_result = await db.execute(count_stmt)
    existing_count = len(count_result.scalars().all())
    
    if existing_count >= 20:
        raise HTTPException(status_code=400, detail="æœ€å¤šåªèƒ½å»ºç«‹ 20 å€‹æ¨™ç±¤")
    
    # æª¢æŸ¥åç¨±æ˜¯å¦é‡è¤‡
    check_stmt = select(UserTag).where(
        UserTag.user_id == user.id,
        UserTag.name == data.name
    )
    check_result = await db.execute(check_stmt)
    if check_result.scalar_one_or_none():
        raise HTTPException(status_code=400, detail="æ¨™ç±¤åç¨±å·²å­˜åœ¨")
    
    # å»ºç«‹æ¨™ç±¤
    tag = UserTag(
        user_id=user.id,
        name=data.name,
        color=data.color,
        icon=data.icon,
        sort_order=existing_count,
    )
    db.add(tag)
    await db.commit()
    await db.refresh(tag)
    
    logger.info(f"ç”¨æˆ¶ {user.id} å»ºç«‹æ¨™ç±¤: {tag.name}")
    
    return {
        "success": True,
        "message": "æ¨™ç±¤å·²å»ºç«‹",
        "data": tag.to_dict(),
    }


@router.put("/{tag_id}", summary="æ›´æ–°æ¨™ç±¤")
async def update_tag(
    tag_id: int,
    data: TagUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ›´æ–°æ¨™ç±¤"""
    stmt = select(UserTag).where(
        UserTag.id == tag_id,
        UserTag.user_id == user.id
    )
    result = await db.execute(stmt)
    tag = result.scalar_one_or_none()
    
    if not tag:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°æ¨™ç±¤")
    
    # æª¢æŸ¥åç¨±æ˜¯å¦èˆ‡å…¶ä»–æ¨™ç±¤é‡è¤‡
    if data.name and data.name != tag.name:
        check_stmt = select(UserTag).where(
            UserTag.user_id == user.id,
            UserTag.name == data.name,
            UserTag.id != tag_id
        )
        check_result = await db.execute(check_stmt)
        if check_result.scalar_one_or_none():
            raise HTTPException(status_code=400, detail="æ¨™ç±¤åç¨±å·²å­˜åœ¨")
    
    # æ›´æ–°æ¬„ä½
    if data.name is not None:
        tag.name = data.name
    if data.color is not None:
        tag.color = data.color
    if data.icon is not None:
        tag.icon = data.icon
    if data.sort_order is not None:
        tag.sort_order = data.sort_order
    
    await db.commit()
    await db.refresh(tag)
    
    return {
        "success": True,
        "message": "æ¨™ç±¤å·²æ›´æ–°",
        "data": tag.to_dict(),
    }


@router.delete("/{tag_id}", summary="åˆªé™¤æ¨™ç±¤")
async def delete_tag(
    tag_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆªé™¤æ¨™ç±¤"""
    stmt = select(UserTag).where(
        UserTag.id == tag_id,
        UserTag.user_id == user.id
    )
    result = await db.execute(stmt)
    tag = result.scalar_one_or_none()
    
    if not tag:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°æ¨™ç±¤")
    
    # åˆªé™¤é—œè¯å’Œæ¨™ç±¤
    await db.execute(
        delete(watchlist_tags).where(watchlist_tags.c.tag_id == tag_id)
    )
    await db.delete(tag)
    await db.commit()
    
    logger.info(f"ç”¨æˆ¶ {user.id} åˆªé™¤æ¨™ç±¤: {tag.name}")
    
    return {
        "success": True,
        "message": "æ¨™ç±¤å·²åˆªé™¤",
    }


@router.post("/init-defaults", summary="åˆå§‹åŒ–é è¨­æ¨™ç±¤")
async def init_default_tags(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """åˆå§‹åŒ–é è¨­æ¨™ç±¤ï¼ˆåƒ…é™ç„¡æ¨™ç±¤æ™‚ï¼‰"""
    # æª¢æŸ¥æ˜¯å¦å·²æœ‰æ¨™ç±¤
    check_stmt = select(UserTag).where(UserTag.user_id == user.id)
    check_result = await db.execute(check_stmt)
    if check_result.scalars().first():
        return {
            "success": False,
            "message": "å·²æœ‰æ¨™ç±¤å­˜åœ¨ï¼Œç„¡æ³•åˆå§‹åŒ–",
        }
    
    # å»ºç«‹é è¨­æ¨™ç±¤
    for i, tag_data in enumerate(DEFAULT_TAGS):
        tag = UserTag(
            user_id=user.id,
            name=tag_data["name"],
            color=tag_data["color"],
            icon=tag_data["icon"],
            sort_order=i,
        )
        db.add(tag)
    
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²å»ºç«‹ {len(DEFAULT_TAGS)} å€‹é è¨­æ¨™ç±¤",
    }


# ============================================================
# è¿½è¹¤é …ç›®æ¨™ç±¤ç®¡ç†
# ============================================================

@router.get("/watchlist/{watchlist_id}", summary="å–å¾—è¿½è¹¤é …ç›®çš„æ¨™ç±¤")
async def get_watchlist_tags(
    watchlist_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å–å¾—è¿½è¹¤é …ç›®çš„æ¨™ç±¤"""
    # ç¢ºèªè¿½è¹¤é …ç›®å±¬æ–¼ç”¨æˆ¶
    watchlist_stmt = select(Watchlist).where(
        Watchlist.id == watchlist_id,
        Watchlist.user_id == user.id
    )
    watchlist_result = await db.execute(watchlist_stmt)
    watchlist = watchlist_result.scalar_one_or_none()
    
    if not watchlist:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¿½è¹¤é …ç›®")
    
    # å–å¾—é—œè¯çš„æ¨™ç±¤
    tags_stmt = (
        select(UserTag)
        .join(watchlist_tags, UserTag.id == watchlist_tags.c.tag_id)
        .where(watchlist_tags.c.watchlist_id == watchlist_id)
    )
    tags_result = await db.execute(tags_stmt)
    tags = tags_result.scalars().all()
    
    return {
        "success": True,
        "watchlist_id": watchlist_id,
        "symbol": watchlist.symbol,
        "tags": [t.to_dict() for t in tags],
    }


@router.put("/watchlist/{watchlist_id}", summary="è¨­å®šè¿½è¹¤é …ç›®çš„æ¨™ç±¤")
async def set_watchlist_tags(
    watchlist_id: int,
    data: WatchlistTagAssign,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """è¨­å®šè¿½è¹¤é …ç›®çš„æ¨™ç±¤ï¼ˆè¦†è“‹ç¾æœ‰ï¼‰"""
    # ç¢ºèªè¿½è¹¤é …ç›®å±¬æ–¼ç”¨æˆ¶
    watchlist_stmt = select(Watchlist).where(
        Watchlist.id == watchlist_id,
        Watchlist.user_id == user.id
    )
    watchlist_result = await db.execute(watchlist_stmt)
    watchlist = watchlist_result.scalar_one_or_none()
    
    if not watchlist:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¿½è¹¤é …ç›®")
    
    # é©—è­‰æ¨™ç±¤éƒ½å±¬æ–¼ç”¨æˆ¶
    if data.tag_ids:
        tags_stmt = select(UserTag).where(
            UserTag.id.in_(data.tag_ids),
            UserTag.user_id == user.id
        )
        tags_result = await db.execute(tags_stmt)
        valid_tags = tags_result.scalars().all()
        valid_tag_ids = {t.id for t in valid_tags}
        
        invalid_ids = set(data.tag_ids) - valid_tag_ids
        if invalid_ids:
            raise HTTPException(status_code=400, detail=f"ç„¡æ•ˆçš„æ¨™ç±¤ ID: {invalid_ids}")
    
    # æ¸…é™¤ç¾æœ‰é—œè¯
    await db.execute(
        delete(watchlist_tags).where(watchlist_tags.c.watchlist_id == watchlist_id)
    )
    
    # å»ºç«‹æ–°é—œè¯
    if data.tag_ids:
        for tag_id in data.tag_ids:
            await db.execute(
                watchlist_tags.insert().values(
                    watchlist_id=watchlist_id,
                    tag_id=tag_id
                )
            )
    
    await db.commit()
    
    return {
        "success": True,
        "message": "æ¨™ç±¤å·²æ›´æ–°",
        "watchlist_id": watchlist_id,
        "tag_ids": data.tag_ids,
    }


@router.post("/watchlist/{watchlist_id}/add/{tag_id}", summary="æ–°å¢æ¨™ç±¤åˆ°è¿½è¹¤é …ç›®")
async def add_tag_to_watchlist(
    watchlist_id: int,
    tag_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """æ–°å¢å–®ä¸€æ¨™ç±¤åˆ°è¿½è¹¤é …ç›®"""
    # ç¢ºèªè¿½è¹¤é …ç›®å’Œæ¨™ç±¤éƒ½å±¬æ–¼ç”¨æˆ¶
    watchlist_stmt = select(Watchlist).where(
        Watchlist.id == watchlist_id,
        Watchlist.user_id == user.id
    )
    watchlist_result = await db.execute(watchlist_stmt)
    watchlist = watchlist_result.scalar_one_or_none()
    
    if not watchlist:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¿½è¹¤é …ç›®")
    
    tag_stmt = select(UserTag).where(
        UserTag.id == tag_id,
        UserTag.user_id == user.id
    )
    tag_result = await db.execute(tag_stmt)
    tag = tag_result.scalar_one_or_none()
    
    if not tag:
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°æ¨™ç±¤")
    
    # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    from sqlalchemy import text
    check = await db.execute(
        text("SELECT 1 FROM watchlist_tags WHERE watchlist_id = :wid AND tag_id = :tid"),
        {"wid": watchlist_id, "tid": tag_id}
    )
    if check.scalar():
        return {
            "success": True,
            "message": "æ¨™ç±¤å·²å­˜åœ¨",
        }
    
    # æ–°å¢é—œè¯
    await db.execute(
        watchlist_tags.insert().values(
            watchlist_id=watchlist_id,
            tag_id=tag_id
        )
    )
    await db.commit()
    
    return {
        "success": True,
        "message": f"å·²æ–°å¢æ¨™ç±¤ {tag.name}",
    }


@router.delete("/watchlist/{watchlist_id}/remove/{tag_id}", summary="å¾è¿½è¹¤é …ç›®ç§»é™¤æ¨™ç±¤")
async def remove_tag_from_watchlist(
    watchlist_id: int,
    tag_id: int,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """å¾è¿½è¹¤é …ç›®ç§»é™¤æ¨™ç±¤"""
    # ç¢ºèªè¿½è¹¤é …ç›®å±¬æ–¼ç”¨æˆ¶
    watchlist_stmt = select(Watchlist).where(
        Watchlist.id == watchlist_id,
        Watchlist.user_id == user.id
    )
    watchlist_result = await db.execute(watchlist_stmt)
    if not watchlist_result.scalar_one_or_none():
        raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è¿½è¹¤é …ç›®")
    
    # ç§»é™¤é—œè¯
    await db.execute(
        delete(watchlist_tags).where(
            watchlist_tags.c.watchlist_id == watchlist_id,
            watchlist_tags.c.tag_id == tag_id
        )
    )
    await db.commit()
    
    return {
        "success": True,
        "message": "æ¨™ç±¤å·²ç§»é™¤",
    }


# ============================================================
# å–å¾—é¸é …
# ============================================================

@router.get("/options/colors", summary="å–å¾—é¡è‰²é¸é …")
async def get_color_options():
    """å–å¾—å¯ç”¨çš„æ¨™ç±¤é¡è‰²"""
    return {
        "success": True,
        "colors": TAG_COLORS,
    }


@router.get("/options/icons", summary="å–å¾—åœ–ç¤ºé¸é …")
async def get_icon_options():
    """å–å¾—å¯ç”¨çš„æ¨™ç±¤åœ–ç¤º"""
    return {
        "success": True,
        "icons": TAG_ICONS,
    }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/routers/watchlist.py  â­â­â­
> è¿½è¹¤æ¸…å–® API è·¯ç”±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–® API è·¯ç”±
ğŸ”§ P0ä¿®å¾©ï¼šä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
âš¡ æ•ˆèƒ½å„ªåŒ–ï¼šæ‰¹é‡è¼‰å…¥æ¨™ç±¤ï¼Œæ¶ˆé™¤ N+1 å•é¡Œ
"""
from fastapi import APIRouter, Depends, HTTPException, Request, UploadFile, File
from fastapi.responses import StreamingResponse
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from typing import List, Optional
from pydantic import BaseModel
import logging
import json
import csv
import io
from datetime import datetime

from app.database import get_async_session
from app.services.watchlist_service import WatchlistService
from app.schemas.schemas import (
    WatchlistAdd,
    WatchlistUpdate,
    WatchlistItem,
    WatchlistResponse,
    WatchlistListResponse,
    WatchlistOverviewResponse,
    ResponseBase,
)
from app.models.user import User
from app.models.watchlist import Watchlist
from app.models.price_cache import StockPriceCache
from app.models.watchlist_tag import UserTag, watchlist_tags  # â­ æ–°å¢

# ğŸ”§ ä½¿ç”¨çµ±ä¸€èªè­‰æ¨¡çµ„
from app.dependencies import get_current_user

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/watchlist", tags=["è¿½è¹¤æ¸…å–®"])


# Schemas
class TargetPriceUpdate(BaseModel):
    target_price: Optional[float] = None


class WatchlistImportItem(BaseModel):
    symbol: str
    asset_type: Optional[str] = "stock"
    note: Optional[str] = None
    target_price: Optional[float] = None


class WatchlistImportRequest(BaseModel):
    items: List[WatchlistImportItem]


# ============================================================
# ğŸ†• ç†±é–€è¿½è¹¤çµ±è¨ˆ API
# ============================================================

@router.get("/popular", summary="ç†±é–€è¿½è¹¤çµ±è¨ˆ")
async def get_popular_watchlist(
    limit: int = 10,
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—æœ€å¤šäººè¿½è¹¤çš„è‚¡ç¥¨æ’è¡Œ
    
    - ä¸éœ€è¦ç™»å…¥
    - è¿”å›å‰ N å€‹æœ€å¤šäººè¿½è¹¤çš„æ¨™çš„
    - åŒ…å«è¿½è¹¤äººæ•¸çµ±è¨ˆ
    """
    logger.info(f"API: ç†±é–€è¿½è¹¤çµ±è¨ˆ - limit={limit}")

    try:
        from sqlalchemy import func
        
        # æŒ‰ symbol åˆ†çµ„ï¼Œè¨ˆç®—è¿½è¹¤äººæ•¸
        stmt = (
            select(
                Watchlist.symbol,
                Watchlist.asset_type,
                func.count(Watchlist.user_id.distinct()).label('count')
            )
            .group_by(Watchlist.symbol, Watchlist.asset_type)
            .order_by(func.count(Watchlist.user_id.distinct()).desc())
            .limit(limit)
        )
        
        result = await db.execute(stmt)
        rows = result.all()
        
        popular = []
        for row in rows:
            popular.append({
                "symbol": row.symbol,
                "asset_type": row.asset_type or "stock",
                "count": row.count,
            })
        
        return {
            "success": True,
            "popular": popular,
            "total": len(popular),
        }

    except Exception as e:
        logger.error(f"å–å¾—ç†±é–€è¿½è¹¤çµ±è¨ˆå¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# åŒ¯å‡ºåŒ¯å…¥ API
# ============================================================

@router.get("/export", summary="åŒ¯å‡ºè¿½è¹¤æ¸…å–®")
async def export_watchlist(
    format: str = "json",
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    åŒ¯å‡ºç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
    
    - format: json æˆ– csv
    - åŒ…å« symbol, asset_type, note, target_price
    """
    logger.info(f"API: åŒ¯å‡ºè¿½è¹¤æ¸…å–® - user_id={user.id}, format={format}")

    try:
        # å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
        stmt = (
            select(Watchlist)
            .where(Watchlist.user_id == user.id)
            .order_by(Watchlist.added_at.desc())
        )
        result = await db.execute(stmt)
        items = list(result.scalars().all())

        if not items:
            raise HTTPException(status_code=404, detail="è¿½è¹¤æ¸…å–®ç‚ºç©º")

        # æº–å‚™åŒ¯å‡ºè³‡æ–™
        export_data = []
        for item in items:
            export_data.append({
                "symbol": item.symbol,
                "asset_type": item.asset_type,
                "note": item.note or "",
                "target_price": float(item.target_price) if item.target_price else None,
                "added_at": item.added_at.isoformat() if item.added_at else None,
            })

        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

        if format.lower() == "csv":
            # CSV æ ¼å¼
            output = io.StringIO()
            writer = csv.DictWriter(output, fieldnames=["symbol", "asset_type", "note", "target_price", "added_at"])
            writer.writeheader()
            writer.writerows(export_data)
            
            return StreamingResponse(
                iter([output.getvalue()]),
                media_type="text/csv",
                headers={
                    "Content-Disposition": f"attachment; filename=watchlist_{timestamp}.csv"
                }
            )
        else:
            # JSON æ ¼å¼
            json_str = json.dumps({
                "export_time": datetime.now().isoformat(),
                "total": len(export_data),
                "items": export_data
            }, ensure_ascii=False, indent=2)
            
            return StreamingResponse(
                iter([json_str]),
                media_type="application/json",
                headers={
                    "Content-Disposition": f"attachment; filename=watchlist_{timestamp}.json"
                }
            )

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"åŒ¯å‡ºè¿½è¹¤æ¸…å–®å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/import", summary="åŒ¯å…¥è¿½è¹¤æ¸…å–®")
async def import_watchlist(
    data: WatchlistImportRequest,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    åŒ¯å…¥è¿½è¹¤æ¸…å–®
    
    - å·²å­˜åœ¨çš„ symbol æœƒè·³é
    - è¿”å›æˆåŠŸ/è·³é/å¤±æ•—çš„çµ±è¨ˆ
    """
    logger.info(f"API: åŒ¯å…¥è¿½è¹¤æ¸…å–® - user_id={user.id}, items={len(data.items)}")

    try:
        # å–å¾—ç¾æœ‰è¿½è¹¤æ¸…å–®
        stmt = select(Watchlist.symbol).where(Watchlist.user_id == user.id)
        result = await db.execute(stmt)
        existing_symbols = set(row[0] for row in result.all())

        added = []
        skipped = []
        errors = []

        for item in data.items:
            symbol = item.symbol.upper().strip()
            
            if not symbol:
                continue
                
            if symbol in existing_symbols:
                skipped.append(symbol)
                continue

            try:
                # æ–°å¢è¿½è¹¤
                new_item = Watchlist(
                    user_id=user.id,
                    symbol=symbol,
                    asset_type=item.asset_type or "stock",
                    note=item.note,
                    target_price=item.target_price,
                )
                db.add(new_item)
                added.append(symbol)
                existing_symbols.add(symbol)
            except Exception as e:
                errors.append({"symbol": symbol, "error": str(e)})

        await db.commit()

        return {
            "success": True,
            "message": f"åŒ¯å…¥å®Œæˆï¼šæ–°å¢ {len(added)} ç­†ï¼Œè·³é {len(skipped)} ç­†",
            "data": {
                "added": added,
                "skipped": skipped,
                "errors": errors,
                "total_added": len(added),
                "total_skipped": len(skipped),
                "total_errors": len(errors),
            }
        }

    except Exception as e:
        logger.error(f"åŒ¯å…¥è¿½è¹¤æ¸…å–®å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# åƒ¹æ ¼å¿«å– APIï¼ˆâ­ å„ªåŒ–ç‰ˆï¼šåŒ…å«æ¨™ç±¤ï¼‰
# ============================================================

@router.get("/with-prices", summary="è¿½è¹¤æ¸…å–®ï¼ˆå«å³æ™‚åƒ¹æ ¼ï¼‰")
async def get_watchlist_with_prices(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶è¿½è¹¤æ¸…å–®ï¼ŒåŒ…å«å³æ™‚åƒ¹æ ¼ï¼ˆå¾å¿«å–è®€å–ï¼‰
    
    â­ æ•ˆèƒ½å„ªåŒ–ï¼šä¸€æ¬¡æ€§è¼‰å…¥æ‰€æœ‰æ¨™ç±¤ï¼Œæ¶ˆé™¤ N+1 å•é¡Œ
    
    - åƒ¹æ ¼ä¾†è‡ª stock_price_cache è¡¨
    - æ¯ 10 åˆ†é˜ç”±æ’ç¨‹æ›´æ–°
    - å›æ‡‰æ™‚é–“ï¼šæ¯«ç§’ç´š
    - åŒ…å«ç›®æ¨™åƒ¹åŠæ˜¯å¦é”æ¨™
    - åŒ…å«è©²é …ç›®çš„æ‰€æœ‰æ¨™ç±¤
    """
    logger.info(f"API: è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼) - user_id={user.id}")

    try:
        # 1. å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
        stmt = (
            select(Watchlist)
            .where(Watchlist.user_id == user.id)
            .order_by(Watchlist.added_at.desc())
        )
        result = await db.execute(stmt)
        watchlist_items = list(result.scalars().all())

        if not watchlist_items:
            return {
                "success": True,
                "data": [],
                "total": 0,
            }

        # 2. å–å¾—æ‰€æœ‰ symbol å’Œ watchlist_id
        symbols = [item.symbol for item in watchlist_items]
        watchlist_ids = [item.id for item in watchlist_items]

        # 3. å¾å¿«å–æ‰¹æ¬¡å–å¾—åƒ¹æ ¼
        cache_stmt = select(StockPriceCache).where(
            StockPriceCache.symbol.in_(symbols)
        )
        cache_result = await db.execute(cache_stmt)
        cache_map = {c.symbol: c for c in cache_result.scalars().all()}

        # 4. â­ æ‰¹æ¬¡å–å¾—æ‰€æœ‰æ¨™ç±¤é—œè¯ï¼ˆæ¶ˆé™¤ N+1 å•é¡Œï¼‰
        tags_map = {}
        try:
            tags_stmt = (
                select(
                    watchlist_tags.c.watchlist_id,
                    UserTag
                )
                .join(UserTag, UserTag.id == watchlist_tags.c.tag_id)
                .where(watchlist_tags.c.watchlist_id.in_(watchlist_ids))
            )
            tags_result = await db.execute(tags_stmt)
            
            # å»ºç«‹ watchlist_id -> tags çš„æ˜ å°„
            for row in tags_result:
                wl_id = row[0]
                tag = row[1]
                if wl_id not in tags_map:
                    tags_map[wl_id] = []
                tags_map[wl_id].append({
                    "id": tag.id,
                    "name": tag.name,
                    "color": tag.color,
                    "icon": tag.icon,
                })
        except Exception as e:
            logger.warning(f"è¼‰å…¥æ¨™ç±¤å¤±æ•—ï¼ˆå¯èƒ½æ˜¯æ–°ç³»çµ±å°šæœªå»ºç«‹æ¨™ç±¤è¡¨ï¼‰: {e}")
            # æ¨™ç±¤è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½

        # 5. çµ„åˆè³‡æ–™
        data = []
        for item in watchlist_items:
            cache = cache_map.get(item.symbol)
            
            # MA20 å€¼
            ma20_value = float(cache.ma20) if cache and cache.ma20 else None
            
            # ç›®æ¨™åƒ¹åˆ¤æ–·
            target_price = float(item.target_price) if item.target_price else None
            current_price = float(cache.price) if cache and cache.price else None
            target_reached = False
            
            if current_price and target_price:
                target_reached = current_price >= target_price

            data.append({
                "id": item.id,
                "symbol": item.symbol,
                "asset_type": item.asset_type,
                "note": item.note,
                "target_price": target_price,
                "target_reached": target_reached,
                "added_at": item.added_at.isoformat() if item.added_at else None,
                # åƒ¹æ ¼è³‡è¨Šï¼ˆå¾å¿«å–ï¼‰
                "name": cache.name if cache else None,
                "price": current_price,
                "change": float(cache.change) if cache and cache.change else None,
                "change_pct": float(cache.change_pct) if cache and cache.change_pct else None,
                "ma20": ma20_value,
                "price_updated_at": cache.updated_at.isoformat() if cache and cache.updated_at else None,
                # â­ æ¨™ç±¤è³‡è¨Šï¼ˆæ‰¹é‡è¼‰å…¥ï¼‰
                "tags": tags_map.get(item.id, []),
            })

        return {
            "success": True,
            "data": data,
            "total": len(data),
        }

    except Exception as e:
        logger.error(f"å–å¾—è¿½è¹¤æ¸…å–®(å«åƒ¹æ ¼)å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/cache-status", summary="å¿«å–ç‹€æ…‹")
async def get_cache_status(
    db: AsyncSession = Depends(get_async_session),
):
    """æŸ¥çœ‹åƒ¹æ ¼å¿«å–ç‹€æ…‹"""
    try:
        from app.services.price_cache_service import get_market_status

        stmt = select(StockPriceCache)
        result = await db.execute(stmt)
        all_cache = list(result.scalars().all())

        if not all_cache:
            return {
                "success": True,
                "total_cached": 0,
                "message": "å¿«å–ç‚ºç©ºï¼Œè«‹ç­‰å¾…æ’ç¨‹æ›´æ–°",
                "market_status": get_market_status(),
            }

        updates = [c.updated_at for c in all_cache if c.updated_at]
        tw_stocks = [c for c in all_cache if c.symbol.endswith(('.TW', '.TWO'))]
        us_stocks = [c for c in all_cache if c.asset_type == 'stock' and not c.symbol.endswith(('.TW', '.TWO'))]
        crypto = [c for c in all_cache if c.asset_type == 'crypto']

        return {
            "success": True,
            "total_cached": len(all_cache),
            "tw_stocks": len(tw_stocks),
            "us_stocks": len(us_stocks),
            "crypto": len(crypto),
            "oldest_update": min(updates).isoformat() if updates else None,
            "newest_update": max(updates).isoformat() if updates else None,
            "market_status": get_market_status(),
        }

    except Exception as e:
        logger.error(f"æŸ¥è©¢å¿«å–ç‹€æ…‹å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# ç›®æ¨™åƒ¹ API
# ============================================================

@router.put("/{item_id}/target-price", summary="è¨­å®šç›®æ¨™åƒ¹")
async def set_target_price(
    item_id: int,
    data: TargetPriceUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    è¨­å®šè¿½è¹¤æ¨™çš„çš„ç›®æ¨™åƒ¹æ ¼
    
    - è¨­å®šå¾Œï¼Œç•¶ç¾åƒ¹é”åˆ°æˆ–è¶…éç›®æ¨™åƒ¹æœƒè®Šè‰²æé†’
    - å‚³å…¥ null å¯æ¸…é™¤ç›®æ¨™åƒ¹
    """
    logger.info(f"API: è¨­å®šç›®æ¨™åƒ¹ - user_id={user.id}, item_id={item_id}, target={data.target_price}")

    try:
        # æŸ¥è©¢è©²è¿½è¹¤é …ç›®
        stmt = select(Watchlist).where(
            Watchlist.id == item_id,
            Watchlist.user_id == user.id
        )
        result = await db.execute(stmt)
        item = result.scalar_one_or_none()

        if not item:
            raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°è©²è¿½è¹¤é …ç›®")

        # æ›´æ–°ç›®æ¨™åƒ¹
        item.target_price = data.target_price
        await db.commit()

        return {
            "success": True,
            "message": "ç›®æ¨™åƒ¹å·²æ›´æ–°" if data.target_price else "ç›®æ¨™åƒ¹å·²æ¸…é™¤",
            "data": {
                "id": item.id,
                "symbol": item.symbol,
                "target_price": float(item.target_price) if item.target_price else None,
            }
        }

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"è¨­å®šç›®æ¨™åƒ¹å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


# ============================================================
# åŸæœ‰çš„ç«¯é»
# ============================================================

@router.get("", summary="å–å¾—è¿½è¹¤æ¸…å–®", response_model=WatchlistListResponse)
async def get_watchlist(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
    """
    logger.info(f"API: å–å¾—è¿½è¹¤æ¸…å–® - user_id={user.id}, line_id={user.line_user_id}")

    service = WatchlistService(db)
    items = await service.get_watchlist(user.id)

    return WatchlistListResponse(
        success=True,
        data=[WatchlistItem.model_validate(item) for item in items],
        total=len(items),
    )


@router.post("", summary="æ–°å¢è¿½è¹¤", response_model=WatchlistResponse)
async def add_to_watchlist(
    data: WatchlistAdd,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ–°å¢æ¨™çš„åˆ°è¿½è¹¤æ¸…å–®
    
    - **symbol**: è‚¡ç¥¨ä»£è™Ÿ (å¦‚ AAPL) æˆ–åŠ å¯†è²¨å¹£ (å¦‚ BTC)
    - **note**: è‡ªè¨‚å‚™è¨»ï¼ˆé¸å¡«ï¼‰
    """
    logger.info(f"API: æ–°å¢è¿½è¹¤ - user_id={user.id}, line_id={user.line_user_id}, symbol={data.symbol}")

    service = WatchlistService(db)
    result = await service.add_to_watchlist(
        user_id=user.id,
        symbol=data.symbol,
        note=data.note,
    )

    if not result["success"]:
        raise HTTPException(
            status_code=400,
            detail=result["message"]
        )

    return WatchlistResponse(
        success=True,
        message=result["message"],
        data=WatchlistItem.model_validate(result["watchlist"]),
    )


@router.delete("/{symbol}", summary="ç§»é™¤è¿½è¹¤", response_model=ResponseBase)
async def remove_from_watchlist(
    symbol: str,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å¾è¿½è¹¤æ¸…å–®ç§»é™¤æ¨™çš„
    """
    logger.info(f"API: ç§»é™¤è¿½è¹¤ - user_id={user.id}, line_id={user.line_user_id}, symbol={symbol}")

    service = WatchlistService(db)
    result = await service.remove_from_watchlist(
        user_id=user.id,
        symbol=symbol,
    )

    if not result["success"]:
        raise HTTPException(
            status_code=404,
            detail=result["message"]
        )

    return ResponseBase(
        success=True,
        message=result["message"],
    )


@router.put("/{symbol}", summary="æ›´æ–°å‚™è¨»", response_model=ResponseBase)
async def update_watchlist_note(
    symbol: str,
    data: WatchlistUpdate,
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    æ›´æ–°è¿½è¹¤æ¨™çš„çš„å‚™è¨»
    """
    logger.info(f"API: æ›´æ–°å‚™è¨» - user_id={user.id}, symbol={symbol}")

    service = WatchlistService(db)
    result = await service.update_note(
        user_id=user.id,
        symbol=symbol,
        note=data.note,
    )

    if not result["success"]:
        raise HTTPException(
            status_code=404,
            detail=result["message"]
        )

    return ResponseBase(
        success=True,
        message=result["message"],
    )


@router.get("/overview", summary="è¿½è¹¤æ¸…å–®ç¸½è¦½")
async def get_watchlist_overview(
    user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_async_session),
):
    """
    å–å¾—è¿½è¹¤æ¸…å–®ç¸½è¦½
    
    åŒ…å«æ‰€æœ‰è¿½è¹¤æ¨™çš„çš„åŸºæœ¬è³‡è¨Š
    """
    logger.info(f"API: è¿½è¹¤æ¸…å–®ç¸½è¦½ - user_id={user.id}, line_id={user.line_user_id}")

    service = WatchlistService(db)
    items = await service.get_watchlist(user.id)

    return {
        "success": True,
        "data": [
            {
                "id": item.id,
                "symbol": item.symbol,
                "asset_type": item.asset_type,
                "note": item.note,
                "target_price": float(item.target_price) if item.target_price else None,
                "added_at": item.added_at.isoformat() if item.added_at else None,
            }
            for item in items
        ],
        "total": len(items),
    }
```

======================================================================
## ğŸ“¦ è³‡æ–™æ¨¡å‹
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/database.py  â­â­
> è³‡æ–™åº«é€£ç·šèˆ‡ Session ç®¡ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è³‡æ–™åº«é€£ç·šèˆ‡ Session ç®¡ç†
æ”¯æ´ SQLite (é–‹ç™¼) å’Œ PostgreSQL (ç”Ÿç”¢)

ğŸ”§ ä¿®å¾©ç‰ˆæœ¬ - 2026-01-16
æ–°å¢ get_sync_db åˆ¥å

ğŸš€ æ•ˆèƒ½å„ªåŒ– - 2026-01-16
æ–°å¢ stock_prices æ­·å²è³‡æ–™è¡¨
"""
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.orm import declarative_base
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import NullPool

from app.config import settings


def get_async_url(url: str) -> str:
    """å°‡ä¸€èˆ¬çš„è³‡æ–™åº« URL è½‰æ›ç‚º async æ ¼å¼"""
    if url.startswith("sqlite:///") and "+aiosqlite" not in url:
        return url.replace("sqlite:///", "sqlite+aiosqlite:///")
    elif url.startswith("postgresql://") and "+asyncpg" not in url:
        return url.replace("postgresql://", "postgresql+asyncpg://")
    elif url.startswith("postgres://"):
        # Railway ä½¿ç”¨ postgres:// ä½† SQLAlchemy éœ€è¦ postgresql://
        return url.replace("postgres://", "postgresql+asyncpg://")
    return url


def get_sync_url(url: str) -> str:
    """ç¢ºä¿æ˜¯åŒæ­¥æ ¼å¼çš„ URL"""
    url = url.replace("+aiosqlite", "").replace("+asyncpg", "")
    # ä¿®æ­£ Railway çš„ postgres:// æ ¼å¼
    if url.startswith("postgres://"):
        url = url.replace("postgres://", "postgresql://")
    return url


def is_postgres(url: str) -> bool:
    """æª¢æŸ¥æ˜¯å¦ç‚º PostgreSQL"""
    return "postgresql" in url or "postgres" in url


# å–å¾—è³‡æ–™åº« URL
database_url = settings.DATABASE_URL

# éåŒæ­¥å¼•æ“ (FastAPI ç”¨)
async_database_url = get_async_url(database_url)

# PostgreSQL éœ€è¦ç‰¹åˆ¥çš„é€£ç·šæ± è¨­å®š
if is_postgres(database_url):
    async_engine = create_async_engine(
        async_database_url,
        echo=settings.DEBUG,
        poolclass=NullPool,  # Railway å»ºè­°ä½¿ç”¨ NullPool
    )
else:
    async_engine = create_async_engine(
        async_database_url,
        echo=settings.DEBUG,
    )

# éåŒæ­¥ Session
AsyncSessionLocal = async_sessionmaker(
    bind=async_engine,
    class_=AsyncSession,
    expire_on_commit=False,
)

# åŒæ­¥å¼•æ“ (CLI ç”¨)
sync_database_url = get_sync_url(database_url)

if is_postgres(database_url):
    sync_engine = create_engine(
        sync_database_url,
        echo=settings.DEBUG,
        poolclass=NullPool,
    )
else:
    sync_engine = create_engine(
        sync_database_url,
        echo=settings.DEBUG,
    )

# ============================================================
# ğŸ†• è‡ªå‹•è³‡æ–™åº«é·ç§»
# ============================================================
def run_auto_migrations():
    """å•Ÿå‹•æ™‚è‡ªå‹•åŸ·è¡Œè³‡æ–™åº«é·ç§»"""
    migrations = [
        # 2026-01-14: MA20 æ’åºåŠŸèƒ½
        {
            "name": "add_ma20_to_price_cache",
            "check_sql": "SELECT column_name FROM information_schema.columns WHERE table_name='stock_price_cache' AND column_name='ma20'",
            "migrate_sql": "ALTER TABLE stock_price_cache ADD COLUMN ma20 NUMERIC(12, 4)",
        },
        # 2026-01-14: è¨‚é–±ç²¾é¸åŠŸèƒ½ - è¨‚é–±æºè¡¨
        {
            "name": "create_subscription_sources",
            "check_sql": "SELECT table_name FROM information_schema.tables WHERE table_name='subscription_sources'",
            "migrate_sql": """
                CREATE TABLE subscription_sources (
                    id SERIAL PRIMARY KEY,
                    name VARCHAR(100) NOT NULL,
                    slug VARCHAR(50) UNIQUE NOT NULL,
                    url VARCHAR(500) NOT NULL,
                    type VARCHAR(20) DEFAULT 'substack',
                    description TEXT,
                    enabled BOOLEAN DEFAULT true,
                    last_fetched_at TIMESTAMP,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """,
        },
        # 2026-01-14: è¨‚é–±ç²¾é¸åŠŸèƒ½ - è‡ªå‹•ç²¾é¸è¡¨
        {
            "name": "create_auto_picks",
            "check_sql": "SELECT table_name FROM information_schema.tables WHERE table_name='auto_picks'",
            "migrate_sql": """
                CREATE TABLE auto_picks (
                    id SERIAL PRIMARY KEY,
                    source_id INTEGER REFERENCES subscription_sources(id),
                    symbol VARCHAR(20) NOT NULL,
                    article_url VARCHAR(500),
                    article_title VARCHAR(300),
                    article_date DATE,
                    first_seen_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_seen_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    expires_at TIMESTAMP,
                    mention_count INTEGER DEFAULT 1,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(source_id, symbol)
                )
            """,
        },
        # 2026-01-14: è¨‚é–±ç²¾é¸åŠŸèƒ½ - ç”¨æˆ¶è¨‚é–±è¡¨
        {
            "name": "create_user_subscriptions",
            "check_sql": "SELECT table_name FROM information_schema.tables WHERE table_name='user_subscriptions'",
            "migrate_sql": """
                CREATE TABLE user_subscriptions (
                    id SERIAL PRIMARY KEY,
                    user_id INTEGER REFERENCES users(id),
                    source_id INTEGER REFERENCES subscription_sources(id),
                    subscribed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(user_id, source_id)
                )
            """,
        },
        # 2026-01-15: P1 ç›®æ¨™åƒ¹åŠŸèƒ½
        {
            "name": "add_target_price_to_watchlists",
            "check_sql": "SELECT column_name FROM information_schema.columns WHERE table_name='watchlists' AND column_name='target_price'",
            "migrate_sql": "ALTER TABLE watchlists ADD COLUMN target_price NUMERIC(12, 4) DEFAULT NULL",
        },
        # ============================================================
        # ğŸš€ 2026-01-16: è‚¡ç¥¨æ­·å²è³‡æ–™å¿«å–è¡¨ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰
        # ============================================================
        {
            "name": "create_stock_prices",
            "check_sql": "SELECT table_name FROM information_schema.tables WHERE table_name='stock_prices'",
            "migrate_sql": """
                CREATE TABLE stock_prices (
                    id SERIAL PRIMARY KEY,
                    symbol VARCHAR(20) NOT NULL,
                    date DATE NOT NULL,
                    open NUMERIC(12, 4),
                    high NUMERIC(12, 4),
                    low NUMERIC(12, 4),
                    close NUMERIC(12, 4),
                    volume BIGINT,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(symbol, date)
                )
            """,
        },
        {
            "name": "create_stock_prices_symbol_index",
            "check_sql": "SELECT indexname FROM pg_indexes WHERE indexname='idx_stock_prices_symbol'",
            "migrate_sql": "CREATE INDEX idx_stock_prices_symbol ON stock_prices(symbol)",
        },
        {
            "name": "create_stock_prices_date_index",
            "check_sql": "SELECT indexname FROM pg_indexes WHERE indexname='idx_stock_prices_date'",
            "migrate_sql": "CREATE INDEX idx_stock_prices_date ON stock_prices(date)",
        },
    ]
    
    try:
        with sync_engine.connect() as conn:
            for migration in migrations:
                try:
                    result = conn.execute(text(migration["check_sql"])).fetchone()
                    if not result:
                        conn.execute(text(migration["migrate_sql"]))
                        conn.commit()
                        print(f"âœ… Migration: {migration['name']} completed")
                except Exception as e:
                    print(f"âš ï¸ Migration {migration['name']} skipped: {e}")
    except Exception as e:
        print(f"âš ï¸ Auto migration warning: {e}")

# å•Ÿå‹•æ™‚åŸ·è¡Œé·ç§»
run_auto_migrations()
# ============================================================

# åŒæ­¥ Session
SyncSessionLocal = sessionmaker(
    bind=sync_engine,
    autocommit=False,
    autoflush=False,
)

# ç‚ºäº†å‘å¾Œç›¸å®¹ï¼Œä¿ç•™ SessionLocal åˆ¥å
SessionLocal = SyncSessionLocal

# ORM Base
Base = declarative_base()


async def get_async_session():
    """FastAPI ä¾è³´æ³¨å…¥ç”¨"""
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:
            await session.close()


def get_sync_session():
    """CLI ç”¨åŒæ­¥ Session"""
    session = SyncSessionLocal()
    try:
        return session
    except Exception:
        session.close()
        raise


async def init_db():
    """åˆå§‹åŒ–è³‡æ–™åº«ï¼ˆå»ºç«‹æ‰€æœ‰è¡¨æ ¼ï¼‰"""
    async with async_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


def init_db_sync():
    """åŒæ­¥åˆå§‹åŒ–è³‡æ–™åº«"""
    Base.metadata.create_all(bind=sync_engine)


# FastAPI ä¾è³´æ³¨å…¥ç”¨ï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼Œç”¨æ–¼æŸäº› APIï¼‰
def get_db():
    """FastAPI ä¾è³´æ³¨å…¥ç”¨ï¼ˆåŒæ­¥ Sessionï¼‰"""
    db = SyncSessionLocal()
    try:
        yield db
    finally:
        db.close()


# ============================================================
# ğŸ†• æ–°å¢åˆ¥å - ä¿®å¾© stock.py ImportError
# ============================================================
get_sync_db = get_db
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/__init__.py  â­â­
> è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è³‡æ–™æ¨¡å‹
"""
from app.models.stock_price import StockPrice
from app.models.crypto_price import CryptoPrice
from app.models.market_sentiment import MarketSentiment
from app.models.user import User, LoginLog, TokenBlacklist, SystemConfig
from app.models.watchlist import Watchlist
from app.models.user_settings import (
    UserIndicatorSettings,
    UserAlertSettings,
    UserIndicatorParams,
)
from app.models.notification import Notification
from app.models.index_price import IndexPrice, INDEX_SYMBOLS
from app.models.dividend_history import DividendHistory
from app.models.comparison import Comparison
from app.models.price_cache import StockPriceCache
from app.models.portfolio import PortfolioTransaction, PortfolioHolding, ExchangeRate

# ğŸ·ï¸ P1: æ¨™ç±¤åŠŸèƒ½ - å¿…é ˆåœ¨ Watchlist ä¹‹å¾Œ import
from app.models.watchlist_tag import UserTag, watchlist_tags

# ğŸ“Š P1: è‚¡ç¥¨è³‡è¨Šç¨®å­è¡¨
from app.models.stock_info import StockInfo

__all__ = [
    "StockPrice",
    "CryptoPrice", 
    "MarketSentiment",
    "User",
    "LoginLog",
    "TokenBlacklist",
    "SystemConfig",
    "Watchlist",
    "UserIndicatorSettings",
    "UserAlertSettings",
    "UserIndicatorParams",
    "Notification",
    "IndexPrice",
    "INDEX_SYMBOLS",
    "DividendHistory",
    "Comparison",
    "StockPriceCache",
    "PortfolioTransaction",
    "PortfolioHolding",
    "ExchangeRate",
    # P1
    "UserTag",
    "watchlist_tags",
    "StockInfo",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/comparison.py  â­â­
> å ±é…¬ç‡æ¯”è¼ƒçµ„åˆ Model
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å ±é…¬ç‡æ¯”è¼ƒçµ„åˆ Model
å„²å­˜ç”¨æˆ¶çš„è‡ªè¨‚æ¯”è¼ƒçµ„åˆ
"""
from datetime import datetime
from typing import List, Optional
import json

from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Text
from sqlalchemy.orm import relationship

from app.database import Base


class Comparison(Base):
    """ç”¨æˆ¶å„²å­˜çš„æ¯”è¼ƒçµ„åˆ"""
    __tablename__ = "comparisons"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    name = Column(String(100), nullable=False)  # çµ„åˆåç¨±
    symbols_json = Column(Text, nullable=False)  # JSON æ ¼å¼å„²å­˜ ["AAPL","MSFT"]
    benchmark = Column(String(20), nullable=True, default="^GSPC")  # åŸºæº–æŒ‡æ•¸
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # é—œè¯
    user = relationship("User", backref="comparisons")
    
    @property
    def symbols(self) -> List[str]:
        """å–å¾—æ¨™çš„åˆ—è¡¨"""
        try:
            return json.loads(self.symbols_json)
        except (json.JSONDecodeError, TypeError):
            return []
    
    @symbols.setter
    def symbols(self, value: List[str]):
        """è¨­å®šæ¨™çš„åˆ—è¡¨"""
        self.symbols_json = json.dumps(value)
    
    def to_dict(self) -> dict:
        """è½‰æ›ç‚ºå­—å…¸"""
        return {
            "id": self.id,
            "user_id": self.user_id,
            "name": self.name,
            "symbols": self.symbols,
            "benchmark": self.benchmark,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
    
    def __repr__(self):
        return f"<Comparison(id={self.id}, name='{self.name}', symbols={self.symbols})>"
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/crypto_price.py  â­â­
> åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class CryptoPrice(Base):
    """åŠ å¯†è²¨å¹£åƒ¹æ ¼æ­·å²"""
    
    __tablename__ = "crypto_prices"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)  # BTC, ETH
    date = Column(Date, nullable=False, index=True)
    price = Column(Numeric(18, 8))  # USD åƒ¹æ ¼
    volume_24h = Column(Numeric(18, 2))  # 24 å°æ™‚æˆäº¤é‡
    market_cap = Column(Numeric(18, 2))  # å¸‚å€¼
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_crypto_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<CryptoPrice(symbol={self.symbol}, date={self.date}, price={self.price})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "date": self.date.isoformat() if self.date else None,
            "price": float(self.price) if self.price else None,
            "volume_24h": float(self.volume_24h) if self.volume_24h else None,
            "market_cap": float(self.market_cap) if self.market_cap else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/dividend_history.py  â­â­
> è‚¡ç¥¨é…æ¯æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨é…æ¯æ­·å²è³‡æ–™æ¨¡å‹
ç”¨æ–¼è¨ˆç®—å«æ¯å¹´åŒ–å ±é…¬ç‡
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class DividendHistory(Base):
    """è‚¡ç¥¨é…æ¯æ­·å²"""
    
    __tablename__ = "dividend_history"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)
    date = Column(Date, nullable=False, index=True)  # é™¤æ¯æ—¥
    amount = Column(Numeric(10, 4), nullable=False)  # æ¯è‚¡é…æ¯é‡‘é¡
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_dividend_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<DividendHistory(symbol={self.symbol}, date={self.date}, amount={self.amount})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "date": self.date.isoformat() if self.date else None,
            "amount": float(self.amount) if self.amount else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/index_price.py  â­â­
> å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
æ”¯æ´ S&P 500, é“ç“Š, ç´æ–¯é”å…‹, å°è‚¡åŠ æ¬Š
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, BigInteger, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


# æŒ‡æ•¸ä»£è™Ÿå°ç…§
INDEX_SYMBOLS = {
    "^GSPC": {"name": "S&P 500", "name_zh": "æ¨™æ™®500"},
    "^DJI": {"name": "Dow Jones", "name_zh": "é“ç“Šå·¥æ¥­"},
    "^IXIC": {"name": "NASDAQ", "name_zh": "ç´æ–¯é”å…‹"},
    "^TWII": {"name": "TAIEX", "name_zh": "å°è‚¡åŠ æ¬Š"},
}


class IndexPrice(Base):
    """å¸‚å ´æŒ‡æ•¸åƒ¹æ ¼æ­·å²"""
    
    __tablename__ = "index_prices"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)  # ^GSPC, ^DJI, ^IXIC
    name = Column(String(50))  # S&P 500, Dow Jones, NASDAQ
    date = Column(Date, nullable=False, index=True)
    open = Column(Numeric(12, 2))
    high = Column(Numeric(12, 2))
    low = Column(Numeric(12, 2))
    close = Column(Numeric(12, 2))
    volume = Column(BigInteger)
    change = Column(Numeric(10, 2))  # æ¼²è·Œé»æ•¸
    change_pct = Column(Numeric(6, 2))  # æ¼²è·Œå¹… %
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_index_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<IndexPrice(symbol={self.symbol}, date={self.date}, close={self.close})>"
    
    @property
    def name_zh(self) -> str:
        """å–å¾—ä¸­æ–‡åç¨±"""
        info = INDEX_SYMBOLS.get(self.symbol, {})
        return info.get("name_zh", self.name or self.symbol)
    
    def to_dict(self):
        def safe_float(val):
            """å®‰å…¨è½‰æ› floatï¼Œè™•ç† NaN å’Œ Infinity"""
            if val is None:
                return None
            try:
                f = float(val)
                # æª¢æŸ¥ NaN å’Œ Infinity
                import math
                if math.isnan(f) or math.isinf(f):
                    return None
                return f
            except (ValueError, TypeError):
                return None
        
        return {
            "id": self.id,
            "symbol": self.symbol,
            "name": self.name,
            "name_zh": self.name_zh,
            "date": self.date.isoformat() if self.date else None,
            "open": safe_float(self.open),
            "high": safe_float(self.high),
            "low": safe_float(self.low),
            "close": safe_float(self.close),
            "volume": self.volume,
            "change": safe_float(self.change),
            "change_pct": safe_float(self.change_pct),
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/market_sentiment.py  â­â­
> å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class MarketSentiment(Base):
    """å¸‚å ´æƒ…ç·’æŒ‡æ•¸"""
    
    __tablename__ = "market_sentiment"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    date = Column(Date, nullable=False, index=True)
    market = Column(String(10), nullable=False)  # stock / crypto
    value = Column(Integer)  # 0-100
    classification = Column(String(20))  # extreme_fear, fear, neutral, greed, extreme_greed
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_sentiment_market_date', 'market', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<MarketSentiment(market={self.market}, date={self.date}, value={self.value})>"
    
    @staticmethod
    def get_classification(value: int) -> str:
        """æ ¹æ“šæ•¸å€¼å–å¾—åˆ†é¡"""
        if value <= 25:
            return "extreme_fear"
        elif value <= 45:
            return "fear"
        elif value <= 55:
            return "neutral"
        elif value <= 75:
            return "greed"
        else:
            return "extreme_greed"
    
    @staticmethod
    def get_classification_zh(value: int) -> str:
        """æ ¹æ“šæ•¸å€¼å–å¾—ä¸­æ–‡åˆ†é¡"""
        if value <= 25:
            return "æ¥µåº¦ææ‡¼"
        elif value <= 45:
            return "ææ‡¼"
        elif value <= 55:
            return "ä¸­æ€§"
        elif value <= 75:
            return "è²ªå©ª"
        else:
            return "æ¥µåº¦è²ªå©ª"
    
    def to_dict(self):
        return {
            "id": self.id,
            "date": self.date.isoformat() if self.date else None,
            "market": self.market,
            "value": self.value,
            "classification": self.classification,
            "classification_zh": self.get_classification_zh(self.value) if self.value else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/notification.py  â­â­
> é€šçŸ¥è¨˜éŒ„è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
é€šçŸ¥è¨˜éŒ„è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Boolean, Numeric, Text, Index
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base


class Notification(Base):
    """é€šçŸ¥è¨˜éŒ„"""
    
    __tablename__ = "notifications"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(10), nullable=False)
    asset_type = Column(String(10), nullable=False)  # stock / crypto
    alert_type = Column(String(30), nullable=False)  # é€šçŸ¥é¡å‹
    indicator = Column(String(20))  # ç›¸é—œæŒ‡æ¨™
    message = Column(Text)  # é€šçŸ¥å…§å®¹
    price_at_trigger = Column(Numeric(18, 8))  # è§¸ç™¼æ™‚åƒ¹æ ¼
    triggered_at = Column(DateTime, server_default=func.now())
    sent = Column(Boolean, default=False)  # æ˜¯å¦å·²ç™¼é€
    sent_at = Column(DateTime)  # ç™¼é€æ™‚é–“
    
    # é—œè¯
    user = relationship("User")
    
    __table_args__ = (
        Index('idx_notification_user', 'user_id'),
        Index('idx_notification_symbol', 'symbol'),
        Index('idx_notification_triggered', 'triggered_at'),
    )
    
    # é€šçŸ¥é¡å‹å¸¸æ•¸
    ALERT_TYPES = {
        "ma_golden_cross": "å‡ç·šé»ƒé‡‘äº¤å‰",
        "ma_death_cross": "å‡ç·šæ­»äº¡äº¤å‰",
        "approaching_breakout": "æ¥è¿‘å‘ä¸Šçªç ´",
        "approaching_breakdown": "æ¥è¿‘å‘ä¸‹è·Œç ´",
        "breakout": "å·²çªç ´",
        "breakdown": "å·²è·Œç ´",
        "rsi_overbought": "RSI è¶…è²·",
        "rsi_oversold": "RSI è¶…è³£",
        "macd_golden_cross": "MACD é»ƒé‡‘äº¤å‰",
        "macd_death_cross": "MACD æ­»äº¡äº¤å‰",
        "kd_golden_cross": "KD é»ƒé‡‘äº¤å‰",
        "kd_death_cross": "KD æ­»äº¡äº¤å‰",
        "bollinger_breakout": "å¸ƒæ—ä¸Šè»Œçªç ´",
        "bollinger_breakdown": "å¸ƒæ—ä¸‹è»Œè·Œç ´",
        "volume_surge": "æˆäº¤é‡æš´å¢",
        "sentiment_extreme_fear": "æ¥µåº¦ææ‡¼",
        "sentiment_extreme_greed": "æ¥µåº¦è²ªå©ª",
    }
    
    def __repr__(self):
        return f"<Notification(user_id={self.user_id}, symbol={self.symbol}, alert_type={self.alert_type})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "asset_type": self.asset_type,
            "alert_type": self.alert_type,
            "alert_type_zh": self.ALERT_TYPES.get(self.alert_type, self.alert_type),
            "indicator": self.indicator,
            "message": self.message,
            "price_at_trigger": float(self.price_at_trigger) if self.price_at_trigger else None,
            "triggered_at": self.triggered_at.isoformat() if self.triggered_at else None,
            "sent": self.sent,
            "sent_at": self.sent_at.isoformat() if self.sent_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/portfolio.py  â­â­
> å€‹äººæŠ•è³‡è¨˜éŒ„æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å€‹äººæŠ•è³‡è¨˜éŒ„æ¨¡å‹
ç”¨æ–¼è¨˜éŒ„ç”¨æˆ¶çš„è‚¡ç¥¨è²·è³£äº¤æ˜“åŠåŒ¯ç‡
"""
from datetime import date, datetime
from decimal import Decimal
from typing import Optional

from sqlalchemy import Column, Integer, String, Date, Numeric, DateTime, ForeignKey, Index, Text, Float
from sqlalchemy.sql import func

from app.database import Base


class PortfolioTransaction(Base):
    """äº¤æ˜“ç´€éŒ„"""
    
    __tablename__ = "portfolio_transactions"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    
    # è‚¡ç¥¨è³‡è¨Š
    symbol = Column(String(20), nullable=False)           # è‚¡ç¥¨ä»£ç¢¼
    name = Column(String(100))                            # è‚¡ç¥¨åç¨±
    market = Column(String(10), nullable=False)           # tw / us
    
    # äº¤æ˜“è³‡è¨Š
    transaction_type = Column(String(10), nullable=False) # buy / sell
    quantity = Column(Integer, nullable=False)            # ç¸½è‚¡æ•¸ï¼ˆå°è‚¡ï¼šå¼µÃ—1000 + é›¶è‚¡ï¼‰
    price = Column(Numeric(12, 4), nullable=False)        # æˆäº¤åƒ¹
    fee = Column(Numeric(10, 2), default=0)               # æ‰‹çºŒè²»
    tax = Column(Numeric(10, 2), default=0)               # äº¤æ˜“ç¨…ï¼ˆè³£å‡ºæ™‚ï¼‰
    transaction_date = Column(Date, nullable=False)       # äº¤æ˜“æ—¥æœŸ
    
    # å‚™è¨»
    note = Column(Text)
    
    # æ™‚é–“æˆ³
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    # ç´¢å¼•
    __table_args__ = (
        Index('idx_portfolio_user', 'user_id'),
        Index('idx_portfolio_symbol', 'symbol'),
        Index('idx_portfolio_market', 'market'),
        Index('idx_portfolio_date', 'transaction_date'),
        Index('idx_portfolio_user_symbol', 'user_id', 'symbol'),
    )
    
    @property
    def total_amount(self) -> float:
        """äº¤æ˜“ç¸½é¡ï¼ˆä¸å«æ‰‹çºŒè²»ï¼‰"""
        return float(self.quantity) * float(self.price)
    
    @property
    def total_cost(self) -> float:
        """ç¸½æˆæœ¬ï¼ˆå«æ‰‹çºŒè²»ã€ç¨…ï¼‰"""
        base = self.total_amount
        fee = float(self.fee or 0)
        tax = float(self.tax or 0)
        
        if self.transaction_type == "buy":
            return base + fee
        else:  # sell
            return base - fee - tax
    
    def format_quantity_display(self) -> str:
        """æ ¼å¼åŒ–é¡¯ç¤ºè‚¡æ•¸ï¼ˆå°è‚¡é¡¯ç¤ºå¼µ+é›¶è‚¡ï¼‰"""
        if self.market == 'tw':
            lots = self.quantity // 1000
            odd = self.quantity % 1000
            if lots > 0 and odd > 0:
                return f"{lots}å¼µ{odd}è‚¡"
            elif lots > 0:
                return f"{lots}å¼µ"
            else:
                return f"{odd}è‚¡"
        else:
            return f"{self.quantity}è‚¡"
    
    def to_dict(self) -> dict:
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "name": self.name,
            "market": self.market,
            "transaction_type": self.transaction_type,
            "quantity": self.quantity,
            "quantity_display": self.format_quantity_display(),
            "price": float(self.price),
            "fee": float(self.fee or 0),
            "tax": float(self.tax or 0),
            "total_amount": self.total_amount,
            "total_cost": self.total_cost,
            "transaction_date": self.transaction_date.isoformat() if self.transaction_date else None,
            "note": self.note,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }


class PortfolioHolding(Base):
    """
    æŒè‚¡å½™ç¸½
    ç”±äº¤æ˜“ç´€éŒ„è¨ˆç®—è€Œä¾†ï¼Œç”¨æ–¼å¿«é€ŸæŸ¥è©¢
    """
    
    __tablename__ = "portfolio_holdings"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(20), nullable=False)
    name = Column(String(100))
    market = Column(String(10), nullable=False)
    
    # æŒè‚¡è³‡è¨Š
    total_shares = Column(Integer, default=0)              # ç¸½æŒè‚¡
    avg_cost = Column(Numeric(12, 4), default=0)           # å¹³å‡æˆæœ¬
    total_invested = Column(Numeric(14, 2), default=0)     # ç¸½æŠ•å…¥é‡‘é¡
    realized_profit = Column(Numeric(14, 2), default=0)    # å·²å¯¦ç¾æç›Š
    
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_holding_user_symbol', 'user_id', 'symbol', 'market', unique=True),
        Index('idx_holding_user', 'user_id'),
    )
    
    def format_quantity_display(self) -> str:
        """æ ¼å¼åŒ–é¡¯ç¤ºè‚¡æ•¸ï¼ˆå°è‚¡é¡¯ç¤ºå¼µ+é›¶è‚¡ï¼‰"""
        if self.market == 'tw':
            lots = self.total_shares // 1000
            odd = self.total_shares % 1000
            if lots > 0 and odd > 0:
                return f"{lots}å¼µ{odd}è‚¡"
            elif lots > 0:
                return f"{lots}å¼µ"
            else:
                return f"{odd}è‚¡"
        else:
            return f"{self.total_shares}è‚¡"
    
    def to_dict(self) -> dict:
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "name": self.name,
            "market": self.market,
            "total_shares": self.total_shares,
            "quantity_display": self.format_quantity_display(),
            "avg_cost": float(self.avg_cost) if self.avg_cost else 0,
            "total_invested": float(self.total_invested) if self.total_invested else 0,
            "realized_profit": float(self.realized_profit) if self.realized_profit else 0,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }


class ExchangeRate(Base):
    """åŒ¯ç‡è¡¨"""
    
    __tablename__ = "exchange_rates"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    from_currency = Column(String(10), nullable=False)    # USD
    to_currency = Column(String(10), nullable=False)      # TWD
    rate = Column(Float, nullable=False)                  # åŒ¯ç‡
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_exchange_pair', 'from_currency', 'to_currency', unique=True),
    )
    
    def to_dict(self) -> dict:
        return {
            "from_currency": self.from_currency,
            "to_currency": self.to_currency,
            "rate": self.rate,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/price_cache.py  â­â­
> è‚¡ç¥¨åƒ¹æ ¼å¿«å– Model
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨åƒ¹æ ¼å¿«å– Model
ç”¨æ–¼è¿½è¹¤æ¸…å–®çš„å³æ™‚åƒ¹æ ¼é¡¯ç¤ºï¼ˆå…¨ç³»çµ±å…±ç”¨ï¼‰

æ›´æ–°ï¼šåŠ å…¥ MA20 æ¬„ä½æ”¯æ´æ’åºåŠŸèƒ½
"""
from sqlalchemy import Column, String, Numeric, BigInteger, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class StockPriceCache(Base):
    """
    è‚¡ç¥¨å³æ™‚åƒ¹æ ¼å¿«å–
    
    - å…¨ç³»çµ±å…±ç”¨ï¼Œä¸åˆ†ç”¨æˆ¶
    - æ¯ 10 åˆ†é˜ç”±æ’ç¨‹æ‰¹æ¬¡æ›´æ–°
    - è¿½è¹¤æ¸…å–®é é¢ç›´æ¥å¾é€™è£¡è®€å–
    """
    
    __tablename__ = "stock_price_cache"
    
    # ä¸»éµï¼šè‚¡ç¥¨ä»£è™Ÿï¼ˆå¦‚ 0050.TW, AAPLï¼‰
    symbol = Column(String(20), primary_key=True)
    
    # è‚¡ç¥¨åç¨±
    name = Column(String(100))
    
    # åƒ¹æ ¼è³‡è¨Š
    price = Column(Numeric(12, 4))           # æœ€æ–°åƒ¹æ ¼
    prev_close = Column(Numeric(12, 4))      # å‰æ”¶ç›¤åƒ¹ï¼ˆç”¨æ–¼è¨ˆç®—æ¼²è·Œï¼‰
    change = Column(Numeric(12, 4))          # æ¼²è·Œé‡‘é¡
    change_pct = Column(Numeric(8, 4))       # æ¼²è·Œå¹… %
    
    # ğŸ†• æŠ€è¡“æŒ‡æ¨™ï¼ˆç”¨æ–¼æ’åºï¼‰
    ma20 = Column(Numeric(12, 4))            # 20æ—¥å‡ç·š
    
    # æˆäº¤é‡
    volume = Column(BigInteger)
    
    # è³‡ç”¢é¡å‹ï¼šstock / crypto
    asset_type = Column(String(10), default="stock")
    
    # æ›´æ–°æ™‚é–“
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_cache_asset_type', 'asset_type'),
        Index('idx_cache_updated', 'updated_at'),
    )
    
    def __repr__(self):
        return f"<StockPriceCache(symbol={self.symbol}, price={self.price}, change_pct={self.change_pct}%)>"
    
    def to_dict(self):
        return {
            "symbol": self.symbol,
            "name": self.name,
            "price": float(self.price) if self.price else None,
            "prev_close": float(self.prev_close) if self.prev_close else None,
            "change": float(self.change) if self.change else None,
            "change_pct": float(self.change_pct) if self.change_pct else None,
            "ma20": float(self.ma20) if self.ma20 else None,
            "volume": self.volume,
            "asset_type": self.asset_type,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/stock_info.py  â­â­
> è‚¡ç¥¨åŸºæœ¬è³‡è¨Šè¡¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨åŸºæœ¬è³‡è¨Šè¡¨
=============
å„²å­˜è‚¡ç¥¨çš„åŸºæœ¬è³‡è¨Šï¼Œç”¨æ–¼æœå°‹å’Œé¡¯ç¤º

P1 åŠŸèƒ½ï¼šstock_info ç¨®å­è¡¨
"""
from sqlalchemy import Column, Integer, String, Float, DateTime, Boolean, Index, Text
from datetime import datetime

from app.database import Base


class StockInfo(Base):
    """è‚¡ç¥¨åŸºæœ¬è³‡è¨Šè¡¨"""
    
    __tablename__ = "stock_info"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    
    # åŸºæœ¬è³‡è¨Š
    symbol = Column(String(20), unique=True, nullable=False, index=True)
    name = Column(String(100))                    # è‚¡ç¥¨åç¨±
    name_zh = Column(String(100))                 # ä¸­æ–‡åç¨±
    
    # å¸‚å ´åˆ†é¡
    market = Column(String(10), default="us")     # us, tw, crypto
    exchange = Column(String(20))                 # NYSE, NASDAQ, TWSE, TPEx
    sector = Column(String(50))                   # ç”¢æ¥­é¡åˆ¥
    industry = Column(String(50))                 # ç”¢æ¥­ç´°åˆ†
    
    # åŸºæœ¬æ•¸æ“š
    market_cap = Column(Float)                    # å¸‚å€¼
    pe_ratio = Column(Float)                      # æœ¬ç›Šæ¯”
    dividend_yield = Column(Float)                # æ®–åˆ©ç‡
    
    # æè¿°
    description = Column(Text)                    # å…¬å¸æè¿°
    website = Column(String(200))                 # å®˜ç¶²
    logo_url = Column(String(300))                # Logo URL
    
    # ç‹€æ…‹
    is_active = Column(Boolean, default=True)     # æ˜¯å¦æœ‰æ•ˆ
    is_popular = Column(Boolean, default=False)   # æ˜¯å¦ç†±é–€
    
    # æ™‚é–“æˆ³
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # ç´¢å¼•
    __table_args__ = (
        Index('idx_stock_info_market', 'market'),
        Index('idx_stock_info_sector', 'sector'),
        Index('idx_stock_info_popular', 'is_popular'),
    )
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "name": self.name,
            "name_zh": self.name_zh,
            "market": self.market,
            "exchange": self.exchange,
            "sector": self.sector,
            "industry": self.industry,
            "market_cap": self.market_cap,
            "pe_ratio": self.pe_ratio,
            "dividend_yield": self.dividend_yield,
            "description": self.description,
            "website": self.website,
            "logo_url": self.logo_url,
            "is_active": self.is_active,
            "is_popular": self.is_popular,
        }
    
    def __repr__(self):
        return f"<StockInfo {self.symbol}: {self.name}>"


# ============================================================
# é è¨­ç¨®å­è³‡æ–™
# ============================================================

DEFAULT_STOCK_INFO = [
    # ç¾è‚¡ - ç§‘æŠ€å·¨é ­
    {"symbol": "AAPL", "name": "Apple Inc.", "name_zh": "è˜‹æœ", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "MSFT", "name": "Microsoft Corporation", "name_zh": "å¾®è»Ÿ", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "GOOGL", "name": "Alphabet Inc.", "name_zh": "Google", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "AMZN", "name": "Amazon.com Inc.", "name_zh": "äºé¦¬éœ", "market": "us", "exchange": "NASDAQ", "sector": "Consumer Cyclical", "is_popular": True},
    {"symbol": "NVDA", "name": "NVIDIA Corporation", "name_zh": "è¼é”", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "META", "name": "Meta Platforms Inc.", "name_zh": "Meta", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "TSLA", "name": "Tesla Inc.", "name_zh": "ç‰¹æ–¯æ‹‰", "market": "us", "exchange": "NASDAQ", "sector": "Consumer Cyclical", "is_popular": True},
    
    # ç¾è‚¡ - é‡‘è
    {"symbol": "JPM", "name": "JPMorgan Chase & Co.", "name_zh": "æ‘©æ ¹å¤§é€š", "market": "us", "exchange": "NYSE", "sector": "Financial Services", "is_popular": True},
    {"symbol": "V", "name": "Visa Inc.", "name_zh": "Visa", "market": "us", "exchange": "NYSE", "sector": "Financial Services", "is_popular": True},
    {"symbol": "MA", "name": "Mastercard Inc.", "name_zh": "è¬äº‹é”å¡", "market": "us", "exchange": "NYSE", "sector": "Financial Services", "is_popular": True},
    
    # ç¾è‚¡ - åŠå°é«”
    {"symbol": "AMD", "name": "Advanced Micro Devices", "name_zh": "è¶…å¾®", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "INTC", "name": "Intel Corporation", "name_zh": "è‹±ç‰¹çˆ¾", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "AVGO", "name": "Broadcom Inc.", "name_zh": "åšé€š", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    
    # å°è‚¡ - åŠå°é«”
    {"symbol": "2330.TW", "name": "Taiwan Semiconductor", "name_zh": "å°ç©é›»", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    {"symbol": "2454.TW", "name": "MediaTek Inc.", "name_zh": "è¯ç™¼ç§‘", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    {"symbol": "2303.TW", "name": "United Microelectronics", "name_zh": "è¯é›»", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    {"symbol": "3711.TW", "name": "ASE Technology", "name_zh": "æ—¥æœˆå…‰æŠ•æ§", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    
    # å°è‚¡ - é›»å­ä»£å·¥
    {"symbol": "2317.TW", "name": "Hon Hai Precision", "name_zh": "é´»æµ·", "market": "tw", "exchange": "TWSE", "sector": "é›»å­", "is_popular": True},
    {"symbol": "2382.TW", "name": "Quanta Computer", "name_zh": "å»£é”", "market": "tw", "exchange": "TWSE", "sector": "é›»å­", "is_popular": True},
    {"symbol": "2357.TW", "name": "Asustek Computer", "name_zh": "è¯ç¢©", "market": "tw", "exchange": "TWSE", "sector": "é›»å­", "is_popular": True},
    
    # å°è‚¡ - é‡‘è
    {"symbol": "2881.TW", "name": "Fubon Financial", "name_zh": "å¯Œé‚¦é‡‘", "market": "tw", "exchange": "TWSE", "sector": "é‡‘è", "is_popular": True},
    {"symbol": "2882.TW", "name": "Cathay Financial", "name_zh": "åœ‹æ³°é‡‘", "market": "tw", "exchange": "TWSE", "sector": "é‡‘è", "is_popular": True},
    {"symbol": "2884.TW", "name": "E.Sun Financial", "name_zh": "ç‰å±±é‡‘", "market": "tw", "exchange": "TWSE", "sector": "é‡‘è", "is_popular": True},
    
    # å°è‚¡ - ETF
    {"symbol": "0050.TW", "name": "Yuanta Taiwan 50 ETF", "name_zh": "å…ƒå¤§å°ç£50", "market": "tw", "exchange": "TWSE", "sector": "ETF", "is_popular": True},
    {"symbol": "0056.TW", "name": "Yuanta High Dividend ETF", "name_zh": "å…ƒå¤§é«˜è‚¡æ¯", "market": "tw", "exchange": "TWSE", "sector": "ETF", "is_popular": True},
    {"symbol": "00878.TW", "name": "Cathay ESG High Dividend ETF", "name_zh": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯", "market": "tw", "exchange": "TWSE", "sector": "ETF", "is_popular": True},
    
    # åŠ å¯†è²¨å¹£
    {"symbol": "BTC", "name": "Bitcoin", "name_zh": "æ¯”ç‰¹å¹£", "market": "crypto", "exchange": "CoinGecko", "sector": "Cryptocurrency", "is_popular": True},
    {"symbol": "ETH", "name": "Ethereum", "name_zh": "ä»¥å¤ªåŠ", "market": "crypto", "exchange": "CoinGecko", "sector": "Cryptocurrency", "is_popular": True},
    {"symbol": "SOL", "name": "Solana", "name_zh": "ç´¢æ‹‰ç´", "market": "crypto", "exchange": "CoinGecko", "sector": "Cryptocurrency", "is_popular": True},
    
    # æŒ‡æ•¸
    {"symbol": "^GSPC", "name": "S&P 500", "name_zh": "æ¨™æ™®500", "market": "us", "exchange": "INDEX", "sector": "Index", "is_popular": True},
    {"symbol": "^DJI", "name": "Dow Jones Industrial Average", "name_zh": "é“ç“Šå·¥æ¥­", "market": "us", "exchange": "INDEX", "sector": "Index", "is_popular": True},
    {"symbol": "^IXIC", "name": "NASDAQ Composite", "name_zh": "ç´æ–¯é”å…‹", "market": "us", "exchange": "INDEX", "sector": "Index", "is_popular": True},
    {"symbol": "^TWII", "name": "Taiwan Weighted Index", "name_zh": "å°ç£åŠ æ¬Š", "market": "tw", "exchange": "INDEX", "sector": "Index", "is_popular": True},
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/stock_price.py  â­â­
> è‚¡ç¥¨åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨åƒ¹æ ¼æ­·å²è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, Date, Numeric, BigInteger, DateTime, Index
from sqlalchemy.sql import func
from app.database import Base


class StockPrice(Base):
    """ç¾è‚¡åƒ¹æ ¼æ­·å²"""
    
    __tablename__ = "stock_prices"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    symbol = Column(String(10), nullable=False, index=True)
    date = Column(Date, nullable=False, index=True)
    open = Column(Numeric(12, 4))
    high = Column(Numeric(12, 4))
    low = Column(Numeric(12, 4))
    close = Column(Numeric(12, 4))
    volume = Column(BigInteger)
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    __table_args__ = (
        Index('idx_stock_symbol_date', 'symbol', 'date', unique=True),
    )
    
    def __repr__(self):
        return f"<StockPrice(symbol={self.symbol}, date={self.date}, close={self.close})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "symbol": self.symbol,
            "date": self.date.isoformat() if self.date else None,
            "open": float(self.open) if self.open else None,
            "high": float(self.high) if self.high else None,
            "low": float(self.low) if self.low else None,
            "close": float(self.close) if self.close else None,
            "volume": self.volume,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/subscription.py  â­â­
> è¨‚é–±ç²¾é¸ç›¸é—œ Model
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨‚é–±ç²¾é¸ç›¸é—œ Model
- SubscriptionSource: è¨‚é–±æºï¼ˆå¦‚ç¾è‚¡å¤§å”ï¼‰
- AutoPick: è‡ªå‹•æŠ“å–çš„æ¨™çš„
- UserSubscription: ç”¨æˆ¶è¨‚é–±é—œä¿‚
"""
from sqlalchemy import Column, Integer, String, Text, Boolean, DateTime, Date, ForeignKey, UniqueConstraint
from sqlalchemy.orm import relationship
from datetime import datetime, timedelta

from app.database import Base


class SubscriptionSource(Base):
    """è¨‚é–±æº"""
    __tablename__ = "subscription_sources"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(100), nullable=False)          # "ç¾è‚¡å¤§å”"
    slug = Column(String(50), unique=True, nullable=False)  # "uncle-stock"
    url = Column(String(500), nullable=False)           # RSS feed URL
    type = Column(String(20), default="substack")       # substack, rss, etc.
    description = Column(Text)
    enabled = Column(Boolean, default=True)
    last_fetched_at = Column(DateTime)                  # æœ€å¾ŒæŠ“å–æ™‚é–“
    created_at = Column(DateTime, default=datetime.now)
    
    # é—œè¯
    auto_picks = relationship("AutoPick", back_populates="source")
    subscribers = relationship("UserSubscription", back_populates="source")
    
    def to_dict(self):
        return {
            "id": self.id,
            "name": self.name,
            "slug": self.slug,
            "url": self.url,
            "type": self.type,
            "description": self.description,
            "enabled": self.enabled,
            "last_fetched_at": self.last_fetched_at.isoformat() if self.last_fetched_at else None,
        }


class AutoPick(Base):
    """è‡ªå‹•æŠ“å–çš„æ¨™çš„"""
    __tablename__ = "auto_picks"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    source_id = Column(Integer, ForeignKey("subscription_sources.id"), nullable=False)
    symbol = Column(String(20), nullable=False)         # è‚¡ç¥¨ä»£ç¢¼
    article_url = Column(String(500))                   # å‡ºè™•é€£çµ
    article_title = Column(String(300))                 # æ–‡ç« æ¨™é¡Œ
    article_date = Column(Date)                         # æ–‡ç« æ—¥æœŸ
    first_seen_at = Column(DateTime, default=datetime.now)  # é¦–æ¬¡ç™¼ç¾
    last_seen_at = Column(DateTime, default=datetime.now)   # æœ€è¿‘æåŠ
    expires_at = Column(DateTime)                       # last_seen_at + 30å¤©
    mention_count = Column(Integer, default=1)          # æåŠæ¬¡æ•¸
    created_at = Column(DateTime, default=datetime.now)
    
    # é—œè¯
    source = relationship("SubscriptionSource", back_populates="auto_picks")
    
    # è¤‡åˆå”¯ä¸€ï¼šåŒä¾†æº + åŒä»£ç¢¼
    __table_args__ = (
        UniqueConstraint('source_id', 'symbol', name='uq_source_symbol'),
    )
    
    def update_mention(self, article_url: str = None, article_title: str = None, article_date: Date = None):
        """æ›´æ–°æåŠï¼šé‡ç®—éæœŸæ™‚é–“ã€ç´¯åŠ è¨ˆæ•¸"""
        self.last_seen_at = datetime.now()
        self.expires_at = datetime.now() + timedelta(days=30)
        self.mention_count += 1
        if article_url:
            self.article_url = article_url
        if article_title:
            self.article_title = article_title
        if article_date:
            self.article_date = article_date
    
    @property
    def is_active(self) -> bool:
        """æ˜¯å¦ä»åœ¨æœ‰æ•ˆæœŸå…§"""
        if not self.expires_at:
            return False
        return self.expires_at > datetime.now()
    
    @property
    def days_remaining(self) -> int:
        """å‰©é¤˜å¤©æ•¸"""
        if not self.expires_at:
            return 0
        delta = self.expires_at - datetime.now()
        return max(0, delta.days)
    
    def to_dict(self):
        return {
            "id": self.id,
            "source_id": self.source_id,
            "symbol": self.symbol,
            "article_url": self.article_url,
            "article_title": self.article_title,
            "article_date": self.article_date.isoformat() if self.article_date else None,
            "first_seen_at": self.first_seen_at.isoformat() if self.first_seen_at else None,
            "last_seen_at": self.last_seen_at.isoformat() if self.last_seen_at else None,
            "expires_at": self.expires_at.isoformat() if self.expires_at else None,
            "days_remaining": self.days_remaining,
            "mention_count": self.mention_count,
            "is_active": self.is_active,
        }


class UserSubscription(Base):
    """ç”¨æˆ¶è¨‚é–±é—œä¿‚"""
    __tablename__ = "user_subscriptions"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    source_id = Column(Integer, ForeignKey("subscription_sources.id"), nullable=False)
    subscribed_at = Column(DateTime, default=datetime.now)
    
    # é—œè¯
    source = relationship("SubscriptionSource", back_populates="subscribers")
    
    # è¤‡åˆå”¯ä¸€
    __table_args__ = (
        UniqueConstraint('user_id', 'source_id', name='uq_user_source'),
    )
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "source_id": self.source_id,
            "subscribed_at": self.subscribed_at.isoformat() if self.subscribed_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/user.py  â­â­
> ç”¨æˆ¶è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ç”¨æˆ¶è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, DateTime, Boolean, Text, ForeignKey
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base


class User(Base):
    """ç”¨æˆ¶è³‡æ–™"""
    
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    line_user_id = Column(String(50), unique=True, nullable=False, index=True)
    display_name = Column(String(100))
    picture_url = Column(String(500))
    email = Column(String(200))
    is_active = Column(Boolean, default=True)
    is_admin = Column(Boolean, default=False)  # ç®¡ç†å“¡
    is_blocked = Column(Boolean, default=False)  # å°é–
    blocked_reason = Column(String(200))  # å°é–åŸå› 
    blocked_at = Column(DateTime)  # å°é–æ™‚é–“
    created_at = Column(DateTime, server_default=func.now())
    last_login = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    # é—œè¯
    watchlists = relationship("Watchlist", back_populates="user", cascade="all, delete-orphan")
    indicator_settings = relationship("UserIndicatorSettings", back_populates="user", uselist=False, cascade="all, delete-orphan")
    alert_settings = relationship("UserAlertSettings", back_populates="user", uselist=False, cascade="all, delete-orphan")
    login_logs = relationship("LoginLog", back_populates="user", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<User(id={self.id}, line_user_id={self.line_user_id}, display_name={self.display_name})>"
    
    def to_dict(self):
        return {
            "id": self.id,
            "line_user_id": self.line_user_id,
            "display_name": self.display_name,
            "picture_url": self.picture_url,
            "email": self.email,
            "is_active": self.is_active,
            "is_admin": self.is_admin,
            "is_blocked": self.is_blocked,
            "blocked_reason": self.blocked_reason,
            "blocked_at": self.blocked_at.isoformat() if self.blocked_at else None,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "last_login": self.last_login.isoformat() if self.last_login else None,
        }


class LoginLog(Base):
    """ç™»å…¥æ—¥èªŒ"""
    
    __tablename__ = "login_logs"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    action = Column(String(20), nullable=False)  # login, logout, token_refresh
    ip_address = Column(String(50))
    user_agent = Column(String(500))
    created_at = Column(DateTime, server_default=func.now())
    
    # é—œè¯
    user = relationship("User", back_populates="login_logs")
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "action": self.action,
            "ip_address": self.ip_address,
            "user_agent": self.user_agent,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }


class TokenBlacklist(Base):
    """Token é»‘åå–®ï¼ˆç”¨æ–¼è¸¢å‡ºç”¨æˆ¶ï¼‰"""
    
    __tablename__ = "token_blacklist"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    token_jti = Column(String(100), unique=True, nullable=False, index=True)  # JWT ID
    user_id = Column(Integer, index=True)
    reason = Column(String(100))  # kicked, logout, blocked
    created_at = Column(DateTime, server_default=func.now())
    expires_at = Column(DateTime)  # Token éæœŸæ™‚é–“ï¼ˆéæœŸå¾Œå¯æ¸…ç†ï¼‰
    
    def to_dict(self):
        return {
            "id": self.id,
            "token_jti": self.token_jti,
            "user_id": self.user_id,
            "reason": self.reason,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }


class SystemConfig(Base):
    """ç³»çµ±è¨­å®š"""
    
    __tablename__ = "system_config"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    key = Column(String(50), unique=True, nullable=False, index=True)
    value = Column(Text)
    description = Column(String(200))
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
    
    def to_dict(self):
        return {
            "id": self.id,
            "key": self.key,
            "value": self.value,
            "description": self.description,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/user_settings.py  â­â­
> ç”¨æˆ¶è¨­å®šè³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ç”¨æˆ¶è¨­å®šè³‡æ–™æ¨¡å‹
åŒ…å«æŒ‡æ¨™é¡¯ç¤ºè¨­å®šã€é€šçŸ¥è¨­å®šã€åƒæ•¸è¨­å®š
"""
from sqlalchemy import Column, Integer, Boolean, ForeignKey, Numeric
from sqlalchemy.orm import relationship
from app.database import Base


class UserIndicatorSettings(Base):
    """ç”¨æˆ¶æŒ‡æ¨™é¡¯ç¤ºè¨­å®š"""
    
    __tablename__ = "user_indicator_settings"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    show_ma = Column(Boolean, default=True)
    show_rsi = Column(Boolean, default=True)
    show_macd = Column(Boolean, default=True)
    show_kd = Column(Boolean, default=False)
    show_bollinger = Column(Boolean, default=True)
    show_obv = Column(Boolean, default=False)
    show_volume = Column(Boolean, default=True)
    
    # é—œè¯
    user = relationship("User", back_populates="indicator_settings")
    
    def __repr__(self):
        return f"<UserIndicatorSettings(user_id={self.user_id})>"
    
    def to_dict(self):
        return {
            "show_ma": self.show_ma,
            "show_rsi": self.show_rsi,
            "show_macd": self.show_macd,
            "show_kd": self.show_kd,
            "show_bollinger": self.show_bollinger,
            "show_obv": self.show_obv,
            "show_volume": self.show_volume,
        }
    
    @classmethod
    def create_default(cls, user_id: int):
        """å»ºç«‹é è¨­è¨­å®š"""
        return cls(user_id=user_id)


class UserAlertSettings(Base):
    """ç”¨æˆ¶é€šçŸ¥è¨­å®š"""
    
    __tablename__ = "user_alert_settings"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    alert_ma_cross = Column(Boolean, default=True)      # å‡ç·šäº¤å‰é€šçŸ¥
    alert_ma_breakout = Column(Boolean, default=True)   # å‡ç·šçªç ´é€šçŸ¥
    alert_rsi = Column(Boolean, default=True)           # RSI è¶…è²·è¶…è³£é€šçŸ¥
    alert_macd = Column(Boolean, default=True)          # MACD äº¤å‰é€šçŸ¥
    alert_kd = Column(Boolean, default=False)           # KD äº¤å‰é€šçŸ¥
    alert_bollinger = Column(Boolean, default=False)    # å¸ƒæ—çªç ´é€šçŸ¥
    alert_volume = Column(Boolean, default=False)       # é‡èƒ½ç•°å¸¸é€šçŸ¥
    alert_sentiment = Column(Boolean, default=True)     # æƒ…ç·’æ¥µç«¯é€šçŸ¥
    
    # é—œè¯
    user = relationship("User", back_populates="alert_settings")
    
    def __repr__(self):
        return f"<UserAlertSettings(user_id={self.user_id})>"
    
    def to_dict(self):
        return {
            "alert_ma_cross": self.alert_ma_cross,
            "alert_ma_breakout": self.alert_ma_breakout,
            "alert_rsi": self.alert_rsi,
            "alert_macd": self.alert_macd,
            "alert_kd": self.alert_kd,
            "alert_bollinger": self.alert_bollinger,
            "alert_volume": self.alert_volume,
            "alert_sentiment": self.alert_sentiment,
        }
    
    @classmethod
    def create_default(cls, user_id: int):
        """å»ºç«‹é è¨­è¨­å®š"""
        return cls(user_id=user_id)


class UserIndicatorParams(Base):
    """ç”¨æˆ¶æŒ‡æ¨™åƒæ•¸è¨­å®š"""
    
    __tablename__ = "user_indicator_params"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), primary_key=True)
    
    # å‡ç·š
    ma_short = Column(Integer, default=20)
    ma_mid = Column(Integer, default=50)
    ma_long = Column(Integer, default=200)
    
    # RSI
    rsi_period = Column(Integer, default=14)
    rsi_overbought = Column(Integer, default=70)
    rsi_oversold = Column(Integer, default=30)
    
    # MACD
    macd_fast = Column(Integer, default=12)
    macd_slow = Column(Integer, default=26)
    macd_signal = Column(Integer, default=9)
    
    # KD
    kd_period = Column(Integer, default=9)
    
    # å¸ƒæ—é€šé“
    bollinger_period = Column(Integer, default=20)
    bollinger_std = Column(Numeric(3, 1), default=2.0)
    
    # è­¦æˆ’å€¼
    breakout_threshold = Column(Numeric(4, 2), default=2.00)  # çªç ´é è­¦é–€æª» (%)
    volume_alert_ratio = Column(Numeric(3, 1), default=2.0)   # é‡æ¯”è­¦æˆ’å€æ•¸
    
    # é—œè¯
    user = relationship("User")
    
    def __repr__(self):
        return f"<UserIndicatorParams(user_id={self.user_id})>"
    
    def to_dict(self):
        return {
            "ma_short": self.ma_short,
            "ma_mid": self.ma_mid,
            "ma_long": self.ma_long,
            "rsi_period": self.rsi_period,
            "rsi_overbought": self.rsi_overbought,
            "rsi_oversold": self.rsi_oversold,
            "macd_fast": self.macd_fast,
            "macd_slow": self.macd_slow,
            "macd_signal": self.macd_signal,
            "kd_period": self.kd_period,
            "bollinger_period": self.bollinger_period,
            "bollinger_std": float(self.bollinger_std) if self.bollinger_std else 2.0,
            "breakout_threshold": float(self.breakout_threshold) if self.breakout_threshold else 2.0,
            "volume_alert_ratio": float(self.volume_alert_ratio) if self.volume_alert_ratio else 2.0,
        }
    
    @classmethod
    def create_default(cls, user_id: int):
        """å»ºç«‹é è¨­è¨­å®š"""
        return cls(user_id=user_id)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/watchlist.py  â­â­
> è¿½è¹¤æ¸…å–®è³‡æ–™æ¨¡å‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–®è³‡æ–™æ¨¡å‹
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Index, Numeric
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from app.database import Base


class Watchlist(Base):
    """ç”¨æˆ¶è¿½è¹¤æ¸…å–®"""
    __tablename__ = "watchlists"

    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    symbol = Column(String(10), nullable=False)
    asset_type = Column(String(10), nullable=False)  # stock / crypto
    note = Column(String(200))  # è‡ªè¨‚å‚™è¨»
    target_price = Column(Numeric(12, 4), nullable=True)  # ğŸ†• ç›®æ¨™åƒ¹æ ¼
    added_at = Column(DateTime, server_default=func.now())

    # é—œè¯
    user = relationship("User", back_populates="watchlists")

    __table_args__ = (
        Index('idx_watchlist_user', 'user_id'),
        Index('idx_watchlist_unique', 'user_id', 'symbol', 'asset_type', unique=True),
    )

    def __repr__(self):
        return f"<Watchlist(user_id={self.user_id}, symbol={self.symbol}, asset_type={self.asset_type})>"

    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "symbol": self.symbol,
            "asset_type": self.asset_type,
            "note": self.note,
            "target_price": float(self.target_price) if self.target_price else None,
            "added_at": self.added_at.isoformat() if self.added_at else None,
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/models/watchlist_tag.py  â­â­
> è¿½è¹¤æ¸…å–®åˆ†çµ„æ¨™ç±¤
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–®åˆ†çµ„æ¨™ç±¤
==================
æ”¯æ´ç”¨æˆ¶è‡ªè¨‚æ¨™ç±¤ä¾†åˆ†é¡è¿½è¹¤çš„è‚¡ç¥¨

P1 åŠŸèƒ½ï¼šè¿½è¹¤æ¸…å–®åˆ†çµ„ Tag
"""
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey, Table, Index
from sqlalchemy.orm import relationship
from datetime import datetime

from app.database import Base


# å¤šå°å¤šé—œè¯è¡¨ï¼šè¿½è¹¤é …ç›® <-> æ¨™ç±¤
# æ³¨æ„ï¼šWatchlist è¡¨åæ˜¯ "watchlists"ï¼ˆæœ‰ sï¼‰
watchlist_tags = Table(
    'watchlist_tags',
    Base.metadata,
    Column('watchlist_id', Integer, ForeignKey('watchlists.id', ondelete='CASCADE'), primary_key=True),
    Column('tag_id', Integer, ForeignKey('user_tags.id', ondelete='CASCADE'), primary_key=True),
)


class UserTag(Base):
    """ç”¨æˆ¶è‡ªè¨‚æ¨™ç±¤"""
    
    __tablename__ = "user_tags"
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    
    # æ¨™ç±¤è³‡è¨Š
    name = Column(String(50), nullable=False)      # æ¨™ç±¤åç¨±
    color = Column(String(20), default="#3B82F6")  # æ¨™ç±¤é¡è‰² (hex)
    icon = Column(String(50), default="fa-tag")    # æ¨™ç±¤åœ–ç¤º
    sort_order = Column(Integer, default=0)        # æ’åºé †åº
    
    # æ™‚é–“æˆ³
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # ç´¢å¼•
    __table_args__ = (
        Index('idx_user_tags_user_id', 'user_id'),
        Index('idx_user_tags_user_name', 'user_id', 'name', unique=True),
    )
    
    def to_dict(self):
        return {
            "id": self.id,
            "user_id": self.user_id,
            "name": self.name,
            "color": self.color,
            "icon": self.icon,
            "sort_order": self.sort_order,
            "created_at": self.created_at.isoformat() if self.created_at else None,
        }
    
    def __repr__(self):
        return f"<UserTag {self.name}>"


# ============================================================
# é è¨­æ¨™ç±¤é¡è‰²é¸é …
# ============================================================

TAG_COLORS = [
    {"name": "è—è‰²", "value": "#3B82F6"},
    {"name": "ç¶ è‰²", "value": "#10B981"},
    {"name": "ç´…è‰²", "value": "#EF4444"},
    {"name": "é»ƒè‰²", "value": "#F59E0B"},
    {"name": "ç´«è‰²", "value": "#8B5CF6"},
    {"name": "ç²‰è‰²", "value": "#EC4899"},
    {"name": "é›è‰²", "value": "#6366F1"},
    {"name": "é’è‰²", "value": "#06B6D4"},
    {"name": "æ©™è‰²", "value": "#F97316"},
    {"name": "ç°è‰²", "value": "#6B7280"},
]

TAG_ICONS = [
    {"name": "æ¨™ç±¤", "value": "fa-tag"},
    {"name": "æ˜Ÿæ˜Ÿ", "value": "fa-star"},
    {"name": "å¿ƒå½¢", "value": "fa-heart"},
    {"name": "æ›¸ç±¤", "value": "fa-bookmark"},
    {"name": "æ——å¹Ÿ", "value": "fa-flag"},
    {"name": "è³‡æ–™å¤¾", "value": "fa-folder"},
    {"name": "ç«ç„°", "value": "fa-fire"},
    {"name": "é–ƒé›»", "value": "fa-bolt"},
    {"name": "çç›ƒ", "value": "fa-trophy"},
    {"name": "æ”¾å¤§é¡", "value": "fa-search"},
]

# é è¨­æ¨™ç±¤ç¯„ä¾‹
DEFAULT_TAGS = [
    {"name": "é•·æœŸæŒæœ‰", "color": "#10B981", "icon": "fa-star"},
    {"name": "è§€æœ›ä¸­", "color": "#F59E0B", "icon": "fa-search"},
    {"name": "çŸ­ç·šäº¤æ˜“", "color": "#EF4444", "icon": "fa-bolt"},
    {"name": "ETF", "color": "#3B82F6", "icon": "fa-layer-group"},
    {"name": "é«˜è‚¡æ¯", "color": "#8B5CF6", "icon": "fa-coins"},
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/schemas/__init__.py  â­â­
> Pydantic Schemas
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Pydantic Schemas
"""
from app.schemas.schemas import *
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/schemas/schemas.py  â­â­
> Pydantic Schemas
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Pydantic Schemas
API è«‹æ±‚/å›æ‡‰è³‡æ–™æ¨¡å‹
"""
from pydantic import BaseModel, Field
from typing import Optional, List, Any, Dict
from datetime import datetime


# ==================== é€šç”¨ ====================

class ResponseBase(BaseModel):
    """åŸºç¤å›æ‡‰"""
    success: bool = True
    message: Optional[str] = None


class ErrorResponse(BaseModel):
    """éŒ¯èª¤å›æ‡‰"""
    success: bool = False
    error: Dict[str, str]


# ==================== ç”¨æˆ¶ ====================

class UserBase(BaseModel):
    """ç”¨æˆ¶åŸºæœ¬è³‡è¨Š"""
    display_name: Optional[str] = None
    picture_url: Optional[str] = None
    email: Optional[str] = None


class UserResponse(UserBase):
    """ç”¨æˆ¶å›æ‡‰"""
    id: int
    line_user_id: str
    is_active: bool
    is_admin: bool = False  # ç®¡ç†å“¡æ¬Šé™
    created_at: Optional[datetime] = None
    last_login: Optional[datetime] = None
    
    class Config:
        from_attributes = True


class LoginResponse(ResponseBase):
    """ç™»å…¥å›æ‡‰"""
    token: str
    user: UserResponse
    is_new_user: bool = False


# ==================== è¿½è¹¤æ¸…å–® ====================

class WatchlistAdd(BaseModel):
    """æ–°å¢è¿½è¹¤æ¸…å–®è«‹æ±‚"""
    symbol: str = Field(..., min_length=1, max_length=10)
    note: Optional[str] = Field(None, max_length=200)


class WatchlistUpdate(BaseModel):
    """æ›´æ–°è¿½è¹¤æ¸…å–®è«‹æ±‚"""
    note: Optional[str] = Field(None, max_length=200)


class WatchlistItem(BaseModel):
    """è¿½è¹¤æ¸…å–®é …ç›®"""
    id: int
    symbol: str
    asset_type: str
    note: Optional[str] = None
    added_at: Optional[datetime] = None
    
    class Config:
        from_attributes = True


class WatchlistResponse(ResponseBase):
    """è¿½è¹¤æ¸…å–®å›æ‡‰"""
    data: Optional[WatchlistItem] = None


class WatchlistListResponse(ResponseBase):
    """è¿½è¹¤æ¸…å–®åˆ—è¡¨å›æ‡‰"""
    data: List[WatchlistItem] = []
    total: int = 0


class WatchlistOverviewItem(BaseModel):
    """è¿½è¹¤æ¸…å–®ç¸½è¦½é …ç›®"""
    id: int
    symbol: str
    name: Optional[str] = None
    price: Optional[float] = None
    change_day: Optional[float] = None
    change_24h: Optional[float] = None
    ma_alignment: Optional[str] = None
    rsi: Optional[float] = None
    score: Optional[Dict[str, Any]] = None
    note: Optional[str] = None
    added_at: Optional[str] = None


class SentimentItem(BaseModel):
    """æƒ…ç·’æŒ‡æ•¸é …ç›®"""
    value: int
    classification: str
    classification_zh: str
    timestamp: str
    market: str


class WatchlistOverviewResponse(ResponseBase):
    """è¿½è¹¤æ¸…å–®ç¸½è¦½å›æ‡‰"""
    stocks: List[WatchlistOverviewItem] = []
    crypto: List[WatchlistOverviewItem] = []
    sentiment: Optional[Dict[str, SentimentItem]] = None
    total_count: int = 0


# ==================== è¨­å®š ====================

class IndicatorSettingsUpdate(BaseModel):
    """æŒ‡æ¨™é¡¯ç¤ºè¨­å®šæ›´æ–°"""
    show_ma: Optional[bool] = None
    show_rsi: Optional[bool] = None
    show_macd: Optional[bool] = None
    show_kd: Optional[bool] = None
    show_bollinger: Optional[bool] = None
    show_obv: Optional[bool] = None
    show_volume: Optional[bool] = None


class IndicatorSettingsResponse(ResponseBase):
    """æŒ‡æ¨™é¡¯ç¤ºè¨­å®šå›æ‡‰"""
    data: Dict[str, bool] = {}


class AlertSettingsUpdate(BaseModel):
    """é€šçŸ¥è¨­å®šæ›´æ–°"""
    alert_ma_cross: Optional[bool] = None
    alert_ma_breakout: Optional[bool] = None
    alert_rsi: Optional[bool] = None
    alert_macd: Optional[bool] = None
    alert_kd: Optional[bool] = None
    alert_bollinger: Optional[bool] = None
    alert_volume: Optional[bool] = None
    alert_sentiment: Optional[bool] = None


class AlertSettingsResponse(ResponseBase):
    """é€šçŸ¥è¨­å®šå›æ‡‰"""
    data: Dict[str, bool] = {}


class IndicatorParamsUpdate(BaseModel):
    """æŒ‡æ¨™åƒæ•¸æ›´æ–°"""
    ma_short: Optional[int] = Field(None, ge=5, le=50)
    ma_mid: Optional[int] = Field(None, ge=20, le=100)
    ma_long: Optional[int] = Field(None, ge=50, le=300)
    rsi_period: Optional[int] = Field(None, ge=5, le=30)
    rsi_overbought: Optional[int] = Field(None, ge=60, le=90)
    rsi_oversold: Optional[int] = Field(None, ge=10, le=40)
    macd_fast: Optional[int] = Field(None, ge=5, le=20)
    macd_slow: Optional[int] = Field(None, ge=15, le=40)
    macd_signal: Optional[int] = Field(None, ge=5, le=15)
    kd_period: Optional[int] = Field(None, ge=5, le=20)
    bollinger_period: Optional[int] = Field(None, ge=10, le=30)
    bollinger_std: Optional[float] = Field(None, ge=1.0, le=3.0)
    breakout_threshold: Optional[float] = Field(None, ge=0.5, le=5.0)
    volume_alert_ratio: Optional[float] = Field(None, ge=1.0, le=5.0)


class IndicatorParamsResponse(ResponseBase):
    """æŒ‡æ¨™åƒæ•¸å›æ‡‰"""
    data: Dict[str, Any] = {}


# ==================== è‚¡ç¥¨/åŠ å¯†è²¨å¹£ ====================

class PriceInfo(BaseModel):
    """åƒ¹æ ¼è³‡è¨Š"""
    current: float
    high_52w: Optional[float] = None
    low_52w: Optional[float] = None
    ath: Optional[float] = None
    from_high_pct: Optional[float] = None
    from_low_pct: Optional[float] = None
    from_ath_pct: Optional[float] = None


class ChangeInfo(BaseModel):
    """æ¼²è·Œå¹…è³‡è¨Š"""
    day: Optional[float] = None
    week: Optional[float] = None
    month: Optional[float] = None
    quarter: Optional[float] = None
    year: Optional[float] = None


class VolumeInfo(BaseModel):
    """æˆäº¤é‡è³‡è¨Š"""
    today: Optional[int] = None
    avg_20d: Optional[int] = None
    ratio: Optional[float] = None


class SignalItem(BaseModel):
    """è¨Šè™Ÿé …ç›®"""
    type: str
    indicator: str
    description: str


class ScoreInfo(BaseModel):
    """è©•åˆ†è³‡è¨Š"""
    buy_score: int = 0
    sell_score: int = 0
    rating: str = "neutral"
    details: List[str] = []


class StockAnalysisResponse(ResponseBase):
    """è‚¡ç¥¨åˆ†æå›æ‡‰"""
    symbol: str
    name: str
    asset_type: str = "stock"
    price: PriceInfo
    change: ChangeInfo
    volume: Optional[VolumeInfo] = None
    indicators: Dict[str, Any] = {}
    signals: List[SignalItem] = []
    score: ScoreInfo
    updated_at: Optional[str] = None


class CryptoAnalysisResponse(ResponseBase):
    """åŠ å¯†è²¨å¹£åˆ†æå›æ‡‰"""
    symbol: str
    name: str
    asset_type: str = "crypto"
    price: PriceInfo
    change: ChangeInfo
    market: Optional[Dict[str, Any]] = None
    indicators: Dict[str, Any] = {}
    signals: List[SignalItem] = []
    score: ScoreInfo
    updated_at: Optional[str] = None


# ==================== å¸‚å ´æƒ…ç·’ ====================

class MarketSentimentResponse(ResponseBase):
    """å¸‚å ´æƒ…ç·’å›æ‡‰"""
    stock: Optional[SentimentItem] = None
    crypto: Optional[SentimentItem] = None
```

======================================================================
## ğŸ§  æ ¸å¿ƒé‚è¼¯
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/__init__.py  â­â­â­
> å•†æ¥­é‚è¼¯æœå‹™æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å•†æ¥­é‚è¼¯æœå‹™æ¨¡çµ„
"""
from app.services.indicator_service import indicator_service, IndicatorService
from app.services.stock_service import StockService
from app.services.crypto_service import CryptoService
from app.services.chart_service import chart_service, ChartService
from app.services.auth_service import AuthService, AuthServiceSync
from app.services.watchlist_service import WatchlistService
from app.services.market_service import MarketService
from app.services.signal_service import signal_service, SignalService, SignalType
from app.services.line_notify_service import line_notify_service, LineNotifyService

__all__ = [
    "indicator_service",
    "IndicatorService",
    "StockService",
    "CryptoService",
    "chart_service",
    "ChartService",
    "AuthService",
    "AuthServiceSync",
    "WatchlistService",
    "MarketService",
    "signal_service",
    "SignalService",
    "SignalType",
    "line_notify_service",
    "LineNotifyService",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/auth_service.py  â­â­â­
> èªè­‰æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
èªè­‰æœå‹™
LINE Login æ•´åˆ + JWT Token ç®¡ç†
"""
import httpx
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
from jose import jwt, JWTError
from sqlalchemy.orm import Session
from sqlalchemy import select
import logging
import secrets
import uuid

from app.config import settings
from app.models.user import User, LoginLog, SystemConfig
from app.models.user_settings import UserIndicatorSettings, UserAlertSettings, UserIndicatorParams

logger = logging.getLogger(__name__)

# JWT è¨­å®š
JWT_ALGORITHM = "HS256"


class AuthService:
    """èªè­‰æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    # ==================== LINE Login ====================
    
    def get_line_auth_url(self, state: str = None) -> str:
        """
        å–å¾— LINE æˆæ¬Š URL
        
        Args:
            state: é˜² CSRF çš„éš¨æ©Ÿå­—ä¸²
            
        Returns:
            LINE æˆæ¬Šé é¢ URL
        """
        if not state:
            state = secrets.token_urlsafe(32)
        
        params = {
            "response_type": "code",
            "client_id": settings.LINE_LOGIN_CHANNEL_ID,
            "redirect_uri": settings.LINE_LOGIN_CALLBACK_URL,
            "state": state,
            "scope": "profile openid email",
        }
        
        query_string = "&".join(f"{k}={v}" for k, v in params.items())
        return f"https://access.line.me/oauth2/v2.1/authorize?{query_string}"
    
    async def exchange_code_for_token(self, code: str) -> Optional[Dict[str, Any]]:
        """
        ç”¨ authorization code æ›å– access token
        
        Args:
            code: LINE å›å‚³çš„ authorization code
            
        Returns:
            åŒ…å« access_token, id_token ç­‰çš„å­—å…¸
        """
        url = "https://api.line.me/oauth2/v2.1/token"
        
        data = {
            "grant_type": "authorization_code",
            "code": code,
            "redirect_uri": settings.LINE_LOGIN_CALLBACK_URL,
            "client_id": settings.LINE_LOGIN_CHANNEL_ID,
            "client_secret": settings.LINE_LOGIN_CHANNEL_SECRET,
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(url, data=data)
                response.raise_for_status()
                return response.json()
        except Exception as e:
            logger.error(f"LINE token äº¤æ›å¤±æ•—: {e}")
            return None
    
    async def get_line_profile(self, access_token: str) -> Optional[Dict[str, Any]]:
        """
        ç”¨ access token å–å¾— LINE ç”¨æˆ¶è³‡æ–™
        
        Args:
            access_token: LINE access token
            
        Returns:
            ç”¨æˆ¶è³‡æ–™å­—å…¸ (userId, displayName, pictureUrl, statusMessage)
        """
        url = "https://api.line.me/v2/profile"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.get(
                    url,
                    headers={"Authorization": f"Bearer {access_token}"}
                )
                response.raise_for_status()
                return response.json()
        except Exception as e:
            logger.error(f"å–å¾— LINE ç”¨æˆ¶è³‡æ–™å¤±æ•—: {e}")
            return None
    
    async def verify_id_token(self, id_token: str) -> Optional[Dict[str, Any]]:
        """
        é©—è­‰ LINE ID Token
        
        Args:
            id_token: LINE ID Token
            
        Returns:
            è§£ç¢¼å¾Œçš„ token payload
        """
        url = "https://api.line.me/oauth2/v2.1/verify"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    url,
                    data={
                        "id_token": id_token,
                        "client_id": settings.LINE_LOGIN_CHANNEL_ID,
                    }
                )
                response.raise_for_status()
                return response.json()
        except Exception as e:
            logger.error(f"LINE ID Token é©—è­‰å¤±æ•—: {e}")
            return None
    
    # ==================== ç”¨æˆ¶ç®¡ç† ====================
    
    async def get_user_by_line_id(self, line_user_id: str) -> Optional[User]:
        """æ ¹æ“š LINE User ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.line_user_id == line_user_id)
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def get_user_by_id(self, user_id: int) -> Optional[User]:
        """æ ¹æ“š ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.id == user_id)
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def create_user(
        self,
        line_user_id: str,
        display_name: str = None,
        picture_url: str = None,
        email: str = None,
    ) -> User:
        """
        å»ºç«‹æ–°ç”¨æˆ¶
        
        æœƒè‡ªå‹•å»ºç«‹é è¨­è¨­å®šï¼Œä¸¦æª¢æŸ¥æ˜¯å¦ç‚ºåˆå§‹ç®¡ç†å“¡
        """
        # æª¢æŸ¥æ˜¯å¦ç‚ºåˆå§‹ç®¡ç†å“¡
        admin_ids = settings.get_admin_line_ids()
        is_admin = line_user_id in admin_ids
        
        user = User(
            line_user_id=line_user_id,
            display_name=display_name,
            picture_url=picture_url,
            email=email,
            is_admin=is_admin,
        )
        self.db.add(user)
        await self.db.flush()  # å–å¾— user.id
        
        # å»ºç«‹é è¨­è¨­å®š
        indicator_settings = UserIndicatorSettings.create_default(user.id)
        alert_settings = UserAlertSettings.create_default(user.id)
        params = UserIndicatorParams.create_default(user.id)
        
        self.db.add(indicator_settings)
        self.db.add(alert_settings)
        self.db.add(params)
        
        await self.db.commit()
        await self.db.refresh(user)
        
        logger.info(f"æ–°ç”¨æˆ¶å»ºç«‹: {user.id} ({display_name}), admin={is_admin}")
        return user
    
    async def update_user_login(self, user: User, display_name: str = None, picture_url: str = None):
        """æ›´æ–°ç”¨æˆ¶ç™»å…¥è³‡è¨Š"""
        if display_name:
            user.display_name = display_name
        if picture_url:
            user.picture_url = picture_url
        user.last_login = datetime.utcnow()
        
        # æª¢æŸ¥æ˜¯å¦éœ€è¦å‡ç´šç‚ºç®¡ç†å“¡ï¼ˆä½¿ç”¨ getattr å’Œ setattr é¿å…æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼‰
        try:
            if not getattr(user, 'is_admin', False):
                admin_ids = settings.get_admin_line_ids()
                if user.line_user_id in admin_ids:
                    user.is_admin = True
                    logger.info(f"ç”¨æˆ¶ {user.id} å‡ç´šç‚ºç®¡ç†å“¡")
        except Exception as e:
            logger.warning(f"is_admin check failed: {e}")
        
        await self.db.commit()
    
    async def log_login(self, user_id: int, action: str = "login", ip_address: str = None, user_agent: str = None):
        """è¨˜éŒ„ç™»å…¥æ—¥èªŒ"""
        try:
            log = LoginLog(
                user_id=user_id,
                action=action,
                ip_address=ip_address,
                user_agent=user_agent[:500] if user_agent else None,
            )
            self.db.add(log)
            await self.db.commit()
        except Exception as e:
            # å¦‚æœ login_logs è¡¨ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤
            logger.warning(f"log_login failed (table may not exist): {e}")
    
    async def login_with_line(self, code: str, ip_address: str = None, user_agent: str = None) -> Optional[Dict[str, Any]]:
        """
        LINE Login å®Œæ•´æµç¨‹
        
        Args:
            code: LINE å›å‚³çš„ authorization code
            
        Returns:
            {
                "user": User,
                "token": str,
                "is_new_user": bool
            }
        """
        logger.info(f"=== LINE Login é–‹å§‹ ===")
        logger.info(f"IP: {ip_address}, UA: {user_agent[:100] if user_agent else 'N/A'}")
        
        # 1. æ›å– access token
        token_data = await self.exchange_code_for_token(code)
        if not token_data:
            logger.error("LINE token äº¤æ›å¤±æ•—")
            return None
        
        access_token = token_data.get("access_token")
        logger.info(f"LINE token äº¤æ›æˆåŠŸ")
        
        # 2. å–å¾—ç”¨æˆ¶è³‡æ–™
        profile = await self.get_line_profile(access_token)
        if not profile:
            logger.error("å–å¾— LINE ç”¨æˆ¶è³‡æ–™å¤±æ•—")
            return None
        
        line_user_id = profile.get("userId")
        display_name = profile.get("displayName")
        picture_url = profile.get("pictureUrl")
        
        logger.info(f"LINE ç”¨æˆ¶è³‡æ–™: line_id={line_user_id}, name={display_name}")
        
        # 3. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
        user = await self.get_user_by_line_id(line_user_id)
        is_new_user = False
        
        if user:
            logger.info(f"æ—¢æœ‰ç”¨æˆ¶ç™»å…¥: db_id={user.id}, line_id={user.line_user_id}, name={user.display_name}")
            
            # æª¢æŸ¥æ˜¯å¦è¢«å°é–ï¼ˆä½¿ç”¨ getattr é¿å…æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼‰
            if getattr(user, 'is_blocked', False):
                logger.warning(f"å°é–ç”¨æˆ¶å˜—è©¦ç™»å…¥: {user.id} ({display_name})")
                return None
            
            # æ›´æ–°ç™»å…¥è³‡è¨Š
            await self.update_user_login(user, display_name, picture_url)
            logger.info(f"ç”¨æˆ¶ç™»å…¥è³‡è¨Šå·²æ›´æ–°: db_id={user.id}")
        else:
            # å»ºç«‹æ–°ç”¨æˆ¶
            logger.info(f"å»ºç«‹æ–°ç”¨æˆ¶: line_id={line_user_id}, name={display_name}")
            
            # å˜—è©¦å¾ ID token å–å¾— email
            email = None
            if token_data.get("id_token"):
                id_token_data = await self.verify_id_token(token_data["id_token"])
                if id_token_data:
                    email = id_token_data.get("email")
            
            user = await self.create_user(
                line_user_id=line_user_id,
                display_name=display_name,
                picture_url=picture_url,
                email=email,
            )
            is_new_user = True
            logger.info(f"æ–°ç”¨æˆ¶å»ºç«‹æˆåŠŸ: db_id={user.id}, line_id={user.line_user_id}")
        
        # 4. è¨˜éŒ„ç™»å…¥æ—¥èªŒ
        await self.log_login(user.id, "login", ip_address, user_agent)
        logger.info(f"ç™»å…¥æ—¥èªŒå·²è¨˜éŒ„: user_id={user.id}")
        
        # 5. ç”¢ç”Ÿ JWT Token
        jwt_token = self.create_jwt_token(user)
        
        logger.info(f"=== LINE Login å®Œæˆ ===")
        logger.info(f"ç”¨æˆ¶: db_id={user.id}, line_id={user.line_user_id}, name={user.display_name}, is_new={is_new_user}")
        
        return {
            "user": user,
            "token": jwt_token,
            "is_new_user": is_new_user,
        }
    
    # ==================== JWT Token ====================
    
    def create_jwt_token(self, user: User) -> str:
        """
        å»ºç«‹ JWT Token
        
        Args:
            user: ç”¨æˆ¶ç‰©ä»¶
            
        Returns:
            JWT Token å­—ä¸²
        
        ğŸ†• éæœŸæ™‚é–“ï¼š
        - ä¸€èˆ¬ç”¨æˆ¶ï¼š10 åˆ†é˜
        - ç®¡ç†å“¡ï¼š1 å°æ™‚
        """
        is_admin = getattr(user, 'is_admin', False)
        
        # æ ¹æ“šç”¨æˆ¶è§’è‰²è¨­å®šéæœŸæ™‚é–“
        if is_admin:
            expire_minutes = settings.JWT_EXPIRE_MINUTES_ADMIN  # 60 åˆ†é˜
        else:
            expire_minutes = settings.JWT_EXPIRE_MINUTES_USER   # 10 åˆ†é˜
        
        expire = datetime.utcnow() + timedelta(minutes=expire_minutes)
        issued_at = datetime.utcnow()
        
        payload = {
            "sub": str(user.id),
            "line_user_id": user.line_user_id,
            "display_name": user.display_name,
            "is_admin": is_admin,
            "exp": expire,
            "iat": issued_at,
            "jti": str(uuid.uuid4()),  # å”¯ä¸€ Token ID
            "expire_minutes": expire_minutes,  # ğŸ†• å‘Šè¨´å‰ç«¯éæœŸæ™‚é–“
        }
        
        token = jwt.encode(payload, settings.JWT_SECRET_KEY, algorithm=JWT_ALGORITHM)
        logger.info(f"JWT Token å»ºç«‹: user_id={user.id}, is_admin={is_admin}, expire={expire_minutes}åˆ†é˜")
        return token
    
    def verify_jwt_token(self, token: str) -> Optional[Dict[str, Any]]:
        """
        é©—è­‰ JWT Token
        
        Args:
            token: JWT Token å­—ä¸²
            
        Returns:
            Token payload æˆ– None
        """
        try:
            payload = jwt.decode(
                token,
                settings.JWT_SECRET_KEY,
                algorithms=[JWT_ALGORITHM]
            )
            return payload
        except JWTError as e:
            logger.warning(f"JWT é©—è­‰å¤±æ•—: {e}")
            return None
    
    async def check_token_valid(self, user_id: int, issued_at: int) -> bool:
        """
        æª¢æŸ¥ Token æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆæœªè¢«è¸¢å‡ºï¼‰
        
        Args:
            user_id: ç”¨æˆ¶ ID
            issued_at: Token ç°½ç™¼æ™‚é–“æˆ³
            
        Returns:
            True å¦‚æœ Token æœ‰æ•ˆ
        """
        try:
            # æª¢æŸ¥å…¨åŸŸ token ç‰ˆæœ¬
            result = await self.db.execute(
                select(SystemConfig).where(SystemConfig.key == "global_token_version")
            )
            global_config = result.scalar_one_or_none()
            
            if global_config and global_config.value:
                global_version = int(global_config.value)
                if issued_at < global_version:
                    return False
            
            # æª¢æŸ¥ç”¨æˆ¶ token ç‰ˆæœ¬
            result = await self.db.execute(
                select(SystemConfig).where(SystemConfig.key == f"user_token_version:{user_id}")
            )
            user_config = result.scalar_one_or_none()
            
            if user_config and user_config.value:
                user_version = int(user_config.value)
                if issued_at < user_version:
                    return False
        except Exception as e:
            # å¦‚æœ system_config è¡¨ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤ï¼Œé è¨­ token æœ‰æ•ˆ
            logger.warning(f"check_token_valid error (table may not exist): {e}")
        
        return True
    
    async def get_user_from_token(self, token: str) -> Optional[User]:
        """
        å¾ JWT Token å–å¾—ç”¨æˆ¶
        
        Args:
            token: JWT Token å­—ä¸²
            
        Returns:
            User ç‰©ä»¶æˆ– None
        """
        payload = self.verify_jwt_token(token)
        if not payload:
            logger.warning("Token é©—è­‰å¤±æ•—: payload ç‚ºç©º")
            return None
        
        user_id = payload.get("sub")
        token_line_user_id = payload.get("line_user_id")
        
        if not user_id:
            logger.warning("Token é©—è­‰å¤±æ•—: ç¼ºå°‘ user_id")
            return None
        
        user_id = int(user_id)
        
        # æª¢æŸ¥ Token æ˜¯å¦è¢«è¸¢å‡º
        issued_at = payload.get("iat")
        if issued_at:
            if isinstance(issued_at, datetime):
                issued_at = int(issued_at.timestamp())
            
            is_valid = await self.check_token_valid(user_id, issued_at)
            if not is_valid:
                logger.info(f"Token å·²è¢«è¸¢å‡º: user_id={user_id}")
                return None
        
        user = await self.get_user_by_id(user_id)
        
        if not user:
            logger.warning(f"Token é©—è­‰å¤±æ•—: ç”¨æˆ¶ä¸å­˜åœ¨ user_id={user_id}")
            return None
        
        # â˜…â˜…â˜… é‡è¦ï¼šé©—è­‰ Token ä¸­çš„ line_user_id èˆ‡è³‡æ–™åº«ä¸€è‡´ â˜…â˜…â˜…
        if token_line_user_id and user.line_user_id != token_line_user_id:
            logger.error(f"Token é©—è­‰å¤±æ•—: LINE ID ä¸ä¸€è‡´! token={token_line_user_id}, db={user.line_user_id}")
            return None
        
        # æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦è¢«å°é–ï¼ˆä½¿ç”¨ getattr é¿å…æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤ï¼‰
        if getattr(user, 'is_blocked', False):
            logger.info(f"å°é–ç”¨æˆ¶å˜—è©¦å­˜å–: user_id={user_id}")
            return None
        
        logger.debug(f"Token é©—è­‰æˆåŠŸ: user_id={user_id}, line_id={user.line_user_id}")
        return user


# ==================== åŒæ­¥ç‰ˆæœ¬ï¼ˆCLI ç”¨ï¼‰====================

class AuthServiceSync:
    """åŒæ­¥ç‰ˆèªè­‰æœå‹™ï¼ˆCLI ç”¨ï¼‰"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_user_by_id(self, user_id: int) -> Optional[User]:
        """æ ¹æ“š ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.id == user_id)
        return self.db.execute(stmt).scalar_one_or_none()
    
    def get_user_by_line_id(self, line_user_id: str) -> Optional[User]:
        """æ ¹æ“š LINE User ID å–å¾—ç”¨æˆ¶"""
        stmt = select(User).where(User.line_user_id == line_user_id)
        return self.db.execute(stmt).scalar_one_or_none()
    
    def create_demo_user(self, name: str = "Demo User") -> User:
        """å»ºç«‹æ¸¬è©¦ç”¨æˆ¶ï¼ˆé–‹ç™¼ç”¨ï¼‰"""
        demo_line_id = f"demo_{secrets.token_hex(8)}"
        
        user = User(
            line_user_id=demo_line_id,
            display_name=name,
        )
        self.db.add(user)
        self.db.flush()
        
        # å»ºç«‹é è¨­è¨­å®š
        self.db.add(UserIndicatorSettings.create_default(user.id))
        self.db.add(UserAlertSettings.create_default(user.id))
        self.db.add(UserIndicatorParams.create_default(user.id))
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def verify_jwt_token(self, token: str) -> Optional[Dict[str, Any]]:
        """é©—è­‰ JWT Token"""
        try:
            payload = jwt.decode(
                token,
                settings.JWT_SECRET_KEY,
                algorithms=[JWT_ALGORITHM]
            )
            return payload
        except JWTError:
            return None
    
    def get_user_from_token(self, token: str) -> Optional[User]:
        """å¾ JWT Token å–å¾—ç”¨æˆ¶"""
        payload = self.verify_jwt_token(token)
        if not payload:
            return None
        user_id = payload.get("sub")
        if not user_id:
            return None
        return self.get_user_by_id(int(user_id))
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/cache_helper.py  â­â­â­
> åƒ¹æ ¼å¿«å–è¼”åŠ©æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åƒ¹æ ¼å¿«å–è¼”åŠ©æ¨¡çµ„

æŸ¥è©¢è‚¡ç¥¨æ™‚è‡ªå‹•å°‡çµæœå¯«å…¥å¿«å–
- æŸ¥è©¢éçš„è‚¡ç¥¨æœƒè¢«å¿«å–
- ä½†ä¸æœƒè‡ªå‹•æ›´æ–°ï¼ˆåªæœ‰è¿½è¹¤æ¸…å–®æ‰æœƒï¼‰
- æ”¯æ´ MA20 æ¬„ä½ç”¨æ–¼æ’åº
"""
import logging
from datetime import datetime
from typing import Optional

logger = logging.getLogger(__name__)


def cache_stock_price(
    symbol: str,
    name: str,
    price: float,
    prev_close: Optional[float] = None,
    change: Optional[float] = None,
    change_pct: Optional[float] = None,
    ma20: Optional[float] = None,
    volume: Optional[int] = None,
    asset_type: str = "stock"
):
    """
    å°‡æŸ¥è©¢çµæœå¯«å…¥å¿«å–ï¼ˆèƒŒæ™¯åŸ·è¡Œï¼Œä¸å½±éŸ¿ä¸»æµç¨‹ï¼‰
    
    Args:
        symbol: è‚¡ç¥¨ä»£ç¢¼ (å¦‚ 0050.TW, AAPL)
        name: è‚¡ç¥¨åç¨±
        price: æœ€æ–°åƒ¹æ ¼
        prev_close: å‰æ”¶ç›¤åƒ¹
        change: æ¼²è·Œé‡‘é¡
        change_pct: æ¼²è·Œå¹… %
        ma20: 20æ—¥å‡ç·šï¼ˆç”¨æ–¼æ’åºï¼‰
        volume: æˆäº¤é‡
        asset_type: è³‡ç”¢é¡å‹ (stock/crypto)
    """
    try:
        from app.database import SessionLocal
        from app.models.price_cache import StockPriceCache
        
        db = SessionLocal()
        try:
            cache = db.query(StockPriceCache).filter(
                StockPriceCache.symbol == symbol
            ).first()
            
            if cache:
                # æ›´æ–°ç¾æœ‰å¿«å–
                cache.name = name or cache.name
                cache.price = price
                if prev_close is not None:
                    cache.prev_close = prev_close
                if change is not None:
                    cache.change = change
                if change_pct is not None:
                    cache.change_pct = change_pct
                if ma20 is not None:
                    cache.ma20 = ma20
                if volume is not None:
                    cache.volume = volume
                cache.updated_at = datetime.now()
                logger.debug(f"æ›´æ–°å¿«å–: {symbol} = {price}, MA20={ma20}")
            else:
                # æ–°å¢å¿«å–
                cache = StockPriceCache(
                    symbol=symbol,
                    name=name,
                    price=price,
                    prev_close=prev_close,
                    change=change,
                    change_pct=change_pct,
                    ma20=ma20,
                    volume=volume,
                    asset_type=asset_type,
                )
                db.add(cache)
                logger.info(f"æ–°å¢å¿«å–: {symbol} = {price}, MA20={ma20}")
            
            db.commit()
        finally:
            db.close()
    except Exception as e:
        # å¿«å–å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹
        logger.warning(f"å¿«å– {symbol} å¤±æ•—ï¼ˆä¸å½±éŸ¿æŸ¥è©¢ï¼‰: {e}")


def cache_crypto_price(
    symbol: str,
    name: str,
    price: float,
    change_pct: Optional[float] = None,
    volume: Optional[int] = None
):
    """
    å¿«å–åŠ å¯†è²¨å¹£åƒ¹æ ¼ï¼ˆåŠ å¯†è²¨å¹£ä¸éœ€è¦ MA20ï¼‰
    """
    cache_stock_price(
        symbol=symbol,
        name=name,
        price=price,
        change_pct=change_pct,
        volume=volume,
        asset_type="crypto"
    )
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/chart_service.py  â­â­â­
> åœ–è¡¨ç¹ªè£½æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åœ–è¡¨ç¹ªè£½æœå‹™
ä½¿ç”¨ matplotlib + mplfinance ç¹ªè£½æŠ€è¡“åˆ†æåœ–è¡¨
"""
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from matplotlib.patches import Circle
from datetime import datetime, timedelta
from pathlib import Path
from typing import Optional, Dict, Any, List, Tuple
import logging

from app.config import settings, CHARTS_DIR

logger = logging.getLogger(__name__)

# è¨­å®šä¸­æ–‡å­—é«”
plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# é¡è‰²å®šç¾©
COLORS = {
    "price": "#2196F3",      # åƒ¹æ ¼ç·š - è—è‰²
    "ma_short": "#FF9800",   # MA20 - æ©™è‰²
    "ma_mid": "#9C27B0",     # MA50 - ç´«è‰²
    "ma_long": "#F44336",    # MA200 - ç´…è‰²
    "volume_up": "#4CAF50",  # ä¸Šæ¼²æˆäº¤é‡ - ç¶ è‰²
    "volume_down": "#F44336", # ä¸‹è·Œæˆäº¤é‡ - ç´…è‰²
    "bb_fill": "#E3F2FD",    # å¸ƒæ—é€šé“å¡«å…… - æ·ºè—
    "bb_line": "#90CAF9",    # å¸ƒæ—é€šé“ç·š - è—è‰²
    "rsi": "#673AB7",        # RSI - æ·±ç´«
    "macd_dif": "#2196F3",   # MACD DIF - è—è‰²
    "macd_dea": "#FF9800",   # MACD DEA - æ©™è‰²
    "macd_hist_pos": "#4CAF50",  # MACD æ­£æŸ± - ç¶ è‰²
    "macd_hist_neg": "#F44336",  # MACD è² æŸ± - ç´…è‰²
    "kd_k": "#2196F3",       # K ç·š - è—è‰²
    "kd_d": "#FF9800",       # D ç·š - æ©™è‰²
    "golden_cross": "#4CAF50",   # é»ƒé‡‘äº¤å‰ - ç¶ è‰²
    "death_cross": "#F44336",    # æ­»äº¡äº¤å‰ - ç´…è‰²
    "grid": "#E0E0E0",       # ç¶²æ ¼ç·š
    "overbought": "#FFCDD2", # è¶…è²·å€ - æ·ºç´…
    "oversold": "#C8E6C9",   # è¶…è³£å€ - æ·ºç¶ 
}


class ChartService:
    """åœ–è¡¨ç¹ªè£½æœå‹™"""
    
    def __init__(self, output_dir: Path = None):
        self.output_dir = output_dir or CHARTS_DIR
        self.output_dir.mkdir(exist_ok=True)
    
    def plot_stock_analysis(
        self,
        df: pd.DataFrame,
        symbol: str,
        name: str = "",
        show_ma: bool = True,
        show_bollinger: bool = True,
        show_volume: bool = True,
        show_rsi: bool = True,
        show_macd: bool = True,
        show_kd: bool = False,
        show_signals: bool = True,
        days: int = 120,
        save_path: Optional[str] = None,
    ) -> str:
        """
        ç¹ªè£½å®Œæ•´è‚¡ç¥¨åˆ†æåœ–è¡¨
        
        Args:
            df: å«æœ‰åƒ¹æ ¼å’ŒæŒ‡æ¨™çš„ DataFrame
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            name: è‚¡ç¥¨åç¨±
            show_ma: é¡¯ç¤ºå‡ç·š
            show_bollinger: é¡¯ç¤ºå¸ƒæ—é€šé“
            show_volume: é¡¯ç¤ºæˆäº¤é‡
            show_rsi: é¡¯ç¤º RSI
            show_macd: é¡¯ç¤º MACD
            show_kd: é¡¯ç¤º KD
            show_signals: æ¨™è¨˜äº¤å‰è¨Šè™Ÿ
            days: é¡¯ç¤ºå¤©æ•¸
            save_path: å„²å­˜è·¯å¾‘ï¼ˆä¸æŒ‡å®šå‰‡è‡ªå‹•ç”Ÿæˆï¼‰
            
        Returns:
            åœ–è¡¨æª”æ¡ˆè·¯å¾‘
        """
        # åªå–æœ€è¿‘ N å¤©è³‡æ–™
        if len(df) > days:
            df = df.tail(days).copy()
        else:
            df = df.copy()
        
        # ç¢ºä¿ date æ¬„ä½æ­£ç¢º
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
            df = df.set_index('date')
        
        # è¨ˆç®—å­åœ–æ•¸é‡
        n_subplots = 1  # ä¸»åœ–
        if show_volume:
            n_subplots += 1
        if show_rsi:
            n_subplots += 1
        if show_macd:
            n_subplots += 1
        if show_kd:
            n_subplots += 1
        
        # è¨­å®šå­åœ–é«˜åº¦æ¯”ä¾‹
        height_ratios = [3]  # ä¸»åœ–
        if show_volume:
            height_ratios.append(1)
        if show_rsi:
            height_ratios.append(1)
        if show_macd:
            height_ratios.append(1.2)
        if show_kd:
            height_ratios.append(1)
        
        # å»ºç«‹åœ–è¡¨
        fig, axes = plt.subplots(
            n_subplots, 1,
            figsize=(14, 3 + n_subplots * 2),
            gridspec_kw={'height_ratios': height_ratios},
            sharex=True,
        )
        
        if n_subplots == 1:
            axes = [axes]
        
        ax_idx = 0
        
        # === ä¸»åœ–ï¼šåƒ¹æ ¼ + å‡ç·š + å¸ƒæ—é€šé“ ===
        ax_main = axes[ax_idx]
        ax_idx += 1
        
        self._plot_price(ax_main, df, show_ma, show_bollinger, show_signals)
        
        # æ¨™é¡Œ
        title = f"{symbol}"
        if name:
            title += f" - {name}"
        title += f"\næœ€å¾Œæ›´æ–°: {df.index[-1].strftime('%Y-%m-%d')} | æ”¶ç›¤: ${df['close'].iloc[-1]:.2f}"
        ax_main.set_title(title, fontsize=14, fontweight='bold', pad=10)
        
        # === æˆäº¤é‡ ===
        if show_volume:
            self._plot_volume(axes[ax_idx], df)
            ax_idx += 1
        
        # === RSI ===
        if show_rsi and 'rsi' in df.columns:
            self._plot_rsi(axes[ax_idx], df)
            ax_idx += 1
        
        # === MACD ===
        if show_macd and 'macd_dif' in df.columns:
            self._plot_macd(axes[ax_idx], df)
            ax_idx += 1
        
        # === KD ===
        if show_kd and 'kd_k' in df.columns:
            self._plot_kd(axes[ax_idx], df)
            ax_idx += 1
        
        # èª¿æ•´å¸ƒå±€
        plt.tight_layout()
        
        # å„²å­˜åœ–è¡¨
        if not save_path:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            save_path = self.output_dir / f"{symbol}_{timestamp}.png"
        
        plt.savefig(save_path, dpi=150, bbox_inches='tight', facecolor='white')
        plt.close(fig)
        
        logger.info(f"åœ–è¡¨å·²å„²å­˜: {save_path}")
        return str(save_path)
    
    def _plot_price(
        self,
        ax: plt.Axes,
        df: pd.DataFrame,
        show_ma: bool,
        show_bollinger: bool,
        show_signals: bool,
    ):
        """ç¹ªè£½åƒ¹æ ¼ä¸»åœ–"""
        # å¸ƒæ—é€šé“ï¼ˆå…ˆç•«ï¼Œä½œç‚ºèƒŒæ™¯ï¼‰
        if show_bollinger and 'bb_upper' in df.columns:
            ax.fill_between(
                df.index,
                df['bb_lower'],
                df['bb_upper'],
                color=COLORS['bb_fill'],
                alpha=0.5,
                label='å¸ƒæ—é€šé“',
            )
            ax.plot(df.index, df['bb_middle'], color=COLORS['bb_line'], 
                   linewidth=0.8, linestyle='--', alpha=0.7)
        
        # åƒ¹æ ¼ç·š
        ax.plot(df.index, df['close'], color=COLORS['price'], 
               linewidth=1.5, label='æ”¶ç›¤åƒ¹')
        
        # å‡ç·š
        if show_ma:
            ma_short = f"ma{settings.MA_SHORT}"
            ma_mid = f"ma{settings.MA_MID}"
            ma_long = f"ma{settings.MA_LONG}"
            
            if ma_short in df.columns:
                ax.plot(df.index, df[ma_short], color=COLORS['ma_short'],
                       linewidth=1, label=f'MA{settings.MA_SHORT}')
            if ma_mid in df.columns:
                ax.plot(df.index, df[ma_mid], color=COLORS['ma_mid'],
                       linewidth=1, label=f'MA{settings.MA_MID}')
            if ma_long in df.columns:
                ax.plot(df.index, df[ma_long], color=COLORS['ma_long'],
                       linewidth=1, label=f'MA{settings.MA_LONG}')
        
        # æ¨™è¨˜äº¤å‰è¨Šè™Ÿ
        if show_signals and show_ma:
            self._mark_crossovers(ax, df)
        
        # è¨­å®š
        ax.set_ylabel('åƒ¹æ ¼ ($)', fontsize=10)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        ax.set_xlim(df.index[0], df.index[-1])
    
    def _mark_crossovers(self, ax: plt.Axes, df: pd.DataFrame):
        """æ¨™è¨˜å‡ç·šäº¤å‰é»"""
        ma_short = f"ma{settings.MA_SHORT}"
        ma_mid = f"ma{settings.MA_MID}"
        
        if ma_short not in df.columns or ma_mid not in df.columns:
            return
        
        for i in range(1, len(df)):
            # é»ƒé‡‘äº¤å‰
            if (df[ma_short].iloc[i-1] < df[ma_mid].iloc[i-1] and 
                df[ma_short].iloc[i] > df[ma_mid].iloc[i]):
                ax.scatter(df.index[i], df['close'].iloc[i], 
                          color=COLORS['golden_cross'], s=100, marker='^', 
                          zorder=5, edgecolors='white', linewidths=1)
            
            # æ­»äº¡äº¤å‰
            elif (df[ma_short].iloc[i-1] > df[ma_mid].iloc[i-1] and 
                  df[ma_short].iloc[i] < df[ma_mid].iloc[i]):
                ax.scatter(df.index[i], df['close'].iloc[i], 
                          color=COLORS['death_cross'], s=100, marker='v', 
                          zorder=5, edgecolors='white', linewidths=1)
    
    def _plot_volume(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½æˆäº¤é‡"""
        colors = []
        for i in range(len(df)):
            if i == 0:
                colors.append(COLORS['volume_up'])
            elif df['close'].iloc[i] >= df['close'].iloc[i-1]:
                colors.append(COLORS['volume_up'])
            else:
                colors.append(COLORS['volume_down'])
        
        ax.bar(df.index, df['volume'], color=colors, alpha=0.7, width=0.8)
        
        # 20æ—¥å‡é‡ç·š
        if 'volume_ma20' in df.columns:
            ax.plot(df.index, df['volume_ma20'], color='orange', 
                   linewidth=1, label='20æ—¥å‡é‡')
            ax.legend(loc='upper left', fontsize=8)
        
        ax.set_ylabel('æˆäº¤é‡', fontsize=10)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        
        # æ ¼å¼åŒ– Y è»¸
        ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1e6:.1f}M'))
    
    def _plot_rsi(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½ RSI"""
        # è¶…è²·è¶…è³£å€åŸŸ
        ax.axhspan(settings.RSI_OVERBOUGHT, 100, color=COLORS['overbought'], alpha=0.3)
        ax.axhspan(0, settings.RSI_OVERSOLD, color=COLORS['oversold'], alpha=0.3)
        
        # ä¸­ç·š
        ax.axhline(y=50, color='gray', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=settings.RSI_OVERBOUGHT, color='red', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=settings.RSI_OVERSOLD, color='green', linestyle='--', linewidth=0.8, alpha=0.5)
        
        # RSI ç·š
        ax.plot(df.index, df['rsi'], color=COLORS['rsi'], linewidth=1.2, label='RSI')
        
        # è¨­å®š
        ax.set_ylabel('RSI', fontsize=10)
        ax.set_ylim(0, 100)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        
        # æ¨™è¨˜æœ€æ–°å€¼
        latest_rsi = df['rsi'].iloc[-1]
        if not pd.isna(latest_rsi):
            ax.annotate(f'{latest_rsi:.1f}', 
                       xy=(df.index[-1], latest_rsi),
                       xytext=(5, 0), textcoords='offset points',
                       fontsize=9, color=COLORS['rsi'])
    
    def _plot_macd(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½ MACD"""
        # é›¶è»¸
        ax.axhline(y=0, color='gray', linestyle='-', linewidth=0.8)
        
        # MACD æŸ±ç‹€åœ–
        colors = [COLORS['macd_hist_pos'] if v >= 0 else COLORS['macd_hist_neg'] 
                 for v in df['macd_hist']]
        ax.bar(df.index, df['macd_hist'], color=colors, alpha=0.6, width=0.8)
        
        # DIF å’Œ DEA ç·š
        ax.plot(df.index, df['macd_dif'], color=COLORS['macd_dif'], 
               linewidth=1.2, label='DIF')
        ax.plot(df.index, df['macd_dea'], color=COLORS['macd_dea'], 
               linewidth=1.2, label='DEA')
        
        # æ¨™è¨˜äº¤å‰é»
        for i in range(1, len(df)):
            if pd.isna(df['macd_dif'].iloc[i]) or pd.isna(df['macd_dea'].iloc[i]):
                continue
            # é»ƒé‡‘äº¤å‰
            if (df['macd_dif'].iloc[i-1] < df['macd_dea'].iloc[i-1] and 
                df['macd_dif'].iloc[i] > df['macd_dea'].iloc[i]):
                ax.scatter(df.index[i], df['macd_dif'].iloc[i], 
                          color=COLORS['golden_cross'], s=50, marker='^', zorder=5)
            # æ­»äº¡äº¤å‰
            elif (df['macd_dif'].iloc[i-1] > df['macd_dea'].iloc[i-1] and 
                  df['macd_dif'].iloc[i] < df['macd_dea'].iloc[i]):
                ax.scatter(df.index[i], df['macd_dif'].iloc[i], 
                          color=COLORS['death_cross'], s=50, marker='v', zorder=5)
        
        # è¨­å®š
        ax.set_ylabel('MACD', fontsize=10)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
    
    def _plot_kd(self, ax: plt.Axes, df: pd.DataFrame):
        """ç¹ªè£½ KD"""
        # è¶…è²·è¶…è³£å€åŸŸ
        ax.axhspan(80, 100, color=COLORS['overbought'], alpha=0.3)
        ax.axhspan(0, 20, color=COLORS['oversold'], alpha=0.3)
        
        # ä¸­ç·š
        ax.axhline(y=50, color='gray', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=80, color='red', linestyle='--', linewidth=0.8, alpha=0.5)
        ax.axhline(y=20, color='green', linestyle='--', linewidth=0.8, alpha=0.5)
        
        # K å’Œ D ç·š
        ax.plot(df.index, df['kd_k'], color=COLORS['kd_k'], linewidth=1.2, label='K')
        ax.plot(df.index, df['kd_d'], color=COLORS['kd_d'], linewidth=1.2, label='D')
        
        # è¨­å®š
        ax.set_ylabel('KD', fontsize=10)
        ax.set_ylim(0, 100)
        ax.legend(loc='upper left', fontsize=8)
        ax.grid(True, color=COLORS['grid'], linestyle='-', linewidth=0.5, alpha=0.7)
        ax.set_xlabel('æ—¥æœŸ', fontsize=10)
    
    def plot_candlestick(
        self,
        df: pd.DataFrame,
        symbol: str,
        name: str = "",
        days: int = 60,
        save_path: Optional[str] = None,
    ) -> str:
        """
        ç¹ªè£½ K ç·šåœ–ï¼ˆä½¿ç”¨ mplfinanceï¼‰
        
        Args:
            df: OHLCV DataFrame
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            name: è‚¡ç¥¨åç¨±
            days: é¡¯ç¤ºå¤©æ•¸
            save_path: å„²å­˜è·¯å¾‘
            
        Returns:
            åœ–è¡¨æª”æ¡ˆè·¯å¾‘
        """
        try:
            import mplfinance as mpf
        except ImportError:
            logger.warning("mplfinance æœªå®‰è£ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ")
            return self._plot_candlestick_fallback(df, symbol, name, days, save_path)
        
        # æº–å‚™è³‡æ–™
        if len(df) > days:
            df = df.tail(days).copy()
        else:
            df = df.copy()
        
        # ç¢ºä¿ç´¢å¼•ç‚º DatetimeIndex
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
            df = df.set_index('date')
        
        # ç¢ºä¿æ¬„ä½åç¨±æ­£ç¢ºï¼ˆmplfinance éœ€è¦å¤§å¯«ï¼‰
        df = df.rename(columns={
            'open': 'Open',
            'high': 'High',
            'low': 'Low',
            'close': 'Close',
            'volume': 'Volume',
        })
        
        # æº–å‚™å‡ç·š
        ma_short = f"ma{settings.MA_SHORT}"
        ma_mid = f"ma{settings.MA_MID}"
        ma_long = f"ma{settings.MA_LONG}"
        
        addplots = []
        if ma_short in df.columns:
            addplots.append(mpf.make_addplot(df[ma_short], color=COLORS['ma_short']))
        if ma_mid in df.columns:
            addplots.append(mpf.make_addplot(df[ma_mid], color=COLORS['ma_mid']))
        if ma_long in df.columns:
            addplots.append(mpf.make_addplot(df[ma_long], color=COLORS['ma_long']))
        
        # è¨­å®šæ¨£å¼
        mc = mpf.make_marketcolors(
            up='#4CAF50',
            down='#F44336',
            edge='inherit',
            wick='inherit',
            volume='inherit',
        )
        style = mpf.make_mpf_style(
            marketcolors=mc,
            gridstyle='-',
            gridcolor=COLORS['grid'],
        )
        
        # å„²å­˜è·¯å¾‘
        if not save_path:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            save_path = self.output_dir / f"{symbol}_kline_{timestamp}.png"
        
        # æ¨™é¡Œ
        title = f"{symbol}"
        if name:
            title += f" - {name}"
        
        # ç¹ªè£½
        mpf.plot(
            df,
            type='candle',
            style=style,
            title=title,
            ylabel='åƒ¹æ ¼ ($)',
            ylabel_lower='æˆäº¤é‡',
            volume=True,
            addplot=addplots if addplots else None,
            figsize=(14, 8),
            savefig=str(save_path),
        )
        
        logger.info(f"Kç·šåœ–å·²å„²å­˜: {save_path}")
        return str(save_path)
    
    def _plot_candlestick_fallback(
        self,
        df: pd.DataFrame,
        symbol: str,
        name: str,
        days: int,
        save_path: Optional[str],
    ) -> str:
        """ç•¶ mplfinance ä¸å¯ç”¨æ™‚çš„æ›¿ä»£ K ç·šåœ–"""
        if len(df) > days:
            df = df.tail(days).copy()
        else:
            df = df.copy()
        
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
            df = df.set_index('date')
        
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(14, 8), 
                                        gridspec_kw={'height_ratios': [3, 1]},
                                        sharex=True)
        
        # K ç·š
        width = 0.6
        width2 = 0.1
        
        up = df[df['close'] >= df['open']]
        down = df[df['close'] < df['open']]
        
        # ä¸Šæ¼² K ç·š
        ax1.bar(up.index, up['close'] - up['open'], width, bottom=up['open'], 
               color='#4CAF50', edgecolor='#4CAF50')
        ax1.bar(up.index, up['high'] - up['close'], width2, bottom=up['close'], 
               color='#4CAF50')
        ax1.bar(up.index, up['low'] - up['open'], width2, bottom=up['open'], 
               color='#4CAF50')
        
        # ä¸‹è·Œ K ç·š
        ax1.bar(down.index, down['close'] - down['open'], width, bottom=down['open'], 
               color='#F44336', edgecolor='#F44336')
        ax1.bar(down.index, down['high'] - down['open'], width2, bottom=down['open'], 
               color='#F44336')
        ax1.bar(down.index, down['low'] - down['close'], width2, bottom=down['close'], 
               color='#F44336')
        
        # æ¨™é¡Œ
        title = f"{symbol}"
        if name:
            title += f" - {name}"
        ax1.set_title(title, fontsize=14, fontweight='bold')
        ax1.set_ylabel('åƒ¹æ ¼ ($)')
        ax1.grid(True, alpha=0.3)
        
        # æˆäº¤é‡
        colors = ['#4CAF50' if df['close'].iloc[i] >= df['open'].iloc[i] 
                 else '#F44336' for i in range(len(df))]
        ax2.bar(df.index, df['volume'], color=colors, alpha=0.7)
        ax2.set_ylabel('æˆäº¤é‡')
        ax2.grid(True, alpha=0.3)
        
        plt.tight_layout()
        
        if not save_path:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            save_path = self.output_dir / f"{symbol}_kline_{timestamp}.png"
        
        plt.savefig(save_path, dpi=150, bbox_inches='tight', facecolor='white')
        plt.close(fig)
        
        return str(save_path)


# å»ºç«‹é è¨­å¯¦ä¾‹
chart_service = ChartService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/compare_service.py  â­â­â­
> å ±é…¬ç‡æ¯”è¼ƒæœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å ±é…¬ç‡æ¯”è¼ƒæœå‹™
è¨ˆç®—ä¸¦æ¯”è¼ƒå¤šå€‹æ¨™çš„çš„å¹´åŒ–å ±é…¬ç‡ (CAGR)

ä¿®å¾©ï¼š
1. å°è‚¡ä»£è™Ÿè‡ªå‹•åŠ  .TW / .TWO
2. ä½¿ç”¨èª¿æ•´å¾Œåƒ¹æ ¼(adj_close)è¨ˆç®—ï¼Œé¿å…åˆ†å‰²å½±éŸ¿
3. åŠ å…¥é…æ¯é‚„åŸï¼Œåæ˜ çœŸå¯¦å ±é…¬
"""
import logging
from datetime import datetime, date, timedelta
from typing import List, Dict, Any, Optional, Tuple
import json
import math

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_
import pandas as pd

from app.models.comparison import Comparison
from app.data_sources.yahoo_finance import yahoo_finance
from app.data_sources.coingecko import coingecko, CRYPTO_MAP

logger = logging.getLogger(__name__)


# é è¨­æ¯”è¼ƒçµ„åˆ
PRESET_GROUPS = {
    "us_tech": {
        "name": "ç¾åœ‹ç§‘æŠ€è‚¡",
        "symbols": ["AAPL", "MSFT", "GOOGL", "AMZN", "NVDA"],
        "description": "ç¾åœ‹äº”å¤§ç§‘æŠ€å·¨é ­"
    },
    "crypto_major": {
        "name": "ä¸»æµåŠ å¯†è²¨å¹£",
        "symbols": ["BTC", "ETH", "SOL", "BNB", "XRP"],
        "description": "å¸‚å€¼å‰äº”å¤§åŠ å¯†è²¨å¹£"
    },
    "index": {
        "name": "å¤§ç›¤æŒ‡æ•¸",
        "symbols": ["^GSPC", "^IXIC", "^DJI"],
        "description": "ç¾åœ‹ä¸‰å¤§æŒ‡æ•¸"
    },
    "etf_popular": {
        "name": "ç†±é–€ ETF",
        "symbols": ["SPY", "QQQ", "VOO", "VTI", "IWM"],
        "description": "æœ€å—æ­¡è¿çš„ ETF"
    },
    "dividend": {
        "name": "é«˜è‚¡æ¯è‚¡ç¥¨",
        "symbols": ["JNJ", "PG", "KO", "PEP", "VZ"],
        "description": "ç©©å®šé…æ¯çš„è—ç±Œè‚¡"
    },
    "tw_etf": {
        "name": "å°è‚¡ ETF",
        "symbols": ["0050", "0056", "00878", "00919", "006208"],
        "description": "å°ç£ç†±é–€ ETF"
    },
    "tw_tech": {
        "name": "å°ç£ç§‘æŠ€è‚¡",
        "symbols": ["2330", "2454", "2317", "3711", "2308"],
        "description": "å°ç£ç§‘æŠ€æ¬Šå€¼è‚¡"
    }
}

# åŸºæº–æŒ‡æ•¸é¸é …
BENCHMARK_OPTIONS = {
    "^GSPC": "S&P 500",
    "^IXIC": "ç´æ–¯é”å…‹",
    "^DJI": "é“ç“Šå·¥æ¥­",
    "": "ç„¡"
}

# æ”¯æ´çš„åŠ å¯†è²¨å¹£
SUPPORTED_CRYPTO = set(k for k in CRYPTO_MAP.keys() if k not in ("BITCOIN", "ETHEREUM"))


class CompareService:
    """å ±é…¬ç‡æ¯”è¼ƒæœå‹™"""
    
    def __init__(self):
        self.max_symbols = 5  # æœ€å¤šæ¯”è¼ƒ 5 å€‹
    
    def _normalize_symbol(self, symbol: str) -> str:
        """
        æ¨™æº–åŒ–è‚¡ç¥¨ä»£è™Ÿ
        - å°è‚¡ä»£è™Ÿï¼ˆç´”æ•¸å­— 4-6 ä½ï¼‰è‡ªå‹•åŠ  .TW
        - å…¶ä»–ä¿æŒåŸæ¨£
        """
        symbol = symbol.strip().upper()
        
        # å¦‚æœå·²ç¶“æœ‰å¾Œç¶´ï¼Œä¸è™•ç†
        if '.' in symbol or symbol.startswith('^'):
            return symbol
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£
        if symbol in SUPPORTED_CRYPTO:
            return symbol
        
        # å°è‚¡ä»£è™Ÿï¼š4-6 ä½ç´”æ•¸å­—
        if symbol.isdigit() and 4 <= len(symbol) <= 6:
            return f"{symbol}.TW"
        
        return symbol
    
    def _get_asset_type(self, symbol: str) -> str:
        """åˆ¤æ–·è³‡ç”¢é¡å‹"""
        symbol_upper = symbol.upper()
        
        # å…ˆæª¢æŸ¥åŸå§‹ä»£è™Ÿæ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£
        base_symbol = symbol_upper.replace('.TW', '').replace('.TWO', '')
        if base_symbol in SUPPORTED_CRYPTO:
            return "crypto"
        
        if symbol_upper.startswith("^"):
            return "index"
        elif symbol_upper.endswith(".TW") or symbol_upper.endswith(".TWO"):
            return "tw_stock"
        else:
            return "stock"
    
    def _get_period_days(self, period: str) -> int:
        """å–å¾—æ™‚é–“é€±æœŸå°æ‡‰çš„å¤©æ•¸"""
        period_map = {
            "1y": 365,
            "3y": 365 * 3,
            "5y": 365 * 5,
            "10y": 365 * 10,
        }
        return period_map.get(period, 365)
    
    async def _fetch_price_data(
        self,
        symbol: str,
        days: int = 3650,  # é è¨­æŠ“ 10 å¹´
    ) -> Tuple[Optional[pd.DataFrame], Optional[Dict]]:
        """
        æŠ“å–åƒ¹æ ¼è³‡æ–™
        
        Returns:
            (DataFrame, info_dict) æˆ– (None, None)
        """
        asset_type = self._get_asset_type(symbol)
        
        try:
            if asset_type == "crypto":
                # åŠ å¯†è²¨å¹£ç”¨ CoinGecko
                df = coingecko.get_crypto_history(symbol, days=days)
                info = coingecko.get_crypto_info(symbol)
                if info:
                    info_dict = {
                        "name": info.get("name", symbol),
                        "type": "crypto",
                        "current_price": info.get("current_price"),
                    }
                else:
                    info_dict = {"name": symbol, "type": "crypto", "current_price": None}
                return df, info_dict
            else:
                # è‚¡ç¥¨/æŒ‡æ•¸/ETF ç”¨ Yahoo Finance
                period = "10y" if days >= 3650 else ("5y" if days >= 1825 else "1y")
                df = yahoo_finance.get_stock_history(symbol, period=period)
                
                # å¦‚æœ .TW æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ .TWO (ä¸Šæ«ƒè‚¡ç¥¨)
                if (df is None or df.empty) and symbol.endswith('.TW'):
                    two_symbol = symbol.replace('.TW', '.TWO')
                    logger.info(f"{symbol} æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
                    df = yahoo_finance.get_stock_history(two_symbol, period=period)
                    if df is not None and not df.empty:
                        symbol = two_symbol
                        logger.info(f"æˆåŠŸæ‰¾åˆ°ä¸Šæ«ƒè‚¡ç¥¨: {two_symbol}")
                
                info = yahoo_finance.get_stock_info(symbol)
                
                # å–å¾—ç¾åƒ¹ï¼ˆç”¨åŸå§‹æ”¶ç›¤åƒ¹ï¼‰
                current_price = None
                if df is not None and not df.empty:
                    current_price = float(df['close'].iloc[-1])
                
                if info:
                    info_dict = {
                        "name": info.get("name", symbol),
                        "type": asset_type,
                        "current_price": current_price or info.get("current_price"),
                        "symbol": symbol,  # å¯èƒ½å·²ç¶“æ”¹æˆ .TWO
                    }
                else:
                    info_dict = {
                        "name": symbol, 
                        "type": asset_type, 
                        "current_price": current_price,
                        "symbol": symbol,
                    }
                
                return df, info_dict
            
        except Exception as e:
            logger.error(f"æŠ“å– {symbol} è³‡æ–™å¤±æ•—: {e}")
            return None, None
    
    def _calculate_cagr_with_dividends(
        self,
        symbol: str,
        df: pd.DataFrame,
        years: int,
    ) -> Optional[float]:
        """
        è¨ˆç®—å«é…æ¯èª¿æ•´çš„ CAGR
        
        ä½¿ç”¨ adj_closeï¼ˆåˆ†å‰²èª¿æ•´ï¼‰+ é…æ¯é‚„åŸ
        é€™å’Œè‚¡ç¥¨æŸ¥è©¢é é¢çš„è¨ˆç®—æ–¹å¼ä¸€è‡´
        """
        if df is None or df.empty:
            return None
        
        try:
            # ç¢ºä¿æœ‰ date æ¬„ä½
            if 'date' not in df.columns:
                df = df.reset_index()
                if 'Date' in df.columns:
                    df = df.rename(columns={'Date': 'date'})
            
            df['date'] = pd.to_datetime(df['date']).dt.date
            df = df.sort_values('date').reset_index(drop=True)
            
            current_date = df['date'].iloc[-1]
            target_date = current_date - timedelta(days=years * 365)
            
            # æ‰¾åˆ°ç›®æ¨™æ—¥æœŸä¹‹å‰çš„è³‡æ–™
            past_df = df[df['date'] <= target_date]
            
            if past_df.empty or len(past_df) < 10:
                return None
            
            # å„ªå…ˆä½¿ç”¨ adj_closeï¼Œæ²’æœ‰å‰‡ç”¨ close
            price_col = 'adj_close' if 'adj_close' in df.columns else 'close'
            
            start_row = past_df.iloc[-1]
            start_price = float(start_row[price_col])
            start_date = start_row['date']
            
            current_price = float(df.iloc[-1][price_col])
            
            if start_price <= 0:
                return None
            
            # å–å¾—é…æ¯è³‡æ–™ä¸¦èª¿æ•´
            try:
                dividends_df = yahoo_finance.get_dividends(symbol, period=f"{years + 1}y")
                
                if dividends_df is not None and not dividends_df.empty:
                    # å»ºç«‹å«é…æ¯èª¿æ•´çš„åƒ¹æ ¼åºåˆ—
                    df_adj = df.copy()
                    df_adj['adj_with_div'] = df_adj[price_col].astype(float)
                    
                    date_to_idx = {row['date']: idx for idx, row in df_adj.iterrows()}
                    
                    # ç¯©é¸åœ¨è¨ˆç®—ç¯„åœå…§çš„é…æ¯
                    min_date = df_adj['date'].min()
                    max_date = df_adj['date'].max()
                    
                    dividends = {}
                    for _, row in dividends_df.iterrows():
                        div_date = row['date']
                        if isinstance(div_date, str):
                            div_date = datetime.strptime(div_date, '%Y-%m-%d').date()
                        elif hasattr(div_date, 'date'):
                            div_date = div_date.date()
                        if min_date < div_date <= max_date:
                            dividends[div_date] = float(row['amount'])
                    
                    # å¾æœ€æ–°åˆ°æœ€èˆŠè™•ç†é…æ¯ï¼ˆé…æ¯é‚„åŸèª¿æ•´ï¼‰
                    for div_date, div_amount in sorted(dividends.items(), reverse=True):
                        if div_date in date_to_idx:
                            ex_idx = date_to_idx[div_date]
                            if ex_idx > 0:
                                prev_price = df_adj.loc[ex_idx - 1, 'adj_with_div']
                                if prev_price > div_amount and div_amount > 0:
                                    adjustment_factor = prev_price / (prev_price - div_amount)
                                    df_adj.loc[:ex_idx-1, 'adj_with_div'] = df_adj.loc[:ex_idx-1, 'adj_with_div'] / adjustment_factor
                    
                    # ä½¿ç”¨èª¿æ•´å¾Œçš„åƒ¹æ ¼è¨ˆç®—
                    start_price = float(df_adj[df_adj['date'] <= target_date].iloc[-1]['adj_with_div'])
                    current_price = float(df_adj.iloc[-1]['adj_with_div'])
                    
                    logger.debug(f"{symbol} é…æ¯èª¿æ•´: æ‰¾åˆ° {len(dividends)} ç­†é…æ¯")
                    
            except Exception as e:
                logger.warning(f"{symbol} é…æ¯èª¿æ•´å¤±æ•—ï¼Œä½¿ç”¨åŸºæœ¬è¨ˆç®—: {e}")
            
            # å¯¦éš›å¹´æ•¸ï¼ˆæ›´ç²¾ç¢ºï¼‰
            actual_days = (current_date - start_date).days
            actual_years = actual_days / 365.25
            
            if actual_years < 0.5:
                return None
            
            # CAGR å…¬å¼
            cagr = (current_price / start_price) ** (1 / actual_years) - 1
            
            # æª¢æŸ¥æœ‰æ•ˆæ€§
            if math.isnan(cagr) or math.isinf(cagr):
                return None
            
            return round(cagr * 100, 2)
            
        except Exception as e:
            logger.error(f"è¨ˆç®— {symbol} CAGR å¤±æ•—: {e}")
            return None
    
    def _calculate_custom_cagr(
        self,
        df: pd.DataFrame,
        start_date: date,
        end_date: date,
    ) -> Optional[float]:
        """è¨ˆç®—è‡ªè¨‚å€é–“çš„ CAGR"""
        if df is None or df.empty:
            return None
        
        try:
            # ç¢ºä¿æ—¥æœŸæ¬„ä½
            if 'date' in df.columns:
                df = df.set_index('date')
            
            # ç¯©é¸æ—¥æœŸç¯„åœ
            mask = (df.index >= pd.Timestamp(start_date)) & (df.index <= pd.Timestamp(end_date))
            filtered_df = df[mask]
            
            if len(filtered_df) < 2:
                return None
            
            # å„ªå…ˆä½¿ç”¨ adj_close
            price_col = 'adj_close' if 'adj_close' in filtered_df.columns else 'close'
            
            start_price = float(filtered_df[price_col].iloc[0])
            end_price = float(filtered_df[price_col].iloc[-1])
            
            # è¨ˆç®—å¹´æ•¸
            days = (end_date - start_date).days
            years = days / 365.0
            
            if years <= 0 or start_price <= 0:
                return None
            
            # CAGR å…¬å¼
            cagr = (end_price / start_price) ** (1 / years) - 1
            return round(cagr * 100, 2)
            
        except Exception as e:
            logger.error(f"è¨ˆç®—è‡ªè¨‚ CAGR å¤±æ•—: {e}")
            return None
    
    async def compare_cagr(
        self,
        symbols: List[str],
        periods: List[str] = None,
        custom_range: Dict[str, str] = None,
        benchmark: str = "^GSPC",
        sort_by: str = "5y",
        sort_order: str = "desc",
    ) -> Dict[str, Any]:
        """
        æ¯”è¼ƒå¤šå€‹æ¨™çš„çš„å¹´åŒ–å ±é…¬ç‡
        
        Args:
            symbols: æ¨™çš„ä»£è™Ÿåˆ—è¡¨ (æœ€å¤š 5 å€‹)
            periods: æ™‚é–“é€±æœŸ ["1y", "3y", "5y", "10y"]
            custom_range: è‡ªè¨‚å€é–“ {"start": "2020-01-01", "end": "2024-12-31"}
            benchmark: åŸºæº–æŒ‡æ•¸
            sort_by: æ’åºä¾æ“š
            sort_order: æ’åºæ–¹å‘ "asc" / "desc"
            
        Returns:
            æ¯”è¼ƒçµæœ
        """
        # é©—è­‰
        if not symbols:
            return {"success": False, "error": "è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™çš„"}
        
        if len(symbols) > self.max_symbols:
            return {"success": False, "error": f"æœ€å¤šåªèƒ½æ¯”è¼ƒ {self.max_symbols} å€‹æ¨™çš„"}
        
        if periods is None:
            periods = ["1y", "3y", "5y"]
        
        # æ­£è¦åŒ–ä»£è™Ÿï¼ˆè™•ç†å°è‚¡ç­‰ï¼‰
        symbols = [self._normalize_symbol(s) for s in symbols]
        logger.info(f"æ¨™æº–åŒ–å¾Œçš„ä»£è™Ÿ: {symbols}")
        
        # è¨ˆç®—éœ€è¦çš„å¤©æ•¸
        max_days = 3650  # 10 å¹´
        if custom_range:
            try:
                start_date = datetime.strptime(custom_range["start"], "%Y-%m-%d").date()
                end_date = datetime.strptime(custom_range["end"], "%Y-%m-%d").date()
                custom_days = (date.today() - start_date).days
                max_days = max(max_days, custom_days)
            except (ValueError, KeyError):
                custom_range = None
        
        results = []
        
        # è™•ç†æ¯å€‹æ¨™çš„
        for symbol in symbols:
            df, info = await self._fetch_price_data(symbol, max_days)
            
            # å¦‚æœæœ‰ symbol æ›´æ–°ï¼ˆä¾‹å¦‚ .TW -> .TWOï¼‰ï¼Œä½¿ç”¨æ›´æ–°å¾Œçš„
            actual_symbol = info.get("symbol", symbol) if info else symbol
            
            if df is None or info is None:
                results.append({
                    "symbol": actual_symbol,
                    "name": actual_symbol,
                    "type": self._get_asset_type(actual_symbol),
                    "current_price": None,
                    "cagr": {p: None for p in periods},
                    "error": "ç„¡æ³•å–å¾—è³‡æ–™"
                })
                continue
            
            # è¨ˆç®—å„é€±æœŸ CAGRï¼ˆä½¿ç”¨å«é…æ¯çš„è¨ˆç®—ï¼‰
            cagr_results = {}
            for period in periods:
                period_years = {"1y": 1, "3y": 3, "5y": 5, "10y": 10}.get(period)
                if period_years:
                    cagr_results[period] = self._calculate_cagr_with_dividends(
                        actual_symbol, df, period_years
                    )
            
            # è‡ªè¨‚å€é–“
            if custom_range:
                cagr_results["custom"] = self._calculate_custom_cagr(
                    df, start_date, end_date
                )
            
            results.append({
                "symbol": actual_symbol,
                "name": info.get("name", actual_symbol),
                "type": info.get("type", "stock"),
                "current_price": info.get("current_price"),
                "cagr": cagr_results,
            })
        
        # è¨ˆç®—åŸºæº–æŒ‡æ•¸
        benchmark_data = None
        if benchmark:
            benchmark_df, benchmark_info = await self._fetch_price_data(benchmark, max_days)
            if benchmark_df is not None:
                benchmark_cagr = {}
                for period in periods:
                    period_years = {"1y": 1, "3y": 3, "5y": 5, "10y": 10}.get(period)
                    if period_years:
                        benchmark_cagr[period] = self._calculate_cagr_with_dividends(
                            benchmark, benchmark_df, period_years
                        )
                
                benchmark_data = {
                    "symbol": benchmark,
                    "name": BENCHMARK_OPTIONS.get(benchmark, benchmark),
                    "cagr": benchmark_cagr,
                }
                
                # è¨ˆç®— vs benchmark
                for result in results:
                    result["vs_benchmark"] = {}
                    for period in periods:
                        result_cagr = result["cagr"].get(period)
                        bench_cagr = benchmark_cagr.get(period)
                        if result_cagr is not None and bench_cagr is not None:
                            result["vs_benchmark"][period] = round(result_cagr - bench_cagr, 2)
                        else:
                            result["vs_benchmark"][period] = None
        
        # æ’åº
        def get_sort_value(item):
            val = item.get("cagr", {}).get(sort_by)
            return val if val is not None else float('-inf')
        
        results.sort(key=get_sort_value, reverse=(sort_order == "desc"))
        
        # åŠ å…¥æ’å
        for i, result in enumerate(results):
            result["rank"] = i + 1
        
        return {
            "success": True,
            "comparison": results,
            "benchmark": benchmark_data,
            "periods": periods + (["custom"] if custom_range else []),
            "custom_range": custom_range,
            "sort_by": sort_by,
            "generated_at": datetime.now().isoformat(),
            "note": "CAGR å·²åŒ…å«åˆ†å‰²èª¿æ•´åŠé…æ¯å†æŠ•å…¥æ•ˆæœ"
        }
    
    def get_presets(self) -> List[Dict[str, Any]]:
        """å–å¾—é è¨­çµ„åˆåˆ—è¡¨"""
        return [
            {
                "id": key,
                "name": value["name"],
                "description": value["description"],
                "symbols": value["symbols"],
                "count": len(value["symbols"]),
            }
            for key, value in PRESET_GROUPS.items()
        ]
    
    def get_preset_detail(self, preset_id: str) -> Optional[Dict[str, Any]]:
        """å–å¾—é è¨­çµ„åˆè©³æƒ…"""
        if preset_id not in PRESET_GROUPS:
            return None
        
        preset = PRESET_GROUPS[preset_id]
        return {
            "id": preset_id,
            "name": preset["name"],
            "description": preset["description"],
            "symbols": preset["symbols"],
        }


class ComparisonCRUD:
    """æ¯”è¼ƒçµ„åˆ CRUD æ“ä½œ"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def get_user_comparisons(self, user_id: int) -> List[Comparison]:
        """å–å¾—ç”¨æˆ¶çš„æ¯”è¼ƒçµ„åˆ"""
        result = await self.db.execute(
            select(Comparison)
            .where(Comparison.user_id == user_id)
            .order_by(Comparison.updated_at.desc())
        )
        return result.scalars().all()
    
    async def get_comparison_by_id(self, comparison_id: int, user_id: int) -> Optional[Comparison]:
        """å–å¾—å–®ä¸€æ¯”è¼ƒçµ„åˆ"""
        result = await self.db.execute(
            select(Comparison)
            .where(and_(Comparison.id == comparison_id, Comparison.user_id == user_id))
        )
        return result.scalar_one_or_none()
    
    async def create_comparison(
        self,
        user_id: int,
        name: str,
        symbols: List[str],
        benchmark: str = None,
    ) -> Comparison:
        """å»ºç«‹æ¯”è¼ƒçµ„åˆ"""
        comparison = Comparison(
            user_id=user_id,
            name=name,
            _symbols=json.dumps(symbols),
            benchmark=benchmark,
        )
        self.db.add(comparison)
        await self.db.commit()
        await self.db.refresh(comparison)
        return comparison
    
    async def update_comparison(
        self,
        comparison: Comparison,
        name: str = None,
        symbols: List[str] = None,
        benchmark: str = None,
    ) -> Comparison:
        """æ›´æ–°æ¯”è¼ƒçµ„åˆ"""
        if name is not None:
            comparison.name = name
        if symbols is not None:
            comparison._symbols = json.dumps(symbols)
        if benchmark is not None:
            comparison.benchmark = benchmark
        
        await self.db.commit()
        await self.db.refresh(comparison)
        return comparison
    
    async def delete_comparison(self, comparison: Comparison) -> bool:
        """åˆªé™¤æ¯”è¼ƒçµ„åˆ"""
        await self.db.delete(comparison)
        await self.db.commit()
        return True
    
    async def count_user_comparisons(self, user_id: int) -> int:
        """è¨ˆç®—ç”¨æˆ¶çš„æ¯”è¼ƒçµ„åˆæ•¸é‡"""
        result = await self.db.execute(
            select(Comparison)
            .where(Comparison.user_id == user_id)
        )
        return len(result.scalars().all())


# å–®ä¾‹
compare_service = CompareService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/crypto_service.py  â­â­â­
> åŠ å¯†è²¨å¹£æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŠ å¯†è²¨å¹£æœå‹™
æ•´åˆ CoinGecko è³‡æ–™ã€å¿«å–å’ŒæŠ€è¡“æŒ‡æ¨™è¨ˆç®—
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Dict, Any, List
from sqlalchemy.orm import Session
from sqlalchemy import select, and_
import logging

from app.models.crypto_price import CryptoPrice
from app.models.market_sentiment import MarketSentiment
from app.data_sources.coingecko import coingecko
from app.data_sources.fear_greed import fear_greed
from app.services.indicator_service import indicator_service, TrendDirection
from app.config import settings

logger = logging.getLogger(__name__)


class CryptoService:
    """åŠ å¯†è²¨å¹£æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def _is_cache_valid(self, symbol: str) -> bool:
        """æª¢æŸ¥å¿«å–æ˜¯å¦æœ‰æ•ˆ"""
        today = date.today()
        
        stmt = (
            select(CryptoPrice)
            .where(CryptoPrice.symbol == symbol.upper())
            .order_by(CryptoPrice.date.desc())
            .limit(1)
        )
        result = self.db.execute(stmt).scalar_one_or_none()
        
        if not result:
            return False
        
        # åŠ å¯†è²¨å¹£å¸‚å ´ 24/7ï¼Œæª¢æŸ¥æ›´æ–°æ™‚é–“
        if result.updated_at:
            cache_minutes = settings.CRYPTO_DATA_CACHE_MINUTES
            cache_deadline = datetime.now() - timedelta(minutes=cache_minutes)
            if result.updated_at > cache_deadline:
                return True
        
        return False
    
    def _save_prices_to_db(self, df: pd.DataFrame) -> int:
        """å„²å­˜åƒ¹æ ¼è³‡æ–™åˆ°è³‡æ–™åº«"""
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            stmt = select(CryptoPrice).where(
                and_(
                    CryptoPrice.symbol == row["symbol"],
                    CryptoPrice.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                existing.price = row.get("price") or row.get("close")
                existing.volume_24h = row.get("volume_24h")
                existing.market_cap = row.get("market_cap")
            else:
                price = CryptoPrice(
                    symbol=row["symbol"],
                    date=row["date"],
                    price=row.get("price") or row.get("close"),
                    volume_24h=row.get("volume_24h"),
                    market_cap=row.get("market_cap"),
                )
                self.db.add(price)
                count += 1
        
        self.db.commit()
        return count
    
    def _load_prices_from_db(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """å¾è³‡æ–™åº«è¼‰å…¥åƒ¹æ ¼è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(CryptoPrice)
            .where(
                and_(
                    CryptoPrice.symbol == symbol.upper(),
                    CryptoPrice.date >= start_date,
                )
            )
            .order_by(CryptoPrice.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        if not results:
            return None
        
        data = []
        for r in results:
            data.append({
                "symbol": r.symbol,
                "date": r.date,
                "close": float(r.price) if r.price else None,
                "price": float(r.price) if r.price else None,
                "volume": float(r.volume_24h) if r.volume_24h else 0,
                "volume_24h": float(r.volume_24h) if r.volume_24h else None,
                "market_cap": float(r.market_cap) if r.market_cap else None,
                # åŠ å¯†è²¨å¹£æ²’æœ‰ OHLCï¼Œç”¨ close å¡«å……
                "open": float(r.price) if r.price else None,
                "high": float(r.price) if r.price else None,
                "low": float(r.price) if r.price else None,
            })
        
        return pd.DataFrame(data)
    
    def fetch_and_cache_crypto(self, symbol: str, days: int = 365) -> bool:
        """æŠ“å–åŠ å¯†è²¨å¹£è³‡æ–™ä¸¦å¿«å–"""
        df = coingecko.get_market_chart(symbol, days=days)
        if df is None:
            return False
        
        # è½‰æ›æ¬„ä½åç¨±ä»¥ç¬¦åˆè³‡æ–™åº«
        df["close"] = df["price"]
        
        self._save_prices_to_db(df)
        return True
    
    def get_crypto_data(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[pd.DataFrame]:
        """å–å¾—åŠ å¯†è²¨å¹£è³‡æ–™ï¼ˆå„ªå…ˆä½¿ç”¨å¿«å–ï¼‰"""
        symbol = symbol.upper()
        
        if not coingecko.validate_symbol(symbol):
            logger.warning(f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}")
            return None
        
        # æª¢æŸ¥å¿«å–
        if not force_refresh and self._is_cache_valid(symbol):
            logger.info(f"ä½¿ç”¨å¿«å–è³‡æ–™: {symbol}")
            df = self._load_prices_from_db(symbol)
        else:
            logger.info(f"å¾ CoinGecko æŠ“å–: {symbol}")
            if not self.fetch_and_cache_crypto(symbol):
                df = self._load_prices_from_db(symbol)
                if df is None:
                    return None
            else:
                df = self._load_prices_from_db(symbol)
        
        if df is None or df.empty:
            return None
        
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆä½¿ç”¨é©åˆåŠ å¯†è²¨å¹£çš„åƒæ•¸ï¼‰
        df = self._calculate_crypto_indicators(df)
        
        return df
    
    def _calculate_crypto_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """è¨ˆç®—åŠ å¯†è²¨å¹£æŠ€è¡“æŒ‡æ¨™ï¼ˆä½¿ç”¨å¹£åœˆå¸¸ç”¨åƒæ•¸ï¼‰"""
        # å»ºç«‹å¹£åœˆå°ˆç”¨çš„æŒ‡æ¨™æœå‹™ï¼ˆä½¿ç”¨ä¸åŒçš„ MA é€±æœŸï¼‰
        crypto_indicator = indicator_service.__class__(
            ma_short=7,    # å¹£åœˆçŸ­å‡ç·š
            ma_mid=25,     # å¹£åœˆä¸­å‡ç·š
            ma_long=99,    # å¹£åœˆé•·å‡ç·š
        )
        
        df = crypto_indicator.add_ma_indicators(df)
        df = indicator_service.add_rsi_indicator(df)
        df = indicator_service.add_macd_indicator(df)
        df = indicator_service.add_kd_indicator(df)
        df = indicator_service.add_bollinger_indicator(df)
        
        # åŠ å¯†è²¨å¹£é€šå¸¸æ²’æœ‰çœŸæ­£çš„æˆäº¤é‡è³‡æ–™ï¼Œè·³é OBV
        if 'volume' in df.columns and df['volume'].sum() > 0:
            df = indicator_service.add_obv_indicator(df)
        
        return df
    
    def get_crypto_analysis(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[Dict[str, Any]]:
        """å–å¾—åŠ å¯†è²¨å¹£å®Œæ•´åˆ†æå ±å‘Š"""
        symbol = symbol.upper()
        
        # å–å¾—è³‡æ–™
        df = self.get_crypto_data(symbol, force_refresh)
        if df is None:
            return None
        
        # å–å¾—è©³ç´°è³‡è¨Š
        info = coingecko.get_coin_info(symbol)
        
        # æœ€æ–°åƒ¹æ ¼
        latest = df.iloc[-1]
        price = float(latest["close"])
        
        # æ¼²è·Œå¹…
        changes = self._calculate_changes(df, info)
        
        # æŠ€è¡“æŒ‡æ¨™
        indicators = self._get_indicators_summary(df, latest)
        
        # è¨Šè™Ÿ
        signals = indicator_service.get_all_signals(df)
        
        # è©•åˆ†
        score = indicator_service.calculate_score(df)
        
        return {
            "symbol": symbol,
            "name": info.get("name", symbol) if info else symbol,
            "asset_type": "crypto",
            "price": {
                "current": price,
                "ath": info.get("ath") if info else None,
                "atl": info.get("atl") if info else None,
                "from_ath_pct": info.get("ath_change_percentage") if info else None,
                "high_24h": info.get("high_24h") if info else None,
                "low_24h": info.get("low_24h") if info else None,
            },
            "change": changes,
            "market": {
                "market_cap": info.get("market_cap") if info else None,
                "market_cap_rank": info.get("market_cap_rank") if info else None,
                "volume_24h": info.get("total_volume") if info else None,
                "circulating_supply": info.get("circulating_supply") if info else None,
            },
            "indicators": indicators,
            "signals": [
                {
                    "type": s.type.value,
                    "indicator": s.indicator,
                    "description": s.description,
                }
                for s in signals
            ],
            "score": score,
            "updated_at": datetime.now().isoformat(),
        }
    
    def _calculate_changes(
        self,
        df: pd.DataFrame,
        info: Optional[Dict],
    ) -> Dict[str, float]:
        """è¨ˆç®—æ¼²è·Œå¹…"""
        changes = {}
        
        # å¾ CoinGecko API å–å¾—
        if info:
            changes["day"] = info.get("price_change_percentage_24h")
            changes["week"] = info.get("price_change_percentage_7d")
            changes["month"] = info.get("price_change_percentage_30d")
            changes["year"] = info.get("price_change_percentage_1y")
        
        # å¾æœ¬åœ°è³‡æ–™è¨ˆç®—
        latest_close = df["close"].iloc[-1]
        
        def calc_change(days: int) -> Optional[float]:
            if len(df) <= days:
                return None
            old_close = df["close"].iloc[-(days + 1)]
            if old_close and old_close != 0:
                return round((latest_close - old_close) / old_close * 100, 2)
            return None
        
        # è£œå……ç¼ºå¤±çš„è³‡æ–™
        if not changes.get("day"):
            changes["day"] = calc_change(1)
        if not changes.get("week"):
            changes["week"] = calc_change(7)
        if not changes.get("month"):
            changes["month"] = calc_change(30)
        
        return changes
    
    def _get_indicators_summary(
        self,
        df: pd.DataFrame,
        latest: pd.Series,
    ) -> Dict[str, Any]:
        """å–å¾—æŒ‡æ¨™æ‘˜è¦"""
        price = float(latest["close"])
        
        # MAï¼ˆå¹£åœˆé€±æœŸï¼‰
        ma_info = {
            "ma7": round(latest.get("ma7", 0), 2) if not pd.isna(latest.get("ma7")) else None,
            "ma25": round(latest.get("ma25", 0), 2) if not pd.isna(latest.get("ma25")) else None,
            "ma99": round(latest.get("ma99", 0), 2) if not pd.isna(latest.get("ma99")) else None,
        }
        
        # åˆ¤æ–·å‡ç·šæ’åˆ—
        ma7 = latest.get("ma7")
        ma25 = latest.get("ma25")
        ma99 = latest.get("ma99")
        
        if not any(pd.isna(x) for x in [ma7, ma25, ma99]):
            if price > ma7 > ma25 > ma99:
                ma_info["alignment"] = "bullish"
            elif price < ma7 < ma25 < ma99:
                ma_info["alignment"] = "bearish"
            else:
                ma_info["alignment"] = "neutral"
        else:
            ma_info["alignment"] = "unknown"
        
        # RSI
        rsi = latest.get("rsi")
        rsi_status, _ = indicator_service.get_rsi_status(rsi)
        rsi_info = {
            "value": round(rsi, 2) if not pd.isna(rsi) else None,
            "status": rsi_status,
        }
        
        # MACD
        macd_dif = latest.get("macd_dif")
        macd_dea = latest.get("macd_dea")
        macd_hist = latest.get("macd_hist")
        macd_info = {
            "dif": round(macd_dif, 4) if not pd.isna(macd_dif) else None,
            "dea": round(macd_dea, 4) if not pd.isna(macd_dea) else None,
            "histogram": round(macd_hist, 4) if not pd.isna(macd_hist) else None,
            "status": "bullish" if macd_hist and macd_hist > 0 else "bearish",
        }
        
        # Bollinger
        bb_upper = latest.get("bb_upper")
        bb_middle = latest.get("bb_middle")
        bb_lower = latest.get("bb_lower")
        bb_info = {
            "upper": round(bb_upper, 2) if not pd.isna(bb_upper) else None,
            "middle": round(bb_middle, 2) if not pd.isna(bb_middle) else None,
            "lower": round(bb_lower, 2) if not pd.isna(bb_lower) else None,
            "position": indicator_service.get_bollinger_position(price, bb_upper, bb_middle, bb_lower),
        }
        
        return {
            "ma": ma_info,
            "rsi": rsi_info,
            "macd": macd_info,
            "bollinger": bb_info,
        }
    
    # ==================== å¸‚å ´æƒ…ç·’ ====================
    
    def get_market_sentiment(self, market: str = "all") -> Dict[str, Any]:
        """
        å–å¾—å¸‚å ´æƒ…ç·’æŒ‡æ•¸
        
        Args:
            market: "stock", "crypto", or "all"
        """
        result = {}
        
        if market in ("all", "stock"):
            stock_sentiment = fear_greed.get_stock_fear_greed()
            if stock_sentiment:
                result["stock"] = stock_sentiment
                # å„²å­˜åˆ°è³‡æ–™åº«
                self._save_sentiment(stock_sentiment)
        
        if market in ("all", "crypto"):
            crypto_sentiment = fear_greed.get_crypto_fear_greed()
            if crypto_sentiment:
                result["crypto"] = crypto_sentiment
                # å„²å­˜åˆ°è³‡æ–™åº«
                self._save_sentiment(crypto_sentiment)
        
        return result
    
    def _save_sentiment(self, sentiment_data: Dict[str, Any]):
        """å„²å­˜æƒ…ç·’æŒ‡æ•¸åˆ°è³‡æ–™åº«"""
        try:
            market = sentiment_data.get("market")
            value = sentiment_data.get("value")
            timestamp = sentiment_data.get("timestamp")
            
            if not all([market, value, timestamp]):
                return
            
            sentiment_date = datetime.strptime(timestamp, "%Y-%m-%d").date()
            
            stmt = select(MarketSentiment).where(
                and_(
                    MarketSentiment.market == market,
                    MarketSentiment.date == sentiment_date,
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                existing.value = value
                existing.classification = sentiment_data.get("classification")
            else:
                sentiment = MarketSentiment(
                    date=sentiment_date,
                    market=market,
                    value=value,
                    classification=sentiment_data.get("classification"),
                )
                self.db.add(sentiment)
            
            self.db.commit()
        except Exception as e:
            logger.error(f"å„²å­˜æƒ…ç·’æŒ‡æ•¸å¤±æ•—: {e}")
    
    def get_supported_cryptos(self) -> List[Dict[str, str]]:
        """å–å¾—æ”¯æ´çš„åŠ å¯†è²¨å¹£åˆ—è¡¨"""
        from app.data_sources.coingecko import CRYPTO_MAP
        return [
            {"symbol": symbol, "id": coin_id}
            for symbol, coin_id in CRYPTO_MAP.items()
            if symbol not in ("BITCOIN", "ETHEREUM")  # æ’é™¤åˆ¥å
        ]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/exchange_rate_service.py  â­â­â­
> åŒ¯ç‡æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åŒ¯ç‡æœå‹™
å¾ Yahoo Finance æŠ“å– USD/TWD åŒ¯ç‡
"""
import logging
from datetime import datetime
from typing import Optional

import yfinance as yf
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import Session

from app.models.portfolio import ExchangeRate

logger = logging.getLogger(__name__)

# é è¨­åŒ¯ç‡
DEFAULT_USD_TWD_RATE = 32.5


def fetch_usd_twd_rate() -> Optional[float]:
    """
    å¾ Yahoo Finance æŠ“å– USD/TWD åŒ¯ç‡
    è¿”å› None è¡¨ç¤ºæŠ“å–å¤±æ•—
    """
    try:
        ticker = yf.Ticker("TWD=X")
        data = ticker.history(period="1d")
        
        if data.empty:
            logger.warning("ç„¡æ³•å–å¾— USD/TWD åŒ¯ç‡è³‡æ–™")
            return None
        
        rate = float(data['Close'].iloc[-1])
        logger.info(f"å–å¾— USD/TWD åŒ¯ç‡: {rate:.4f}")
        return rate
        
    except Exception as e:
        logger.error(f"æŠ“å– USD/TWD åŒ¯ç‡å¤±æ•—: {e}")
        return None


def update_exchange_rate_sync(db: Session) -> float:
    """
    åŒæ­¥æ›´æ–°åŒ¯ç‡ï¼ˆä¾›æ’ç¨‹ä½¿ç”¨ï¼‰
    è¿”å›ç•¶å‰åŒ¯ç‡
    """
    rate = fetch_usd_twd_rate()
    
    if rate is None:
        # æŠ“å–å¤±æ•—ï¼Œä½¿ç”¨ç¾æœ‰åŒ¯ç‡æˆ–é è¨­å€¼
        existing = db.query(ExchangeRate).filter_by(
            from_currency="USD",
            to_currency="TWD"
        ).first()
        
        if existing:
            logger.info(f"ä½¿ç”¨ç¾æœ‰åŒ¯ç‡: {existing.rate}")
            return existing.rate
        else:
            logger.info(f"ä½¿ç”¨é è¨­åŒ¯ç‡: {DEFAULT_USD_TWD_RATE}")
            return DEFAULT_USD_TWD_RATE
    
    # æ›´æ–°æˆ–æ–°å¢åŒ¯ç‡
    existing = db.query(ExchangeRate).filter_by(
        from_currency="USD",
        to_currency="TWD"
    ).first()
    
    if existing:
        existing.rate = rate
        existing.updated_at = datetime.utcnow()
    else:
        new_rate = ExchangeRate(
            from_currency="USD",
            to_currency="TWD",
            rate=rate,
        )
        db.add(new_rate)
    
    db.commit()
    logger.info(f"åŒ¯ç‡å·²æ›´æ–°: USD/TWD = {rate:.4f}")
    return rate


async def get_exchange_rate(db: AsyncSession) -> dict:
    """
    å–å¾— USD/TWD åŒ¯ç‡
    """
    stmt = select(ExchangeRate).where(
        ExchangeRate.from_currency == "USD",
        ExchangeRate.to_currency == "TWD"
    )
    result = await db.execute(stmt)
    rate_record = result.scalar_one_or_none()
    
    if rate_record:
        return {
            "rate": rate_record.rate,
            "updated_at": rate_record.updated_at.isoformat() if rate_record.updated_at else None,
        }
    else:
        return {
            "rate": DEFAULT_USD_TWD_RATE,
            "updated_at": None,
            "is_default": True,
        }


async def set_exchange_rate(db: AsyncSession, rate: float) -> dict:
    """
    æ‰‹å‹•è¨­å®šåŒ¯ç‡
    """
    stmt = select(ExchangeRate).where(
        ExchangeRate.from_currency == "USD",
        ExchangeRate.to_currency == "TWD"
    )
    result = await db.execute(stmt)
    rate_record = result.scalar_one_or_none()
    
    if rate_record:
        rate_record.rate = rate
        rate_record.updated_at = datetime.utcnow()
    else:
        rate_record = ExchangeRate(
            from_currency="USD",
            to_currency="TWD",
            rate=rate,
        )
        db.add(rate_record)
    
    await db.commit()
    await db.refresh(rate_record)
    
    return rate_record.to_dict()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/index_service.py  â­â­â­
> æŒ‡æ•¸æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æŒ‡æ•¸æœå‹™
========
å››å¤§æŒ‡æ•¸è³‡æ–™æ›´æ–°æœå‹™
- S&P 500 (^GSPC)
- é“ç“Šå·¥æ¥­ (^DJI)
- ç´æ–¯é”å…‹ (^IXIC)
- å°ç£åŠ æ¬Š (^TWII)

è§£æ±º admin.py å¼•ç”¨ index_service ä¸å­˜åœ¨çš„å•é¡Œ
"""
import logging
from typing import Dict, Any
from sqlalchemy.orm import Session

logger = logging.getLogger(__name__)

# å››å¤§æŒ‡æ•¸å®šç¾©
INDICES = {
    "^GSPC": {"name": "S&P 500", "name_zh": "æ¨™æ™®500"},
    "^DJI": {"name": "Dow Jones", "name_zh": "é“ç“Šå·¥æ¥­"},
    "^IXIC": {"name": "NASDAQ", "name_zh": "ç´æ–¯é”å…‹"},
    "^TWII": {"name": "TWSE", "name_zh": "å°ç£åŠ æ¬Š"},
}


class IndexService:
    """æŒ‡æ•¸æœå‹™é¡"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def update_index(self, symbol: str, period: str = "5d") -> Dict[str, Any]:
        """
        æ›´æ–°å–®ä¸€æŒ‡æ•¸
        
        Args:
            symbol: æŒ‡æ•¸ä»£è™Ÿ
            period: å–å¾—é€±æœŸ (5d, 1mo, 3mo, 1y, 5y, 10y)
        
        Returns:
            æ›´æ–°çµæœ
        """
        from app.data_sources.yahoo_finance import yahoo_finance
        from app.models.index_price import IndexPrice
        
        if symbol not in INDICES:
            return {"success": False, "error": f"ç„¡æ•ˆçš„æŒ‡æ•¸ä»£è™Ÿ: {symbol}"}
        
        try:
            logger.info(f"æ›´æ–°æŒ‡æ•¸ {symbol}...")
            
            # å–å¾—æ­·å²è³‡æ–™
            df = yahoo_finance.get_stock_history(symbol, period=period)
            
            if df is None or df.empty:
                return {"success": False, "error": f"ç„¡æ³•å–å¾— {symbol} è³‡æ–™"}
            
            # å„²å­˜åˆ°è³‡æ–™åº«
            count = 0
            for _, row in df.iterrows():
                try:
                    # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    existing = self.db.query(IndexPrice).filter(
                        IndexPrice.symbol == symbol,
                        IndexPrice.date == row['date']
                    ).first()
                    
                    if existing:
                        # æ›´æ–°
                        existing.open = float(row['open']) if row['open'] else None
                        existing.high = float(row['high']) if row['high'] else None
                        existing.low = float(row['low']) if row['low'] else None
                        existing.close = float(row['close']) if row['close'] else None
                        existing.volume = int(row['volume']) if row['volume'] else None
                    else:
                        # æ–°å¢
                        index_price = IndexPrice(
                            symbol=symbol,
                            date=row['date'],
                            open=float(row['open']) if row['open'] else None,
                            high=float(row['high']) if row['high'] else None,
                            low=float(row['low']) if row['low'] else None,
                            close=float(row['close']) if row['close'] else None,
                            volume=int(row['volume']) if row['volume'] else None,
                        )
                        self.db.add(index_price)
                    count += 1
                except Exception as e:
                    logger.warning(f"å„²å­˜ {symbol} {row['date']} å¤±æ•—: {e}")
                    continue
            
            self.db.commit()
            
            logger.info(f"âœ… {symbol} æ›´æ–°å®Œæˆ: {count} ç­†")
            return {
                "success": True,
                "symbol": symbol,
                "records": count,
            }
            
        except Exception as e:
            logger.error(f"æ›´æ–° {symbol} å¤±æ•—: {e}")
            self.db.rollback()
            return {"success": False, "error": str(e)}
    
    def update_all(self, period: str = "5d") -> Dict[str, Any]:
        """
        æ›´æ–°æ‰€æœ‰æŒ‡æ•¸
        
        Returns:
            æ›´æ–°çµæœå½™ç¸½
        """
        results = []
        errors = []
        
        for symbol in INDICES.keys():
            result = self.update_index(symbol, period)
            if result.get("success"):
                results.append({
                    "symbol": symbol,
                    "records": result.get("records", 0),
                })
            else:
                errors.append({
                    "symbol": symbol,
                    "error": result.get("error"),
                })
        
        return {
            "success": len(errors) == 0,
            "updated": len(results),
            "results": results,
            "errors": errors,
        }


# ============================================================
# å…¨åŸŸå‡½æ•¸ï¼ˆä¾› admin.py ä½¿ç”¨ï¼‰
# ============================================================

def update_all_indices(period: str = "5d") -> Dict[str, Any]:
    """
    æ›´æ–°æ‰€æœ‰å››å¤§æŒ‡æ•¸ï¼ˆå…¨åŸŸå‡½æ•¸ï¼‰
    
    ç”¨æ–¼ admin.py:
        from app.services.index_service import update_all_indices
        result = update_all_indices()
    """
    from app.database import SessionLocal
    
    db = SessionLocal()
    try:
        service = IndexService(db)
        return service.update_all(period)
    finally:
        db.close()


def update_single_index(symbol: str, period: str = "5d") -> Dict[str, Any]:
    """
    æ›´æ–°å–®ä¸€æŒ‡æ•¸ï¼ˆå…¨åŸŸå‡½æ•¸ï¼‰
    """
    from app.database import SessionLocal
    
    db = SessionLocal()
    try:
        service = IndexService(db)
        return service.update_index(symbol, period)
    finally:
        db.close()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/indicator_service.py  â­â­â­
> æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™
åŒ…å« MAã€RSIã€MACDã€KDã€å¸ƒæ—é€šé“ã€OBV ç­‰æŒ‡æ¨™è¨ˆç®—
"""
import pandas as pd
import numpy as np
from typing import Dict, Any, Optional, Tuple, List
from dataclasses import dataclass
from enum import Enum

from app.config import settings


class TrendDirection(Enum):
    """è¶¨å‹¢æ–¹å‘"""
    BULLISH = "bullish"      # å¤šé ­
    BEARISH = "bearish"      # ç©ºé ­
    NEUTRAL = "neutral"      # ä¸­æ€§


class SignalType(Enum):
    """è¨Šè™Ÿé¡å‹"""
    GOLDEN_CROSS = "golden_cross"      # é»ƒé‡‘äº¤å‰
    DEATH_CROSS = "death_cross"        # æ­»äº¡äº¤å‰
    OVERBOUGHT = "overbought"          # è¶…è²·
    OVERSOLD = "oversold"              # è¶…è³£
    BREAKOUT = "breakout"              # çªç ´
    BREAKDOWN = "breakdown"            # è·Œç ´
    APPROACHING_BREAKOUT = "approaching_breakout"  # æ¥è¿‘çªç ´
    APPROACHING_BREAKDOWN = "approaching_breakdown"  # æ¥è¿‘è·Œç ´


@dataclass
class Signal:
    """äº¤æ˜“è¨Šè™Ÿ"""
    type: SignalType
    indicator: str
    description: str
    value: Optional[float] = None
    date: Optional[str] = None


class IndicatorService:
    """æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æœå‹™"""
    
    def __init__(
        self,
        ma_short: int = None,
        ma_mid: int = None,
        ma_long: int = None,
        rsi_period: int = None,
        rsi_overbought: int = None,
        rsi_oversold: int = None,
        macd_fast: int = None,
        macd_slow: int = None,
        macd_signal: int = None,
        kd_period: int = None,
        bollinger_period: int = None,
        bollinger_std: float = None,
        breakout_threshold: float = None,
    ):
        """
        åˆå§‹åŒ–æŒ‡æ¨™åƒæ•¸
        è‹¥æœªæŒ‡å®šï¼Œå‰‡ä½¿ç”¨ config ä¸­çš„é è¨­å€¼
        """
        self.ma_short = ma_short or settings.MA_SHORT
        self.ma_mid = ma_mid or settings.MA_MID
        self.ma_long = ma_long or settings.MA_LONG
        self.rsi_period = rsi_period or settings.RSI_PERIOD
        self.rsi_overbought = rsi_overbought or settings.RSI_OVERBOUGHT
        self.rsi_oversold = rsi_oversold or settings.RSI_OVERSOLD
        self.macd_fast = macd_fast or settings.MACD_FAST
        self.macd_slow = macd_slow or settings.MACD_SLOW
        self.macd_signal = macd_signal or settings.MACD_SIGNAL
        self.kd_period = kd_period or settings.KD_PERIOD
        self.bollinger_period = bollinger_period or settings.BOLLINGER_PERIOD
        self.bollinger_std = bollinger_std or settings.BOLLINGER_STD
        self.breakout_threshold = breakout_threshold or settings.BREAKOUT_THRESHOLD
    
    # ==================== ç§»å‹•å¹³å‡ç·š (MA) ====================
    
    def calculate_ma(self, df: pd.DataFrame, period: int, column: str = "close") -> pd.Series:
        """è¨ˆç®—ç°¡å–®ç§»å‹•å¹³å‡ç·š (SMA)"""
        return df[column].rolling(window=period).mean()
    
    def calculate_ema(self, df: pd.DataFrame, period: int, column: str = "close") -> pd.Series:
        """è¨ˆç®—æŒ‡æ•¸ç§»å‹•å¹³å‡ç·š (EMA)"""
        return df[column].ewm(span=period, adjust=False).mean()
    
    def add_ma_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """
        æ–°å¢ç§»å‹•å¹³å‡ç·šæŒ‡æ¨™
        
        Returns:
            æ–°å¢ ma20, ma50, ma200, ma250 æ¬„ä½çš„ DataFrame
        """
        df = df.copy()
        df[f"ma{self.ma_short}"] = self.calculate_ma(df, self.ma_short)
        df[f"ma{self.ma_mid}"] = self.calculate_ma(df, self.ma_mid)
        df[f"ma{self.ma_long}"] = self.calculate_ma(df, self.ma_long)
        df["ma250"] = self.calculate_ma(df, 250)  # æ·»åŠ  MA250
        return df
    
    def get_ma_alignment(self, df: pd.DataFrame) -> Tuple[TrendDirection, str]:
        """
        åˆ¤æ–·å‡ç·šæ’åˆ—
        
        Returns:
            (è¶¨å‹¢æ–¹å‘, æè¿°)
        """
        if len(df) < self.ma_long:
            return TrendDirection.NEUTRAL, "è³‡æ–™ä¸è¶³"
        
        latest = df.iloc[-1]
        ma_short = latest.get(f"ma{self.ma_short}")
        ma_mid = latest.get(f"ma{self.ma_mid}")
        ma_long = latest.get(f"ma{self.ma_long}")
        price = latest["close"]
        
        if pd.isna(ma_short) or pd.isna(ma_mid) or pd.isna(ma_long):
            return TrendDirection.NEUTRAL, "å‡ç·šè³‡æ–™ä¸è¶³"
        
        # å¤šé ­æ’åˆ—ï¼šåƒ¹æ ¼ > çŸ­å‡ > ä¸­å‡ > é•·å‡
        if price > ma_short > ma_mid > ma_long:
            return TrendDirection.BULLISH, "å¤šé ­æ’åˆ—"
        
        # ç©ºé ­æ’åˆ—ï¼šåƒ¹æ ¼ < çŸ­å‡ < ä¸­å‡ < é•·å‡
        if price < ma_short < ma_mid < ma_long:
            return TrendDirection.BEARISH, "ç©ºé ­æ’åˆ—"
        
        return TrendDirection.NEUTRAL, "ç›¤æ•´"
    
    def check_ma_cross(self, df: pd.DataFrame, short_ma: str, long_ma: str) -> Optional[Signal]:
        """
        æª¢æŸ¥å‡ç·šäº¤å‰
        
        Args:
            df: å«æœ‰å‡ç·šè³‡æ–™çš„ DataFrame
            short_ma: çŸ­å‡ç·šæ¬„ä½åç¨± (å¦‚ "ma20")
            long_ma: é•·å‡ç·šæ¬„ä½åç¨± (å¦‚ "ma50")
            
        Returns:
            Signal ç‰©ä»¶æˆ– None
        """
        if len(df) < 2:
            return None
        
        today = df.iloc[-1]
        yesterday = df.iloc[-2]
        
        short_today = today.get(short_ma)
        short_yesterday = yesterday.get(short_ma)
        long_today = today.get(long_ma)
        long_yesterday = yesterday.get(long_ma)
        
        if any(pd.isna(x) for x in [short_today, short_yesterday, long_today, long_yesterday]):
            return None
        
        # é»ƒé‡‘äº¤å‰ï¼šçŸ­å‡ç·šç”±ä¸‹å¾€ä¸Šç©¿è¶Šé•·å‡ç·š
        if short_yesterday < long_yesterday and short_today > long_today:
            return Signal(
                type=SignalType.GOLDEN_CROSS,
                indicator=f"{short_ma}/{long_ma}",
                description=f"{short_ma.upper()} é»ƒé‡‘äº¤å‰ {long_ma.upper()}",
            )
        
        # æ­»äº¡äº¤å‰ï¼šçŸ­å‡ç·šç”±ä¸Šå¾€ä¸‹ç©¿è¶Šé•·å‡ç·š
        if short_yesterday > long_yesterday and short_today < long_today:
            return Signal(
                type=SignalType.DEATH_CROSS,
                indicator=f"{short_ma}/{long_ma}",
                description=f"{short_ma.upper()} æ­»äº¡äº¤å‰ {long_ma.upper()}",
            )
        
        return None
    
    def check_price_vs_ma(
        self,
        price: float,
        ma_value: float,
        ma_name: str,
    ) -> Optional[Signal]:
        """
        æª¢æŸ¥åƒ¹æ ¼èˆ‡å‡ç·šçš„é—œä¿‚ï¼ˆæ¥è¿‘çªç ´/è·Œç ´ï¼‰
        
        Args:
            price: ç•¶å‰åƒ¹æ ¼
            ma_value: å‡ç·šå€¼
            ma_name: å‡ç·šåç¨± (å¦‚ "MA20")
            
        Returns:
            Signal ç‰©ä»¶æˆ– None
        """
        if pd.isna(ma_value):
            return None
        
        distance_pct = ((price - ma_value) / ma_value) * 100
        
        # åƒ¹æ ¼åœ¨å‡ç·šä¸‹æ–¹ï¼Œä¸”è·é›¢å°æ–¼é–€æª» -> æ¥è¿‘å‘ä¸Šçªç ´
        if -self.breakout_threshold < distance_pct < 0:
            return Signal(
                type=SignalType.APPROACHING_BREAKOUT,
                indicator=ma_name,
                description=f"æ¥è¿‘çªç ´ {ma_name} ({abs(distance_pct):.1f}%)",
                value=distance_pct,
            )
        
        # åƒ¹æ ¼åœ¨å‡ç·šä¸Šæ–¹ï¼Œä¸”è·é›¢å°æ–¼é–€æª» -> æ¥è¿‘å‘ä¸‹è·Œç ´
        if 0 < distance_pct < self.breakout_threshold:
            return Signal(
                type=SignalType.APPROACHING_BREAKDOWN,
                indicator=ma_name,
                description=f"æ¥è¿‘è·Œç ´ {ma_name} ({distance_pct:.1f}%)",
                value=distance_pct,
            )
        
        return None
    
    # ==================== RSI ====================
    
    def calculate_rsi(self, df: pd.DataFrame, period: int = None) -> pd.Series:
        """
        è¨ˆç®— RSIï¼ˆç›¸å°å¼·å¼±æŒ‡æ¨™ï¼‰
        
        RSI = 100 - (100 / (1 + RS))
        RS = å¹³å‡æ¼²å¹… / å¹³å‡è·Œå¹…
        """
        period = period or self.rsi_period
        
        delta = df["close"].diff()
        gain = delta.where(delta > 0, 0)
        loss = (-delta).where(delta < 0, 0)
        
        avg_gain = gain.rolling(window=period).mean()
        avg_loss = loss.rolling(window=period).mean()
        
        rs = avg_gain / avg_loss
        rsi = 100 - (100 / (1 + rs))
        
        return rsi
    
    def add_rsi_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ RSI æŒ‡æ¨™"""
        df = df.copy()
        df["rsi"] = self.calculate_rsi(df)
        return df
    
    def get_rsi_status(self, rsi_value: float) -> Tuple[str, str]:
        """
        å–å¾— RSI ç‹€æ…‹
        
        Returns:
            (ç‹€æ…‹, æè¿°)
        """
        if pd.isna(rsi_value):
            return "unknown", "è³‡æ–™ä¸è¶³"
        
        if rsi_value >= self.rsi_overbought:
            return "overbought", f"è¶…è²· ({rsi_value:.1f})"
        elif rsi_value <= self.rsi_oversold:
            return "oversold", f"è¶…è³£ ({rsi_value:.1f})"
        else:
            return "neutral", f"ä¸­æ€§ ({rsi_value:.1f})"
    
    def check_rsi_signal(self, df: pd.DataFrame) -> Optional[Signal]:
        """æª¢æŸ¥ RSI è¨Šè™Ÿ"""
        if len(df) < 2 or "rsi" not in df.columns:
            return None
        
        rsi_today = df["rsi"].iloc[-1]
        rsi_yesterday = df["rsi"].iloc[-2]
        
        if pd.isna(rsi_today) or pd.isna(rsi_yesterday):
            return None
        
        # é€²å…¥è¶…è²·å€
        if rsi_yesterday < self.rsi_overbought <= rsi_today:
            return Signal(
                type=SignalType.OVERBOUGHT,
                indicator="RSI",
                description=f"RSI é€²å…¥è¶…è²·å€ ({rsi_today:.1f})",
                value=rsi_today,
            )
        
        # é€²å…¥è¶…è³£å€
        if rsi_yesterday > self.rsi_oversold >= rsi_today:
            return Signal(
                type=SignalType.OVERSOLD,
                indicator="RSI",
                description=f"RSI é€²å…¥è¶…è³£å€ ({rsi_today:.1f})",
                value=rsi_today,
            )
        
        return None
    
    # ==================== MACD ====================
    
    def calculate_macd(self, df: pd.DataFrame) -> Tuple[pd.Series, pd.Series, pd.Series]:
        """
        è¨ˆç®— MACD
        
        Returns:
            (DIF, MACD/DEA, Histogram)
        """
        ema_fast = self.calculate_ema(df, self.macd_fast)
        ema_slow = self.calculate_ema(df, self.macd_slow)
        
        dif = ema_fast - ema_slow
        dea = dif.ewm(span=self.macd_signal, adjust=False).mean()
        histogram = dif - dea
        
        return dif, dea, histogram
    
    def add_macd_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ MACD æŒ‡æ¨™"""
        df = df.copy()
        df["macd_dif"], df["macd_dea"], df["macd_hist"] = self.calculate_macd(df)
        return df
    
    def check_macd_signal(self, df: pd.DataFrame) -> Optional[Signal]:
        """æª¢æŸ¥ MACD äº¤å‰è¨Šè™Ÿ"""
        if len(df) < 2:
            return None
        
        dif_today = df["macd_dif"].iloc[-1]
        dif_yesterday = df["macd_dif"].iloc[-2]
        dea_today = df["macd_dea"].iloc[-1]
        dea_yesterday = df["macd_dea"].iloc[-2]
        
        if any(pd.isna(x) for x in [dif_today, dif_yesterday, dea_today, dea_yesterday]):
            return None
        
        # é»ƒé‡‘äº¤å‰ï¼šDIF ç”±ä¸‹å¾€ä¸Šç©¿è¶Š DEA
        if dif_yesterday < dea_yesterday and dif_today > dea_today:
            position = "é›¶è»¸ä¸Šæ–¹" if dif_today > 0 else "é›¶è»¸ä¸‹æ–¹"
            return Signal(
                type=SignalType.GOLDEN_CROSS,
                indicator="MACD",
                description=f"MACD é»ƒé‡‘äº¤å‰ ({position})",
                value=dif_today,
            )
        
        # æ­»äº¡äº¤å‰ï¼šDIF ç”±ä¸Šå¾€ä¸‹ç©¿è¶Š DEA
        if dif_yesterday > dea_yesterday and dif_today < dea_today:
            position = "é›¶è»¸ä¸Šæ–¹" if dif_today > 0 else "é›¶è»¸ä¸‹æ–¹"
            return Signal(
                type=SignalType.DEATH_CROSS,
                indicator="MACD",
                description=f"MACD æ­»äº¡äº¤å‰ ({position})",
                value=dif_today,
            )
        
        return None
    
    # ==================== KD ====================
    
    def calculate_kd(self, df: pd.DataFrame) -> Tuple[pd.Series, pd.Series]:
        """
        è¨ˆç®— KDï¼ˆéš¨æ©ŸæŒ‡æ¨™ï¼‰
        
        RSV = (ä»Šæ—¥æ”¶ç›¤ - Næ—¥æœ€ä½) / (Næ—¥æœ€é«˜ - Næ—¥æœ€ä½) Ã— 100
        K = 2/3 Ã— æ˜¨æ—¥K + 1/3 Ã— RSV
        D = 2/3 Ã— æ˜¨æ—¥D + 1/3 Ã— K
        
        Returns:
            (K, D)
        """
        period = self.kd_period
        
        lowest = df["low"].rolling(window=period).min()
        highest = df["high"].rolling(window=period).max()
        
        rsv = ((df["close"] - lowest) / (highest - lowest)) * 100
        
        # åˆå§‹åŒ– K, D
        k = pd.Series(index=df.index, dtype=float)
        d = pd.Series(index=df.index, dtype=float)
        
        # ç¬¬ä¸€å€‹æœ‰æ•ˆå€¼è¨­ç‚º 50
        first_valid = rsv.first_valid_index()
        if first_valid is not None:
            idx = df.index.get_loc(first_valid)
            k.iloc[idx] = 50
            d.iloc[idx] = 50
            
            # è¿­ä»£è¨ˆç®—
            for i in range(idx + 1, len(df)):
                k.iloc[i] = (2/3) * k.iloc[i-1] + (1/3) * rsv.iloc[i]
                d.iloc[i] = (2/3) * d.iloc[i-1] + (1/3) * k.iloc[i]
        
        return k, d
    
    def add_kd_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ KD æŒ‡æ¨™"""
        df = df.copy()
        df["kd_k"], df["kd_d"] = self.calculate_kd(df)
        return df
    
    def check_kd_signal(self, df: pd.DataFrame) -> Optional[Signal]:
        """æª¢æŸ¥ KD äº¤å‰è¨Šè™Ÿ"""
        if len(df) < 2:
            return None
        
        k_today = df["kd_k"].iloc[-1]
        k_yesterday = df["kd_k"].iloc[-2]
        d_today = df["kd_d"].iloc[-1]
        d_yesterday = df["kd_d"].iloc[-2]
        
        if any(pd.isna(x) for x in [k_today, k_yesterday, d_today, d_yesterday]):
            return None
        
        # é»ƒé‡‘äº¤å‰ï¼šK ç”±ä¸‹å¾€ä¸Šç©¿è¶Š D
        if k_yesterday < d_yesterday and k_today > d_today:
            zone = "è¶…è³£å€" if k_today < 20 else ("è¶…è²·å€" if k_today > 80 else "ä¸­æ€§å€")
            return Signal(
                type=SignalType.GOLDEN_CROSS,
                indicator="KD",
                description=f"KD é»ƒé‡‘äº¤å‰ ({zone}, K={k_today:.1f})",
                value=k_today,
            )
        
        # æ­»äº¡äº¤å‰ï¼šK ç”±ä¸Šå¾€ä¸‹ç©¿è¶Š D
        if k_yesterday > d_yesterday and k_today < d_today:
            zone = "è¶…è³£å€" if k_today < 20 else ("è¶…è²·å€" if k_today > 80 else "ä¸­æ€§å€")
            return Signal(
                type=SignalType.DEATH_CROSS,
                indicator="KD",
                description=f"KD æ­»äº¡äº¤å‰ ({zone}, K={k_today:.1f})",
                value=k_today,
            )
        
        return None
    
    # ==================== å¸ƒæ—é€šé“ ====================
    
    def calculate_bollinger(self, df: pd.DataFrame) -> Tuple[pd.Series, pd.Series, pd.Series]:
        """
        è¨ˆç®—å¸ƒæ—é€šé“
        
        Returns:
            (ä¸Šè»Œ, ä¸­è»Œ, ä¸‹è»Œ)
        """
        middle = df["close"].rolling(window=self.bollinger_period).mean()
        std = df["close"].rolling(window=self.bollinger_period).std()
        
        upper = middle + (self.bollinger_std * std)
        lower = middle - (self.bollinger_std * std)
        
        return upper, middle, lower
    
    def add_bollinger_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢å¸ƒæ—é€šé“æŒ‡æ¨™"""
        df = df.copy()
        df["bb_upper"], df["bb_middle"], df["bb_lower"] = self.calculate_bollinger(df)
        df["bb_width"] = (df["bb_upper"] - df["bb_lower"]) / df["bb_middle"]
        return df
    
    def get_bollinger_position(self, price: float, upper: float, middle: float, lower: float) -> str:
        """å–å¾—åƒ¹æ ¼åœ¨å¸ƒæ—é€šé“ä¸­çš„ä½ç½®"""
        if pd.isna(upper) or pd.isna(lower):
            return "unknown"
        
        if price >= upper:
            return "above_upper"
        elif price <= lower:
            return "below_lower"
        elif price >= middle:
            return "upper_half"
        else:
            return "lower_half"
    
    # ==================== OBV ====================
    
    def calculate_obv(self, df: pd.DataFrame) -> pd.Series:
        """
        è¨ˆç®— OBVï¼ˆèƒ½é‡æ½®æŒ‡æ¨™ï¼‰
        
        è‹¥ä»Šæ—¥æ”¶ç›¤ > æ˜¨æ—¥æ”¶ç›¤ï¼šOBV = æ˜¨æ—¥ OBV + ä»Šæ—¥æˆäº¤é‡
        è‹¥ä»Šæ—¥æ”¶ç›¤ < æ˜¨æ—¥æ”¶ç›¤ï¼šOBV = æ˜¨æ—¥ OBV - ä»Šæ—¥æˆäº¤é‡
        è‹¥ä»Šæ—¥æ”¶ç›¤ = æ˜¨æ—¥æ”¶ç›¤ï¼šOBV = æ˜¨æ—¥ OBV
        """
        obv = pd.Series(index=df.index, dtype=float)
        obv.iloc[0] = df["volume"].iloc[0]
        
        for i in range(1, len(df)):
            if df["close"].iloc[i] > df["close"].iloc[i-1]:
                obv.iloc[i] = obv.iloc[i-1] + df["volume"].iloc[i]
            elif df["close"].iloc[i] < df["close"].iloc[i-1]:
                obv.iloc[i] = obv.iloc[i-1] - df["volume"].iloc[i]
            else:
                obv.iloc[i] = obv.iloc[i-1]
        
        return obv
    
    def add_obv_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢ OBV æŒ‡æ¨™"""
        df = df.copy()
        # æª¢æŸ¥æ˜¯å¦æœ‰ volume æ¬„ä½
        if "volume" not in df.columns:
            df["obv"] = None
            return df
        df["obv"] = self.calculate_obv(df)
        return df
    
    def get_obv_trend(self, df: pd.DataFrame, lookback: int = 5) -> str:
        """
        åˆ¤æ–· OBV è¶¨å‹¢
        
        Args:
            df: å«æœ‰ OBV çš„ DataFrame
            lookback: å›é¡§å¤©æ•¸
            
        Returns:
            è¶¨å‹¢å­—ä¸² ("rising", "falling", "flat")
        """
        if "obv" not in df.columns or len(df) < lookback:
            return "unknown"
        
        obv_recent = df["obv"].iloc[-lookback:]
        
        if obv_recent.is_monotonic_increasing:
            return "rising"
        elif obv_recent.is_monotonic_decreasing:
            return "falling"
        else:
            # æ¯”è¼ƒé¦–å°¾
            change_pct = (obv_recent.iloc[-1] - obv_recent.iloc[0]) / abs(obv_recent.iloc[0]) * 100
            if change_pct > 5:
                return "rising"
            elif change_pct < -5:
                return "falling"
            else:
                return "flat"
    
    # ==================== æˆäº¤é‡åˆ†æ ====================
    
    def calculate_volume_ratio(self, df: pd.DataFrame, ma_period: int = 20) -> pd.Series:
        """è¨ˆç®—é‡æ¯”ï¼ˆä»Šæ—¥æˆäº¤é‡ / Næ—¥å‡é‡ï¼‰"""
        avg_volume = df["volume"].rolling(window=ma_period).mean()
        return df["volume"] / avg_volume
    
    def add_volume_indicator(self, df: pd.DataFrame) -> pd.DataFrame:
        """æ–°å¢æˆäº¤é‡æŒ‡æ¨™"""
        df = df.copy()
        # æª¢æŸ¥æ˜¯å¦æœ‰ volume æ¬„ä½
        if "volume" not in df.columns:
            df["volume_ma20"] = None
            df["volume_ratio"] = None
            return df
        df["volume_ma20"] = df["volume"].rolling(window=20).mean()
        df["volume_ratio"] = self.calculate_volume_ratio(df)
        return df
    
    # ==================== ç¶œåˆè¨ˆç®— ====================
    
    def calculate_all_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
        """è¨ˆç®—æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™"""
        df = self.add_ma_indicators(df)
        df = self.add_rsi_indicator(df)
        df = self.add_macd_indicator(df)
        df = self.add_kd_indicator(df)
        df = self.add_bollinger_indicator(df)
        df = self.add_obv_indicator(df)
        df = self.add_volume_indicator(df)
        return df
    
    def get_all_signals(self, df: pd.DataFrame) -> List[Signal]:
        """å–å¾—æ‰€æœ‰è¨Šè™Ÿ"""
        signals = []
        
        # MA äº¤å‰
        ma_cross_20_50 = self.check_ma_cross(df, f"ma{self.ma_short}", f"ma{self.ma_mid}")
        if ma_cross_20_50:
            signals.append(ma_cross_20_50)
        
        ma_cross_50_200 = self.check_ma_cross(df, f"ma{self.ma_mid}", f"ma{self.ma_long}")
        if ma_cross_50_200:
            signals.append(ma_cross_50_200)
        
        # RSI
        rsi_signal = self.check_rsi_signal(df)
        if rsi_signal:
            signals.append(rsi_signal)
        
        # MACD
        macd_signal = self.check_macd_signal(df)
        if macd_signal:
            signals.append(macd_signal)
        
        # KD
        kd_signal = self.check_kd_signal(df)
        if kd_signal:
            signals.append(kd_signal)
        
        # åƒ¹æ ¼æ¥è¿‘å‡ç·š
        if len(df) > 0:
            latest = df.iloc[-1]
            price = latest["close"]
            
            for ma_col in [f"ma{self.ma_short}", f"ma{self.ma_mid}", f"ma{self.ma_long}"]:
                if ma_col in df.columns:
                    signal = self.check_price_vs_ma(price, latest[ma_col], ma_col.upper())
                    if signal:
                        signals.append(signal)
        
        return signals
    
    def calculate_score(self, df: pd.DataFrame) -> Dict[str, Any]:
        """
        è¨ˆç®—ç¶œåˆè©•åˆ†
        
        Returns:
            {
                "buy_score": int,
                "sell_score": int,
                "rating": str,
                "details": list
            }
        """
        buy_score = 0
        sell_score = 0
        details = []
        
        if len(df) < self.ma_long:
            return {
                "buy_score": 0,
                "sell_score": 0,
                "rating": "insufficient_data",
                "details": ["è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•è©•åˆ†"],
            }
        
        latest = df.iloc[-1]
        
        # 1. å‡ç·šæ’åˆ—
        alignment, alignment_desc = self.get_ma_alignment(df)
        if alignment == TrendDirection.BULLISH:
            buy_score += 1
            details.append(f"âœ… {alignment_desc}")
        elif alignment == TrendDirection.BEARISH:
            sell_score += 1
            details.append(f"âŒ {alignment_desc}")
        
        # 2. RSI
        if "rsi" in df.columns:
            rsi = latest["rsi"]
            if not pd.isna(rsi):
                if rsi <= self.rsi_oversold:
                    buy_score += 1
                    details.append(f"âœ… RSI è¶…è³£ ({rsi:.1f})")
                elif rsi >= self.rsi_overbought:
                    sell_score += 1
                    details.append(f"âŒ RSI è¶…è²· ({rsi:.1f})")
        
        # 3. MACD
        if "macd_hist" in df.columns and len(df) >= 2:
            hist_today = latest["macd_hist"]
            hist_yesterday = df["macd_hist"].iloc[-2]
            if not pd.isna(hist_today) and not pd.isna(hist_yesterday):
                if hist_today > 0 and hist_today > hist_yesterday:
                    buy_score += 1
                    details.append("âœ… MACD å‹•èƒ½å¢å¼·")
                elif hist_today < 0 and hist_today < hist_yesterday:
                    sell_score += 1
                    details.append("âŒ MACD å‹•èƒ½æ¸›å¼±")
        
        # 4. KD
        if "kd_k" in df.columns:
            k = latest["kd_k"]
            d = latest["kd_d"]
            if not pd.isna(k) and not pd.isna(d):
                if k < 20 and k > d:
                    buy_score += 1
                    details.append(f"âœ… KD ä½æª”é»ƒé‡‘äº¤å‰ (K={k:.1f})")
                elif k > 80 and k < d:
                    sell_score += 1
                    details.append(f"âŒ KD é«˜æª”æ­»äº¡äº¤å‰ (K={k:.1f})")
        
        # 5. å¸ƒæ—é€šé“
        if "bb_lower" in df.columns:
            price = latest["close"]
            bb_lower = latest["bb_lower"]
            bb_upper = latest["bb_upper"]
            bb_middle = latest["bb_middle"]
            
            if not pd.isna(bb_lower):
                if price <= bb_lower:
                    buy_score += 1
                    details.append("âœ… è§¸åŠå¸ƒæ—ä¸‹è»Œ")
                elif price >= bb_upper:
                    sell_score += 1
                    details.append("âŒ è§¸åŠå¸ƒæ—ä¸Šè»Œ")
                elif price < bb_middle and len(df) >= 2:
                    if df["close"].iloc[-2] >= bb_middle:
                        sell_score += 1
                        details.append("âŒ è·Œç ´å¸ƒæ—ä¸­è»Œ")
        
        # 6. é‡èƒ½
        if "volume_ratio" in df.columns:
            vol_ratio = latest["volume_ratio"]
            if not pd.isna(vol_ratio):
                if vol_ratio >= 2.0:
                    details.append(f"ğŸ“Š æˆäº¤é‡çˆ†å¢ (é‡æ¯” {vol_ratio:.1f})")
        
        # 7. OBV
        if "obv" in df.columns:
            obv_trend = self.get_obv_trend(df)
            if obv_trend == "rising":
                buy_score += 1
                details.append("âœ… OBV ä¸Šå‡è¶¨å‹¢")
            elif obv_trend == "falling":
                sell_score += 1
                details.append("âŒ OBV ä¸‹é™è¶¨å‹¢")
        
        # è¨ˆç®—è©•ç­‰
        if buy_score >= 5:
            rating = "strong_buy"
        elif buy_score >= 3:
            rating = "buy"
        elif sell_score >= 5:
            rating = "strong_sell"
        elif sell_score >= 3:
            rating = "sell"
        else:
            rating = "neutral"
        
        return {
            "buy_score": buy_score,
            "sell_score": sell_score,
            "rating": rating,
            "details": details,
        }
    
    # ==================== å¹´åŒ–å ±é…¬ç‡ï¼ˆCAGRï¼‰è¨ˆç®— ====================
    
    def calculate_cagr(
        self,
        df: pd.DataFrame,
        years: float,
    ) -> Optional[float]:
        """
        è¨ˆç®—å¹´åŒ–è¤‡åˆæˆé•·ç‡ï¼ˆCAGRï¼‰
        
        å…¬å¼: CAGR = (çµ‚å€¼/åˆå€¼)^(1/å¹´æ•¸) - 1
        
        Args:
            df: è‚¡åƒ¹ DataFrameï¼ˆéœ€æœ‰ 'close' æ¬„ä½ï¼‰
            years: è¨ˆç®—çš„å¹´æ•¸
            
        Returns:
            å¹´åŒ–å ±é…¬ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œä¾‹å¦‚ 15.5 è¡¨ç¤º 15.5%
            å¦‚æœè³‡æ–™ä¸è¶³å‰‡è¿”å› None
        """
        if df is None or df.empty:
            return None
        
        # è¨ˆç®—éœ€è¦çš„å¤©æ•¸ï¼ˆå‡è¨­ä¸€å¹´ç´„ 252 å€‹äº¤æ˜“æ—¥ï¼‰
        trading_days = int(years * 252)
        
        if len(df) < trading_days:
            return None
        
        try:
            # å–å¾—çµ‚å€¼ï¼ˆæœ€æ–°åƒ¹æ ¼ï¼‰
            end_price = float(df['close'].iloc[-1])
            
            # å–å¾—åˆå€¼ï¼ˆNå¹´å‰åƒ¹æ ¼ï¼‰
            start_price = float(df['close'].iloc[-trading_days])
            
            if start_price <= 0 or end_price <= 0:
                return None
            
            # è¨ˆç®— CAGR
            cagr = (end_price / start_price) ** (1 / years) - 1
            
            # è½‰æ›ç‚ºç™¾åˆ†æ¯”
            return round(cagr * 100, 2)
        except Exception:
            return None
    
    def calculate_all_cagr(
        self,
        df: pd.DataFrame,
    ) -> Dict[str, Optional[float]]:
        """
        è¨ˆç®—æ‰€æœ‰æ™‚é–“ç¯„åœçš„å¹´åŒ–å ±é…¬ç‡
        
        Returns:
            {
                "cagr_1y": 15.5,   # 1 å¹´å¹´åŒ–
                "cagr_3y": 12.3,   # 3 å¹´å¹´åŒ–
                "cagr_5y": 18.7,   # 5 å¹´å¹´åŒ–
                "cagr_10y": 14.2,  # 10 å¹´å¹´åŒ–
            }
        """
        return {
            "cagr_1y": self.calculate_cagr(df, 1),
            "cagr_3y": self.calculate_cagr(df, 3),
            "cagr_5y": self.calculate_cagr(df, 5),
            "cagr_10y": self.calculate_cagr(df, 10),
        }
    
    def calculate_cagr_from_prices(
        self,
        start_price: float,
        end_price: float,
        years: float,
    ) -> Optional[float]:
        """
        å¾èµ·å§‹å’ŒçµæŸåƒ¹æ ¼è¨ˆç®— CAGR
        
        Args:
            start_price: èµ·å§‹åƒ¹æ ¼
            end_price: çµæŸåƒ¹æ ¼
            years: å¹´æ•¸
            
        Returns:
            å¹´åŒ–å ±é…¬ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        """
        if start_price <= 0 or end_price <= 0 or years <= 0:
            return None
        
        try:
            cagr = (end_price / start_price) ** (1 / years) - 1
            return round(cagr * 100, 2)
        except Exception:
            return None


# å»ºç«‹é è¨­å¯¦ä¾‹
indicator_service = IndicatorService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/line_notify_service.py  â­â­â­
> LINE Messaging API æ¨æ’­æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
LINE Messaging API æ¨æ’­æœå‹™
ç™¼é€æŠ€è¡“è¨Šè™Ÿé€šçŸ¥çµ¦ç”¨æˆ¶
"""
import httpx
import logging
from typing import List, Optional, Dict, Any
from datetime import datetime

from app.config import settings

logger = logging.getLogger(__name__)


class LineNotifyService:
    """LINE Messaging API æ¨æ’­æœå‹™"""
    
    PUSH_URL = "https://api.line.me/v2/bot/message/push"
    MULTICAST_URL = "https://api.line.me/v2/bot/message/multicast"
    BROADCAST_URL = "https://api.line.me/v2/bot/message/broadcast"
    
    def __init__(self):
        self.channel_access_token = settings.LINE_MESSAGING_CHANNEL_ACCESS_TOKEN
        self.enabled = bool(self.channel_access_token)
        
        if not self.enabled:
            logger.warning("LINE Messaging API æœªè¨­å®š Channel Access Tokenï¼Œæ¨æ’­åŠŸèƒ½åœç”¨")
    
    def _get_headers(self) -> Dict[str, str]:
        """å–å¾— API è«‹æ±‚æ¨™é ­"""
        return {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.channel_access_token}",
        }
    
    async def push_text_message(
        self, 
        user_id: str, 
        message: str
    ) -> bool:
        """
        æ¨é€æ–‡å­—è¨Šæ¯çµ¦å–®ä¸€ç”¨æˆ¶
        
        Args:
            user_id: LINE User ID
            message: è¨Šæ¯å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        if not user_id or not message:
            logger.warning("user_id æˆ– message ç‚ºç©º")
            return False
        
        payload = {
            "to": user_id,
            "messages": [
                {
                    "type": "text",
                    "text": message
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.PUSH_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=10.0
                )
                
                if response.status_code == 200:
                    logger.info(f"LINE æ¨æ’­æˆåŠŸ: user={user_id[:10]}...")
                    return True
                else:
                    logger.error(f"LINE æ¨æ’­å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE æ¨æ’­ä¾‹å¤–: {e}")
            return False
    
    async def push_flex_message(
        self,
        user_id: str,
        alt_text: str,
        flex_content: Dict[str, Any]
    ) -> bool:
        """
        æ¨é€ Flex Message çµ¦å–®ä¸€ç”¨æˆ¶
        
        Args:
            user_id: LINE User ID
            alt_text: æ›¿ä»£æ–‡å­—ï¼ˆæ‰‹æ©Ÿé€šçŸ¥é¡¯ç¤ºï¼‰
            flex_content: Flex Message å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        payload = {
            "to": user_id,
            "messages": [
                {
                    "type": "flex",
                    "altText": alt_text,
                    "contents": flex_content
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.PUSH_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=10.0
                )
                
                if response.status_code == 200:
                    logger.info(f"LINE Flex æ¨æ’­æˆåŠŸ: user={user_id[:10]}...")
                    return True
                else:
                    logger.error(f"LINE Flex æ¨æ’­å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE Flex æ¨æ’­ä¾‹å¤–: {e}")
            return False
    
    async def multicast_text_message(
        self,
        user_ids: List[str],
        message: str
    ) -> bool:
        """
        æ¨é€æ–‡å­—è¨Šæ¯çµ¦å¤šå€‹ç”¨æˆ¶ï¼ˆæœ€å¤š 500 äººï¼‰
        
        Args:
            user_ids: LINE User ID åˆ—è¡¨
            message: è¨Šæ¯å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        if not user_ids or not message:
            return False
        
        # LINE API é™åˆ¶æœ€å¤š 500 äºº
        if len(user_ids) > 500:
            logger.warning(f"ç”¨æˆ¶æ•¸è¶…é 500ï¼Œåªæ¨é€å‰ 500 äºº")
            user_ids = user_ids[:500]
        
        payload = {
            "to": user_ids,
            "messages": [
                {
                    "type": "text",
                    "text": message
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.MULTICAST_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=30.0
                )
                
                if response.status_code == 200:
                    logger.info(f"LINE ç¾¤ç™¼æˆåŠŸ: {len(user_ids)} äºº")
                    return True
                else:
                    logger.error(f"LINE ç¾¤ç™¼å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE ç¾¤ç™¼ä¾‹å¤–: {e}")
            return False
    
    async def broadcast_text_message(self, message: str) -> bool:
        """
        å»£æ’­è¨Šæ¯çµ¦æ‰€æœ‰å¥½å‹
        
        Args:
            message: è¨Šæ¯å…§å®¹
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        if not self.enabled:
            logger.warning("LINE æ¨æ’­æœªå•Ÿç”¨")
            return False
        
        payload = {
            "messages": [
                {
                    "type": "text",
                    "text": message
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    self.BROADCAST_URL,
                    headers=self._get_headers(),
                    json=payload,
                    timeout=30.0
                )
                
                if response.status_code == 200:
                    logger.info("LINE å»£æ’­æˆåŠŸ")
                    return True
                else:
                    logger.error(f"LINE å»£æ’­å¤±æ•—: {response.status_code} - {response.text}")
                    return False
                    
        except Exception as e:
            logger.error(f"LINE å»£æ’­ä¾‹å¤–: {e}")
            return False
    
    def create_signal_flex_message(
        self,
        symbol: str,
        signals: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        å»ºç«‹è¨Šè™Ÿé€šçŸ¥çš„ Flex Message
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            signals: è¨Šè™Ÿåˆ—è¡¨
            
        Returns:
            Flex Message å…§å®¹
        """
        # è¨Šè™Ÿé¡è‰²å°ç…§
        signal_colors = {
            "golden": "#00C853",  # ç¶ è‰²
            "death": "#FF1744",   # ç´…è‰²
            "overbought": "#FF9800",  # æ©™è‰²
            "oversold": "#00C853",
            "breakout": "#00C853",
            "breakdown": "#FF1744",
            "surge": "#2196F3",   # è—è‰²
            "fear": "#FF9800",
            "greed": "#FF1744",
        }
        
        def get_color(signal_type: str) -> str:
            for key, color in signal_colors.items():
                if key in signal_type.lower():
                    return color
            return "#666666"
        
        # å»ºç«‹è¨Šè™Ÿåˆ—è¡¨
        signal_boxes = []
        for s in signals:
            signal_type = s.get("signal_type", "")
            message = s.get("message", "")
            color = get_color(signal_type)
            
            signal_boxes.append({
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "text",
                        "text": "â—",
                        "size": "sm",
                        "color": color,
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": message,
                        "size": "sm",
                        "color": "#333333",
                        "flex": 1,
                        "wrap": True
                    }
                ],
                "margin": "sm"
            })
        
        # Flex Message çµæ§‹
        flex_content = {
            "type": "bubble",
            "size": "kilo",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": f"ğŸ“Š {symbol}",
                        "weight": "bold",
                        "size": "lg",
                        "color": "#FFFFFF"
                    }
                ],
                "backgroundColor": "#FA7A35",
                "paddingAll": "15px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": signal_boxes,
                "paddingAll": "15px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": datetime.now().strftime("%Y-%m-%d %H:%M"),
                        "size": "xs",
                        "color": "#999999",
                        "align": "end"
                    }
                ],
                "paddingAll": "10px"
            }
        }
        
        return flex_content


# å–®ä¾‹
line_notify_service = LineNotifyService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/market_service.py  â­â­â­
> å¸‚å ´æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æœå‹™
è™•ç†ä¸‰å¤§æŒ‡æ•¸ã€å¸‚å ´æƒ…ç·’çš„è³‡æ–™å­˜å–
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Dict, Any, List
from sqlalchemy.orm import Session
from sqlalchemy import select, and_, desc
import logging

from app.models.index_price import IndexPrice, INDEX_SYMBOLS
from app.models.market_sentiment import MarketSentiment
from app.models.dividend_history import DividendHistory
from app.models.stock_price import StockPrice
from app.data_sources.yahoo_finance import yahoo_finance
from app.data_sources.fear_greed import fear_greed

logger = logging.getLogger(__name__)


class MarketService:
    """å¸‚å ´æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    # ==================== ä¸‰å¤§æŒ‡æ•¸ ====================
    
    def get_latest_indices(self) -> Dict[str, Any]:
        """å–å¾—ä¸‰å¤§æŒ‡æ•¸æœ€æ–°è³‡æ–™ï¼Œå›å‚³å­—å…¸æ ¼å¼"""
        result = {}
        
        for symbol, info in INDEX_SYMBOLS.items():
            try:
                stmt = (
                    select(IndexPrice)
                    .where(IndexPrice.symbol == symbol)
                    .order_by(desc(IndexPrice.date))
                    .limit(1)
                )
                latest = self.db.execute(stmt).scalar_one_or_none()
                
                if latest:
                    result[symbol] = latest.to_dict()
                    continue
            except Exception as e:
                logger.warning(f"å¾è³‡æ–™åº«å–å¾— {symbol} å¤±æ•—: {e}")
            
            # Fallback: å¾ Yahoo Finance API å–å¾—
            try:
                df = yahoo_finance.get_index_data(symbol, period="5d")
                if df is not None and not df.empty:
                    row = df.iloc[-1]
                    result[symbol] = {
                        "symbol": symbol,
                        "name": info["name"],
                        "name_zh": info["name_zh"],
                        "date": str(row["date"]),
                        "close": float(row["close"]),
                        "change": float(row["change"]) if pd.notna(row.get("change")) else None,
                        "change_pct": float(row["change_pct"]) if pd.notna(row.get("change_pct")) else None,
                    }
                    logger.info(f"å¾ API å–å¾— {symbol}: {result[symbol]['close']}")
            except Exception as e:
                logger.error(f"å¾ API å–å¾— {symbol} å¤±æ•—: {e}")
        
        return result
    
    def get_index_history(
        self,
        symbol: str,
        days: int = 365,
    ) -> List[Dict[str, Any]]:
        """å–å¾—æŒ‡æ•¸æ­·å²è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(IndexPrice)
            .where(
                and_(
                    IndexPrice.symbol == symbol,
                    IndexPrice.date >= start_date,
                )
            )
            .order_by(IndexPrice.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        return [r.to_dict() for r in results]
    
    def save_index_data(self, df: pd.DataFrame, symbol: str) -> int:
        """
        å„²å­˜æŒ‡æ•¸è³‡æ–™åˆ°è³‡æ–™åº«
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        import math
        
        def clean_value(val):
            """æ¸…ç†å€¼ï¼Œå°‡ NaN/Inf è½‰ç‚º None"""
            if val is None:
                return None
            if pd.isna(val):
                return None
            try:
                f = float(val)
                if math.isnan(f) or math.isinf(f):
                    return None
                return f
            except (ValueError, TypeError):
                return None
        
        if df is None or df.empty:
            return 0
        
        count = 0
        index_info = INDEX_SYMBOLS.get(symbol, {})
        
        for _, row in df.iterrows():
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(IndexPrice).where(
                and_(
                    IndexPrice.symbol == symbol,
                    IndexPrice.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                # æ›´æ–°ç¾æœ‰è³‡æ–™
                existing.open = clean_value(row.get("open"))
                existing.high = clean_value(row.get("high"))
                existing.low = clean_value(row.get("low"))
                existing.close = clean_value(row.get("close"))
                existing.volume = row.get("volume")
                existing.change = clean_value(row.get("change"))
                existing.change_pct = clean_value(row.get("change_pct"))
            else:
                # æ–°å¢è³‡æ–™
                price = IndexPrice(
                    symbol=symbol,
                    name=index_info.get("name", symbol),
                    date=row["date"],
                    open=clean_value(row.get("open")),
                    high=clean_value(row.get("high")),
                    low=clean_value(row.get("low")),
                    close=clean_value(row.get("close")),
                    volume=row.get("volume"),
                    change=clean_value(row.get("change")),
                    change_pct=clean_value(row.get("change_pct")),
                )
                self.db.add(price)
                count += 1
        
        self.db.commit()
        return count
    
    def fetch_and_save_all_indices(self, period: str = "10y") -> Dict[str, int]:
        """
        æŠ“å–ä¸¦å„²å­˜æ‰€æœ‰ä¸‰å¤§æŒ‡æ•¸è³‡æ–™
        
        Returns:
            {symbol: å„²å­˜ç­†æ•¸}
        """
        result = {}
        
        for symbol in INDEX_SYMBOLS.keys():
            logger.info(f"æŠ“å–æŒ‡æ•¸è³‡æ–™: {symbol}")
            df = yahoo_finance.get_index_data(symbol, period=period)
            
            if df is not None:
                count = self.save_index_data(df, symbol)
                result[symbol] = count
                logger.info(f"{symbol} æ–°å¢ {count} ç­†è³‡æ–™")
            else:
                result[symbol] = 0
                logger.warning(f"{symbol} æŠ“å–å¤±æ•—")
        
        return result
    
    # ==================== å¸‚å ´æƒ…ç·’ ====================
    
    def get_latest_sentiment(self) -> Dict[str, Any]:
        """
        å–å¾—æœ€æ–°çš„å¸‚å ´æƒ…ç·’
        
        ğŸ”§ ä¿®å¾©ç‰ˆæœ¬ï¼š
        - å„ªå…ˆå¾è³‡æ–™åº«è®€å–ï¼ˆæ¯«ç§’ç´šï¼‰
        - æª¢æŸ¥è³‡æ–™æ–°é®®åº¦ï¼ˆè¶…é 1 å¤©æ‰é‡æ–°æŠ“å–ï¼‰
        - è³‡æ–™åº«æ²’æœ‰æ™‚æ‰å‘¼å«å¤–éƒ¨ API
        - å¾ API å–å¾—å¾Œæœƒå­˜å…¥è³‡æ–™åº«
        """
        result = {}
        today = date.today()
        
        for market in ["stock", "crypto"]:
            # 1. å…ˆæŸ¥è³‡æ–™åº«
            stmt = (
                select(MarketSentiment)
                .where(MarketSentiment.market == market)
                .order_by(desc(MarketSentiment.date))
                .limit(1)
            )
            latest = self.db.execute(stmt).scalar_one_or_none()
            
            if latest:
                # 2. æª¢æŸ¥è³‡æ–™æ–°é®®åº¦ï¼ˆä»Šå¤©æˆ–æ˜¨å¤©çš„è³‡æ–™éƒ½å¯æ¥å—ï¼‰
                if latest.date >= today - timedelta(days=1):
                    result[market] = latest.to_dict()
                    logger.debug(f"[Sentiment] {market} å¾è³‡æ–™åº«è®€å–: {latest.value}")
                    continue
                else:
                    logger.info(f"[Sentiment] {market} è³‡æ–™éæœŸ (date={latest.date}), å˜—è©¦æ›´æ–°...")
            else:
                logger.info(f"[Sentiment] {market} è³‡æ–™åº«ç„¡è³‡æ–™, å˜—è©¦å¾ API æŠ“å–...")
            
            # 3. è³‡æ–™éæœŸæˆ–ä¸å­˜åœ¨ï¼Œå¾ API æŠ“å–
            try:
                if market == "crypto":
                    data = fear_greed.get_crypto_fear_greed()
                else:
                    data = fear_greed.get_stock_fear_greed()
                
                if data and not data.get("is_fallback"):
                    # ğŸ†• å­˜å…¥è³‡æ–™åº«ï¼ˆä¸‹æ¬¡å°±ä¸ç”¨å†æŠ“äº†ï¼‰
                    self.save_sentiment(market, data["value"])
                    result[market] = data
                    logger.info(f"[Sentiment] {market} å¾ API æ›´æ–°æˆåŠŸ: {data['value']}")
                elif latest:
                    # API å¤±æ•—ä½†æœ‰èˆŠè³‡æ–™ï¼Œè¿”å›èˆŠè³‡æ–™
                    result[market] = latest.to_dict()
                    logger.warning(f"[Sentiment] {market} API å¤±æ•—ï¼Œä½¿ç”¨èˆŠè³‡æ–™")
                elif data:
                    # å®Œå…¨æ²’è³‡æ–™ï¼Œè¿”å› API çµæœï¼ˆå¯èƒ½æ˜¯ fallbackï¼‰
                    result[market] = data
            except Exception as e:
                logger.error(f"[Sentiment] {market} æŠ“å–å¤±æ•—: {e}")
                if latest:
                    result[market] = latest.to_dict()
        
        return result


    def get_sentiment_history(
        self,
        market: str,
        days: int = 365,
    ) -> List[Dict[str, Any]]:
        """å–å¾—æƒ…ç·’æ­·å²è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(MarketSentiment)
            .where(
                and_(
                    MarketSentiment.market == market,
                    MarketSentiment.date >= start_date,
                )
            )
            .order_by(MarketSentiment.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        return [r.to_dict() for r in results]
    
    def save_sentiment(
        self,
        market: str,
        value: int,
        target_date: Optional[date] = None,
    ) -> bool:
        """
        å„²å­˜å¸‚å ´æƒ…ç·’è³‡æ–™
        """
        if target_date is None:
            target_date = date.today()
        
        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        stmt = select(MarketSentiment).where(
            and_(
                MarketSentiment.market == market,
                MarketSentiment.date == target_date,
            )
        )
        existing = self.db.execute(stmt).scalar_one_or_none()
        
        classification = MarketSentiment.get_classification(value)
        
        if existing:
            existing.value = value
            existing.classification = classification
        else:
            sentiment = MarketSentiment(
                date=target_date,
                market=market,
                value=value,
                classification=classification,
            )
            self.db.add(sentiment)
        
        self.db.commit()
        return True
    
    def fetch_and_save_crypto_history(self, days: int = 365) -> int:
        """
        æŠ“å–ä¸¦å„²å­˜å¹£åœˆæƒ…ç·’æ­·å²è³‡æ–™
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        logger.info(f"æŠ“å–å¹£åœˆæƒ…ç·’æ­·å²: {days} å¤©")
        history = fear_greed.get_crypto_fear_greed_history(days)
        
        count = 0
        for item in history:
            try:
                target_date = datetime.strptime(item["date"], "%Y-%m-%d").date()
                
                # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                stmt = select(MarketSentiment).where(
                    and_(
                        MarketSentiment.market == "crypto",
                        MarketSentiment.date == target_date,
                    )
                )
                existing = self.db.execute(stmt).scalar_one_or_none()
                
                if not existing:
                    sentiment = MarketSentiment(
                        date=target_date,
                        market="crypto",
                        value=item["value"],
                        classification=item["classification"],
                    )
                    self.db.add(sentiment)
                    count += 1
            except Exception as e:
                logger.error(f"å„²å­˜æƒ…ç·’è³‡æ–™å¤±æ•—: {e}")
        
        self.db.commit()
        logger.info(f"å¹£åœˆæƒ…ç·’æ­·å²æ–°å¢ {count} ç­†")
        return count
    
    def update_today_sentiment(self) -> Dict[str, bool]:
        """
        æ›´æ–°ä»Šæ—¥çš„å¸‚å ´æƒ…ç·’
        
        Returns:
            {market: success}
        """
        result = {}
        
        # ç¾è‚¡æƒ…ç·’
        stock_data = fear_greed.get_stock_fear_greed()
        if stock_data and not stock_data.get("is_fallback"):
            result["stock"] = self.save_sentiment("stock", stock_data["value"])
        else:
            result["stock"] = False
        
        # å¹£åœˆæƒ…ç·’
        crypto_data = fear_greed.get_crypto_fear_greed()
        if crypto_data and not crypto_data.get("is_fallback"):
            result["crypto"] = self.save_sentiment("crypto", crypto_data["value"])
        else:
            result["crypto"] = False
        
        return result
    
    # ==================== é…æ¯è³‡æ–™ ====================
    
    def save_dividends(self, df: pd.DataFrame) -> int:
        """
        å„²å­˜é…æ¯è³‡æ–™
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(DividendHistory).where(
                and_(
                    DividendHistory.symbol == row["symbol"],
                    DividendHistory.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if not existing:
                dividend = DividendHistory(
                    symbol=row["symbol"],
                    date=row["date"],
                    amount=row["amount"],
                )
                self.db.add(dividend)
                count += 1
        
        self.db.commit()
        return count
    
    def fetch_and_save_dividends(self, symbol: str, period: str = "10y") -> int:
        """
        æŠ“å–ä¸¦å„²å­˜é…æ¯è³‡æ–™
        """
        logger.info(f"æŠ“å–é…æ¯è³‡æ–™: {symbol}")
        df = yahoo_finance.get_dividends(symbol, period=period)
        
        if df is not None:
            count = self.save_dividends(df)
            logger.info(f"{symbol} é…æ¯æ–°å¢ {count} ç­†")
            return count
        
        return 0
    
    def get_dividends(
        self,
        symbol: str,
        years: int = 10,
    ) -> List[Dict[str, Any]]:
        """å–å¾—é…æ¯æ­·å²"""
        start_date = date.today() - timedelta(days=years * 365)
        
        stmt = (
            select(DividendHistory)
            .where(
                and_(
                    DividendHistory.symbol == symbol.upper(),
                    DividendHistory.date >= start_date,
                )
            )
            .order_by(DividendHistory.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        return [r.to_dict() for r in results]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/notification_service.py  â­â­â­
> é€šçŸ¥ç®¡ç†æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
é€šçŸ¥ç®¡ç†æœå‹™
æ•´åˆè¨Šè™Ÿåµæ¸¬ã€é€šçŸ¥è¨˜éŒ„ã€LINE æ¨æ’­
"""
import logging
from datetime import datetime, timedelta
from typing import List, Dict, Any, Optional, Set
from sqlalchemy import select, and_, func
from sqlalchemy.ext.asyncio import AsyncSession

from app.models.user import User
from app.models.watchlist import Watchlist
from app.models.notification import Notification
from app.models.user_settings import UserAlertSettings
from app.services.signal_service import Signal, SignalType, signal_service
from app.services.line_notify_service import line_notify_service
from app.services.indicator_service import indicator_service
from app.data_sources.yahoo_finance import yahoo_finance

logger = logging.getLogger(__name__)


class NotificationService:
    """é€šçŸ¥ç®¡ç†æœå‹™"""
    
    # è¨Šè™Ÿé¡å‹èˆ‡é€šçŸ¥è¨­å®šçš„å°æ‡‰
    SIGNAL_TO_SETTING = {
        SignalType.MA_GOLDEN_CROSS: "alert_ma_cross",
        SignalType.MA_DEATH_CROSS: "alert_ma_cross",
        SignalType.APPROACHING_BREAKOUT: "alert_ma_breakout",
        SignalType.APPROACHING_BREAKDOWN: "alert_ma_breakout",
        SignalType.BREAKOUT: "alert_ma_breakout",
        SignalType.BREAKDOWN: "alert_ma_breakout",
        SignalType.RSI_OVERBOUGHT: "alert_rsi",
        SignalType.RSI_OVERSOLD: "alert_rsi",
        SignalType.MACD_GOLDEN_CROSS: "alert_macd",
        SignalType.MACD_DEATH_CROSS: "alert_macd",
        SignalType.KD_GOLDEN_CROSS: "alert_kd",
        SignalType.KD_DEATH_CROSS: "alert_kd",
        SignalType.BOLLINGER_BREAKOUT: "alert_bollinger",
        SignalType.BOLLINGER_BREAKDOWN: "alert_bollinger",
        SignalType.VOLUME_SURGE: "alert_volume",
        SignalType.SENTIMENT_EXTREME_FEAR: "alert_sentiment",
        SignalType.SENTIMENT_EXTREME_GREED: "alert_sentiment",
    }
    
    async def get_all_tracked_symbols(self, db: AsyncSession) -> Dict[str, Set[int]]:
        """
        å–å¾—æ‰€æœ‰ç”¨æˆ¶è¿½è¹¤çš„è‚¡ç¥¨ï¼ˆè¯é›†ï¼‰
        
        Returns:
            {symbol: set(user_ids)} å°æ‡‰è¡¨
        """
        result = await db.execute(
            select(Watchlist.symbol, Watchlist.user_id, Watchlist.asset_type)
            .join(User, Watchlist.user_id == User.id)
            .where(User.is_active == True)
            .where(User.is_blocked == False)
        )
        rows = result.all()
        
        symbol_users = {}
        for symbol, user_id, asset_type in rows:
            key = f"{symbol}|{asset_type}"
            if key not in symbol_users:
                symbol_users[key] = {"symbol": symbol, "asset_type": asset_type, "users": set()}
            symbol_users[key]["users"].add(user_id)
        
        logger.info(f"å…± {len(symbol_users)} å€‹è¿½è¹¤æ¨™çš„")
        return symbol_users
    
    async def get_user_alert_settings(
        self, 
        db: AsyncSession, 
        user_id: int
    ) -> Dict[str, bool]:
        """å–å¾—ç”¨æˆ¶çš„é€šçŸ¥è¨­å®š"""
        result = await db.execute(
            select(UserAlertSettings).where(UserAlertSettings.user_id == user_id)
        )
        settings = result.scalar_one_or_none()
        
        if not settings:
            # ä½¿ç”¨é è¨­å€¼ï¼ˆå…¨éƒ¨é–‹å•Ÿï¼‰
            return {
                "alert_ma_cross": True,
                "alert_ma_breakout": True,
                "alert_rsi": True,
                "alert_macd": True,
                "alert_kd": False,
                "alert_bollinger": False,
                "alert_volume": False,
                "alert_sentiment": True,
            }
        
        return {
            "alert_ma_cross": settings.alert_ma_cross,
            "alert_ma_breakout": settings.alert_ma_breakout,
            "alert_rsi": settings.alert_rsi,
            "alert_macd": settings.alert_macd,
            "alert_kd": settings.alert_kd,
            "alert_bollinger": settings.alert_bollinger,
            "alert_volume": settings.alert_volume,
            "alert_sentiment": settings.alert_sentiment,
        }
    
    async def is_recently_notified(
        self,
        db: AsyncSession,
        user_id: int,
        symbol: str,
        signal_type: str,
        hours: int = 24
    ) -> bool:
        """
        æª¢æŸ¥æ˜¯å¦æœ€è¿‘å·²é€šçŸ¥éï¼ˆé˜²æ­¢é‡è¤‡ï¼‰
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            signal_type: è¨Šè™Ÿé¡å‹
            hours: å¤šå°‘å°æ™‚å…§ä¸é‡è¤‡
            
        Returns:
            æ˜¯å¦å·²é€šçŸ¥é
        """
        since = datetime.utcnow() - timedelta(hours=hours)
        
        result = await db.execute(
            select(func.count(Notification.id))
            .where(and_(
                Notification.user_id == user_id,
                Notification.symbol == symbol,
                Notification.alert_type == signal_type,
                Notification.triggered_at >= since
            ))
        )
        count = result.scalar()
        return count > 0
    
    async def save_notification(
        self,
        db: AsyncSession,
        user_id: int,
        signal: Signal,
        sent: bool = False
    ) -> Notification:
        """å„²å­˜é€šçŸ¥è¨˜éŒ„"""
        notification = Notification(
            user_id=user_id,
            symbol=signal.symbol,
            asset_type=signal.asset_type,
            alert_type=signal.signal_type.value,
            indicator=signal.indicator,
            message=signal.message,
            price_at_trigger=signal.price if signal.price > 0 else None,
            triggered_at=signal.timestamp,
            sent=sent,
            sent_at=datetime.utcnow() if sent else None,
        )
        db.add(notification)
        await db.commit()
        return notification
    
    async def process_signals_for_user(
        self,
        db: AsyncSession,
        user_id: int,
        line_user_id: str,
        signals: List[Signal]
    ) -> Dict[str, Any]:
        """
        è™•ç†ç”¨æˆ¶çš„è¨Šè™Ÿé€šçŸ¥
        
        Args:
            db: è³‡æ–™åº« session
            user_id: ç”¨æˆ¶ ID
            line_user_id: LINE User ID
            signals: è¨Šè™Ÿåˆ—è¡¨
            
        Returns:
            è™•ç†çµæœ
        """
        if not signals:
            return {"sent": 0, "skipped": 0, "filtered": 0}
        
        # å–å¾—ç”¨æˆ¶é€šçŸ¥è¨­å®š
        alert_settings = await self.get_user_alert_settings(db, user_id)
        
        sent_count = 0
        skipped_count = 0
        filtered_count = 0
        signals_to_send = []
        
        for signal in signals:
            # 1. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é–‹å•Ÿæ­¤é¡é€šçŸ¥
            setting_key = self.SIGNAL_TO_SETTING.get(signal.signal_type)
            if setting_key and not alert_settings.get(setting_key, True):
                filtered_count += 1
                continue
            
            # 2. æª¢æŸ¥æ˜¯å¦æœ€è¿‘å·²é€šçŸ¥é
            if await self.is_recently_notified(
                db, user_id, signal.symbol, signal.signal_type.value
            ):
                skipped_count += 1
                continue
            
            signals_to_send.append(signal)
        
        # 3. ç™¼é€ LINE é€šçŸ¥
        if signals_to_send and line_user_id:
            # åˆä½µè¨Šæ¯ç™¼é€
            message = signal_service.format_signals_summary(signals_to_send)
            
            success = await line_notify_service.push_text_message(
                line_user_id, message
            )
            
            # 4. å„²å­˜é€šçŸ¥è¨˜éŒ„
            for signal in signals_to_send:
                await self.save_notification(db, user_id, signal, sent=success)
                if success:
                    sent_count += 1
        
        return {
            "sent": sent_count,
            "skipped": skipped_count,
            "filtered": filtered_count,
        }
    
    async def run_signal_check(self, db: AsyncSession) -> Dict[str, Any]:
        """
        åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥ï¼ˆä¸»è¦å…¥å£ï¼‰
        
        æµç¨‹ï¼š
        1. å–å¾—æ‰€æœ‰è¿½è¹¤çš„è‚¡ç¥¨
        2. è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        3. åµæ¸¬è¨Šè™Ÿ
        4. æ ¹æ“šç”¨æˆ¶è¨­å®šéæ¿¾ä¸¦ç™¼é€é€šçŸ¥
        
        Returns:
            åŸ·è¡Œçµæœæ‘˜è¦
        """
        logger.info("=" * 50)
        logger.info("é–‹å§‹åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥")
        logger.info("=" * 50)
        
        start_time = datetime.now()
        result = {
            "symbols_checked": 0,
            "signals_detected": 0,
            "notifications_sent": 0,
            "errors": [],
        }
        
        try:
            # 1. å–å¾—æ‰€æœ‰è¿½è¹¤çš„è‚¡ç¥¨
            symbol_users = await self.get_all_tracked_symbols(db)
            
            if not symbol_users:
                logger.info("ç„¡è¿½è¹¤æ¨™çš„ï¼ŒçµæŸæª¢æŸ¥")
                return result
            
            all_signals_by_symbol = {}  # {symbol: [signals]}
            
            # 2. é€ä¸€è¨ˆç®—æŒ‡æ¨™ä¸¦åµæ¸¬è¨Šè™Ÿ
            for key, info in symbol_users.items():
                symbol = info["symbol"]
                asset_type = info["asset_type"]
                
                try:
                    # å–å¾—è‚¡åƒ¹è³‡æ–™
                    if asset_type == "stock":
                        df = yahoo_finance.get_stock_history(symbol, period="6mo")
                    else:
                        # åŠ å¯†è²¨å¹£è™•ç†
                        from app.services.crypto_service import crypto_service
                        df = await crypto_service.get_crypto_history(symbol, period="6mo")
                    
                    if df is None or df.empty:
                        logger.warning(f"{symbol} ç„¡æ³•å–å¾—è³‡æ–™")
                        continue
                    
                    # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
                    indicators = indicator_service.calculate_all_indicators(df)
                    
                    if not indicators:
                        continue
                    
                    # åµæ¸¬è¨Šè™Ÿ
                    signals = signal_service.detect_signals(
                        symbol, indicators, asset_type
                    )
                    
                    if signals:
                        all_signals_by_symbol[key] = {
                            "signals": signals,
                            "users": info["users"],
                        }
                        result["signals_detected"] += len(signals)
                    
                    result["symbols_checked"] += 1
                    
                except Exception as e:
                    logger.error(f"è™•ç† {symbol} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                    result["errors"].append(f"{symbol}: {str(e)}")
            
            # 3. ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
            for key, data in all_signals_by_symbol.items():
                signals = data["signals"]
                user_ids = data["users"]
                
                for user_id in user_ids:
                    try:
                        # å–å¾—ç”¨æˆ¶ LINE ID
                        user_result = await db.execute(
                            select(User).where(User.id == user_id)
                        )
                        user = user_result.scalar_one_or_none()
                        
                        if not user or not user.line_user_id:
                            continue
                        
                        # è™•ç†ä¸¦ç™¼é€é€šçŸ¥
                        send_result = await self.process_signals_for_user(
                            db, user_id, user.line_user_id, signals
                        )
                        
                        result["notifications_sent"] += send_result["sent"]
                        
                    except Exception as e:
                        logger.error(f"ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶ {user_id} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                        result["errors"].append(f"user_{user_id}: {str(e)}")
            
            # 4. æª¢æŸ¥å¸‚å ´æƒ…ç·’
            try:
                from app.services.market_service import MarketService
                market_service = MarketService()
                sentiment = await market_service.get_current_sentiment()
                
                sentiment_signals = signal_service.detect_sentiment_signals(sentiment)
                
                if sentiment_signals:
                    result["signals_detected"] += len(sentiment_signals)
                    # æƒ…ç·’è¨Šè™Ÿç™¼é€çµ¦æ‰€æœ‰é–‹å•Ÿæ­¤é€šçŸ¥çš„ç”¨æˆ¶
                    # ï¼ˆé€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›å¯ä»¥æ›´ç²¾ç´°æ§åˆ¶ï¼‰
                    logger.info(f"åµæ¸¬åˆ° {len(sentiment_signals)} å€‹æƒ…ç·’è¨Šè™Ÿ")
                    
            except Exception as e:
                logger.error(f"æª¢æŸ¥å¸‚å ´æƒ…ç·’æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            
        except Exception as e:
            logger.error(f"è¨Šè™Ÿæª¢æŸ¥ç™¼ç”Ÿåš´é‡éŒ¯èª¤: {e}", exc_info=True)
            result["errors"].append(f"critical: {str(e)}")
        
        elapsed = (datetime.now() - start_time).total_seconds()
        result["elapsed_seconds"] = round(elapsed, 2)
        
        logger.info(f"è¨Šè™Ÿæª¢æŸ¥å®Œæˆ: {result}")
        return result
    
    async def get_user_notifications(
        self,
        db: AsyncSession,
        user_id: int,
        limit: int = 50,
        unread_only: bool = False
    ) -> List[Dict]:
        """å–å¾—ç”¨æˆ¶çš„é€šçŸ¥æ­·å²"""
        query = select(Notification).where(
            Notification.user_id == user_id
        ).order_by(Notification.triggered_at.desc()).limit(limit)
        
        if unread_only:
            query = query.where(Notification.sent == False)
        
        result = await db.execute(query)
        notifications = result.scalars().all()
        
        return [n.to_dict() for n in notifications]


# å–®ä¾‹
notification_service = NotificationService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/portfolio_service.py  â­â­â­
> æŠ•è³‡çµ„åˆæ¥­å‹™é‚è¼¯æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æŠ•è³‡çµ„åˆæ¥­å‹™é‚è¼¯æœå‹™
è™•ç†äº¤æ˜“ç´€éŒ„çš„ CRUD å’ŒæŒè‚¡è¨ˆç®—
"""
from datetime import date, datetime
from decimal import Decimal
from typing import List, Optional, Dict, Any
import logging

from sqlalchemy import select, update, delete, func, and_
from sqlalchemy.ext.asyncio import AsyncSession

from app.models.portfolio import PortfolioTransaction, PortfolioHolding, ExchangeRate
from app.models.price_cache import StockPriceCache
from app.services.exchange_rate_service import DEFAULT_USD_TWD_RATE

logger = logging.getLogger(__name__)


class PortfolioService:
    """æŠ•è³‡çµ„åˆæœå‹™"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    # ============================================================
    # äº¤æ˜“ç´€éŒ„ CRUD
    # ============================================================
    
    async def create_transaction(
        self,
        user_id: int,
        symbol: str,
        market: str,
        transaction_type: str,
        quantity: int,
        price: float,
        transaction_date: date,
        name: Optional[str] = None,
        fee: float = 0,
        tax: float = 0,
        note: Optional[str] = None,
    ) -> PortfolioTransaction:
        """æ–°å¢äº¤æ˜“ç´€éŒ„"""
        
        # é©—è­‰
        if transaction_type not in ("buy", "sell"):
            raise ValueError("transaction_type å¿…é ˆæ˜¯ 'buy' æˆ– 'sell'")
        if market not in ("tw", "us"):
            raise ValueError("market å¿…é ˆæ˜¯ 'tw' æˆ– 'us'")
        if quantity <= 0:
            raise ValueError("quantity å¿…é ˆå¤§æ–¼ 0")
        if price <= 0:
            raise ValueError("price å¿…é ˆå¤§æ–¼ 0")
        
        # æ¨™æº–åŒ– symbol
        symbol = symbol.upper().strip()
        
        # å»ºç«‹äº¤æ˜“ç´€éŒ„
        transaction = PortfolioTransaction(
            user_id=user_id,
            symbol=symbol,
            name=name,
            market=market,
            transaction_type=transaction_type,
            quantity=quantity,
            price=Decimal(str(price)),
            fee=Decimal(str(fee)) if fee else Decimal("0"),
            tax=Decimal(str(tax)) if tax else Decimal("0"),
            transaction_date=transaction_date,
            note=note,
        )
        
        self.db.add(transaction)
        await self.db.commit()
        await self.db.refresh(transaction)
        
        logger.info(f"æ–°å¢äº¤æ˜“: user={user_id}, {transaction_type} {quantity} {symbol} @ {price}")
        
        # æ›´æ–°æŒè‚¡å½™ç¸½
        await self._update_holding(user_id, symbol, market, name)
        
        return transaction
    
    async def get_transaction(self, transaction_id: int, user_id: int) -> Optional[PortfolioTransaction]:
        """å–å¾—å–®ç­†äº¤æ˜“"""
        stmt = select(PortfolioTransaction).where(
            and_(
                PortfolioTransaction.id == transaction_id,
                PortfolioTransaction.user_id == user_id,
            )
        )
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def get_transactions(
        self,
        user_id: int,
        market: Optional[str] = None,
        symbol: Optional[str] = None,
        limit: int = 100,
        offset: int = 0,
    ) -> List[PortfolioTransaction]:
        """å–å¾—äº¤æ˜“ç´€éŒ„åˆ—è¡¨"""
        stmt = select(PortfolioTransaction).where(
            PortfolioTransaction.user_id == user_id
        )
        
        if market:
            stmt = stmt.where(PortfolioTransaction.market == market)
        if symbol:
            stmt = stmt.where(PortfolioTransaction.symbol == symbol.upper())
        
        stmt = stmt.order_by(PortfolioTransaction.transaction_date.desc())
        stmt = stmt.limit(limit).offset(offset)
        
        result = await self.db.execute(stmt)
        return list(result.scalars().all())
    
    async def update_transaction(
        self,
        transaction_id: int,
        user_id: int,
        **kwargs,
    ) -> Optional[PortfolioTransaction]:
        """æ›´æ–°äº¤æ˜“ç´€éŒ„"""
        transaction = await self.get_transaction(transaction_id, user_id)
        if not transaction:
            return None
        
        old_symbol = transaction.symbol
        old_market = transaction.market
        
        # æ›´æ–°æ¬„ä½
        allowed_fields = {
            'symbol', 'name', 'market', 'transaction_type',
            'quantity', 'price', 'fee', 'tax', 'transaction_date', 'note'
        }
        
        for key, value in kwargs.items():
            if key in allowed_fields and value is not None:
                if key in ('price', 'fee', 'tax'):
                    value = Decimal(str(value))
                if key == 'symbol':
                    value = value.upper().strip()
                setattr(transaction, key, value)
        
        await self.db.commit()
        await self.db.refresh(transaction)
        
        # æ›´æ–°æŒè‚¡å½™ç¸½
        await self._update_holding(user_id, transaction.symbol, transaction.market, transaction.name)
        
        # å¦‚æœ symbol æˆ– market æ”¹è®Šï¼Œä¹Ÿè¦æ›´æ–°èˆŠçš„
        if old_symbol != transaction.symbol or old_market != transaction.market:
            await self._update_holding(user_id, old_symbol, old_market)
        
        logger.info(f"æ›´æ–°äº¤æ˜“: id={transaction_id}")
        return transaction
    
    async def delete_transaction(self, transaction_id: int, user_id: int) -> bool:
        """åˆªé™¤äº¤æ˜“ç´€éŒ„"""
        transaction = await self.get_transaction(transaction_id, user_id)
        if not transaction:
            return False
        
        symbol = transaction.symbol
        market = transaction.market
        
        await self.db.delete(transaction)
        await self.db.commit()
        
        # æ›´æ–°æŒè‚¡å½™ç¸½
        await self._update_holding(user_id, symbol, market)
        
        logger.info(f"åˆªé™¤äº¤æ˜“: id={transaction_id}")
        return True
    
    # ============================================================
    # æŒè‚¡å½™ç¸½
    # ============================================================
    
    async def _update_holding(
        self,
        user_id: int,
        symbol: str,
        market: str,
        name: Optional[str] = None,
    ):
        """æ›´æ–°å–®ä¸€è‚¡ç¥¨çš„æŒè‚¡å½™ç¸½"""
        
        # å–å¾—è©²è‚¡ç¥¨çš„æ‰€æœ‰äº¤æ˜“
        stmt = select(PortfolioTransaction).where(
            and_(
                PortfolioTransaction.user_id == user_id,
                PortfolioTransaction.symbol == symbol,
                PortfolioTransaction.market == market,
            )
        ).order_by(PortfolioTransaction.transaction_date.asc())
        
        result = await self.db.execute(stmt)
        transactions = list(result.scalars().all())
        
        # è¨ˆç®—æŒè‚¡
        total_shares = 0
        total_cost = Decimal("0")
        realized_profit = Decimal("0")
        latest_name = name
        
        for tx in transactions:
            if tx.name:
                latest_name = tx.name
            
            if tx.transaction_type == "buy":
                total_shares += tx.quantity
                total_cost += Decimal(str(tx.quantity)) * tx.price + (tx.fee or Decimal("0"))
            else:  # sell
                if total_shares > 0:
                    # è¨ˆç®—å·²å¯¦ç¾æç›Šï¼ˆå…ˆé€²å…ˆå‡ºï¼‰
                    avg_cost = total_cost / Decimal(str(total_shares)) if total_shares > 0 else Decimal("0")
                    sell_revenue = Decimal(str(tx.quantity)) * tx.price - (tx.fee or Decimal("0")) - (tx.tax or Decimal("0"))
                    sell_cost = avg_cost * Decimal(str(tx.quantity))
                    realized_profit += sell_revenue - sell_cost
                    
                    # æ›´æ–°æŒè‚¡å’Œæˆæœ¬
                    total_shares -= tx.quantity
                    total_cost -= sell_cost
                    
                    if total_shares <= 0:
                        total_shares = 0
                        total_cost = Decimal("0")
        
        # è¨ˆç®—å¹³å‡æˆæœ¬
        avg_cost = total_cost / Decimal(str(total_shares)) if total_shares > 0 else Decimal("0")
        
        # æ›´æ–°æˆ–å»ºç«‹ Holding
        stmt = select(PortfolioHolding).where(
            and_(
                PortfolioHolding.user_id == user_id,
                PortfolioHolding.symbol == symbol,
                PortfolioHolding.market == market,
            )
        )
        result = await self.db.execute(stmt)
        holding = result.scalar_one_or_none()
        
        if total_shares > 0 or realized_profit != 0:
            if holding:
                holding.total_shares = total_shares
                holding.avg_cost = avg_cost
                holding.total_invested = total_cost
                holding.realized_profit = realized_profit
                if latest_name:
                    holding.name = latest_name
            else:
                holding = PortfolioHolding(
                    user_id=user_id,
                    symbol=symbol,
                    name=latest_name,
                    market=market,
                    total_shares=total_shares,
                    avg_cost=avg_cost,
                    total_invested=total_cost,
                    realized_profit=realized_profit,
                )
                self.db.add(holding)
            
            await self.db.commit()
        elif holding:
            # æ²’æœ‰æŒè‚¡ä¹Ÿæ²’æœ‰å·²å¯¦ç¾æç›Šï¼Œåˆªé™¤ Holding
            await self.db.delete(holding)
            await self.db.commit()
    
    async def get_holdings(
        self,
        user_id: int,
        market: Optional[str] = None,
    ) -> List[PortfolioHolding]:
        """å–å¾—æŒè‚¡åˆ—è¡¨"""
        stmt = select(PortfolioHolding).where(
            PortfolioHolding.user_id == user_id
        )
        
        if market:
            stmt = stmt.where(PortfolioHolding.market == market)
        
        stmt = stmt.order_by(PortfolioHolding.symbol)
        
        result = await self.db.execute(stmt)
        return list(result.scalars().all())
    
    async def get_holdings_with_prices(
        self,
        user_id: int,
        market: Optional[str] = None,
    ) -> List[Dict[str, Any]]:
        """å–å¾—æŒè‚¡åˆ—è¡¨ï¼ˆå«ç¾åƒ¹ï¼‰"""
        holdings = await self.get_holdings(user_id, market)
        
        if not holdings:
            return []
        
        # å–å¾—åƒ¹æ ¼å¿«å–
        symbols = [h.symbol for h in holdings]
        cache_stmt = select(StockPriceCache).where(
            StockPriceCache.symbol.in_(symbols)
        )
        cache_result = await self.db.execute(cache_stmt)
        price_cache = {r.symbol: r for r in cache_result.scalars().all()}
        
        # çµ„åˆè³‡æ–™
        result = []
        for h in holdings:
            cache = price_cache.get(h.symbol)
            current_price = float(cache.price) if cache and cache.price else None
            
            # è¨ˆç®—æœªå¯¦ç¾æç›Š
            unrealized_profit = None
            unrealized_profit_pct = None
            current_value = None
            
            if current_price and h.total_shares > 0:
                current_value = current_price * h.total_shares
                cost_basis = float(h.avg_cost) * h.total_shares if h.avg_cost else 0
                unrealized_profit = current_value - cost_basis
                if cost_basis > 0:
                    unrealized_profit_pct = (unrealized_profit / cost_basis) * 100
            
            result.append({
                **h.to_dict(),
                "current_price": current_price,
                "current_value": current_value,
                "unrealized_profit": unrealized_profit,
                "unrealized_profit_pct": unrealized_profit_pct,
                "price_change_pct": float(cache.change_pct) if cache and cache.change_pct else None,
            })
        
        return result
    
    async def _get_exchange_rate(self) -> float:
        """å–å¾— USD/TWD åŒ¯ç‡"""
        stmt = select(ExchangeRate).where(
            ExchangeRate.from_currency == "USD",
            ExchangeRate.to_currency == "TWD"
        )
        result = await self.db.execute(stmt)
        rate_record = result.scalar_one_or_none()
        
        return rate_record.rate if rate_record else DEFAULT_USD_TWD_RATE
    
    async def get_summary(self, user_id: int) -> Dict[str, Any]:
        """å–å¾—æŠ•è³‡æ‘˜è¦ï¼ˆåˆ†å°è‚¡/ç¾è‚¡ + åŠ ç¸½ï¼‰"""
        
        # å–å¾—åŒ¯ç‡
        exchange_rate = await self._get_exchange_rate()
        
        # å–å¾—åŒ¯ç‡æ›´æ–°æ™‚é–“
        stmt = select(ExchangeRate).where(
            ExchangeRate.from_currency == "USD",
            ExchangeRate.to_currency == "TWD"
        )
        result = await self.db.execute(stmt)
        rate_record = result.scalar_one_or_none()
        rate_updated_at = rate_record.updated_at.isoformat() if rate_record and rate_record.updated_at else None
        
        # å–å¾—å°è‚¡æŒè‚¡
        tw_holdings = await self.get_holdings_with_prices(user_id, "tw")
        # å–å¾—ç¾è‚¡æŒè‚¡
        us_holdings = await self.get_holdings_with_prices(user_id, "us")
        
        # å°è‚¡çµ±è¨ˆ
        tw_invested = sum(float(h['total_invested'] or 0) for h in tw_holdings)
        tw_current_value = sum(h['current_value'] or 0 for h in tw_holdings if h['current_value'])
        tw_realized = sum(float(h['realized_profit'] or 0) for h in tw_holdings)
        tw_unrealized = sum(h['unrealized_profit'] or 0 for h in tw_holdings if h['unrealized_profit'])
        tw_positions = len([h for h in tw_holdings if h['total_shares'] > 0])
        
        # ç¾è‚¡çµ±è¨ˆ
        us_invested = sum(float(h['total_invested'] or 0) for h in us_holdings)
        us_current_value = sum(h['current_value'] or 0 for h in us_holdings if h['current_value'])
        us_realized = sum(float(h['realized_profit'] or 0) for h in us_holdings)
        us_unrealized = sum(h['unrealized_profit'] or 0 for h in us_holdings if h['unrealized_profit'])
        us_positions = len([h for h in us_holdings if h['total_shares'] > 0])
        
        # æ›ç®—æˆ TWD åŠ ç¸½
        total_invested_twd = tw_invested + (us_invested * exchange_rate)
        total_current_value_twd = tw_current_value + (us_current_value * exchange_rate)
        total_realized_twd = tw_realized + (us_realized * exchange_rate)
        total_unrealized_twd = tw_unrealized + (us_unrealized * exchange_rate)
        total_profit_twd = total_realized_twd + total_unrealized_twd
        
        # ç¸½å ±é…¬ç‡
        total_return_rate = None
        if total_invested_twd > 0:
            total_return_rate = (total_profit_twd / total_invested_twd) * 100
        
        # å°è‚¡å ±é…¬ç‡
        tw_return_rate = None
        if tw_invested > 0:
            tw_profit = tw_realized + tw_unrealized
            tw_return_rate = (tw_profit / tw_invested) * 100
        
        # ç¾è‚¡å ±é…¬ç‡
        us_return_rate = None
        if us_invested > 0:
            us_profit = us_realized + us_unrealized
            us_return_rate = (us_profit / us_invested) * 100
        
        return {
            # åŒ¯ç‡
            "exchange_rate": exchange_rate,
            "exchange_rate_updated_at": rate_updated_at,
            
            # å°è‚¡
            "tw": {
                "invested": tw_invested,
                "current_value": tw_current_value,
                "realized_profit": tw_realized,
                "unrealized_profit": tw_unrealized,
                "total_profit": tw_realized + tw_unrealized,
                "return_rate": tw_return_rate,
                "positions": tw_positions,
            },
            
            # ç¾è‚¡
            "us": {
                "invested": us_invested,
                "current_value": us_current_value,
                "realized_profit": us_realized,
                "unrealized_profit": us_unrealized,
                "total_profit": us_realized + us_unrealized,
                "return_rate": us_return_rate,
                "positions": us_positions,
            },
            
            # åŠ ç¸½ï¼ˆTWDï¼‰
            "total": {
                "invested_twd": total_invested_twd,
                "current_value_twd": total_current_value_twd,
                "realized_profit_twd": total_realized_twd,
                "unrealized_profit_twd": total_unrealized_twd,
                "total_profit_twd": total_profit_twd,
                "return_rate": total_return_rate,
                "positions": tw_positions + us_positions,
            },
        }
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/price_cache_service.py  â­â­â­
> åƒ¹æ ¼å¿«å–æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åƒ¹æ ¼å¿«å–æœå‹™
è² è²¬æ‰¹æ¬¡æ›´æ–°è¿½è¹¤è‚¡ç¥¨çš„å³æ™‚åƒ¹æ ¼

æ’ç¨‹é‚è¼¯ï¼š
- å°è‚¡é–‹ç›¤ (09:00-13:30)ï¼šæ¯ 10 åˆ†é˜æ›´æ–°å°è‚¡
- ç¾è‚¡é–‹ç›¤ (21:30-05:00)ï¼šæ¯ 10 åˆ†é˜æ›´æ–°ç¾è‚¡
- æ”¶ç›¤å¾Œï¼šä¸æ›´æ–°ï¼ˆä½¿ç”¨æ”¶ç›¤åƒ¹ï¼‰
- åŠ å¯†è²¨å¹£ï¼š24 å°æ™‚æ¯ 10 åˆ†é˜æ›´æ–°
"""
import logging
from datetime import datetime, time
from typing import Dict, List, Any
from sqlalchemy.orm import Session
from sqlalchemy import select, distinct
import yfinance as yf

from app.models.price_cache import StockPriceCache
from app.models.watchlist import Watchlist

logger = logging.getLogger(__name__)


# å°è‚¡åç¨±å°ç…§ï¼ˆå¸¸è¦‹çš„ï¼‰
TAIWAN_STOCK_NAMES = {
    # ===== æ¬Šå€¼è‚¡ =====
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    # ===== é‡‘èè‚¡ =====
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    "5876": "ä¸Šæµ·å•†éŠ€",
    # ===== é›»å­è‚¡ =====
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "2351": "é †å¾·",
    "2354": "é´»æº–",
    "2360": "è‡´èŒ‚",
    "2385": "ç¾¤å…‰",
    "2388": "å¨ç››",
    "2392": "æ­£å´´",
    "2401": "å‡Œé™½",
    "2402": "æ¯…å˜‰",
    # ===== èˆªé‹/å‚³ç”¢ =====
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    # ===== ç”ŸæŠ€ =====
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ===== ETF =====
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "0057": "å¯Œé‚¦æ‘©å°",
    "006205": "å¯Œé‚¦ä¸Šè­‰",
    "006206": "å…ƒå¤§ä¸Šè­‰50",
    "006208": "å¯Œé‚¦å°50",
    "00631L": "å…ƒå¤§å°ç£50æ­£2",
    "00632R": "å…ƒå¤§å°ç£50å1",
    "00635U": "å…ƒå¤§S&Pé»ƒé‡‘",
    "00636": "åœ‹æ³°ä¸­åœ‹A50",
    "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
    "00639": "å¯Œé‚¦æ·±100",
    "00642U": "å…ƒå¤§S&PçŸ³æ²¹",
    "00645": "å¯Œé‚¦æ—¥æœ¬",
    "00646": "å…ƒå¤§S&P500",
    "00647L": "å…ƒå¤§S&P500æ­£2",
    "00648R": "å…ƒå¤§S&P500å1",
    "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
    "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
    "00657": "åœ‹æ³°æ—¥ç¶“225",
    "00661": "å…ƒå¤§æ—¥ç¶“225",
    "00662": "å¯Œé‚¦NASDAQ",
    "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
    "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
    "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
    "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
    "00670L": "å¯Œé‚¦NASDAQæ­£2",
    "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
    "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
    "00677U": "å¯Œé‚¦VIX",
    "00678": "ç¾¤ç›ŠNBIç”ŸæŠ€",
    "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
    "00681R": "å…ƒå¤§ç¾å‚µ20å1",
    "00682U": "å…ƒå¤§ç¾å‚µ20å¹´",
    "00690": "å…†è±è—ç±Œ30",
    "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
    "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
    "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
    "00757": "çµ±ä¸€FANG+",
    "00762": "å…ƒå¤§å…¨çƒAI",
    "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00851": "å°æ–°å…¨çƒAI",
    "00852L": "åœ‹æ³°ç¾åœ‹è²»åŠæ­£2",
    "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
    "00876": "å…ƒå¤§å…¨çƒ5G",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00885": "å¯Œé‚¦è¶Šå—",
    "00886": "å…ƒå¤§å…¨çƒé›²ç«¯æœå‹™",
    "00887": "æ°¸è±å°ç£ESG",
    "00888": "æ°¸è±ç¾åœ‹è²»åŠ",
    "00889": "æ°¸è±å°ç£æ™ºèƒ½è»Š",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00896": "ä¸­ä¿¡ç¶ èƒ½é›»å‹•è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
    "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
    "00905": "FTè‡ºç£Smart",
    "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
    "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
    "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
    "00916": "åœ‹æ³°å…¨çƒå“ç‰Œ50",
    "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
    "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
    "00923": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
    "00931": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
    "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
    "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
    "00935": "é‡æ‘å°ç£æ–°ç§‘æŠ€50",
    "00936": "å°æ–°è‡ºç£ICè¨­è¨ˆ",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}



# ============================================================
# é–‹ç›¤æ™‚é–“åˆ¤æ–·ï¼ˆå°ç£æ™‚é–“ï¼‰
# ============================================================

def is_tw_market_open() -> bool:
    """åˆ¤æ–·å°è‚¡æ˜¯å¦é–‹ç›¤ï¼ˆé€±ä¸€åˆ°é€±äº” 09:00-13:30ï¼‰"""
    now = datetime.now()
    if now.weekday() >= 5:
        return False
    return time(9, 0) <= now.time() <= time(13, 30)


def is_us_market_open() -> bool:
    """åˆ¤æ–·ç¾è‚¡æ˜¯å¦é–‹ç›¤ï¼ˆå°ç£æ™‚é–“ 21:30-05:00ï¼‰"""
    now = datetime.now()
    weekday = now.weekday()
    current_time = now.time()
    
    # æ™šä¸Š 21:30 å¾Œï¼ˆé€±ä¸€åˆ°é€±äº”ï¼‰
    if weekday < 5 and current_time >= time(21, 30):
        return True
    # å‡Œæ™¨ 05:00 å‰ï¼ˆé€±äºŒåˆ°é€±å…­ï¼‰
    if weekday > 0 and current_time <= time(5, 0):
        return True
    # é€±å…­å‡Œæ™¨
    if weekday == 5 and current_time <= time(5, 0):
        return True
    return False


def get_market_status() -> Dict[str, bool]:
    """å–å¾—å„å¸‚å ´é–‹ç›¤ç‹€æ…‹"""
    return {
        "tw_open": is_tw_market_open(),
        "us_open": is_us_market_open(),
        "crypto_open": True,
    }


# ============================================================
# åƒ¹æ ¼å¿«å–æœå‹™
# ============================================================

class PriceCacheService:
    """åƒ¹æ ¼å¿«å–æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_all_tracked_symbols(self) -> Dict[str, List[str]]:
        """å–å¾—æ‰€æœ‰è¢«è¿½è¹¤çš„ symbolï¼ˆå»é‡ï¼ŒæŒ‰å¸‚å ´åˆ†é¡ï¼‰"""
        stmt = select(distinct(Watchlist.symbol), Watchlist.asset_type)
        results = self.db.execute(stmt).all()
        
        tw_stocks = []
        us_stocks = []
        crypto = []
        
        for symbol, asset_type in results:
            if asset_type == "crypto":
                crypto.append(symbol)
            elif symbol.endswith((".TW", ".TWO")):
                tw_stocks.append(symbol)
            else:
                us_stocks.append(symbol)
        
        logger.info(f"è¿½è¹¤: å°è‚¡ {len(tw_stocks)}, ç¾è‚¡ {len(us_stocks)}, åŠ å¯†è²¨å¹£ {len(crypto)}")
        return {"tw_stocks": tw_stocks, "us_stocks": us_stocks, "crypto": crypto}
    
    def batch_update_stock_prices(self, symbols: List[str]) -> Dict[str, Any]:
        """æ‰¹æ¬¡æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼ï¼ˆå« MA20ï¼‰"""
        if not symbols:
            return {"updated": 0, "failed": []}
        
        result = {"updated": 0, "failed": []}
        logger.info(f"é–‹å§‹æ›´æ–° {len(symbols)} æ”¯è‚¡ç¥¨...")
        
        try:
            # ä½¿ç”¨ yfinance æ‰¹æ¬¡å–å¾—
            tickers = yf.Tickers(" ".join(symbols))
            
            for symbol in symbols:
                try:
                    ticker = tickers.tickers.get(symbol)
                    if not ticker:
                        result["failed"].append(symbol)
                        continue
                    
                    # ğŸ†• å–å¾—æ­·å²æ•¸æ“šï¼ˆç”¨æ–¼è¨ˆç®— MA20ï¼‰
                    hist = ticker.history(period="1mo")
                    
                    if hist.empty:
                        # å˜—è©¦ç”¨ info
                        info = ticker.info
                        if not info:
                            result["failed"].append(symbol)
                            continue
                        
                        price = info.get("regularMarketPrice") or info.get("currentPrice")
                        prev_close = info.get("regularMarketPreviousClose") or info.get("previousClose")
                        volume = info.get("regularMarketVolume") or info.get("volume")
                        name = info.get("shortName") or info.get("longName") or ""
                        ma20 = None
                    else:
                        # å¾æ­·å²æ•¸æ“šå–å¾—
                        price = float(hist['Close'].iloc[-1])
                        prev_close = float(hist['Close'].iloc[-2]) if len(hist) > 1 else None
                        volume = int(hist['Volume'].iloc[-1]) if 'Volume' in hist.columns else None
                        
                        # ğŸ†• è¨ˆç®— MA20
                        ma20 = None
                        if len(hist) >= 20:
                            ma20 = float(hist['Close'].tail(20).mean())
                        
                        # å–å¾—åç¨±
                        info = ticker.info
                        name = ""
                        if info:
                            name = info.get("shortName") or info.get("longName") or ""
                    
                    if price is None:
                        result["failed"].append(symbol)
                        continue
                    
                    # å°è‚¡åç¨±
                    if not name and symbol.endswith((".TW", ".TWO")):
                        stock_code = symbol.replace(".TW", "").replace(".TWO", "")
                        name = TAIWAN_STOCK_NAMES.get(stock_code, "")
                    
                    # è¨ˆç®—æ¼²è·Œ
                    change = None
                    change_pct = None
                    if prev_close and prev_close > 0:
                        change = price - prev_close
                        change_pct = (change / prev_close) * 100
                    
                    # æ›´æ–°å¿«å–ï¼ˆå« MA20ï¼‰
                    self._upsert_cache(
                        symbol=symbol,
                        name=name,
                        price=price,
                        prev_close=prev_close,
                        change=change,
                        change_pct=change_pct,
                        volume=volume,
                        asset_type="stock",
                        ma20=ma20,
                    )
                    result["updated"] += 1
                    
                except Exception as e:
                    logger.error(f"æ›´æ–° {symbol} å¤±æ•—: {e}")
                    result["failed"].append(symbol)
            
            self.db.commit()
            logger.info(f"è‚¡ç¥¨æ›´æ–°å®Œæˆ: æˆåŠŸ {result['updated']}, å¤±æ•— {len(result['failed'])}")
            
        except Exception as e:
            logger.error(f"æ‰¹æ¬¡æ›´æ–°å¤±æ•—: {e}")
        
        return result
    
    def batch_update_crypto_prices(self, symbols: List[str]) -> Dict[str, Any]:
        """æ‰¹æ¬¡æ›´æ–°åŠ å¯†è²¨å¹£åƒ¹æ ¼"""
        if not symbols:
            return {"updated": 0, "failed": []}
        
        result = {"updated": 0, "failed": []}
        
        try:
            from app.data_sources.coingecko import coingecko
            
            for symbol in symbols:
                try:
                    data = coingecko.get_price(symbol)
                    if not data or data.get("price") is None:
                        result["failed"].append(symbol)
                        continue
                    
                    self._upsert_cache(
                        symbol=symbol,
                        name=data.get("name", symbol),
                        price=data["price"],
                        prev_close=None,
                        change=None,
                        change_pct=data.get("change_24h"),
                        volume=data.get("volume_24h"),
                        asset_type="crypto",
                        ma20=None,  # åŠ å¯†è²¨å¹£ä¸è¨ˆç®— MA20
                    )
                    result["updated"] += 1
                    
                except Exception as e:
                    logger.error(f"æ›´æ–° {symbol} å¤±æ•—: {e}")
                    result["failed"].append(symbol)
            
            self.db.commit()
            
        except Exception as e:
            logger.error(f"åŠ å¯†è²¨å¹£æ›´æ–°å¤±æ•—: {e}")
        
        return result
    
    def _upsert_cache(self, symbol, name, price, prev_close, change, change_pct, volume, asset_type, ma20=None):
        """æ›´æ–°æˆ–æ–°å¢å¿«å–ï¼ˆå« MA20ï¼‰"""
        cache = self.db.query(StockPriceCache).filter(
            StockPriceCache.symbol == symbol
        ).first()
        
        if cache:
            cache.name = name or cache.name
            cache.price = price
            cache.prev_close = prev_close
            cache.change = change
            cache.change_pct = change_pct
            cache.volume = volume
            if ma20 is not None:
                cache.ma20 = ma20
            cache.updated_at = datetime.now()
        else:
            cache = StockPriceCache(
                symbol=symbol,
                name=name,
                price=price,
                prev_close=prev_close,
                change=change,
                change_pct=change_pct,
                ma20=ma20,
                volume=volume,
                asset_type=asset_type,
            )
            self.db.add(cache)
    
    # ============================================================
    # ğŸ†• æŸ¥è©¢å¿«å–ï¼ˆä¾› stock.py API ä½¿ç”¨ï¼‰
    # ============================================================
    
    def get_cached_price(self, symbol: str, max_age_minutes: int = 5) -> dict:
        """
        å¾å¿«å–å–å¾—è‚¡ç¥¨åƒ¹æ ¼ï¼ˆ5 åˆ†é˜æœ‰æ•ˆï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            max_age_minutes: å¿«å–æœ‰æ•ˆæœŸï¼ˆåˆ†é˜ï¼‰ï¼Œé è¨­ 5 åˆ†é˜
            
        Returns:
            å¿«å–è³‡æ–™ dict æˆ– Noneï¼ˆç„¡å¿«å–æˆ–å·²éæœŸï¼‰
        """
        from datetime import timedelta
        
        cache = self.db.query(StockPriceCache).filter(
            StockPriceCache.symbol == symbol.upper()
        ).first()
        
        if not cache:
            logger.debug(f"å¿«å–æœªå‘½ä¸­: {symbol}")
            return None
        
        # æª¢æŸ¥æ˜¯å¦éæœŸ
        if cache.updated_at:
            age = datetime.now() - cache.updated_at
            if age > timedelta(minutes=max_age_minutes):
                logger.info(f"å¿«å–éæœŸ: {symbol} (å·² {age.total_seconds()/60:.1f} åˆ†é˜)")
                return None
        
        logger.info(f"ğŸ“¦ å¿«å–å‘½ä¸­: {symbol}")
        return {
            "symbol": cache.symbol,
            "name": cache.name,
            "price": float(cache.price) if cache.price else None,
            "prev_close": float(cache.prev_close) if cache.prev_close else None,
            "change": float(cache.change) if cache.change else None,
            "change_pct": float(cache.change_pct) if cache.change_pct else None,
            "volume": int(cache.volume) if cache.volume else None,
            "ma20": float(cache.ma20) if cache.ma20 else None,
            "updated_at": cache.updated_at.isoformat() if cache.updated_at else None,
        }
    
    def update_all(self, force: bool = False) -> Dict[str, Any]:
        """
        æ›´æ–°æ‰€æœ‰è¿½è¹¤çš„åƒ¹æ ¼
        
        - force=True: å¼·åˆ¶æ›´æ–°æ‰€æœ‰
        - force=False: åªæ›´æ–°é–‹ç›¤ä¸­çš„å¸‚å ´
        """
        logger.info("=" * 40)
        logger.info(f"é–‹å§‹æ›´æ–°åƒ¹æ ¼å¿«å– (force={force})")
        logger.info(f"æ™‚é–“: {datetime.now()}")
        
        tw_open = is_tw_market_open()
        us_open = is_us_market_open()
        logger.info(f"å°è‚¡: {'é–‹ç›¤' if tw_open else 'æ”¶ç›¤'}, ç¾è‚¡: {'é–‹ç›¤' if us_open else 'æ”¶ç›¤'}")
        logger.info("=" * 40)
        
        tracked = self.get_all_tracked_symbols()
        
        result = {
            "tw_stocks": {"updated": 0, "failed": [], "skipped": False},
            "us_stocks": {"updated": 0, "failed": [], "skipped": False},
            "crypto": {"updated": 0, "failed": []},
            "timestamp": datetime.now().isoformat(),
        }
        
        # å°è‚¡
        if force or tw_open:
            if tracked["tw_stocks"]:
                result["tw_stocks"] = self.batch_update_stock_prices(tracked["tw_stocks"])
        else:
            result["tw_stocks"]["skipped"] = True
        
        # ç¾è‚¡
        if force or us_open:
            if tracked["us_stocks"]:
                result["us_stocks"] = self.batch_update_stock_prices(tracked["us_stocks"])
        else:
            result["us_stocks"]["skipped"] = True
        
        # åŠ å¯†è²¨å¹£ï¼ˆ24å°æ™‚ï¼‰
        if tracked["crypto"]:
            result["crypto"] = self.batch_update_crypto_prices(tracked["crypto"])
        
        result["total_updated"] = (
            result["tw_stocks"].get("updated", 0) +
            result["us_stocks"].get("updated", 0) +
            result["crypto"].get("updated", 0)
        )
        
        logger.info(f"æ›´æ–°å®Œæˆ: å…± {result['total_updated']} ç­†")
        return result
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/rss_fetcher.py  â­â­â­
> è¨‚é–±æºçˆ¬èŸ²æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨‚é–±æºçˆ¬èŸ²æœå‹™
è² è²¬æŠ“å– RSS feed ä¸¦è§£æè‚¡ç¥¨ä»£ç¢¼
"""
import re
import logging
import feedparser
from datetime import datetime, timedelta
from typing import List, Dict, Set, Optional
from bs4 import BeautifulSoup
import requests

logger = logging.getLogger(__name__)

# å¸¸è¦‹è‹±æ–‡è©å½™ï¼Œæ’é™¤é€™äº›ï¼ˆä¸æ˜¯è‚¡ç¥¨ä»£ç¢¼ï¼‰
COMMON_WORDS = {
    # å¸¸è¦‹è©
    'THE', 'AND', 'FOR', 'ARE', 'BUT', 'NOT', 'YOU', 'ALL', 'CAN', 'HAD',
    'HER', 'WAS', 'ONE', 'OUR', 'OUT', 'HAS', 'HIS', 'HOW', 'ITS', 'MAY',
    'NEW', 'NOW', 'OLD', 'SEE', 'WAY', 'WHO', 'BOY', 'DID', 'GET', 'HIM',
    'LET', 'PUT', 'SAY', 'SHE', 'TOO', 'USE', 'DAY', 'HAS', 'HIM', 'HIS',
    # é‡‘èç›¸é—œå¸¸è¦‹è©
    'ETF', 'IPO', 'CEO', 'CFO', 'COO', 'NYSE', 'SEC', 'FED', 'GDP', 'CPI',
    'EPS', 'ROE', 'ROA', 'DCF', 'ATH', 'ATL', 'YOY', 'QOQ', 'MOM', 'TTM',
    'USA', 'USD', 'EUR', 'GBP', 'JPY', 'CNY', 'TWD',
    # å…¶ä»–
    'AI', 'API', 'AWS', 'CEO', 'CTO', 'FAQ', 'CEO', 'PDF', 'URL', 'RSS',
    'BUY', 'SELL', 'HOLD', 'LONG', 'SHORT',
    # æœˆä»½/æ˜ŸæœŸ
    'JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC',
    'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN',
}

# å·²çŸ¥çš„æœ‰æ•ˆç¾è‚¡ä»£ç¢¼æ¨¡å¼ï¼ˆå¯é¸ï¼šå¢åŠ ç™½åå–®ï¼‰
KNOWN_SYMBOLS = {
    'AAPL', 'MSFT', 'GOOGL', 'GOOG', 'AMZN', 'NVDA', 'META', 'TSLA',
    'BRK', 'UNH', 'JNJ', 'V', 'XOM', 'WMT', 'JPM', 'MA', 'PG', 'HD',
    'CVX', 'MRK', 'ABBV', 'LLY', 'PFE', 'KO', 'PEP', 'COST', 'TMO',
    'AVGO', 'MCD', 'CSCO', 'ACN', 'ABT', 'DHR', 'NKE', 'TXN', 'NEE',
    'PM', 'UNP', 'RTX', 'HON', 'LOW', 'IBM', 'ORCL', 'AMD', 'INTC',
    'QCOM', 'SPGI', 'CAT', 'GE', 'BA', 'SBUX', 'INTU', 'AMAT', 'GS',
    'BLK', 'DE', 'MDLZ', 'AXP', 'ADI', 'ISRG', 'GILD', 'VRTX', 'REGN',
    'BKNG', 'SYK', 'MMC', 'ZTS', 'LRCX', 'ETN', 'CB', 'CI', 'SO',
    'DUK', 'CME', 'PLD', 'BSX', 'CL', 'MO', 'AON', 'APD', 'ICE',
    'SCHW', 'SHW', 'NOC', 'FIS', 'EQIX', 'NSC', 'FCX', 'MCK', 'EMR',
    'PNC', 'GM', 'F', 'RIVN', 'LCID', 'NIO', 'XPEV', 'LI',
    'PLTR', 'SNOW', 'NET', 'DDOG', 'ZS', 'CRWD', 'PANW', 'OKTA',
    'SQ', 'SHOP', 'PYPL', 'COIN', 'HOOD', 'SOFI', 'UPST', 'AFRM',
    'RBLX', 'U', 'TTWO', 'EA', 'ATVI', 'NFLX', 'DIS', 'PARA', 'WBD',
    'ABNB', 'UBER', 'LYFT', 'DASH', 'GRAB', 'SE',
    'ARM', 'SMCI', 'DELL', 'HPQ', 'HPE',
    'CCJ', 'VST', 'LENZ', 'GOOS', 'CAVA', 'QS', 'ONDS',
    # æ›´å¤šå¯ä»¥æŒçºŒæ·»åŠ ...
}


class RSSFetcher:
    """RSS çˆ¬èŸ²"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
    
    def fetch_feed(self, url: str, since_date: datetime = None) -> List[Dict]:
        """
        æŠ“å– RSS feed
        
        Args:
            url: RSS feed URL
            since_date: åªæŠ“å–æ­¤æ—¥æœŸä¹‹å¾Œçš„æ–‡ç« 
        
        Returns:
            æ–‡ç« åˆ—è¡¨ [{title, link, published, content}, ...]
        """
        logger.info(f"æŠ“å– RSS: {url}")
        
        try:
            feed = feedparser.parse(url)
            
            if feed.bozo and feed.bozo_exception:
                logger.warning(f"RSS è§£æè­¦å‘Š: {feed.bozo_exception}")
            
            articles = []
            for entry in feed.entries:
                # è§£æç™¼å¸ƒæ—¥æœŸ
                published = None
                if hasattr(entry, 'published_parsed') and entry.published_parsed:
                    published = datetime(*entry.published_parsed[:6])
                elif hasattr(entry, 'updated_parsed') and entry.updated_parsed:
                    published = datetime(*entry.updated_parsed[:6])
                
                # éæ¿¾æ—¥æœŸ
                if since_date and published and published < since_date:
                    continue
                
                # å–å¾—å…§å®¹
                content = ""
                if hasattr(entry, 'content') and entry.content:
                    content = entry.content[0].value
                elif hasattr(entry, 'summary'):
                    content = entry.summary
                
                articles.append({
                    'title': entry.get('title', ''),
                    'link': entry.get('link', ''),
                    'published': published,
                    'content': content,
                })
            
            logger.info(f"å–å¾— {len(articles)} ç¯‡æ–‡ç« ")
            return articles
            
        except Exception as e:
            logger.error(f"æŠ“å– RSS å¤±æ•—: {e}")
            return []
    
    def extract_symbols(self, text: str) -> Set[str]:
        """
        å¾æ–‡ç« å…§å®¹æå–è‚¡ç¥¨ä»£ç¢¼
        
        è¦å‰‡ï¼š
        - 1-5 å€‹å¤§å¯«å­—æ¯
        - æ’é™¤å¸¸è¦‹è‹±æ–‡è©
        - å¸¸è¦‹æ ¼å¼ï¼š$AAPL, (AAPL), AAPL:
        """
        if not text:
            return set()
        
        # ç§»é™¤ HTML æ¨™ç±¤
        soup = BeautifulSoup(text, 'html.parser')
        clean_text = soup.get_text()
        
        symbols = set()
        
        # æ¨¡å¼ 1: $AAPL æ ¼å¼ï¼ˆé«˜å¯ä¿¡åº¦ï¼‰
        dollar_pattern = r'\$([A-Z]{1,5})\b'
        for match in re.findall(dollar_pattern, clean_text):
            if match not in COMMON_WORDS:
                symbols.add(match)
        
        # æ¨¡å¼ 2: (AAPL) æ‹¬è™Ÿæ ¼å¼ï¼ˆé«˜å¯ä¿¡åº¦ï¼‰
        paren_pattern = r'\(([A-Z]{1,5})\)'
        for match in re.findall(paren_pattern, clean_text):
            if match not in COMMON_WORDS:
                symbols.add(match)
        
        # æ¨¡å¼ 3: ç¨ç«‹çš„ 1-5 å¤§å¯«å­—æ¯ï¼ˆéœ€é¡å¤–éæ¿¾ï¼‰
        # åªæŠ“å·²çŸ¥çš„è‚¡ç¥¨ä»£ç¢¼ï¼Œé¿å…èª¤åˆ¤
        word_pattern = r'\b([A-Z]{1,5})\b'
        for match in re.findall(word_pattern, clean_text):
            if match in KNOWN_SYMBOLS:
                symbols.add(match)
        
        return symbols
    
    def fetch_and_parse(self, url: str, since_date: datetime = None) -> List[Dict]:
        """
        æŠ“å–ä¸¦è§£æï¼Œå›å‚³è‚¡ç¥¨ä»£ç¢¼åˆ—è¡¨
        
        Returns:
            [{symbol, article_url, article_title, article_date}, ...]
        """
        articles = self.fetch_feed(url, since_date)
        
        results = []
        for article in articles:
            symbols = self.extract_symbols(article['content'])
            # æ¨™é¡Œä¹Ÿæ‰¾ä¸€ä¸‹
            symbols.update(self.extract_symbols(article['title']))
            
            for symbol in symbols:
                results.append({
                    'symbol': symbol,
                    'article_url': article['link'],
                    'article_title': article['title'],
                    'article_date': article['published'].date() if article['published'] else None,
                })
        
        logger.info(f"è§£æå‡º {len(results)} å€‹è‚¡ç¥¨æåŠ")
        return results


# å–®ä¾‹
rss_fetcher = RSSFetcher()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/signal_service.py  â­â­â­
> è¨Šè™Ÿåµæ¸¬æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨Šè™Ÿåµæ¸¬æœå‹™
åµæ¸¬æŠ€è¡“æŒ‡æ¨™è¨Šè™Ÿï¼ˆé»ƒé‡‘äº¤å‰ã€æ­»äº¡äº¤å‰ã€è¶…è²·è¶…è³£ç­‰ï¼‰
"""
import logging
from datetime import datetime, date, timedelta
from typing import Dict, List, Any, Optional, Tuple
from dataclasses import dataclass
from enum import Enum

logger = logging.getLogger(__name__)


class SignalType(str, Enum):
    """è¨Šè™Ÿé¡å‹"""
    # å‡ç·š
    MA_GOLDEN_CROSS = "ma_golden_cross"
    MA_DEATH_CROSS = "ma_death_cross"
    APPROACHING_BREAKOUT = "approaching_breakout"
    APPROACHING_BREAKDOWN = "approaching_breakdown"
    BREAKOUT = "breakout"
    BREAKDOWN = "breakdown"
    
    # RSI
    RSI_OVERBOUGHT = "rsi_overbought"
    RSI_OVERSOLD = "rsi_oversold"
    
    # MACD
    MACD_GOLDEN_CROSS = "macd_golden_cross"
    MACD_DEATH_CROSS = "macd_death_cross"
    
    # KD
    KD_GOLDEN_CROSS = "kd_golden_cross"
    KD_DEATH_CROSS = "kd_death_cross"
    
    # å¸ƒæ—é€šé“
    BOLLINGER_BREAKOUT = "bollinger_breakout"
    BOLLINGER_BREAKDOWN = "bollinger_breakdown"
    
    # æˆäº¤é‡
    VOLUME_SURGE = "volume_surge"
    
    # å¸‚å ´æƒ…ç·’
    SENTIMENT_EXTREME_FEAR = "sentiment_extreme_fear"
    SENTIMENT_EXTREME_GREED = "sentiment_extreme_greed"


@dataclass
class Signal:
    """è¨Šè™Ÿè³‡æ–™"""
    symbol: str
    asset_type: str  # stock / crypto
    signal_type: SignalType
    indicator: str
    message: str
    price: float
    details: Dict[str, Any]
    timestamp: datetime


class SignalService:
    """è¨Šè™Ÿåµæ¸¬æœå‹™"""
    
    # è¨Šè™Ÿé¡å‹ä¸­æ–‡å°ç…§
    SIGNAL_NAMES = {
        SignalType.MA_GOLDEN_CROSS: "å‡ç·šé»ƒé‡‘äº¤å‰",
        SignalType.MA_DEATH_CROSS: "å‡ç·šæ­»äº¡äº¤å‰",
        SignalType.APPROACHING_BREAKOUT: "æ¥è¿‘å‘ä¸Šçªç ´",
        SignalType.APPROACHING_BREAKDOWN: "æ¥è¿‘å‘ä¸‹è·Œç ´",
        SignalType.BREAKOUT: "å‘ä¸Šçªç ´",
        SignalType.BREAKDOWN: "å‘ä¸‹è·Œç ´",
        SignalType.RSI_OVERBOUGHT: "RSI è¶…è²·",
        SignalType.RSI_OVERSOLD: "RSI è¶…è³£",
        SignalType.MACD_GOLDEN_CROSS: "MACD é»ƒé‡‘äº¤å‰",
        SignalType.MACD_DEATH_CROSS: "MACD æ­»äº¡äº¤å‰",
        SignalType.KD_GOLDEN_CROSS: "KD é»ƒé‡‘äº¤å‰",
        SignalType.KD_DEATH_CROSS: "KD æ­»äº¡äº¤å‰",
        SignalType.BOLLINGER_BREAKOUT: "çªç ´å¸ƒæ—ä¸Šè»Œ",
        SignalType.BOLLINGER_BREAKDOWN: "è·Œç ´å¸ƒæ—ä¸‹è»Œ",
        SignalType.VOLUME_SURGE: "æˆäº¤é‡æš´å¢",
        SignalType.SENTIMENT_EXTREME_FEAR: "æ¥µåº¦ææ‡¼",
        SignalType.SENTIMENT_EXTREME_GREED: "æ¥µåº¦è²ªå©ª",
    }
    
    # è¨Šè™Ÿ Emoji
    SIGNAL_EMOJI = {
        SignalType.MA_GOLDEN_CROSS: "ğŸŸ¢",
        SignalType.MA_DEATH_CROSS: "ğŸ”´",
        SignalType.APPROACHING_BREAKOUT: "â¬†ï¸",
        SignalType.APPROACHING_BREAKDOWN: "â¬‡ï¸",
        SignalType.BREAKOUT: "âœ…",
        SignalType.BREAKDOWN: "âŒ",
        SignalType.RSI_OVERBOUGHT: "âš ï¸",
        SignalType.RSI_OVERSOLD: "ğŸŸ¢",
        SignalType.MACD_GOLDEN_CROSS: "ğŸŸ¢",
        SignalType.MACD_DEATH_CROSS: "ğŸ”´",
        SignalType.KD_GOLDEN_CROSS: "ğŸŸ¢",
        SignalType.KD_DEATH_CROSS: "ğŸ”´",
        SignalType.BOLLINGER_BREAKOUT: "ğŸ“ˆ",
        SignalType.BOLLINGER_BREAKDOWN: "ğŸ“‰",
        SignalType.VOLUME_SURGE: "ğŸ“Š",
        SignalType.SENTIMENT_EXTREME_FEAR: "ğŸ˜±",
        SignalType.SENTIMENT_EXTREME_GREED: "ğŸ¤‘",
    }
    
    def __init__(self):
        # é è¨­åƒæ•¸ï¼ˆå¯è¢«ç”¨æˆ¶è¨­å®šè¦†è“‹ï¼‰
        self.default_params = {
            "ma_short": 20,
            "ma_mid": 50,
            "ma_long": 200,
            "rsi_period": 14,
            "rsi_overbought": 70,
            "rsi_oversold": 30,
            "macd_fast": 12,
            "macd_slow": 26,
            "macd_signal": 9,
            "kd_period": 9,
            "bollinger_period": 20,
            "bollinger_std": 2.0,
            "breakout_threshold": 2.0,  # æ¥è¿‘çªç ´é–€æª» (%)
            "volume_alert_ratio": 2.0,  # é‡æ¯”è­¦æˆ’å€æ•¸
        }
    
    def detect_signals(
        self, 
        symbol: str, 
        indicators: Dict[str, Any],
        asset_type: str = "stock",
        params: Optional[Dict] = None
    ) -> List[Signal]:
        """
        åµæ¸¬è‚¡ç¥¨/åŠ å¯†è²¨å¹£çš„æŠ€è¡“æŒ‡æ¨™è¨Šè™Ÿ
        
        Args:
            symbol: è‚¡ç¥¨/å¹£ç¨®ä»£è™Ÿ
            indicators: æŠ€è¡“æŒ‡æ¨™è³‡æ–™ï¼ˆä¾†è‡ª indicator_serviceï¼‰
            asset_type: stock / crypto
            params: ç”¨æˆ¶è‡ªè¨‚åƒæ•¸ï¼ˆå¯é¸ï¼‰
            
        Returns:
            åµæ¸¬åˆ°çš„è¨Šè™Ÿåˆ—è¡¨
        """
        signals = []
        p = {**self.default_params, **(params or {})}
        
        current_price = indicators.get("current_price", 0)
        if not current_price:
            logger.warning(f"{symbol} ç„¡æ³•å–å¾—ç¾åƒ¹")
            return signals
        
        now = datetime.now()
        
        # 1. å‡ç·šè¨Šè™Ÿ
        ma_signals = self._detect_ma_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(ma_signals)
        
        # 2. RSI è¨Šè™Ÿ
        rsi_signals = self._detect_rsi_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(rsi_signals)
        
        # 3. MACD è¨Šè™Ÿ
        macd_signals = self._detect_macd_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(macd_signals)
        
        # 4. KD è¨Šè™Ÿ
        kd_signals = self._detect_kd_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(kd_signals)
        
        # 5. å¸ƒæ—é€šé“è¨Šè™Ÿ
        bb_signals = self._detect_bollinger_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(bb_signals)
        
        # 6. æˆäº¤é‡è¨Šè™Ÿ
        vol_signals = self._detect_volume_signals(symbol, indicators, current_price, p, now, asset_type)
        signals.extend(vol_signals)
        
        logger.info(f"{symbol} åµæ¸¬åˆ° {len(signals)} å€‹è¨Šè™Ÿ")
        return signals
    
    def _detect_ma_signals(
        self, symbol: str, indicators: Dict, price: float, 
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬å‡ç·šè¨Šè™Ÿ"""
        signals = []
        ma = indicators.get("ma", {})
        
        if not ma:
            return signals
        
        ma20 = ma.get("ma20")
        ma50 = ma.get("ma50")
        ma200 = ma.get("ma200")
        
        # å‡ç·šäº¤å‰ï¼ˆéœ€è¦æœ‰å‰ä¸€æ—¥è³‡æ–™æ‰èƒ½åˆ¤æ–·ï¼Œé€™è£¡ç°¡åŒ–ç‚ºæª¢æŸ¥ç•¶å‰ç‹€æ…‹ï¼‰
        # å¯¦éš›ä¸Šéœ€è¦æ¯”è¼ƒæ˜¨æ—¥å’Œä»Šæ—¥çš„ MA å€¼
        
        # æ¥è¿‘çªç ´/è·Œç ´æª¢æ¸¬
        threshold_pct = params["breakout_threshold"] / 100
        
        for ma_name, ma_value in [("MA20", ma20), ("MA50", ma50), ("MA200", ma200)]:
            if ma_value is None or ma_value <= 0:
                continue
            
            diff_pct = (price - ma_value) / ma_value
            
            # æ¥è¿‘å‘ä¸Šçªç ´ï¼ˆåƒ¹æ ¼åœ¨å‡ç·šä¸‹æ–¹ï¼Œå·®è·å°æ–¼é–€æª»ï¼‰
            if -threshold_pct < diff_pct < 0:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.APPROACHING_BREAKOUT,
                    indicator=ma_name,
                    message=f"{symbol} æ¥è¿‘çªç ´ {ma_name} ({ma_value:.2f})ï¼Œå·®è· {abs(diff_pct)*100:.1f}%",
                    price=price,
                    details={"ma_name": ma_name, "ma_value": ma_value, "diff_pct": diff_pct},
                    timestamp=now,
                ))
            
            # æ¥è¿‘å‘ä¸‹è·Œç ´ï¼ˆåƒ¹æ ¼åœ¨å‡ç·šä¸Šæ–¹ï¼Œå·®è·å°æ–¼é–€æª»ï¼‰
            elif 0 < diff_pct < threshold_pct:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.APPROACHING_BREAKDOWN,
                    indicator=ma_name,
                    message=f"{symbol} æ¥è¿‘è·Œç ´ {ma_name} ({ma_value:.2f})ï¼Œå·®è· {diff_pct*100:.1f}%",
                    price=price,
                    details={"ma_name": ma_name, "ma_value": ma_value, "diff_pct": diff_pct},
                    timestamp=now,
                ))
        
        # é»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰ï¼ˆMA20 vs MA50ï¼‰
        if ma20 and ma50:
            cross_info = ma.get("cross_info", {})
            if cross_info.get("type") == "golden_cross" and cross_info.get("days_ago", 999) <= 3:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.MA_GOLDEN_CROSS,
                    indicator="MA20/MA50",
                    message=f"{symbol} MA20 é»ƒé‡‘äº¤å‰ MA50",
                    price=price,
                    details={"ma20": ma20, "ma50": ma50},
                    timestamp=now,
                ))
            elif cross_info.get("type") == "death_cross" and cross_info.get("days_ago", 999) <= 3:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type=asset_type,
                    signal_type=SignalType.MA_DEATH_CROSS,
                    indicator="MA20/MA50",
                    message=f"{symbol} MA20 æ­»äº¡äº¤å‰ MA50",
                    price=price,
                    details={"ma20": ma20, "ma50": ma50},
                    timestamp=now,
                ))
        
        return signals
    
    def _detect_rsi_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬ RSI è¨Šè™Ÿ"""
        signals = []
        rsi_data = indicators.get("rsi", {})
        
        if not rsi_data:
            return signals
        
        rsi_value = rsi_data.get("value")
        if rsi_value is None:
            return signals
        
        overbought = params["rsi_overbought"]
        oversold = params["rsi_oversold"]
        
        if rsi_value >= overbought:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.RSI_OVERBOUGHT,
                indicator="RSI",
                message=f"{symbol} RSI é” {rsi_value:.1f}ï¼Œé€²å…¥è¶…è²·å€",
                price=price,
                details={"rsi": rsi_value, "threshold": overbought},
                timestamp=now,
            ))
        elif rsi_value <= oversold:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.RSI_OVERSOLD,
                indicator="RSI",
                message=f"{symbol} RSI è·Œè‡³ {rsi_value:.1f}ï¼Œé€²å…¥è¶…è³£å€",
                price=price,
                details={"rsi": rsi_value, "threshold": oversold},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_macd_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬ MACD è¨Šè™Ÿ"""
        signals = []
        macd_data = indicators.get("macd", {})
        
        if not macd_data:
            return signals
        
        dif = macd_data.get("dif")
        macd = macd_data.get("macd")
        histogram = macd_data.get("histogram")
        status = macd_data.get("status", "")
        
        # æ ¹æ“š status åˆ¤æ–·ï¼ˆindicator_service å·²ç¶“è¨ˆç®—å¥½ï¼‰
        if "golden_cross" in status.lower() or status == "bullish_cross":
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.MACD_GOLDEN_CROSS,
                indicator="MACD",
                message=f"{symbol} MACD é»ƒé‡‘äº¤å‰",
                price=price,
                details={"dif": dif, "macd": macd, "histogram": histogram},
                timestamp=now,
            ))
        elif "death_cross" in status.lower() or status == "bearish_cross":
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.MACD_DEATH_CROSS,
                indicator="MACD",
                message=f"{symbol} MACD æ­»äº¡äº¤å‰",
                price=price,
                details={"dif": dif, "macd": macd, "histogram": histogram},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_kd_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬ KD è¨Šè™Ÿ"""
        signals = []
        kd_data = indicators.get("kd", {})
        
        if not kd_data:
            return signals
        
        k = kd_data.get("k")
        d = kd_data.get("d")
        status = kd_data.get("status", "")
        
        # KD äº¤å‰
        if "golden" in status.lower():
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.KD_GOLDEN_CROSS,
                indicator="KD",
                message=f"{symbol} KD é»ƒé‡‘äº¤å‰ (K={k:.1f}, D={d:.1f})",
                price=price,
                details={"k": k, "d": d},
                timestamp=now,
            ))
        elif "death" in status.lower():
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.KD_DEATH_CROSS,
                indicator="KD",
                message=f"{symbol} KD æ­»äº¡äº¤å‰ (K={k:.1f}, D={d:.1f})",
                price=price,
                details={"k": k, "d": d},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_bollinger_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬å¸ƒæ—é€šé“è¨Šè™Ÿ"""
        signals = []
        bb_data = indicators.get("bollinger", {})
        
        if not bb_data:
            return signals
        
        upper = bb_data.get("upper")
        lower = bb_data.get("lower")
        position = bb_data.get("position", "")
        
        if upper and price >= upper:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.BOLLINGER_BREAKOUT,
                indicator="Bollinger",
                message=f"{symbol} çªç ´å¸ƒæ—ä¸Šè»Œ ({upper:.2f})",
                price=price,
                details={"upper": upper, "lower": lower, "price": price},
                timestamp=now,
            ))
        elif lower and price <= lower:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.BOLLINGER_BREAKDOWN,
                indicator="Bollinger",
                message=f"{symbol} è·Œç ´å¸ƒæ—ä¸‹è»Œ ({lower:.2f})",
                price=price,
                details={"upper": upper, "lower": lower, "price": price},
                timestamp=now,
            ))
        
        return signals
    
    def _detect_volume_signals(
        self, symbol: str, indicators: Dict, price: float,
        params: Dict, now: datetime, asset_type: str
    ) -> List[Signal]:
        """åµæ¸¬æˆäº¤é‡è¨Šè™Ÿ"""
        signals = []
        vol_data = indicators.get("volume", {})
        
        if not vol_data:
            return signals
        
        ratio = vol_data.get("ratio")
        alert_ratio = params["volume_alert_ratio"]
        
        if ratio and ratio >= alert_ratio:
            signals.append(Signal(
                symbol=symbol,
                asset_type=asset_type,
                signal_type=SignalType.VOLUME_SURGE,
                indicator="Volume",
                message=f"{symbol} æˆäº¤é‡æš´å¢ (é‡æ¯” {ratio:.1f})",
                price=price,
                details={"ratio": ratio, "threshold": alert_ratio},
                timestamp=now,
            ))
        
        return signals
    
    def detect_sentiment_signals(
        self, sentiment_data: Dict[str, Any]
    ) -> List[Signal]:
        """
        åµæ¸¬å¸‚å ´æƒ…ç·’è¨Šè™Ÿ
        
        Args:
            sentiment_data: æƒ…ç·’è³‡æ–™ {"stock": {...}, "crypto": {...}}
            
        Returns:
            åµæ¸¬åˆ°çš„è¨Šè™Ÿåˆ—è¡¨
        """
        signals = []
        now = datetime.now()
        
        for market, data in sentiment_data.items():
            if not data:
                continue
            
            value = data.get("value")
            if value is None:
                continue
            
            asset_type = "stock" if market == "stock" else "crypto"
            market_name = "ç¾è‚¡" if market == "stock" else "å¹£åœˆ"
            
            if value <= 20:
                signals.append(Signal(
                    symbol=market_name,
                    asset_type=asset_type,
                    signal_type=SignalType.SENTIMENT_EXTREME_FEAR,
                    indicator="Fear & Greed",
                    message=f"{market_name}æ¥µåº¦ææ‡¼ ({value})ï¼Œç•™æ„è²·å…¥æ©Ÿæœƒ",
                    price=0,
                    details={"value": value, "classification": data.get("classification")},
                    timestamp=now,
                ))
            elif value >= 80:
                signals.append(Signal(
                    symbol=market_name,
                    asset_type=asset_type,
                    signal_type=SignalType.SENTIMENT_EXTREME_GREED,
                    indicator="Fear & Greed",
                    message=f"{market_name}æ¥µåº¦è²ªå©ª ({value})ï¼Œç•™æ„é¢¨éšª",
                    price=0,
                    details={"value": value, "classification": data.get("classification")},
                    timestamp=now,
                ))
        
        return signals
    
    def format_signal_message(self, signal: Signal) -> str:
        """æ ¼å¼åŒ–è¨Šè™Ÿè¨Šæ¯ï¼ˆç”¨æ–¼ LINE æ¨æ’­ï¼‰"""
        emoji = self.SIGNAL_EMOJI.get(signal.signal_type, "ğŸ“¢")
        return f"{emoji} {signal.message}"
    
    def format_signals_summary(self, signals: List[Signal]) -> str:
        """
        æ ¼å¼åŒ–å¤šå€‹è¨Šè™Ÿç‚ºæ‘˜è¦è¨Šæ¯
        
        Args:
            signals: è¨Šè™Ÿåˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–çš„è¨Šæ¯æ–‡å­—
        """
        if not signals:
            return ""
        
        # æŒ‰è‚¡ç¥¨åˆ†çµ„
        by_symbol = {}
        for s in signals:
            if s.symbol not in by_symbol:
                by_symbol[s.symbol] = []
            by_symbol[s.symbol].append(s)
        
        lines = ["ğŸ“Š æŠ€è¡“è¨Šè™Ÿé€šçŸ¥", ""]
        
        for symbol, symbol_signals in by_symbol.items():
            lines.append(f"ã€{symbol}ã€‘")
            for s in symbol_signals:
                emoji = self.SIGNAL_EMOJI.get(s.signal_type, "â€¢")
                name = self.SIGNAL_NAMES.get(s.signal_type, str(s.signal_type))
                if s.price > 0:
                    lines.append(f"  {emoji} {name} @ ${s.price:.2f}")
                else:
                    lines.append(f"  {emoji} {s.message}")
            lines.append("")
        
        lines.append(f"â° {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        
        return "\n".join(lines)


# å–®ä¾‹
signal_service = SignalService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/stock_history_service.py  â­â­â­
> è‚¡ç¥¨æ­·å²è³‡æ–™å¿«å–æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨æ­·å²è³‡æ–™å¿«å–æœå‹™
====================
å°‡æŸ¥è©¢éçš„æ­·å²è³‡æ–™å­˜å…¥ PostgreSQLï¼Œå¤§å¹…æ¸›å°‘ Yahoo Finance API èª¿ç”¨

ä¿®æ­£ç‰ˆ - 2026-01-16
- ç¢ºä¿è³‡æ–™æ­£ç¢ºå­˜å…¥ DB
- ç¢ºä¿å¾ DB è®€å–çš„æ ¼å¼èˆ‡ yahoo_finance å®Œå…¨ä¸€è‡´
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Tuple
from sqlalchemy.orm import Session
from sqlalchemy import select, and_, func, delete, text
import logging

from app.models.stock_price import StockPrice
from app.data_sources.yahoo_finance import yahoo_finance

logger = logging.getLogger(__name__)


class StockHistoryService:
    """è‚¡ç¥¨æ­·å²è³‡æ–™å¿«å–æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_stock_history(
        self,
        symbol: str,
        years: int = 10,
        force_refresh: bool = False,
    ) -> Tuple[Optional[pd.DataFrame], str]:
        """
        å–å¾—è‚¡ç¥¨æ­·å²è³‡æ–™ï¼ˆå„ªå…ˆä½¿ç”¨æœ¬åœ°å¿«å–ï¼‰
        
        Returns:
            (DataFrame, source) - DataFrame æ ¼å¼èˆ‡ yahoo_finance.get_stock_history() å®Œå…¨ç›¸åŒ
        """
        symbol = symbol.upper()
        
        # å¼·åˆ¶åˆ·æ–°
        if force_refresh:
            logger.info(f"ğŸ”„ å¼·åˆ¶åˆ·æ–°: {symbol}")
            df = self._fetch_and_save(symbol, years)
            return df, "yahoo"
        
        # æª¢æŸ¥å¿«å–
        cache_info = self._get_cache_info(symbol)
        
        if cache_info is None:
            # ç„¡å¿«å–ï¼Œé¦–æ¬¡æŸ¥è©¢
            logger.info(f"ğŸ“¥ é¦–æ¬¡æŸ¥è©¢: {symbol}")
            df = self._fetch_and_save(symbol, years)
            return df, "yahoo"
        
        latest_date, record_count = cache_info
        today = date.today()
        
        # åˆ¤æ–·å¿«å–æ˜¯å¦è¶³å¤ æ–°
        if self._is_cache_fresh(latest_date, today):
            logger.info(f"ğŸ“¦ å¿«å–å‘½ä¸­: {symbol} ({record_count} ç­†ï¼Œæœ€æ–° {latest_date})")
            df = self._load_from_db(symbol, years)
            return df, "cache"
        else:
            # éœ€è¦è£œæŠ“
            days_missing = (today - latest_date).days
            logger.info(f"ğŸ“¥ è£œæŠ“ {symbol}: {days_missing} å¤©")
            df = self._fetch_incremental(symbol, latest_date, years)
            return df, "partial" if df is not None else "cache"
    
    def _get_cache_info(self, symbol: str) -> Optional[Tuple[date, int]]:
        """å–å¾—å¿«å–è³‡è¨Š"""
        try:
            stmt = select(
                func.max(StockPrice.date),
                func.count(StockPrice.id)
            ).where(StockPrice.symbol == symbol)
            
            result = self.db.execute(stmt).first()
            
            if result and result[0] is not None:
                return result[0], result[1]
        except Exception as e:
            logger.warning(f"æŸ¥è©¢å¿«å–è³‡è¨Šå¤±æ•—: {e}")
        return None
    
    def _is_cache_fresh(self, latest_date: date, today: date) -> bool:
        """åˆ¤æ–·å¿«å–æ˜¯å¦è¶³å¤ æ–°"""
        if latest_date >= today:
            return True
        
        # é€±æœ«åˆ¤æ–·
        if today.weekday() >= 5:
            days_since_friday = today.weekday() - 4
            last_friday = today - timedelta(days=days_since_friday)
            if latest_date >= last_friday:
                return True
        
        # å…è¨± 1 å¤©å»¶é²ï¼ˆå‡æ—¥ï¼‰
        if (today - latest_date).days <= 1:
            return True
        
        return False
    
    def _fetch_and_save(self, symbol: str, years: int) -> Optional[pd.DataFrame]:
        """å¾ Yahoo æŠ“å–ä¸¦å­˜å…¥ DB"""
        period = f"{years}y"
        df = yahoo_finance.get_stock_history(symbol, period=period)
        
        if df is not None and not df.empty:
            saved = self._save_to_db(symbol, df)
            logger.info(f"ğŸ’¾ å·²å­˜å…¥ DB: {symbol} ({saved} ç­†)")
        
        return df
    
    def _fetch_incremental(self, symbol: str, last_date: date, years: int) -> Optional[pd.DataFrame]:
        """å¢é‡æŠ“å–"""
        today = date.today()
        days_needed = (today - last_date).days + 5
        
        if days_needed <= 30:
            period = "1mo"
        elif days_needed <= 90:
            period = "3mo"
        else:
            period = "6mo"
        
        df_new = yahoo_finance.get_stock_history(symbol, period=period)
        
        if df_new is not None and not df_new.empty:
            # åªå­˜æ–°è³‡æ–™
            df_to_save = df_new[df_new['date'] > last_date]
            if not df_to_save.empty:
                saved = self._save_to_db(symbol, df_to_save)
                logger.info(f"ğŸ’¾ å¢é‡å­˜å…¥: {symbol} ({saved} ç­†)")
        
        # è¿”å›å®Œæ•´è³‡æ–™
        return self._load_from_db(symbol, years)
    
    def _save_to_db(self, symbol: str, df: pd.DataFrame) -> int:
        """å­˜å…¥è³‡æ–™åº«"""
        if df is None or df.empty:
            return 0
        
        count = 0
        symbol = symbol.upper()
        
        for _, row in df.iterrows():
            try:
                # è™•ç†æ—¥æœŸ
                row_date = row['date']
                if hasattr(row_date, 'date') and callable(row_date.date):
                    row_date = row_date.date()
                elif not isinstance(row_date, date):
                    row_date = pd.to_datetime(row_date).date()
                
                # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                existing = self.db.query(StockPrice).filter(
                    StockPrice.symbol == symbol,
                    StockPrice.date == row_date
                ).first()
                
                if existing:
                    # æ›´æ–°
                    existing.open = float(row['open']) if pd.notna(row.get('open')) else None
                    existing.high = float(row['high']) if pd.notna(row.get('high')) else None
                    existing.low = float(row['low']) if pd.notna(row.get('low')) else None
                    existing.close = float(row['close']) if pd.notna(row.get('close')) else None
                    existing.volume = int(row['volume']) if pd.notna(row.get('volume')) else 0
                else:
                    # æ–°å¢
                    price = StockPrice(
                        symbol=symbol,
                        date=row_date,
                        open=float(row['open']) if pd.notna(row.get('open')) else None,
                        high=float(row['high']) if pd.notna(row.get('high')) else None,
                        low=float(row['low']) if pd.notna(row.get('low')) else None,
                        close=float(row['close']) if pd.notna(row.get('close')) else None,
                        volume=int(row['volume']) if pd.notna(row.get('volume')) else 0,
                    )
                    self.db.add(price)
                    count += 1
                    
            except Exception as e:
                logger.warning(f"å­˜å…¥å¤±æ•— {symbol} {row.get('date')}: {e}")
                continue
        
        try:
            self.db.commit()
        except Exception as e:
            logger.error(f"Commit å¤±æ•—: {e}")
            self.db.rollback()
            return 0
        
        return count
    
    def _load_from_db(self, symbol: str, years: int) -> Optional[pd.DataFrame]:
        """
        å¾è³‡æ–™åº«è¼‰å…¥ï¼Œè¿”å›æ ¼å¼èˆ‡ yahoo_finance.get_stock_history() å®Œå…¨ç›¸åŒ
        """
        start_date = date.today() - timedelta(days=years * 365)
        
        try:
            results = self.db.query(StockPrice).filter(
                StockPrice.symbol == symbol.upper(),
                StockPrice.date >= start_date
            ).order_by(StockPrice.date).all()
            
            if not results:
                return None
            
            # å»ºç«‹èˆ‡ yahoo_finance ç›¸åŒæ ¼å¼çš„ DataFrame
            data = []
            for r in results:
                data.append({
                    "date": r.date,
                    "open": float(r.open) if r.open else None,
                    "high": float(r.high) if r.high else None,
                    "low": float(r.low) if r.low else None,
                    "close": float(r.close) if r.close else None,
                    "volume": int(r.volume) if r.volume else 0,
                    "symbol": symbol.upper(),
                })
            
            df = pd.DataFrame(data)
            
            # èª¿ç”¨ yahoo_finance çš„åˆ†å‰²èª¿æ•´é‚è¼¯ï¼Œç”¢ç”Ÿ adj_close
            df = yahoo_finance._detect_and_adjust_splits(df, symbol)
            
            return df
            
        except Exception as e:
            logger.error(f"å¾ DB è¼‰å…¥å¤±æ•—: {e}")
            return None
    
    def get_cache_stats(self, symbol: str = None) -> dict:
        """å–å¾—å¿«å–çµ±è¨ˆ"""
        if symbol:
            info = self._get_cache_info(symbol.upper())
            if info:
                return {
                    "symbol": symbol.upper(),
                    "latest_date": info[0].isoformat(),
                    "record_count": info[1],
                }
            return {"symbol": symbol.upper(), "cached": False}
        
        try:
            stmt = select(
                StockPrice.symbol,
                func.count(StockPrice.id),
                func.max(StockPrice.date)
            ).group_by(StockPrice.symbol)
            
            results = self.db.execute(stmt).all()
            
            return {
                "total_symbols": len(results),
                "total_records": sum(r[1] for r in results),
                "symbols": [
                    {"symbol": r[0], "records": r[1], "latest": r[2].isoformat() if r[2] else None}
                    for r in results
                ]
            }
        except Exception as e:
            return {"error": str(e)}
    
    def clear_cache(self, symbol: str = None) -> int:
        """æ¸…é™¤å¿«å–"""
        try:
            if symbol:
                count = self.db.query(StockPrice).filter(
                    StockPrice.symbol == symbol.upper()
                ).delete()
            else:
                count = self.db.query(StockPrice).delete()
            
            self.db.commit()
            logger.info(f"ğŸ—‘ï¸ å·²æ¸…é™¤å¿«å–: {symbol or 'å…¨éƒ¨'} ({count} ç­†)")
            return count
        except Exception as e:
            logger.error(f"æ¸…é™¤å¿«å–å¤±æ•—: {e}")
            self.db.rollback()
            return 0
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/stock_service.py  â­â­â­
> è‚¡ç¥¨æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‚¡ç¥¨æœå‹™
æ•´åˆè³‡æ–™æŠ“å–ã€å¿«å–å’ŒæŠ€è¡“æŒ‡æ¨™è¨ˆç®—
"""
import pandas as pd
from datetime import datetime, date, timedelta
from typing import Optional, Dict, Any, List
from sqlalchemy.orm import Session
from sqlalchemy import select, and_
import logging

from app.models.stock_price import StockPrice
from app.data_sources.yahoo_finance import yahoo_finance
from app.services.indicator_service import indicator_service, TrendDirection
from app.config import settings

logger = logging.getLogger(__name__)


class StockService:
    """è‚¡ç¥¨æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def _is_cache_valid(self, symbol: str) -> bool:
        """
        æª¢æŸ¥å¿«å–æ˜¯å¦æœ‰æ•ˆ
        
        è¦å‰‡ï¼š
        1. æœ‰ä»Šæ—¥è³‡æ–™
        2. æˆ–æ˜¯é€±æœ«/å‡æ—¥æ™‚æœ‰æœ€è¿‘äº¤æ˜“æ—¥è³‡æ–™
        """
        today = date.today()
        
        # æŸ¥è©¢æœ€æ–°è³‡æ–™
        stmt = (
            select(StockPrice)
            .where(StockPrice.symbol == symbol.upper())
            .order_by(StockPrice.date.desc())
            .limit(1)
        )
        result = self.db.execute(stmt).scalar_one_or_none()
        
        if not result:
            return False
        
        # å¦‚æœæœ‰ä»Šæ—¥è³‡æ–™ï¼Œå¿«å–æœ‰æ•ˆ
        if result.date == today:
            return True
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«
        if today.weekday() >= 5:  # é€±å…­=5, é€±æ—¥=6
            # é€±æœ«æ™‚ï¼Œåªè¦æœ‰é€±äº”çš„è³‡æ–™å°±ç®—æœ‰æ•ˆ
            friday = today - timedelta(days=(today.weekday() - 4))
            if result.date >= friday:
                return True
        
        # æª¢æŸ¥æ›´æ–°æ™‚é–“æ˜¯å¦åœ¨å¿«å–æ™‚é–“å…§
        if result.updated_at:
            cache_hours = settings.STOCK_DATA_CACHE_HOURS
            cache_deadline = datetime.now() - timedelta(hours=cache_hours)
            if result.updated_at > cache_deadline:
                return True
        
        return False
    
    def _save_prices_to_db(self, df: pd.DataFrame) -> int:
        """
        å„²å­˜åƒ¹æ ¼è³‡æ–™åˆ°è³‡æ–™åº«
        
        Returns:
            å„²å­˜çš„ç­†æ•¸
        """
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(StockPrice).where(
                and_(
                    StockPrice.symbol == row["symbol"],
                    StockPrice.date == row["date"],
                )
            )
            existing = self.db.execute(stmt).scalar_one_or_none()
            
            if existing:
                # æ›´æ–°ç¾æœ‰è³‡æ–™
                existing.open = row["open"]
                existing.high = row["high"]
                existing.low = row["low"]
                existing.close = row["close"]
                existing.volume = row["volume"]
            else:
                # æ–°å¢è³‡æ–™
                price = StockPrice(
                    symbol=row["symbol"],
                    date=row["date"],
                    open=row["open"],
                    high=row["high"],
                    low=row["low"],
                    close=row["close"],
                    volume=row["volume"],
                )
                self.db.add(price)
                count += 1
        
        self.db.commit()
        return count
    
    def _load_prices_from_db(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """å¾è³‡æ–™åº«è¼‰å…¥åƒ¹æ ¼è³‡æ–™"""
        start_date = date.today() - timedelta(days=days)
        
        stmt = (
            select(StockPrice)
            .where(
                and_(
                    StockPrice.symbol == symbol.upper(),
                    StockPrice.date >= start_date,
                )
            )
            .order_by(StockPrice.date)
        )
        results = self.db.execute(stmt).scalars().all()
        
        if not results:
            return None
        
        data = []
        for r in results:
            data.append({
                "symbol": r.symbol,
                "date": r.date,
                "open": float(r.open) if r.open else None,
                "high": float(r.high) if r.high else None,
                "low": float(r.low) if r.low else None,
                "close": float(r.close) if r.close else None,
                "volume": r.volume,
            })
        
        return pd.DataFrame(data)
    
    def fetch_and_cache_stock(self, symbol: str, period: str = "1y") -> bool:
        """
        æŠ“å–è‚¡ç¥¨è³‡æ–™ä¸¦å¿«å–
        
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        df = yahoo_finance.get_stock_history(symbol, period=period)
        if df is None:
            return False
        
        self._save_prices_to_db(df)
        return True
    
    def get_stock_data(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾—è‚¡ç¥¨è³‡æ–™ï¼ˆå„ªå…ˆä½¿ç”¨å¿«å–ï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            force_refresh: æ˜¯å¦å¼·åˆ¶æ›´æ–°
            
        Returns:
            åŒ…å«åƒ¹æ ¼å’ŒæŠ€è¡“æŒ‡æ¨™çš„ DataFrame
        """
        symbol = symbol.upper()
        
        # æª¢æŸ¥å¿«å–
        if not force_refresh and self._is_cache_valid(symbol):
            logger.info(f"ä½¿ç”¨å¿«å–è³‡æ–™: {symbol}")
            df = self._load_prices_from_db(symbol)
        else:
            # å¾ Yahoo Finance æŠ“å–
            logger.info(f"å¾ Yahoo Finance æŠ“å–: {symbol}")
            if not self.fetch_and_cache_stock(symbol):
                # æŠ“å–å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨èˆŠçš„å¿«å–
                df = self._load_prices_from_db(symbol)
                if df is None:
                    return None
            else:
                df = self._load_prices_from_db(symbol)
        
        if df is None or df.empty:
            return None
        
        # è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
        df = indicator_service.calculate_all_indicators(df)
        
        return df
    
    def get_stock_analysis(
        self,
        symbol: str,
        force_refresh: bool = False,
    ) -> Optional[Dict[str, Any]]:
        """
        å–å¾—è‚¡ç¥¨å®Œæ•´åˆ†æå ±å‘Š
        
        Returns:
            åˆ†æå ±å‘Šå­—å…¸
        """
        symbol = symbol.upper()
        
        # å–å¾—è³‡æ–™
        df = self.get_stock_data(symbol, force_refresh)
        if df is None:
            return None
        
        # å–å¾—è‚¡ç¥¨åŸºæœ¬è³‡è¨Š
        info = yahoo_finance.get_stock_info(symbol)
        
        # æœ€æ–°åƒ¹æ ¼è³‡æ–™
        latest = df.iloc[-1]
        price = float(latest["close"])
        
        # è¨ˆç®—æ¼²è·Œå¹…
        changes = self._calculate_changes(df)
        
        # æŠ€è¡“æŒ‡æ¨™
        indicators = self._get_indicators_summary(df, latest)
        
        # è¨Šè™Ÿ
        signals = indicator_service.get_all_signals(df)
        
        # è©•åˆ†
        score = indicator_service.calculate_score(df)
        
        # æˆäº¤é‡
        volume_info = self._get_volume_info(df, latest)
        
        return {
            "symbol": symbol,
            "name": info.get("name", "N/A") if info else "N/A",
            "asset_type": "stock",
            "price": {
                "current": price,
                "high_52w": info.get("fifty_two_week_high") if info else None,
                "low_52w": info.get("fifty_two_week_low") if info else None,
                "from_high_pct": self._calc_pct_from_high(price, info),
                "from_low_pct": self._calc_pct_from_low(price, info),
            },
            "change": changes,
            "volume": volume_info,
            "indicators": indicators,
            "signals": [
                {
                    "type": s.type.value,
                    "indicator": s.indicator,
                    "description": s.description,
                }
                for s in signals
            ],
            "score": score,
            "updated_at": datetime.now().isoformat(),
        }
    
    def _calculate_changes(self, df: pd.DataFrame) -> Dict[str, float]:
        """è¨ˆç®—å„æ™‚é–“æ®µæ¼²è·Œå¹…"""
        latest_close = df["close"].iloc[-1]
        
        def calc_change(days: int) -> Optional[float]:
            if len(df) <= days:
                return None
            old_close = df["close"].iloc[-(days + 1)]
            return round((latest_close - old_close) / old_close * 100, 2)
        
        return {
            "day": calc_change(1),
            "week": calc_change(5),
            "month": calc_change(20),
            "quarter": calc_change(60),
            "year": calc_change(250) if len(df) > 250 else None,
        }
    
    def _get_indicators_summary(
        self,
        df: pd.DataFrame,
        latest: pd.Series,
    ) -> Dict[str, Any]:
        """å–å¾—æŒ‡æ¨™æ‘˜è¦"""
        price = float(latest["close"])
        
        # MA
        ma_short = latest.get(f"ma{settings.MA_SHORT}")
        ma_mid = latest.get(f"ma{settings.MA_MID}")
        ma_long = latest.get(f"ma{settings.MA_LONG}")
        
        alignment, _ = indicator_service.get_ma_alignment(df)
        
        ma_info = {
            f"ma{settings.MA_SHORT}": round(ma_short, 2) if not pd.isna(ma_short) else None,
            f"ma{settings.MA_MID}": round(ma_mid, 2) if not pd.isna(ma_mid) else None,
            f"ma{settings.MA_LONG}": round(ma_long, 2) if not pd.isna(ma_long) else None,
            "alignment": alignment.value,
            f"price_vs_ma{settings.MA_SHORT}": "above" if price > ma_short else "below" if not pd.isna(ma_short) else None,
            f"price_vs_ma{settings.MA_MID}": "above" if price > ma_mid else "below" if not pd.isna(ma_mid) else None,
            f"price_vs_ma{settings.MA_LONG}": "above" if price > ma_long else "below" if not pd.isna(ma_long) else None,
        }
        
        # RSI
        rsi = latest.get("rsi")
        rsi_status, _ = indicator_service.get_rsi_status(rsi)
        rsi_info = {
            "value": round(rsi, 2) if not pd.isna(rsi) else None,
            "status": rsi_status,
        }
        
        # MACD
        macd_dif = latest.get("macd_dif")
        macd_dea = latest.get("macd_dea")
        macd_hist = latest.get("macd_hist")
        macd_info = {
            "dif": round(macd_dif, 4) if not pd.isna(macd_dif) else None,
            "dea": round(macd_dea, 4) if not pd.isna(macd_dea) else None,
            "histogram": round(macd_hist, 4) if not pd.isna(macd_hist) else None,
            "status": "bullish" if macd_hist and macd_hist > 0 else "bearish",
        }
        
        # KD
        kd_k = latest.get("kd_k")
        kd_d = latest.get("kd_d")
        kd_info = {
            "k": round(kd_k, 2) if not pd.isna(kd_k) else None,
            "d": round(kd_d, 2) if not pd.isna(kd_d) else None,
            "status": self._get_kd_status(kd_k),
        }
        
        # Bollinger
        bb_upper = latest.get("bb_upper")
        bb_middle = latest.get("bb_middle")
        bb_lower = latest.get("bb_lower")
        bb_info = {
            "upper": round(bb_upper, 2) if not pd.isna(bb_upper) else None,
            "middle": round(bb_middle, 2) if not pd.isna(bb_middle) else None,
            "lower": round(bb_lower, 2) if not pd.isna(bb_lower) else None,
            "position": indicator_service.get_bollinger_position(price, bb_upper, bb_middle, bb_lower),
        }
        
        # OBV
        obv_trend = indicator_service.get_obv_trend(df)
        obv_info = {
            "trend": obv_trend,
        }
        
        return {
            "ma": ma_info,
            "rsi": rsi_info,
            "macd": macd_info,
            "kd": kd_info,
            "bollinger": bb_info,
            "obv": obv_info,
        }
    
    def _get_kd_status(self, k_value: float) -> str:
        """å–å¾— KD ç‹€æ…‹"""
        if pd.isna(k_value):
            return "unknown"
        if k_value > 80:
            return "overbought"
        elif k_value < 20:
            return "oversold"
        elif k_value > 50:
            return "neutral_high"
        else:
            return "neutral_low"
    
    def _get_volume_info(
        self,
        df: pd.DataFrame,
        latest: pd.Series,
    ) -> Dict[str, Any]:
        """å–å¾—æˆäº¤é‡è³‡è¨Š"""
        today_vol = latest.get("volume", 0)
        avg_vol = latest.get("volume_ma20")
        vol_ratio = latest.get("volume_ratio")
        
        return {
            "today": int(today_vol) if today_vol else 0,
            "avg_20d": int(avg_vol) if not pd.isna(avg_vol) else None,
            "ratio": round(vol_ratio, 2) if not pd.isna(vol_ratio) else None,
        }
    
    def _calc_pct_from_high(self, price: float, info: Optional[Dict]) -> Optional[float]:
        """è¨ˆç®—è·é›¢ 52 é€±é«˜é»çš„è·Œå¹…"""
        if not info or not info.get("fifty_two_week_high"):
            return None
        high = info["fifty_two_week_high"]
        return round((price - high) / high * 100, 2)
    
    def _calc_pct_from_low(self, price: float, info: Optional[Dict]) -> Optional[float]:
        """è¨ˆç®—è·é›¢ 52 é€±ä½é»çš„æ¼²å¹…"""
        if not info or not info.get("fifty_two_week_low"):
            return None
        low = info["fifty_two_week_low"]
        return round((price - low) / low * 100, 2)
    
    def search_stocks(self, query: str) -> List[Dict[str, str]]:
        """
        æœå°‹è‚¡ç¥¨ï¼ˆç°¡å–®å¯¦ä½œï¼Œç›´æ¥é©—è­‰ä»£è™Ÿï¼‰
        
        Returns:
            ç¬¦åˆçš„è‚¡ç¥¨åˆ—è¡¨
        """
        symbol = query.upper().strip()
        
        if yahoo_finance.validate_symbol(symbol):
            info = yahoo_finance.get_stock_info(symbol)
            if info:
                return [{
                    "symbol": info["symbol"],
                    "name": info.get("name", "N/A"),
                }]
        
        return []
    
    def fetch_extended_history(
        self,
        symbol: str,
        years: int = 10,
    ) -> bool:
        """
        æŠ“å–ä¸¦å¿«å–å»¶ä¼¸æ­·å²è³‡æ–™ï¼ˆæ”¯æ´å¤šå¹´ï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            years: å¹´æ•¸ (1, 3, 5, 10)
            
        Returns:
            æ˜¯å¦æˆåŠŸ
        """
        period_map = {1: "1y", 2: "2y", 5: "5y", 10: "10y"}
        period = period_map.get(years, "10y")
        
        df = yahoo_finance.get_stock_history(symbol, period=period)
        if df is None:
            return False
        
        self._save_prices_to_db(df)
        return True
    
    def get_price_history(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾—è‚¡ç¥¨åƒ¹æ ¼æ­·å²ï¼ˆå¾è³‡æ–™åº«ï¼‰
        
        Args:
            symbol: è‚¡ç¥¨ä»£è™Ÿ
            days: å¤©æ•¸
            
        Returns:
            åƒ¹æ ¼ DataFrame
        """
        return self._load_prices_from_db(symbol, days)
    
    def ensure_historical_data(
        self,
        symbol: str,
        years: int = 10,
    ) -> bool:
        """
        ç¢ºä¿æœ‰è¶³å¤ çš„æ­·å²è³‡æ–™
        
        æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æœ‰æŒ‡å®šå¹´ä»½çš„è³‡æ–™ï¼Œ
        å¦‚æœä¸è¶³å‰‡å¾ API æŠ“å–è£œé½Š
        """
        symbol = symbol.upper()
        days_needed = years * 365
        
        # æª¢æŸ¥è³‡æ–™åº«ä¸­æœ€æ—©çš„è³‡æ–™æ—¥æœŸ
        stmt = (
            select(StockPrice)
            .where(StockPrice.symbol == symbol)
            .order_by(StockPrice.date)
            .limit(1)
        )
        earliest = self.db.execute(stmt).scalar_one_or_none()
        
        if earliest:
            days_available = (date.today() - earliest.date).days
            if days_available >= days_needed * 0.9:  # 90% å°±ç®—è¶³å¤ 
                return True
        
        # è³‡æ–™ä¸è¶³ï¼ŒæŠ“å–æ›´å¤š
        logger.info(f"æŠ“å– {symbol} çš„ {years} å¹´æ­·å²è³‡æ–™")
        return self.fetch_extended_history(symbol, years)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/subscription_service.py  â­â­â­
> è¨‚é–±ç²¾é¸æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨‚é–±ç²¾é¸æœå‹™
è² è²¬ç®¡ç†è¨‚é–±æºã€è™•ç†æŠ“å–çµæœã€ç”¨æˆ¶è¨‚é–±
"""
import logging
from datetime import datetime, timedelta
from typing import List, Dict, Optional
from sqlalchemy.orm import Session
from sqlalchemy import and_

from app.models.subscription import SubscriptionSource, AutoPick, UserSubscription
from app.services.rss_fetcher import rss_fetcher

logger = logging.getLogger(__name__)


class SubscriptionService:
    """è¨‚é–±ç²¾é¸æœå‹™"""
    
    def __init__(self, db: Session):
        self.db = db
    
    # ============================================================
    # è¨‚é–±æºç®¡ç†
    # ============================================================
    
    def get_all_sources(self, enabled_only: bool = True) -> List[SubscriptionSource]:
        """å–å¾—æ‰€æœ‰è¨‚é–±æº"""
        query = self.db.query(SubscriptionSource)
        if enabled_only:
            query = query.filter(SubscriptionSource.enabled == True)
        return query.all()
    
    def get_source_by_slug(self, slug: str) -> Optional[SubscriptionSource]:
        """æ ¹æ“š slug å–å¾—è¨‚é–±æº"""
        return self.db.query(SubscriptionSource).filter(
            SubscriptionSource.slug == slug
        ).first()
    
    def create_source(self, name: str, slug: str, url: str, 
                      type: str = "substack", description: str = None) -> SubscriptionSource:
        """å»ºç«‹è¨‚é–±æº"""
        source = SubscriptionSource(
            name=name,
            slug=slug,
            url=url,
            type=type,
            description=description,
        )
        self.db.add(source)
        self.db.commit()
        self.db.refresh(source)
        logger.info(f"å»ºç«‹è¨‚é–±æº: {name} ({slug})")
        return source
    
    def init_default_sources(self):
        """åˆå§‹åŒ–é è¨­è¨‚é–±æº"""
        defaults = [
            {
                "name": "ç¾è‚¡å¤§å”",
                "slug": "uncle-stock",
                "url": "https://unclestocknotes.substack.com/feed",
                "type": "substack",
                "description": "ç¾è‚¡å¤§å”çš„æŠ•è³‡ç­†è¨˜",
            },
        ]
        
        for source_data in defaults:
            existing = self.get_source_by_slug(source_data["slug"])
            if not existing:
                self.create_source(**source_data)
    
    # ============================================================
    # æŠ“å–èˆ‡æ›´æ–°
    # ============================================================
    
    def fetch_source(self, source: SubscriptionSource, 
                     since_date: datetime = None, 
                     backfill: bool = False) -> Dict:
        """
        æŠ“å–å–®ä¸€è¨‚é–±æº
        
        Args:
            source: è¨‚é–±æº
            since_date: èµ·å§‹æ—¥æœŸ
            backfill: æ˜¯å¦ç‚ºå›æº¯æ¨¡å¼ï¼ˆé¦–æ¬¡æŠ“å–ï¼‰
        
        Returns:
            {new: int, updated: int, symbols: [...]}
        """
        logger.info(f"é–‹å§‹æŠ“å–: {source.name}")
        
        # æ±ºå®šèµ·å§‹æ—¥æœŸ
        if backfill:
            since_date = datetime.now() - timedelta(days=30)
        elif since_date is None:
            # ä½¿ç”¨ä¸Šæ¬¡æŠ“å–æ™‚é–“ï¼Œæˆ–é è¨­ 1 å¤©å‰
            since_date = source.last_fetched_at or (datetime.now() - timedelta(days=1))
        
        # æŠ“å– RSS
        picks = rss_fetcher.fetch_and_parse(source.url, since_date)
        
        result = {"new": 0, "updated": 0, "symbols": []}
        
        # ç”¨ä¾†è¿½è¹¤æœ¬æ¬¡è™•ç†éçš„ symbolsï¼ˆé¿å…é‡è¤‡æ’å…¥ï¼‰
        processed_symbols = {}
        
        for pick in picks:
            symbol = pick["symbol"]
            
            # æª¢æŸ¥æ˜¯å¦åœ¨æœ¬æ¬¡è¿´åœˆä¸­å·²è™•ç†é
            if symbol in processed_symbols:
                # æ›´æ–°æœ¬æ¬¡è¿´åœˆä¸­çš„è¨˜éŒ„
                existing_pick = processed_symbols[symbol]
                existing_pick.update_mention(
                    article_url=pick["article_url"],
                    article_title=pick["article_title"],
                    article_date=pick["article_date"],
                )
                result["updated"] += 1
                continue
            
            # æª¢æŸ¥è³‡æ–™åº«ä¸­æ˜¯å¦å·²å­˜åœ¨
            existing = self.db.query(AutoPick).filter(
                and_(
                    AutoPick.source_id == source.id,
                    AutoPick.symbol == symbol
                )
            ).first()
            
            if existing:
                # æ›´æ–°æåŠ
                existing.update_mention(
                    article_url=pick["article_url"],
                    article_title=pick["article_title"],
                    article_date=pick["article_date"],
                )
                processed_symbols[symbol] = existing
                result["updated"] += 1
            else:
                # æ–°å¢
                new_pick = AutoPick(
                    source_id=source.id,
                    symbol=symbol,
                    article_url=pick["article_url"],
                    article_title=pick["article_title"],
                    article_date=pick["article_date"],
                    first_seen_at=datetime.now(),
                    last_seen_at=datetime.now(),
                    expires_at=datetime.now() + timedelta(days=30),
                    mention_count=1,
                )
                self.db.add(new_pick)
                processed_symbols[symbol] = new_pick
                result["new"] += 1
            
            if symbol not in result["symbols"]:
                result["symbols"].append(symbol)
        
        # æ›´æ–°æœ€å¾ŒæŠ“å–æ™‚é–“
        source.last_fetched_at = datetime.now()
        self.db.commit()
        
        logger.info(f"æŠ“å–å®Œæˆ: æ–°å¢ {result['new']}, æ›´æ–° {result['updated']}")
        return result
    
    def fetch_all_sources(self, backfill: bool = False) -> Dict:
        """æŠ“å–æ‰€æœ‰å•Ÿç”¨çš„è¨‚é–±æº"""
        sources = self.get_all_sources(enabled_only=True)
        
        total_result = {"sources": [], "total_new": 0, "total_updated": 0}
        
        for source in sources:
            result = self.fetch_source(source, backfill=backfill)
            total_result["sources"].append({
                "name": source.name,
                "slug": source.slug,
                **result
            })
            total_result["total_new"] += result["new"]
            total_result["total_updated"] += result["updated"]
        
        return total_result
    
    # ============================================================
    # ç”¨æˆ¶è¨‚é–±
    # ============================================================
    
    def subscribe(self, user_id: int, source_id: int) -> bool:
        """ç”¨æˆ¶è¨‚é–±ä¾†æº"""
        existing = self.db.query(UserSubscription).filter(
            and_(
                UserSubscription.user_id == user_id,
                UserSubscription.source_id == source_id
            )
        ).first()
        
        if existing:
            return False  # å·²è¨‚é–±
        
        subscription = UserSubscription(
            user_id=user_id,
            source_id=source_id,
        )
        self.db.add(subscription)
        self.db.commit()
        logger.info(f"ç”¨æˆ¶ {user_id} è¨‚é–±äº†ä¾†æº {source_id}")
        return True
    
    def unsubscribe(self, user_id: int, source_id: int) -> bool:
        """ç”¨æˆ¶å–æ¶ˆè¨‚é–±"""
        subscription = self.db.query(UserSubscription).filter(
            and_(
                UserSubscription.user_id == user_id,
                UserSubscription.source_id == source_id
            )
        ).first()
        
        if not subscription:
            return False
        
        self.db.delete(subscription)
        self.db.commit()
        logger.info(f"ç”¨æˆ¶ {user_id} å–æ¶ˆè¨‚é–±ä¾†æº {source_id}")
        return True
    
    def get_user_subscriptions(self, user_id: int) -> List[SubscriptionSource]:
        """å–å¾—ç”¨æˆ¶è¨‚é–±çš„ä¾†æº"""
        subscriptions = self.db.query(UserSubscription).filter(
            UserSubscription.user_id == user_id
        ).all()
        
        source_ids = [s.source_id for s in subscriptions]
        if not source_ids:
            return []
        
        return self.db.query(SubscriptionSource).filter(
            SubscriptionSource.id.in_(source_ids)
        ).all()
    
    def is_subscribed(self, user_id: int, source_id: int) -> bool:
        """æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨‚é–±"""
        return self.db.query(UserSubscription).filter(
            and_(
                UserSubscription.user_id == user_id,
                UserSubscription.source_id == source_id
            )
        ).first() is not None
    
    # ============================================================
    # æŸ¥è©¢ç²¾é¸
    # ============================================================
    
    def get_active_picks(self, source_id: int = None, limit: int = 50) -> List[AutoPick]:
        """å–å¾—æœ‰æ•ˆçš„ç²¾é¸ï¼ˆæœªéæœŸï¼‰"""
        query = self.db.query(AutoPick).filter(
            AutoPick.expires_at > datetime.now()
        )
        
        if source_id:
            query = query.filter(AutoPick.source_id == source_id)
        
        return query.order_by(AutoPick.last_seen_at.desc()).limit(limit).all()
    
    def get_user_picks(self, user_id: int, limit: int = 50) -> List[Dict]:
        """å–å¾—ç”¨æˆ¶è¨‚é–±çš„æ‰€æœ‰ç²¾é¸"""
        # å–å¾—ç”¨æˆ¶è¨‚é–±çš„ä¾†æº
        subscribed_sources = self.get_user_subscriptions(user_id)
        if not subscribed_sources:
            return []
        
        source_ids = [s.id for s in subscribed_sources]
        
        # æŸ¥è©¢æœ‰æ•ˆçš„ç²¾é¸
        picks = self.db.query(AutoPick).filter(
            and_(
                AutoPick.source_id.in_(source_ids),
                AutoPick.expires_at > datetime.now()
            )
        ).order_by(AutoPick.last_seen_at.desc()).limit(limit).all()
        
        # çµ„åˆçµæœ
        source_map = {s.id: s for s in subscribed_sources}
        results = []
        for pick in picks:
            pick_dict = pick.to_dict()
            pick_dict["source_name"] = source_map[pick.source_id].name
            pick_dict["source_slug"] = source_map[pick.source_id].slug
            results.append(pick_dict)
        
        return results
    
    def get_pick_by_symbol(self, source_id: int, symbol: str) -> Optional[AutoPick]:
        """æ ¹æ“šä¾†æºå’Œä»£ç¢¼å–å¾—ç²¾é¸"""
        return self.db.query(AutoPick).filter(
            and_(
                AutoPick.source_id == source_id,
                AutoPick.symbol == symbol
            )
        ).first()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/services/watchlist_service.py  â­â­â­
> è¿½è¹¤æ¸…å–®æœå‹™ (Async ç‰ˆæœ¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¿½è¹¤æ¸…å–®æœå‹™ (Async ç‰ˆæœ¬)

ğŸ”§ ä¿®å¾©ç‰ˆæœ¬ - 2026-01-16
- æ–°å¢è¿½è¹¤å¾Œç«‹å³æ›´æ–°å¿«å–ï¼ˆåŠ é€Ÿè¿½è¹¤æ¸…å–®è¼‰å…¥ï¼‰
"""
from typing import Optional, Dict, Any, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_
import logging
import pandas as pd

from app.models.watchlist import Watchlist
from app.models.user import User
from app.data_sources.coingecko import CRYPTO_MAP

logger = logging.getLogger(__name__)

# æ”¯æ´çš„åŠ å¯†è²¨å¹£ä»£è™Ÿ
SUPPORTED_CRYPTO = set(k for k in CRYPTO_MAP.keys() if k not in ("BITCOIN", "ETHEREUM"))


class WatchlistService:
    """è¿½è¹¤æ¸…å–®æœå‹™ (Async)"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    def _get_asset_type(self, symbol: str) -> str:
        """åˆ¤æ–·è³‡ç”¢é¡å‹"""
        return "crypto" if symbol.upper() in SUPPORTED_CRYPTO else "stock"
    
    async def add_to_watchlist(
        self,
        user_id: int,
        symbol: str,
        note: str = None,
    ) -> Dict[str, Any]:
        """
        æ–°å¢è¿½è¹¤æ¨™çš„
        
        ğŸ”§ å„ªåŒ–ç‰ˆæœ¬ï¼šæ–°å¢å¾Œç«‹å³æ›´æ–°å¿«å–
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: è‚¡ç¥¨/åŠ å¯†è²¨å¹£ä»£è™Ÿ
            note: å‚™è¨»
            
        Returns:
            {
                "success": bool,
                "message": str,
                "watchlist": Watchlist (if success)
            }
        """
        symbol = symbol.upper()
        asset_type = self._get_asset_type(symbol)
        
        logger.info(f"=== æ–°å¢è¿½è¹¤æ¸…å–® ===")
        logger.info(f"ç”¨æˆ¶ ID: {user_id}, ä»£è™Ÿ: {symbol}, é¡å‹: {asset_type}")
        
        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        existing = await self._get_watchlist_item(user_id, symbol, asset_type)
        if existing:
            logger.info(f"å·²å­˜åœ¨è¿½è¹¤: user_id={user_id}, symbol={symbol}")
            return {
                "success": False,
                "message": f"{symbol} å·²åœ¨è¿½è¹¤æ¸…å–®ä¸­",
            }
        
        # é©—è­‰ä»£è™Ÿæ˜¯å¦æœ‰æ•ˆ
        if asset_type == "crypto":
            from app.data_sources.coingecko import coingecko
            if not coingecko.validate_symbol(symbol):
                logger.warning(f"ç„¡æ•ˆçš„åŠ å¯†è²¨å¹£: {symbol}")
                return {
                    "success": False,
                    "message": f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}",
                }
        else:
            from app.data_sources.yahoo_finance import yahoo_finance
            if not yahoo_finance.validate_symbol(symbol):
                logger.warning(f"ç„¡æ•ˆçš„è‚¡ç¥¨ä»£è™Ÿ: {symbol}")
                return {
                    "success": False,
                    "message": f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}",
                }
        
        # æ–°å¢
        watchlist = Watchlist(
            user_id=user_id,
            symbol=symbol,
            asset_type=asset_type,
            note=note,
        )
        self.db.add(watchlist)
        await self.db.commit()
        await self.db.refresh(watchlist)
        
        logger.info(f"â˜… è¿½è¹¤æ¸…å–®å¯«å…¥æˆåŠŸ: id={watchlist.id}, user_id={user_id}, symbol={symbol}")
        
        # ğŸ†• æ–°å¢è¿½è¹¤å¾Œç«‹å³æ›´æ–°å¿«å–ï¼ˆé€™æ¨£è¿½è¹¤æ¸…å–®é¦¬ä¸Šå°±æœ‰åƒ¹æ ¼ï¼‰
        try:
            await self._update_price_cache_for_symbol(symbol, asset_type)
            logger.info(f"âœ… å·²æ›´æ–° {symbol} å¿«å–")
        except Exception as e:
            logger.warning(f"æ›´æ–° {symbol} å¿«å–å¤±æ•—: {e}")
            # ä¸å½±éŸ¿ä¸»æµç¨‹ï¼Œå¿«å–æœƒåœ¨ä¸‹æ¬¡æ’ç¨‹æ›´æ–°
        
        return {
            "success": True,
            "message": f"å·²æ–°å¢ {symbol} åˆ°è¿½è¹¤æ¸…å–®",
            "watchlist": watchlist,
        }
    
    async def _update_price_cache_for_symbol(self, symbol: str, asset_type: str):
        """
        ğŸ†• æ›´æ–°å–®ä¸€è‚¡ç¥¨/åŠ å¯†è²¨å¹£çš„åƒ¹æ ¼å¿«å–
        ç”¨æ–¼æ–°å¢è¿½è¹¤å¾Œç«‹å³æ›´æ–°ï¼Œä¸ç”¨ç­‰æ’ç¨‹
        """
        from app.database import SyncSessionLocal
        from app.services.price_cache_service import PriceCacheService
        from app.data_sources.yahoo_finance import yahoo_finance
        from app.data_sources.coingecko import coingecko
        from app.services.indicator_service import indicator_service
        
        # ä½¿ç”¨åŒæ­¥ sessionï¼ˆå› ç‚º PriceCacheService æ˜¯åŒæ­¥çš„ï¼‰
        sync_db = SyncSessionLocal()
        try:
            cache_service = PriceCacheService(sync_db)
            
            if asset_type == "crypto":
                # åŠ å¯†è²¨å¹£
                price_data = coingecko.get_price(symbol)
                if price_data:
                    cache_service._upsert_cache(
                        symbol=symbol,
                        name=price_data.get("name", symbol),
                        price=price_data.get("price"),
                        prev_close=price_data.get("prev_close"),
                        change=price_data.get("change"),
                        change_pct=price_data.get("change_pct"),
                        volume=price_data.get("volume"),
                        asset_type="crypto",
                    )
                    sync_db.commit()
            else:
                # è‚¡ç¥¨
                df = yahoo_finance.get_stock_history(symbol, period="1mo")
                if df is not None and not df.empty:
                    # è¨ˆç®— MA20
                    df = indicator_service.add_ma_indicators(df)
                    
                    latest = df.iloc[-1]
                    prev = df.iloc[-2] if len(df) > 1 else None
                    
                    current_price = float(latest['close'])
                    prev_close = float(prev['close']) if prev is not None else None
                    change = current_price - prev_close if prev_close else None
                    change_pct = (change / prev_close * 100) if prev_close and change else None
                    ma20 = float(latest.get('ma20')) if 'ma20' in latest and not pd.isna(latest.get('ma20')) else None
                    
                    # å–å¾—è‚¡ç¥¨åç¨±
                    info = yahoo_finance.get_stock_info(symbol)
                    name = info.get("name", symbol) if info else symbol
                    
                    cache_service._upsert_cache(
                        symbol=symbol,
                        name=name,
                        price=current_price,
                        prev_close=prev_close,
                        change=change,
                        change_pct=change_pct,
                        volume=int(latest.get('volume', 0)),
                        asset_type="stock",
                        ma20=ma20,
                    )
                    sync_db.commit()
                    
        except Exception as e:
            logger.error(f"æ›´æ–° {symbol} å¿«å–å¤±æ•—: {e}")
            raise
        finally:
            sync_db.close()
    
    async def remove_from_watchlist(
        self,
        user_id: int,
        symbol: str = None,
        watchlist_id: int = None,
    ) -> Dict[str, Any]:
        """
        å¾è¿½è¹¤æ¸…å–®ç§»é™¤
        
        Args:
            user_id: ç”¨æˆ¶ ID
            symbol: ä»£è™Ÿï¼ˆèˆ‡ watchlist_id äºŒæ“‡ä¸€ï¼‰
            watchlist_id: è¿½è¹¤æ¸…å–® ID
            
        Returns:
            {"success": bool, "message": str}
        """
        logger.info(f"=== ç§»é™¤è¿½è¹¤æ¸…å–® ===")
        logger.info(f"ç”¨æˆ¶ ID: {user_id}, symbol: {symbol}, watchlist_id: {watchlist_id}")
        
        watchlist = None
        
        if watchlist_id:
            # ç”¨ ID æŸ¥è©¢
            stmt = select(Watchlist).where(
                and_(
                    Watchlist.id == watchlist_id,
                    Watchlist.user_id == user_id,
                )
            )
            result = await self.db.execute(stmt)
            watchlist = result.scalar_one_or_none()
        elif symbol:
            # ç”¨ symbol æŸ¥è©¢
            symbol = symbol.upper()
            asset_type = self._get_asset_type(symbol)
            watchlist = await self._get_watchlist_item(user_id, symbol, asset_type)
        
        if not watchlist:
            logger.warning(f"æ‰¾ä¸åˆ°è¿½è¹¤: user_id={user_id}, symbol={symbol}, watchlist_id={watchlist_id}")
            return {
                "success": False,
                "message": "æ‰¾ä¸åˆ°è©²è¿½è¹¤é …ç›®",
            }
        
        removed_symbol = watchlist.symbol
        await self.db.delete(watchlist)
        await self.db.commit()
        
        logger.info(f"â˜… å·²ç§»é™¤è¿½è¹¤: user_id={user_id}, symbol={removed_symbol}")
        
        return {
            "success": True,
            "message": f"å·²å¾è¿½è¹¤æ¸…å–®ç§»é™¤ {removed_symbol}",
        }
    
    async def update_note(
        self,
        user_id: int,
        symbol: str,
        note: str,
    ) -> Dict[str, Any]:
        """
        æ›´æ–°å‚™è¨»
        """
        symbol = symbol.upper()
        asset_type = self._get_asset_type(symbol)
        
        watchlist = await self._get_watchlist_item(user_id, symbol, asset_type)
        
        if not watchlist:
            return {
                "success": False,
                "message": f"{symbol} ä¸åœ¨è¿½è¹¤æ¸…å–®ä¸­",
            }
        
        watchlist.note = note
        await self.db.commit()
        
        return {
            "success": True,
            "message": f"å·²æ›´æ–° {symbol} çš„å‚™è¨»",
        }
    
    async def get_watchlist(self, user_id: int) -> List[Watchlist]:
        """
        å–å¾—ç”¨æˆ¶è¿½è¹¤æ¸…å–®
        
        Args:
            user_id: ç”¨æˆ¶ ID
            
        Returns:
            è¿½è¹¤æ¸…å–®åˆ—è¡¨
        """
        logger.debug(f"å–å¾—è¿½è¹¤æ¸…å–®: user_id={user_id}")
        
        stmt = (
            select(Watchlist)
            .where(Watchlist.user_id == user_id)  # â˜… åªå–å¾—è©²ç”¨æˆ¶çš„è³‡æ–™
            .order_by(Watchlist.added_at.desc())
        )
        result = await self.db.execute(stmt)
        items = list(result.scalars().all())
        
        logger.info(f"å–å¾—è¿½è¹¤æ¸…å–®: user_id={user_id}, æ•¸é‡={len(items)}")
        for item in items:
            logger.debug(f"  - id={item.id}, symbol={item.symbol}, user_id={item.user_id}")
        
        return items
    
    async def get_watchlist_symbols(self, user_id: int) -> Dict[str, List[str]]:
        """
        å–å¾—ç”¨æˆ¶è¿½è¹¤çš„ä»£è™Ÿåˆ—è¡¨ï¼ˆç”¨æ–¼é€šçŸ¥ç³»çµ±ï¼‰
        
        Returns:
            {
                "stocks": ["AAPL", "TSLA"],
                "crypto": ["BTC", "ETH"]
            }
        """
        watchlists = await self.get_watchlist(user_id)
        
        stocks = []
        cryptos = []
        
        for item in watchlists:
            if item.asset_type == "stock":
                stocks.append(item.symbol)
            else:
                cryptos.append(item.symbol)
        
        return {
            "stocks": stocks,
            "crypto": cryptos,
        }
    
    async def _get_watchlist_item(
        self,
        user_id: int,
        symbol: str,
        asset_type: str,
    ) -> Optional[Watchlist]:
        """å–å¾—ç‰¹å®šè¿½è¹¤é …ç›®"""
        stmt = select(Watchlist).where(
            and_(
                Watchlist.user_id == user_id,
                Watchlist.symbol == symbol,
                Watchlist.asset_type == asset_type,
            )
        )
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def get_all_tracked_symbols(self) -> Dict[str, set]:
        """
        å–å¾—æ‰€æœ‰ç”¨æˆ¶è¿½è¹¤çš„ä»£è™Ÿï¼ˆç”¨æ–¼æ‰¹æ¬¡æ›´æ–°ï¼‰
        
        Returns:
            {
                "stocks": {"AAPL", "TSLA", ...},
                "crypto": {"BTC", "ETH"}
            }
        """
        stmt = select(Watchlist.symbol, Watchlist.asset_type).distinct()
        result = await self.db.execute(stmt)
        results = result.all()
        
        stocks = set()
        cryptos = set()
        
        for symbol, asset_type in results:
            if asset_type == "stock":
                stocks.add(symbol)
            else:
                cryptos.add(symbol)
        
        return {
            "stocks": stocks,
            "crypto": cryptos,
        }
```

======================================================================
## ğŸ”§ å·¥å…· / è¼”åŠ©
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/utils/__init__.py  â­
> å·¥å…·æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å·¥å…·æ¨¡çµ„
"""
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/utils/migrations.py  â­
> è³‡æ–™åº«è‡ªå‹•é·ç§»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è³‡æ–™åº«è‡ªå‹•é·ç§»
åœ¨å•Ÿå‹•æ™‚æª¢æŸ¥ä¸¦æ·»åŠ ç¼ºå°‘çš„æ¬„ä½
"""
import logging
from sqlalchemy import text
from sqlalchemy.orm import Session

logger = logging.getLogger(__name__)


def run_migrations(db: Session):
    """åŸ·è¡Œè³‡æ–™åº«é·ç§»"""
    migrations = [
        # 2024-01-14: è¿½è¹¤æ¸…å–® MA20 æ’åºåŠŸèƒ½
        {
            "name": "add_ma20_to_price_cache",
            "check": "SELECT column_name FROM information_schema.columns WHERE table_name='stock_price_cache' AND column_name='ma20'",
            "sql": "ALTER TABLE stock_price_cache ADD COLUMN ma20 NUMERIC(12, 4)",
        },
    ]
    
    for migration in migrations:
        try:
            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            result = db.execute(text(migration["check"])).fetchone()
            if result:
                logger.debug(f"Migration '{migration['name']}' å·²å­˜åœ¨ï¼Œè·³é")
                continue
            
            # åŸ·è¡Œé·ç§»
            logger.info(f"åŸ·è¡Œ Migration: {migration['name']}")
            db.execute(text(migration["sql"]))
            db.commit()
            logger.info(f"Migration '{migration['name']}' å®Œæˆ")
            
        except Exception as e:
            logger.warning(f"Migration '{migration['name']}' å¤±æ•—: {e}")
            db.rollback()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/utils/p1_migrations.py  â­
> P1 åŠŸèƒ½è³‡æ–™åº«é·ç§»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
P1 åŠŸèƒ½è³‡æ–™åº«é·ç§»
==================
æ–°å¢ä»¥ä¸‹è¡¨æ ¼ï¼š
1. stock_info - è‚¡ç¥¨åŸºæœ¬è³‡è¨Šç¨®å­è¡¨
2. user_tags - ç”¨æˆ¶è‡ªè¨‚æ¨™ç±¤
3. watchlist_tags - è¿½è¹¤é …ç›®æ¨™ç±¤é—œè¯

åœ¨ app/database.py çš„ run_migrations() ä¸­å‘¼å«
"""

import logging
from sqlalchemy import text
from sqlalchemy.orm import Session

logger = logging.getLogger(__name__)


# ============================================================
# é è¨­ç¨®å­è³‡æ–™
# ============================================================

DEFAULT_STOCK_INFO = [
    # ç¾è‚¡ - ç§‘æŠ€å·¨é ­
    {"symbol": "AAPL", "name": "Apple Inc.", "name_zh": "è˜‹æœ", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "MSFT", "name": "Microsoft Corporation", "name_zh": "å¾®è»Ÿ", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "GOOGL", "name": "Alphabet Inc.", "name_zh": "Google", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "AMZN", "name": "Amazon.com Inc.", "name_zh": "äºé¦¬éœ", "market": "us", "exchange": "NASDAQ", "sector": "Consumer Cyclical", "is_popular": True},
    {"symbol": "NVDA", "name": "NVIDIA Corporation", "name_zh": "è¼é”", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "META", "name": "Meta Platforms Inc.", "name_zh": "Meta", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "TSLA", "name": "Tesla Inc.", "name_zh": "ç‰¹æ–¯æ‹‰", "market": "us", "exchange": "NASDAQ", "sector": "Consumer Cyclical", "is_popular": True},
    
    # ç¾è‚¡ - é‡‘è
    {"symbol": "JPM", "name": "JPMorgan Chase & Co.", "name_zh": "æ‘©æ ¹å¤§é€š", "market": "us", "exchange": "NYSE", "sector": "Financial Services", "is_popular": True},
    {"symbol": "V", "name": "Visa Inc.", "name_zh": "Visa", "market": "us", "exchange": "NYSE", "sector": "Financial Services", "is_popular": True},
    {"symbol": "MA", "name": "Mastercard Inc.", "name_zh": "è¬äº‹é”å¡", "market": "us", "exchange": "NYSE", "sector": "Financial Services", "is_popular": True},
    
    # ç¾è‚¡ - åŠå°é«”
    {"symbol": "AMD", "name": "Advanced Micro Devices", "name_zh": "è¶…å¾®", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "INTC", "name": "Intel Corporation", "name_zh": "è‹±ç‰¹çˆ¾", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    {"symbol": "AVGO", "name": "Broadcom Inc.", "name_zh": "åšé€š", "market": "us", "exchange": "NASDAQ", "sector": "Technology", "is_popular": True},
    
    # å°è‚¡ - åŠå°é«”
    {"symbol": "2330.TW", "name": "Taiwan Semiconductor", "name_zh": "å°ç©é›»", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    {"symbol": "2454.TW", "name": "MediaTek Inc.", "name_zh": "è¯ç™¼ç§‘", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    {"symbol": "2303.TW", "name": "United Microelectronics", "name_zh": "è¯é›»", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    {"symbol": "3711.TW", "name": "ASE Technology", "name_zh": "æ—¥æœˆå…‰æŠ•æ§", "market": "tw", "exchange": "TWSE", "sector": "åŠå°é«”", "is_popular": True},
    
    # å°è‚¡ - é›»å­ä»£å·¥
    {"symbol": "2317.TW", "name": "Hon Hai Precision", "name_zh": "é´»æµ·", "market": "tw", "exchange": "TWSE", "sector": "é›»å­", "is_popular": True},
    {"symbol": "2382.TW", "name": "Quanta Computer", "name_zh": "å»£é”", "market": "tw", "exchange": "TWSE", "sector": "é›»å­", "is_popular": True},
    {"symbol": "2357.TW", "name": "Asustek Computer", "name_zh": "è¯ç¢©", "market": "tw", "exchange": "TWSE", "sector": "é›»å­", "is_popular": True},
    
    # å°è‚¡ - é‡‘è
    {"symbol": "2881.TW", "name": "Fubon Financial", "name_zh": "å¯Œé‚¦é‡‘", "market": "tw", "exchange": "TWSE", "sector": "é‡‘è", "is_popular": True},
    {"symbol": "2882.TW", "name": "Cathay Financial", "name_zh": "åœ‹æ³°é‡‘", "market": "tw", "exchange": "TWSE", "sector": "é‡‘è", "is_popular": True},
    {"symbol": "2884.TW", "name": "E.Sun Financial", "name_zh": "ç‰å±±é‡‘", "market": "tw", "exchange": "TWSE", "sector": "é‡‘è", "is_popular": True},
    
    # å°è‚¡ - ETF
    {"symbol": "0050.TW", "name": "Yuanta Taiwan 50 ETF", "name_zh": "å…ƒå¤§å°ç£50", "market": "tw", "exchange": "TWSE", "sector": "ETF", "is_popular": True},
    {"symbol": "0056.TW", "name": "Yuanta High Dividend ETF", "name_zh": "å…ƒå¤§é«˜è‚¡æ¯", "market": "tw", "exchange": "TWSE", "sector": "ETF", "is_popular": True},
    {"symbol": "00878.TW", "name": "Cathay ESG High Dividend ETF", "name_zh": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯", "market": "tw", "exchange": "TWSE", "sector": "ETF", "is_popular": True},
    
    # åŠ å¯†è²¨å¹£
    {"symbol": "BTC", "name": "Bitcoin", "name_zh": "æ¯”ç‰¹å¹£", "market": "crypto", "exchange": "CoinGecko", "sector": "Cryptocurrency", "is_popular": True},
    {"symbol": "ETH", "name": "Ethereum", "name_zh": "ä»¥å¤ªåŠ", "market": "crypto", "exchange": "CoinGecko", "sector": "Cryptocurrency", "is_popular": True},
    {"symbol": "SOL", "name": "Solana", "name_zh": "ç´¢æ‹‰ç´", "market": "crypto", "exchange": "CoinGecko", "sector": "Cryptocurrency", "is_popular": True},
    
    # æŒ‡æ•¸
    {"symbol": "^GSPC", "name": "S&P 500", "name_zh": "æ¨™æ™®500", "market": "us", "exchange": "INDEX", "sector": "Index", "is_popular": True},
    {"symbol": "^DJI", "name": "Dow Jones Industrial Average", "name_zh": "é“ç“Šå·¥æ¥­", "market": "us", "exchange": "INDEX", "sector": "Index", "is_popular": True},
    {"symbol": "^IXIC", "name": "NASDAQ Composite", "name_zh": "ç´æ–¯é”å…‹", "market": "us", "exchange": "INDEX", "sector": "Index", "is_popular": True},
    {"symbol": "^TWII", "name": "Taiwan Weighted Index", "name_zh": "å°ç£åŠ æ¬Š", "market": "tw", "exchange": "INDEX", "sector": "Index", "is_popular": True},
]


def run_p1_migrations(db: Session) -> dict:
    """
    åŸ·è¡Œ P1 åŠŸèƒ½çš„è³‡æ–™åº«é·ç§»
    
    Returns:
        é·ç§»çµæœ
    """
    results = {
        "success": True,
        "tables_created": [],
        "columns_added": [],
        "seed_data": 0,
        "errors": [],
    }
    
    try:
        # ============================================================
        # 1. stock_info è¡¨
        # ============================================================
        try:
            db.execute(text("""
                CREATE TABLE IF NOT EXISTS stock_info (
                    id SERIAL PRIMARY KEY,
                    symbol VARCHAR(20) UNIQUE NOT NULL,
                    name VARCHAR(100),
                    name_zh VARCHAR(100),
                    market VARCHAR(10) DEFAULT 'us',
                    exchange VARCHAR(20),
                    sector VARCHAR(50),
                    industry VARCHAR(50),
                    market_cap FLOAT,
                    pe_ratio FLOAT,
                    dividend_yield FLOAT,
                    description TEXT,
                    website VARCHAR(200),
                    logo_url VARCHAR(300),
                    is_active BOOLEAN DEFAULT TRUE,
                    is_popular BOOLEAN DEFAULT FALSE,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """))
            
            # å»ºç«‹ç´¢å¼•
            db.execute(text("CREATE INDEX IF NOT EXISTS idx_stock_info_symbol ON stock_info(symbol)"))
            db.execute(text("CREATE INDEX IF NOT EXISTS idx_stock_info_market ON stock_info(market)"))
            db.execute(text("CREATE INDEX IF NOT EXISTS idx_stock_info_sector ON stock_info(sector)"))
            db.execute(text("CREATE INDEX IF NOT EXISTS idx_stock_info_popular ON stock_info(is_popular)"))
            
            db.commit()
            results["tables_created"].append("stock_info")
            logger.info("âœ… stock_info è¡¨å·²å»ºç«‹")
        except Exception as e:
            if "already exists" in str(e).lower():
                logger.info("â„¹ï¸ stock_info è¡¨å·²å­˜åœ¨")
            else:
                results["errors"].append(f"stock_info: {e}")
                logger.error(f"âŒ stock_info å»ºç«‹å¤±æ•—: {e}")
        
        # ============================================================
        # 2. user_tags è¡¨
        # ============================================================
        try:
            db.execute(text("""
                CREATE TABLE IF NOT EXISTS user_tags (
                    id SERIAL PRIMARY KEY,
                    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    name VARCHAR(50) NOT NULL,
                    color VARCHAR(20) DEFAULT '#3B82F6',
                    icon VARCHAR(50) DEFAULT 'fa-tag',
                    sort_order INTEGER DEFAULT 0,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(user_id, name)
                )
            """))
            
            # å»ºç«‹ç´¢å¼•
            db.execute(text("CREATE INDEX IF NOT EXISTS idx_user_tags_user_id ON user_tags(user_id)"))
            
            db.commit()
            results["tables_created"].append("user_tags")
            logger.info("âœ… user_tags è¡¨å·²å»ºç«‹")
        except Exception as e:
            if "already exists" in str(e).lower():
                logger.info("â„¹ï¸ user_tags è¡¨å·²å­˜åœ¨")
            else:
                results["errors"].append(f"user_tags: {e}")
                logger.error(f"âŒ user_tags å»ºç«‹å¤±æ•—: {e}")
        
        # ============================================================
        # 3. watchlist_tags é—œè¯è¡¨
        # ============================================================
        try:
            db.execute(text("""
                CREATE TABLE IF NOT EXISTS watchlist_tags (
                    watchlist_id INTEGER NOT NULL REFERENCES watchlist(id) ON DELETE CASCADE,
                    tag_id INTEGER NOT NULL REFERENCES user_tags(id) ON DELETE CASCADE,
                    PRIMARY KEY (watchlist_id, tag_id)
                )
            """))
            
            db.commit()
            results["tables_created"].append("watchlist_tags")
            logger.info("âœ… watchlist_tags è¡¨å·²å»ºç«‹")
        except Exception as e:
            if "already exists" in str(e).lower():
                logger.info("â„¹ï¸ watchlist_tags è¡¨å·²å­˜åœ¨")
            else:
                results["errors"].append(f"watchlist_tags: {e}")
                logger.error(f"âŒ watchlist_tags å»ºç«‹å¤±æ•—: {e}")
        
        # ============================================================
        # 4. æª¢æŸ¥ watchlist è¡¨æ˜¯å¦æœ‰ target_price æ¬„ä½
        # ============================================================
        try:
            # æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
            result = db.execute(text("""
                SELECT column_name FROM information_schema.columns 
                WHERE table_name = 'watchlist' AND column_name = 'target_price'
            """))
            if not result.fetchone():
                db.execute(text("""
                    ALTER TABLE watchlist ADD COLUMN target_price DECIMAL(20, 8)
                """))
                db.commit()
                results["columns_added"].append("watchlist.target_price")
                logger.info("âœ… watchlist.target_price æ¬„ä½å·²æ–°å¢")
            else:
                logger.info("â„¹ï¸ watchlist.target_price æ¬„ä½å·²å­˜åœ¨")
        except Exception as e:
            if "already exists" in str(e).lower():
                pass
            else:
                results["errors"].append(f"target_price: {e}")
                logger.warning(f"âš ï¸ æ–°å¢ target_price æ¬„ä½å¤±æ•—: {e}")
        
        # ============================================================
        # 5. è‡ªå‹•å¡«å…¥ç¨®å­è³‡æ–™
        # ============================================================
        try:
            # æª¢æŸ¥æ˜¯å¦ç‚ºç©ºè¡¨
            count_result = db.execute(text("SELECT COUNT(*) FROM stock_info"))
            count = count_result.scalar()
            
            if count == 0:
                logger.info("ğŸ“Š stock_info ç‚ºç©ºï¼Œé–‹å§‹å¡«å…¥ç¨®å­è³‡æ–™...")
                for stock_data in DEFAULT_STOCK_INFO:
                    db.execute(text("""
                        INSERT INTO stock_info (symbol, name, name_zh, market, exchange, sector, is_popular)
                        VALUES (:symbol, :name, :name_zh, :market, :exchange, :sector, :is_popular)
                        ON CONFLICT (symbol) DO NOTHING
                    """), stock_data)
                db.commit()
                results["seed_data"] = len(DEFAULT_STOCK_INFO)
                logger.info(f"âœ… å·²å¡«å…¥ {len(DEFAULT_STOCK_INFO)} ç­†ç¨®å­è³‡æ–™")
            else:
                logger.info(f"â„¹ï¸ stock_info å·²æœ‰ {count} ç­†è³‡æ–™ï¼Œè·³éç¨®å­å¡«å…¥")
        except Exception as e:
            logger.warning(f"âš ï¸ ç¨®å­è³‡æ–™å¡«å…¥å¤±æ•—: {e}")
        
        # ============================================================
        # ç¸½çµ
        # ============================================================
        if results["errors"]:
            results["success"] = False
            logger.warning(f"P1 é·ç§»å®Œæˆï¼Œä½†æœ‰éŒ¯èª¤: {results['errors']}")
        else:
            logger.info(f"âœ… P1 é·ç§»å®Œæˆ: å»ºç«‹ {len(results['tables_created'])} å€‹è¡¨, ç¨®å­ {results['seed_data']} ç­†")
        
        return results
        
    except Exception as e:
        logger.error(f"âŒ P1 é·ç§»å¤±æ•—: {e}")
        db.rollback()
        results["success"] = False
        results["errors"].append(str(e))
        return results
```

======================================================================
## ğŸ¨ å‰ç«¯ / éœæ…‹è³‡æº
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/admin.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <style>
        .brand-orange { color: #FA7A35; }
        .bg-brand-orange { background-color: #FA7A35; }
        .hover\:bg-brand-orange-dark:hover { background-color: #e56a25; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-slate-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-xl font-bold bg-brand-orange px-3 py-1 rounded">SELA</span>
                    <span class="text-lg">ç®¡ç†å¾Œå°</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/static/dashboard.html" class="text-gray-300 hover:text-white">
                        â† è¿”å›å„€è¡¨æ¿
                    </a>
                    <span id="adminName" class="text-gray-300"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ç¸½ç”¨æˆ¶æ•¸</div>
                <div id="statTotal" class="text-2xl font-bold text-slate-800">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ç¸½ç™»å…¥æ¬¡æ•¸</div>
                <div id="statTotalLogins" class="text-2xl font-bold text-purple-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ä»Šæ—¥ç™»å…¥</div>
                <div id="statToday" class="text-2xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">å°é–ç”¨æˆ¶</div>
                <div id="statBlocked" class="text-2xl font-bold text-red-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">ç®¡ç†å“¡</div>
                <div id="statAdmin" class="text-2xl font-bold text-blue-600">-</div>
            </div>
        </div>
        
        <!-- ç³»çµ±ç®¡ç† -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š å¸‚å ´è³‡æ–™ç®¡ç†</h3>
            <div class="flex flex-wrap gap-3">
                <button onclick="initializeData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                    <span class="mr-2">ğŸ”„</span>åˆå§‹åŒ–æ­·å²è³‡æ–™
                </button>
                <button onclick="updateIndices()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
                    <span class="mr-2">ğŸ“ˆ</span>æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
                </button>
                <button onclick="updateSentiment()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center">
                    <span class="mr-2">ğŸ’­</span>æ›´æ–°ææ‡¼è²ªå©ª
                </button>
                <button onclick="triggerDailyUpdate()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center">
                    <span class="mr-2">âš¡</span>åŸ·è¡Œæ¯æ—¥æ›´æ–°
                </button>
            </div>
            <p id="systemMessage" class="mt-3 text-sm text-gray-500"></p>
        </div>

        <!-- è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h3 class="font-bold text-gray-700 mb-4">ğŸ”” è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­</h3>
            <div class="flex flex-wrap gap-3 mb-3">
                <button onclick="runSignalCheck()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center">
                    <span class="mr-2">ğŸ”</span>åµæ¸¬è¨Šè™Ÿï¼ˆæ¸¬è©¦ï¼‰
                </button>
                <button onclick="sendSignalNotifications()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center">
                    <span class="mr-2">ğŸ“¤</span>ç™¼é€è¨Šè™Ÿé€šçŸ¥
                </button>
                <button onclick="testLineNotify()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center">
                    <span class="mr-2">ğŸ“±</span>æ¸¬è©¦ LINE æ¨æ’­
                </button>
            </div>
            <div class="flex gap-2 items-center">
                <input type="text" id="testSymbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæ¸¬è©¦è¨Šè™Ÿåµæ¸¬ (å¦‚ AAPL)"
                    class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <button onclick="testSignalDetection()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    æ¸¬è©¦åµæ¸¬
                </button>
            </div>
            <p id="signalMessage" class="mt-3 text-sm text-gray-500"></p>
            <div id="signalResult" class="mt-3 hidden">
                <h4 class="font-medium text-gray-700 mb-2">åµæ¸¬çµæœï¼š</h4>
                <pre id="signalResultContent" class="bg-gray-100 p-3 rounded text-xs overflow-x-auto"></pre>
            </div>
        </div>

        <!-- æœå°‹å’Œç¯©é¸ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="æœå°‹ç”¨æˆ¶åç¨±ã€Email æˆ– LINE ID..."
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400">
                </div>
                <div class="flex gap-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="blockedOnly" class="mr-2">
                        <span class="text-sm">åªé¡¯ç¤ºå°é–</span>
                    </label>
                    <button onclick="loadUsers()" class="bg-brand-orange text-white px-4 py-2 rounded-lg hover:bg-brand-orange-dark">
                        æœå°‹
                    </button>
                    <button onclick="kickAllUsers()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        è¸¢å‡ºå…¨éƒ¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç”¨æˆ¶</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç™»å…¥æ¬¡æ•¸</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">æœ€å¾Œç™»å…¥</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="divide-y divide-gray-200">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é  -->
            <div class="px-4 py-3 bg-gray-50 flex items-center justify-between">
                <div id="pageInfo" class="text-sm text-gray-500"></div>
                <div class="flex gap-2">
                    <button id="prevPage" onclick="changePage(-1)" class="px-3 py-1 border rounded hover:bg-gray-100" disabled>ä¸Šä¸€é </button>
                    <button id="nextPage" onclick="changePage(1)" class="px-3 py-1 border rounded hover:bg-gray-100" disabled>ä¸‹ä¸€é </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ¶è©³æƒ… Modal -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">ç”¨æˆ¶è©³æƒ…</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div id="modalContent">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // æª¢æŸ¥ç™»å…¥å’Œç®¡ç†å“¡æ¬Šé™
        if (!token) {
            window.location.href = '/static/index.html';
        }

        document.getElementById('adminName').textContent = user.display_name || '';

        // API è«‹æ±‚
        async function apiRequest(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/static/index.html';
                return null;
            }
            
            if (response.status === 403) {
                alert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
                window.location.href = '/static/dashboard.html';
                return null;
            }
            
            return response.json();
        }

        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            const data = await apiRequest('/api/admin/stats');
            if (data && data.success) {
                document.getElementById('statTotal').textContent = data.stats.total_users;
                document.getElementById('statTotalLogins').textContent = data.stats.total_logins;
                document.getElementById('statToday').textContent = data.stats.today_logins;
                document.getElementById('statBlocked').textContent = data.stats.blocked_users;
                document.getElementById('statAdmin').textContent = data.stats.admin_users;
            }
        }

        // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
        async function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const blockedOnly = document.getElementById('blockedOnly').checked;
            
            let url = `/api/admin/users?page=${currentPage}&page_size=20`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (blockedOnly) url += `&blocked_only=true`;
            
            const data = await apiRequest(url);
            if (data && data.success) {
                renderUsers(data.users);
                totalPages = data.pagination.total_pages;
                document.getElementById('pageInfo').textContent = 
                    `ç¬¬ ${data.pagination.page} / ${totalPages} é ï¼Œå…± ${data.pagination.total} ç­†`;
                document.getElementById('prevPage').disabled = currentPage <= 1;
                document.getElementById('nextPage').disabled = currentPage >= totalPages;
            }
        }

        // æ¸²æŸ“ç”¨æˆ¶åˆ—è¡¨
        function renderUsers(users) {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <img src="${u.picture_url || '/static/logo.png'}" 
                                class="w-10 h-10 rounded-full mr-3" 
                                onerror="this.src='/static/logo.png'">
                            <div>
                                <div class="font-medium text-gray-900">${escapeHtml(u.display_name || 'æœªå‘½å')}</div>
                                <div class="text-xs text-gray-500">ID: ${u.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 hidden md:table-cell">
                        ${escapeHtml(u.email || '-')}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-1">
                            ${u.is_admin ? '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800">ç®¡ç†å“¡</span>' : ''}
                            ${u.is_blocked ? '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800">å·²å°é–</span>' : '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800">æ­£å¸¸</span>'}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-sm font-medium rounded-full bg-purple-100 text-purple-700">${u.login_count || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 hidden md:table-cell">
                        ${formatDate(u.last_login)}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex gap-1">
                            <button onclick="showUserDetail(${u.id})" 
                                class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">è©³æƒ…</button>
                            ${u.is_blocked 
                                ? `<button onclick="unblockUser(${u.id})" class="px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded">è§£å°</button>`
                                : `<button onclick="blockUser(${u.id})" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-700 rounded">å°é–</button>`
                            }
                            <button onclick="kickUser(${u.id})" 
                                class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded">è¸¢å‡º</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // é¡¯ç¤ºç”¨æˆ¶è©³æƒ…
        async function showUserDetail(userId) {
            const data = await apiRequest(`/api/admin/users/${userId}`);
            if (data && data.success) {
                const u = data.user;
                const logs = data.recent_logs;
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${u.picture_url || '/static/logo.png'}" 
                            class="w-16 h-16 rounded-full mr-4"
                            onerror="this.src='/static/logo.png'">
                        <div>
                            <div class="font-bold text-xl">${escapeHtml(u.display_name || 'æœªå‘½å')}</div>
                            <div class="text-gray-500">${escapeHtml(u.email || 'ç„¡ Email')}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">ç”¨æˆ¶ ID</div>
                            <div class="font-medium">${u.id}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">LINE ID</div>
                            <div class="font-medium text-xs break-all">${u.line_user_id}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">è¨»å†Šæ™‚é–“</div>
                            <div class="font-medium">${formatDate(u.created_at)}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-xs text-gray-500">æœ€å¾Œç™»å…¥</div>
                            <div class="font-medium">${formatDate(u.last_login)}</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        ${u.is_admin 
                            ? `<button onclick="removeAdmin(${u.id})" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded">ç§»é™¤ç®¡ç†å“¡</button>`
                            : `<button onclick="setAdmin(${u.id})" class="flex-1 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">è¨­ç‚ºç®¡ç†å“¡</button>`
                        }
                        ${u.is_blocked 
                            ? `<button onclick="unblockUser(${u.id})" class="flex-1 py-2 bg-green-500 hover:bg-green-600 text-white rounded">è§£é™¤å°é–</button>`
                            : `<button onclick="blockUser(${u.id})" class="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white rounded">å°é–ç”¨æˆ¶</button>`
                        }
                    </div>
                    
                    ${u.is_blocked ? `
                        <div class="bg-red-50 p-3 rounded mb-4">
                            <div class="text-red-800 font-medium">å°é–è³‡è¨Š</div>
                            <div class="text-sm text-red-600">åŸå› ï¼š${escapeHtml(u.blocked_reason || 'æœªèªªæ˜')}</div>
                            <div class="text-sm text-red-600">æ™‚é–“ï¼š${formatDate(u.blocked_at)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="border-t pt-4">
                        <div class="font-medium mb-2">æœ€è¿‘æ´»å‹•è¨˜éŒ„</div>
                        <div class="max-h-48 overflow-y-auto">
                            ${logs.length ? logs.map(log => `
                                <div class="flex justify-between py-1 text-sm border-b">
                                    <span class="text-gray-600">${getActionText(log.action)}</span>
                                    <span class="text-gray-400">${formatDate(log.created_at)}</span>
                                </div>
                            `).join('') : '<div class="text-gray-400 text-sm">ç„¡è¨˜éŒ„</div>'}
                        </div>
                    </div>
                `;
                
                document.getElementById('userModal').classList.remove('hidden');
                document.getElementById('userModal').classList.add('flex');
            }
        }

        function closeModal() {
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('userModal').classList.remove('flex');
        }

        // æ“ä½œå‡½æ•¸
        async function blockUser(userId) {
            const reason = prompt('è«‹è¼¸å…¥å°é–åŸå› ï¼ˆå¯ç•™ç©ºï¼‰ï¼š');
            if (reason === null) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/block?reason=${encodeURIComponent(reason)}`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        async function unblockUser(userId) {
            if (!confirm('ç¢ºå®šè¦è§£é™¤å°é–æ­¤ç”¨æˆ¶å—ï¼Ÿ')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/unblock`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        async function kickUser(userId) {
            if (!confirm('ç¢ºå®šè¦è¸¢å‡ºæ­¤ç”¨æˆ¶å—ï¼Ÿç”¨æˆ¶éœ€è¦é‡æ–°ç™»å…¥ã€‚')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/kick`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
            }
        }

        async function kickAllUsers() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦è¸¢å‡ºæ‰€æœ‰ç”¨æˆ¶å—ï¼Ÿæ‰€æœ‰äººï¼ˆåŒ…æ‹¬æ‚¨è‡ªå·±ï¼‰éƒ½éœ€è¦é‡æ–°ç™»å…¥ï¼')) return;
            if (!confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡ä½¿æ‰€æœ‰ç™»å…¥ Token å¤±æ•ˆï¼')) return;
            
            const data = await apiRequest('/api/admin/kick-all', {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                localStorage.clear();
                window.location.href = '/static/index.html';
            }
        }

        async function setAdmin(userId) {
            if (!confirm('ç¢ºå®šè¦å°‡æ­¤ç”¨æˆ¶è¨­ç‚ºç®¡ç†å“¡å—ï¼Ÿ')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/set-admin`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        async function removeAdmin(userId) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ç”¨æˆ¶çš„ç®¡ç†å“¡æ¬Šé™å—ï¼Ÿ')) return;
            
            const data = await apiRequest(`/api/admin/users/${userId}/remove-admin`, {
                method: 'POST'
            });
            if (data && data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
                closeModal();
            }
        }

        function changePage(delta) {
            currentPage += delta;
            loadUsers();
        }

        // å·¥å…·å‡½æ•¸
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getActionText(action) {
            const actions = {
                'login': 'ğŸ”‘ ç™»å…¥',
                'logout': 'ğŸšª ç™»å‡º',
                'blocked': 'ğŸš« è¢«å°é–',
                'unblocked': 'âœ… è§£é™¤å°é–',
                'kicked': 'ğŸ‘¢ è¢«è¸¢å‡º',
                'kick_all': 'ğŸ‘¢ å…¨å“¡è¸¢å‡º',
            };
            return actions[action] || action;
        }
        
        // ===== å¸‚å ´è³‡æ–™ç®¡ç† =====
        
        function showSystemMessage(msg, isError = false) {
            const el = document.getElementById('systemMessage');
            el.textContent = msg;
            el.className = `mt-3 text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
        }
        
        async function initializeData() {
            if (!confirm('é€™æœƒåˆå§‹åŒ–ä¸‰å¤§æŒ‡æ•¸æ­·å²è³‡æ–™ï¼ˆ10å¹´ï¼‰å’Œå¹£åœˆæƒ…ç·’æ­·å²ï¼ˆ365å¤©ï¼‰ï¼Œå¯èƒ½éœ€è¦å¹¾åˆ†é˜ã€‚ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                return;
            }
            
            showSystemMessage('æ­£åœ¨åˆå§‹åŒ–è³‡æ–™ï¼Œè«‹ç¨å€™...');
            
            try {
                const data = await apiRequest('/api/market/admin/initialize', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… åˆå§‹åŒ–å®Œæˆï¼æŒ‡æ•¸: ${data.data?.indices || 0} ç­†, æƒ…ç·’: ${data.data?.sentiment || 0} ç­†`);
                } else {
                    showSystemMessage(`âŒ åˆå§‹åŒ–å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ åˆå§‹åŒ–å¤±æ•—: ${e.message}`, true);
            }
        }
        
        async function updateIndices() {
            showSystemMessage('æ­£åœ¨æ›´æ–°ä¸‰å¤§æŒ‡æ•¸...');
            
            try {
                const data = await apiRequest('/api/market/admin/update-indices', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… ä¸‰å¤§æŒ‡æ•¸æ›´æ–°å®Œæˆï¼${data.data?.count || 0} ç­†è³‡æ–™`);
                } else {
                    showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
            }
        }
        
        async function updateSentiment() {
            showSystemMessage('æ­£åœ¨æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸...');
            
            try {
                const data = await apiRequest('/api/market/admin/update-sentiment', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… ææ‡¼è²ªå©ªæŒ‡æ•¸æ›´æ–°å®Œæˆï¼`);
                } else {
                    showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
            }
        }
        
        async function triggerDailyUpdate() {
            showSystemMessage('æ­£åœ¨åŸ·è¡Œæ¯æ—¥æ›´æ–°...');
            
            try {
                const data = await apiRequest('/api/market/admin/update', { method: 'POST' });
                if (data && data.success) {
                    showSystemMessage(`âœ… æ¯æ—¥æ›´æ–°å®Œæˆï¼`);
                } else {
                    showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
            }
        }

        // ========== è¨Šè™Ÿæª¢æŸ¥ç›¸é—œ ==========
        
        function showSignalMessage(msg, isError = false) {
            const el = document.getElementById('signalMessage');
            el.textContent = msg;
            el.className = isError ? 'mt-3 text-sm text-red-500' : 'mt-3 text-sm text-gray-500';
        }

        async function runSignalCheck() {
            showSignalMessage('æ­£åœ¨åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥...');
            document.getElementById('signalResult').classList.add('hidden');
            
            try {
                const data = await apiRequest('/api/admin/signal/detect', { method: 'POST' });
                if (data && data.success) {
                    showSignalMessage(`âœ… æª¢æŸ¥å®Œæˆï¼šåµæ¸¬åˆ° ${data.total_signals} å€‹è¨Šè™Ÿ`);
                    
                    if (data.signals_by_symbol && Object.keys(data.signals_by_symbol).length > 0) {
                        document.getElementById('signalResult').classList.remove('hidden');
                        document.getElementById('signalResultContent').textContent = 
                            JSON.stringify(data.signals_by_symbol, null, 2);
                    }
                } else {
                    showSignalMessage(`âŒ æª¢æŸ¥å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ æª¢æŸ¥å¤±æ•—: ${e.message}`, true);
            }
        }

        async function sendSignalNotifications() {
            showSignalMessage('æ­£åœ¨ç™¼é€è¨Šè™Ÿé€šçŸ¥...');
            
            try {
                const data = await apiRequest('/api/admin/signal/notify', { method: 'POST' });
                if (data && data.success) {
                    const r = data.result || {};
                    showSignalMessage(`âœ… ${data.message} - è‚¡ç¥¨æ›´æ–°: ${r.stocks_updated}, è¨Šè™Ÿåµæ¸¬: ${r.signals_detected}, é€šçŸ¥ç™¼é€: ${r.notifications_sent}`);
                    
                    if (r.errors && r.errors.length > 0) {
                        document.getElementById('signalResult').classList.remove('hidden');
                        document.getElementById('signalResultContent').textContent = 
                            'éŒ¯èª¤è¨˜éŒ„:\n' + r.errors.join('\n');
                    }
                } else {
                    showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${e.message}`, true);
            }
        }

        async function testSignalDetection() {
            const symbol = document.getElementById('testSymbolInput').value.trim();
            if (!symbol) {
                showSignalMessage('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ', true);
                return;
            }
            
            showSignalMessage(`æ­£åœ¨æ¸¬è©¦ ${symbol.toUpperCase()} çš„è¨Šè™Ÿåµæ¸¬...`);
            document.getElementById('signalResult').classList.add('hidden');
            
            // ä½¿ç”¨ detect API ç„¶å¾Œéæ¿¾ç‰¹å®šè‚¡ç¥¨
            try {
                const data = await apiRequest('/api/admin/signal/detect', { method: 'POST' });
                if (data && data.success) {
                    const symbolUpper = symbol.toUpperCase();
                    const symbolSignals = data.signals_by_symbol[symbolUpper] || [];
                    
                    showSignalMessage(`âœ… ${symbolUpper} åµæ¸¬åˆ° ${symbolSignals.length} å€‹è¨Šè™Ÿ`);
                    
                    document.getElementById('signalResult').classList.remove('hidden');
                    document.getElementById('signalResultContent').textContent = 
                        JSON.stringify({ symbol: symbolUpper, signals: symbolSignals }, null, 2);
                } else {
                    showSignalMessage(`âŒ åµæ¸¬å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ åµæ¸¬å¤±æ•—: ${e.message}`, true);
            }
        }

        async function testLineNotify() {
            showSignalMessage('æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...');
            
            try {
                const data = await apiRequest('/api/admin/signal/test-push?message=ç®¡ç†å“¡æ¸¬è©¦è¨Šæ¯', { method: 'POST' });
                if (data && data.success) {
                    showSignalMessage('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINE');
                } else {
                    showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${data?.message || data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
                }
            } catch (e) {
                showSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${e.message}`, true);
            }
        }

        // æ¸¬è©¦è‚¡ç¥¨è¼¸å…¥æ¡† Enter éµæ”¯æ´
        document.getElementById('testSymbolInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testSignalDetection();
        });

        // æœå°‹ Enter éµæ”¯æ´
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadUsers();
        });

        // åˆå§‹è¼‰å…¥
        loadStats();
        loadUsers();
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/compare-nav.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * SELA å ±é…¬ç‡æ¯”è¼ƒåŠŸèƒ½ - å°èˆªé€£çµæ³¨å…¥
 * å°‡æ­¤æª”æ¡ˆæ”¾åˆ° static/ ç›®éŒ„ï¼Œä¸¦åœ¨ dashboard.html çš„ </body> å‰å¼•å…¥
 * <script src="/static/compare-nav.js"></script>
 */

(function() {
    'use strict';
    
    // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
        injectCompareLinks();
    });
    
    // å¦‚æœ DOM å·²ç¶“è¼‰å…¥å®Œæˆï¼Œç›´æ¥åŸ·è¡Œ
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(injectCompareLinks, 100);
    }
    
    function injectCompareLinks() {
        // æ¡Œé¢ç‰ˆå´é‚Šæ¬„é€£çµ HTML
        const desktopLinkHTML = `
            <a href="/static/compare.html" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                <i class="fas fa-chart-bar mr-3"></i>
                <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
            </a>
        `;
        
        // æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„é€£çµ HTML
        const mobileLinkHTML = `
            <a href="/static/compare.html" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target">
                <i class="fas fa-chart-bar mr-3 w-6"></i>
                <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
            </a>
        `;
        
        // æ‰¾åˆ°ã€Œè¨­å®šã€é€£çµä¸¦åœ¨å…¶å¾Œæ’å…¥
        // æ¡Œé¢ç‰ˆ
        const desktopSettingsLinks = document.querySelectorAll('a.nav-link');
        desktopSettingsLinks.forEach(function(link) {
            if (link.textContent.includes('è¨­å®š') && !link.nextElementSibling?.textContent?.includes('å ±é…¬ç‡')) {
                link.insertAdjacentHTML('afterend', desktopLinkHTML);
            }
        });
        
        // æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„
        const mobileSettingsLinks = document.querySelectorAll('a.mobile-nav-link');
        mobileSettingsLinks.forEach(function(link) {
            if (link.textContent.includes('è¨­å®š') && !link.nextElementSibling?.textContent?.includes('å ±é…¬ç‡')) {
                link.insertAdjacentHTML('afterend', mobileLinkHTML);
            }
        });
        
        // ä¹Ÿå¯ä»¥åœ¨å„€è¡¨æ¿å€åŸŸåŠ å…¥å¿«æ·å…¥å£
        addDashboardQuickAccess();
        
        console.log('âœ… å ±é…¬ç‡æ¯”è¼ƒé€£çµå·²æ³¨å…¥');
    }
    
    function addDashboardQuickAccess() {
        // æ‰¾åˆ°å„€è¡¨æ¿å€å¡Š
        const dashboardSection = document.getElementById('section-dashboard');
        if (!dashboardSection) return;
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å¿«æ·å…¥å£
        if (dashboardSection.querySelector('.compare-quick-access')) return;
        
        // åœ¨å„€è¡¨æ¿é–‹é ­åŠ å…¥å¿«æ·å¡ç‰‡
        const quickAccessHTML = `
            <div class="compare-quick-access bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-4 mb-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-lg">ğŸ† å ±é…¬ç‡æ¯”è¼ƒ</h3>
                        <p class="text-indigo-100 text-sm">æ¯”è¼ƒè‚¡ç¥¨ã€åŠ å¯†è²¨å¹£çš„å¹´åŒ–å ±é…¬</p>
                    </div>
                    <a href="/static/compare.html" 
                       class="px-4 py-2 bg-white text-indigo-600 rounded-lg font-medium hover:bg-indigo-50 transition">
                        ç«‹å³æ¯”è¼ƒ â†’
                    </a>
                </div>
            </div>
        `;
        
        // æ‰¾åˆ°ç¬¬ä¸€å€‹å­å…ƒç´ ä¸¦åœ¨å‰é¢æ’å…¥
        const firstChild = dashboardSection.querySelector('h2');
        if (firstChild && firstChild.nextElementSibling) {
            firstChild.nextElementSibling.insertAdjacentHTML('beforebegin', quickAccessHTML);
        }
    }
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/compare.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±é…¬ç‡æ¯”è¼ƒ - SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <style>
        :root {
            --brand-orange: #FA7A35;
        }
        .brand-orange { background-color: var(--brand-orange); }
        .brand-orange:hover { background-color: #e86a25; }
        .brand-text { color: var(--brand-orange); }
        .brand-border { border-color: var(--brand-orange); }
        
        .cagr-positive { color: #16a34a; }
        .cagr-negative { color: #dc2626; }
        .cagr-neutral { color: #6b7280; }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%); }
        
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .symbol-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            border-radius: 9999px;
            margin: 0.25rem;
        }
        .symbol-tag button {
            margin-left: 0.5rem;
            color: #9ca3af;
        }
        .symbol-tag button:hover {
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-slate-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="/static/dashboard.html" class="flex items-center space-x-2">
                        <img src="/static/logo.png" alt="SELA" class="w-10 h-10 rounded-lg">
                        <span class="font-bold text-xl">SELA</span>
                    </a>
                    <span class="text-gray-400">|</span>
                    <span class="text-lg">ğŸ“Š å ±é…¬ç‡æ¯”è¼ƒ</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/static/dashboard.html" class="text-gray-300 hover:text-white">
                        â† è¿”å›å„€è¡¨æ¿
                    </a>
                    <span id="userName" class="text-gray-300"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹ -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- èªªæ˜å¡ç‰‡ -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-6 mb-6 text-white">
            <h1 class="text-2xl font-bold mb-2">ğŸ† å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒå™¨</h1>
            <p class="text-blue-100">æ¯”è¼ƒè‚¡ç¥¨ã€åŠ å¯†è²¨å¹£ã€æŒ‡æ•¸çš„é•·æœŸæŠ•è³‡å ±é…¬è¡¨ç¾ï¼Œæ‰¾å‡ºæœ€ä½³æŠ•è³‡æ¨™çš„</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šé¸æ“‡æ¨™çš„ -->
            <div class="lg:col-span-1 space-y-4">
                <!-- å¿«é€Ÿé¸æ“‡é è¨­çµ„åˆ -->
                <div class="bg-white rounded-xl shadow p-4">
                    <h3 class="font-bold text-gray-700 mb-3">ğŸš€ å¿«é€Ÿæ¯”è¼ƒ</h3>
                    <div class="space-y-2" id="presetList">
                        <p class="text-gray-400 text-sm">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- è‡ªè¨‚æ¨™çš„ -->
                <div class="bg-white rounded-xl shadow p-4">
                    <h3 class="font-bold text-gray-700 mb-3">âœï¸ è‡ªè¨‚æ¯”è¼ƒ</h3>
                    
                    <!-- å·²é¸æ¨™çš„ -->
                    <div class="mb-3">
                        <label class="text-sm text-gray-500 mb-1 block">å·²é¸æ¨™çš„ (æœ€å¤š5å€‹)</label>
                        <div id="selectedSymbols" class="min-h-[40px] p-2 bg-gray-50 rounded-lg flex flex-wrap">
                            <span class="text-gray-400 text-sm">å°šæœªé¸æ“‡</span>
                        </div>
                    </div>
                    
                    <!-- è¼¸å…¥æ¡† -->
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="symbolInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ AAPL, BTC)"
                            class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                            onkeypress="if(event.key==='Enter') addSymbol()">
                        <button onclick="addSymbol()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- æ™‚é–“é€±æœŸ -->
                    <div class="mb-3">
                        <label class="text-sm text-gray-500 mb-1 block">æ¯”è¼ƒé€±æœŸ</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="1y" checked> 1å¹´
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="3y" checked> 3å¹´
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="5y" checked> 5å¹´
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="period-check mr-1" value="10y"> 10å¹´
                            </label>
                        </div>
                    </div>
                    
                    <!-- åŸºæº–æŒ‡æ•¸ -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 mb-1 block">åŸºæº–æŒ‡æ•¸</label>
                        <select id="benchmarkSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="^GSPC">S&P 500</option>
                            <option value="^IXIC">ç´æ–¯é”å…‹</option>
                            <option value="^DJI">é“ç“Šå·¥æ¥­</option>
                            <option value="">ç„¡</option>
                        </select>
                    </div>
                    
                    <!-- æ’åº -->
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 mb-1 block">æ’åºä¾æ“š</label>
                        <select id="sortBySelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="1y">1å¹´å ±é…¬ç‡</option>
                            <option value="3y">3å¹´å ±é…¬ç‡</option>
                            <option value="5y" selected>5å¹´å ±é…¬ç‡</option>
                            <option value="10y">10å¹´å ±é…¬ç‡</option>
                        </select>
                    </div>
                    
                    <!-- åŸ·è¡Œæ¯”è¼ƒæŒ‰éˆ• -->
                    <button onclick="runComparison()" id="compareBtn"
                        class="w-full py-3 brand-orange text-white rounded-lg font-bold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chart-bar mr-2"></i>é–‹å§‹æ¯”è¼ƒ
                    </button>
                </div>
                
                <!-- æˆ‘çš„çµ„åˆ -->
                <div class="bg-white rounded-xl shadow p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-700">ğŸ’¾ æˆ‘çš„çµ„åˆ</h3>
                        <button onclick="saveCurrentComparison()" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-save mr-1"></i>å„²å­˜ç›®å‰
                        </button>
                    </div>
                    <div id="savedComparisons" class="space-y-2">
                        <p class="text-gray-400 text-sm">ç™»å…¥å¾Œå¯å„²å­˜çµ„åˆ</p>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šæ¯”è¼ƒçµæœ -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 text-lg">ğŸ“Š æ¯”è¼ƒçµæœ</h3>
                        <span id="resultTime" class="text-sm text-gray-400"></span>
                    </div>
                    
                    <div id="comparisonResult">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-chart-line text-6xl mb-4"></i>
                            <p>é¸æ“‡æ¨™çš„å¾Œé»æ“Šã€Œé–‹å§‹æ¯”è¼ƒã€</p>
                            <p class="text-sm mt-2">æˆ–ä½¿ç”¨å·¦å´çš„å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        const API_BASE = '';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // é¸ä¸­çš„æ¨™çš„
        let selectedSymbols = [];
        
        // æª¢æŸ¥ç™»å…¥
        if (token && user.display_name) {
            document.getElementById('userName').textContent = user.display_name;
        }
        
        // ==================== é è¨­çµ„åˆ ====================
        async function loadPresets() {
            try {
                const res = await fetch(`${API_BASE}/api/compare/presets`);
                const data = await res.json();
                
                if (data.success) {
                    const container = document.getElementById('presetList');
                    container.innerHTML = data.presets.map(preset => `
                        <button onclick="quickCompare('${preset.id}')" 
                            class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition flex justify-between items-center">
                            <span>${preset.name}</span>
                            <span class="text-xs text-gray-400">${preset.count}å€‹</span>
                        </button>
                    `).join('');
                }
            } catch (e) {
                console.error('è¼‰å…¥é è¨­çµ„åˆå¤±æ•—', e);
            }
        }
        
        async function quickCompare(presetId) {
            showLoading();
            try {
                const benchmark = document.getElementById('benchmarkSelect').value;
                const sortBy = document.getElementById('sortBySelect').value;
                
                const res = await fetch(`${API_BASE}/api/compare/quick/${presetId}?benchmark=${benchmark}&sort_by=${sortBy}`);
                const data = await res.json();
                
                if (data.success) {
                    // æ›´æ–°é¸ä¸­çš„æ¨™çš„
                    if (data.preset && data.preset.symbols) {
                        selectedSymbols = data.preset.symbols;
                        renderSelectedSymbols();
                    }
                    renderResult(data);
                } else {
                    showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + e.message);
            }
        }
        
        // ==================== æ¨™çš„é¸æ“‡ ====================
        function addSymbol() {
            const input = document.getElementById('symbolInput');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) return;
            
            if (selectedSymbols.length >= 5) {
                showToast('æœ€å¤šåªèƒ½é¸æ“‡ 5 å€‹æ¨™çš„');
                return;
            }
            
            if (selectedSymbols.includes(symbol)) {
                showToast('å·²ç¶“é¸æ“‡éæ­¤æ¨™çš„');
                return;
            }
            
            selectedSymbols.push(symbol);
            renderSelectedSymbols();
            input.value = '';
        }
        
        function removeSymbol(symbol) {
            selectedSymbols = selectedSymbols.filter(s => s !== symbol);
            renderSelectedSymbols();
        }
        
        function renderSelectedSymbols() {
            const container = document.getElementById('selectedSymbols');
            
            if (selectedSymbols.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm">å°šæœªé¸æ“‡</span>';
                return;
            }
            
            container.innerHTML = selectedSymbols.map(symbol => `
                <span class="symbol-tag">
                    ${symbol}
                    <button onclick="removeSymbol('${symbol}')" title="ç§»é™¤">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }
        
        // ==================== åŸ·è¡Œæ¯”è¼ƒ ====================
        async function runComparison() {
            if (selectedSymbols.length === 0) {
                showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™çš„');
                return;
            }
            
            showLoading();
            
            // å–å¾—å‹¾é¸çš„é€±æœŸ
            const periods = Array.from(document.querySelectorAll('.period-check:checked'))
                .map(cb => cb.value);
            
            if (periods.length === 0) {
                showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ™‚é–“é€±æœŸ');
                return;
            }
            
            const benchmark = document.getElementById('benchmarkSelect').value;
            const sortBy = document.getElementById('sortBySelect').value;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/cagr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({
                        symbols: selectedSymbols,
                        periods: periods,
                        benchmark: benchmark,
                        sort_by: sortBy,
                        sort_order: 'desc'
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    renderResult(data);
                } else {
                    showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + (data.detail || data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    document.getElementById('comparisonResult').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                            <p>${data.detail || data.error || 'æ¯”è¼ƒå¤±æ•—'}</p>
                        </div>
                    `;
                }
            } catch (e) {
                showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + e.message);
            }
        }
        
        function showLoading() {
            document.getElementById('comparisonResult').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-gray-500">æ­£åœ¨è¨ˆç®—å ±é…¬ç‡...</p>
                    <p class="text-gray-400 text-sm mt-1">é¦–æ¬¡æŸ¥è©¢å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“</p>
                </div>
            `;
        }
        
        // ==================== æ¸²æŸ“çµæœ ====================
        function renderResult(data) {
            const container = document.getElementById('comparisonResult');
            const periods = data.periods || ['1y', '3y', '5y'];
            
            // æ›´æ–°æ™‚é–“
            if (data.generated_at) {
                const time = new Date(data.generated_at).toLocaleString('zh-TW');
                document.getElementById('resultTime').textContent = `æ›´æ–°ï¼š${time}`;
            }
            
            // å»ºç«‹è¡¨æ ¼
            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ’å</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ¨™çš„</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ç¾åƒ¹</th>
                                ${periods.map(p => `
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">${formatPeriod(p)}</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;
            
            data.comparison.forEach((item, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                const typeIcon = item.type === 'crypto' ? 'ğŸª™' : item.type === 'index' ? 'ğŸ“ˆ' : 'ğŸ“Š';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${rankClass} font-bold text-sm">
                                ${rankIcon}
                            </span>
                        </td>
                        <td class="px-4 py-4">
                            <div class="flex items-center">
                                <span class="mr-2">${typeIcon}</span>
                                <div>
                                    <div class="font-medium text-gray-900">${item.symbol}</div>
                                    <div class="text-xs text-gray-500">${item.name || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-right">
                            ${item.current_price ? `$${formatNumber(item.current_price)}` : '--'}
                        </td>
                        ${periods.map(p => {
                            const cagr = item.cagr ? item.cagr[p] : null;
                            const vsBench = item.vs_benchmark ? item.vs_benchmark[p] : null;
                            return `
                                <td class="px-4 py-4 text-right">
                                    ${formatCAGR(cagr)}
                                    ${vsBench !== null && vsBench !== undefined ? `
                                        <div class="text-xs ${vsBench >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${vsBench >= 0 ? '+' : ''}${vsBench.toFixed(1)}%
                                        </div>
                                    ` : ''}
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // åŸºæº–æŒ‡æ•¸è³‡è¨Š
            if (data.benchmark) {
                html += `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <span class="text-sm text-gray-500">ğŸ“Œ åŸºæº–æŒ‡æ•¸ï¼š</span>
                        <span class="font-medium">${data.benchmark.name} (${data.benchmark.symbol})</span>
                        <span class="ml-4 text-sm text-gray-500">
                            ${periods.map(p => `${formatPeriod(p)}: ${formatCAGR(data.benchmark.cagr[p], true)}`).join(' | ')}
                        </span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function formatPeriod(period) {
            const map = { '1y': '1å¹´', '3y': '3å¹´', '5y': '5å¹´', '10y': '10å¹´', 'custom': 'è‡ªè¨‚' };
            return map[period] || period;
        }
        
        function formatCAGR(value, simple = false) {
            if (value === null || value === undefined) {
                return '<span class="text-gray-400">--</span>';
            }
            
            const colorClass = value > 0 ? 'cagr-positive' : value < 0 ? 'cagr-negative' : 'cagr-neutral';
            const sign = value > 0 ? '+' : '';
            
            if (simple) {
                return `<span class="${colorClass}">${sign}${value.toFixed(1)}%</span>`;
            }
            
            return `<span class="${colorClass} font-medium text-lg">${sign}${value.toFixed(1)}%</span>`;
        }
        
        function formatNumber(num) {
            if (num >= 1000) {
                return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return num.toFixed(2);
        }
        
        // ==================== å„²å­˜çµ„åˆ ====================
        async function saveCurrentComparison() {
            if (!token) {
                showToast('è«‹å…ˆç™»å…¥');
                return;
            }
            
            if (selectedSymbols.length === 0) {
                showToast('è«‹å…ˆé¸æ“‡æ¨™çš„');
                return;
            }
            
            const name = prompt('è«‹è¼¸å…¥çµ„åˆåç¨±ï¼š');
            if (!name) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/saved`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name: name,
                        symbols: selectedSymbols,
                        benchmark: document.getElementById('benchmarkSelect').value
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('çµ„åˆå·²å„²å­˜');
                    loadSavedComparisons();
                } else {
                    showToast('å„²å­˜å¤±æ•—ï¼š' + (data.detail || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                showToast('å„²å­˜å¤±æ•—ï¼š' + e.message);
            }
        }
        
        async function loadSavedComparisons() {
            if (!token) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/saved`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success && data.comparisons.length > 0) {
                    const container = document.getElementById('savedComparisons');
                    container.innerHTML = data.comparisons.map(c => `
                        <div class="flex justify-between items-center p-2 rounded hover:bg-gray-50">
                            <button onclick="loadSavedComparison(${c.id}, ${JSON.stringify(c.symbols).replace(/"/g, '&quot;')})" 
                                class="text-left flex-1">
                                <div class="font-medium text-sm">${c.name}</div>
                                <div class="text-xs text-gray-400">${c.symbols.join(', ')}</div>
                            </button>
                            <button onclick="deleteSavedComparison(${c.id})" class="text-red-400 hover:text-red-600 ml-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('è¼‰å…¥å„²å­˜çµ„åˆå¤±æ•—', e);
            }
        }
        
        function loadSavedComparison(id, symbols) {
            selectedSymbols = symbols;
            renderSelectedSymbols();
            runComparison();
        }
        
        async function deleteSavedComparison(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤çµ„åˆï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/compare/saved/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('å·²åˆªé™¤');
                    loadSavedComparisons();
                }
            } catch (e) {
                showToast('åˆªé™¤å¤±æ•—');
            }
        }
        
        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        
        // ==================== åˆå§‹åŒ– ====================
        loadPresets();
        if (token) {
            loadSavedComparisons();
        }
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/css/dashboard.css  â­
> å¼·åˆ¶ hidden class ç”Ÿæ•ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸ åƒ…é¡¯ç¤ºå‰ 150 è¡Œ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/css/settings.css  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸ åƒ…é¡¯ç¤ºå‰ 150 è¡Œ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/dashboard.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body class="bg-gray-100">
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center z-50">
        <div class="text-center">
            <img src="/static/logo.png" alt="SELA" class="w-24 h-24 mx-auto mb-4 rounded-xl">
            <p class="text-white text-lg">è¼‰å…¥ä¸­...</p>
            <i class="fas fa-spinner fa-spin text-white text-2xl mt-4"></i>
        </div>
    </div>
    <div id="app-content">
        
        <div id="sidebarOverlay" class="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>
        
        <aside id="mobileSidebar" class="mobile-sidebar">
            <div class="p-4 border-b flex items-center justify-between">
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-10 h-10 rounded-lg mr-2">
                    <span class="font-bold text-lg">SELA</span>
                </div>
                <button onclick="closeMobileSidebar()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#" onclick="mobileNavTo('dashboard')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-700 bg-blue-50 rounded-lg touch-target" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3 w-5"></i>
                    <span>å„€è¡¨æ¿</span>
                </a>
                <a href="#" onclick="mobileNavTo('search')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="search">
                    <i class="fas fa-search mr-3 w-5"></i>
                    <span>è‚¡ç¥¨æŸ¥è©¢</span>
                </a>
                <a href="#" onclick="mobileNavTo('watchlist')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="watchlist">
                    <i class="fas fa-star mr-3 w-5"></i>
                    <span>è¿½è¹¤æ¸…å–®</span>
                </a>
                <a href="#" onclick="mobileNavTo('sentiment')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="sentiment">
                    <i class="fas fa-heart-pulse mr-3 w-5"></i>
                    <span>ææ‡¼è²ªå©ª</span>
                </a>
                <a href="#" onclick="mobileNavTo('compare')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="compare">
                    <i class="fas fa-chart-line mr-3 w-5"></i>
                    <span>èµ°å‹¢æ¯”è¼ƒ</span>
                </a>
                <a href="#" onclick="mobileNavTo('portfolio')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="portfolio">
                    <i class="fas fa-wallet mr-3 w-5"></i>
                    <span>å€‹äººæŠ•è³‡è¨˜éŒ„</span>
                </a>
                <a href="#" onclick="mobileNavTo('subscription')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="subscription">
                    <i class="fas fa-satellite-dish mr-3 w-5"></i>
                    <span>è¨‚é–±ç²¾é¸</span>
                </a>
                <a href="#" onclick="mobileNavTo('cagr')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="cagr">
                    <i class="fas fa-trophy mr-3 w-5"></i>
                    <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
                </a>
                <a href="#" onclick="mobileNavTo('settings')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="settings">
                    <i class="fas fa-cog mr-3 w-5"></i>
                    <span>è¨­å®š</span>
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <img id="sidebarAvatar" class="w-10 h-10 rounded-full mr-3" src="" alt="">
                        <span id="sidebarUserName" class="text-gray-700 font-medium"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-400 mb-2">
                    é–’ç½®ç™»å‡º: <span id="sidebarTimer">5:00</span>
                </div>
                <button onclick="logout()" class="w-full py-2 text-red-500 hover:bg-red-50 rounded-lg flex items-center justify-center touch-target">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>ç™»å‡º</span>
                </button>
            </div>
        </aside>
        
        <nav class="top-nav bg-white shadow-sm border-b">
            <div class="px-4 h-14 flex items-center justify-between">
                <button onclick="openMobileSidebar()" class="mobile-header-menu p-2 -ml-2 text-gray-600 touch-target">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-8 h-8 rounded-lg mr-2">
                    <span class="font-bold text-lg text-gray-800 hidden sm:inline">è‡ªå‹•é¸è‚¡ç³»çµ±</span>
                    <span class="font-bold text-lg text-gray-800 sm:hidden">SELA</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <span id="sessionTimer" class="text-xs text-gray-400 hidden sm:inline"></span>
                    <a id="adminLink" href="#" onclick="showSection('admin', event)" class="text-orange-500 hover:text-orange-600 hidden p-2" title="ç®¡ç†å¾Œå°">
                        <i class="fas fa-user-shield"></i>
                    </a>
                    <span id="userName" class="text-gray-600 text-sm hidden md:inline"></span>
                    <img id="userAvatar" class="w-8 h-8 rounded-full" src="" alt="">
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 hidden sm:inline p-2" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>
        <aside class="desktop-sidebar bg-white shadow-sm">
            <nav class="p-4 space-y-2">
                <a href="#" onclick="showSection('dashboard', event)" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-blue-50 rounded-lg" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>å„€è¡¨æ¿</span>
                </a>
                <a href="#" onclick="showSection('search', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="search">
                    <i class="fas fa-search mr-3"></i>
                    <span>è‚¡ç¥¨æŸ¥è©¢</span>
                </a>
                <a href="#" onclick="showSection('watchlist', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="watchlist">
                    <i class="fas fa-star mr-3"></i>
                    <span>è¿½è¹¤æ¸…å–®</span>
                </a>
                <a href="#" onclick="showSection('sentiment', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="sentiment">
                    <i class="fas fa-heart-pulse mr-3"></i>
                    <span>ææ‡¼è²ªå©ª</span>
                </a>
                <a href="#" onclick="showSection('compare', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="compare">
                    <i class="fas fa-chart-line mr-3"></i>
                    <span>èµ°å‹¢æ¯”è¼ƒ</span>
                </a>
                <a href="#" onclick="showSection('portfolio', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="portfolio">
                    <i class="fas fa-wallet mr-3"></i>
                    <span>å€‹äººæŠ•è³‡è¨˜éŒ„</span>
                </a>
                <a href="#" onclick="showSection('subscription', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="subscription">
                    <i class="fas fa-satellite-dish mr-3"></i>
                    <span>è¨‚é–±ç²¾é¸</span>
                </a>
                <a href="#" onclick="showSection('cagr', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="cagr">
                    <i class="fas fa-trophy mr-3"></i>
                    <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
                </a>
                <a href="#" onclick="showSection('settings', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="settings">
                    <i class="fas fa-cog mr-3"></i>
                    <span>è¨­å®š</span>
                </a>
                <a id="adminSidebarLink" href="#" onclick="showSection('admin', event)" class="hidden flex items-center px-4 py-2 text-orange-500 hover:bg-orange-50 rounded-lg mt-4 border-t pt-4" data-section="admin">
                    <i class="fas fa-user-shield mr-3"></i>
                    <span>ç®¡ç†å¾Œå°</span>
                </a>
            </nav>
        </aside>
        <main class="main-content">
            
            <section id="section-dashboard" class="section">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">å„€è¡¨æ¿</h2>
                
                <div class="mb-4 md:mb-6">
                    <div id="btc-price-card" class="bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl p-4 md:p-5 text-white shadow-lg cursor-pointer hover:shadow-xl transition-all duration-300 relative overflow-hidden" onclick="showSection('search', event); setTimeout(() => { document.getElementById('searchSymbol').value='BTC'; searchStock(); }, 100);">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <i class="fab fa-bitcoin text-xl"></i>
                                    <span class="text-sm font-medium opacity-90">Bitcoin</span>
                                    <span id="btc-update-indicator" class="w-2 h-2 rounded-full bg-white/50 animate-pulse hidden"></span>
                                </div>
                                <div class="text-2xl md:text-3xl font-bold truncate" id="btc-price">$--,---</div>
                            </div>
                            <div class="text-right flex-shrink-0 ml-3">
                                <div class="text-lg md:text-xl font-semibold" id="btc-change">--%</div>
                                <div class="text-xs opacity-75">24h</div>
                            </div>
                            <div class="ml-3 md:ml-4 flex-shrink-0 opacity-20">
                                <i class="fab fa-bitcoin text-5xl md:text-6xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 md:mb-6">
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^GSPC', 'S&P 500')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-line text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">S&P 500</h3>
                                    <p class="text-xs text-gray-400">^GSPC</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-GSPC-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-GSPC-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-GSPC-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^DJI', 'é“ç“Šå·¥æ¥­')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-industry text-green-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">é“ç“Šå·¥æ¥­</h3>
                                    <p class="text-xs text-gray-400">^DJI</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-DJI-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-DJI-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-DJI-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^IXIC', 'ç´æ–¯é”å…‹')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-microchip text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">ç´æ–¯é”å…‹</h3>
                                    <p class="text-xs text-gray-400">^IXIC</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-IXIC-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-IXIC-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-IXIC-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('^TWII', 'å°è‚¡åŠ æ¬Š')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-landmark text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-700 text-sm">å°è‚¡åŠ æ¬Š</h3>
                                    <p class="text-xs text-gray-400">^TWII</p>
                                </div>
                            </div>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span id="index-TWII-price" class="text-xl font-bold text-gray-800">--</span>
                            <span id="index-TWII-change" class="text-sm font-medium">--</span>
                        </div>
                        <p id="index-TWII-date" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                    <div class="bg-white rounded-xl shadow p-4 md:p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="openSentimentModal('stock', 'ç¾è‚¡ææ‡¼è²ªå©ªæŒ‡æ•¸')">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700 text-sm md:text-base">
                                <i class="fas fa-flag-usa mr-2 text-blue-500"></i>ç¾è‚¡ææ‡¼è²ªå©ªæŒ‡æ•¸
                            </h3>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="fear-greed-gauge" id="stockGauge">
                            <svg viewBox="0 0 200 115" class="gauge-svg">
                                <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                                <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                                <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                                <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                                <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                                <text x="8" y="105" class="gauge-tick-text">0</text>
                                <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                                <text x="188" y="105" class="gauge-tick-text">100</text>
                                <g id="stockNeedleGroup" class="gauge-needle-group">
                                    <polygon class="gauge-needle" points="100,25 97,100 103,100" />
                                </g>
                                <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                            </svg>
                        </div>
                        <div class="text-center mt-2">
                            <span id="stockGaugeValue" class="text-4xl font-bold text-gray-800">--</span>
                        </div>
                        <p id="stockSentimentStatus" class="text-center font-semibold text-lg mt-1"></p>
                        <p id="stockSentimentTime" class="text-xs text-gray-400 text-center mt-1"></p>
                        <p class="text-xs text-blue-500 text-center mt-2"><i class="fas fa-chart-line mr-1"></i>é»æ“ŠæŸ¥çœ‹èµ°å‹¢</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4 md:p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="openSentimentModal('crypto', 'å¹£åœˆææ‡¼è²ªå©ªæŒ‡æ•¸')">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700 text-sm md:text-base">
                                <i class="fab fa-bitcoin mr-2 text-orange-500"></i>å¹£åœˆææ‡¼è²ªå©ªæŒ‡æ•¸
                            </h3>
                            <i class="fas fa-chart-area text-gray-300"></i>
                        </div>
                        <div class="fear-greed-gauge" id="cryptoGauge">
                            <svg viewBox="0 0 200 115" class="gauge-svg">
                                <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                                <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                                <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                                <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                                <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                                <text x="8" y="105" class="gauge-tick-text">0</text>
                                <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                                <text x="188" y="105" class="gauge-tick-text">100</text>
                                <g id="cryptoNeedleGroup" class="gauge-needle-group">
                                    <polygon class="gauge-needle" points="100,25 97,100 103,100" />
                                </g>
                                <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                            </svg>
                        </div>
                        <div class="text-center mt-2">
                            <span id="cryptoGaugeValue" class="text-4xl font-bold text-gray-800">--</span>
                        </div>
                        <p id="cryptoSentimentStatus" class="text-center font-semibold text-lg mt-1"></p>
                        <p id="cryptoSentimentTime" class="text-xs text-gray-400 text-center mt-1"></p>
                        <p class="text-xs text-blue-500 text-center mt-2"><i class="fas fa-chart-line mr-1"></i>é»æ“ŠæŸ¥çœ‹èµ°å‹¢</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-700">è¿½è¹¤æ¸…å–®</h3>
                        <a href="#" onclick="showSection('watchlist')" class="text-blue-600 text-sm hover:underline">æŸ¥çœ‹å…¨éƒ¨</a>
                    </div>
                    <div id="dashboardWatchlist">
                        <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </section>
            <section id="section-search" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">è‚¡ç¥¨æŸ¥è©¢</h2>
                
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4 md:mb-6">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="searchSymbol" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ˆå¦‚ AAPLã€2330ï¼‰" 
                            class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                            onkeypress="if(event.key==='Enter')searchStock()">
                        <button onclick="searchStock()" class="brand-orange text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center touch-target">
                            <i class="fas fa-search mr-2"></i>
                            <span>æŸ¥è©¢</span>
                        </button>
                    </div>
                    <p class="text-gray-500 text-xs md:text-sm mt-2">æ”¯æ´ç¾è‚¡ã€å°è‚¡ (è¼¸å…¥ç´”æ•¸å­—å¦‚ 2330) åŠåŠ å¯†è²¨å¹£ (BTC, ETH)</p>
                </div>
                
                <div id="searchResult" class="hidden"></div>
            </section>
            <section id="section-watchlist" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">è¿½è¹¤æ¸…å–®</h2>
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <button onclick="toggleWatchlistMenu()" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-lg border hover:bg-gray-50" title="åŒ¯å‡ºåŒ¯å…¥">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <div id="watchlistMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50">
                                <button onclick="exportWatchlist('json')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-download mr-2 text-blue-500"></i>åŒ¯å‡º JSON
                                </button>
                                <button onclick="exportWatchlist('csv')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv mr-2 text-green-500"></i>åŒ¯å‡º CSV
                                </button>
                                <hr class="my-1">
                                <button onclick="showImportWatchlistModal()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                    <i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥æ¸…å–®
                                </button>
                            </div>
                        </div>
                        <button onclick="showAddWatchlistModal()" class="brand-orange text-white px-4 py-2 rounded-lg font-medium flex items-center touch-target">
                            <i class="fas fa-plus mr-2"></i>
                            <span class="hidden sm:inline">æ–°å¢</span>
                        </button>
                    </div>
                </div>
                <div id="watchlistContent">
                    <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </section>
            <section id="section-sentiment" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">ææ‡¼è²ªå©ªæŒ‡æ•¸</h2>
                <div id="sentimentContent">
                    <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </section>
            <section id="section-compare" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">èµ°å‹¢æ¯”è¼ƒ</h2>
                
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-blue-500"></i>
                        é¸æ“‡æ¯”è¼ƒæ¨™çš„
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæˆ–æŒ‡æ•¸ï¼ˆæœ€å¤š 5 å€‹ï¼‰ï¼Œä»¥é€—è™Ÿåˆ†éš”</p>
                    
                    <div class="mb-4">
                        <span class="text-sm text-gray-600 mr-2">å¿«é€Ÿé¸æ“‡ï¼š</span>
                        <button onclick="addCompareSymbol('^GSPC')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">S&P 500</button>
                        <button onclick="addCompareSymbol('^DJI')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">é“ç“Š</button>
                        <button onclick="addCompareSymbol('^IXIC')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">ç´æ–¯é”å…‹</button>
                        <button onclick="addCompareSymbol('^TWII')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">å°è‚¡åŠ æ¬Š</button>
                        <button onclick="addCompareSymbol('AAPL')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">AAPL</button>
                        <button onclick="addCompareSymbol('MSFT')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">MSFT</button>
                        <button onclick="addCompareSymbol('NVDA')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">NVDA</button>
                        <button onclick="addCompareSymbol('TSLA')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">TSLA</button>
                        <button onclick="addCompareSymbol('2330.TW')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">å°ç©é›»</button>
                        <button onclick="addCompareSymbol('2317.TW')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">é´»æµ·</button>
                        <button onclick="addCompareSymbol('BTC-USD')" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded mr-1 mb-1">BTC</button>
                        <button onclick="addCompareSymbol('ETH-USD')" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded mr-1 mb-1">ETH</button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="compareSymbols" placeholder="ä¾‹: AAPL, MSFT, ^GSPC" 
                               class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <select id="compareDays" class="px-4 py-2 border rounded-lg bg-white">
                            <option value="30">1 å€‹æœˆ</option>
                            <option value="90" selected>3 å€‹æœˆ</option>
                            <option value="180">6 å€‹æœˆ</option>
                            <option value="365">1 å¹´</option>
                        </select>
                        <button onclick="loadCompareChart()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-chart-line mr-2"></i>æ¯”è¼ƒ
                        </button>
                    </div>
                    
                    <div id="selectedSymbols" class="flex flex-wrap gap-2 mt-3"></div>
                </div>
                
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <div id="compareChartContainer" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-chart-line mr-2 text-green-500"></i>
                                èµ°å‹¢æ¯”è¼ƒåœ–
                            </h3>
                            <span class="text-sm text-gray-500">èµ·å§‹æ—¥ = 100%</span>
                        </div>
                        <div class="relative" style="height: 400px;">
                            <canvas id="compareChart"></canvas>
                        </div>
                    </div>
                    <div id="compareChartPlaceholder" class="text-center py-12">
                        <i class="fas fa-chart-line text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">é¸æ“‡æ¨™çš„å¾Œé¡¯ç¤ºæ¯”è¼ƒåœ–è¡¨</p>
                    </div>
                    <div id="compareChartLoading" class="hidden text-center py-12">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-4"></i>
                        <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
                
                <div id="compareResultTable" class="bg-white rounded-xl shadow p-4 md:p-6 hidden">
                    <h3 class="font-semibold text-gray-700 mb-4">
                        <i class="fas fa-table mr-2 text-purple-500"></i>
                        æ¯”è¼ƒçµæœ
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-2 px-3">æ¨™çš„</th>
                                    <th class="text-right py-2 px-3">èµ·å§‹åƒ¹</th>
                                    <th class="text-right py-2 px-3">æœ€æ–°åƒ¹</th>
                                    <th class="text-right py-2 px-3">æ¼²è·Œå¹…</th>
                                </tr>
                            </thead>
                            <tbody id="compareTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="section-portfolio" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">å€‹äººæŠ•è³‡è¨˜éŒ„</h2>
                    <div class="relative">
                        <button onclick="togglePortfolioMenu()" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-lg border hover:bg-gray-50" title="åŒ¯å‡ºåŒ¯å…¥">
                            <i class="fas fa-exchange-alt mr-1"></i>
                            <span class="hidden sm:inline text-sm">åŒ¯å‡ºåŒ¯å…¥</span>
                        </button>
                        <div id="portfolioMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border z-50">
                            <div class="px-3 py-2 text-xs text-gray-400 border-b">åŒ¯å‡ºäº¤æ˜“ç´€éŒ„</div>
                            <button onclick="exportPortfolio('json', null)" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-download mr-2 text-blue-500"></i>å…¨éƒ¨ (JSON)
                            </button>
                            <button onclick="exportPortfolio('csv', 'tw')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-file-csv mr-2 text-red-500"></i>å°è‚¡ (CSV)
                            </button>
                            <button onclick="exportPortfolio('csv', 'us')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-file-csv mr-2 text-blue-500"></i>ç¾è‚¡ (CSV)
                            </button>
                            <hr class="my-1">
                            <div class="px-3 py-2 text-xs text-gray-400 border-b">åŒ¯å…¥äº¤æ˜“ç´€éŒ„</div>
                            <button onclick="showImportPortfolioModal()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                                <i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥ç´€éŒ„
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3 mb-4 md:mb-6">
                    <div class="bg-gradient-to-r from-red-500 to-rose-500 rounded-xl p-4 text-white">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-landmark mr-2"></i>
                            <h3 class="font-semibold">å°è‚¡</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ç¾å€¼</p>
                                <p id="twCurrentValue" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">æç›Š</p>
                                <p id="twProfit" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">å ±é…¬ç‡</p>
                                <p id="twReturnRate" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">æŒè‚¡æ•¸</p>
                                <p id="twPositions" class="font-bold">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-4 text-white">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-flag-usa mr-2"></i>
                            <h3 class="font-semibold">ç¾è‚¡</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ç¾å€¼ (USD)</p>
                                <p id="usCurrentValue" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">æç›Š</p>
                                <p id="usProfit" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">å ±é…¬ç‡</p>
                                <p id="usReturnRate" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">æŒè‚¡æ•¸</p>
                                <p id="usPositions" class="font-bold">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-600 to-violet-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <i class="fas fa-calculator mr-2"></i>
                                <h3 class="font-semibold">åˆè¨ˆ (TWD)</h3>
                            </div>
                            <div class="text-xs opacity-80">
                                <span>åŒ¯ç‡: 1 USD = </span>
                                <span id="exchangeRateValue">--</span>
                                <span> TWD</span>
                                <span id="exchangeRateTime" class="ml-1 opacity-60"></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ç¸½ç¾å€¼</p>
                                <p id="totalValueTwd" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ç¸½æç›Š</p>
                                <p id="totalProfitTwd" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">å ±é…¬ç‡</p>
                                <p id="totalReturnRate" class="font-bold">--</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2">
                                <p class="text-xs opacity-80">ç¸½æŒè‚¡</p>
                                <p id="totalPositions" class="font-bold">--</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex border-b mb-4 overflow-x-auto">
                    <button onclick="switchPortfolioTab('holdings')" id="tabHoldings" class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap">
                        æŒè‚¡ç¸½è¦½
                    </button>
                    <button onclick="switchPortfolioTab('tw-transactions')" id="tabTwTransactions" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
                        å°è‚¡ç´€éŒ„
                    </button>
                    <button onclick="switchPortfolioTab('us-transactions')" id="tabUsTransactions" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
                        ç¾è‚¡ç´€éŒ„
                    </button>
                </div>
                
                <div id="portfolioHoldings" class="space-y-4">
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-2">
                                    <i class="fas fa-landmark text-red-600 text-sm"></i>
                                </span>
                                <div>
                                    <h3 class="font-semibold text-gray-700">å°è‚¡</h3>
                                    <p id="twSummaryLine" class="text-xs text-gray-500">--</p>
                                </div>
                            </div>
                            <button onclick="showAddTwModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                        <div id="holdingsTW" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-2">
                                    <i class="fas fa-flag-usa text-blue-600 text-sm"></i>
                                </span>
                                <div>
                                    <h3 class="font-semibold text-gray-700">ç¾è‚¡</h3>
                                    <p id="usSummaryLine" class="text-xs text-gray-500">--</p>
                                </div>
                            </div>
                            <button onclick="showAddUsModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                        <div id="holdingsUS" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
                
                <div id="portfolioTwTransactions" class="hidden">
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-landmark text-red-500 mr-2"></i>å°è‚¡äº¤æ˜“ç´€éŒ„
                            </h3>
                            <button onclick="showAddTwModal()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                        <div id="twTransactionList" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
                
                <div id="portfolioUsTransactions" class="hidden">
                    <div class="bg-white rounded-xl shadow p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-flag-usa text-blue-500 mr-2"></i>ç¾è‚¡äº¤æ˜“ç´€éŒ„
                            </h3>
                            <button onclick="showAddUsModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>æ–°å¢
                            </button>
                        </div>
                        <div id="usTransactionList" class="space-y-2">
                            <p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="section-subscription" class="section hidden">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">ğŸ“¡ è¨‚é–±ç²¾é¸</h2>
                    <button onclick="refreshSubscriptionPicks()" class="text-gray-500 hover:text-gray-700 p-2" title="é‡æ–°æ•´ç†">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div id="subscriptionSourcesCard" class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-rss mr-2 text-orange-500"></i>
                        è¨‚é–±ä¾†æº
                    </h3>
                    <div id="subscriptionSourcesList">
                        <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between">
                        <span>
                            <i class="fas fa-fire mr-2 text-red-500"></i>
                            ç²¾é¸è‚¡ç¥¨
                        </span>
                        <span id="subscriptionPicksCount" class="text-sm text-gray-400"></span>
                    </h3>
                    <div id="subscriptionPicksList">
                        <p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </section>
            <section id="section-settings" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">è¨­å®š</h2>
                
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-magic mr-2 text-purple-500"></i>
                        å¿«é€Ÿå¥—ç”¨æ¨¡æ¿
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="templateButtons">
                        <button onclick="applyTemplate('minimal')" data-template="minimal" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all">
                            <i class="fas fa-minus-circle text-gray-400 mr-1"></i>æ¥µç°¡
                        </button>
                        <button onclick="applyTemplate('standard')" data-template="standard" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all border-blue-500 bg-blue-50 text-blue-600">
                            <i class="fas fa-check-circle text-blue-500 mr-1"></i>æ¨™æº–
                        </button>
                        <button onclick="applyTemplate('full')" data-template="full" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all">
                            <i class="fas fa-layer-group text-green-500 mr-1"></i>å®Œæ•´
                        </button>
                        <button onclick="applyTemplate('short_term')" data-template="short_term" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50 transition-all">
                            <i class="fas fa-bolt text-yellow-500 mr-1"></i>çŸ­ç·š
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                        æŒ‡æ¨™é¡¯ç¤ºè¨­å®š
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">é¸æ“‡åœ¨è‚¡ç¥¨åˆ†æä¸­è¦é¡¯ç¤ºçš„æŠ€è¡“æŒ‡æ¨™</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_ma" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">å‡ç·š MA</span>
                                <span class="block text-xs text-gray-500">20/50/200æ—¥</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_rsi" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">RSI</span>
                                <span class="block text-xs text-gray-500">ç›¸å°å¼·å¼±æŒ‡æ¨™</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_macd" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">MACD</span>
                                <span class="block text-xs text-gray-500">æŒ‡æ•¸å¹³æ»‘ç•°åŒ</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_kd" class="indicator-toggle w-5 h-5 text-blue-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">KD</span>
                                <span class="block text-xs text-gray-500">éš¨æ©ŸæŒ‡æ¨™</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_bollinger" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">å¸ƒæ—é€šé“</span>
                                <span class="block text-xs text-gray-500">Bollinger Bands</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_obv" class="indicator-toggle w-5 h-5 text-blue-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">OBV</span>
                                <span class="block text-xs text-gray-500">èƒ½é‡æ½®æŒ‡æ¨™</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="show_volume" class="indicator-toggle w-5 h-5 text-blue-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">æˆäº¤é‡</span>
                                <span class="block text-xs text-gray-500">Volume</span>
                            </span>
                        </label>
                    </div>
                    <button onclick="saveIndicatorSettings()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-save mr-2"></i>å„²å­˜æŒ‡æ¨™è¨­å®š
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-bell mr-2 text-yellow-500"></i>
                        é€šçŸ¥è¨­å®š
                        <span class="ml-2 text-xs text-gray-400">(å³å°‡æ¨å‡º)</span>
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">é¸æ“‡è¦æ¥æ”¶çš„æŠ€è¡“è¨Šè™Ÿé€šçŸ¥</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_ma_cross" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">å‡ç·šäº¤å‰</span>
                                <span class="block text-xs text-gray-500">é»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_ma_breakout" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">å‡ç·šçªç ´</span>
                                <span class="block text-xs text-gray-500">åƒ¹æ ¼ç©¿è¶Šå‡ç·š</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_rsi" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">RSI è¶…è²·è¶…è³£</span>
                                <span class="block text-xs text-gray-500">é€²å…¥æ¥µç«¯å€åŸŸ</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_macd" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">MACD äº¤å‰</span>
                                <span class="block text-xs text-gray-500">DIF ç©¿è¶Š MACD</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_kd" class="alert-toggle w-5 h-5 text-yellow-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">KD äº¤å‰</span>
                                <span class="block text-xs text-gray-500">K ç©¿è¶Š D</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_bollinger" class="alert-toggle w-5 h-5 text-yellow-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">å¸ƒæ—çªç ´</span>
                                <span class="block text-xs text-gray-500">è§¸åŠä¸Šä¸‹è»Œ</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_volume" class="alert-toggle w-5 h-5 text-yellow-600 rounded">
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">é‡èƒ½ç•°å¸¸</span>
                                <span class="block text-xs text-gray-500">æˆäº¤é‡æš´å¢</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="alert_sentiment" class="alert-toggle w-5 h-5 text-yellow-600 rounded" checked>
                            <span class="ml-3">
                                <span class="font-medium text-gray-700">æƒ…ç·’æ¥µç«¯</span>
                                <span class="block text-xs text-gray-500">æ¥µåº¦ææ‡¼/è²ªå©ª</span>
                            </span>
                        </label>
                    </div>
                    <button onclick="saveAlertSettings()" class="mt-4 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                        <i class="fas fa-save mr-2"></i>å„²å­˜é€šçŸ¥è¨­å®š
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-green-500"></i>
                        æŒ‡æ¨™åƒæ•¸èª¿æ•´
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">è‡ªè¨‚æŠ€è¡“æŒ‡æ¨™çš„è¨ˆç®—åƒæ•¸</p>
                    
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">å‡ç·šé€±æœŸ</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">çŸ­æœŸå‡ç·š</label>
                                <input type="number" id="ma_short" value="20" min="5" max="50" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ä¸­æœŸå‡ç·š</label>
                                <input type="number" id="ma_mid" value="50" min="20" max="100" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">é•·æœŸå‡ç·š</label>
                                <input type="number" id="ma_long" value="200" min="50" max="300" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">RSI åƒæ•¸</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">RSI é€±æœŸ</label>
                                <input type="number" id="rsi_period" value="14" min="5" max="30" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">è¶…è²·é–€æª»</label>
                                <input type="number" id="rsi_overbought" value="70" min="60" max="90" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">è¶…è³£é–€æª»</label>
                                <input type="number" id="rsi_oversold" value="30" min="10" max="40" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">MACD åƒæ•¸</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å¿«ç·šé€±æœŸ</label>
                                <input type="number" id="macd_fast" value="12" min="5" max="20" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">æ…¢ç·šé€±æœŸ</label>
                                <input type="number" id="macd_slow" value="26" min="15" max="40" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">è¨Šè™Ÿç·š</label>
                                <input type="number" id="macd_signal" value="9" min="5" max="15" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-600 mb-2">å…¶ä»–åƒæ•¸</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">KD é€±æœŸ</label>
                                <input type="number" id="kd_period" value="9" min="5" max="20" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å¸ƒæ—é€±æœŸ</label>
                                <input type="number" id="bollinger_period" value="20" min="10" max="30" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">çªç ´é è­¦%</label>
                                <input type="number" id="breakout_threshold" value="2.0" min="0.5" max="5" step="0.5" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">é‡æ¯”è­¦æˆ’</label>
                                <input type="number" id="volume_alert_ratio" value="2.0" min="1.5" max="5" step="0.5" class="param-input w-full px-3 py-2 border rounded-lg text-center">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="saveParamSettings()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            <i class="fas fa-save mr-2"></i>å„²å­˜åƒæ•¸
                        </button>
                        <button onclick="resetParams()" class="px-4 py-2 border text-gray-600 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-undo mr-2"></i>æ¢å¾©é è¨­
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-tags mr-2 text-blue-500"></i>
                        æ¨™ç±¤ç®¡ç†
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">å»ºç«‹æ¨™ç±¤ä¾†åˆ†é¡è¿½è¹¤æ¸…å–®ä¸­çš„è‚¡ç¥¨</p>
                    <div id="tagManagerContent">
                        <p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
                <div id="adminToolsSection" class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-tools mr-2 text-orange-500"></i>
                        ç®¡ç†å“¡å·¥å…·
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">æ‰‹å‹•è§¸ç™¼ç³»çµ±æ›´æ–°</p>
                    
                    <div class="space-y-3">
                        <button onclick="adminUpdatePriceCache()" class="w-full px-4 py-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 flex items-center justify-between">
                            <span><i class="fas fa-dollar-sign mr-2"></i>æ›´æ–°åƒ¹æ ¼å¿«å–</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        
                        <button onclick="adminUpdateExchangeRate()" class="w-full px-4 py-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 flex items-center justify-between">
                            <span><i class="fas fa-exchange-alt mr-2"></i>æ›´æ–°åŒ¯ç‡</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        
                        <button onclick="adminFetchSubscriptions()" class="w-full px-4 py-3 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 flex items-center justify-between">
                            <span><i class="fas fa-rss mr-2"></i>æŠ“å–è¨‚é–±ç²¾é¸ (å›æº¯30å¤©)</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-user mr-2 text-gray-500"></i>
                        å¸³è™Ÿè³‡è¨Š
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-500">ç”¨æˆ¶åç¨±</span>
                            <span id="settingsUserName" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-500">æœƒå“¡ç­‰ç´š</span>
                            <span id="settingsMemberLevel" class="font-medium text-orange-500">ä¸€èˆ¬æœƒå“¡</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-500">ç³»çµ±ç‰ˆæœ¬</span>
                            <span class="font-medium">v0.5.3</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="mt-4 w-full py-3 border border-red-500 text-red-500 rounded-lg font-medium hover:bg-red-50">
                        <i class="fas fa-sign-out-alt mr-2"></i>ç™»å‡º
                    </button>
                </div>
            </section>
            <section id="section-cagr" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    å ±é…¬ç‡æ¯”è¼ƒ
                </h2>
                
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-4 md:p-6 mb-4 text-white">
                    <h3 class="text-lg font-bold mb-2">ğŸ† å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒå™¨</h3>
                    <p class="text-blue-100 text-sm">æ¯”è¼ƒè‚¡ç¥¨ã€åŠ å¯†è²¨å¹£ã€æŒ‡æ•¸çš„é•·æœŸæŠ•è³‡å ±é…¬è¡¨ç¾ï¼Œæ‰¾å‡ºæœ€ä½³æŠ•è³‡æ¨™çš„</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="bg-white rounded-xl shadow p-4">
                            <h3 class="font-bold text-gray-700 mb-3">ğŸš€ å¿«é€Ÿæ¯”è¼ƒ</h3>
                            <div class="space-y-2" id="cagrPresetList">
                                <button onclick="cagrLoadPreset('mag7')" class="w-full text-left px-3 py-2 bg-gray-50 hover:bg-blue-50 rounded-lg text-sm">
                                    <i class="fas fa-star text-yellow-500 mr-2"></i>ç§‘æŠ€ä¸ƒé›„ (MAG7)
                                </button>
                                <button onclick="cagrLoadPreset('indices')" class="w-full text-left px-3 py-2 bg-gray-50 hover:bg-blue-50 rounded-lg text-sm">
                                    <i class="fas fa-chart-line text-blue-500 mr-2"></i>ç¾è‚¡ä¸‰å¤§æŒ‡æ•¸
                                </button>
                                <button onclick="cagrLoadPreset('tw_etf')" class="w-full text-left px-3 py-2 bg-gray-50 hover:bg-blue-50 rounded-lg text-sm">
                                    <i class="fas fa-flag text-red-500 mr-2"></i>å°è‚¡ç†±é–€ ETF
                                </button>
                                <button onclick="cagrLoadPreset('crypto')" class="w-full text-left px-3 py-2 bg-gray-50 hover:bg-blue-50 rounded-lg text-sm">
                                    <i class="fab fa-bitcoin text-orange-500 mr-2"></i>åŠ å¯†è²¨å¹£
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow p-4">
                            <h3 class="font-bold text-gray-700 mb-3">âœï¸ è‡ªè¨‚æ¯”è¼ƒ</h3>
                            
                            <div class="mb-3">
                                <label class="text-sm text-gray-500 mb-1 block">å·²é¸æ¨™çš„ (æœ€å¤š5å€‹)</label>
                                <div id="cagrSelectedSymbols" class="min-h-[40px] p-2 bg-gray-50 rounded-lg flex flex-wrap">
                                    <span class="text-gray-400 text-sm">å°šæœªé¸æ“‡</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="cagrSymbolInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ AAPL, BTC)"
                                    class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                    onkeypress="if(event.key==='Enter') cagrAddSymbol()">
                                <button onclick="cagrAddSymbol()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="text-sm text-gray-500 mb-1 block">æ¯”è¼ƒé€±æœŸ</label>
                                <div class="flex flex-wrap gap-2 text-sm">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="cagr-period-check mr-1" value="1y" checked> 1å¹´
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="cagr-period-check mr-1" value="3y" checked> 3å¹´
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="cagr-period-check mr-1" value="5y" checked> 5å¹´
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="cagr-period-check mr-1" value="10y"> 10å¹´
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="text-sm text-gray-500 mb-1 block">åŸºæº–æŒ‡æ•¸</label>
                                <select id="cagrBenchmarkSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm">
                                    <option value="^GSPC">S&P 500</option>
                                    <option value="^IXIC">ç´æ–¯é”å…‹</option>
                                    <option value="^DJI">é“ç“Šå·¥æ¥­</option>
                                    <option value="">ç„¡</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="text-sm text-gray-500 mb-1 block">æ’åºä¾æ“š</label>
                                <select id="cagrSortBySelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm">
                                    <option value="1y">1å¹´å ±é…¬ç‡</option>
                                    <option value="3y">3å¹´å ±é…¬ç‡</option>
                                    <option value="5y" selected>5å¹´å ±é…¬ç‡</option>
                                    <option value="10y">10å¹´å ±é…¬ç‡</option>
                                </select>
                            </div>
                            
                            <button onclick="cagrRunComparison()" 
                                class="w-full py-3 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition">
                                <i class="fas fa-chart-bar mr-2"></i>é–‹å§‹æ¯”è¼ƒ
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-700">ğŸ’¾ æˆ‘çš„çµ„åˆ</h3>
                                <button onclick="cagrSaveCurrentComparison()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-save mr-1"></i>å„²å­˜ç›®å‰
                                </button>
                            </div>
                            <div id="cagrSavedComparisons" class="space-y-2">
                                <p class="text-gray-400 text-sm">ç™»å…¥å¾Œå¯å„²å­˜çµ„åˆ</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow p-4 md:p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-700 text-lg">ğŸ“Š æ¯”è¼ƒçµæœ</h3>
                                <span id="cagrResultTime" class="text-sm text-gray-400"></span>
                            </div>
                            
                            <div id="cagrComparisonResult">
                                <div class="text-center py-12 text-gray-400">
                                    <i class="fas fa-chart-line text-6xl mb-4"></i>
                                    <p>é¸æ“‡æ¨™çš„å¾Œé»æ“Šã€Œé–‹å§‹æ¯”è¼ƒã€</p>
                                    <p class="text-sm mt-2">æˆ–ä½¿ç”¨å·¦å´çš„å¿«é€Ÿæ¯”è¼ƒé è¨­çµ„åˆ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="section-admin" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">
                    <i class="fas fa-user-shield text-orange-500 mr-2"></i>
                    ç®¡ç†å¾Œå°
                </h2>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4 mb-4 md:mb-6">
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ç¸½ç”¨æˆ¶æ•¸</div>
                        <div id="adminStatTotal" class="text-xl md:text-2xl font-bold text-slate-800">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ç¸½ç™»å…¥æ¬¡æ•¸</div>
                        <div id="adminStatTotalLogins" class="text-xl md:text-2xl font-bold text-purple-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ä»Šæ—¥ç™»å…¥</div>
                        <div id="adminStatToday" class="text-xl md:text-2xl font-bold text-green-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">å°é–ç”¨æˆ¶</div>
                        <div id="adminStatBlocked" class="text-xl md:text-2xl font-bold text-red-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ç®¡ç†å“¡</div>
                        <div id="adminStatAdmin" class="text-xl md:text-2xl font-bold text-blue-600">-</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š å¸‚å ´è³‡æ–™ç®¡ç†</h3>
                    <div class="flex flex-wrap gap-2 md:gap-3">
                        <button onclick="adminInitializeData()" class="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                            <i class="fas fa-sync mr-2"></i>åˆå§‹åŒ–æ­·å²è³‡æ–™
                        </button>
                        <button onclick="adminUpdateIndices()" class="bg-green-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-green-700 flex items-center text-sm">
                            <i class="fas fa-chart-line mr-2"></i>æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
                        </button>
                        <button onclick="adminUpdateSentiment()" class="bg-purple-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center text-sm">
                            <i class="fas fa-brain mr-2"></i>æ›´æ–°ææ‡¼è²ªå©ª
                        </button>
                        <button onclick="adminTriggerDailyUpdate()" class="bg-orange-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center text-sm">
                            <i class="fas fa-bolt mr-2"></i>åŸ·è¡Œæ¯æ—¥æ›´æ–°
                        </button>
                    </div>
                    <p id="adminSystemMessage" class="mt-3 text-sm text-gray-500"></p>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ”” è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­</h3>
                    <div class="flex flex-wrap gap-2 md:gap-3 mb-3">
                        <button onclick="adminRunSignalCheck()" class="bg-indigo-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center text-sm">
                            <i class="fas fa-search mr-2"></i>åµæ¸¬è¨Šè™Ÿ
                        </button>
                        <button onclick="adminSendSignalNotifications()" class="bg-orange-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center text-sm">
                            <i class="fas fa-paper-plane mr-2"></i>ç™¼é€è¨Šè™Ÿé€šçŸ¥
                        </button>
                        <button onclick="adminTestLineNotify()" class="bg-green-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-green-600 flex items-center text-sm">
                            <i class="fab fa-line mr-2"></i>æ¸¬è©¦ LINE æ¨æ’­
                        </button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" id="adminTestSymbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæ¸¬è©¦è¨Šè™Ÿåµæ¸¬ (å¦‚ AAPL)"
                            class="flex-1 px-3 md:px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm"
                            onkeypress="if(event.key==='Enter') adminTestSignalDetection()">
                        <button onclick="adminTestSignalDetection()" class="bg-gray-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm">
                            æ¸¬è©¦åµæ¸¬
                        </button>
                    </div>
                    <p id="adminSignalMessage" class="mt-3 text-sm text-gray-500"></p>
                    <div id="adminSignalResult" class="mt-3 hidden">
                        <h4 class="font-medium text-gray-700 mb-2">åµæ¸¬çµæœï¼š</h4>
                        <pre id="adminSignalResultContent" class="bg-gray-100 p-3 rounded text-xs overflow-x-auto max-h-48"></pre>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ“¡ è¨‚é–±æºç®¡ç†</h3>
                    <div class="flex flex-wrap gap-2 md:gap-3 mb-3">
                        <button onclick="adminFetchSubscriptions()" class="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                            <i class="fas fa-sync mr-2"></i>æŠ“å–è¨‚é–±ç²¾é¸
                        </button>
                        <button onclick="adminBackfillSubscriptions()" class="bg-purple-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center text-sm">
                            <i class="fas fa-history mr-2"></i>å›è£œæ­·å²æ–‡ç« 
                        </button>
                    </div>
                    <p id="adminSubscriptionMessage" class="mt-3 text-sm text-gray-500"></p>
                </div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h3>
                    <div class="flex flex-col md:flex-row gap-3 md:gap-4 mb-4">
                        <input type="text" id="adminSearchInput" placeholder="æœå°‹ç”¨æˆ¶åç¨±ã€Email æˆ– LINE ID..."
                            class="flex-1 px-3 md:px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm"
                            onkeypress="if(event.key==='Enter') adminLoadUsers()">
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="adminBlockedOnly" class="mr-2">
                                <span>åªé¡¯ç¤ºå°é–</span>
                            </label>
                            <button onclick="adminLoadUsers()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 text-sm">
                                æœå°‹
                            </button>
                            <button onclick="adminKickAllUsers()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                è¸¢å‡ºå…¨éƒ¨
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b bg-gray-50">
                                    <th class="text-left py-2 px-3">ç”¨æˆ¶</th>
                                    <th class="text-left py-2 px-3 hidden md:table-cell">LINE ID</th>
                                    <th class="text-center py-2 px-3">ç™»å…¥</th>
                                    <th class="text-center py-2 px-3">ç‹€æ…‹</th>
                                    <th class="text-center py-2 px-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="adminUserList">
                                <tr><td colspan="5" class="text-center py-4 text-gray-400">é»æ“Šã€Œæœå°‹ã€è¼‰å…¥ç”¨æˆ¶</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
        </main>
        <nav class="mobile-bottom-nav">
            <a href="#" onclick="mobileNavTo('dashboard')" class="bottom-nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>é¦–é </span>
            </a>
            <a href="#" onclick="mobileNavTo('search')" class="bottom-nav-item" data-section="search">
                <i class="fas fa-search"></i>
                <span>æŸ¥è©¢</span>
            </a>
            <a href="#" onclick="mobileNavTo('watchlist')" class="bottom-nav-item" data-section="watchlist">
                <i class="fas fa-star"></i>
                <span>è¿½è¹¤</span>
            </a>
            <a href="#" onclick="mobileNavTo('sentiment')" class="bottom-nav-item" data-section="sentiment">
                <i class="fas fa-heart-pulse"></i>
                <span>æƒ…ç·’</span>
            </a>
            <a href="#" onclick="mobileNavTo('settings')" class="bottom-nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>è¨­å®š</span>
            </a>
        </nav>
    </div>
    <div id="modal-container"></div>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/core.js"></script>
    <script src="/static/js/state.js"></script>
    <script src="/static/js/modals.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/search.js"></script>
    <script src="/static/js/tags.js"></script>
    <script src="/static/js/watchlist.js"></script>
    <script src="/static/js/portfolio.js"></script>
    <script src="/static/js/transaction.js"></script>
    <script src="/static/js/compare.js"></script>
    <script src="/static/js/returns.js"></script>
    <script src="/static/js/subscription.js"></script>
    <script src="/static/js/settings.js"></script>
    <script src="/static/js/cagr.js"></script>
    <script src="/static/js/admin.js"></script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/index.html  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SELA è‡ªå‹•é¸è‚¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .brand-orange { background-color: #FA7A35; }
        .brand-orange:hover { background-color: #e86a25; }
        .brand-text { color: #FA7A35; }
        .line-btn { background-color: #06C755; }
        .line-btn:hover { background-color: #05b34c; }
        .touch-target { min-height: 48px; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md">
        <!-- Logo -->
        <div class="text-center mb-6 md:mb-8">
            <img src="/static/logo.png" alt="SELA Logo" class="w-20 h-20 md:w-24 md:h-24 mx-auto mb-3 md:mb-4 rounded-xl">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">SELA è‡ªå‹•é¸è‚¡ç³»çµ±</h1>
            <p class="text-gray-500 mt-2 text-sm md:text-base">æŠ€è¡“æŒ‡æ¨™åˆ†æ Â· æ™ºèƒ½é è­¦é€šçŸ¥</p>
        </div>

        <!-- åŠŸèƒ½ä»‹ç´¹ -->
        <div class="space-y-2 md:space-y-3 mb-6 md:mb-8">
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>ç¾è‚¡å³æ™‚å ±åƒ¹èˆ‡æŠ€è¡“åˆ†æ</span>
            </div>
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>æ¯”ç‰¹å¹£ã€ä»¥å¤ªå¹£åƒ¹æ ¼è¿½è¹¤</span>
            </div>
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>å€‹äººåŒ–è¿½è¹¤æ¸…å–®</span>
            </div>
            <div class="flex items-center text-gray-600 text-sm md:text-base">
                <i class="fas fa-check-circle brand-text mr-3 flex-shrink-0"></i>
                <span>LINE æ¨æ’­æ™ºèƒ½é è­¦</span>
            </div>
        </div>

        <!-- LINE ç™»å…¥æŒ‰éˆ• -->
        <a href="/auth/line" class="line-btn w-full py-3 md:py-4 px-4 rounded-lg text-white font-semibold flex items-center justify-center space-x-2 transition-colors touch-target">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
            </svg>
            <span>ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥</span>
        </a>

        <!-- ç‰ˆæ¬Š -->
        <p class="text-center text-gray-400 text-xs md:text-sm mt-6 md:mt-8">
            Â© 2025 SELA Â· è‡ªå‹•é¸è‚¡ç³»çµ± v0.3.2
        </p>
    </div>

    <script>
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const token = localStorage.getItem('token');
        if (token) {
            window.location.href = '/static/dashboard.html';
        }
    </script>
</body>
</html>
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/admin.js  â­
> ============================================================
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
// ============================================================
// ç®¡ç†å¾Œå° - admin.js
// ============================================================

let adminCurrentPage = 1;
let adminTotalPages = 1;

// ==================== åˆå§‹åŒ– ====================
function initAdmin() {
    // åªæœ‰ç®¡ç†å“¡æ‰åˆå§‹åŒ–
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.is_admin) {
        // é¡¯ç¤ºç®¡ç†å“¡å…¥å£
        const adminMobileLink = document.getElementById('adminMobileLink');
        if (adminMobileLink) {
            adminMobileLink.classList.remove('hidden');
            adminMobileLink.classList.add('flex');
        }
    }
}

// ==================== API è«‹æ±‚å°è£ (è¿”å› JSON) ====================
async function adminApiRequest(endpoint, options = {}) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/static/index.html';
        return null;
    }
    
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...options.headers
    };
    
    try {
        const response = await fetch(endpoint, {
            ...options,
            headers
        });
        
        if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/static/index.html';
            return null;
        }
        
        if (response.status === 403) {
            showToast('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error');
            showSection('dashboard');
            return null;
        }
        
        return await response.json();
    } catch (e) {
        console.error('Admin API è«‹æ±‚å¤±æ•—:', e);
        return null;
    }
}

// ==================== è¼‰å…¥çµ±è¨ˆ ====================
async function adminLoadStats() {
    try {
        const data = await adminApiRequest('/api/admin/stats');
        if (data && data.success) {
            document.getElementById('adminStatTotal').textContent = data.stats.total_users;
            document.getElementById('adminStatTotalLogins').textContent = data.stats.total_logins;
            document.getElementById('adminStatToday').textContent = data.stats.today_logins;
            document.getElementById('adminStatBlocked').textContent = data.stats.blocked_users;
            document.getElementById('adminStatAdmin').textContent = data.stats.admin_users;
        }
    } catch (e) {
        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—', e);
    }
}

// ==================== ç”¨æˆ¶ç®¡ç† ====================
async function adminLoadUsers() {
    const search = document.getElementById('adminSearchInput')?.value || '';
    const blockedOnly = document.getElementById('adminBlockedOnly')?.checked || false;
    
    let url = `/api/admin/users?page=${adminCurrentPage}&page_size=15`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (blockedOnly) url += `&blocked_only=true`;
    
    try {
        const data = await adminApiRequest(url);
        if (data && data.success) {
            adminRenderUsers(data.users);
            adminTotalPages = data.pagination.total_pages;
            const pageInfo = document.getElementById('adminPageInfo');
            if (pageInfo) {
                pageInfo.textContent = `ç¬¬ ${data.pagination.page} / ${adminTotalPages} é ï¼Œå…± ${data.pagination.total} ç­†`;
            }
            const prevBtn = document.getElementById('adminPrevPage');
            const nextBtn = document.getElementById('adminNextPage');
            if (prevBtn) prevBtn.disabled = adminCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = adminCurrentPage >= adminTotalPages;
        }
    } catch (e) {
        showToast('è¼‰å…¥ç”¨æˆ¶å¤±æ•—', 'error');
    }
}

function adminRenderUsers(users) {
    const tbody = document.getElementById('adminUserList');
    
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">æ²’æœ‰æ‰¾åˆ°ç”¨æˆ¶</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50">
            <td class="px-3 py-2">
                <div class="flex items-center">
                    <img src="${u.picture_url || '/static/logo.png'}" 
                        class="w-8 h-8 rounded-full mr-2" 
                        onerror="this.src='/static/logo.png'">
                    <div>
                        <div class="font-medium text-gray-900 text-sm">${adminEscapeHtml(u.display_name || 'æœªå‘½å')}</div>
                        <div class="text-xs text-gray-400">ID: ${u.id}</div>
                    </div>
                </div>
            </td>
            <td class="px-3 py-2 text-sm text-gray-500 hidden md:table-cell">
                ${adminEscapeHtml(u.email || '-')}
            </td>
            <td class="px-3 py-2">
                <div class="flex flex-wrap gap-1">
                    ${u.is_admin ? '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800">ç®¡ç†å“¡</span>' : ''}
                    ${u.is_blocked 
                        ? '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800">å·²å°é–</span>' 
                        : '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800">æ­£å¸¸</span>'}
                </div>
            </td>
            <td class="px-3 py-2 text-center">
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-700">${u.login_count || 0}</span>
            </td>
            <td class="px-3 py-2">
                <div class="flex gap-1 flex-wrap">
                    ${u.is_blocked 
                        ? `<button onclick="adminUnblockUser(${u.id})" class="px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded">è§£å°</button>`
                        : `<button onclick="adminBlockUser(${u.id})" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 text-red-700 rounded">å°é–</button>`
                    }
                    <button onclick="adminKickUser(${u.id})" 
                        class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded">è¸¢å‡º</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function adminChangePage(delta) {
    adminCurrentPage += delta;
    adminLoadUsers();
}

// ==================== ç”¨æˆ¶æ“ä½œ ====================
async function adminBlockUser(userId) {
    const reason = prompt('è«‹è¼¸å…¥å°é–åŸå› ï¼š');
    if (reason === null) return;
    
    try {
        const data = await adminApiRequest(`/api/admin/users/${userId}/block`, {
            method: 'POST',
            body: JSON.stringify({ reason: reason })
        });
        
        if (data && data.success) {
            showToast('ç”¨æˆ¶å·²å°é–', 'success');
            adminLoadUsers();
            adminLoadStats();
        } else {
            showToast('å°é–å¤±æ•—', 'error');
        }
    } catch (e) {
        showToast('å°é–å¤±æ•—ï¼š' + e.message, 'error');
    }
}

async function adminUnblockUser(userId) {
    if (!confirm('ç¢ºå®šè¦è§£é™¤å°é–æ­¤ç”¨æˆ¶ï¼Ÿ')) return;
    
    try {
        const data = await adminApiRequest(`/api/admin/users/${userId}/unblock`, {
            method: 'POST'
        });
        
        if (data && data.success) {
            showToast('å·²è§£é™¤å°é–', 'success');
            adminLoadUsers();
            adminLoadStats();
        } else {
            showToast('è§£å°å¤±æ•—', 'error');
        }
    } catch (e) {
        showToast('è§£å°å¤±æ•—ï¼š' + e.message, 'error');
    }
}

async function adminKickUser(userId) {
    if (!confirm('ç¢ºå®šè¦è¸¢å‡ºæ­¤ç”¨æˆ¶ï¼Ÿ')) return;
    
    try {
        const data = await adminApiRequest(`/api/admin/users/${userId}/kick`, {
            method: 'POST'
        });
        
        if (data && data.success) {
            showToast('ç”¨æˆ¶å·²è¸¢å‡º', 'success');
        } else {
            showToast('æ“ä½œå¤±æ•—', 'error');
        }
    } catch (e) {
        showToast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
    }
}

async function adminKickAllUsers() {
    if (!confirm('ç¢ºå®šè¦è¸¢å‡ºæ‰€æœ‰ç”¨æˆ¶ï¼Ÿæ­¤æ“ä½œå°‡ä½¿æ‰€æœ‰ç”¨æˆ¶é‡æ–°ç™»å…¥ã€‚')) return;
    
    try {
        const data = await adminApiRequest('/api/admin/users/kick-all', {
            method: 'POST'
        });
        
        if (data && data.success) {
            showToast(`å·²è¸¢å‡º ${data.kicked_count} å€‹ç”¨æˆ¶`, 'success');
        } else {
            showToast('æ“ä½œå¤±æ•—', 'error');
        }
    } catch (e) {
        showToast('æ“ä½œå¤±æ•—ï¼š' + e.message, 'error');
    }
}

// ==================== ç³»çµ±ç®¡ç† ====================
function adminShowSystemMessage(msg, isError = false) {
    const el = document.getElementById('adminSystemMessage');
    if (el) {
        el.textContent = msg;
        el.className = isError ? 'mt-3 text-sm text-red-500' : 'mt-3 text-sm text-green-600';
    }
}

async function adminInitializeData() {
    adminShowSystemMessage('æ­£åœ¨åˆå§‹åŒ–æ­·å²è³‡æ–™...');
    
    try {
        const data = await adminApiRequest('/api/market/admin/initialize', { method: 'POST' });
        if (data && data.success) {
            adminShowSystemMessage(`âœ… åˆå§‹åŒ–å®Œæˆï¼${data.data?.count || 0} ç­†è³‡æ–™`);
        } else {
            adminShowSystemMessage(`âŒ åˆå§‹åŒ–å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSystemMessage(`âŒ åˆå§‹åŒ–å¤±æ•—: ${e.message}`, true);
    }
}

async function adminUpdateIndices() {
    adminShowSystemMessage('æ­£åœ¨æ›´æ–°ä¸‰å¤§æŒ‡æ•¸...');
    
    try {
        const data = await adminApiRequest('/api/market/admin/update-indices', { method: 'POST' });
        if (data && data.success) {
            adminShowSystemMessage(`âœ… ä¸‰å¤§æŒ‡æ•¸æ›´æ–°å®Œæˆï¼${data.data?.count || 0} ç­†è³‡æ–™`);
        } else {
            adminShowSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
    }
}

async function adminUpdateSentiment() {
    adminShowSystemMessage('æ­£åœ¨æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸...');
    
    try {
        const data = await adminApiRequest('/api/market/admin/update-sentiment', { method: 'POST' });
        if (data && data.success) {
            adminShowSystemMessage(`âœ… ææ‡¼è²ªå©ªæŒ‡æ•¸æ›´æ–°å®Œæˆï¼`);
        } else {
            adminShowSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
    }
}

async function adminTriggerDailyUpdate() {
    adminShowSystemMessage('æ­£åœ¨åŸ·è¡Œæ¯æ—¥æ›´æ–°...');
    
    try {
        const data = await adminApiRequest('/api/market/admin/update', { method: 'POST' });
        if (data && data.success) {
            adminShowSystemMessage(`âœ… æ¯æ—¥æ›´æ–°å®Œæˆï¼`);
        } else {
            adminShowSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSystemMessage(`âŒ æ›´æ–°å¤±æ•—: ${e.message}`, true);
    }
}

// ==================== è¨Šè™Ÿæª¢æŸ¥ ====================
function adminShowSignalMessage(msg, isError = false) {
    const el = document.getElementById('adminSignalMessage');
    if (el) {
        el.textContent = msg;
        el.className = isError ? 'mt-3 text-sm text-red-500' : 'mt-3 text-sm text-green-600';
    }
}

async function adminRunSignalCheck() {
    adminShowSignalMessage('æ­£åœ¨åŸ·è¡Œè¨Šè™Ÿæª¢æŸ¥...');
    document.getElementById('adminSignalResult')?.classList.add('hidden');
    
    try {
        const data = await adminApiRequest('/api/admin/signal/detect', { method: 'POST' });
        if (data && data.success) {
            adminShowSignalMessage(`âœ… æª¢æŸ¥å®Œæˆï¼šåµæ¸¬åˆ° ${data.total_signals} å€‹è¨Šè™Ÿ`);
            
            if (data.signals_by_symbol && Object.keys(data.signals_by_symbol).length > 0) {
                document.getElementById('adminSignalResult')?.classList.remove('hidden');
                const contentEl = document.getElementById('adminSignalResultContent');
                if (contentEl) {
                    contentEl.textContent = JSON.stringify(data.signals_by_symbol, null, 2);
                }
            }
        } else {
            adminShowSignalMessage(`âŒ æª¢æŸ¥å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSignalMessage(`âŒ æª¢æŸ¥å¤±æ•—: ${e.message}`, true);
    }
}

async function adminSendSignalNotifications() {
    adminShowSignalMessage('æ­£åœ¨ç™¼é€è¨Šè™Ÿé€šçŸ¥...');
    
    try {
        const data = await adminApiRequest('/api/admin/signal/notify', { method: 'POST' });
        if (data && data.success) {
            const r = data.result || {};
            adminShowSignalMessage(`âœ… ${data.message} - è‚¡ç¥¨æ›´æ–°: ${r.stocks_updated}, è¨Šè™Ÿåµæ¸¬: ${r.signals_detected}, é€šçŸ¥ç™¼é€: ${r.notifications_sent}`);
            
            if (r.errors && r.errors.length > 0) {
                document.getElementById('adminSignalResult')?.classList.remove('hidden');
                const contentEl = document.getElementById('adminSignalResultContent');
                if (contentEl) {
                    contentEl.textContent = 'éŒ¯èª¤è¨˜éŒ„:\n' + r.errors.join('\n');
                }
            }
        } else {
            adminShowSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${e.message}`, true);
    }
}

async function adminTestSignalDetection() {
    const symbol = document.getElementById('adminTestSymbolInput')?.value.trim();
    if (!symbol) {
        adminShowSignalMessage('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ', true);
        return;
    }
    
    adminShowSignalMessage(`æ­£åœ¨æ¸¬è©¦ ${symbol.toUpperCase()} çš„è¨Šè™Ÿåµæ¸¬...`);
    document.getElementById('adminSignalResult')?.classList.add('hidden');
    
    try {
        const data = await adminApiRequest('/api/admin/signal/detect', { method: 'POST' });
        if (data && data.success) {
            const symbolUpper = symbol.toUpperCase();
            const symbolSignals = data.signals_by_symbol[symbolUpper] || [];
            
            adminShowSignalMessage(`âœ… ${symbolUpper} åµæ¸¬åˆ° ${symbolSignals.length} å€‹è¨Šè™Ÿ`);
            
            document.getElementById('adminSignalResult')?.classList.remove('hidden');
            const contentEl = document.getElementById('adminSignalResultContent');
            if (contentEl) {
                contentEl.textContent = JSON.stringify({ symbol: symbolUpper, signals: symbolSignals }, null, 2);
            }
        } else {
            adminShowSignalMessage(`âŒ åµæ¸¬å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSignalMessage(`âŒ åµæ¸¬å¤±æ•—: ${e.message}`, true);
    }
}

async function adminTestLineNotify() {
    adminShowSignalMessage('æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...');
    
    try {
        const data = await adminApiRequest('/api/admin/signal/test-push?message=ç®¡ç†å“¡æ¸¬è©¦è¨Šæ¯', { method: 'POST' });
        if (data && data.success) {
            adminShowSignalMessage('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINE');
        } else {
            adminShowSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${data?.message || data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSignalMessage(`âŒ ç™¼é€å¤±æ•—: ${e.message}`, true);
    }
}

// ==================== è¨‚é–±æºç®¡ç† ====================
function adminShowSubscriptionMessage(msg, isError = false) {
    const el = document.getElementById('adminSubscriptionMessage');
    if (el) {
        el.textContent = msg;
        el.className = isError ? 'mt-3 text-sm text-red-500' : 'mt-3 text-sm text-green-600';
    }
}

async function adminFetchSubscriptions() {
    adminShowSubscriptionMessage('æ­£åœ¨æŠ“å–è¨‚é–±ç²¾é¸...');
    
    try {
        const data = await adminApiRequest('/api/subscription/admin/fetch', { method: 'POST' });
        if (data && data.success) {
            adminShowSubscriptionMessage(`âœ… æŠ“å–å®Œæˆï¼æ–°å¢ ${data.new_articles || 0} ç¯‡æ–‡ç« ï¼Œ${data.new_mentions || 0} å€‹æåŠ`);
        } else {
            adminShowSubscriptionMessage(`âŒ æŠ“å–å¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSubscriptionMessage(`âŒ æŠ“å–å¤±æ•—: ${e.message}`, true);
    }
}

async function adminBackfillSubscriptions() {
    const days = prompt('å›è£œå¹¾å¤©çš„æ–‡ç« ï¼Ÿ', '7');
    if (!days) return;
    
    adminShowSubscriptionMessage('æ­£åœ¨å›è£œæ­·å²æ–‡ç« ...');
    
    try {
        const data = await adminApiRequest(`/api/subscription/admin/backfill?days=${days}`, { method: 'POST' });
        if (data && data.success) {
            adminShowSubscriptionMessage(`âœ… å›è£œå®Œæˆï¼æ–°å¢ ${data.new_articles || 0} ç¯‡æ–‡ç« ï¼Œ${data.new_mentions || 0} å€‹æåŠ`);
        } else {
            adminShowSubscriptionMessage(`âŒ å›è£œå¤±æ•—: ${data?.detail || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
    } catch (e) {
        adminShowSubscriptionMessage(`âŒ å›è£œå¤±æ•—: ${e.message}`, true);
    }
}

// ==================== å·¥å…·å‡½æ•¸ ====================
function adminFormatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function adminEscapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initAdmin, 100);
});
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/cagr.js  â­
> ============================================================
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
// ============================================================
// å ±é…¬ç‡æ¯”è¼ƒ (CAGR) - cagr.js
// ============================================================

// é¸ä¸­çš„æ¨™çš„
let cagrSelectedSymbols = [];

// é è¨­çµ„åˆ
const CAGR_PRESETS = {
    'mag7': {
        name: 'ç§‘æŠ€ä¸ƒé›„ (MAG7)',
        symbols: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA']
    },
    'indices': {
        name: 'ç¾è‚¡ä¸‰å¤§æŒ‡æ•¸',
        symbols: ['^GSPC', '^DJI', '^IXIC']
    },
    'tw_etf': {
        name: 'å°è‚¡ç†±é–€ ETF',
        symbols: ['0050.TW', '0056.TW', '00878.TW', '00919.TW']
    },
    'crypto': {
        name: 'åŠ å¯†è²¨å¹£',
        symbols: ['BTC-USD', 'ETH-USD', 'SOL-USD']
    }
};

// ==================== åˆå§‹åŒ– ====================
function initCagr() {
    cagrLoadPresets();
    cagrLoadSavedComparisons();
}

// ==================== é è¨­çµ„åˆ ====================
function cagrLoadPresets() {
    const container = document.getElementById('cagrPresetList');
    if (!container) return;
    
    container.innerHTML = Object.entries(CAGR_PRESETS).map(([id, preset]) => `
        <button onclick="cagrLoadPreset('${id}')" 
            class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition flex justify-between items-center text-sm">
            <span>${preset.name}</span>
            <span class="text-xs text-gray-400">${preset.symbols.length}å€‹</span>
        </button>
    `).join('');
}

function cagrLoadPreset(presetId) {
    const preset = CAGR_PRESETS[presetId];
    if (!preset) {
        showToast('æ‰¾ä¸åˆ°é è¨­çµ„åˆ', 'error');
        return;
    }
    
    // é™åˆ¶æœ€å¤š 5 å€‹
    cagrSelectedSymbols = preset.symbols.slice(0, 5);
    cagrRenderSelectedSymbols();
    cagrRunComparison();
}

async function cagrQuickCompare(presetId) {
    cagrShowLoading();
    try {
        const benchmark = document.getElementById('cagrBenchmarkSelect').value;
        const sortBy = document.getElementById('cagrSortBySelect').value;
        
        const res = await fetch(`/api/compare/quick/${presetId}?benchmark=${benchmark}&sort_by=${sortBy}`);
        const data = await res.json();
        
        if (data.success) {
            // æ›´æ–°é¸ä¸­çš„æ¨™çš„
            if (data.preset && data.preset.symbols) {
                cagrSelectedSymbols = data.preset.symbols;
                cagrRenderSelectedSymbols();
            }
            cagrRenderResult(data);
        } else {
            showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (e) {
        showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + e.message, 'error');
    }
}

// ==================== æ¨™çš„é¸æ“‡ ====================
function cagrAddSymbol() {
    const input = document.getElementById('cagrSymbolInput');
    const symbol = input.value.trim().toUpperCase();
    
    if (!symbol) return;
    
    if (cagrSelectedSymbols.length >= 5) {
        showToast('æœ€å¤šåªèƒ½é¸æ“‡ 5 å€‹æ¨™çš„', 'warning');
        return;
    }
    
    if (cagrSelectedSymbols.includes(symbol)) {
        showToast('å·²ç¶“é¸æ“‡éæ­¤æ¨™çš„', 'warning');
        return;
    }
    
    cagrSelectedSymbols.push(symbol);
    cagrRenderSelectedSymbols();
    input.value = '';
}

function cagrRemoveSymbol(symbol) {
    cagrSelectedSymbols = cagrSelectedSymbols.filter(s => s !== symbol);
    cagrRenderSelectedSymbols();
}

function cagrRenderSelectedSymbols() {
    const container = document.getElementById('cagrSelectedSymbols');
    
    if (cagrSelectedSymbols.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">å°šæœªé¸æ“‡</span>';
        return;
    }
    
    container.innerHTML = cagrSelectedSymbols.map(symbol => `
        <span class="inline-flex items-center px-3 py-1 bg-gray-200 rounded-full text-sm m-1">
            ${symbol}
            <button onclick="cagrRemoveSymbol('${symbol}')" class="ml-2 text-gray-400 hover:text-red-500" title="ç§»é™¤">
                <i class="fas fa-times"></i>
            </button>
        </span>
    `).join('');
}

// ==================== åŸ·è¡Œæ¯”è¼ƒ ====================
async function cagrRunComparison() {
    if (cagrSelectedSymbols.length === 0) {
        showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™çš„', 'warning');
        return;
    }
    
    cagrShowLoading();
    
    // å–å¾—å‹¾é¸çš„é€±æœŸ
    const periods = Array.from(document.querySelectorAll('.cagr-period-check:checked'))
        .map(cb => cb.value);
    
    if (periods.length === 0) {
        showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ™‚é–“é€±æœŸ', 'warning');
        return;
    }
    
    const benchmark = document.getElementById('cagrBenchmarkSelect').value;
    const sortBy = document.getElementById('cagrSortBySelect').value;
    const token = localStorage.getItem('token');
    
    try {
        const res = await fetch('/api/compare/cagr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify({
                symbols: cagrSelectedSymbols,
                periods: periods,
                benchmark: benchmark,
                sort_by: sortBy,
                sort_order: 'desc'
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            cagrRenderResult(data);
        } else {
            showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + (data.detail || data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            document.getElementById('cagrComparisonResult').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                    <p>${data.detail || data.error || 'æ¯”è¼ƒå¤±æ•—'}</p>
                </div>
            `;
        }
    } catch (e) {
        showToast('æ¯”è¼ƒå¤±æ•—ï¼š' + e.message, 'error');
    }
}

function cagrShowLoading() {
    document.getElementById('cagrComparisonResult').innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <p class="text-gray-500">æ­£åœ¨è¨ˆç®—å ±é…¬ç‡...</p>
            <p class="text-gray-400 text-sm mt-1">é¦–æ¬¡æŸ¥è©¢å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“</p>
        </div>
    `;
}

// ==================== æ¸²æŸ“çµæœ ====================
function cagrRenderResult(data) {
    const container = document.getElementById('cagrComparisonResult');
    const periods = data.periods || ['1y', '3y', '5y'];
    
    // æ›´æ–°æ™‚é–“
    if (data.generated_at) {
        const time = new Date(data.generated_at).toLocaleString('zh-TW');
        document.getElementById('cagrResultTime').textContent = `æ›´æ–°ï¼š${time}`;
    }
    
    // å»ºç«‹è¡¨æ ¼
    let html = `
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ’å</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ¨™çš„</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">ç¾åƒ¹</th>
                        ${periods.map(p => `
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">${cagrFormatPeriod(p)}</th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
    `;
    
    data.comparison.forEach((item, index) => {
        const rankClass = index === 0 ? 'bg-yellow-100' : index === 1 ? 'bg-gray-100' : index === 2 ? 'bg-orange-100' : '';
        const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
        const typeIcon = item.type === 'crypto' ? 'ğŸª™' : item.type === 'index' ? 'ğŸ“ˆ' : 'ğŸ“Š';
        
        html += `
            <tr class="hover:bg-gray-50">
                <td class="px-3 py-3">
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${rankClass} font-bold text-sm">
                        ${rankIcon}
                    </span>
                </td>
                <td class="px-3 py-3">
                    <div class="flex items-center">
                        <span class="mr-2">${typeIcon}</span>
                        <div>
                            <div class="font-medium text-gray-900">${item.symbol}</div>
                            <div class="text-xs text-gray-500">${item.name || ''}</div>
                        </div>
                    </div>
                </td>
                <td class="px-3 py-3 text-right">
                    ${item.current_price ? `$${cagrFormatNumber(item.current_price)}` : '--'}
                </td>
                ${periods.map(p => {
                    const cagr = item.cagr ? item.cagr[p] : null;
                    const vsBench = item.vs_benchmark ? item.vs_benchmark[p] : null;
                    return `
                        <td class="px-3 py-3 text-right">
                            ${cagrFormatCAGR(cagr)}
                            ${vsBench !== null && vsBench !== undefined ? `
                                <div class="text-xs ${vsBench >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${vsBench >= 0 ? '+' : ''}${vsBench.toFixed(1)}%
                                </div>
                            ` : ''}
                        </td>
                    `;
                }).join('')}
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    // åŸºæº–æŒ‡æ•¸è³‡è¨Š
    if (data.benchmark) {
        html += `
            <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm">
                <span class="text-gray-500">ğŸ“Œ åŸºæº–æŒ‡æ•¸ï¼š</span>
                <span class="font-medium">${data.benchmark.name} (${data.benchmark.symbol})</span>
                <span class="ml-4 text-gray-500">
                    ${periods.map(p => `${cagrFormatPeriod(p)}: ${cagrFormatCAGR(data.benchmark.cagr[p], true)}`).join(' | ')}
                </span>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function cagrFormatPeriod(period) {
    const map = { '1y': '1å¹´', '3y': '3å¹´', '5y': '5å¹´', '10y': '10å¹´', 'custom': 'è‡ªè¨‚' };
    return map[period] || period;
}

function cagrFormatCAGR(value, simple = false) {
    if (value === null || value === undefined) {
        return '<span class="text-gray-400">--</span>';
    }
    
    const colorClass = value > 0 ? 'text-green-600' : value < 0 ? 'text-red-600' : 'text-gray-600';
    const sign = value > 0 ? '+' : '';
    
    if (simple) {
        return `<span class="${colorClass}">${sign}${value.toFixed(1)}%</span>`;
    }
    
    return `<span class="${colorClass} font-medium">${sign}${value.toFixed(1)}%</span>`;
}

function cagrFormatNumber(num) {
    if (num >= 1000) {
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    return num.toFixed(2);
}

// ==================== å„²å­˜çµ„åˆ ====================
async function cagrSaveCurrentComparison() {
    const token = localStorage.getItem('token');
    if (!token) {
        showToast('è«‹å…ˆç™»å…¥', 'warning');
        return;
    }
    
    if (cagrSelectedSymbols.length === 0) {
        showToast('è«‹å…ˆé¸æ“‡æ¨™çš„', 'warning');
        return;
    }
    
    const name = prompt('è«‹è¼¸å…¥çµ„åˆåç¨±ï¼š');
    if (!name) return;
    
    try {
        const res = await fetch('/api/compare/saved', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                name: name,
                symbols: cagrSelectedSymbols,
                benchmark: document.getElementById('cagrBenchmarkSelect').value
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast('çµ„åˆå·²å„²å­˜', 'success');
            cagrLoadSavedComparisons();
        } else {
            showToast('å„²å­˜å¤±æ•—ï¼š' + (data.detail || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (e) {
        showToast('å„²å­˜å¤±æ•—ï¼š' + e.message, 'error');
    }
}

async function cagrLoadSavedComparisons() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const res = await fetch('/api/compare/saved', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (data.success && data.comparisons && data.comparisons.length > 0) {
            const container = document.getElementById('cagrSavedComparisons');
            container.innerHTML = data.comparisons.map(c => `
                <div class="flex justify-between items-center p-2 rounded hover:bg-gray-50">
                    <button onclick="cagrLoadSavedComparison(${c.id}, ${JSON.stringify(c.symbols).replace(/"/g, '&quot;')})" 
                        class="text-left flex-1">
                        <div class="font-medium text-sm">${c.name}</div>
                        <div class="text-xs text-gray-400">${c.symbols.join(', ')}</div>
                    </button>
                    <button onclick="cagrDeleteSavedComparison(${c.id})" class="text-red-400 hover:text-red-600 ml-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
    } catch (e) {
        console.error('è¼‰å…¥å„²å­˜çµ„åˆå¤±æ•—', e);
    }
}

function cagrLoadSavedComparison(id, symbols) {
    cagrSelectedSymbols = symbols;
    cagrRenderSelectedSymbols();
    cagrRunComparison();
}

async function cagrDeleteSavedComparison(id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤çµ„åˆï¼Ÿ')) return;
    
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`/api/compare/saved/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast('å·²åˆªé™¤', 'success');
            cagrLoadSavedComparisons();
        }
    } catch (e) {
        showToast('åˆªé™¤å¤±æ•—', 'error');
    }
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å»¶é²åˆå§‹åŒ–ï¼Œè®“å…¶ä»–æ¨¡çµ„å…ˆè¼‰å…¥
    setTimeout(initCagr, 100);
});
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/compare.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * èµ°å‹¢æ¯”è¼ƒæ¨¡çµ„
 */

(function() {
    'use strict';
    
    let compareChart = null;
    const compareColors = [
        '#3B82F6', // è—
        '#EF4444', // ç´…
        '#10B981', // ç¶ 
        '#F59E0B', // æ©™
        '#8B5CF6', // ç´«
    ];
    
    /**
     * æ–°å¢æ¯”è¼ƒæ¨™çš„
     */
    function addCompareSymbol(symbol) {
        const input = document.getElementById('compareSymbols');
        if (!input) return;
        
        const current = input.value.trim();
        const symbols = current ? current.split(',').map(s => s.trim().toUpperCase()) : [];
        
        if (!symbols.includes(symbol.toUpperCase())) {
            if (symbols.length >= 5) {
                showToast('æœ€å¤šåªèƒ½æ¯”è¼ƒ 5 å€‹æ¨™çš„');
                return;
            }
            symbols.push(symbol.toUpperCase());
            input.value = symbols.join(', ');
            updateSelectedSymbols();
        }
    }
    
    /**
     * ç§»é™¤æ¯”è¼ƒæ¨™çš„
     */
    function removeCompareSymbol(symbol) {
        const input = document.getElementById('compareSymbols');
        if (!input) return;
        
        const current = input.value.trim();
        const symbols = current ? current.split(',').map(s => s.trim().toUpperCase()) : [];
        const filtered = symbols.filter(s => s !== symbol.toUpperCase());
        input.value = filtered.join(', ');
        updateSelectedSymbols();
    }
    
    /**
     * æ›´æ–°å·²é¸æ“‡çš„æ¨™çš„é¡¯ç¤º
     */
    function updateSelectedSymbols() {
        const input = document.getElementById('compareSymbols');
        const container = document.getElementById('selectedSymbols');
        if (!input || !container) return;
        
        const current = input.value.trim();
        const symbols = current ? current.split(',').map(s => s.trim().toUpperCase()).filter(s => s) : [];
        
        if (symbols.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = symbols.map((s, i) => `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm" 
                  style="background-color: ${compareColors[i % compareColors.length]}20; 
                         color: ${compareColors[i % compareColors.length]}; 
                         border: 1px solid ${compareColors[i % compareColors.length]}">
                ${s}
                <button onclick="removeCompareSymbol('${s}')" class="ml-2 hover:opacity-70">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `).join('');
    }
    
    /**
     * è¼‰å…¥æ¯”è¼ƒåœ–è¡¨
     */
    async function loadCompareChart() {
        const input = document.getElementById('compareSymbols');
        const daysSelect = document.getElementById('compareDays');
        const symbols = input?.value?.trim();
        const days = daysSelect?.value || 90;
        
        if (!symbols) {
            showToast('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹è‚¡ç¥¨ä»£è™Ÿ');
            return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        const placeholder = document.getElementById('compareChartPlaceholder');
        const container = document.getElementById('compareChartContainer');
        const loading = document.getElementById('compareChartLoading');
        const resultTable = document.getElementById('compareResultTable');
        
        if (placeholder) placeholder.classList.add('hidden');
        if (container) container.classList.add('hidden');
        if (loading) loading.classList.remove('hidden');
        if (resultTable) resultTable.classList.add('hidden');
        
        try {
            const res = await apiRequest(`/api/stock/compare/history?symbols=${encodeURIComponent(symbols)}&days=${days}`);
            const data = await res.json();
            
            if (!data.success) {
                throw new Error(data.detail || 'å–å¾—è³‡æ–™å¤±æ•—');
            }
            
            // âœ… ä¿®æ­£ï¼šå¾Œç«¯è¿”å› data.data ç›´æ¥æ˜¯è‚¡ç¥¨å­—å…¸ï¼Œä¸æ˜¯ data.data.stocks
            const stocks = data.data;
            const symbolList = Object.keys(stocks);
            
            if (symbolList.length === 0) {
                throw new Error('æ‰¾ä¸åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™');
            }
            
            // æº–å‚™åœ–è¡¨è³‡æ–™
            const datasets = [];
            let tableHtml = '';
            
            symbolList.forEach((sym, idx) => {
                const stock = stocks[sym];
                const color = compareColors[idx % compareColors.length];
                
                // âœ… ä¿®æ­£ï¼šå¾Œç«¯è¿”å› stock.historyï¼Œä¸æ˜¯ stock.data
                const historyData = stock.history || [];
                
                if (historyData.length === 0) return;
                
                datasets.push({
                    label: `${stock.name} (${sym})`,
                    data: historyData.map(d => ({ x: d.date, y: d.value })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    tension: 0.1,
                    fill: false,
                });
                
                // âœ… ä¿®æ­£ï¼šå¾ history è¨ˆç®—èµ·å§‹åƒ¹ã€çµæŸåƒ¹ã€æ¼²è·Œå¹…
                const startValue = historyData[0]?.value || 100;
                const endValue = historyData[historyData.length - 1]?.value || 100;
                const changePct = endValue - startValue; // å› ç‚ºå·²ç¶“æ­£è¦åŒ–ç‚º 100 åŸºæº–
                
                const changeClass = changePct >= 0 ? 'text-green-600' : 'text-red-600';
                const changeIcon = changePct >= 0 ? 'â–²' : 'â–¼';
                
                tableHtml += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-3">
                            <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                            <span class="font-medium">${stock.name}</span>
                            <span class="text-gray-400 text-xs ml-1">${sym}</span>
                        </td>
                        <td class="text-right py-2 px-3">${startValue.toFixed(2)}%</td>
                        <td class="text-right py-2 px-3">${endValue.toFixed(2)}%</td>
                        <td class="text-right py-2 px-3 ${changeClass} font-medium">
                            ${changeIcon} ${Math.abs(changePct).toFixed(2)}%
                        </td>
                    </tr>
                `;
            });
            
            if (datasets.length === 0) {
                throw new Error('ç„¡æ³•è™•ç†è³‡æ–™');
            }
            
            // ç¹ªè£½åœ–è¡¨
            const canvas = document.getElementById('compareChart');
            if (!canvas) {
                throw new Error('æ‰¾ä¸åˆ°åœ–è¡¨å…ƒç´ ');
            }
            
            const ctx = canvas.getContext('2d');
            
            if (compareChart) {
                compareChart.destroy();
            }
            
            compareChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, boxWidth: 8 }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { 
                                unit: 'day', 
                                displayFormats: { day: 'MM/dd' } 
                            },
                            grid: { display: false },
                            ticks: { maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: '#F3F4F6' },
                            ticks: { callback: v => v.toFixed(0) + '%' }
                        }
                    }
                }
            });
            
            // æ›´æ–° UI
            if (loading) loading.classList.add('hidden');
            if (container) container.classList.remove('hidden');
            
            const tableBody = document.getElementById('compareTableBody');
            if (tableBody) tableBody.innerHTML = tableHtml;
            if (resultTable) resultTable.classList.remove('hidden');
            
        } catch (e) {
            console.error('èµ°å‹¢æ¯”è¼ƒå¤±æ•—:', e);
            if (loading) loading.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            showToast(e.message || 'è¼‰å…¥å¤±æ•—');
        }
    }
    
    /**
     * æ¸…ç©ºæ¯”è¼ƒ
     */
    function clearCompare() {
        const input = document.getElementById('compareSymbols');
        if (input) input.value = '';
        updateSelectedSymbols();
        
        const placeholder = document.getElementById('compareChartPlaceholder');
        const container = document.getElementById('compareChartContainer');
        const resultTable = document.getElementById('compareResultTable');
        
        if (placeholder) placeholder.classList.remove('hidden');
        if (container) container.classList.add('hidden');
        if (resultTable) resultTable.classList.add('hidden');
        
        if (compareChart) {
            compareChart.destroy();
            compareChart = null;
        }
    }
    
    // åˆå§‹åŒ–ï¼šç›£è½è¼¸å…¥è®ŠåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('compareSymbols');
        if (input) {
            input.addEventListener('input', updateSelectedSymbols);
        }
    });
    
    // å°å‡ºåˆ°å…¨åŸŸ
    window.addCompareSymbol = addCompareSymbol;
    window.removeCompareSymbol = removeCompareSymbol;
    window.updateSelectedSymbols = updateSelectedSymbols;
    window.loadCompareChart = loadCompareChart;
    window.clearCompare = clearCompare;
    
    console.log('ğŸ“ˆ compare.js æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/core.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * SELA æ ¸å¿ƒæ¨¡çµ„ (P0 å„ªåŒ–ç‰ˆ)
 * 
 * å„ªåŒ–å…§å®¹ï¼š
 * 1. DOM å¿«å– - æ¸›å°‘é‡è¤‡æŸ¥è©¢
 * 2. æ‰¹é‡æ›´æ–° - æ¸›å°‘ç€è¦½å™¨é‡æ’
 * 3. çµ±ä¸€å‘½åç©ºé–“ - æ¸›å°‘å…¨åŸŸæ±¡æŸ“
 * 
 * å‘å¾Œå…¼å®¹ï¼šä¿ç•™æ‰€æœ‰ window.xxx å°å‡º
 */

(function() {
    'use strict';
    
    // ============================================================
    // DOM å¿«å–ç³»çµ± (P0 æ ¸å¿ƒå„ªåŒ–)
    // ============================================================
    
    const _domCache = new Map();
    const _querySelectorCache = new Map();
    
    /**
     * å¿«å–ç‰ˆ getElementById
     * ç¬¬ä¸€æ¬¡æŸ¥è©¢å¾Œå¿«å–ï¼Œå¾ŒçºŒç›´æ¥è¿”å›
     * @param {string} id - å…ƒç´  ID
     * @param {boolean} force - å¼·åˆ¶é‡æ–°æŸ¥è©¢
     * @returns {HTMLElement|null}
     */
    function $(id, force = false) {
        if (!force && _domCache.has(id)) {
            return _domCache.get(id);
        }
        const el = document.getElementById(id);
        if (el) {
            _domCache.set(id, el);
        }
        return el;
    }
    
    /**
     * å¿«å–ç‰ˆ querySelector
     * @param {string} selector - CSS é¸æ“‡å™¨
     * @param {boolean} force - å¼·åˆ¶é‡æ–°æŸ¥è©¢
     * @returns {HTMLElement|null}
     */
    function $q(selector, force = false) {
        if (!force && _querySelectorCache.has(selector)) {
            return _querySelectorCache.get(selector);
        }
        const el = document.querySelector(selector);
        if (el) {
            _querySelectorCache.set(selector, el);
        }
        return el;
    }
    
    /**
     * æ¸…é™¤ DOM å¿«å–
     * ç•¶ DOM çµæ§‹è®ŠåŒ–æ™‚èª¿ç”¨ï¼ˆå¦‚å‹•æ…‹è¼‰å…¥å…§å®¹å¾Œï¼‰
     */
    function clearDomCache() {
        _domCache.clear();
        _querySelectorCache.clear();
        console.log('ğŸ—‘ï¸ DOM å¿«å–å·²æ¸…é™¤');
    }
    
    /**
     * é è¼‰å…¥å¸¸ç”¨ DOM å…ƒç´ åˆ°å¿«å–
     */
    function preloadDomCache() {
        const commonIds = [
            'loading-screen', 'app-content',
            'userName', 'userAvatar', 'sidebarUserName', 'sidebarAvatar',
            'sessionTimer', 'sidebarTimer',
            'mobileSidebar', 'sidebarOverlay',
            'toast', 'toastMessage', 'toastContainer',
            'searchSymbol', 'searchResult',
            'adminLink', 'adminSidebarLink', 'adminMobileLink'
        ];
        commonIds.forEach(id => $(id));
        console.log(`ğŸ“¦ å·²é è¼‰å…¥ ${_domCache.size} å€‹ DOM å…ƒç´ åˆ°å¿«å–`);
    }
    
    // ============================================================
    // æ‰¹é‡ DOM æ›´æ–° (P0 æ ¸å¿ƒå„ªåŒ–)
    // ============================================================
    
    /**
     * æ‰¹é‡æ›´æ–°å¤šå€‹å…ƒç´ 
     * ä½¿ç”¨ requestAnimationFrame ç¢ºä¿åœ¨åŒä¸€å¹€å…§å®Œæˆ
     * @param {Array} updates - [{id: 'xxx', prop: 'textContent', value: 'xxx'}, ...]
     */
    function batchUpdate(updates) {
        requestAnimationFrame(() => {
            updates.forEach(({ id, prop, value, html, className, classList }) => {
                const el = $(id);
                if (!el) return;
                
                if (prop && value !== undefined) {
                    el[prop] = value;
                }
                if (html !== undefined) {
                    el.innerHTML = html;
                }
                if (className !== undefined) {
                    el.className = className;
                }
                if (classList) {
                    if (classList.add) el.classList.add(...classList.add);
                    if (classList.remove) el.classList.remove(...classList.remove);
                    if (classList.toggle) {
                        Object.entries(classList.toggle).forEach(([cls, force]) => {
                            el.classList.toggle(cls, force);
                        });
                    }
                }
            });
        });
    }
    
    /**
     * å®‰å…¨è¨­ç½® innerHTMLï¼ˆæ‰¹é‡ç‰ˆï¼‰
     * å…ˆæ§‹å»ºå®Œæ•´ HTML å­—ä¸²ï¼Œå†ä¸€æ¬¡æ€§æ›´æ–°
     * @param {string} id - å…ƒç´  ID
     * @param {string|Array} html - HTML å­—ä¸²æˆ–å­—ä¸²é™£åˆ—
     */
    function setHtml(id, html) {
        const el = $(id);
        if (!el) return;
        
        requestAnimationFrame(() => {
            el.innerHTML = Array.isArray(html) ? html.join('') : html;
        });
    }
    
    /**
     * ä½¿ç”¨ DocumentFragment æ‰¹é‡æ·»åŠ å­å…ƒç´ 
     * æ¯”å¤šæ¬¡ appendChild æ•ˆèƒ½å¥½ 10 å€
     * @param {string} containerId - å®¹å™¨å…ƒç´  ID
     * @param {Array} items - è¦æ·»åŠ çš„é …ç›®
     * @param {Function} renderFn - æ¸²æŸ“å‡½æ•¸ (item) => HTMLElement
     */
    function appendBatch(containerId, items, renderFn) {
        const container = $(containerId);
        if (!container) return;
        
        const fragment = document.createDocumentFragment();
        items.forEach(item => {
            const el = renderFn(item);
            if (el) fragment.appendChild(el);
        });
        
        requestAnimationFrame(() => {
            container.appendChild(fragment);
        });
    }
    
    // ============================================================
    // å…¨åŸŸè®Šæ•¸
    // ============================================================
    
    const API_BASE = '';
    let token = localStorage.getItem('token');
    let currentUser = JSON.parse(localStorage.getItem('user') || 'null');
    let sessionTimer = null;
    let lastActivity = Date.now();
    
    const deviceInfo = {
        isMobile: window.innerWidth < 768,
        isTouch: 'ontouchstart' in window,
        isLineApp: /Line\//i.test(navigator.userAgent),
        isIOS: /iPhone|iPad/i.test(navigator.userAgent),
        isAndroid: /Android/i.test(navigator.userAgent),
    };
    
    // ============================================================
    // API è«‹æ±‚å°è£
    // ============================================================
    
    async function apiRequest(endpoint, options = {}) {
        if (!token) {
            console.error('API è«‹æ±‚å¤±æ•—: ç„¡ token');
            clearAllUserData();
            window.location.href = '/static/index.html';
            throw new Error('æœªç™»å…¥');
        }
        
        const headers = {
            'Authorization': `Bearer ${token}`,
            ...options.headers
        };
        
        if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(options.body);
        }
        
        try {
            const res = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers
            });
            
            if (res.status === 401) {
                console.error('Token ç„¡æ•ˆï¼Œé‡æ–°ç™»å…¥');
                clearAllUserData();
                window.location.href = '/static/index.html';
                throw new Error('Token ç„¡æ•ˆ');
            }
            
            return res;
        } catch (e) {
            console.error(`API è«‹æ±‚å¤±æ•— ${endpoint}:`, e);
            throw e;
        }
    }
    
    // ============================================================
    // è‡ªå‹•ç™»å‡ºåŠŸèƒ½
    // ============================================================
    
    function getSessionTimeout() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const isAdmin = user.is_admin === true;
        return isAdmin ? 60 * 60 * 1000 : 10 * 60 * 1000;
    }
    
    function resetSessionTimer() {
        lastActivity = Date.now();
    }
    
    function checkSessionTimeout() {
        const SESSION_TIMEOUT = getSessionTimeout();
        const elapsed = Date.now() - lastActivity;
        const remaining = SESSION_TIMEOUT - elapsed;
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const isAdmin = user.is_admin === true;
        const timeoutMinutes = isAdmin ? 60 : 10;
        
        if (remaining <= 0) {
            showToast(`é–’ç½®è¶…é ${timeoutMinutes} åˆ†é˜ï¼Œå·²è‡ªå‹•ç™»å‡º`);
            setTimeout(() => logout(), 1500);
        } else {
            const mins = Math.floor(remaining / 60000);
            const secs = Math.floor((remaining % 60000) / 1000);
            const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // âœ… ä½¿ç”¨å¿«å–ç‰ˆ DOM æŸ¥è©¢
            const timerEl = $('sessionTimer');
            const sidebarTimerEl = $('sidebarTimer');
            if (timerEl) timerEl.textContent = `é–’ç½®ç™»å‡º: ${timeStr}`;
            if (sidebarTimerEl) sidebarTimerEl.textContent = timeStr;
        }
    }
    
    function startSessionMonitor() {
        ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, resetSessionTimer, { passive: true });
        });
        sessionTimer = setInterval(checkSessionTimeout, 1000);
    }
    
    function stopSessionMonitor() {
        if (sessionTimer) {
            clearInterval(sessionTimer);
            sessionTimer = null;
        }
    }
    
    // ============================================================
    // ç™»å…¥é©—è­‰
    // ============================================================
    
    async function checkAuth() {
        if (!token) {
            console.log('ç„¡ tokenï¼Œè·³è½‰ç™»å…¥é ');
            clearAllUserData();
            window.location.href = '/static/index.html';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!res.ok) {
                console.error('Token é©—è­‰å¤±æ•—ï¼Œç‹€æ…‹ç¢¼:', res.status);
                throw new Error('Unauthorized');
            }
            
            const serverUser = await res.json();
            
            const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
            if (storedUser.id && storedUser.id !== serverUser.id) {
                console.error('ç”¨æˆ¶ ID ä¸ä¸€è‡´!');
                clearAllUserData();
                window.location.href = '/static/index.html';
                return;
            }
            
            if (storedUser.line_user_id && storedUser.line_user_id !== serverUser.line_user_id) {
                console.error('LINE ID ä¸ä¸€è‡´!');
                clearAllUserData();
                window.location.href = '/static/index.html';
                return;
            }
            
            currentUser = serverUser;
            
            localStorage.setItem('user', JSON.stringify({
                id: serverUser.id,
                display_name: serverUser.display_name,
                picture_url: serverUser.picture_url || '',
                line_user_id: serverUser.line_user_id,
                is_admin: serverUser.is_admin || false
            }));
            
            console.log('ç™»å…¥é©—è­‰æˆåŠŸ: ç”¨æˆ¶ ID =', serverUser.id);
            
            // âœ… P1: åŒæ­¥åˆ° AppState
            if (window.AppState) {
                window.AppState.setUser(serverUser);
            }
            
            updateUserUI();
            
            // âœ… ä½¿ç”¨å¿«å–ç‰ˆ DOM æŸ¥è©¢
            const loadingScreen = $('loading-screen');
            const appContent = $('app-content');
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (appContent) appContent.style.display = 'block';
            
            startSessionMonitor();
            
            if (typeof loadDashboard === 'function') {
                loadDashboard();
            }
            
        } catch (e) {
            console.error('é©—è­‰å¤±æ•—:', e);
            clearAllUserData();
            window.location.href = '/static/index.html';
        }
    }
    
    function updateUserUI() {
        if (!currentUser) return;
        
        // âœ… ä½¿ç”¨æ‰¹é‡æ›´æ–°æ¸›å°‘é‡æ’
        batchUpdate([
            { id: 'userName', prop: 'textContent', value: currentUser.display_name },
            { id: 'sidebarUserName', prop: 'textContent', value: currentUser.display_name },
        ]);
        
        // é ­åƒå–®ç¨è™•ç†ï¼ˆsrc å±¬æ€§ï¼‰
        const avatarUrl = currentUser.picture_url || 'https://via.placeholder.com/40';
        const avatarEl = $('userAvatar');
        const sidebarAvatarEl = $('sidebarAvatar');
        if (avatarEl) avatarEl.src = avatarUrl;
        if (sidebarAvatarEl) sidebarAvatarEl.src = avatarUrl;
        
        // ç®¡ç†å“¡å…¥å£
        if (currentUser.is_admin) {
            const adminLink = $('adminLink');
            const adminSidebarLink = $('adminSidebarLink');
            const adminMobileLink = $('adminMobileLink');
            if (adminLink) adminLink.classList.remove('hidden');
            if (adminSidebarLink) adminSidebarLink.classList.remove('hidden');
            if (adminMobileLink) {
                adminMobileLink.classList.remove('hidden');
                adminMobileLink.classList.add('flex');
            }
            
            if (typeof triggerAdminUpdates === 'function') {
                triggerAdminUpdates();
            }
        }
    }
    
    function clearAllUserData() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('login_time');
        sessionStorage.clear();
        currentUser = null;
        token = null;
    }

    function logout() {
        stopSessionMonitor();
        clearAllUserData();
        
        // âœ… P1: é‡ç½® AppState
        if (window.AppState) {
            window.AppState.reset();
        }
        
        window.location.href = '/static/index.html';
    }
    
    function getCurrentUser() {
        return currentUser;
    }
    
    function getToken() {
        return token;
    }
    
    // ============================================================
    // æ‰‹æ©Ÿç‰ˆé¸å–®
    // ============================================================
    
    function openMobileSidebar() {
        // âœ… ä½¿ç”¨å¿«å–ç‰ˆ DOM æŸ¥è©¢
        const sidebar = $('mobileSidebar');
        const overlay = $('sidebarOverlay');
        if (sidebar) sidebar.classList.add('open');
        if (overlay) overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
    }
    
    function closeMobileSidebar() {
        const sidebar = $('mobileSidebar');
        const overlay = $('sidebarOverlay');
        if (sidebar) sidebar.classList.remove('open');
        if (overlay) overlay.classList.remove('open');
        document.body.style.overflow = '';
    }
    
    function mobileNavTo(section) {
        closeMobileSidebar();
        showSection(section);
        
        // âœ… åªæŸ¥è©¢ä¸€æ¬¡ï¼Œä¸åœ¨è¿´åœˆä¸­é‡è¤‡æŸ¥è©¢
        document.querySelectorAll('.bottom-nav-item, .mobile-nav-link').forEach(el => {
            const isActive = el.dataset.section === section;
            el.classList.remove('active', 'bg-blue-50', 'text-gray-700');
            
            if (isActive) {
                el.classList.add('active');
                if (el.classList.contains('mobile-nav-link')) {
                    el.classList.add('bg-blue-50', 'text-gray-700');
                }
            } else if (el.classList.contains('mobile-nav-link')) {
                el.classList.add('text-gray-600');
            }
        });
    }
    
    // ============================================================
    // é é¢åˆ‡æ› (å„ªåŒ–ç‰ˆ)
    // ============================================================
    
    // å¿«å–æ‰€æœ‰ section å…ƒç´ 
    let _sectionsCache = null;
    function getAllSections() {
        if (!_sectionsCache) {
            _sectionsCache = document.querySelectorAll('.section');
        }
        return _sectionsCache;
    }
    
    // å¿«å–æ‰€æœ‰å°èˆªé€£çµ
    let _navLinksCache = null;
    function getAllNavLinks() {
        if (!_navLinksCache) {
            _navLinksCache = document.querySelectorAll('.nav-link');
        }
        return _navLinksCache;
    }
    
    // å¿«å–æ‰€æœ‰åº•éƒ¨å°èˆª
    let _bottomNavCache = null;
    function getAllBottomNav() {
        if (!_bottomNavCache) {
            _bottomNavCache = document.querySelectorAll('.bottom-nav-item');
        }
        return _bottomNavCache;
    }
    
    function showSection(name, evt) {
        // âœ… P1: åŒæ­¥åˆ° AppState
        if (window.AppState) {
            window.AppState.switchSection(name);
        }
        
        // âœ… ä½¿ç”¨å¿«å–çš„ section åˆ—è¡¨
        getAllSections().forEach(s => s.classList.add('hidden'));
        
        const section = $(`section-${name}`);
        if (section) {
            section.classList.remove('hidden');
        }
        
        // âœ… ä½¿ç”¨å¿«å–çš„å°èˆªé€£çµ
        getAllNavLinks().forEach(l => {
            const isActive = l.dataset.section === name;
            l.classList.toggle('bg-blue-50', isActive);
            l.classList.toggle('text-gray-700', isActive);
            l.classList.toggle('text-gray-600', !isActive);
        });
        
        if (evt && evt.target) {
            const navLink = evt.target.closest('.nav-link');
            if (navLink) {
                navLink.classList.add('bg-blue-50', 'text-gray-700');
                navLink.classList.remove('text-gray-600');
            }
        }
        
        // âœ… ä½¿ç”¨å¿«å–çš„åº•éƒ¨å°èˆª
        getAllBottomNav().forEach(el => {
            el.classList.toggle('active', el.dataset.section === name);
        });

        // è¼‰å…¥å°æ‡‰è³‡æ–™
        if (name === 'watchlist' && typeof loadWatchlist === 'function') loadWatchlist();
        if (name === 'sentiment' && typeof loadSentimentDetail === 'function') loadSentimentDetail();
        if (name === 'settings' && typeof loadSettings === 'function') loadSettings();
        if (name === 'portfolio' && typeof loadPortfolio === 'function') loadPortfolio();
        if (name === 'subscription' && typeof loadSubscriptionData === 'function') loadSubscriptionData();
        if (name === 'cagr' && typeof initCagr === 'function') initCagr();
        
        if (name === 'admin') {
            if (typeof adminLoadStats === 'function') adminLoadStats();
            if (typeof adminLoadUsers === 'function') adminLoadUsers();
        }
    }
    
    // ============================================================
    // Toast æç¤º (å„ªåŒ–ç‰ˆ)
    // ============================================================
    
    function showToast(message, type = 'info', duration = 3000) {
        // âœ… ä½¿ç”¨å¿«å–ç‰ˆ DOM æŸ¥è©¢
        const container = $('toastContainer');
        if (container) {
            const toast = document.createElement('div');
            toast.className = 'toast bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg mb-2 transform transition-all duration-300 translate-y-full opacity-0';
            toast.textContent = message;
            container.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-full', 'opacity-0');
            });
            
            setTimeout(() => {
                toast.classList.add('translate-y-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, duration);
            return;
        }
        
        const toastEl = $('toast');
        const toastMsg = $('toastMessage');
        if (toastEl && toastMsg) {
            toastMsg.textContent = message;
            toastEl.classList.remove('hidden');
            setTimeout(() => toastEl.classList.add('hidden'), duration);
        }
    }
    
    // ============================================================
    // å·¥å…·å‡½æ•¸
    // ============================================================
    
    /**
     * æ‘ºç–Šé¢æ¿åˆ‡æ›
     */
    function toggleCollapsible(button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (content.style.maxHeight) {
            content.style.maxHeight = null;
            if (icon) icon.style.transform = '';
        } else {
            content.style.maxHeight = content.scrollHeight + 'px';
            if (icon) icon.style.transform = 'rotate(180deg)';
        }
    }
    
    // ============================================================
    // åˆå§‹åŒ–
    // ============================================================
    
    function init() {
        console.log('ğŸš€ SELA ç³»çµ±åˆå§‹åŒ–ä¸­... (P0 å„ªåŒ–ç‰ˆ)');
        console.log('Device info:', deviceInfo);
        
        // âœ… é è¼‰å…¥å¸¸ç”¨ DOM å…ƒç´ 
        preloadDomCache();
        
        checkAuth();
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // ============================================================
    // SELA å‘½åç©ºé–“ (P0+P1)
    // ============================================================
    
    window.SELA = window.SELA || {};
    Object.assign(window.SELA, {
        // DOM å·¥å…·
        $,
        $q,
        clearDomCache,
        preloadDomCache,
        
        // æ‰¹é‡æ›´æ–°
        batchUpdate,
        setHtml,
        appendBatch,
        
        // ç‹€æ…‹ (P1: AppState åœ¨ state.js ä¸­)
        getCurrentUser,
        getToken,
        deviceInfo,
        
        // API
        apiRequest,
        
        // UI
        showSection,
        showToast,
        
        // ç‰ˆæœ¬
        version: '0.8.2-p1'
    });
    
    // ============================================================
    // å‘å¾Œå…¼å®¹ï¼šå°å‡ºåˆ°å…¨åŸŸ
    // ============================================================
    
    window.API_BASE = API_BASE;
    window.apiRequest = apiRequest;
    window.getCurrentUser = getCurrentUser;
    window.getToken = getToken;
    window.checkAuth = checkAuth;
    window.logout = logout;
    window.clearAllUserData = clearAllUserData;
    window.showSection = showSection;
    window.openMobileSidebar = openMobileSidebar;
    window.closeMobileSidebar = closeMobileSidebar;
    window.mobileNavTo = mobileNavTo;
    window.showToast = showToast;
    window.deviceInfo = deviceInfo;
    window.toggleCollapsible = toggleCollapsible;
    
    // å…¼å®¹èˆŠä»£ç¢¼
    window.token = token;
    window.currentUser = currentUser;
    
    // âœ… æ–°å¢ï¼šå°å‡º DOM å¿«å–å·¥å…·ä¾›å…¶ä»–æ¨¡çµ„ä½¿ç”¨
    window.$ = $;
    window.$q = $q;
    window.clearDomCache = clearDomCache;
    window.batchUpdate = batchUpdate;
    window.setHtml = setHtml;
    
    console.log('ğŸ¯ core.js æ ¸å¿ƒæ¨¡çµ„å·²è¼‰å…¥ (P0 å„ªåŒ–ç‰ˆ)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/dashboard.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * å„€è¡¨æ¿æ¨¡çµ„
 * åŒ…å«ï¼šBTC åƒ¹æ ¼ã€ä¸‰å¤§æŒ‡æ•¸ã€å¸‚å ´æƒ…ç·’ã€ç†±é–€è¿½è¹¤çµ±è¨ˆ
 */

(function() {
    'use strict';
    
    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================
    
    let btcRefreshInterval = null;
    let indexCharts = {};
    let indexModalChart = null;
    let currentIndexSymbol = '';
    let currentIndexName = '';
    let sentimentModalChart = null;
    let currentSentimentMarket = '';
    let currentSentimentName = '';
    
    // ============================================================
    // BTC åƒ¹æ ¼
    // ============================================================
    
    async function loadBtcPrice() {
        const priceEl = document.getElementById('btc-price');
        const changeEl = document.getElementById('btc-change');
        const cardEl = document.getElementById('btc-price-card');
        const indicatorEl = document.getElementById('btc-update-indicator');

        if (!priceEl || !changeEl) return;

        try {
            if (indicatorEl) indicatorEl.classList.remove('hidden');

            // ç›´æ¥ç”¨ CoinGecko Simple API å–å³æ™‚åƒ¹æ ¼
            const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
            const data = await res.json();
            
            console.log('[BTC] CoinGecko å›æ‡‰:', data);

            if (data.bitcoin) {
                const price = data.bitcoin.usd || 0;
                const dayChange = data.bitcoin.usd_24h_change || 0;
                
                if (price > 0) {
                    priceEl.textContent = '$' + price.toLocaleString('en-US', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    });

                    const prefix = dayChange >= 0 ? '+' : '';
                    changeEl.textContent = `${prefix}${dayChange.toFixed(2)}%`;
                    
                    changeEl.classList.remove('text-green-200', 'text-red-200');
                    changeEl.classList.add(dayChange >= 0 ? 'text-green-200' : 'text-red-200');

                    // æ ¹æ“šæ¼²è·Œå¹…æ”¹è®Šå¡ç‰‡é¡è‰²
                    if (cardEl) {
                        cardEl.classList.remove(
                            'from-orange-500', 'to-yellow-500', 
                            'from-green-500', 'to-emerald-500', 
                            'from-red-500', 'to-rose-500'
                        );
                        if (dayChange >= 3) {
                            cardEl.classList.add('from-green-500', 'to-emerald-500');
                        } else if (dayChange <= -3) {
                            cardEl.classList.add('from-red-500', 'to-rose-500');
                        } else {
                            cardEl.classList.add('from-orange-500', 'to-yellow-500');
                        }
                    }
                } else {
                    priceEl.textContent = 'è¼‰å…¥ä¸­...';
                }
            }
        } catch (e) {
            console.error('[BTC] è¼‰å…¥å¤±æ•—:', e);
            // å‚™æ´ï¼šä½¿ç”¨å¾Œç«¯ API
            try {
                const backupRes = await fetch('/api/crypto/BTC');
                const backupData = await backupRes.json();
                if (backupData.success && backupData.price?.current) {
                    priceEl.textContent = '$' + backupData.price.current.toLocaleString('en-US', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    });
                    const change = backupData.change?.day || 0;
                    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                }
            } catch (backupErr) {
                console.error('[BTC] å‚™æ´ API ä¹Ÿå¤±æ•—:', backupErr);
            }
        } finally {
            if (indicatorEl) setTimeout(() => indicatorEl.classList.add('hidden'), 500);
        }
        
        // è¨­å®šè‡ªå‹•æ›´æ–°ï¼ˆæ¯åˆ†é˜ï¼‰
        if (!btcRefreshInterval) {
            btcRefreshInterval = setInterval(loadBtcPrice, 60000);
        }
    }
    
    // ============================================================
    // ä¸‰å¤§æŒ‡æ•¸
    // ============================================================
    
    async function loadIndices() {
        try {
            console.log('é–‹å§‹è¼‰å…¥æŒ‡æ•¸...');
            const res = await fetch('/api/market/indices');
            const data = await res.json();
            
            if (data.success && data.data && data.data.indices) {
                const indices = data.data.indices;
                
                if (indices['^GSPC']) updateIndexCard('GSPC', indices['^GSPC']);
                if (indices['^DJI']) updateIndexCard('DJI', indices['^DJI']);
                if (indices['^IXIC']) updateIndexCard('IXIC', indices['^IXIC']);
                if (indices['^TWII']) updateIndexCard('TWII', indices['^TWII']);
            }
        } catch (e) {
            console.error('è¼‰å…¥æŒ‡æ•¸å¤±æ•—', e);
        }
    }
    
    function updateIndexCard(symbol, data) {
        const priceEl = document.getElementById(`index-${symbol}-price`);
        const changeEl = document.getElementById(`index-${symbol}-change`);
        const dateEl = document.getElementById(`index-${symbol}-date`);
        
        if (priceEl) {
            priceEl.textContent = data.close 
                ? data.close.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) 
                : '--';
        }
        
        if (changeEl && data.change_pct !== undefined) {
            const isPositive = data.change_pct >= 0;
            changeEl.textContent = `${isPositive ? 'â–²' : 'â–¼'} ${Math.abs(data.change_pct).toFixed(2)}%`;
            changeEl.className = `text-sm font-medium ${isPositive ? 'text-green-600' : 'text-red-600'}`;
        }
        
        if (dateEl && data.date) {
            dateEl.textContent = `æ›´æ–°: ${data.date}`;
        }
    }
    
    // ============================================================
    // æŒ‡æ•¸åœ–è¡¨ Modal
    // ============================================================
    
    function openIndexModal(symbol, name) {
        currentIndexSymbol = symbol;
        currentIndexName = name;
        document.getElementById('indexModalTitle').textContent = name;
        document.getElementById('indexChartModal').classList.add('open');
        document.body.style.overflow = 'hidden';
        loadIndexModalChart(365);
    }
    
    function closeIndexModal() {
        document.getElementById('indexChartModal').classList.remove('open');
        document.body.style.overflow = '';
    }
    
    async function loadIndexModalChart(days) {
        const canvas = document.getElementById('indexModalChart');
        if (!canvas) return;
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.index-modal-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent === '1M' && days === 30) btn.classList.add('active');
            if (btn.textContent === '3M' && days === 90) btn.classList.add('active');
            if (btn.textContent === '1Y' && days === 365) btn.classList.add('active');
            if (btn.textContent === '5Y' && days === 1825) btn.classList.add('active');
        });
        
        try {
            const res = await fetch(`/api/market/indices/${currentIndexSymbol}/history?days=${days}`);
            const data = await res.json();
            
            if (data.success && data.data && data.data.history) {
                const history = data.data.history;
                const labels = history.map(h => h.date);
                const prices = history.map(h => h.close);
                
                if (indexModalChart) indexModalChart.destroy();
                
                const cleanSymbol = currentIndexSymbol.replace('^', '');
                const colorMap = { 'GSPC': '#3B82F6', 'DJI': '#10B981', 'IXIC': '#8B5CF6', 'TWII': '#EF4444' };
                const color = colorMap[cleanSymbol] || '#3B82F6';
                
                const ctx = canvas.getContext('2d');
                indexModalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: currentIndexName,
                            data: prices,
                            borderColor: color,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2})
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { maxTicksLimit: 8, font: { size: 11 } }, grid: { display: false } },
                            y: { ticks: { font: { size: 11 }, callback: v => v.toLocaleString() }, grid: { color: '#F3F4F6' } }
                        }
                    }
                });
            }
        } catch (e) {
            console.error('è¼‰å…¥æŒ‡æ•¸èµ°å‹¢å¤±æ•—', e);
        }
    }
    
    // ============================================================
    // å¸‚å ´æƒ…ç·’
    // ============================================================
    
    async function loadSentiment() {
        try {
            const res = await fetch('/api/market/sentiment');
            const data = await res.json();
            
            if (data.success) {
                updateSentimentCard('stock', data.stock || { value: 50, classification: 'neutral' });
                updateSentimentCard('crypto', data.crypto || { value: 50, classification: 'neutral' });
            }
        } catch (e) {
            console.error('è¼‰å…¥æƒ…ç·’å¤±æ•—', e);
            updateSentimentCard('stock', { value: 50, classification: 'neutral' });
            updateSentimentCard('crypto', { value: 50, classification: 'neutral' });
        }
    }

    function updateSentimentCard(type, sentiment) {
        if (!sentiment) return;
        
        const value = sentiment.value;
        
        // æ›´æ–°æ•¸å€¼
        const gaugeValue = document.getElementById(`${type}GaugeValue`);
        if (gaugeValue) gaugeValue.textContent = value;
        
        // æ›´æ–°æŒ‡é‡è§’åº¦
        const angle = -90 + (value / 100) * 180;
        const needleGroup = document.getElementById(`${type}NeedleGroup`);
        if (needleGroup) needleGroup.style.transform = `rotate(${angle}deg)`;
        
        // æ±ºå®šç‹€æ…‹
        let label, colorClass;
        if (value <= 25) { label = 'Extreme Fear'; colorClass = 'text-red-600'; }
        else if (value <= 45) { label = 'Fear'; colorClass = 'text-orange-500'; }
        else if (value <= 55) { label = 'Neutral'; colorClass = 'text-gray-500'; }
        else if (value <= 75) { label = 'Greed'; colorClass = 'text-green-500'; }
        else { label = 'Extreme Greed'; colorClass = 'text-emerald-600'; }
        
        const statusEl = document.getElementById(`${type}SentimentStatus`);
        if (statusEl) {
            statusEl.textContent = label;
            statusEl.className = `text-center font-semibold mt-1 ${colorClass}`;
        }
        
        const timeEl = document.getElementById(`${type}SentimentTime`);
        if (timeEl && sentiment.updated_at) {
            const date = new Date(sentiment.updated_at);
            timeEl.textContent = `Last updated ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        }
    }
    
    // ============================================================
    // æƒ…ç·’åœ–è¡¨ Modal
    // ============================================================
    
    function openSentimentModal(market, name) {
        currentSentimentMarket = market;
        currentSentimentName = name;
        document.getElementById('sentimentModalTitle').textContent = name;
        document.getElementById('sentimentChartModal').classList.add('open');
        document.body.style.overflow = 'hidden';
        loadSentimentModalChart(180);
    }
    
    function closeSentimentModal() {
        document.getElementById('sentimentChartModal').classList.remove('open');
        document.body.style.overflow = '';
    }
    
    async function loadSentimentModalChart(days) {
        const canvas = document.getElementById('sentimentModalChart');
        if (!canvas) return;
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.sentiment-modal-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent === '1M' && days === 30) btn.classList.add('active');
            if (btn.textContent === '3M' && days === 90) btn.classList.add('active');
            if (btn.textContent === '6M' && days === 180) btn.classList.add('active');
            if (btn.textContent === '1Y' && days === 365) btn.classList.add('active');
        });
        
        try {
            const res = await fetch(`/api/market/sentiment/${currentSentimentMarket}/history?days=${days}`);
            const data = await res.json();
            
            if (data.success && data.data && data.data.history) {
                const history = data.data.history;
                const labels = history.map(h => h.date);
                const values = history.map(h => h.value);
                
                if (sentimentModalChart) sentimentModalChart.destroy();
                
                const ctx = canvas.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, 'rgba(34, 197, 94, 0.3)');
                gradient.addColorStop(0.5, 'rgba(234, 179, 8, 0.2)');
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.3)');
                
                const color = currentSentimentMarket === 'stock' ? '#3B82F6' : '#F97316';
                
                sentimentModalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: currentSentimentName,
                            data: values,
                            borderColor: color,
                            backgroundColor: gradient,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => {
                                        const v = ctx.parsed.y;
                                        let status = '';
                                        if (v <= 25) status = '(Extreme Fear)';
                                        else if (v <= 45) status = '(Fear)';
                                        else if (v <= 55) status = '(Neutral)';
                                        else if (v <= 75) status = '(Greed)';
                                        else status = '(Extreme Greed)';
                                        return `${v} ${status}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { maxTicksLimit: 8, font: { size: 11 } }, grid: { display: false } },
                            y: {
                                min: 0, max: 100,
                                ticks: {
                                    font: { size: 11 }, stepSize: 25,
                                    callback: v => {
                                        if (v === 0) return '0 Fear';
                                        if (v === 100) return '100 Greed';
                                        return v;
                                    }
                                },
                                grid: { color: '#F3F4F6' }
                            }
                        }
                    }
                });
            }
        } catch (e) {
            console.error('è¼‰å…¥æƒ…ç·’èµ°å‹¢å¤±æ•—', e);
        }
    }
    
    // ============================================================
    // ğŸ†• ç†±é–€è¿½è¹¤çµ±è¨ˆ
    // ============================================================
    
    async function loadPopularStocks() {
        const container = document.getElementById('popularStocksContainer');
        if (!container) return;
        
        try {
            const res = await fetch('/api/watchlist/popular?limit=10');
            const data = await res.json();
            
            if (data.success && data.data && data.data.length > 0) {
                renderPopularStocks(data.data);
            } else {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400 text-sm">
                        <i class="fas fa-chart-line mb-2"></i>
                        <p>å°šç„¡è¿½è¹¤çµ±è¨ˆ</p>
                    </div>
                `;
            }
        } catch (e) {
            console.error('è¼‰å…¥ç†±é–€è¿½è¹¤å¤±æ•—:', e);
            container.innerHTML = `
                <div class="text-center py-4 text-gray-400 text-sm">
                    <p>è¼‰å…¥å¤±æ•—</p>
                </div>
            `;
        }
    }
    
    function renderPopularStocks(stocks) {
        const container = document.getElementById('popularStocksContainer');
        if (!container) return;
        
        const maxCount = stocks[0]?.count || 1;
        
        let html = `
            <div class="space-y-2">
                ${stocks.map((stock, index) => {
                    const barWidth = Math.max(20, (stock.count / maxCount) * 100);
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                    const bgClass = index < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50' : 'bg-gray-50';
                    
                    return `
                        <div class="flex items-center p-2 rounded-lg ${bgClass} hover:shadow-sm transition cursor-pointer" 
                             onclick="searchSymbol('${stock.symbol}')">
                            <span class="w-6 text-center text-sm">${medal || (index + 1)}</span>
                            <div class="flex-1 ml-2">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-gray-800 text-sm">${stock.symbol}</span>
                                    <span class="text-xs text-gray-500">${stock.count} äººè¿½è¹¤</span>
                                </div>
                                <div class="mt-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all" 
                                         style="width: ${barWidth}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // ============================================================
    // ä¸»è¼‰å…¥å‡½æ•¸
    // ============================================================
    
    async function loadDashboard() {
        await loadIndices();
        await loadSentiment();
        await loadBtcPrice();
        await loadPopularStocks();  // ğŸ†• è¼‰å…¥ç†±é–€è¿½è¹¤
        if (typeof loadWatchlistOverview === 'function') {
            await loadWatchlistOverview();
        }
    }
    
    // ç®¡ç†å“¡æ›´æ–°
    async function triggerAdminUpdates() {
        console.log('ğŸ”„ ç®¡ç†å“¡ç™»å…¥ï¼Œè§¸ç™¼å…¨éƒ¨æ›´æ–°...');
        const token = localStorage.getItem('token');
        
        try {
            fetch('/api/admin/update-indices', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(r => r.json()).then(d => {
                console.log('âœ… å››å¤§æŒ‡æ•¸æ›´æ–°:', d.success ? 'æˆåŠŸ' : 'å¤±æ•—');
            });
            
            fetch('/api/admin/update-price-cache', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(r => r.json()).then(d => {
                console.log('âœ… åƒ¹æ ¼å¿«å–æ›´æ–°:', d.success ? 'æˆåŠŸ' : 'å¤±æ•—');
            });
            
            loadBtcPrice();
            
            fetch('/api/admin/update-exchange-rate', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(r => r.json()).then(d => {
                console.log('âœ… åŒ¯ç‡æ›´æ–°:', d.success ? 'æˆåŠŸ' : 'å¤±æ•—');
            });
        } catch (e) {
            console.error('ç®¡ç†å“¡æ›´æ–°è§¸ç™¼å¤±æ•—:', e);
        }
    }
    
    /**
     * è¼‰å…¥ææ‡¼è²ªå©ªè©³ç´°é é¢
     */
    async function loadSentimentDetail() {
        const container = document.getElementById('sentimentContent');
        if (!container) return;
        
        // å…ˆå˜—è©¦å–å¾—æƒ…ç·’è³‡æ–™
        let stockData = { value: 50, classification: 'neutral' };
        let cryptoData = { value: 50, classification: 'neutral' };
        
        try {
            const res = await fetch('/api/market/sentiment');
            if (res.ok) {
                const data = await res.json();
                if (data.stock) stockData = data.stock;
                if (data.crypto) cryptoData = data.crypto;
            }
        } catch (e) {
            console.error('è¼‰å…¥æƒ…ç·’è³‡æ–™å¤±æ•—', e);
        }
        
        // ç”Ÿæˆç°¡æ½”å„€è¡¨ç›¤ SVG HTML
        function createGaugeSVG(id, value) {
            const angle = -90 + (value / 100) * 180;
            
            let label, colorClass;
            if (value <= 25) {
                label = 'Extreme Fear';
                colorClass = 'text-red-600';
            } else if (value <= 45) {
                label = 'Fear';
                colorClass = 'text-orange-500';
            } else if (value <= 55) {
                label = 'Neutral';
                colorClass = 'text-gray-500';
            } else if (value <= 75) {
                label = 'Greed';
                colorClass = 'text-green-500';
            } else {
                label = 'Extreme Greed';
                colorClass = 'text-emerald-600';
            }
            
            return `
                <div class="fear-greed-gauge">
                    <svg viewBox="0 0 200 115" class="gauge-svg">
                        <!-- å¼§å½¢èƒŒæ™¯å€æ®µ -->
                        <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                        <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                        <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                        <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                        <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                        
                        <!-- åˆ»åº¦æ•¸å­— -->
                        <text x="8" y="105" class="gauge-tick-text">0</text>
                        <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                        <text x="188" y="105" class="gauge-tick-text">100</text>
                        
                        <!-- æŒ‡é‡ -->
                        <g class="gauge-needle-group" style="transform: rotate(${angle}deg); transform-origin: 100px 100px;">
                            <polygon class="gauge-needle" points="100,25 97,100 103,100" />
                        </g>
                        <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                    </svg>
                </div>
                <div class="text-center mt-2">
                    <span class="text-4xl font-bold text-gray-800">${value}</span>
                </div>
                <p class="text-center font-semibold text-lg mt-1 ${colorClass}">${label}</p>
            `;
        }
        
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- ç¾è‚¡æƒ…ç·’ -->
                <div class="bg-white rounded-xl shadow p-6 cursor-pointer hover:shadow-lg" onclick="openSentimentModal('stock', 'ç¾è‚¡ææ‡¼è²ªå©ªæŒ‡æ•¸')">
                    <h3 class="font-semibold text-gray-700 mb-4 text-center">ç¾è‚¡æƒ…ç·’æŒ‡æ•¸ (Fear & Greed)</h3>
                    ${createGaugeSVG('stock-detail', stockData.value)}
                    <p class="text-center text-xs text-gray-400 mt-2">é»æ“ŠæŸ¥çœ‹æ­·å²è¶¨å‹¢</p>
                </div>
                
                <!-- å¹£åœˆæƒ…ç·’ -->
                <div class="bg-white rounded-xl shadow p-6 cursor-pointer hover:shadow-lg" onclick="openSentimentModal('crypto', 'å¹£åœˆææ‡¼è²ªå©ªæŒ‡æ•¸')">
                    <h3 class="font-semibold text-gray-700 mb-4 text-center">å¹£åœˆæƒ…ç·’æŒ‡æ•¸</h3>
                    ${createGaugeSVG('crypto-detail', cryptoData.value)}
                    <p class="text-center text-xs text-gray-400 mt-2">é»æ“ŠæŸ¥çœ‹æ­·å²è¶¨å‹¢</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="font-semibold text-gray-700 mb-4">å¸‚å ´æƒ…ç·’è§£è®€</h3>
                <div class="space-y-4 text-sm text-gray-600">
                    <div class="flex items-start">
                        <span class="w-24 flex-shrink-0 font-medium">0-25</span>
                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded mr-2">æ¥µåº¦ææ‡¼</span>
                        <span>å¸‚å ´ææ…Œï¼Œå¯èƒ½æ˜¯è²·å…¥æ©Ÿæœƒ</span>
                    </div>
                    <div class="flex items-start">
                        <span class="w-24 flex-shrink-0 font-medium">26-45</span>
                        <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded mr-2">ææ‡¼</span>
                        <span>å¸‚å ´åè¬¹æ…</span>
                    </div>
                    <div class="flex items-start">
                        <span class="w-24 flex-shrink-0 font-medium">46-55</span>
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded mr-2">ä¸­æ€§</span>
                        <span>è§€æœ›ç‚ºä¸»</span>
                    </div>
                    <div class="flex items-start">
                        <span class="w-24 flex-shrink-0 font-medium">56-75</span>
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded mr-2">è²ªå©ª</span>
                        <span>å¸‚å ´åæ¨‚è§€</span>
                    </div>
                    <div class="flex items-start">
                        <span class="w-24 flex-shrink-0 font-medium">76-100</span>
                        <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded mr-2">æ¥µåº¦è²ªå©ª</span>
                        <span>å¸‚å ´éç†±ï¼Œç•™æ„é¢¨éšª</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ============================================================
    // å°å‡ºåˆ°å…¨åŸŸ
    // ============================================================
    
    window.loadDashboard = loadDashboard;
    window.loadBtcPrice = loadBtcPrice;
    window.loadIndices = loadIndices;
    window.loadSentiment = loadSentiment;
    window.loadSentimentDetail = loadSentimentDetail;
    window.loadPopularStocks = loadPopularStocks;  // ğŸ†•
    window.openIndexModal = openIndexModal;
    window.closeIndexModal = closeIndexModal;
    window.loadIndexModalChart = loadIndexModalChart;
    window.openSentimentModal = openSentimentModal;
    window.closeSentimentModal = closeSentimentModal;
    window.loadSentimentModalChart = loadSentimentModalChart;
    window.triggerAdminUpdates = triggerAdminUpdates;
    
    console.log('ğŸ“Š dashboard.js æ¨¡çµ„å·²è¼‰å…¥ (P2 å«ç†±é–€è¿½è¹¤çµ±è¨ˆ)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/layout.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * ä½ˆå±€å…ƒä»¶å‹•æ…‹ç”Ÿæˆæ¨¡çµ„
 * ç”Ÿæˆå´é‚Šæ¬„ã€åº•éƒ¨å°èˆªç­‰é‡è¤‡ä½¿ç”¨çš„ UI å…ƒä»¶
 */

(function() {
    'use strict';

    // ============================================================
    // å°èˆªé …ç›®é…ç½®
    // ============================================================

    const NAV_ITEMS = [
        { id: 'dashboard', icon: 'fa-tachometer-alt', label: 'å„€è¡¨æ¿', mobileLabel: 'é¦–é ' },
        { id: 'search', icon: 'fa-search', label: 'è‚¡ç¥¨æŸ¥è©¢', mobileLabel: 'æŸ¥è©¢' },
        { id: 'watchlist', icon: 'fa-star', label: 'è¿½è¹¤æ¸…å–®', mobileLabel: 'è¿½è¹¤' },
        { id: 'sentiment', icon: 'fa-heart-pulse', label: 'ææ‡¼è²ªå©ª', mobileLabel: 'æƒ…ç·’' },
        { id: 'compare', icon: 'fa-chart-line', label: 'èµ°å‹¢æ¯”è¼ƒ' },
        { id: 'portfolio', icon: 'fa-wallet', label: 'å€‹äººæŠ•è³‡è¨˜éŒ„' },
        { id: 'subscription', icon: 'fa-satellite-dish', label: 'è¨‚é–±ç²¾é¸' },
        { id: 'cagr', icon: 'fa-trophy', label: 'å ±é…¬ç‡æ¯”è¼ƒ' },
        { id: 'settings', icon: 'fa-cog', label: 'è¨­å®š', mobileLabel: 'è¨­å®š', showInBottomNav: true }
    ];

    // åº•éƒ¨å°èˆªé¡¯ç¤ºçš„é …ç›®
    const BOTTOM_NAV_ITEMS = ['dashboard', 'search', 'watchlist', 'sentiment', 'settings'];

    // ============================================================
    // æ‰‹æ©Ÿç‰ˆå´é‚Šé¸å–®
    // ============================================================

    function renderMobileSidebar() {
        const sidebar = document.getElementById('mobileSidebar');
        if (!sidebar) return;

        const navItems = NAV_ITEMS.map(item => `
            <a href="#" onclick="mobileNavTo('${item.id}')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="${item.id}">
                <i class="fas ${item.icon} mr-3 w-5"></i>
                <span>${item.label}</span>
            </a>
        `).join('');

        sidebar.innerHTML = `
            <div class="p-4 border-b flex items-center justify-between">
                <div class="flex items-center">
                    <img src="/static/logo.png" alt="SELA" class="w-10 h-10 rounded-lg mr-2">
                    <span class="font-bold text-lg">SELA</span>
                </div>
                <button onclick="closeMobileSidebar()" class="p-2 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="p-4 space-y-2">
                ${navItems}
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <img id="sidebarAvatar" class="w-10 h-10 rounded-full mr-3" src="" alt="">
                        <span id="sidebarUserName" class="text-gray-700 font-medium"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-400 mb-2">
                    é–’ç½®ç™»å‡º: <span id="sidebarTimer">5:00</span>
                </div>
                <button onclick="logout()" class="w-full py-2 text-red-500 hover:bg-red-50 rounded-lg flex items-center justify-center touch-target">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span>ç™»å‡º</span>
                </button>
            </div>
        `;

        // è¨­å®šç¬¬ä¸€å€‹ç‚º active
        const firstLink = sidebar.querySelector('.mobile-nav-link');
        if (firstLink) {
            firstLink.classList.remove('text-gray-600', 'hover:bg-gray-50');
            firstLink.classList.add('text-gray-700', 'bg-blue-50');
        }
    }

    // ============================================================
    // é›»è…¦ç‰ˆå´é‚Šæ¬„
    // ============================================================

    function renderDesktopSidebar() {
        const sidebar = document.getElementById('desktopSidebar');
        if (!sidebar) return;

        const navItems = NAV_ITEMS.map((item, index) => `
            <a href="#" onclick="showSection('${item.id}', event)" class="nav-link flex items-center px-4 py-2 ${index === 0 ? 'text-gray-700 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'} rounded-lg" data-section="${item.id}">
                <i class="fas ${item.icon} mr-3"></i>
                <span>${item.label}</span>
            </a>
        `).join('');

        sidebar.innerHTML = `
            <nav class="p-4 space-y-2">
                ${navItems}
                <!-- ç®¡ç†å“¡å…¥å£ (é è¨­éš±è—) -->
                <a id="adminSidebarLink" href="#" onclick="showSection('admin', event)" class="hidden flex items-center px-4 py-2 text-orange-500 hover:bg-orange-50 rounded-lg mt-4 border-t pt-4" data-section="admin">
                    <i class="fas fa-user-shield mr-3"></i>
                    <span>ç®¡ç†å¾Œå°</span>
                </a>
            </nav>
        `;
    }

    // ============================================================
    // æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆªåˆ—
    // ============================================================

    function renderMobileBottomNav() {
        const nav = document.getElementById('mobileBottomNav');
        if (!nav) return;

        const navItems = BOTTOM_NAV_ITEMS.map((id, index) => {
            const item = NAV_ITEMS.find(n => n.id === id);
            if (!item) return '';
            return `
                <a href="#" onclick="mobileNavTo('${item.id}')" class="bottom-nav-item ${index === 0 ? 'active' : ''}" data-section="${item.id}">
                    <i class="fas ${item.icon}"></i>
                    <span>${item.mobileLabel || item.label}</span>
                </a>
            `;
        }).join('');

        nav.innerHTML = navItems;
    }

    // ============================================================
    // åˆå§‹åŒ–æ‰€æœ‰ä½ˆå±€å…ƒä»¶
    // ============================================================

    function initLayout() {
        renderMobileSidebar();
        renderDesktopSidebar();
        renderMobileBottomNav();
        console.log('âœ… ä½ˆå±€å…ƒä»¶å·²åˆå§‹åŒ–');
    }

    // ============================================================
    // å°å‡ºåˆ°å…¨åŸŸ
    // ============================================================

    window.initLayout = initLayout;
    window.renderMobileSidebar = renderMobileSidebar;
    window.renderDesktopSidebar = renderDesktopSidebar;
    window.renderMobileBottomNav = renderMobileBottomNav;

    // è‡ªå‹•åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLayout);
    } else {
        initLayout();
    }

})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/modals.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * Modal å‹•æ…‹ç”Ÿæˆæ¨¡çµ„
 * å°‡æ‰€æœ‰ Modal HTML å¾ dashboard.html ç§»å‡ºï¼Œæ”¹ç‚º JavaScript å‹•æ…‹å‰µå»º
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * 1. åœ¨ dashboard.html å¼•å…¥æ­¤æª”æ¡ˆ
 * 2. åœ¨ DOMContentLoaded æˆ–é©ç•¶æ™‚æ©Ÿèª¿ç”¨ initAllModals()
 */

(function() {
    'use strict';

    // ============================================================
    // Modal æ¨¡æ¿å®šç¾©
    // ============================================================

    const MODAL_TEMPLATES = {
        // ===== å…¨è¢å¹•åœ–è¡¨ =====
        chartFullscreen: `
            <div id="chartFullscreen" class="chart-fullscreen">
                <div class="chart-container h-full flex flex-col">
                    <div class="rotate-banner">
                        ğŸ“± æ©«å‘æ”¾ç½®æ‰‹æ©Ÿå¯ç²å¾—æ›´å¥½çš„åœ–è¡¨é«”é©—
                    </div>
                    <div class="flex items-center justify-between p-3 border-b bg-white">
                        <button onclick="closeChartFullscreen()" class="p-2 text-gray-600 touch-target">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        <span id="chartFullscreenTitle" class="font-bold text-lg"></span>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-1 p-4 bg-gray-50" style="min-height: 200px;">
                        <canvas id="fullscreenChart"></canvas>
                    </div>
                    <div class="flex items-center justify-center gap-2 p-3 bg-white border-t" id="chartRangeButtons">
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="22">1M</button>
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target active" data-days="65">3M</button>
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="130">6M</button>
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="252">1Y</button>
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="756">3Y</button>
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="1260">5Y</button>
                        <button type="button" class="chart-range-btn px-4 py-2 text-sm rounded border touch-target" data-days="99999">MAX</button>
                    </div>
                </div>
            </div>
        `,

        // ===== æŒ‡æ•¸åœ–è¡¨ Modal =====
        indexChartModal: `
            <div id="indexChartModal" class="chart-fullscreen">
                <div class="chart-container h-full flex flex-col">
                    <div class="rotate-banner">
                        ğŸ“± æ©«å‘æ”¾ç½®æ‰‹æ©Ÿå¯ç²å¾—æ›´å¥½çš„åœ–è¡¨é«”é©—
                    </div>
                    <div class="flex items-center justify-between p-3 border-b bg-white">
                        <button onclick="closeIndexModal()" class="p-2 text-gray-600 touch-target">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        <span id="indexModalTitle" class="font-bold text-lg"></span>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-1 p-4 bg-gray-50" style="min-height: 200px;">
                        <canvas id="indexModalChart"></canvas>
                    </div>
                    <div class="flex items-center justify-center gap-2 p-3 bg-white border-t">
                        <button type="button" onclick="loadIndexModalChart(30)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target">1M</button>
                        <button type="button" onclick="loadIndexModalChart(90)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target">3M</button>
                        <button type="button" onclick="loadIndexModalChart(365)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target active">1Y</button>
                        <button type="button" onclick="loadIndexModalChart(1825)" class="index-modal-btn px-4 py-2 text-sm rounded border touch-target">5Y</button>
                    </div>
                </div>
            </div>
        `,

        // ===== æƒ…ç·’åœ–è¡¨ Modal =====
        sentimentChartModal: `
            <div id="sentimentChartModal" class="chart-fullscreen">
                <div class="chart-container h-full flex flex-col">
                    <div class="rotate-banner">
                        ğŸ“± æ©«å‘æ”¾ç½®æ‰‹æ©Ÿå¯ç²å¾—æ›´å¥½çš„åœ–è¡¨é«”é©—
                    </div>
                    <div class="flex items-center justify-between p-3 border-b bg-white">
                        <button onclick="closeSentimentModal()" class="p-2 text-gray-600 touch-target">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        <span id="sentimentModalTitle" class="font-bold text-lg"></span>
                        <div class="w-10"></div>
                    </div>
                    <div class="flex-1 p-4 bg-gray-50" style="min-height: 200px;">
                        <canvas id="sentimentModalChart"></canvas>
                    </div>
                    <div class="flex items-center justify-center gap-2 p-3 bg-white border-t">
                        <button type="button" onclick="loadSentimentModalChart(30)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target">1M</button>
                        <button type="button" onclick="loadSentimentModalChart(90)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target">3M</button>
                        <button type="button" onclick="loadSentimentModalChart(180)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target active">6M</button>
                        <button type="button" onclick="loadSentimentModalChart(365)" class="sentiment-modal-btn px-4 py-2 text-sm rounded border touch-target">1Y</button>
                    </div>
                </div>
            </div>
        `,

        // ===== å¹´åŒ–å ±é…¬ç‡ Modal =====
        returnsModal: `
            <div id="returnsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-percentage text-green-600 mr-2"></i>
                            <span id="returnsModalTitle">å¹´åŒ–å ±é…¬ç‡</span>
                        </h3>
                        <button onclick="closeReturnsModal()" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="returnsModalContent" class="p-4">
                        <div class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
                            <p class="mt-2 text-gray-500">è¨ˆç®—ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        `,

        // ===== å°è‚¡äº¤æ˜“ Modal =====
        twTransactionModal: `
            <div id="twTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-landmark text-red-500 mr-2"></i>
                            <span id="twModalTitle">æ–°å¢å°è‚¡äº¤æ˜“</span>
                        </h3>
                        <button onclick="closeTwModal()" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <input type="hidden" id="twEditId">
                        
                        <!-- äº¤æ˜“é¡å‹ -->
                        <div class="flex gap-2 mb-4">
                            <button type="button" onclick="setTwType('buy')" id="twBtnBuy" class="flex-1 py-2 rounded-lg font-medium transition-all bg-green-500 text-white">
                                <i class="fas fa-arrow-down mr-1"></i>è²·å…¥
                            </button>
                            <button type="button" onclick="setTwType('sell')" id="twBtnSell" class="flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600">
                                <i class="fas fa-arrow-up mr-1"></i>è³£å‡º
                            </button>
                        </div>
                        <input type="hidden" id="twTxType" value="buy">
                        
                        <!-- è‚¡ç¥¨ä»£ç¢¼ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨ä»£ç¢¼ <span class="text-red-500">*</span></label>
                            <input type="text" id="twSymbol" placeholder="ä¾‹: 2330" 
                                   oninput="lookupTwStock()"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        
                        <!-- è‚¡ç¥¨åç¨±ï¼ˆå”¯è®€ï¼‰ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨åç¨±</label>
                            <div id="twNameDisplay" class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-600 min-h-[42px] flex items-center">
                                <span class="text-gray-400">è¼¸å…¥ä»£ç¢¼è‡ªå‹•å¸¶å…¥</span>
                            </div>
                            <input type="hidden" id="twName">
                        </div>
                        
                        <!-- æ•¸é‡ï¼šå¼µ + é›¶è‚¡ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">æ•¸é‡ <span class="text-red-500">*</span></label>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="relative">
                                    <input type="number" id="twLots" placeholder="0" min="0"
                                           oninput="updateTwQuantity()"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 pr-10">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">å¼µ</span>
                                </div>
                                <div class="relative">
                                    <input type="number" id="twOddLot" placeholder="0" min="0" max="999"
                                           oninput="updateTwQuantity()"
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 pr-12">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">é›¶è‚¡</span>
                                </div>
                            </div>
                            <p id="twQuantityDisplay" class="text-xs text-gray-500 mt-1">= 0 è‚¡</p>
                        </div>
                        
                        <!-- æˆäº¤åƒ¹å’Œæ‰‹çºŒè²» -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-gray-700 mb-2 text-sm">æˆäº¤åƒ¹ <span class="text-red-500">*</span></label>
                                <input type="number" id="twPrice" placeholder="850" step="0.01" min="0.01"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 text-sm">æ‰‹çºŒè²»</label>
                                <input type="number" id="twFee" placeholder="0" step="1" min="0"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                        </div>
                        
                        <!-- äº¤æ˜“ç¨… -->
                        <div class="mb-4" id="twTaxField">
                            <label class="block text-gray-700 mb-2 text-sm">äº¤æ˜“ç¨…ï¼ˆè³£å‡ºï¼‰</label>
                            <input type="number" id="twTax" placeholder="0" step="1" min="0"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        
                        <!-- äº¤æ˜“æ—¥æœŸ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">äº¤æ˜“æ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="twDate" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        
                        <!-- å‚™è¨» -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">å‚™è¨»</label>
                            <input type="text" id="twNote" placeholder="é¸å¡«" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        
                        <!-- é€å‡º -->
                        <button onclick="submitTwTransaction()" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">
                            <i class="fas fa-check mr-2"></i>ç¢ºèª
                        </button>
                    </div>
                </div>
            </div>
        `,

        // ===== ç¾è‚¡äº¤æ˜“ Modal =====
        usTransactionModal: `
            <div id="usTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-flag-usa text-blue-500 mr-2"></i>
                            <span id="usModalTitle">æ–°å¢ç¾è‚¡äº¤æ˜“</span>
                        </h3>
                        <button onclick="closeUsModal()" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <input type="hidden" id="usEditId">
                        
                        <!-- äº¤æ˜“é¡å‹ -->
                        <div class="flex gap-2 mb-4">
                            <button type="button" onclick="setUsType('buy')" id="usBtnBuy" class="flex-1 py-2 rounded-lg font-medium transition-all bg-green-500 text-white">
                                <i class="fas fa-arrow-down mr-1"></i>è²·å…¥
                            </button>
                            <button type="button" onclick="setUsType('sell')" id="usBtnSell" class="flex-1 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-600">
                                <i class="fas fa-arrow-up mr-1"></i>è³£å‡º
                            </button>
                        </div>
                        <input type="hidden" id="usTxType" value="buy">
                        
                        <!-- è‚¡ç¥¨ä»£ç¢¼ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨ä»£ç¢¼ <span class="text-red-500">*</span></label>
                            <input type="text" id="usSymbol" placeholder="ä¾‹: AAPL" 
                                   oninput="lookupUsStock()"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 uppercase">
                        </div>
                        
                        <!-- è‚¡ç¥¨åç¨±ï¼ˆå”¯è®€ï¼‰ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨åç¨±</label>
                            <div id="usNameDisplay" class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-600 min-h-[42px] flex items-center">
                                <span class="text-gray-400">è¼¸å…¥ä»£ç¢¼è‡ªå‹•å¸¶å…¥</span>
                            </div>
                            <input type="hidden" id="usName">
                        </div>
                        
                        <!-- è‚¡æ•¸ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">è‚¡æ•¸ <span class="text-red-500">*</span></label>
                            <input type="number" id="usQuantity" placeholder="10" min="1"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <!-- æˆäº¤åƒ¹å’Œæ‰‹çºŒè²» -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-gray-700 mb-2 text-sm">æˆäº¤åƒ¹ (USD) <span class="text-red-500">*</span></label>
                                <input type="number" id="usPrice" placeholder="185.50" step="0.01" min="0.01"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2 text-sm">æ‰‹çºŒè²»</label>
                                <input type="number" id="usFee" placeholder="0" step="0.01" min="0"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- äº¤æ˜“ç¨… -->
                        <div class="mb-4" id="usTaxField">
                            <label class="block text-gray-700 mb-2 text-sm">äº¤æ˜“ç¨…ï¼ˆè³£å‡ºï¼‰</label>
                            <input type="number" id="usTax" placeholder="0" step="0.01" min="0"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <!-- äº¤æ˜“æ—¥æœŸ -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">äº¤æ˜“æ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="usDate" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <!-- å‚™è¨» -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2 text-sm">å‚™è¨»</label>
                            <input type="text" id="usNote" placeholder="é¸å¡«" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <!-- é€å‡º -->
                        <button onclick="submitUsTransaction()" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                            <i class="fas fa-check mr-2"></i>ç¢ºèª
                        </button>
                    </div>
                </div>
            </div>
        `,

        // ===== æ–°å¢è¿½è¹¤æ¸…å–® Modal =====
        addWatchlistModal: `
            <div id="addWatchlistModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">æ–°å¢è¿½è¹¤</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨/åŠ å¯†è²¨å¹£ä»£è™Ÿ</label>
                            <input type="text" id="addSymbol" placeholder="å¦‚ AAPLã€BTC" 
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2 text-sm">é¡å‹</label>
                            <select id="addAssetType" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                                <option value="stock">è‚¡ç¥¨</option>
                                <option value="crypto">åŠ å¯†è²¨å¹£</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2 text-sm">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="addNote" placeholder="è‡ªè¨‚å‚™è¨»" 
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="hideAddWatchlistModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">å–æ¶ˆ</button>
                        <button onclick="addToWatchlist()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 touch-target">æ–°å¢</button>
                    </div>
                </div>
            </div>
        `,

        // ===== åŒ¯å…¥è¿½è¹¤æ¸…å–® Modal =====
        importWatchlistModal: `
            <div id="importWatchlistModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥è¿½è¹¤æ¸…å–®
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2 text-sm">é¸æ“‡æª”æ¡ˆ (JSON æˆ– CSV)</label>
                            <input type="file" id="importWatchlistFile" accept=".json,.csv" onchange="previewWatchlistFile(this)"
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                        </div>
                        <div id="importWatchlistPreview" class="min-h-[60px]"></div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                CSV æ ¼å¼éœ€åŒ…å« symbol æ¬„ä½ï¼Œå¯é¸ asset_type, note, target_price
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="hideImportWatchlistModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">å–æ¶ˆ</button>
                        <button onclick="importWatchlist()" class="flex-1 px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 touch-target">åŒ¯å…¥</button>
                    </div>
                </div>
            </div>
        `,

        // ===== åŒ¯å…¥æŒè‚¡äº¤æ˜“ Modal =====
        importPortfolioModal: `
            <div id="importPortfolioModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥äº¤æ˜“ç´€éŒ„
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2 text-sm">é¸æ“‡æª”æ¡ˆ (JSON æˆ– CSV)</label>
                            <input type="file" id="importPortfolioFile" accept=".json,.csv" onchange="previewPortfolioFile(this)"
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base">
                        </div>
                        <div id="importPortfolioPreview" class="min-h-[60px]"></div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                å¿…å¡«æ¬„ä½: symbol, quantity, price, transaction_date (YYYY-MM-DD)<br>
                                å¯é¸æ¬„ä½: name, market (tw/us), transaction_type (buy/sell), fee, tax, note
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="hideImportPortfolioModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">å–æ¶ˆ</button>
                        <button onclick="importPortfolio()" class="flex-1 px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 touch-target">åŒ¯å…¥</button>
                    </div>
                </div>
            </div>
        `,

        // ===== ç›®æ¨™åƒ¹è¨­å®š Modal =====
        targetPriceModal: `
            <div id="targetPriceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[3000] p-4">
                <div class="bg-white rounded-xl w-full max-w-sm p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-crosshairs mr-2 text-yellow-500"></i>è¨­å®šç›®æ¨™åƒ¹
                    </h3>
                    <div class="space-y-4">
                        <div class="text-center">
                            <span id="targetPriceSymbol" class="text-2xl font-bold text-gray-800"></span>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2 text-sm">ç›®æ¨™åƒ¹æ ¼</label>
                            <input type="number" id="targetPriceInput" step="0.01" placeholder="è¼¸å…¥ç›®æ¨™åƒ¹æ ¼" 
                                class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-yellow-500 text-base text-center text-lg">
                        </div>
                        <p class="text-xs text-gray-500 text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            ç•¶ç¾åƒ¹é”åˆ°æˆ–è¶…éç›®æ¨™åƒ¹æ™‚ï¼Œæœƒä»¥é»ƒè‰²é«˜äº®æé†’
                        </p>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="hideTargetPriceModal()" class="flex-1 px-4 py-3 border rounded-lg hover:bg-gray-50 touch-target">å–æ¶ˆ</button>
                        <button onclick="clearTargetPrice()" class="px-4 py-3 text-red-500 hover:bg-red-50 rounded-lg touch-target">æ¸…é™¤</button>
                        <button onclick="saveTargetPrice()" class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 touch-target">å„²å­˜</button>
                    </div>
                </div>
            </div>
        `,

        // ===== Toast é€šçŸ¥ =====
        toast: `
            <div id="toast" class="fixed bottom-20 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-auto bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity text-center">
                <span id="toastMessage"></span>
            </div>
        `,

        // ===== æ¨™ç±¤ç·¨è¼¯ Modal =====
        tagEditModal: `
            <div id="tagEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 id="tagModalTitle" class="text-lg font-bold text-gray-800">
                            <i class="fas fa-tag mr-2 text-blue-500"></i>æ–°å¢æ¨™ç±¤
                        </h3>
                        <button onclick="hideTagEditModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™ç±¤åç¨±</label>
                            <input type="text" id="tagNameInput" placeholder="ä¾‹å¦‚ï¼šé•·æœŸæŒæœ‰" maxlength="50"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é¡è‰²</label>
                            <div class="flex flex-wrap gap-2" id="tagColorOptions">
                                <button type="button" onclick="selectTagColor('#3B82F6')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-blue-500"></button>
                                <button type="button" onclick="selectTagColor('#10B981')" class="w-8 h-8 rounded-full bg-emerald-500 hover:ring-2 hover:ring-offset-2 hover:ring-emerald-500"></button>
                                <button type="button" onclick="selectTagColor('#EF4444')" class="w-8 h-8 rounded-full bg-red-500 hover:ring-2 hover:ring-offset-2 hover:ring-red-500"></button>
                                <button type="button" onclick="selectTagColor('#F59E0B')" class="w-8 h-8 rounded-full bg-amber-500 hover:ring-2 hover:ring-offset-2 hover:ring-amber-500"></button>
                                <button type="button" onclick="selectTagColor('#8B5CF6')" class="w-8 h-8 rounded-full bg-violet-500 hover:ring-2 hover:ring-offset-2 hover:ring-violet-500"></button>
                                <button type="button" onclick="selectTagColor('#EC4899')" class="w-8 h-8 rounded-full bg-pink-500 hover:ring-2 hover:ring-offset-2 hover:ring-pink-500"></button>
                                <button type="button" onclick="selectTagColor('#6366F1')" class="w-8 h-8 rounded-full bg-indigo-500 hover:ring-2 hover:ring-offset-2 hover:ring-indigo-500"></button>
                                <button type="button" onclick="selectTagColor('#06B6D4')" class="w-8 h-8 rounded-full bg-cyan-500 hover:ring-2 hover:ring-offset-2 hover:ring-cyan-500"></button>
                                <button type="button" onclick="selectTagColor('#F97316')" class="w-8 h-8 rounded-full bg-orange-500 hover:ring-2 hover:ring-offset-2 hover:ring-orange-500"></button>
                                <button type="button" onclick="selectTagColor('#6B7280')" class="w-8 h-8 rounded-full bg-gray-500 hover:ring-2 hover:ring-offset-2 hover:ring-gray-500"></button>
                            </div>
                            <input type="hidden" id="tagColorInput" value="#3B82F6">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åœ–ç¤º</label>
                            <div class="flex flex-wrap gap-2" id="tagIconOptions">
                                <button type="button" onclick="selectTagIcon('fa-tag')" class="w-10 h-10 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-tag"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-star')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-star"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-heart')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-heart"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-bookmark')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-bookmark"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-flag')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-flag"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-folder')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-folder"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-fire')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-fire"></i></button>
                                <button type="button" onclick="selectTagIcon('fa-bolt')" class="w-10 h-10 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-500 flex items-center justify-center text-gray-400"><i class="fas fa-bolt"></i></button>
                            </div>
                            <input type="hidden" id="tagIconInput" value="fa-tag">
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="hideTagEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                        <button onclick="saveTagFromModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-check mr-2"></i>å„²å­˜</button>
                    </div>
                </div>
            </div>
        `,

        // ===== æ¨™ç±¤æŒ‡æ´¾ Modal =====
        assignTagModal: `
            <div id="assignTagModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-tags mr-2 text-blue-500"></i>è¨­å®šæ¨™ç±¤ - <span id="assignTagSymbol" class="text-blue-600"></span>
                        </h3>
                        <button onclick="hideAssignTagModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div id="assignTagList" class="space-y-2 max-h-80 overflow-y-auto mb-4">
                        <p class="text-gray-400 text-center">è¼‰å…¥ä¸­...</p>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="hideAssignTagModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                        <button onclick="saveAssignedTags()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-check mr-2"></i>å„²å­˜</button>
                    </div>
                </div>
            </div>
        `
    };

    // ============================================================
    // Modal å®¹å™¨
    // ============================================================

    let modalContainer = null;

    /**
     * åˆå§‹åŒ– Modal å®¹å™¨
     */
    function initModalContainer() {
        if (modalContainer) return modalContainer;
        
        modalContainer = document.getElementById('modal-container');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modal-container';
            document.body.appendChild(modalContainer);
        }
        return modalContainer;
    }

    /**
     * åˆå§‹åŒ–æ‰€æœ‰ Modals
     */
    function initAllModals() {
        const container = initModalContainer();
        
        // æŒ‰é †åºæ’å…¥æ‰€æœ‰ Modal
        const modalOrder = [
            'chartFullscreen',
            'indexChartModal',
            'sentimentChartModal',
            'returnsModal',
            'twTransactionModal',
            'usTransactionModal',
            'addWatchlistModal',
            'importWatchlistModal',
            'importPortfolioModal',
            'targetPriceModal',
            'toast',
            'tagEditModal',
            'assignTagModal'
        ];

        let html = '';
        for (const key of modalOrder) {
            if (MODAL_TEMPLATES[key]) {
                html += MODAL_TEMPLATES[key];
            }
        }
        
        container.innerHTML = html;
        console.log('âœ… æ‰€æœ‰ Modal å·²åˆå§‹åŒ–');
    }

    /**
     * å‹•æ…‹è¼‰å…¥å–®ä¸€ Modalï¼ˆæŒ‰éœ€è¼‰å…¥ï¼‰
     */
    function loadModal(modalKey) {
        if (!MODAL_TEMPLATES[modalKey]) {
            console.error(`Modal "${modalKey}" ä¸å­˜åœ¨`);
            return null;
        }

        const existingModal = document.getElementById(modalKey);
        if (existingModal) {
            return existingModal;
        }

        const container = initModalContainer();
        const temp = document.createElement('div');
        temp.innerHTML = MODAL_TEMPLATES[modalKey];
        const modal = temp.firstElementChild;
        container.appendChild(modal);
        
        return modal;
    }

    // ============================================================
    // å°å‡ºåˆ°å…¨åŸŸ
    // ============================================================

    window.initAllModals = initAllModals;
    window.loadModal = loadModal;

    // è‡ªå‹•åˆå§‹åŒ–ï¼ˆç•¶ DOM è¼‰å…¥å®Œæˆæ™‚ï¼‰
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAllModals);
    } else {
        // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
        initAllModals();
    }

})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/portfolio-export-import.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * æŒè‚¡äº¤æ˜“åŒ¯å‡ºåŒ¯å…¥åŠŸèƒ½
 * P1 åŠŸèƒ½å¢å¼·
 * 
 * åœ¨ç¾æœ‰ portfolio.js åŸºç¤ä¸Šæ–°å¢åŒ¯å‡ºåŒ¯å…¥åŠŸèƒ½
 */

(function() {
    'use strict';
    
    // ============================================================
    // åŒ¯å‡ºåŠŸèƒ½
    // ============================================================
    
    /**
     * åŒ¯å‡ºäº¤æ˜“è¨˜éŒ„
     * @param {string} format - 'json' æˆ– 'csv'
     * @param {string} market - 'tw', 'us', æˆ– null (å…¨éƒ¨)
     */
    async function exportTransactions(format = 'json', market = null) {
        try {
            let url = `/api/portfolio/export?format=${format}`;
            if (market) {
                url += `&market=${market}`;
            }
            
            const res = await apiRequest(url);
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'åŒ¯å‡ºå¤±æ•—');
            }
            
            const blob = await res.blob();
            const filename = res.headers.get('Content-Disposition')?.split('filename=')[1] || `portfolio.${format}`;
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(downloadUrl);
            
            showToast('åŒ¯å‡ºæˆåŠŸï¼');
        } catch (e) {
            console.error('åŒ¯å‡ºäº¤æ˜“è¨˜éŒ„å¤±æ•—:', e);
            showToast(e.message || 'åŒ¯å‡ºå¤±æ•—');
        }
    }
    
    // ============================================================
    // åŒ¯å…¥åŠŸèƒ½
    // ============================================================
    
    /**
     * é¡¯ç¤ºåŒ¯å…¥ Modal
     */
    function showImportTransactionsModal() {
        const modal = document.getElementById('importTransactionsModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        // æ¸…ç©ºé è¦½
        const preview = document.getElementById('importTransactionsPreview');
        if (preview) preview.innerHTML = '';
        
        const fileInput = document.getElementById('importTransactionsFile');
        if (fileInput) fileInput.value = '';
    }
    
    /**
     * éš±è—åŒ¯å…¥ Modal
     */
    function hideImportTransactionsModal() {
        const modal = document.getElementById('importTransactionsModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }
    
    /**
     * é è¦½åŒ¯å…¥æª”æ¡ˆ
     */
    function previewTransactionsFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        const preview = document.getElementById('importTransactionsPreview');
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                let items = [];
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    const data = JSON.parse(content);
                    items = data.items || data;
                } else if (file.name.endsWith('.csv')) {
                    const lines = content.split('\n').filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        const obj = {};
                        headers.forEach((h, idx) => obj[h] = values[idx]?.trim());
                        if (obj.symbol) items.push(obj);
                    }
                }
                
                // é©—è­‰å¿…è¦æ¬„ä½
                const requiredFields = ['symbol', 'market', 'transaction_type', 'quantity', 'price', 'transaction_date'];
                const validItems = items.filter(item => {
                    return requiredFields.every(field => item[field] !== undefined && item[field] !== '');
                });
                
                const invalidCount = items.length - validItems.length;
                
                preview.innerHTML = `
                    <div class="p-3 ${validItems.length > 0 ? 'bg-green-50' : 'bg-red-50'} rounded-lg">
                        <p class="${validItems.length > 0 ? 'text-green-700' : 'text-red-700'} font-medium">
                            <i class="fas fa-${validItems.length > 0 ? 'check' : 'times'}-circle mr-2"></i>
                            æ‰¾åˆ° ${validItems.length} ç­†æœ‰æ•ˆè¨˜éŒ„
                            ${invalidCount > 0 ? `<span class="text-orange-600">(${invalidCount} ç­†ç„¡æ•ˆ)</span>` : ''}
                        </p>
                        ${validItems.length > 0 ? `
                            <div class="mt-2 max-h-40 overflow-y-auto">
                                <table class="text-sm w-full">
                                    <thead>
                                        <tr class="text-gray-500">
                                            <th class="text-left">ä»£è™Ÿ</th>
                                            <th class="text-left">é¡å‹</th>
                                            <th class="text-right">æ•¸é‡</th>
                                            <th class="text-right">åƒ¹æ ¼</th>
                                            <th class="text-left">æ—¥æœŸ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${validItems.slice(0, 10).map(item => `
                                            <tr class="border-t border-gray-200">
                                                <td>${item.symbol}</td>
                                                <td><span class="px-1.5 py-0.5 rounded text-xs ${item.transaction_type === 'buy' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${item.transaction_type === 'buy' ? 'è²·' : 'è³£'}</span></td>
                                                <td class="text-right">${item.quantity}</td>
                                                <td class="text-right">${item.price}</td>
                                                <td>${item.transaction_date}</td>
                                            </tr>
                                        `).join('')}
                                        ${validItems.length > 10 ? `
                                            <tr class="border-t border-gray-200">
                                                <td colspan="5" class="text-center text-gray-500">... é‚„æœ‰ ${validItems.length - 10} ç­†</td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;
                preview.dataset.items = JSON.stringify(validItems);
            } catch (err) {
                preview.innerHTML = `<p class="text-red-500 p-3"><i class="fas fa-times-circle mr-2"></i>æª”æ¡ˆè§£æå¤±æ•—: ${err.message}</p>`;
            }
        };
        
        reader.readAsText(file);
    }
    
    /**
     * è§£æ CSV è¡Œï¼ˆè™•ç†å¼•è™Ÿå…§çš„é€—è™Ÿï¼‰
     */
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        
        return result;
    }
    
    /**
     * åŸ·è¡ŒåŒ¯å…¥
     */
    async function importTransactions() {
        const preview = document.getElementById('importTransactionsPreview');
        const itemsStr = preview?.dataset?.items;
        
        if (!itemsStr) {
            showToast('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
            return;
        }
        
        try {
            const items = JSON.parse(itemsStr);
            
            if (items.length === 0) {
                showToast('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„');
                return;
            }
            
            const res = await apiRequest('/api/portfolio/import', {
                method: 'POST',
                body: { items }
            });
            
            const data = await res.json();
            
            if (data.success) {
                showToast(data.message);
                hideImportTransactionsModal();
                
                // é‡æ–°è¼‰å…¥æŒè‚¡è³‡æ–™
                if (typeof loadPortfolioData === 'function') {
                    loadPortfolioData();
                }
            } else {
                showToast(data.detail || 'åŒ¯å…¥å¤±æ•—');
            }
        } catch (e) {
            console.error('åŒ¯å…¥äº¤æ˜“è¨˜éŒ„å¤±æ•—:', e);
            showToast('åŒ¯å…¥å¤±æ•—');
        }
    }
    
    // ============================================================
    // åˆ‡æ›åŒ¯å‡ºåŒ¯å…¥é¸å–®
    // ============================================================
    
    function togglePortfolioMenu() {
        const menu = document.getElementById('portfolioMenu');
        if (menu) menu.classList.toggle('hidden');
    }
    
    // ============================================================
    // æ¸²æŸ“åŒ¯å‡ºåŒ¯å…¥æŒ‰éˆ•
    // ============================================================
    
    /**
     * å–å¾—åŒ¯å‡ºåŒ¯å…¥æŒ‰éˆ• HTML
     */
    function getPortfolioExportImportButtons() {
        return `
            <div class="relative">
                <button onclick="togglePortfolioMenu()" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-lg border hover:bg-gray-50" title="åŒ¯å‡ºåŒ¯å…¥">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <div id="portfolioMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50">
                    <button onclick="exportTransactions('json')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                        <i class="fas fa-download mr-2 text-blue-500"></i>åŒ¯å‡º JSON
                    </button>
                    <button onclick="exportTransactions('csv')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                        <i class="fas fa-file-csv mr-2 text-green-500"></i>åŒ¯å‡º CSV
                    </button>
                    <hr class="my-1">
                    <button onclick="exportTransactions('json', 'tw')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                        <i class="fas fa-download mr-2 text-red-500"></i>åƒ…å°è‚¡ JSON
                    </button>
                    <button onclick="exportTransactions('json', 'us')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                        <i class="fas fa-download mr-2 text-blue-500"></i>åƒ…ç¾è‚¡ JSON
                    </button>
                    <hr class="my-1">
                    <button onclick="togglePortfolioMenu(); showImportTransactionsModal();" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center">
                        <i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥è¨˜éŒ„
                    </button>
                </div>
            </div>
        `;
    }
    
    // ============================================================
    // åŒ¯å…¥ Modal HTML
    // ============================================================
    
    /**
     * å–å¾—åŒ¯å…¥ Modal HTML
     */
    function getImportTransactionsModalHTML() {
        return `
            <div id="importTransactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥äº¤æ˜“è¨˜éŒ„
                        </h3>
                        <button onclick="hideImportTransactionsModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">æ”¯æ´ JSON æˆ– CSV æ ¼å¼</p>
                        <p class="text-xs text-gray-500 mb-3">
                            å¿…è¦æ¬„ä½ï¼šsymbol, market (tw/us), transaction_type (buy/sell), quantity, price, transaction_date
                        </p>
                        <input type="file" id="importTransactionsFile" accept=".json,.csv" 
                               onchange="previewTransactionsFile(this)"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    
                    <div id="importTransactionsPreview" class="mb-4"></div>
                    
                    <div class="flex justify-end gap-2">
                        <button onclick="hideImportTransactionsModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            å–æ¶ˆ
                        </button>
                        <button onclick="importTransactions()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                            <i class="fas fa-upload mr-2"></i>åŒ¯å…¥
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ============================================================
    // ç¯„ä¾‹ JSON æ ¼å¼
    // ============================================================
    
    const EXAMPLE_IMPORT_FORMAT = {
        "items": [
            {
                "symbol": "AAPL",
                "name": "Apple Inc.",
                "market": "us",
                "transaction_type": "buy",
                "quantity": 10,
                "price": 185.50,
                "fee": 1.99,
                "tax": 0,
                "transaction_date": "2024-01-15",
                "note": "é•·æœŸæŠ•è³‡"
            },
            {
                "symbol": "2330",
                "name": "å°ç©é›»",
                "market": "tw",
                "transaction_type": "buy",
                "quantity": 1000,
                "price": 580,
                "fee": 20,
                "tax": 0,
                "transaction_date": "2024-01-20",
                "note": ""
            }
        ]
    };
    
    // ============================================================
    // å°å‡ºåˆ°å…¨åŸŸ
    // ============================================================
    
    window.exportTransactions = exportTransactions;
    window.showImportTransactionsModal = showImportTransactionsModal;
    window.hideImportTransactionsModal = hideImportTransactionsModal;
    window.previewTransactionsFile = previewTransactionsFile;
    window.importTransactions = importTransactions;
    window.togglePortfolioMenu = togglePortfolioMenu;
    window.getPortfolioExportImportButtons = getPortfolioExportImportButtons;
    window.getImportTransactionsModalHTML = getImportTransactionsModalHTML;
    
    console.log('ğŸ“¦ portfolio-export-import.js æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/portfolio.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * å€‹äººæŠ•è³‡è¨˜éŒ„æ¨¡çµ„ (P3 å„ªåŒ–ç‰ˆ)
 * 
 * å„ªåŒ–å…§å®¹ï¼š
 * 1. äº‹ä»¶å§”è¨— - æ¸›å°‘ç›£è½å™¨æ•¸é‡
 * 2. AppState æ•´åˆ - çµ±ä¸€ç‹€æ…‹ç®¡ç†
 * 3. DOM å¿«å– - ä½¿ç”¨ $() å‡½æ•¸
 * 
 * åŒ…å«ï¼šæŒè‚¡ç¸½è¦½ã€äº¤æ˜“ç´€éŒ„ã€åŒ¯å‡ºåŒ¯å…¥
 */

(function() {
    'use strict';

    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================

    let currentPortfolioTab = 'holdings';

    // ============================================================
    // Tab åˆ‡æ›
    // ============================================================

    function switchPortfolioTab(tab) {
        currentPortfolioTab = tab;

        const activeClass = 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap';
        const inactiveClass = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap';

        // âœ… P3: ä½¿ç”¨ $() å¿«å–
        const tabHoldings = $('tabHoldings');
        const tabTw = $('tabTwTransactions');
        const tabUs = $('tabUsTransactions');

        if (tabHoldings) tabHoldings.className = tab === 'holdings' ? activeClass : inactiveClass;
        if (tabTw) tabTw.className = tab === 'tw-transactions' ? activeClass : inactiveClass;
        if (tabUs) tabUs.className = tab === 'us-transactions' ? activeClass : inactiveClass;

        // é¡¯ç¤ºå°æ‡‰å…§å®¹
        const holdingsEl = $('portfolioHoldings');
        const twEl = $('portfolioTwTransactions');
        const usEl = $('portfolioUsTransactions');

        if (holdingsEl) holdingsEl.classList.toggle('hidden', tab !== 'holdings');
        if (twEl) twEl.classList.toggle('hidden', tab !== 'tw-transactions');
        if (usEl) usEl.classList.toggle('hidden', tab !== 'us-transactions');

        // è¼‰å…¥è³‡æ–™
        if (tab === 'holdings') loadHoldings();
        else if (tab === 'tw-transactions') loadTransactions('tw');
        else if (tab === 'us-transactions') loadTransactions('us');
    }

    // ============================================================
    // è¼‰å…¥åŠŸèƒ½
    // ============================================================

    async function loadPortfolio() {
        await loadPortfolioSummary();
        await loadHoldings();

        // âœ… P3: åˆå§‹åŒ–äº‹ä»¶å§”è¨—
        initPortfolioEventDelegation();
    }

    async function loadPortfolioSummary() {
        try {
            const res = await apiRequest('/api/portfolio/summary');
            const data = await res.json();

            if (data.success) {
                const s = data.data;

                // âœ… P3: åŒæ­¥åˆ° AppState
                if (window.AppState) {
                    AppState.setPortfolio({ summary: s });
                }

                // åŒ¯ç‡
                const rateEl = $('exchangeRateValue');
                const rateTimeEl = $('exchangeRateTime');
                if (rateEl) rateEl.textContent = s.exchange_rate?.toFixed(2) || '--';
                if (rateTimeEl && s.exchange_rate_updated_at) {
                    const time = new Date(s.exchange_rate_updated_at).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
                    rateTimeEl.textContent = `(${time})`;
                }

                // å°è‚¡
                updateSummarySection('tw', s.tw, 'NT$');

                // ç¾è‚¡
                updateSummarySection('us', s.us, '$');

                // åˆè¨ˆ
                if (s.total) {
                    const totalValueEl = $('totalValueTwd');
                    if (totalValueEl) {
                        totalValueEl.textContent = s.total.current_value_twd
                            ? `NT$${Math.round(s.total.current_value_twd).toLocaleString()}` : '--';
                    }

                    const totalProfit = s.total.total_profit_twd || 0;
                    const totalProfitEl = $('totalProfitTwd');
                    if (totalProfitEl) {
                        totalProfitEl.textContent = `${totalProfit >= 0 ? '+' : ''}NT$${Math.round(Math.abs(totalProfit)).toLocaleString()}`;
                        totalProfitEl.className = totalProfit >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    }

                    const totalReturn = s.total.return_rate;
                    const totalReturnEl = $('totalReturnRate');
                    if (totalReturnEl && totalReturn !== null && totalReturn !== undefined) {
                        totalReturnEl.textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%`;
                        totalReturnEl.className = totalReturn >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
                    }

                    const totalPosEl = $('totalPositions');
                    if (totalPosEl) totalPosEl.textContent = s.total.positions || 0;
                }
            }
        } catch (e) {
            console.error('è¼‰å…¥æŠ•è³‡æ‘˜è¦å¤±æ•—:', e);
        }
    }

    function updateSummarySection(market, data, currency) {
        if (!data) return;

        const value = data.current_value || 0;
        const valueEl = $(`${market}CurrentValue`);
        if (valueEl) {
            valueEl.textContent = value > 0 ? `${currency}${Math.round(value).toLocaleString()}` : '--';
        }

        const profit = (data.realized_profit || 0) + (data.unrealized_profit || 0);
        const profitEl = $(`${market}Profit`);
        if (profitEl) {
            profitEl.textContent = value > 0
                ? `${profit >= 0 ? '+' : ''}${currency}${Math.round(Math.abs(profit)).toLocaleString()}` : '--';
            profitEl.className = profit >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
        }

        const returnRate = data.return_rate;
        const returnEl = $(`${market}ReturnRate`);
        if (returnEl && returnRate !== null && returnRate !== undefined) {
            returnEl.textContent = `${returnRate >= 0 ? '+' : ''}${returnRate.toFixed(2)}%`;
            returnEl.className = returnRate >= 0 ? 'font-bold text-green-200' : 'font-bold text-red-200';
        }

        const posEl = $(`${market}Positions`);
        if (posEl) posEl.textContent = data.positions || 0;

        // æ‘˜è¦è¡Œ
        const summaryEl = $(`${market}SummaryLine`);
        if (summaryEl) {
            summaryEl.innerHTML = data.positions > 0
                ? `${data.positions} æª” Â· æç›Š <span class="${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profit >= 0 ? '+' : ''}${currency}${Math.round(Math.abs(profit)).toLocaleString()}</span>`
                : 'å°šç„¡æŒè‚¡';
        }
    }

    async function loadHoldings() {
        const twContainer = $('holdingsTW');
        const usContainer = $('holdingsUS');

        try {
            const res = await apiRequest('/api/portfolio/holdings');
            const data = await res.json();

            if (data.success) {
                // âœ… P3: åŒæ­¥åˆ° AppState
                if (window.AppState) {
                    AppState.setPortfolio({
                        tw: data.data.tw || [],
                        us: data.data.us || []
                    });
                }

                if (twContainer) {
                    twContainer.innerHTML = data.data.tw && data.data.tw.length > 0
                        ? data.data.tw.map(h => renderHoldingCard(h, 'tw')).join('')
                        : '<p class="text-gray-400 text-center py-4">å°šç„¡å°è‚¡æŒè‚¡</p>';
                }

                if (usContainer) {
                    usContainer.innerHTML = data.data.us && data.data.us.length > 0
                        ? data.data.us.map(h => renderHoldingCard(h, 'us')).join('')
                        : '<p class="text-gray-400 text-center py-4">å°šç„¡ç¾è‚¡æŒè‚¡</p>';
                }
            }
        } catch (e) {
            console.error('è¼‰å…¥æŒè‚¡å¤±æ•—:', e);
            if (twContainer) twContainer.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
            if (usContainer) usContainer.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
        }
    }

    function renderHoldingCard(h, market) {
        const profitClass = (h.unrealized_profit || 0) >= 0 ? 'text-green-600' : 'text-red-600';
        const profitPrefix = (h.unrealized_profit || 0) >= 0 ? '+' : '';
        const currency = market === 'tw' ? 'NT$' : '$';

        // âœ… P3: ä½¿ç”¨ data-action æ›¿ä»£ onclick
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer"
                 data-action="analyze" data-symbol="${h.symbol}">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center">
                        <span class="font-semibold text-gray-800">${h.symbol}</span>
                        <span class="text-gray-500 text-sm ml-2 truncate">${h.name || ''}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${h.quantity_display} @ ${currency}${h.avg_cost?.toFixed(2) || '--'}
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-semibold ${profitClass}">
                        ${profitPrefix}${currency}${Math.round(Math.abs(h.unrealized_profit || 0)).toLocaleString()}
                    </div>
                    <div class="text-xs ${profitClass}">
                        ${h.return_rate !== null ? `${h.return_rate >= 0 ? '+' : ''}${h.return_rate.toFixed(2)}%` : '--'}
                    </div>
                </div>
            </div>
        `;
    }

    async function loadTransactions(market) {
        const container = $(market === 'tw' ? 'twTransactionList' : 'usTransactionList');
        if (!container) return;

        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin text-blue-600"></i>
            </div>
        `;

        try {
            const res = await apiRequest(`/api/portfolio/transactions/${market}`);
            const data = await res.json();

            if (data.success && data.data && data.data.length > 0) {
                container.innerHTML = data.data.map(t => renderTransactionCard(t, market)).join('');
            } else {
                container.innerHTML = `<p class="text-gray-400 text-center py-4">å°šç„¡äº¤æ˜“ç´€éŒ„</p>`;
            }
        } catch (e) {
            console.error('è¼‰å…¥äº¤æ˜“ç´€éŒ„å¤±æ•—:', e);
            container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
        }
    }

    function renderTransactionCard(t, market) {
        const typeClass = t.transaction_type === 'buy' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const typeText = t.transaction_type === 'buy' ? 'è²·å…¥' : 'è³£å‡º';
        const currency = market === 'tw' ? 'NT$' : '$';

        // âœ… P3: ä½¿ç”¨ data-action æ›¿ä»£ onclick
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg" data-id="${t.id}">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">${t.symbol}</span>
                        <span class="px-2 py-0.5 text-xs rounded ${typeClass}">${typeText}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${t.quantity_display} @ ${currency}${t.price?.toFixed(2)} Â· ${new Date(t.transaction_date).toLocaleDateString()}
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-medium">${currency}${Math.round(t.total_amount).toLocaleString()}</span>
                    <button data-action="delete-transaction" data-id="${t.id}" data-market="${market}"
                            class="p-1.5 text-gray-400 hover:text-red-500">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            </div>
        `;
    }

    async function deleteTransaction(id, market) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“ç´€éŒ„å—ï¼Ÿ')) return;

        try {
            const res = await apiRequest(`/api/portfolio/transactions/${market}/${id}`, {
                method: 'DELETE'
            });

            const data = await res.json();

            if (data.success) {
                showToast('å·²åˆªé™¤');
                loadTransactions(market);
                loadPortfolioSummary();
                loadHoldings();
            } else {
                showToast(data.detail || 'åˆªé™¤å¤±æ•—');
            }
        } catch (e) {
            console.error('åˆªé™¤å¤±æ•—:', e);
            showToast('åˆªé™¤å¤±æ•—');
        }
    }

    // ============================================================
    // äº‹ä»¶å§”è¨— (P3 æ ¸å¿ƒå„ªåŒ–)
    // ============================================================

    let delegationInitialized = false;

    function initPortfolioEventDelegation() {
        const section = $('section-portfolio');
        if (!section || delegationInitialized) return;

        section.addEventListener('click', handlePortfolioClick);
        delegationInitialized = true;
        console.log('ğŸ“Œ æŠ•è³‡è¨˜éŒ„äº‹ä»¶å§”è¨—å·²åˆå§‹åŒ–');
    }

    function handlePortfolioClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        e.preventDefault();
        const action = target.dataset.action;

        switch (action) {
            case 'analyze':
                if (typeof searchSymbol === 'function') {
                    searchSymbol(target.dataset.symbol);
                }
                break;

            case 'delete-transaction':
                deleteTransaction(
                    parseInt(target.dataset.id),
                    target.dataset.market
                );
                break;

            case 'switch-tab':
                switchPortfolioTab(target.dataset.tab);
                break;

            case 'export':
                exportPortfolio();
                break;

            case 'show-import':
                showImportPortfolioModal();
                break;
        }
    }

    // ============================================================
    // åŒ¯å‡ºåŒ¯å…¥
    // ============================================================

    function togglePortfolioMenu() {
        const menu = $('portfolioMenu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    }

    async function exportPortfolio() {
        try {
            const res = await apiRequest('/api/portfolio/export');
            const data = await res.json();

            if (!data.success) {
                showToast('åŒ¯å‡ºå¤±æ•—');
                return;
            }

            const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('åŒ¯å‡ºæˆåŠŸ');
            const menu = $('portfolioMenu');
            if (menu) menu.classList.add('hidden');
        } catch (e) {
            console.error('åŒ¯å‡ºå¤±æ•—:', e);
            showToast('åŒ¯å‡ºå¤±æ•—');
        }
    }

    function showImportPortfolioModal() {
        const modal = $('importPortfolioModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        const menu = $('portfolioMenu');
        if (menu) menu.classList.add('hidden');
    }

    function hideImportPortfolioModal() {
        const modal = $('importPortfolioModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        const preview = $('importPortfolioPreview');
        if (preview) preview.innerHTML = '';
    }

    function previewPortfolioFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const preview = $('importPortfolioPreview');
        if (!preview) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const items = JSON.parse(e.target.result);
                preview.innerHTML = `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2">é è¦½ (${items.length} ç­†):</p>
                        <ul class="text-sm space-y-1 max-h-40 overflow-y-auto">
                            ${items.slice(0, 10).map(item => `
                                <li class="flex justify-between">
                                    <span class="font-medium">${item.symbol}</span>
                                    <span class="text-gray-500">${item.transaction_type} ${item.quantity}</span>
                                </li>
                            `).join('')}
                            ${items.length > 10 ? `<li class="text-gray-400">...é‚„æœ‰ ${items.length - 10} ç­†</li>` : ''}
                        </ul>
                    </div>
                `;
            } catch (err) {
                preview.innerHTML = '<p class="text-red-500 text-sm mt-2">æª”æ¡ˆæ ¼å¼éŒ¯èª¤</p>';
            }
        };
        reader.readAsText(file);
    }

    async function importPortfolio() {
        const textarea = $('importPortfolioData');
        const itemsStr = textarea?.value?.trim();

        if (!itemsStr) {
            showToast('è«‹è¼¸å…¥è³‡æ–™');
            return;
        }

        try {
            const items = JSON.parse(itemsStr);

            const res = await apiRequest('/api/portfolio/import', {
                method: 'POST',
                body: { items }
            });

            const data = await res.json();

            if (data.success) {
                showToast(data.message);
                hideImportPortfolioModal();

                // âœ… P3: æ¸…é™¤ AppState å¿«å–
                if (window.AppState) {
                    AppState.set('portfolioLoaded', false);
                }

                loadPortfolio();
            } else {
                showToast(data.detail || 'åŒ¯å…¥å¤±æ•—');
            }
        } catch (e) {
            console.error('åŒ¯å…¥å¤±æ•—:', e);
            showToast('åŒ¯å…¥å¤±æ•—');
        }
    }

    // ============================================================
    // å¿«é€Ÿäº¤æ˜“ï¼ˆå¾è¿½è¹¤æ¸…å–®ï¼‰
    // ============================================================

    function quickTrade(symbol, name, market, type) {
        if (market === 'tw') {
            if (typeof showAddTwModal === 'function') showAddTwModal();
            const symEl = $('twSymbol');
            const nameEl = $('twName');
            const nameDisplay = $('twNameDisplay');
            if (symEl) symEl.value = symbol;
            if (nameEl) nameEl.value = name;
            if (nameDisplay) nameDisplay.innerHTML = `<span class="text-gray-800">${name}</span>`;
            if (typeof setTwType === 'function') setTwType(type);
        } else {
            if (typeof showAddUsModal === 'function') showAddUsModal();
            const symEl = $('usSymbol');
            const nameEl = $('usName');
            const nameDisplay = $('usNameDisplay');
            if (symEl) symEl.value = symbol;
            if (nameEl) nameEl.value = name;
            if (nameDisplay) nameDisplay.innerHTML = `<span class="text-gray-800">${name}</span>`;
            if (typeof setUsType === 'function') setUsType(type);
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.portfolio = {
            load: loadPortfolio,
            loadSummary: loadPortfolioSummary,
            loadHoldings,
            loadTransactions,
            switchTab: switchPortfolioTab,
            exportData: exportPortfolio,
            importData: importPortfolio,
            quickTrade
        };
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.loadPortfolio = loadPortfolio;
    window.loadPortfolioSummary = loadPortfolioSummary;
    window.loadHoldings = loadHoldings;
    window.loadTransactions = loadTransactions;
    window.switchPortfolioTab = switchPortfolioTab;
    window.deleteTransaction = deleteTransaction;
    window.togglePortfolioMenu = togglePortfolioMenu;
    window.exportPortfolio = exportPortfolio;
    window.showImportPortfolioModal = showImportPortfolioModal;
    window.hideImportPortfolioModal = hideImportPortfolioModal;
    window.previewPortfolioFile = previewPortfolioFile;
    window.importPortfolio = importPortfolio;
    window.quickTrade = quickTrade;

    console.log('ğŸ’¼ portfolio.js æ¨¡çµ„å·²è¼‰å…¥ (P3 å„ªåŒ–ç‰ˆ)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/returns.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * å¹´åŒ–å ±é…¬ç‡æ¨¡çµ„
 */

(function() {
    'use strict';
    
    /**
     * è¼‰å…¥å¹´åŒ–å ±é…¬ç‡ Modal
     */
    async function loadReturnsModal(symbol) {
        const modal = document.getElementById('returnsModal');
        const content = document.getElementById('returnsModalContent');
        const title = document.getElementById('returnsModalTitle');
        
        if (!modal || !content) return;
        
        if (title) title.textContent = `${symbol} å¹´åŒ–å ±é…¬ç‡`;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
                <p class="mt-2 text-gray-500">è¨ˆç®—ä¸­...ï¼ˆå«é…æ¯å†æŠ•å…¥ï¼‰</p>
            </div>
        `;
        
        try {
            const res = await apiRequest(`/api/stock/${symbol}/returns`);
            const data = await res.json();
            
            if (!data.success) {
                throw new Error(data.detail || 'è¨ˆç®—å¤±æ•—');
            }
            
            renderReturnsModal(data.data);
            
        } catch (e) {
            console.error('è¼‰å…¥å¹´åŒ–å ±é…¬ç‡å¤±æ•—:', e);
            content.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                    <p>${e.message || 'è¼‰å…¥å¤±æ•—'}</p>
                </div>
            `;
        }
    }
    
    /**
     * æ¸²æŸ“å ±é…¬ç‡å…§å®¹
     */
    function renderReturnsModal(data) {
        const content = document.getElementById('returnsModalContent');
        if (!content) return;
        
        const periods = ['1Y', '3Y', '5Y', '10Y'];
        
        let html = `
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-gray-600 text-sm">${data.name}</p>
                <p class="text-2xl font-bold text-gray-800">$${data.current_price.toLocaleString()}</p>
                <p class="text-xs text-gray-400">${data.current_date}</p>
            </div>
            <div class="space-y-3">
        `;
        
        for (const period of periods) {
            const ret = data.returns[period];
            
            if (!ret) {
                html += `
                    <div class="p-3 bg-gray-100 rounded-lg opacity-50">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-600">${period}</span>
                            <span class="text-gray-400 text-sm">è³‡æ–™ä¸è¶³</span>
                        </div>
                    </div>
                `;
                continue;
            }
            
            const cagr = ret.cagr;
            const cagrClass = cagr >= 0 ? 'text-green-600' : 'text-red-600';
            const cagrIcon = cagr >= 0 ? 'â–²' : 'â–¼';
            const cagrBg = cagr >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
            
            html += `
                <div class="p-4 bg-white border rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-lg text-gray-800">${period}</span>
                        <span class="text-xs text-gray-400">${ret.start_date} ~ ä»Š</span>
                    </div>
                    <div class="p-4 ${cagrBg} rounded-lg border text-center mb-3">
                        <p class="text-xs text-gray-500 mb-1">å¹´åŒ–å ±é…¬ç‡ (CAGR)</p>
                        <p class="text-3xl font-bold ${cagrClass}">${cagrIcon} ${cagr !== null ? Math.abs(cagr).toFixed(2) + '%' : '--'}</p>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 border-t pt-2">
                        <span>èµ·å§‹åƒ¹: $${ret.start_price.toLocaleString()}</span>
                        <span>é…æ¯ ${ret.dividend_count} æ¬¡</span>
                        <span>ç¸½é…æ¯: $${ret.total_dividends.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }
        
        html += `
            </div>
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <p class="text-xs text-blue-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    CAGR åŸºæ–¼ Yahoo Finance é™¤æ¬Šæ¯èª¿æ•´å¾Œåƒ¹æ ¼è¨ˆç®—ï¼Œ<br>
                    å·²åŒ…å«é…æ¯å†æŠ•å…¥çš„è¤‡åˆ©æ•ˆæœ
                </p>
            </div>
        `;
        
        content.innerHTML = html;
    }
    
    /**
     * é—œé–‰ Modal
     */
    function closeReturnsModal() {
        const modal = document.getElementById('returnsModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }
    
    // å°å‡ºåˆ°å…¨åŸŸ
    window.loadReturnsModal = loadReturnsModal;
    window.renderReturnsModal = renderReturnsModal;
    window.closeReturnsModal = closeReturnsModal;
    
    console.log('ğŸ“Š returns.js æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/search.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * æœå°‹æ ¸å¿ƒæ¨¡çµ„ (P2 æ‹†åˆ†)
 * 
 * è·è²¬ï¼š
 * - æœå°‹é‚è¼¯
 * - API è«‹æ±‚
 * - å¿«å–ç®¡ç†
 * 
 * ä¾è³´ï¼šcore.js, state.js
 * è¢«ä¾è³´ï¼šsearch-render.js
 */

(function() {
    'use strict';

    // ============================================================
    // å¿«å–ç³»çµ±
    // ============================================================
    
    const stockCache = new Map();
    const CACHE_TTL = 5 * 60 * 1000; // 5 åˆ†é˜

    function getFromCache(symbol) {
        const cached = stockCache.get(symbol.toUpperCase());
        if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
            console.log(`ğŸ“¦ å¿«å–å‘½ä¸­: ${symbol}`);
            return cached.data;
        }
        return null;
    }

    function saveToCache(symbol, data) {
        stockCache.set(symbol.toUpperCase(), {
            data: data,
            timestamp: Date.now()
        });
        console.log(`ğŸ’¾ å·²å¿«å–: ${symbol}`);
    }

    function clearStockCache() {
        stockCache.clear();
        console.log('ğŸ—‘ï¸ è‚¡ç¥¨å¿«å–å·²æ¸…é™¤');
        showToast('å¿«å–å·²æ¸…é™¤');
    }

    function getStockCacheStats() {
        return {
            count: stockCache.size,
            symbols: Array.from(stockCache.keys())
        };
    }

    // ============================================================
    // æœå°‹åŠŸèƒ½
    // ============================================================

    function searchStock() {
        const input = $('searchSymbol');
        let symbol = input?.value?.trim().toUpperCase();
        if (!symbol) {
            showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
            return;
        }
        searchSymbol(symbol);
    }

    async function searchSymbol(symbol, forceRefresh = false) {
        const container = $('searchResult');
        
        if (typeof showSection === 'function') {
            showSection('search');
        }
        
        const input = $('searchSymbol');
        if (input) input.value = symbol;

        // æª¢æŸ¥å‰ç«¯å¿«å–
        if (!forceRefresh) {
            const cached = getFromCache(symbol);
            if (cached) {
                container.classList.remove('hidden');
                // è§¸ç™¼æ¸²æŸ“ï¼ˆç”± search-render.js è™•ç†ï¼‰
                renderSearchResult(cached, symbol);
                return;
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        container.classList.remove('hidden');
        setHtml('searchResult', `
            <div class="bg-white rounded-xl shadow p-6 text-center">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                <p class="mt-2 text-gray-500 text-sm">æŸ¥è©¢ä¸­...ï¼ˆé¦–æ¬¡æŸ¥è©¢å¯èƒ½éœ€è¦ 10-30 ç§’ï¼‰</p>
            </div>
        `);

        try {
            const upperSymbol = symbol.toUpperCase();
            const isCrypto = ['BTC', 'ETH', 'BITCOIN', 'ETHEREUM'].includes(upperSymbol);
            const isTaiwan = /^\d{4,6}$/.test(symbol) || upperSymbol.endsWith('.TW');

            let endpoint;
            let querySymbol = upperSymbol;

            if (isCrypto) {
                endpoint = `/api/crypto/${upperSymbol}`;
            } else if (isTaiwan) {
                querySymbol = upperSymbol.endsWith('.TW') ? upperSymbol : `${symbol}.TW`;
                endpoint = `/api/stock/${querySymbol}`;
            } else {
                endpoint = `/api/stock/${upperSymbol}`;
            }

            if (forceRefresh) {
                endpoint += '?refresh=true';
            }

            console.log(`æŸ¥è©¢: ${endpoint}, é¡å‹: ${isCrypto ? 'åŠ å¯†è²¨å¹£' : isTaiwan ? 'å°è‚¡' : 'ç¾è‚¡'}`);

            // è¨­ç½®è¼‰å…¥ç‹€æ…‹
            if (window.AppState) {
                AppState.setLoading(true);
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            const res = await fetch(endpoint, { signal: controller.signal });
            clearTimeout(timeoutId);

            const data = await res.json();
            console.log('API å›æ‡‰:', data);

            if (window.AppState) {
                AppState.setLoading(false);
            }

            if (!res.ok) {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        <p class="font-medium">æŸ¥è©¢å¤±æ•—</p>
                        <p class="text-sm mt-2">${data.detail || 'HTTP ' + res.status}</p>
                        ${isCrypto ? '<p class="text-xs mt-2 text-gray-500">æ³¨æ„ï¼šåŠ å¯†è²¨å¹£æŸ¥è©¢å¯èƒ½å›  API é™åˆ¶æš«æ™‚ç„¡æ³•ä½¿ç”¨</p>' : ''}
                    </div>
                `);
                return;
            }

            if (!data.success) {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        ${data.detail || 'æŸ¥è©¢å¤±æ•—'}
                    </div>
                `);
                return;
            }

            // å­˜å…¥å¿«å–
            saveToCache(symbol, data);
            
            // åŒæ­¥åˆ° AppState
            if (window.AppState) {
                AppState.setCurrentStock({
                    symbol: data.symbol,
                    name: data.name,
                    price: data.price,
                    isCrypto,
                    isTaiwan
                });
            }

            // æ¸²æŸ“çµæœï¼ˆç”± search-render.js è™•ç†ï¼‰
            renderSearchResult(data, symbol);

        } catch (e) {
            console.error('Search error:', e);
            
            if (window.AppState) {
                AppState.setLoading(false);
            }

            if (e.name === 'AbortError') {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        æŸ¥è©¢è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦
                    </div>
                `);
            } else {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        æŸ¥è©¢å¤±æ•—: ${e.message}
                    </div>
                `);
            }
        }
    }

    // ============================================================
    // å¿«é€ŸåŠ å…¥è¿½è¹¤æ¸…å–®
    // ============================================================

    async function quickAddToWatchlist(symbol, type = 'stock') {
        try {
            const res = await apiRequest('/api/watchlist', {
                method: 'POST',
                body: { symbol: symbol.toUpperCase(), type }
            });

            const data = await res.json();

            if (res.ok && data.success) {
                showToast(`å·²åŠ å…¥è¿½è¹¤: ${symbol}`);
                
                // æ¨‚è§€æ›´æ–° AppState
                if (window.AppState) {
                    AppState.addToWatchlist({
                        symbol: symbol.toUpperCase(),
                        type,
                        added_at: new Date().toISOString()
                    });
                }
            } else {
                showToast(data.detail || 'åŠ å…¥å¤±æ•—', 'error');
            }
        } catch (e) {
            console.error('Add to watchlist error:', e);
            showToast('åŠ å…¥å¤±æ•—', 'error');
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.search = {
            searchStock,
            searchSymbol,
            quickAddToWatchlist,
            clearCache: clearStockCache,
            getCacheStats: getStockCacheStats
        };
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.searchStock = searchStock;
    window.searchSymbol = searchSymbol;
    window.quickAddToWatchlist = quickAddToWatchlist;
    window.clearStockCache = clearStockCache;
    window.getStockCacheStats = getStockCacheStats;

    console.log('ğŸ” search-core.js æœå°‹æ ¸å¿ƒæ¨¡çµ„å·²è¼‰å…¥');
})();
/**
 * æœå°‹çµæœæ¸²æŸ“æ¨¡çµ„ (P2 æ‹†åˆ†)
 * 
 * è·è²¬ï¼š
 * - æœå°‹çµæœæ¸²æŸ“
 * - MA é€²éšåˆ†æ
 * - äº‹ä»¶å§”è¨—è™•ç†
 * 
 * ä¾è³´ï¼šcore.js, search-core.js
 */

(function() {
    'use strict';

    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================

    let currentChartData = null;

    // ============================================================
    // æ¸²æŸ“å…¥å£
    // ============================================================

    function renderSearchResult(data, symbol) {
        const upperSymbol = symbol.toUpperCase();
        const isCrypto = ['BTC', 'ETH', 'BITCOIN', 'ETHEREUM'].includes(upperSymbol);
        const isTaiwan = /^\d{4,6}$/.test(symbol) || upperSymbol.endsWith('.TW');

        currentChartData = data.chart_data;
        window.currentChartData = currentChartData;

        renderStockResult(data, isCrypto, isTaiwan);
    }

    // ============================================================
    // è‚¡ç¥¨çµæœæ¸²æŸ“
    // ============================================================

    function renderStockResult(stock, isCrypto, isTaiwan = false) {
        const container = $('searchResult');
        if (!container) return;

        const indicators = stock.indicators || {};
        const ma = indicators.ma || {};
        const rsi = indicators.rsi || {};
        const macd = indicators.macd || {};

        const priceChange = stock.change?.day || 0;
        const priceChangeClass = priceChange >= 0 ? 'text-green-600' : 'text-red-600';
        const priceChangeIcon = priceChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';

        const alignmentClass = ma.alignment === 'bullish' ? 'text-green-600' : ma.alignment === 'bearish' ? 'text-red-600' : 'text-gray-600';
        const alignmentText = ma.alignment === 'bullish' ? 'å¤šé ­ ğŸŸ¢' : ma.alignment === 'bearish' ? 'ç©ºé ­ ğŸ”´' : 'ä¸­æ€§';

        const rsiStatus = rsi.status === 'overbought' ? 'è¶…è²· âš ï¸' : rsi.status === 'oversold' ? 'è¶…è³£ ğŸŸ¢' : 'ä¸­æ€§';
        const macdStatus = macd.status === 'bullish' ? 'åå¤š ğŸŸ¢' : 'åç©º ğŸ”´';

        let marketLabel, marketClass;
        if (isCrypto) {
            marketLabel = 'åŠ å¯†è²¨å¹£';
            marketClass = 'bg-purple-100 text-purple-700';
        } else if (isTaiwan) {
            marketLabel = 'å°è‚¡';
            marketClass = 'bg-orange-100 text-orange-700';
        } else {
            marketLabel = 'ç¾è‚¡';
            marketClass = 'bg-blue-100 text-blue-700';
        }

        const cacheIndicator = stock.from_cache
            ? `<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-500" title="è³‡æ–™ä¾†è‡ªå¿«å–">
                   <i class="fas fa-database mr-1"></i>å¿«å–
               </span>`
            : '';

        const maAdvanced = renderMAAdvanced(ma, stock.price?.current);

        const html = `
            <div class="bg-white rounded-xl shadow overflow-hidden" id="searchResultCard" data-symbol="${stock.symbol}">
                <!-- åƒ¹æ ¼å€å¡Š -->
                <div class="p-4 md:p-6 border-b">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="text-xl md:text-2xl font-bold text-gray-800">${stock.symbol}</h3>
                            <p class="text-gray-500 text-sm">${stock.name || marketLabel}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            ${cacheIndicator}
                            <button data-action="refresh" data-symbol="${stock.symbol}" class="p-2 text-gray-400 hover:text-blue-600 transition" title="é‡æ–°æ•´ç†">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <span class="px-2 py-1 rounded text-xs ${marketClass}">${marketLabel}</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="text-3xl md:text-4xl font-bold text-gray-800">$${stock.price?.current?.toLocaleString() || '--'}</span>
                        <span class="ml-2 ${priceChangeClass} text-lg">
                            ${priceChange >= 0 ? '+' : ''}${priceChange?.toFixed(2)}% ${priceChangeIcon}
                        </span>
                    </div>
                </div>

                <!-- å¿«é€Ÿç¸½è¦½ -->
                <div class="p-4 md:p-6 border-b bg-gray-50">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">ğŸ“Š å¿«é€Ÿç¸½è¦½</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">å‡ç·šæ’åˆ—</span>
                            <span class="font-medium ${alignmentClass}">${alignmentText}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">RSI (${rsi.period || 14})</span>
                            <span class="font-medium">${rsi.value?.toFixed(1) || '--'} ${rsiStatus}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">MACD</span>
                            <span class="font-medium">${macdStatus}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">è©•åˆ†</span>
                            <span class="font-medium">${stock.score?.rating === 'bullish' ? 'åå¤š' : stock.score?.rating === 'bearish' ? 'åç©º' : 'ä¸­æ€§'} (${stock.score?.buy || 0}/${stock.score?.sell || 0})</span>
                        </div>
                    </div>
                </div>

                <!-- MA é€²éšåˆ†æ -->
                ${maAdvanced}

                <!-- å¹´åŒ–å ±é…¬ç‡ (CAGR) -->
                ${stock.cagr ? renderCAGRSection(stock.cagr) : ''}

                <!-- è©³ç´°æŒ‡æ¨™ (å¯æ‘ºç–Š) -->
                <div class="border-b">
                    <button data-action="toggle-collapsible" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 touch-target">
                        <span class="font-medium text-gray-700">â–¼ å±•é–‹è©³ç´°æŒ‡æ¨™</span>
                        <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                    </button>
                    <div class="collapsible-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                        ${renderDetailedIndicators(ma, rsi, macd)}
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="p-4 pb-28 md:pb-4 space-y-3">
                    ${stock.chart_data ? `
                    <button data-action="open-chart" data-symbol="${stock.symbol}" data-price="${stock.price?.current || 0}"
                        class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium flex items-center justify-center touch-target hover:bg-blue-700">
                        <i class="fas fa-chart-line mr-2"></i>æŸ¥çœ‹å®Œæ•´åœ–è¡¨
                    </button>
                    ` : ''}
                    <button data-action="load-returns" data-symbol="${stock.symbol}"
                        class="w-full py-3 bg-green-600 text-white rounded-lg font-medium flex items-center justify-center touch-target hover:bg-green-700">
                        <i class="fas fa-percentage mr-2"></i>å¹´åŒ–å ±é…¬ç‡
                    </button>
                    <button data-action="add-watchlist" data-symbol="${stock.symbol}" data-type="${isCrypto ? 'crypto' : 'stock'}"
                        class="w-full py-3 border-2 border-orange-500 text-orange-600 rounded-lg font-medium flex items-center justify-center touch-target hover:bg-orange-50">
                        <i class="fas fa-star mr-2"></i>åŠ å…¥è¿½è¹¤æ¸…å–®
                    </button>
                </div>
            </div>
        `;

        container.innerHTML = html;
    }

    // ============================================================
    // MA é€²éšåˆ†ææ¸²æŸ“
    // ============================================================

    function renderMAAdvanced(ma, currentPrice) {
        if (!ma || !currentPrice) return '';

        // äº¤å‰è¨Šè™Ÿ
        const crossSignals = [];
        if (ma.golden_cross_20_50) crossSignals.push({ type: 'golden', label: 'MA20â†—MA50 é»ƒé‡‘äº¤å‰', days: ma.golden_cross_20_50_days });
        if (ma.death_cross_20_50) crossSignals.push({ type: 'death', label: 'MA20â†˜MA50 æ­»äº¡äº¤å‰', days: ma.death_cross_20_50_days });
        if (ma.golden_cross_50_200) crossSignals.push({ type: 'golden', label: 'MA50â†—MA200 é»ƒé‡‘äº¤å‰', days: ma.golden_cross_50_200_days });
        if (ma.death_cross_50_200) crossSignals.push({ type: 'death', label: 'MA50â†˜MA200 æ­»äº¡äº¤å‰', days: ma.death_cross_50_200_days });

        // è·é›¢å‡ç·šç™¾åˆ†æ¯”
        const distances = [];
        if (ma.dist_ma20 !== undefined) distances.push({ label: 'MA20', value: ma.dist_ma20 });
        if (ma.dist_ma50 !== undefined) distances.push({ label: 'MA50', value: ma.dist_ma50 });
        if (ma.dist_ma200 !== undefined) distances.push({ label: 'MA200', value: ma.dist_ma200 });

        if (crossSignals.length === 0 && distances.length === 0) return '';

        let html = `
            <div class="p-4 md:p-6 border-b">
                <h4 class="font-semibold text-gray-700 mb-3 text-sm">ğŸ” å‡ç·šé€²éšåˆ†æ</h4>
        `;

        // äº¤å‰è¨Šè™Ÿ
        if (crossSignals.length > 0) {
            html += `<div class="mb-3">`;
            crossSignals.forEach(signal => {
                const bgClass = signal.type === 'golden' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const icon = signal.type === 'golden' ? 'ğŸ”º' : 'ğŸ”»';
                const daysText = signal.days ? `(${signal.days}å¤©å‰)` : '';
                html += `
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium ${bgClass} mr-2 mb-2">
                        ${icon} ${signal.label} ${daysText}
                    </span>
                `;
            });
            html += `</div>`;
        }

        // è·é›¢å‡ç·š
        if (distances.length > 0) {
            html += `
                <div class="grid grid-cols-3 gap-2 text-center">
                    ${distances.map(d => {
                        const isAbove = d.value >= 0;
                        const bgClass = isAbove ? 'bg-green-50' : 'bg-red-50';
                        const textClass = isAbove ? 'text-green-600' : 'text-red-600';
                        return `
                            <div class="p-2 rounded-lg ${bgClass}">
                                <p class="text-gray-500 text-xs">è· ${d.label}</p>
                                <p class="font-bold ${textClass}">${d.value >= 0 ? '+' : ''}${d.value.toFixed(1)}%</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        html += `</div>`;
        return html;
    }

    // ============================================================
    // CAGR å€å¡Šæ¸²æŸ“
    // ============================================================

    function renderCAGRSection(cagr) {
        return `
            <div class="p-4 md:p-6 border-b">
                <h4 class="font-semibold text-gray-700 mb-3 text-sm">ğŸ“ˆ å¹´åŒ–å ±é…¬ç‡ (CAGR)</h4>
                <div class="grid grid-cols-4 gap-2 text-center">
                    ${['1y', '3y', '5y', '10y'].map(period => {
                        const val = cagr[`cagr_${period}`];
                        const bgClass = val > 0 ? 'bg-green-50' : val < 0 ? 'bg-red-50' : 'bg-gray-50';
                        const textClass = val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-gray-600';
                        return `
                            <div class="p-2 rounded-lg ${bgClass}">
                                <p class="text-gray-500 text-xs">${period.replace('y', ' å¹´')}</p>
                                <p class="font-bold ${textClass}">
                                    ${val !== null ? (val > 0 ? '+' : '') + val + '%' : '--'}
                                </p>
                            </div>
                        `;
                    }).join('')}
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">å¹´åŒ–è¤‡åˆæˆé•·ç‡ï¼Œåæ˜ é•·æœŸæŠ•è³‡å›å ±</p>
            </div>
        `;
    }

    // ============================================================
    // è©³ç´°æŒ‡æ¨™æ¸²æŸ“
    // ============================================================

    function renderDetailedIndicators(ma, rsi, macd) {
        return `
            <div class="px-4 pb-4 space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    ${['ma20', 'ma50', 'ma200'].map(key => {
                        const val = ma[key];
                        const vsKey = `price_vs_${key}`;
                        const isAbove = ma[vsKey] === 'above';
                        const distKey = `dist_${key}`;
                        const dist = ma[distKey];
                        const distText = dist !== undefined ? `${dist >= 0 ? '+' : ''}${dist.toFixed(1)}%` : '';
                        return `
                            <div class="p-3 rounded-lg ${isAbove ? 'bg-green-50' : 'bg-red-50'}">
                                <p class="text-gray-500 text-xs">${key.toUpperCase()}</p>
                                <p class="font-semibold">${val?.toFixed(2) || '--'}</p>
                                <p class="text-xs ${isAbove ? 'text-green-600' : 'text-red-600'}">
                                    ${isAbove ? 'åƒ¹æ ¼åœ¨ä¸Š âœ”' : 'åƒ¹æ ¼åœ¨ä¸‹'} ${distText ? `(${distText})` : ''}
                                </p>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-500 text-xs">RSI (${rsi.period || 14})</p>
                        <p class="font-semibold">${rsi.value?.toFixed(2) || '--'}</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-500 text-xs">MACD DIF</p>
                        <p class="font-semibold">${macd.dif?.toFixed(2) || '--'}</p>
                    </div>
                </div>
            </div>
        `;
    }

    // ============================================================
    // äº‹ä»¶å§”è¨— (P2 æ ¸å¿ƒå„ªåŒ–)
    // ============================================================

    function initSearchEventDelegation() {
        const container = $('searchResult');
        if (!container) return;

        // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œåªç¶å®šä¸€å€‹ç›£è½å™¨
        container.addEventListener('click', handleSearchResultClick);
        console.log('ğŸ“Œ æœå°‹çµæœäº‹ä»¶å§”è¨—å·²åˆå§‹åŒ–');
    }

    function handleSearchResultClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const symbol = target.dataset.symbol;

        switch (action) {
            case 'refresh':
                e.preventDefault();
                if (typeof searchSymbol === 'function') {
                    searchSymbol(symbol, true);
                }
                break;

            case 'toggle-collapsible':
                e.preventDefault();
                toggleCollapsible(target);
                break;

            case 'open-chart':
                e.preventDefault();
                const price = parseFloat(target.dataset.price) || 0;
                if (typeof openChartFullscreen === 'function') {
                    openChartFullscreen(symbol, price);
                }
                break;

            case 'load-returns':
                e.preventDefault();
                if (typeof loadReturnsModal === 'function') {
                    loadReturnsModal(symbol);
                }
                break;

            case 'add-watchlist':
                e.preventDefault();
                const type = target.dataset.type || 'stock';
                if (typeof quickAddToWatchlist === 'function') {
                    quickAddToWatchlist(symbol, type);
                }
                break;
        }
    }

    // æ‘ºç–Šé¢æ¿åˆ‡æ›
    function toggleCollapsible(button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('i');

        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
            content.style.maxHeight = '0px';
            if (icon) icon.style.transform = '';
        } else {
            content.style.maxHeight = content.scrollHeight + 'px';
            if (icon) icon.style.transform = 'rotate(180deg)';
        }
    }

    // ============================================================
    // åˆå§‹åŒ–
    // ============================================================

    function init() {
        // DOM è¼‰å…¥å¾Œåˆå§‹åŒ–äº‹ä»¶å§”è¨—
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSearchEventDelegation);
        } else {
            initSearchEventDelegation();
        }
    }

    init();

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA && window.SELA.search) {
        Object.assign(window.SELA.search, {
            renderSearchResult,
            renderStockResult
        });
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.renderSearchResult = renderSearchResult;
    window.renderStockResult = renderStockResult;
    window.toggleCollapsible = toggleCollapsible;

    console.log('ğŸ¨ search-render.js æ¸²æŸ“æ¨¡çµ„å·²è¼‰å…¥');
})();
/**
 * æœå°‹åœ–è¡¨æ¨¡çµ„ (P2 æ‹†åˆ†)
 * 
 * è·è²¬ï¼š
 * - å…¨è¢å¹•åœ–è¡¨
 * - æˆäº¤é‡åœ–è¡¨
 * - åœ–è¡¨äº’å‹•
 * 
 * ä¾è³´ï¼šcore.js, Chart.js
 */

(function() {
    'use strict';

    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================

    let fullscreenChartInstance = null;
    let volumeChartInstance = null;

    // ============================================================
    // å…¨è¢å¹•åœ–è¡¨
    // ============================================================

    function openChartFullscreen(symbol, currentPrice) {
        const chartData = window.currentChartData;
        if (!chartData) {
            showToast('ç„¡åœ–è¡¨è³‡æ–™');
            return;
        }

        const modal = $('chartFullscreenModal');
        if (!modal) return;

        // æ›´æ–°æ¨™é¡Œ
        const title = $('chartModalTitle');
        if (title) title.textContent = `${symbol} æŠ€è¡“åˆ†æ`;

        const priceEl = $('chartModalPrice');
        if (priceEl) priceEl.textContent = `$${currentPrice?.toLocaleString() || '--'}`;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // é è¨­é¡¯ç¤º 60 å¤©
        setTimeout(() => renderFullscreenChart(chartData, 60), 100);
    }

    function closeChartFullscreen() {
        const modal = $('chartFullscreenModal');
        if (!modal) return;

        modal.classList.add('hidden');
        modal.classList.remove('flex');

        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
            fullscreenChartInstance = null;
        }
        if (volumeChartInstance) {
            volumeChartInstance.destroy();
            volumeChartInstance = null;
        }
    }

    function setChartRange(days) {
        const chartData = window.currentChartData;
        if (!chartData) return;

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.chart-range-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
            if (parseInt(btn.dataset.days) === days) {
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('bg-gray-100', 'text-gray-700');
            }
        });

        renderFullscreenChart(chartData, days);
    }

    // ============================================================
    // æ¸²æŸ“å…¨è¢å¹•åœ–è¡¨
    // ============================================================

    function renderFullscreenChart(chartData, days = 60) {
        const canvas = $('fullscreenChart');
        if (!canvas) return;

        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
        }

        const ctx = canvas.getContext('2d');
        const dataLength = chartData.dates.length;
        const startIdx = Math.max(0, dataLength - days);

        // æ—¥æœŸæ ¼å¼åŒ–
        const formatDate = (d) => {
            if (days <= 30) return d.slice(5);
            if (days <= 130) return d.slice(5);
            return d.slice(2, 7).replace('-', '/');
        };

        const labels = chartData.dates.slice(startIdx).map(formatDate);

        fullscreenChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ”¶ç›¤åƒ¹',
                        data: chartData.prices.slice(startIdx),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA20',
                        data: chartData.ma20.slice(startIdx),
                        borderColor: '#EF4444',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA50',
                        data: chartData.ma50.slice(startIdx),
                        borderColor: '#10B981',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA200',
                        data: chartData.ma200.slice(startIdx),
                        borderColor: '#EAB308',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA250',
                        data: chartData.ma250 ? chartData.ma250.slice(startIdx) : [],
                        borderColor: '#A855F7',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 10 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.raw === null ? null : `${ctx.dataset.label}: $${ctx.raw.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: days <= 60 ? 8 : 10, maxRotation: 0 }
                    },
                    y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            }
        });

        // æ¸²æŸ“æˆäº¤é‡åœ–è¡¨
        if (chartData.volumes && chartData.volumes.length > 0) {
            renderVolumeChart(chartData, days, labels);
        }
    }

    // ============================================================
    // æ¸²æŸ“æˆäº¤é‡åœ–è¡¨
    // ============================================================

    function renderVolumeChart(chartData, days, labels) {
        const volumeCanvas = $('volumeChart');
        if (!volumeCanvas) return;

        // é¡¯ç¤ºæˆäº¤é‡å®¹å™¨
        const volumeContainer = $('volumeChartContainer');
        if (volumeContainer) {
            volumeContainer.classList.remove('hidden');
        }

        if (volumeChartInstance) {
            volumeChartInstance.destroy();
        }

        const ctx = volumeCanvas.getContext('2d');
        const dataLength = chartData.dates.length;
        const startIdx = Math.max(0, dataLength - days);

        const volumes = chartData.volumes.slice(startIdx);
        const prices = chartData.prices.slice(startIdx);

        // è¨ˆç®—æ¯æ ¹æŸ±å­çš„é¡è‰²ï¼ˆæ¼²ç¶ è·Œç´…ï¼‰
        const barColors = prices.map((price, i) => {
            if (i === 0) return 'rgba(156, 163, 175, 0.6)';
            return price >= prices[i - 1] ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)';
        });

        // è¨ˆç®— 20 æ—¥å‡é‡
        const avgVolumes = [];
        for (let i = 0; i < volumes.length; i++) {
            if (i < 19) {
                avgVolumes.push(null);
            } else {
                const sum = volumes.slice(i - 19, i + 1).reduce((a, b) => a + b, 0);
                avgVolumes.push(sum / 20);
            }
        }

        volumeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æˆäº¤é‡',
                        data: volumes,
                        backgroundColor: barColors,
                        borderWidth: 0,
                        barPercentage: 0.8,
                    },
                    {
                        label: '20æ—¥å‡é‡',
                        data: avgVolumes,
                        type: 'line',
                        borderColor: '#F59E0B',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 10, boxWidth: 8 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                if (ctx.raw === null) return null;
                                const val = ctx.raw;
                                if (val >= 1e9) return `${ctx.dataset.label}: ${(val / 1e9).toFixed(2)}B`;
                                if (val >= 1e6) return `${ctx.dataset.label}: ${(val / 1e6).toFixed(2)}M`;
                                if (val >= 1e3) return `${ctx.dataset.label}: ${(val / 1e3).toFixed(2)}K`;
                                return `${ctx.dataset.label}: ${val.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
                                if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                                if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }

    // ============================================================
    // å¹´åŒ–å ±é…¬ç‡ Modal
    // ============================================================

    async function loadReturnsModal(symbol) {
        const modal = $('returnsModal');
        const content = $('returnsModalContent');
        if (!modal || !content) return;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                <p class="mt-2 text-gray-500">è¼‰å…¥ä¸­...</p>
            </div>
        `;

        try {
            const res = await apiRequest(`/api/stock/${symbol}/returns`);
            const data = await res.json();

            if (!data.success) {
                content.innerHTML = `<p class="text-center text-red-500">${data.detail || 'è¼‰å…¥å¤±æ•—'}</p>`;
                return;
            }

            renderReturnsContent(content, data);

        } catch (e) {
            console.error('Returns error:', e);
            content.innerHTML = `<p class="text-center text-red-500">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
        }
    }

    function renderReturnsContent(content, data) {
        const returns = data.returns || {};
        const cagr = data.cagr || {};

        const html = `
            <h4 class="font-semibold text-lg mb-4">${data.symbol} æ­·å²å ±é…¬ç‡</h4>
            
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 mb-2">ç´¯ç©å ±é…¬ç‡</p>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        ${['1m', '3m', '6m', '1y'].map(period => {
                            const val = returns[period];
                            const bgClass = val > 0 ? 'bg-green-50' : val < 0 ? 'bg-red-50' : 'bg-gray-50';
                            const textClass = val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-gray-600';
                            const label = period === '1m' ? '1æœˆ' : period === '3m' ? '3æœˆ' : period === '6m' ? '6æœˆ' : '1å¹´';
                            return `
                                <div class="p-2 rounded ${bgClass}">
                                    <p class="text-xs text-gray-500">${label}</p>
                                    <p class="font-bold ${textClass}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val.toFixed(1) + '%' : '--'}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500 mb-2">å¹´åŒ–å ±é…¬ç‡ (CAGR)</p>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        ${['1y', '3y', '5y', '10y'].map(period => {
                            const val = cagr[`cagr_${period}`];
                            const bgClass = val > 0 ? 'bg-green-50' : val < 0 ? 'bg-red-50' : 'bg-gray-50';
                            const textClass = val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-gray-600';
                            const label = period.replace('y', 'å¹´');
                            return `
                                <div class="p-2 rounded ${bgClass}">
                                    <p class="text-xs text-gray-500">${label}</p>
                                    <p class="font-bold ${textClass}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val + '%' : '--'}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <p class="text-xs text-gray-400 text-center">
                    CAGR = å¹´åŒ–è¤‡åˆæˆé•·ç‡ï¼Œå·²åŒ…å«é…æ¯å†æŠ•å…¥çš„è¤‡åˆ©æ•ˆæœ
                </p>
            </div>
        `;

        content.innerHTML = html;
    }

    function closeReturnsModal() {
        const modal = $('returnsModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA && window.SELA.search) {
        Object.assign(window.SELA.search, {
            openChartFullscreen,
            closeChartFullscreen,
            setChartRange,
            loadReturnsModal,
            closeReturnsModal
        });
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.openChartFullscreen = openChartFullscreen;
    window.closeChartFullscreen = closeChartFullscreen;
    window.setChartRange = setChartRange;
    window.renderFullscreenChart = renderFullscreenChart;
    window.renderVolumeChart = renderVolumeChart;
    window.loadReturnsModal = loadReturnsModal;
    window.closeReturnsModal = closeReturnsModal;

    console.log('ğŸ“Š search-chart.js åœ–è¡¨æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/search/search-chart.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * æœå°‹åœ–è¡¨æ¨¡çµ„ (P2 æ‹†åˆ†)
 * 
 * è·è²¬ï¼š
 * - å…¨è¢å¹•åœ–è¡¨
 * - æˆäº¤é‡åœ–è¡¨
 * - åœ–è¡¨äº’å‹•
 * 
 * ä¾è³´ï¼šcore.js, Chart.js
 */

(function() {
    'use strict';

    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================

    let fullscreenChartInstance = null;
    let volumeChartInstance = null;

    // ============================================================
    // å…¨è¢å¹•åœ–è¡¨
    // ============================================================

    function openChartFullscreen(symbol, currentPrice) {
        const chartData = window.currentChartData;
        if (!chartData) {
            showToast('ç„¡åœ–è¡¨è³‡æ–™');
            return;
        }

        const modal = $('chartFullscreenModal');
        if (!modal) return;

        // æ›´æ–°æ¨™é¡Œ
        const title = $('chartModalTitle');
        if (title) title.textContent = `${symbol} æŠ€è¡“åˆ†æ`;

        const priceEl = $('chartModalPrice');
        if (priceEl) priceEl.textContent = `$${currentPrice?.toLocaleString() || '--'}`;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // é è¨­é¡¯ç¤º 60 å¤©
        setTimeout(() => renderFullscreenChart(chartData, 60), 100);
    }

    function closeChartFullscreen() {
        const modal = $('chartFullscreenModal');
        if (!modal) return;

        modal.classList.add('hidden');
        modal.classList.remove('flex');

        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
            fullscreenChartInstance = null;
        }
        if (volumeChartInstance) {
            volumeChartInstance.destroy();
            volumeChartInstance = null;
        }
    }

    function setChartRange(days) {
        const chartData = window.currentChartData;
        if (!chartData) return;

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.chart-range-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
            if (parseInt(btn.dataset.days) === days) {
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('bg-gray-100', 'text-gray-700');
            }
        });

        renderFullscreenChart(chartData, days);
    }

    // ============================================================
    // æ¸²æŸ“å…¨è¢å¹•åœ–è¡¨
    // ============================================================

    function renderFullscreenChart(chartData, days = 60) {
        const canvas = $('fullscreenChart');
        if (!canvas) return;

        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
        }

        const ctx = canvas.getContext('2d');
        const dataLength = chartData.dates.length;
        const startIdx = Math.max(0, dataLength - days);

        // æ—¥æœŸæ ¼å¼åŒ–
        const formatDate = (d) => {
            if (days <= 30) return d.slice(5);
            if (days <= 130) return d.slice(5);
            return d.slice(2, 7).replace('-', '/');
        };

        const labels = chartData.dates.slice(startIdx).map(formatDate);

        fullscreenChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æ”¶ç›¤åƒ¹',
                        data: chartData.prices.slice(startIdx),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA20',
                        data: chartData.ma20.slice(startIdx),
                        borderColor: '#EF4444',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA50',
                        data: chartData.ma50.slice(startIdx),
                        borderColor: '#10B981',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA200',
                        data: chartData.ma200.slice(startIdx),
                        borderColor: '#EAB308',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                    {
                        label: 'MA250',
                        data: chartData.ma250 ? chartData.ma250.slice(startIdx) : [],
                        borderColor: '#A855F7',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 10 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.raw === null ? null : `${ctx.dataset.label}: $${ctx.raw.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: days <= 60 ? 8 : 10, maxRotation: 0 }
                    },
                    y: { grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            }
        });

        // æ¸²æŸ“æˆäº¤é‡åœ–è¡¨
        if (chartData.volumes && chartData.volumes.length > 0) {
            renderVolumeChart(chartData, days, labels);
        }
    }

    // ============================================================
    // æ¸²æŸ“æˆäº¤é‡åœ–è¡¨
    // ============================================================

    function renderVolumeChart(chartData, days, labels) {
        const volumeCanvas = $('volumeChart');
        if (!volumeCanvas) return;

        // é¡¯ç¤ºæˆäº¤é‡å®¹å™¨
        const volumeContainer = $('volumeChartContainer');
        if (volumeContainer) {
            volumeContainer.classList.remove('hidden');
        }

        if (volumeChartInstance) {
            volumeChartInstance.destroy();
        }

        const ctx = volumeCanvas.getContext('2d');
        const dataLength = chartData.dates.length;
        const startIdx = Math.max(0, dataLength - days);

        const volumes = chartData.volumes.slice(startIdx);
        const prices = chartData.prices.slice(startIdx);

        // è¨ˆç®—æ¯æ ¹æŸ±å­çš„é¡è‰²ï¼ˆæ¼²ç¶ è·Œç´…ï¼‰
        const barColors = prices.map((price, i) => {
            if (i === 0) return 'rgba(156, 163, 175, 0.6)';
            return price >= prices[i - 1] ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)';
        });

        // è¨ˆç®— 20 æ—¥å‡é‡
        const avgVolumes = [];
        for (let i = 0; i < volumes.length; i++) {
            if (i < 19) {
                avgVolumes.push(null);
            } else {
                const sum = volumes.slice(i - 19, i + 1).reduce((a, b) => a + b, 0);
                avgVolumes.push(sum / 20);
            }
        }

        volumeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'æˆäº¤é‡',
                        data: volumes,
                        backgroundColor: barColors,
                        borderWidth: 0,
                        barPercentage: 0.8,
                    },
                    {
                        label: '20æ—¥å‡é‡',
                        data: avgVolumes,
                        type: 'line',
                        borderColor: '#F59E0B',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 10, boxWidth: 8 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                if (ctx.raw === null) return null;
                                const val = ctx.raw;
                                if (val >= 1e9) return `${ctx.dataset.label}: ${(val / 1e9).toFixed(2)}B`;
                                if (val >= 1e6) return `${ctx.dataset.label}: ${(val / 1e6).toFixed(2)}M`;
                                if (val >= 1e3) return `${ctx.dataset.label}: ${(val / 1e3).toFixed(2)}K`;
                                return `${ctx.dataset.label}: ${val.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
                                if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                                if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }

    // ============================================================
    // å¹´åŒ–å ±é…¬ç‡ Modal
    // ============================================================

    async function loadReturnsModal(symbol) {
        const modal = $('returnsModal');
        const content = $('returnsModalContent');
        if (!modal || !content) return;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                <p class="mt-2 text-gray-500">è¼‰å…¥ä¸­...</p>
            </div>
        `;

        try {
            const res = await apiRequest(`/api/stock/${symbol}/returns`);
            const data = await res.json();

            if (!data.success) {
                content.innerHTML = `<p class="text-center text-red-500">${data.detail || 'è¼‰å…¥å¤±æ•—'}</p>`;
                return;
            }

            renderReturnsContent(content, data);

        } catch (e) {
            console.error('Returns error:', e);
            content.innerHTML = `<p class="text-center text-red-500">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
        }
    }

    function renderReturnsContent(content, data) {
        const returns = data.returns || {};
        const cagr = data.cagr || {};

        const html = `
            <h4 class="font-semibold text-lg mb-4">${data.symbol} æ­·å²å ±é…¬ç‡</h4>
            
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 mb-2">ç´¯ç©å ±é…¬ç‡</p>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        ${['1m', '3m', '6m', '1y'].map(period => {
                            const val = returns[period];
                            const bgClass = val > 0 ? 'bg-green-50' : val < 0 ? 'bg-red-50' : 'bg-gray-50';
                            const textClass = val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-gray-600';
                            const label = period === '1m' ? '1æœˆ' : period === '3m' ? '3æœˆ' : period === '6m' ? '6æœˆ' : '1å¹´';
                            return `
                                <div class="p-2 rounded ${bgClass}">
                                    <p class="text-xs text-gray-500">${label}</p>
                                    <p class="font-bold ${textClass}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val.toFixed(1) + '%' : '--'}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500 mb-2">å¹´åŒ–å ±é…¬ç‡ (CAGR)</p>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        ${['1y', '3y', '5y', '10y'].map(period => {
                            const val = cagr[`cagr_${period}`];
                            const bgClass = val > 0 ? 'bg-green-50' : val < 0 ? 'bg-red-50' : 'bg-gray-50';
                            const textClass = val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-gray-600';
                            const label = period.replace('y', 'å¹´');
                            return `
                                <div class="p-2 rounded ${bgClass}">
                                    <p class="text-xs text-gray-500">${label}</p>
                                    <p class="font-bold ${textClass}">${val !== null && val !== undefined ? (val > 0 ? '+' : '') + val + '%' : '--'}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <p class="text-xs text-gray-400 text-center">
                    CAGR = å¹´åŒ–è¤‡åˆæˆé•·ç‡ï¼Œå·²åŒ…å«é…æ¯å†æŠ•å…¥çš„è¤‡åˆ©æ•ˆæœ
                </p>
            </div>
        `;

        content.innerHTML = html;
    }

    function closeReturnsModal() {
        const modal = $('returnsModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA && window.SELA.search) {
        Object.assign(window.SELA.search, {
            openChartFullscreen,
            closeChartFullscreen,
            setChartRange,
            loadReturnsModal,
            closeReturnsModal
        });
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.openChartFullscreen = openChartFullscreen;
    window.closeChartFullscreen = closeChartFullscreen;
    window.setChartRange = setChartRange;
    window.renderFullscreenChart = renderFullscreenChart;
    window.renderVolumeChart = renderVolumeChart;
    window.loadReturnsModal = loadReturnsModal;
    window.closeReturnsModal = closeReturnsModal;

    console.log('ğŸ“Š search-chart.js åœ–è¡¨æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/search/search-core.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * æœå°‹æ ¸å¿ƒæ¨¡çµ„ (P2 æ‹†åˆ† + æ•ˆèƒ½å„ªåŒ–ç‰ˆ)
 * 
 * è·è²¬ï¼š
 * - æœå°‹é‚è¼¯
 * - API è«‹æ±‚
 * - å¿«å–ç®¡ç†
 * 
 * â­ æ•ˆèƒ½å„ªåŒ–ï¼š
 * - å¿«å–æ™‚é–“å»¶é•·åˆ° 30 åˆ†é˜
 * - ä½¿ç”¨ sessionStorage æŒä¹…åŒ–ï¼ˆé é¢åˆ·æ–°å¾Œä¿ç•™ï¼‰
 * - ç•¶æ—¥æœ‰æ•ˆæœŸåˆ¤æ–·
 * 
 * ä¾è³´ï¼šcore.js, state.js
 * è¢«ä¾è³´ï¼šsearch-render.js
 */

(function() {
    'use strict';

    // ============================================================
    // å¿«å–ç³»çµ±ï¼ˆå„ªåŒ–ç‰ˆï¼‰
    // ============================================================
    
    const stockCache = new Map();
    const CACHE_TTL = 30 * 60 * 1000; // â­ å»¶é•·åˆ° 30 åˆ†é˜
    const STORAGE_KEY = 'sela_stock_cache';

    /**
     * å–å¾—ä»Šæ—¥æ—¥æœŸå­—ä¸² (ç”¨æ–¼åˆ¤æ–·å¿«å–æ˜¯å¦ç•¶æ—¥æœ‰æ•ˆ)
     */
    function getTodayStr() {
        return new Date().toISOString().split('T')[0];
    }

    /**
     * å•Ÿå‹•æ™‚å¾ sessionStorage æ¢å¾©å¿«å–
     */
    function restoreCacheFromStorage() {
        try {
            const stored = sessionStorage.getItem(STORAGE_KEY);
            if (!stored) return;

            const parsed = JSON.parse(stored);
            const today = getTodayStr();

            // åªæ¢å¾©ç•¶æ—¥çš„å¿«å–
            if (parsed.date !== today) {
                sessionStorage.removeItem(STORAGE_KEY);
                console.log('ğŸ“¦ å¿«å–å·²éæœŸï¼ˆéç•¶æ—¥ï¼‰ï¼Œå·²æ¸…é™¤');
                return;
            }

            // æ¢å¾©å¿«å–
            let restored = 0;
            for (const [symbol, entry] of Object.entries(parsed.data)) {
                // æª¢æŸ¥ TTL æ˜¯å¦éæœŸ
                if (Date.now() - entry.timestamp < CACHE_TTL) {
                    stockCache.set(symbol, entry);
                    restored++;
                }
            }

            if (restored > 0) {
                console.log(`ğŸ“¦ å·²å¾ sessionStorage æ¢å¾© ${restored} ç­†å¿«å–`);
            }
        } catch (e) {
            console.warn('æ¢å¾©å¿«å–å¤±æ•—:', e);
            sessionStorage.removeItem(STORAGE_KEY);
        }
    }

    /**
     * å°‡å¿«å–åŒæ­¥åˆ° sessionStorage
     */
    function syncCacheToStorage() {
        try {
            const data = {};
            stockCache.forEach((value, key) => {
                data[key] = value;
            });

            sessionStorage.setItem(STORAGE_KEY, JSON.stringify({
                date: getTodayStr(),
                data: data
            }));
        } catch (e) {
            // sessionStorage å¯èƒ½å·²æ»¿ï¼Œå¿½ç•¥éŒ¯èª¤
            console.warn('åŒæ­¥å¿«å–åˆ° storage å¤±æ•—:', e);
        }
    }

    // å•Ÿå‹•æ™‚æ¢å¾©å¿«å–
    restoreCacheFromStorage();

    function getFromCache(symbol) {
        const cached = stockCache.get(symbol.toUpperCase());
        if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
            console.log(`ğŸ“¦ å¿«å–å‘½ä¸­: ${symbol} (å‰©é¤˜ ${Math.round((CACHE_TTL - (Date.now() - cached.timestamp)) / 1000)}ç§’)`);
            return cached.data;
        }
        return null;
    }

    function saveToCache(symbol, data) {
        stockCache.set(symbol.toUpperCase(), {
            data: data,
            timestamp: Date.now()
        });
        console.log(`ğŸ’¾ å·²å¿«å–: ${symbol}`);
        
        // åŒæ­¥åˆ° sessionStorage
        syncCacheToStorage();
    }

    function clearStockCache() {
        stockCache.clear();
        sessionStorage.removeItem(STORAGE_KEY);
        console.log('ğŸ—‘ï¸ è‚¡ç¥¨å¿«å–å·²æ¸…é™¤');
        showToast('å¿«å–å·²æ¸…é™¤');
    }

    function getStockCacheStats() {
        const now = Date.now();
        const validCount = Array.from(stockCache.values())
            .filter(c => now - c.timestamp < CACHE_TTL).length;
        
        return {
            count: stockCache.size,
            validCount: validCount,
            symbols: Array.from(stockCache.keys()),
            ttlMinutes: CACHE_TTL / 60000
        };
    }

    // ============================================================
    // æœå°‹åŠŸèƒ½
    // ============================================================

    function searchStock() {
        const input = $('searchSymbol');
        let symbol = input?.value?.trim().toUpperCase();
        if (!symbol) {
            showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
            return;
        }
        searchSymbol(symbol);
    }

    async function searchSymbol(symbol, forceRefresh = false) {
        const container = $('searchResult');
        
        if (typeof showSection === 'function') {
            showSection('search');
        }
        
        const input = $('searchSymbol');
        if (input) input.value = symbol;

        // æª¢æŸ¥å‰ç«¯å¿«å–
        if (!forceRefresh) {
            const cached = getFromCache(symbol);
            if (cached) {
                container.classList.remove('hidden');
                // è§¸ç™¼æ¸²æŸ“ï¼ˆç”± search-render.js è™•ç†ï¼‰
                renderSearchResult(cached, symbol);
                return;
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        container.classList.remove('hidden');
        setHtml('searchResult', `
            <div class="bg-white rounded-xl shadow p-6 text-center">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                <p class="mt-2 text-gray-500 text-sm">æŸ¥è©¢ä¸­...ï¼ˆé¦–æ¬¡æŸ¥è©¢å¯èƒ½éœ€è¦ 10-30 ç§’ï¼‰</p>
            </div>
        `);

        try {
            const upperSymbol = symbol.toUpperCase();
            const isCrypto = ['BTC', 'ETH', 'BITCOIN', 'ETHEREUM'].includes(upperSymbol);
            const isTaiwan = /^\d{4,6}$/.test(symbol) || upperSymbol.endsWith('.TW');

            let endpoint;
            let querySymbol = upperSymbol;

            if (isCrypto) {
                endpoint = `/api/crypto/${upperSymbol}`;
            } else if (isTaiwan) {
                querySymbol = upperSymbol.endsWith('.TW') ? upperSymbol : `${symbol}.TW`;
                endpoint = `/api/stock/${querySymbol}`;
            } else {
                endpoint = `/api/stock/${upperSymbol}`;
            }

            if (forceRefresh) {
                endpoint += '?refresh=true';
            }

            console.log(`æŸ¥è©¢: ${endpoint}, é¡å‹: ${isCrypto ? 'åŠ å¯†è²¨å¹£' : isTaiwan ? 'å°è‚¡' : 'ç¾è‚¡'}`);

            // è¨­ç½®è¼‰å…¥ç‹€æ…‹
            if (window.AppState) {
                AppState.setLoading(true);
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);

            const res = await fetch(endpoint, { signal: controller.signal });
            clearTimeout(timeoutId);

            const data = await res.json();
            console.log('API å›æ‡‰:', data);

            if (window.AppState) {
                AppState.setLoading(false);
            }

            if (!res.ok) {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        <p class="font-medium">æŸ¥è©¢å¤±æ•—</p>
                        <p class="text-sm mt-2">${data.detail || 'HTTP ' + res.status}</p>
                        ${isCrypto ? '<p class="text-xs mt-2 text-gray-500">æ³¨æ„ï¼šåŠ å¯†è²¨å¹£æŸ¥è©¢å¯èƒ½å›  API é™åˆ¶æš«æ™‚ç„¡æ³•ä½¿ç”¨</p>' : ''}
                    </div>
                `);
                return;
            }

            if (!data.success) {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        ${data.detail || 'æŸ¥è©¢å¤±æ•—'}
                    </div>
                `);
                return;
            }

            // å­˜å…¥å¿«å–
            saveToCache(symbol, data);
            
            // åŒæ­¥åˆ° AppState
            if (window.AppState) {
                AppState.setCurrentStock({
                    symbol: data.symbol,
                    name: data.name,
                    price: data.price,
                    isCrypto,
                    isTaiwan
                });
            }

            // æ¸²æŸ“çµæœï¼ˆç”± search-render.js è™•ç†ï¼‰
            renderSearchResult(data, symbol);

        } catch (e) {
            console.error('Search error:', e);
            
            if (window.AppState) {
                AppState.setLoading(false);
            }

            if (e.name === 'AbortError') {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        æŸ¥è©¢è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦
                    </div>
                `);
            } else {
                setHtml('searchResult', `
                    <div class="bg-white rounded-xl shadow p-6 text-center text-red-500">
                        æŸ¥è©¢å¤±æ•—: ${e.message}
                    </div>
                `);
            }
        }
    }

    // ============================================================
    // å¿«é€ŸåŠ å…¥è¿½è¹¤æ¸…å–®
    // ============================================================

    async function quickAddToWatchlist(symbol, type = 'stock') {
        try {
            const res = await apiRequest('/api/watchlist', {
                method: 'POST',
                body: { symbol: symbol.toUpperCase(), type }
            });

            const data = await res.json();

            if (res.ok && data.success) {
                showToast(`å·²åŠ å…¥è¿½è¹¤: ${symbol}`);
                
                // æ¨‚è§€æ›´æ–° AppState
                if (window.AppState) {
                    AppState.addToWatchlist({
                        symbol: symbol.toUpperCase(),
                        type,
                        added_at: new Date().toISOString()
                    });
                }
            } else {
                showToast(data.detail || 'åŠ å…¥å¤±æ•—', 'error');
            }
        } catch (e) {
            console.error('Add to watchlist error:', e);
            showToast('åŠ å…¥å¤±æ•—', 'error');
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.search = {
            searchStock,
            searchSymbol,
            quickAddToWatchlist,
            clearCache: clearStockCache,
            getCacheStats: getStockCacheStats
        };
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.searchStock = searchStock;
    window.searchSymbol = searchSymbol;
    window.quickAddToWatchlist = quickAddToWatchlist;
    window.clearStockCache = clearStockCache;
    window.getStockCacheStats = getStockCacheStats;

    console.log('ğŸ” search-core.js æœå°‹æ ¸å¿ƒæ¨¡çµ„å·²è¼‰å…¥ (å„ªåŒ–ç‰ˆ: 30åˆ†é˜å¿«å– + sessionStorage æŒä¹…åŒ–)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/search/search-render.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * æœå°‹çµæœæ¸²æŸ“æ¨¡çµ„ (ä¿®æ­£ç‰ˆ)
 * 
 * ä¿®æ­£ï¼š
 * - chartFullscreenModal â†’ chartFullscreen
 * - chartModalTitle â†’ chartFullscreenTitle
 */

(function() {
    'use strict';

    // ============================================================
    // è¼”åŠ©å‡½æ•¸
    // ============================================================

    function $(id) {
        return document.getElementById(id);
    }

    function setHtml(id, html) {
        const el = $(id);
        if (el) el.innerHTML = html;
    }

    // ============================================================
    // åœ–è¡¨å¯¦ä¾‹
    // ============================================================

    let fullscreenChartInstance = null;
    let volumeChartInstance = null;
    let currentChartData = null;

    // ============================================================
    // æ¸²æŸ“å…¥å£
    // ============================================================

    function renderSearchResult(data, symbol) {
        const upperSymbol = symbol.toUpperCase();
        const isCrypto = ['BTC', 'ETH', 'BITCOIN', 'ETHEREUM'].includes(upperSymbol);
        const isTaiwan = /^\d{4,6}$/.test(symbol) || upperSymbol.endsWith('.TW');

        currentChartData = data.chart_data;
        window.currentChartData = currentChartData;

        renderStockResult(data, isCrypto, isTaiwan);
    }

    // ============================================================
    // è‚¡ç¥¨çµæœæ¸²æŸ“
    // ============================================================

    function renderStockResult(data, isCrypto, isTaiwan) {
        const symbol = data.symbol;
        const name = data.name || symbol;
        const price = data.price?.current || 0;
        const change = data.change || {};
        const indicators = data.indicators || {};
        const score = data.score || {};

        const dayChange = change.day;
        const changeClass = dayChange >= 0 ? 'text-green-600' : 'text-red-600';
        const changeIcon = dayChange >= 0 ? 'â–²' : 'â–¼';
        const changeBg = dayChange >= 0 ? 'bg-green-50' : 'bg-red-50';

        // æ ¼å¼åŒ–åƒ¹æ ¼
        const formatPrice = (p) => {
            if (p == null) return '--';
            if (isTaiwan) return p.toLocaleString();
            return p.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // MA ç‹€æ…‹
        const ma = indicators.ma || {};
        const maAlignment = ma.alignment || 'neutral';
        const maAlignmentText = maAlignment === 'bullish' ? 'å¤šé ­æ’åˆ—' : maAlignment === 'bearish' ? 'ç©ºé ­æ’åˆ—' : 'ä¸­æ€§';
        const maAlignmentClass = maAlignment === 'bullish' ? 'text-green-600' : maAlignment === 'bearish' ? 'text-red-600' : 'text-gray-600';

        // RSI ç‹€æ…‹
        const rsi = indicators.rsi || {};
        const rsiValue = rsi.value || 50;
        const rsiStatus = rsi.status || 'neutral';
        const rsiClass = rsiStatus === 'overbought' ? 'text-red-600' : rsiStatus === 'oversold' ? 'text-green-600' : 'text-gray-600';
        const rsiText = rsiStatus === 'overbought' ? 'è¶…è²·' : rsiStatus === 'oversold' ? 'è¶…è³£' : 'ä¸­æ€§';

        // MACD ç‹€æ…‹
        const macd = indicators.macd || {};
        const macdStatus = macd.status || 'neutral';
        const macdClass = macdStatus === 'bullish' ? 'text-green-600' : 'text-red-600';
        const macdText = macdStatus === 'bullish' ? 'å¤šé ­' : 'ç©ºé ­';

        // è©•åˆ†
        const rating = score.rating || 'neutral';
        const ratingText = rating === 'bullish' ? 'åå¤š' : rating === 'bearish' ? 'åç©º' : 'ä¸­æ€§';
        const ratingClass = rating === 'bullish' ? 'bg-green-100 text-green-800' : rating === 'bearish' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';

        const html = `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <!-- æ¨™é¡Œåˆ— -->
                <div class="p-4 ${changeBg} border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">${symbol}</h2>
                            <p class="text-sm text-gray-600">${name}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-800">${isTaiwan ? '' : '$'}${formatPrice(price)}</p>
                            <p class="${changeClass} text-sm font-medium">
                                ${changeIcon} ${dayChange != null ? Math.abs(dayChange).toFixed(2) + '%' : '--'}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickAddToWatchlist('${symbol}', 'stock')" 
                                class="flex-1 min-w-[100px] py-2 px-3 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-1"></i>è¿½è¹¤
                        </button>
                        <button data-action="open-chart" data-symbol="${symbol}" data-price="${price}"
                                class="flex-1 min-w-[100px] py-2 px-3 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors">
                            <i class="fas fa-chart-line mr-1"></i>åœ–è¡¨
                        </button>
                        <button data-action="load-returns" data-symbol="${symbol}"
                                class="flex-1 min-w-[100px] py-2 px-3 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                            <i class="fas fa-percentage mr-1"></i>å ±é…¬ç‡
                        </button>
                    </div>
                </div>

                <!-- æŠ€è¡“æŒ‡æ¨™æ‘˜è¦ -->
                <div class="p-4">
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">MA æ’åˆ—</p>
                            <p class="font-bold ${maAlignmentClass}">${maAlignmentText}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">RSI(14)</p>
                            <p class="font-bold ${rsiClass}">${rsiValue.toFixed(1)} ${rsiText}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">MACD</p>
                            <p class="font-bold ${macdClass}">${macdText}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">ç¶œåˆè©•åˆ†</p>
                            <span class="px-2 py-1 rounded text-sm font-medium ${ratingClass}">${ratingText}</span>
                        </div>
                    </div>

                    <!-- æ¼²è·Œå¹… -->
                    <div class="border-t pt-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">å€é–“æ¼²è·Œ</p>
                        <div class="flex flex-wrap gap-2 text-xs">
                            ${renderChangeTag('1é€±', change.week)}
                            ${renderChangeTag('1æœˆ', change.month)}
                            ${renderChangeTag('1å­£', change.quarter)}
                            ${renderChangeTag('1å¹´', change.year)}
                        </div>
                    </div>

                    <!-- MA è©³ç´° -->
                    <div class="border-t pt-4 mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">å‡ç·šä½ç½®</p>
                        <div class="space-y-1 text-xs">
                            ${renderMARow('MA20', ma.ma20, ma.price_vs_ma20, price)}
                            ${renderMARow('MA50', ma.ma50, ma.price_vs_ma50, price)}
                            ${renderMARow('MA200', ma.ma200, ma.price_vs_ma200, price)}
                        </div>
                    </div>
                </div>
            </div>
        `;

        setHtml('searchResult', html);

        // ç¶å®šäº‹ä»¶
        bindResultEvents();
    }

    function renderChangeTag(label, value) {
        if (value == null) return `<span class="px-2 py-1 bg-gray-100 text-gray-500 rounded">${label}: --</span>`;
        const cls = value >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const sign = value >= 0 ? '+' : '';
        return `<span class="px-2 py-1 ${cls} rounded">${label}: ${sign}${value.toFixed(2)}%</span>`;
    }

    function renderMARow(label, maValue, position, currentPrice) {
        if (maValue == null) return '';
        const posClass = position === 'above' ? 'text-green-600' : 'text-red-600';
        const posText = position === 'above' ? 'åƒ¹æ ¼åœ¨ä¸Š' : 'åƒ¹æ ¼åœ¨ä¸‹';
        const diff = currentPrice && maValue ? ((currentPrice - maValue) / maValue * 100).toFixed(2) : '--';
        return `
            <div class="flex justify-between items-center py-1">
                <span class="text-gray-600">${label}</span>
                <span class="text-gray-800">${maValue.toFixed(2)}</span>
                <span class="${posClass}">${posText} (${diff}%)</span>
            </div>
        `;
    }

    // ============================================================
    // äº‹ä»¶ç¶å®š
    // ============================================================

    function bindResultEvents() {
        const container = $('searchResult');
        if (!container) return;

        container.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const symbol = target.dataset.symbol;

            switch (action) {
                case 'open-chart':
                    e.preventDefault();
                    const price = parseFloat(target.dataset.price) || 0;
                    openChartFullscreen(symbol, price);
                    break;

                case 'load-returns':
                    e.preventDefault();
                    if (typeof loadReturnsModal === 'function') {
                        loadReturnsModal(symbol);
                    }
                    break;

                case 'add-watchlist':
                    e.preventDefault();
                    const type = target.dataset.type || 'stock';
                    if (typeof quickAddToWatchlist === 'function') {
                        quickAddToWatchlist(symbol, type);
                    }
                    break;
            }
        });
    }

    // ============================================================
    // ğŸ”´ ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ ID
    // ============================================================

    function openChartFullscreen(symbol, currentPrice) {
        const chartData = window.currentChartData;
        if (!chartData) {
            if (typeof showToast === 'function') {
                showToast('ç„¡åœ–è¡¨è³‡æ–™');
            }
            return;
        }

        // ğŸ”´ ä¿®æ­£ï¼šchartFullscreenModal â†’ chartFullscreen
        const modal = $('chartFullscreen');
        if (!modal) {
            console.error('æ‰¾ä¸åˆ° chartFullscreen å…ƒç´ ');
            return;
        }

        // ğŸ”´ ä¿®æ­£ï¼šchartModalTitle â†’ chartFullscreenTitle
        const title = $('chartFullscreenTitle');
        if (title) title.textContent = `${symbol} æŠ€è¡“åˆ†æ`;

        // ğŸ”´ ä¿®æ­£ï¼šç›´æ¥è¨­å®š display è€Œéä¾è³´ CSS class
        modal.style.display = 'block';
        modal.classList.add('active');

        // é è¨­é¡¯ç¤º 65 å¤© (3M)
        setTimeout(() => renderFullscreenChart(chartData, 65), 100);
    }

    function closeChartFullscreen() {
        // ğŸ”´ ä¿®æ­£ï¼šchartFullscreenModal â†’ chartFullscreen
        const modal = $('chartFullscreen');
        if (!modal) return;

        // ğŸ”´ ä¿®æ­£ï¼šç›´æ¥è¨­å®š display
        modal.style.display = 'none';
        modal.classList.remove('active');

        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
            fullscreenChartInstance = null;
        }
    }

    function setChartRange(days) {
        const chartData = window.currentChartData;
        if (!chartData) return;

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.chart-range-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'active');
            btn.classList.add('bg-gray-100', 'text-gray-700');
            if (parseInt(btn.dataset.days) === days) {
                btn.classList.add('bg-blue-600', 'text-white', 'active');
                btn.classList.remove('bg-gray-100', 'text-gray-700');
            }
        });

        renderFullscreenChart(chartData, days);
    }

    // ============================================================
    // æ¸²æŸ“å…¨è¢å¹•åœ–è¡¨
    // ============================================================

    function renderFullscreenChart(chartData, days = 65) {
        const canvas = $('fullscreenChart');
        if (!canvas) {
            console.error('æ‰¾ä¸åˆ° fullscreenChart canvas');
            return;
        }

        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
        }

        const ctx = canvas.getContext('2d');
        const dataLength = chartData.dates.length;
        const startIdx = Math.max(0, dataLength - days);

        // æ—¥æœŸæ ¼å¼åŒ–
        const formatDate = (d) => {
            if (!d) return '';
            if (days <= 30) return d.slice(5);
            if (days <= 130) return d.slice(5);
            return d.slice(2, 7).replace('-', '/');
        };

        const labels = chartData.dates.slice(startIdx).map(formatDate);
        const prices = chartData.prices.slice(startIdx);
        const ma20 = chartData.ma20?.slice(startIdx) || [];
        const ma50 = chartData.ma50?.slice(startIdx) || [];
        const ma200 = chartData.ma200?.slice(startIdx) || [];

        const datasets = [
            {
                label: 'è‚¡åƒ¹',
                data: prices,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1,
                pointRadius: 0,
            }
        ];

        if (ma20.length > 0 && ma20.some(v => v != null)) {
            datasets.push({
                label: 'MA20',
                data: ma20,
                borderColor: '#F59E0B',
                borderWidth: 1.5,
                fill: false,
                tension: 0.1,
                pointRadius: 0,
            });
        }

        if (ma50.length > 0 && ma50.some(v => v != null)) {
            datasets.push({
                label: 'MA50',
                data: ma50,
                borderColor: '#10B981',
                borderWidth: 1.5,
                fill: false,
                tension: 0.1,
                pointRadius: 0,
            });
        }

        if (ma200.length > 0 && ma200.some(v => v != null)) {
            datasets.push({
                label: 'MA200',
                data: ma200,
                borderColor: '#EF4444',
                borderWidth: 1.5,
                fill: false,
                tension: 0.1,
                pointRadius: 0,
            });
        }

        fullscreenChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        enabled: true,
                    },
                },
                scales: {
                    x: {
                        display: true,
                        ticks: {
                            maxTicksLimit: 8,
                            font: { size: 10 },
                        },
                    },
                    y: {
                        display: true,
                        position: 'right',
                        ticks: {
                            font: { size: 10 },
                        },
                    },
                },
            },
        });
    }

    // ============================================================
    // åœ–è¡¨ç¯„åœæŒ‰éˆ•äº‹ä»¶
    // ============================================================

    document.addEventListener('DOMContentLoaded', () => {
        // ç¶å®šåœ–è¡¨ç¯„åœæŒ‰éˆ•
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.chart-range-btn');
            if (btn) {
                const days = parseInt(btn.dataset.days) || 65;
                setChartRange(days);
            }
        });
    });

    // ============================================================
    // å°å‡º
    // ============================================================

    window.renderSearchResult = renderSearchResult;
    window.openChartFullscreen = openChartFullscreen;
    window.closeChartFullscreen = closeChartFullscreen;
    window.setChartRange = setChartRange;

    console.log('ğŸ“Š search-render.js æ¨¡çµ„å·²è¼‰å…¥ (ä¿®æ­£ç‰ˆ: æ­£ç¢ºçš„ Modal ID)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/sections.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * Section å…§å®¹å‹•æ…‹ç”Ÿæˆæ¨¡çµ„
 * å°‡æ‰€æœ‰ section HTML å¾ dashboard.html ç§»å‡º
 */
(function() {
    'use strict';

    // è¼”åŠ©å‡½æ•¸
    function renderIndexCard(symbol, name, id, color, icon) {
        return `<div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="openIndexModal('${symbol}', '${name}')">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-${color}-100 rounded-lg flex items-center justify-center mr-3"><i class="fas ${icon} text-${color}-600"></i></div>
                    <div><h3 class="font-semibold text-gray-700 text-sm">${name}</h3><p class="text-xs text-gray-400">${symbol}</p></div>
                </div>
                <i class="fas fa-chart-area text-gray-300"></i>
            </div>
            <div class="flex items-baseline justify-between">
                <span id="index-${id}-price" class="text-xl font-bold text-gray-800">--</span>
                <span id="index-${id}-change" class="text-sm font-medium">--</span>
            </div>
            <p id="index-${id}-date" class="text-xs text-gray-400 mt-1"></p>
        </div>`;
    }

    function renderGauge(type, title, iconClass, color) {
        return `<div class="bg-white rounded-xl shadow p-4 md:p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="openSentimentModal('${type}', '${title}')">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-700 text-sm md:text-base"><i class="${iconClass} mr-2 text-${color}-500"></i>${title}</h3>
                <i class="fas fa-chart-area text-gray-300"></i>
            </div>
            <div class="fear-greed-gauge" id="${type}Gauge">
                <svg viewBox="0 0 200 115" class="gauge-svg">
                    <path class="gauge-arc gauge-arc-extreme-fear" d="M 20 100 A 80 80 0 0 1 38 62" />
                    <path class="gauge-arc gauge-arc-fear" d="M 38 62 A 80 80 0 0 1 75 32" />
                    <path class="gauge-arc gauge-arc-neutral" d="M 75 32 A 80 80 0 0 1 125 32" />
                    <path class="gauge-arc gauge-arc-greed" d="M 125 32 A 80 80 0 0 1 162 62" />
                    <path class="gauge-arc gauge-arc-extreme-greed" d="M 162 62 A 80 80 0 0 1 180 100" />
                    <text x="8" y="105" class="gauge-tick-text">0</text>
                    <text x="96" y="12" class="gauge-tick-text" text-anchor="middle">50</text>
                    <text x="188" y="105" class="gauge-tick-text">100</text>
                    <g id="${type}NeedleGroup" class="gauge-needle-group"><polygon class="gauge-needle" points="100,25 97,100 103,100" /></g>
                    <circle class="gauge-center-dot" cx="100" cy="100" r="6" />
                </svg>
            </div>
            <div class="text-center mt-2"><span id="${type}GaugeValue" class="text-4xl font-bold text-gray-800">--</span></div>
            <p id="${type}SentimentStatus" class="text-center font-semibold text-lg mt-1"></p>
            <p id="${type}SentimentTime" class="text-xs text-gray-400 text-center mt-1"></p>
            <p class="text-xs text-blue-500 text-center mt-2"><i class="fas fa-chart-line mr-1"></i>é»æ“ŠæŸ¥çœ‹èµ°å‹¢</p>
        </div>`;
    }

    const SECTION_TEMPLATES = {
        dashboard: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">å„€è¡¨æ¿</h2>
            <div class="mb-4 md:mb-6">
                <div id="btc-price-card" class="bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl p-4 md:p-5 text-white shadow-lg cursor-pointer hover:shadow-xl transition-all duration-300" onclick="showSection('search', event); setTimeout(() => { document.getElementById('searchSymbol').value='BTC'; searchStock(); }, 100);">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1"><i class="fab fa-bitcoin text-xl"></i><span class="text-sm font-medium opacity-90">Bitcoin</span></div>
                            <div class="text-2xl md:text-3xl font-bold truncate" id="btc-price">$--,---</div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-3">
                            <div class="text-lg md:text-xl font-semibold" id="btc-change">--%</div>
                            <div class="text-xs opacity-75">24h</div>
                        </div>
                        <div class="ml-3 opacity-20"><i class="fab fa-bitcoin text-5xl md:text-6xl"></i></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 md:mb-6">
                ${renderIndexCard('^GSPC', 'S&P 500', 'GSPC', 'blue', 'fa-chart-line')}
                ${renderIndexCard('^DJI', 'é“ç“Šå·¥æ¥­', 'DJI', 'green', 'fa-industry')}
                ${renderIndexCard('^IXIC', 'ç´æ–¯é”å…‹', 'IXIC', 'purple', 'fa-microchip')}
                ${renderIndexCard('^TWII', 'å°è‚¡åŠ æ¬Š', 'TWII', 'red', 'fa-landmark')}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                ${renderGauge('stock', 'ç¾è‚¡ææ‡¼è²ªå©ªæŒ‡æ•¸', 'fas fa-flag-usa', 'blue')}
                ${renderGauge('crypto', 'å¹£åœˆææ‡¼è²ªå©ªæŒ‡æ•¸', 'fab fa-bitcoin', 'orange')}
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-700">è¿½è¹¤æ¸…å–®</h3>
                    <a href="#" onclick="showSection('watchlist')" class="text-blue-600 text-sm hover:underline">æŸ¥çœ‹å…¨éƒ¨</a>
                </div>
                <div id="dashboardWatchlist"><p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p></div>
            </div>`,

        search: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">è‚¡ç¥¨æŸ¥è©¢</h2>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4 md:mb-6">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="searchSymbol" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ˆå¦‚ AAPLã€2330ï¼‰" class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-base" onkeypress="if(event.key==='Enter')searchStock()">
                    <button onclick="searchStock()" class="brand-orange text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center touch-target"><i class="fas fa-search mr-2"></i><span>æŸ¥è©¢</span></button>
                </div>
                <p class="text-gray-500 text-xs md:text-sm mt-2">æ”¯æ´ç¾è‚¡ã€å°è‚¡ (è¼¸å…¥ç´”æ•¸å­—å¦‚ 2330) åŠåŠ å¯†è²¨å¹£ (BTC, ETH)</p>
            </div>
            <div id="searchResult" class="hidden"></div>`,

        watchlist: `<div class="flex items-center justify-between mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">è¿½è¹¤æ¸…å–®</h2>
                <div class="flex items-center gap-2">
                    <div class="relative">
                        <button onclick="toggleWatchlistMenu()" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-lg border hover:bg-gray-50" title="åŒ¯å‡ºåŒ¯å…¥"><i class="fas fa-exchange-alt"></i></button>
                        <div id="watchlistMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50">
                            <button onclick="exportWatchlist('json')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center"><i class="fas fa-download mr-2 text-blue-500"></i>åŒ¯å‡º JSON</button>
                            <button onclick="exportWatchlist('csv')" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center"><i class="fas fa-file-csv mr-2 text-green-500"></i>åŒ¯å‡º CSV</button>
                            <hr class="my-1">
                            <button onclick="showImportWatchlistModal()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-gray-700 flex items-center"><i class="fas fa-upload mr-2 text-orange-500"></i>åŒ¯å…¥æ¸…å–®</button>
                        </div>
                    </div>
                    <button onclick="showAddWatchlistModal()" class="brand-orange text-white px-4 py-2 rounded-lg font-medium flex items-center touch-target"><i class="fas fa-plus mr-2"></i><span class="hidden sm:inline">æ–°å¢</span></button>
                </div>
            </div>
            <div id="watchlistContent"><p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p></div>`,

        sentiment: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">ææ‡¼è²ªå©ªæŒ‡æ•¸</h2>
            <div id="sentimentContent"><p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p></div>`,

        compare: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">èµ°å‹¢æ¯”è¼ƒ</h2>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-plus-circle mr-2 text-blue-500"></i>é¸æ“‡æ¯”è¼ƒæ¨™çš„</h3>
                <p class="text-gray-500 text-sm mb-4">è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæˆ–æŒ‡æ•¸ï¼ˆæœ€å¤š 5 å€‹ï¼‰ï¼Œä»¥é€—è™Ÿåˆ†éš”</p>
                <div class="mb-4"><span class="text-sm text-gray-600 mr-2">å¿«é€Ÿé¸æ“‡ï¼š</span>
                    <button onclick="addCompareSymbol('^GSPC')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">S&P 500</button>
                    <button onclick="addCompareSymbol('^DJI')" class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded mr-1 mb-1">é“ç“Š</button>
                    <button onclick="addCompareSymbol('AAPL')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">AAPL</button>
                    <button onclick="addCompareSymbol('MSFT')" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded mr-1 mb-1">MSFT</button>
                    <button onclick="addCompareSymbol('2330.TW')" class="px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded mr-1 mb-1">å°ç©é›»</button>
                    <button onclick="addCompareSymbol('BTC-USD')" class="px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded mr-1 mb-1">BTC</button>
                </div>
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="compareSymbols" placeholder="ä¾‹: AAPL, MSFT, ^GSPC" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="compareDays" class="px-4 py-2 border rounded-lg bg-white">
                        <option value="30">1 å€‹æœˆ</option><option value="90" selected>3 å€‹æœˆ</option><option value="180">6 å€‹æœˆ</option><option value="365">1 å¹´</option>
                    </select>
                    <button onclick="loadCompareChart()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"><i class="fas fa-chart-line mr-2"></i>æ¯”è¼ƒ</button>
                </div>
                <div id="selectedSymbols" class="flex flex-wrap gap-2 mt-3"></div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <div id="compareChartContainer" class="hidden">
                    <div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-gray-700"><i class="fas fa-chart-line mr-2 text-green-500"></i>èµ°å‹¢æ¯”è¼ƒåœ–</h3><span class="text-sm text-gray-500">èµ·å§‹æ—¥ = 100%</span></div>
                    <div class="relative" style="height: 400px;"><canvas id="compareChart"></canvas></div>
                </div>
                <div id="compareChartPlaceholder" class="text-center py-12"><i class="fas fa-chart-line text-gray-300 text-5xl mb-4"></i><p class="text-gray-500">é¸æ“‡æ¨™çš„å¾Œé¡¯ç¤ºæ¯”è¼ƒåœ–è¡¨</p></div>
                <div id="compareChartLoading" class="hidden text-center py-12"><i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-4"></i><p class="text-gray-500">è¼‰å…¥ä¸­...</p></div>
            </div>
            <div id="compareResultTable" class="bg-white rounded-xl shadow p-4 md:p-6 hidden">
                <h3 class="font-semibold text-gray-700 mb-4"><i class="fas fa-table mr-2 text-purple-500"></i>æ¯”è¼ƒçµæœ</h3>
                <div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b"><th class="text-left py-2 px-3">æ¨™çš„</th><th class="text-right py-2 px-3">èµ·å§‹åƒ¹</th><th class="text-right py-2 px-3">æœ€æ–°åƒ¹</th><th class="text-right py-2 px-3">æ¼²è·Œå¹…</th></tr></thead><tbody id="compareTableBody"></tbody></table></div>
            </div>`,

        portfolio: `<div class="flex items-center justify-between mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">å€‹äººæŠ•è³‡è¨˜éŒ„</h2>
                <div class="flex gap-2">
                    <button onclick="showExportMenu()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm"><i class="fas fa-download mr-1"></i>åŒ¯å‡º</button>
                    <button onclick="showImportPortfolioModal()" class="px-3 py-2 bg-orange-100 text-orange-600 rounded-lg hover:bg-orange-200 text-sm"><i class="fas fa-upload mr-1"></i>åŒ¯å…¥</button>
                </div>
            </div>
            <div class="flex gap-2 mb-4 border-b">
                <button onclick="switchPortfolioMarket('tw')" id="portfolioTabTw" class="px-4 py-2 border-b-2 border-red-500 text-red-600 font-medium"><i class="fas fa-landmark mr-1"></i>å°è‚¡</button>
                <button onclick="switchPortfolioMarket('us')" id="portfolioTabUs" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"><i class="fas fa-flag-usa mr-1"></i>ç¾è‚¡</button>
            </div>
            <div id="portfolioTwSection">
                <button onclick="showTwModal()" class="w-full mb-4 py-3 border-2 border-dashed border-red-300 text-red-500 rounded-xl hover:bg-red-50"><i class="fas fa-plus mr-2"></i>æ–°å¢å°è‚¡äº¤æ˜“</button>
                <div class="bg-white rounded-xl shadow p-4 mb-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-chart-pie mr-2 text-red-500"></i>å°è‚¡æŒè‚¡ç¸½è¦½</h3><div id="twHoldingsSummary" class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</div></div>
                <div class="bg-white rounded-xl shadow p-4 mb-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between"><span><i class="fas fa-list mr-2 text-red-500"></i>æŒè‚¡æ˜ç´°</span><span class="text-sm text-gray-400" id="twHoldingsCount">0 æª”</span></h3><div id="twHoldingsList" class="space-y-3"><p class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</p></div></div>
                <div class="bg-white rounded-xl shadow p-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between"><span><i class="fas fa-history mr-2 text-red-500"></i>äº¤æ˜“ç´€éŒ„</span><span class="text-sm text-gray-400" id="twTxCount">0 ç­†</span></h3><div id="twTransactionList" class="space-y-2 max-h-96 overflow-y-auto"><p class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</p></div></div>
            </div>
            <div id="portfolioUsSection" class="hidden">
                <button onclick="showUsModal()" class="w-full mb-4 py-3 border-2 border-dashed border-blue-300 text-blue-500 rounded-xl hover:bg-blue-50"><i class="fas fa-plus mr-2"></i>æ–°å¢ç¾è‚¡äº¤æ˜“</button>
                <div class="bg-white rounded-xl shadow p-4 mb-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-chart-pie mr-2 text-blue-500"></i>ç¾è‚¡æŒè‚¡ç¸½è¦½</h3><div id="usHoldingsSummary" class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</div></div>
                <div class="bg-white rounded-xl shadow p-4 mb-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between"><span><i class="fas fa-list mr-2 text-blue-500"></i>æŒè‚¡æ˜ç´°</span><span class="text-sm text-gray-400" id="usHoldingsCount">0 æª”</span></h3><div id="usHoldingsList" class="space-y-3"><p class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</p></div></div>
                <div class="bg-white rounded-xl shadow p-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between"><span><i class="fas fa-history mr-2 text-blue-500"></i>äº¤æ˜“ç´€éŒ„</span><span class="text-sm text-gray-400" id="usTxCount">0 ç­†</span></h3><div id="usTransactionList" class="space-y-2 max-h-96 overflow-y-auto"><p class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</p></div></div>
            </div>`,

        subscription: `<div class="flex items-center justify-between mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">ğŸ“¡ è¨‚é–±ç²¾é¸</h2>
                <button onclick="refreshSubscriptionPicks()" class="text-gray-500 hover:text-gray-700 p-2" title="é‡æ–°æ•´ç†"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div id="subscriptionSourcesCard" class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-rss mr-2 text-orange-500"></i>è¨‚é–±ä¾†æº</h3>
                <div id="subscriptionSourcesList"><p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p></div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center justify-between"><span><i class="fas fa-fire mr-2 text-red-500"></i>ç²¾é¸è‚¡ç¥¨</span><span id="subscriptionPicksCount" class="text-sm text-gray-400"></span></h3>
                <div id="subscriptionPicksList"><p class="text-gray-500 text-center py-4">è¼‰å…¥ä¸­...</p></div>
            </div>`,

        settings: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">è¨­å®š</h2>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-magic mr-2 text-purple-500"></i>å¿«é€Ÿå¥—ç”¨æ¨¡æ¿</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="templateButtons">
                    <button onclick="applyTemplate('minimal')" data-template="minimal" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50"><i class="fas fa-minus-circle text-gray-400 mr-1"></i>æ¥µç°¡</button>
                    <button onclick="applyTemplate('standard')" data-template="standard" class="template-btn px-3 py-2 border rounded-lg text-sm border-blue-500 bg-blue-50 text-blue-600"><i class="fas fa-check-circle text-blue-500 mr-1"></i>æ¨™æº–</button>
                    <button onclick="applyTemplate('full')" data-template="full" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50"><i class="fas fa-layer-group text-green-500 mr-1"></i>å®Œæ•´</button>
                    <button onclick="applyTemplate('short_term')" data-template="short_term" class="template-btn px-3 py-2 border rounded-lg text-sm hover:bg-gray-50"><i class="fas fa-bolt text-yellow-500 mr-1"></i>çŸ­ç·š</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-chart-line mr-2 text-blue-500"></i>æŒ‡æ¨™é¡¯ç¤ºè¨­å®š</h3>
                <p class="text-gray-500 text-sm mb-4">é¸æ“‡åœ¨è‚¡ç¥¨åˆ†æä¸­è¦é¡¯ç¤ºçš„æŠ€è¡“æŒ‡æ¨™</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="indicatorToggles"></div>
                <button onclick="saveIndicatorSettings()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-save mr-2"></i>å„²å­˜æŒ‡æ¨™è¨­å®š</button>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-700 flex items-center"><i class="fas fa-tags mr-2 text-indigo-500"></i>æ¨™ç±¤ç®¡ç†</h3>
                    <button onclick="showTagEditModal()" class="px-3 py-1 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600"><i class="fas fa-plus mr-1"></i>æ–°å¢</button>
                </div>
                <div id="tagManageList" class="space-y-2"><p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p></div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-user-circle mr-2 text-gray-500"></i>å¸³æˆ¶è³‡è¨Š</h3>
                <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                    <img id="settingsAvatar" class="w-16 h-16 rounded-full mr-4" src="" alt="">
                    <div><p class="font-medium text-gray-800" id="settingsUserName">-</p><p class="text-sm text-gray-500">LINE å¸³è™Ÿç™»å…¥</p><p class="text-xs text-gray-400 mt-1">ID: <span id="settingsUserId">-</span></p></div>
                </div>
                <button onclick="logout()" class="mt-4 w-full py-3 border border-red-300 text-red-500 rounded-lg hover:bg-red-50"><i class="fas fa-sign-out-alt mr-2"></i>ç™»å‡º</button>
            </div>`,

        cagr: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">å ±é…¬ç‡æ¯”è¼ƒ</h2>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div><label class="block text-gray-700 mb-2 text-sm">è‚¡ç¥¨ä»£ç¢¼ (æœ€å¤š5å€‹)</label><input type="text" id="cagrSymbols" placeholder="å¦‚: AAPL,MSFT,GOOGL" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"><p class="text-xs text-gray-400 mt-1">ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹ä»£ç¢¼</p></div>
                    <div><label class="block text-gray-700 mb-2 text-sm">èµ·å§‹æ—¥æœŸ</label><input type="date" id="cagrStartDate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"></div>
                    <div><label class="block text-gray-700 mb-2 text-sm">çµæŸæ—¥æœŸ</label><input type="date" id="cagrEndDate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="calculateCAGR()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="fas fa-calculator mr-2"></i>è¨ˆç®—å ±é…¬ç‡</button>
                    <button onclick="clearCAGR()" class="px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50"><i class="fas fa-eraser mr-2"></i>æ¸…é™¤</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-bolt mr-2 text-yellow-500"></i>å¿«é€Ÿç¯„ä¾‹</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setCAGRExample('AAPL,MSFT,GOOGL', 5)" class="px-3 py-1.5 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200">ç§‘æŠ€ä¸‰å·¨é ­ (5å¹´)</button>
                    <button onclick="setCAGRExample('SPY,QQQ,VTI', 10)" class="px-3 py-1.5 bg-green-100 text-green-600 rounded-lg text-sm hover:bg-green-200">å¤§ç›¤ETF (10å¹´)</button>
                    <button onclick="setCAGRExample('2330.TW,2317.TW,2454.TW', 5)" class="px-3 py-1.5 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">å°ç£æ¬Šå€¼è‚¡ (5å¹´)</button>
                </div>
            </div>
            <div id="cagrResults" class="hidden">
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4"><h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-trophy mr-2 text-green-500"></i>å ±é…¬ç‡æ’å</h3><div id="cagrRankingList" class="space-y-3"></div></div>
                <div class="bg-white rounded-xl shadow p-4 md:p-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-chart-line mr-2 text-blue-500"></i>ç´¯ç©å ±é…¬èµ°å‹¢</h3><div class="h-80"><canvas id="cagrChart"></canvas></div></div>
            </div>`,

        admin: `<h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6"><i class="fas fa-user-shield mr-2 text-orange-500"></i>ç®¡ç†å¾Œå°</h2>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-server mr-2 text-green-500"></i>ç³»çµ±ç‹€æ…‹</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-2xl font-bold text-blue-600" id="adminUserCount">-</p><p class="text-xs text-gray-500">è¨»å†Šç”¨æˆ¶</p></div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-2xl font-bold text-green-600" id="adminWatchlistCount">-</p><p class="text-xs text-gray-500">è¿½è¹¤é …ç›®</p></div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-2xl font-bold text-purple-600" id="adminCacheCount">-</p><p class="text-xs text-gray-500">å¿«å–é …ç›®</p></div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-2xl font-bold text-orange-600" id="adminTxCount">-</p><p class="text-xs text-gray-500">äº¤æ˜“ç´€éŒ„</p></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-database mr-2 text-blue-500"></i>å¿«å–ç®¡ç†</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="adminUpdateAllPrices()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-sync mr-2"></i>æ›´æ–°æ‰€æœ‰åƒ¹æ ¼</button>
                    <button onclick="adminClearOldCache()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"><i class="fas fa-broom mr-2"></i>æ¸…ç†éæœŸå¿«å–</button>
                </div>
                <div id="adminCacheStatus" class="mt-3 text-sm text-gray-500"></div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 md:p-6">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-users mr-2 text-indigo-500"></i>ç”¨æˆ¶åˆ—è¡¨</h3>
                <div id="adminUserList" class="space-y-2 max-h-96 overflow-y-auto"><p class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</p></div>
            </div>`
    };

    // Section è¼‰å…¥é‚è¼¯
    const loadedSections = new Set();

    function loadSectionContent(sectionId) {
        const el = document.getElementById('section-' + sectionId);
        if (!el || loadedSections.has(sectionId)) return;
        if (SECTION_TEMPLATES[sectionId]) {
            el.innerHTML = SECTION_TEMPLATES[sectionId];
            loadedSections.add(sectionId);
            console.log('âœ… Section loaded:', sectionId);
        }
    }

    // æ””æˆª showSection
    const origShow = window.showSection;
    window.showSection = function(id, e) {
        loadSectionContent(id);
        if (typeof origShow === 'function') origShow(id, e);
    };

    window.loadSectionContent = loadSectionContent;
    window.preloadAllSections = function() { Object.keys(SECTION_TEMPLATES).forEach(loadSectionContent); };

    // è‡ªå‹•è¼‰å…¥ dashboard
    document.addEventListener('DOMContentLoaded', function() { loadSectionContent('dashboard'); });
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/settings.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * è¨­å®šæ¨¡çµ„
 * åŒ…å«ï¼šæŒ‡æ¨™è¨­å®šã€é€šçŸ¥è¨­å®šã€åƒæ•¸èª¿æ•´
 * 
 * ğŸ”§ ä¿®å¾©ç‰ˆ - æ–°å¢æ¨™ç±¤ç®¡ç†è¼‰å…¥
 */

(function() {
    'use strict';
    
    // ============================================================
    // æ¨¡æ¿å®šç¾©
    // ============================================================
    
    const TEMPLATES = {
        minimal: {
            indicators: { ma: true, rsi: false, macd: false, kd: false, bollinger: false, obv: false, volume: false },
            alerts: { ma_cross: true, ma_breakout: false, rsi: false, macd: false, kd: false, bollinger: false, volume: false, sentiment: false }
        },
        standard: {
            indicators: { ma: true, rsi: true, macd: true, kd: false, bollinger: true, obv: false, volume: true },
            alerts: { ma_cross: true, ma_breakout: true, rsi: true, macd: true, kd: false, bollinger: false, volume: false, sentiment: true }
        },
        full: {
            indicators: { ma: true, rsi: true, macd: true, kd: true, bollinger: true, obv: true, volume: true },
            alerts: { ma_cross: true, ma_breakout: true, rsi: true, macd: true, kd: true, bollinger: true, volume: true, sentiment: true }
        },
        short_term: {
            indicators: { ma: true, rsi: true, macd: true, kd: true, bollinger: true, obv: false, volume: true },
            alerts: { ma_cross: true, ma_breakout: true, rsi: true, macd: true, kd: true, bollinger: true, volume: true, sentiment: false }
        }
    };
    
    // ============================================================
    // æŒ‡æ¨™è¨­å®š
    // ============================================================
    
    function loadSettings() {
        // è¼‰å…¥æŒ‡æ¨™è¨­å®š
        const indicators = storage.get('indicatorSettings', {
            ma: true, rsi: true, macd: true, kd: false, 
            bollinger: true, obv: false, volume: true
        });
        
        Object.entries(indicators).forEach(([key, val]) => {
            const el = document.getElementById(`show_${key}`);
            if (el) el.checked = val;
        });
        
        // è¼‰å…¥é€šçŸ¥è¨­å®š
        const alerts = storage.get('alertSettings', {
            ma_cross: true, ma_breakout: true, rsi: true, macd: true,
            kd: false, bollinger: false, volume: false, sentiment: true
        });
        
        Object.entries(alerts).forEach(([key, val]) => {
            const el = document.getElementById(`alert_${key}`);
            if (el) el.checked = val;
        });
        
        // è¼‰å…¥åƒæ•¸è¨­å®š
        const params = storage.get('paramSettings', {
            ma_short: 20, ma_mid: 50, ma_long: 200,
            rsi_period: 14, rsi_overbought: 70, rsi_oversold: 30,
            macd_fast: 12, macd_slow: 26, macd_signal: 9,
            kd_period: 9, bollinger_period: 20, breakout_threshold: 2.0
        });
        
        Object.entries(params).forEach(([key, val]) => {
            const el = document.getElementById(key);
            if (el) el.value = val;
        });
        
        // æ›´æ–°æ¨¡æ¿æŒ‰éˆ•ç‹€æ…‹
        updateTemplateButtons();
        
        // ============================================================
        // ğŸ†• è¼‰å…¥æ¨™ç±¤ç®¡ç†
        // ============================================================
        if (typeof loadTags === 'function' && typeof renderTagManager === 'function') {
            loadTags().then(() => {
                renderTagManager();
            });
        }
    }
    
    function saveIndicatorSettings() {
        const indicators = {};
        ['ma', 'rsi', 'macd', 'kd', 'bollinger', 'obv', 'volume'].forEach(key => {
            const el = document.getElementById(`show_${key}`);
            if (el) indicators[key] = el.checked;
        });
        
        storage.set('indicatorSettings', indicators);
        showToast('æŒ‡æ¨™è¨­å®šå·²å„²å­˜');
        updateTemplateButtons();
    }
    
    function saveAlertSettings() {
        const alerts = {};
        ['ma_cross', 'ma_breakout', 'rsi', 'macd', 'kd', 'bollinger', 'volume', 'sentiment'].forEach(key => {
            const el = document.getElementById(`alert_${key}`);
            if (el) alerts[key] = el.checked;
        });
        
        storage.set('alertSettings', alerts);
        showToast('é€šçŸ¥è¨­å®šå·²å„²å­˜');
        updateTemplateButtons();
    }
    
    function saveParamSettings() {
        const params = {};
        const keys = [
            'ma_short', 'ma_mid', 'ma_long',
            'rsi_period', 'rsi_overbought', 'rsi_oversold',
            'macd_fast', 'macd_slow', 'macd_signal',
            'kd_period', 'bollinger_period', 'breakout_threshold'
        ];
        
        keys.forEach(key => {
            const el = document.getElementById(key);
            if (el) params[key] = parseFloat(el.value) || 0;
        });
        
        storage.set('paramSettings', params);
        showToast('åƒæ•¸è¨­å®šå·²å„²å­˜');
    }
    
    // ============================================================
    // æ¨¡æ¿åŠŸèƒ½
    // ============================================================
    
    function applyTemplate(name) {
        const template = TEMPLATES[name];
        if (!template) return;
        
        // å¥—ç”¨æŒ‡æ¨™è¨­å®š
        Object.entries(template.indicators).forEach(([key, val]) => {
            const el = document.getElementById(`show_${key}`);
            if (el) el.checked = val;
        });
        
        // å¥—ç”¨é€šçŸ¥è¨­å®š
        Object.entries(template.alerts).forEach(([key, val]) => {
            const el = document.getElementById(`alert_${key}`);
            if (el) el.checked = val;
        });
        
        // å„²å­˜è¨­å®š
        storage.set('indicatorSettings', template.indicators);
        storage.set('alertSettings', template.alerts);
        
        showToast(`å·²å¥—ç”¨ã€Œ${getTemplateName(name)}ã€æ¨¡æ¿`);
        updateTemplateButtons();
    }
    
    function getTemplateName(name) {
        const names = {
            minimal: 'æ¥µç°¡',
            standard: 'æ¨™æº–',
            full: 'å®Œæ•´',
            short_term: 'çŸ­ç·š'
        };
        return names[name] || name;
    }
    
    function updateTemplateButtons() {
        const currentIndicators = {};
        ['ma', 'rsi', 'macd', 'kd', 'bollinger', 'obv', 'volume'].forEach(key => {
            const el = document.getElementById(`show_${key}`);
            if (el) currentIndicators[key] = el.checked;
        });
        
        const currentAlerts = {};
        ['ma_cross', 'ma_breakout', 'rsi', 'macd', 'kd', 'bollinger', 'volume', 'sentiment'].forEach(key => {
            const el = document.getElementById(`alert_${key}`);
            if (el) currentAlerts[key] = el.checked;
        });
        
        // æª¢æŸ¥åŒ¹é…çš„æ¨¡æ¿
        document.querySelectorAll('.template-btn').forEach(btn => {
            const templateName = btn.dataset.template;
            const template = TEMPLATES[templateName];
            
            if (!template) return;
            
            const indicatorsMatch = Object.entries(template.indicators).every(
                ([k, v]) => currentIndicators[k] === v
            );
            const alertsMatch = Object.entries(template.alerts).every(
                ([k, v]) => currentAlerts[k] === v
            );
            
            if (indicatorsMatch && alertsMatch) {
                btn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
                btn.classList.remove('border-gray-300');
            } else {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                btn.classList.add('border-gray-300');
            }
        });
    }
    
    // ============================================================
    // åŒ¯ç‡è¨­å®š
    // ============================================================
    
    async function updateExchangeRate() {
        const input = document.getElementById('manualExchangeRate');
        const rate = parseFloat(input?.value);
        
        if (!rate || rate <= 0) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡');
            return;
        }
        
        try {
            const res = await apiRequest('/api/portfolio/exchange-rate', {
                method: 'PUT',
                body: { rate }
            });
            
            const data = await res.json();
            
            if (data.success) {
                showToast('åŒ¯ç‡å·²æ›´æ–°');
                if (typeof loadPortfolioSummary === 'function') {
                    loadPortfolioSummary();
                }
            } else {
                showToast(data.detail || 'æ›´æ–°å¤±æ•—');
            }
        } catch (e) {
            console.error('æ›´æ–°åŒ¯ç‡å¤±æ•—:', e);
            showToast('æ›´æ–°å¤±æ•—');
        }
    }
    
    // ============================================================
    // ğŸ†• ç®¡ç†å“¡å·¥å…·
    // ============================================================
    
    async function adminUpdatePriceCache() {
        const btn = event?.target?.closest('button');
        if (btn) btn.disabled = true;
        showToast('æ­£åœ¨æ›´æ–°åƒ¹æ ¼å¿«å–...');
        
        try {
            const res = await apiRequest('/api/admin/update-price-cache', { method: 'POST' });
            const data = await res.json();
            
            if (data.success) {
                showToast(`åƒ¹æ ¼å¿«å–å·²æ›´æ–°ï¼š${data.total_updated || 0} ç­†`);
            } else {
                showToast(data.detail || 'æ›´æ–°å¤±æ•—');
            }
        } catch (e) {
            console.error('æ›´æ–°åƒ¹æ ¼å¿«å–å¤±æ•—:', e);
            showToast('æ›´æ–°å¤±æ•—');
        } finally {
            if (btn) btn.disabled = false;
        }
    }
    
    async function adminUpdateExchangeRate() {
        const btn = event?.target?.closest('button');
        if (btn) btn.disabled = true;
        showToast('æ­£åœ¨æ›´æ–°åŒ¯ç‡...');
        
        try {
            const res = await apiRequest('/api/admin/update-exchange-rate', { method: 'POST' });
            const data = await res.json();
            
            if (data.success) {
                showToast(`åŒ¯ç‡å·²æ›´æ–°ï¼š${data.rate || ''}`);
            } else {
                showToast(data.detail || 'æ›´æ–°å¤±æ•—');
            }
        } catch (e) {
            console.error('æ›´æ–°åŒ¯ç‡å¤±æ•—:', e);
            showToast('æ›´æ–°å¤±æ•—');
        } finally {
            if (btn) btn.disabled = false;
        }
    }
    
    async function adminFetchSubscriptions() {
        const btn = event?.target?.closest('button');
        if (btn) btn.disabled = true;
        showToast('æ­£åœ¨æŠ“å–è¨‚é–±å…§å®¹ï¼ˆå›æº¯ 30 å¤©ï¼‰...');
        
        try {
            const res = await apiRequest('/api/subscription/admin/fetch?backfill=true', { method: 'POST' });
            const data = await res.json();
            
            if (data.success) {
                const result = data.data || {};
                showToast(`æŠ“å–å®Œæˆï¼šæ–°å¢ ${result.total_new || 0}ï¼Œæ›´æ–° ${result.total_updated || 0}`);
                if (typeof loadSubscriptionPicks === 'function') {
                    loadSubscriptionPicks();
                }
            } else {
                showToast(data.detail || 'æŠ“å–å¤±æ•—');
            }
        } catch (e) {
            console.error('æŠ“å–è¨‚é–±å¤±æ•—:', e);
            showToast('æŠ“å–å¤±æ•—');
        } finally {
            if (btn) btn.disabled = false;
        }
    }
    
    // ============================================================
    // å°å‡ºåˆ°å…¨åŸŸ
    // ============================================================
    
    window.loadSettings = loadSettings;
    window.saveIndicatorSettings = saveIndicatorSettings;
    window.saveAlertSettings = saveAlertSettings;
    window.saveParamSettings = saveParamSettings;
    window.applyTemplate = applyTemplate;
    window.updateExchangeRate = updateExchangeRate;
    window.adminUpdatePriceCache = adminUpdatePriceCache;
    window.adminUpdateExchangeRate = adminUpdateExchangeRate;
    window.adminFetchSubscriptions = adminFetchSubscriptions;
    
    console.log('âš™ï¸ settings.js æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/state.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * SELA ç‹€æ…‹ç®¡ç†æ¨¡çµ„ (P1)
 * 
 * åŠŸèƒ½ï¼š
 * 1. é›†ä¸­ç®¡ç†æ‡‰ç”¨ç‹€æ…‹
 * 2. ç‹€æ…‹è®ŠåŒ–äº‹ä»¶é€šçŸ¥
 * 3. è·¨æ¨¡çµ„è³‡æ–™åŒæ­¥
 * 
 * è¼‰å…¥é †åºï¼šutils.js â†’ core.js â†’ state.js â†’ å…¶ä»–æ¨¡çµ„
 */

(function() {
    'use strict';

    // ============================================================
    // ç‹€æ…‹ç®¡ç†æ ¸å¿ƒ
    // ============================================================

    const AppState = {
        // ----- ç”¨æˆ¶ç‹€æ…‹ -----
        user: null,
        isAdmin: false,
        
        // ----- å°èˆªç‹€æ…‹ -----
        currentSection: 'dashboard',
        previousSection: null,
        
        // ----- è‚¡ç¥¨ç›¸é—œ -----
        currentStock: null,        // ç›®å‰æŸ¥çœ‹çš„è‚¡ç¥¨
        searchHistory: [],         // æœå°‹æ­·å² (æœ€å¤š 10 ç­†)
        
        // ----- è¿½è¹¤æ¸…å–® -----
        watchlist: [],             // è¿½è¹¤æ¸…å–®
        watchlistLoaded: false,    // æ˜¯å¦å·²è¼‰å…¥
        
        // ----- æŒè‚¡ -----
        portfolio: {
            tw: [],                // å°è‚¡æŒè‚¡
            us: [],                // ç¾è‚¡æŒè‚¡
            summary: null          // ç¸½è¦½
        },
        portfolioLoaded: false,
        
        // ----- æ¨™ç±¤ -----
        tags: [],
        tagsLoaded: false,
        
        // ----- å¸‚å ´è³‡æ–™ -----
        indices: {},               // æŒ‡æ•¸è³‡æ–™
        sentiment: null,           // å¸‚å ´æƒ…ç·’
        btcPrice: null,            // BTC åƒ¹æ ¼
        
        // ----- UI ç‹€æ…‹ -----
        isMobileSidebarOpen: false,
        activeModal: null,
        isLoading: false,
        
        // ----- äº‹ä»¶ç³»çµ± -----
        _listeners: new Map(),
        
        /**
         * è¨­ç½®ç‹€æ…‹ä¸¦è§¸ç™¼äº‹ä»¶
         * @param {string} key - ç‹€æ…‹éµ
         * @param {any} value - æ–°å€¼
         */
        set(key, value) {
            const oldValue = this[key];
            this[key] = value;
            this._emit(key, value, oldValue);
            
            // Debug æ¨¡å¼
            if (window.SELA_DEBUG) {
                console.log(`ğŸ“Š State: ${key}`, oldValue, 'â†’', value);
            }
        },
        
        /**
         * æ‰¹é‡è¨­ç½®ç‹€æ…‹
         * @param {Object} updates - {key: value, ...}
         */
        setMultiple(updates) {
            Object.entries(updates).forEach(([key, value]) => {
                this.set(key, value);
            });
        },
        
        /**
         * ç›£è½ç‹€æ…‹è®ŠåŒ–
         * @param {string} key - ç‹€æ…‹éµ
         * @param {Function} callback - (newValue, oldValue) => void
         * @returns {Function} å–æ¶ˆç›£è½çš„å‡½æ•¸
         */
        on(key, callback) {
            if (!this._listeners.has(key)) {
                this._listeners.set(key, new Set());
            }
            this._listeners.get(key).add(callback);
            
            // è¿”å›å–æ¶ˆç›£è½å‡½æ•¸
            return () => {
                this._listeners.get(key)?.delete(callback);
            };
        },
        
        /**
         * ä¸€æ¬¡æ€§ç›£è½
         */
        once(key, callback) {
            const unsubscribe = this.on(key, (newVal, oldVal) => {
                callback(newVal, oldVal);
                unsubscribe();
            });
            return unsubscribe;
        },
        
        /**
         * è§¸ç™¼äº‹ä»¶
         */
        _emit(key, newValue, oldValue) {
            const listeners = this._listeners.get(key);
            if (listeners) {
                listeners.forEach(cb => {
                    try {
                        cb(newValue, oldValue);
                    } catch (e) {
                        console.error(`State listener error for ${key}:`, e);
                    }
                });
            }
            
            // ä¹Ÿè§¸ç™¼é€šç”¨çš„ '*' ç›£è½å™¨
            const globalListeners = this._listeners.get('*');
            if (globalListeners) {
                globalListeners.forEach(cb => {
                    try {
                        cb(key, newValue, oldValue);
                    } catch (e) {
                        console.error('Global state listener error:', e);
                    }
                });
            }
        },
        
        /**
         * å–æ¶ˆæ‰€æœ‰ç›£è½
         */
        offAll(key) {
            if (key) {
                this._listeners.delete(key);
            } else {
                this._listeners.clear();
            }
        },
        
        // ============================================================
        // ä¾¿æ·æ–¹æ³•
        // ============================================================
        
        /**
         * è¨­ç½®ç•¶å‰ç”¨æˆ¶
         */
        setUser(user) {
            this.set('user', user);
            this.set('isAdmin', user?.is_admin || false);
        },
        
        /**
         * åˆ‡æ› Section
         */
        switchSection(name) {
            this.set('previousSection', this.currentSection);
            this.set('currentSection', name);
        },
        
        /**
         * è¨­ç½®ç•¶å‰è‚¡ç¥¨
         */
        setCurrentStock(stock) {
            this.set('currentStock', stock);
            
            // åŠ å…¥æœå°‹æ­·å²
            if (stock?.symbol) {
                const history = this.searchHistory.filter(s => s !== stock.symbol);
                history.unshift(stock.symbol);
                this.set('searchHistory', history.slice(0, 10));
                
                // æŒä¹…åŒ–æœå°‹æ­·å²
                try {
                    localStorage.setItem('searchHistory', JSON.stringify(this.searchHistory));
                } catch (e) {}
            }
        },
        
        /**
         * æ›´æ–°è¿½è¹¤æ¸…å–®
         */
        setWatchlist(list) {
            this.set('watchlist', list);
            this.set('watchlistLoaded', true);
        },
        
        /**
         * æ–°å¢åˆ°è¿½è¹¤æ¸…å–® (æ¨‚è§€æ›´æ–°)
         */
        addToWatchlist(item) {
            const newList = [...this.watchlist, item];
            this.set('watchlist', newList);
        },
        
        /**
         * å¾è¿½è¹¤æ¸…å–®ç§»é™¤
         */
        removeFromWatchlist(symbol) {
            const newList = this.watchlist.filter(w => w.symbol !== symbol);
            this.set('watchlist', newList);
        },
        
        /**
         * æ›´æ–°æŒè‚¡è³‡æ–™
         */
        setPortfolio(data) {
            this.set('portfolio', { ...this.portfolio, ...data });
            this.set('portfolioLoaded', true);
        },
        
        /**
         * æ›´æ–°æ¨™ç±¤
         */
        setTags(tags) {
            this.set('tags', tags);
            this.set('tagsLoaded', true);
        },
        
        /**
         * æ›´æ–°å¸‚å ´è³‡æ–™
         */
        setMarketData(data) {
            if (data.indices) this.set('indices', data.indices);
            if (data.sentiment) this.set('sentiment', data.sentiment);
            if (data.btcPrice) this.set('btcPrice', data.btcPrice);
        },
        
        /**
         * è¨­ç½®è¼‰å…¥ç‹€æ…‹
         */
        setLoading(isLoading) {
            this.set('isLoading', isLoading);
        },
        
        /**
         * è¨­ç½® Modal ç‹€æ…‹
         */
        setModal(modalId) {
            this.set('activeModal', modalId);
        },
        
        /**
         * é‡ç½®ç‹€æ…‹ (ç™»å‡ºæ™‚)
         */
        reset() {
            this.user = null;
            this.isAdmin = false;
            this.currentStock = null;
            this.watchlist = [];
            this.watchlistLoaded = false;
            this.portfolio = { tw: [], us: [], summary: null };
            this.portfolioLoaded = false;
            this.tags = [];
            this.tagsLoaded = false;
            this._emit('reset', null, null);
        },
        
        /**
         * åˆå§‹åŒ– (å¾ localStorage æ¢å¾©)
         */
        init() {
            // æ¢å¾©æœå°‹æ­·å²
            try {
                const history = localStorage.getItem('searchHistory');
                if (history) {
                    this.searchHistory = JSON.parse(history);
                }
            } catch (e) {}
            
            console.log('ğŸ“Š AppState åˆå§‹åŒ–å®Œæˆ');
        }
    };

    // ============================================================
    // è‡ªå‹•åŒæ­¥ UI (ç¯„ä¾‹)
    // ============================================================

    // ç›£è½ section è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–°å°èˆªé«˜äº®
    AppState.on('currentSection', (newSection) => {
        // æ›´æ–° URL hash (å¯é¸)
        // history.replaceState(null, '', `#${newSection}`);
    });

    // ç›£è½ç”¨æˆ¶è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–° UI
    AppState.on('user', (user) => {
        if (user && typeof updateUserUI === 'function') {
            // updateUserUI å·²åœ¨ core.js ä¸­å®šç¾©
        }
    });

    // ç›£è½è¼‰å…¥ç‹€æ…‹
    AppState.on('isLoading', (isLoading) => {
        // å¯ä»¥åœ¨é€™è£¡é¡¯ç¤º/éš±è—å…¨åŸŸè¼‰å…¥æŒ‡ç¤ºå™¨
    });

    // ============================================================
    // åˆå§‹åŒ–
    // ============================================================

    AppState.init();

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.state = AppState;
    }

    // å…¨åŸŸå°å‡º
    window.AppState = AppState;

    console.log('ğŸ“Š state.js ç‹€æ…‹ç®¡ç†æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/subscription.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * è¨‚é–±ç²¾é¸æ¨¡çµ„
 */

(function() {
    'use strict';
    
    let subscriptionSources = [];
    
    /**
     * è¼‰å…¥è¨‚é–±è³‡æ–™
     */
    async function loadSubscriptionData() {
        const container = document.getElementById('subscriptionSourcesList');
        const picksContainer = document.getElementById('subscriptionPicksList');
        const countEl = document.getElementById('subscriptionPicksCount');
        
        if (!container) return;
        
        try {
            // è¼‰å…¥æ‰€æœ‰è¨‚é–±ä¾†æº
            const sourcesRes = await fetch('/api/subscription/sources');
            const sourcesData = await sourcesRes.json();
            
            if (sourcesData.success) {
                subscriptionSources = sourcesData.data || [];
            }
            
            // è¼‰å…¥ç”¨æˆ¶è¨‚é–±ç‹€æ…‹
            const myRes = await apiRequest('/api/subscription/my');
            const myData = await myRes.json();
            const mySubscriptions = myData.success ? (myData.data || []).map(s => s.source_id) : [];
            
            if (subscriptionSources.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">å°šç„¡è¨‚é–±ä¾†æº</p>';
            } else {
                container.innerHTML = '';
                for (const source of subscriptionSources) {
                    const isSubscribed = mySubscriptions.includes(source.id);
                    container.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex items-center flex-1 min-w-0">
                                <i class="fas fa-rss text-orange-500 mr-3 flex-shrink-0"></i>
                                <div class="min-w-0">
                                    <p class="font-medium text-gray-800 truncate">${source.name}</p>
                                    <p class="text-xs text-gray-500 truncate">${source.description || ''}</p>
                                </div>
                            </div>
                            <button onclick="window.toggleSubscription(${source.id}, ${isSubscribed})" 
                                    class="ml-3 px-3 py-1.5 text-sm rounded-lg flex-shrink-0 ${isSubscribed 
                                        ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                                        : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">
                                <i class="fas fa-${isSubscribed ? 'check' : 'plus'} mr-1"></i>
                                ${isSubscribed ? 'å·²è¨‚é–±' : 'è¨‚é–±'}
                            </button>
                        </div>
                    `;
                }
            }
            
            // è¼‰å…¥ç²¾é¸è‚¡ç¥¨
            await loadSubscriptionPicks();
            
        } catch (e) {
            console.error('è¼‰å…¥è¨‚é–±è³‡æ–™å¤±æ•—:', e);
            container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
        }
    }
    
    /**
     * åˆ‡æ›è¨‚é–±ç‹€æ…‹
     */
    async function toggleSubscription(sourceId, isCurrentlySubscribed) {
        console.log('toggleSubscription è¢«å‘¼å«:', sourceId, isCurrentlySubscribed);
        
        try {
            const endpoint = isCurrentlySubscribed
                ? `/api/subscription/unsubscribe/${sourceId}`
                : `/api/subscription/subscribe/${sourceId}`;
            
            console.log('å‘¼å« API:', endpoint);
            
            const res = await apiRequest(endpoint, { method: 'POST' });
            const data = await res.json();
            
            console.log('API å›æ‡‰:', data);
            
            if (data.success) {
                showToast(isCurrentlySubscribed ? 'å·²å–æ¶ˆè¨‚é–±' : 'å·²è¨‚é–±');
                loadSubscriptionData();
            } else {
                showToast(data.detail || 'æ“ä½œå¤±æ•—');
            }
        } catch (e) {
            console.error('åˆ‡æ›è¨‚é–±å¤±æ•—:', e);
            showToast('æ“ä½œå¤±æ•—: ' + e.message);
        }
    }
    
    /**
     * è¼‰å…¥ç²¾é¸è‚¡ç¥¨
     */
    async function loadSubscriptionPicks() {
        const container = document.getElementById('subscriptionPicksList');
        const countEl = document.getElementById('subscriptionPicksCount');
        
        if (!container) return;
        
        try {
            const res = await apiRequest('/api/subscription/picks');
            const data = await res.json();
            
            console.log('ç²¾é¸è‚¡ç¥¨è³‡æ–™:', data);
            
            if (data.success && data.data && data.data.length > 0) {
                if (countEl) countEl.textContent = `å…± ${data.data.length} æª”`;
                
                container.innerHTML = data.data.map(p => {
                    // ğŸ†• å„ªå…ˆä½¿ç”¨æ–‡ç« ç™¼ä½ˆæ—¥æœŸ article_date
                    let timeStr = '';
                    const dateField = p.article_date || p.mentioned_at || p.first_seen_at;
                    if (dateField) {
                        try {
                            const d = new Date(dateField);
                            if (!isNaN(d.getTime())) {
                                timeStr = d.toLocaleDateString('zh-TW');
                            }
                        } catch (e) {
                            console.warn('æ—¥æœŸè§£æå¤±æ•—:', dateField);
                        }
                    }
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2 cursor-pointer hover:bg-gray-100"
                         onclick="searchSymbol('${p.symbol}')">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <span class="font-bold text-blue-600 text-sm">${p.symbol.substring(0, 2)}</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${p.symbol}</p>
                                <p class="text-xs text-gray-500">${p.source_name || ''}${timeStr ? ' Â· ' + timeStr : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400">æåŠ ${p.mention_count || 1} æ¬¡</span>
                            <button onclick="event.stopPropagation(); quickAddToWatchlist('${p.symbol}', 'stock')" 
                                    class="ml-2 px-2 py-1 text-xs bg-orange-100 text-orange-600 rounded hover:bg-orange-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `}).join('');
            } else {
                if (countEl) countEl.textContent = '';
                container.innerHTML = '<p class="text-gray-400 text-center py-4">å°šç„¡ç²¾é¸è‚¡ç¥¨ï¼Œè«‹å…ˆæ›´æ–°è¨‚é–±</p>';
            }
        } catch (e) {
            console.error('è¼‰å…¥ç²¾é¸è‚¡ç¥¨å¤±æ•—:', e);
            container.innerHTML = '<p class="text-gray-400 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
        }
    }
    
    /**
     * é‡æ–°æ•´ç†
     */
    async function refreshSubscriptionPicks() {
        const btn = event?.target?.closest('button');
        const icon = btn?.querySelector('i');
        if (icon) icon.classList.add('fa-spin');
        
        await loadSubscriptionData();
        
        if (icon) setTimeout(() => icon.classList.remove('fa-spin'), 500);
        showToast('å·²æ›´æ–°');
    }
    
    /**
     * ğŸ†• ç®¡ç†å“¡ï¼šæ‰‹å‹•æŠ“å–è¨‚é–±ï¼ˆå›æº¯ 30 å¤©ï¼‰
     */
    async function adminFetchSubscriptions(backfill = true) {
        const btn = event?.target?.closest('button');
        if (btn) btn.disabled = true;
        
        showToast('æ­£åœ¨æŠ“å–è¨‚é–±å…§å®¹...');
        
        try {
            const res = await apiRequest(`/api/subscription/admin/fetch?backfill=${backfill}`, { 
                method: 'POST' 
            });
            const data = await res.json();
            
            console.log('æŠ“å–çµæœ:', data);
            
            if (data.success) {
                const result = data.data || {};
                showToast(`æŠ“å–å®Œæˆï¼šæ–°å¢ ${result.total_new || 0}ï¼Œæ›´æ–° ${result.total_updated || 0}`);
                await loadSubscriptionPicks();
            } else {
                showToast(data.detail || 'æŠ“å–å¤±æ•—');
            }
        } catch (e) {
            console.error('æŠ“å–è¨‚é–±å¤±æ•—:', e);
            showToast('æŠ“å–å¤±æ•—: ' + e.message);
        } finally {
            if (btn) btn.disabled = false;
        }
    }
    
    // å°å‡ºåˆ°å…¨åŸŸ
    window.loadSubscriptionData = loadSubscriptionData;
    window.loadSubscriptionPicks = loadSubscriptionPicks;
    window.toggleSubscription = toggleSubscription;
    window.refreshSubscriptionPicks = refreshSubscriptionPicks;
    window.adminFetchSubscriptions = adminFetchSubscriptions;
    
    console.log('ğŸ“¡ subscription.js æ¨¡çµ„å·²è¼‰å…¥');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/tags.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * æ¨™ç±¤ç®¡ç†æ¨¡çµ„ (P4 å„ªåŒ–ç‰ˆ)
 * 
 * å„ªåŒ–å…§å®¹ï¼š
 * 1. AppState æ•´åˆ - çµ±ä¸€ç‹€æ…‹ç®¡ç†
 * 2. äº‹ä»¶å§”è¨— - æ¸›å°‘ç›£è½å™¨æ•¸é‡
 * 3. DOM å¿«å– - ä½¿ç”¨ $() å‡½æ•¸
 * 
 * åŒ…å«ï¼šæ¨™ç±¤ CRUDã€è¿½è¹¤é …ç›®æ¨™ç±¤é—œè¯ã€ç¯©é¸åŠŸèƒ½
 */

(function() {
    'use strict';

    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================

    let userTags = [];
    let currentEditTagId = null;
    let currentAssignWatchlistId = null;
    let currentFilterTagId = null;

    // ============================================================
    // æ¨™ç±¤ CRUD
    // ============================================================

    async function loadTags() {
        // âœ… P4: æª¢æŸ¥ AppState å¿«å–
        if (window.AppState && AppState.tagsLoaded && AppState.tags.length > 0) {
            userTags = AppState.tags;
            return userTags;
        }

        try {
            const res = await apiRequest('/api/tags');
            const data = await res.json();
            if (data.success) {
                userTags = data.data || [];

                // âœ… P4: åŒæ­¥åˆ° AppState
                if (window.AppState) {
                    AppState.setTags(userTags);
                }
            }
            return userTags;
        } catch (e) {
            console.error('è¼‰å…¥æ¨™ç±¤å¤±æ•—:', e);
            return [];
        }
    }

    async function createTag(name, color = '#3B82F6', icon = 'fa-tag') {
        try {
            const res = await apiRequest('/api/tags', {
                method: 'POST',
                body: { name, color, icon }
            });
            const data = await res.json();
            if (data.success) {
                showToast('æ¨™ç±¤å·²å»ºç«‹');

                // âœ… P4: æ¨‚è§€æ›´æ–°
                if (data.data) {
                    userTags.push(data.data);
                    if (window.AppState) {
                        AppState.setTags([...userTags]);
                    }
                } else {
                    await loadTags();
                }

                renderTagManager();
                return data.data;
            } else {
                showToast(data.detail || 'å»ºç«‹å¤±æ•—');
                return null;
            }
        } catch (e) {
            console.error('å»ºç«‹æ¨™ç±¤å¤±æ•—:', e);
            showToast('å»ºç«‹å¤±æ•—');
            return null;
        }
    }

    async function updateTag(tagId, updates) {
        try {
            const res = await apiRequest(`/api/tags/${tagId}`, {
                method: 'PUT',
                body: updates
            });
            const data = await res.json();
            if (data.success) {
                showToast('æ¨™ç±¤å·²æ›´æ–°');

                // âœ… P4: æ¨‚è§€æ›´æ–°
                const idx = userTags.findIndex(t => t.id === tagId);
                if (idx !== -1) {
                    userTags[idx] = { ...userTags[idx], ...updates };
                    if (window.AppState) {
                        AppState.setTags([...userTags]);
                    }
                } else {
                    await loadTags();
                }

                renderTagManager();
            } else {
                showToast(data.detail || 'æ›´æ–°å¤±æ•—');
            }
        } catch (e) {
            console.error('æ›´æ–°æ¨™ç±¤å¤±æ•—:', e);
            showToast('æ›´æ–°å¤±æ•—');
        }
    }

    async function deleteTag(tagId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¨™ç±¤å—ï¼Ÿ')) return;
        try {
            const res = await apiRequest(`/api/tags/${tagId}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                showToast('æ¨™ç±¤å·²åˆªé™¤');

                // âœ… P4: æ¨‚è§€æ›´æ–°
                userTags = userTags.filter(t => t.id !== tagId);
                if (window.AppState) {
                    AppState.setTags([...userTags]);
                }

                renderTagManager();
            } else {
                showToast(data.detail || 'åˆªé™¤å¤±æ•—');
            }
        } catch (e) {
            console.error('åˆªé™¤æ¨™ç±¤å¤±æ•—:', e);
            showToast('åˆªé™¤å¤±æ•—');
        }
    }

    async function initDefaultTags() {
        try {
            const res = await apiRequest('/api/tags/init-defaults', { method: 'POST' });
            const data = await res.json();
            showToast(data.message);
            if (data.success) {
                // æ¸…é™¤å¿«å–ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥
                if (window.AppState) {
                    AppState.set('tagsLoaded', false);
                }
                await loadTags();
                renderTagManager();
            }
        } catch (e) {
            console.error('åˆå§‹åŒ–æ¨™ç±¤å¤±æ•—:', e);
            showToast('åˆå§‹åŒ–å¤±æ•—');
        }
    }

    // ============================================================
    // è¿½è¹¤é …ç›®æ¨™ç±¤ç®¡ç†
    // ============================================================

    async function getWatchlistTags(watchlistId) {
        try {
            const res = await apiRequest(`/api/tags/watchlist/${watchlistId}`);
            const data = await res.json();
            return data.success ? data.tags : [];
        } catch (e) {
            console.error('å–å¾—æ¨™ç±¤å¤±æ•—:', e);
            return [];
        }
    }

    async function setWatchlistTags(watchlistId, tagIds) {
        try {
            const res = await apiRequest(`/api/tags/watchlist/${watchlistId}`, {
                method: 'PUT',
                body: { tag_ids: tagIds }
            });
            const data = await res.json();
            if (data.success) {
                showToast('æ¨™ç±¤å·²æ›´æ–°');
                if (typeof loadWatchlist === 'function') loadWatchlist();
            } else {
                showToast(data.detail || 'æ›´æ–°å¤±æ•—');
            }
        } catch (e) {
            console.error('è¨­å®šæ¨™ç±¤å¤±æ•—:', e);
            showToast('æ›´æ–°å¤±æ•—');
        }
    }

    // ============================================================
    // UI æ¸²æŸ“
    // ============================================================

    function renderTagManager() {
        const container = $('tagManagerContent');
        if (!container) return;

        if (userTags.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-tags text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500 mb-4">å°šç„¡è‡ªè¨‚æ¨™ç±¤</p>
                    <button data-action="init-defaults" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-magic mr-2"></i>å»ºç«‹é è¨­æ¨™ç±¤
                    </button>
                </div>
            `;
            initTagEventDelegation();
            return;
        }

        // âœ… P4: ä½¿ç”¨ data-action æ›¿ä»£ onclick
        container.innerHTML = `
            <div class="flex flex-wrap gap-2 mb-4" id="tagList">
                ${userTags.map(tag => `
                    <div class="flex items-center px-3 py-2 rounded-lg border" style="border-color: ${tag.color}" data-tag-id="${tag.id}">
                        <i class="fas ${tag.icon} mr-2" style="color: ${tag.color}"></i>
                        <span class="font-medium">${tag.name}</span>
                        <button data-action="edit-tag" data-id="${tag.id}" class="ml-2 text-gray-400 hover:text-blue-500">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button data-action="delete-tag" data-id="${tag.id}" class="ml-1 text-gray-400 hover:text-red-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
            <button data-action="create-tag" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                <i class="fas fa-plus mr-2"></i>æ–°å¢æ¨™ç±¤
            </button>
        `;

        initTagEventDelegation();
    }

    function renderTagBadges(tags) {
        if (!tags || tags.length === 0) return '';
        return tags.map(tag => `
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs"
                  style="background-color: ${tag.color}20; color: ${tag.color}">
                <i class="fas ${tag.icon} mr-1 text-xs"></i>${tag.name}
            </span>
        `).join('');
    }

    function renderTagFilter(selectedTagId = null) {
        if (userTags.length === 0) return '';
        // âœ… P4: ä½¿ç”¨ data-action æ›¿ä»£ onclick
        return `
            <div class="flex items-center gap-2 mb-4 flex-wrap">
                <span class="text-sm text-gray-500"><i class="fas fa-filter mr-1"></i>ç¯©é¸:</span>
                <button data-action="filter-tag" data-tag-id="" class="px-3 py-1.5 text-xs rounded-full transition-all ${!selectedTagId ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">å…¨éƒ¨</button>
                ${userTags.map(tag => `
                    <button data-action="filter-tag" data-tag-id="${tag.id}"
                            class="px-3 py-1.5 text-xs rounded-full transition-all ${selectedTagId === tag.id ? 'text-white' : 'hover:opacity-80'}"
                            style="background-color: ${selectedTagId === tag.id ? tag.color : tag.color + '30'}; color: ${selectedTagId === tag.id ? 'white' : tag.color}">
                        <i class="fas ${tag.icon} mr-1"></i>${tag.name}
                    </button>
                `).join('')}
            </div>
        `;
    }

    // ============================================================
    // äº‹ä»¶å§”è¨— (P4 æ ¸å¿ƒå„ªåŒ–)
    // ============================================================

    let delegationInitialized = false;

    function initTagEventDelegation() {
        const container = $('tagManagerContent');
        if (!container || delegationInitialized) return;

        container.addEventListener('click', handleTagClick);
        delegationInitialized = true;
        console.log('ğŸ“Œ æ¨™ç±¤ç®¡ç†äº‹ä»¶å§”è¨—å·²åˆå§‹åŒ–');
    }

    function handleTagClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        e.preventDefault();
        const action = target.dataset.action;

        switch (action) {
            case 'create-tag':
                showCreateTagModal();
                break;

            case 'edit-tag':
                showEditTagModal(parseInt(target.dataset.id));
                break;

            case 'delete-tag':
                deleteTag(parseInt(target.dataset.id));
                break;

            case 'init-defaults':
                initDefaultTags();
                break;

            case 'filter-tag':
                const tagId = target.dataset.tagId ? parseInt(target.dataset.tagId) : null;
                filterByTag(tagId);
                break;
        }
    }

    // ============================================================
    // é¡è‰²/åœ–ç¤ºé¸æ“‡å‡½æ•¸
    // ============================================================

    function selectTagColor(color) {
        const input = $('tagColorInput');
        if (input) input.value = color;

        const buttons = document.querySelectorAll('#tagColorOptions button');
        buttons.forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2'));

        const selectedBtn = Array.from(buttons).find(btn => {
            const onclick = btn.getAttribute('onclick') || btn.getAttribute('data-color');
            return onclick && onclick.includes(color);
        });

        if (!selectedBtn) {
            buttons.forEach(btn => {
                const style = btn.style.backgroundColor;
                if (style) {
                    const rgb = style.match(/\d+/g);
                    if (rgb) {
                        const hex = '#' + rgb.map(x => parseInt(x).toString(16).padStart(2, '0')).join('').toUpperCase();
                        if (hex === color.toUpperCase()) {
                            btn.classList.add('ring-2', 'ring-offset-2');
                            btn.style.setProperty('--tw-ring-color', color);
                        }
                    }
                }
            });
        } else {
            selectedBtn.classList.add('ring-2', 'ring-offset-2');
        }
    }

    function selectTagIcon(icon) {
        const input = $('tagIconInput');
        if (input) input.value = icon;

        const buttons = document.querySelectorAll('#tagIconOptions button');
        buttons.forEach(btn => {
            btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-500', 'border-2');
            btn.classList.add('border', 'border-gray-200', 'text-gray-400');
        });

        const selectedBtn = Array.from(buttons).find(btn => {
            const i = btn.querySelector('i');
            return i && i.classList.contains(icon);
        });

        if (selectedBtn) {
            selectedBtn.classList.remove('border', 'border-gray-200', 'text-gray-400');
            selectedBtn.classList.add('border-2', 'border-blue-500', 'bg-blue-50', 'text-blue-500');
        }
    }

    // ============================================================
    // Modal æ§åˆ¶
    // ============================================================

    function showCreateTagModal() {
        currentEditTagId = null;

        const title = $('tagModalTitle');
        if (title) title.innerHTML = '<i class="fas fa-tag mr-2 text-blue-500"></i>æ–°å¢æ¨™ç±¤';

        const nameInput = $('tagNameInput');
        if (nameInput) nameInput.value = '';

        const colorInput = $('tagColorInput');
        if (colorInput) colorInput.value = '#3B82F6';
        selectTagColor('#3B82F6');

        const iconInput = $('tagIconInput');
        if (iconInput) iconInput.value = 'fa-tag';
        selectTagIcon('fa-tag');

        const modal = $('tagEditModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (nameInput) nameInput.focus();
        }
    }

    function showEditTagModal(tagId) {
        const tag = userTags.find(t => t.id === tagId);
        if (!tag) return;

        currentEditTagId = tagId;

        const title = $('tagModalTitle');
        if (title) title.innerHTML = '<i class="fas fa-tag mr-2 text-blue-500"></i>ç·¨è¼¯æ¨™ç±¤';

        const nameInput = $('tagNameInput');
        if (nameInput) nameInput.value = tag.name;

        const colorInput = $('tagColorInput');
        if (colorInput) colorInput.value = tag.color;
        selectTagColor(tag.color);

        const iconInput = $('tagIconInput');
        if (iconInput) iconInput.value = tag.icon;
        selectTagIcon(tag.icon);

        const modal = $('tagEditModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function hideTagEditModal() {
        const modal = $('tagEditModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        currentEditTagId = null;
    }

    async function saveTagFromModal() {
        const name = $('tagNameInput')?.value?.trim();
        const color = $('tagColorInput')?.value || '#3B82F6';
        const icon = $('tagIconInput')?.value || 'fa-tag';

        if (!name) {
            showToast('è«‹è¼¸å…¥æ¨™ç±¤åç¨±');
            return;
        }

        if (currentEditTagId) {
            await updateTag(currentEditTagId, { name, color, icon });
        } else {
            await createTag(name, color, icon);
        }
        hideTagEditModal();
    }

    // ============================================================
    // æŒ‡æ´¾æ¨™ç±¤ Modal
    // ============================================================

    function showAssignTagModal(watchlistId, symbol) {
        currentAssignWatchlistId = watchlistId;
        const modal = $('assignTagModal');
        const symbolEl = $('assignTagSymbol');
        const container = $('assignTagList');

        if (symbolEl) symbolEl.textContent = symbol;
        if (container) container.innerHTML = '<p class="text-gray-400 text-center">è¼‰å…¥ä¸­...</p>';

        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        loadAssignTagList(watchlistId);
    }

    async function loadAssignTagList(watchlistId) {
        const container = $('assignTagList');
        if (!container) return;

        const currentTags = await getWatchlistTags(watchlistId);
        const currentTagIds = new Set(currentTags.map(t => t.id));

        if (userTags.length === 0) {
            container.innerHTML = `
                <p class="text-gray-500 text-center py-4">å°šç„¡æ¨™ç±¤</p>
                <button data-action="goto-create-tag" class="w-full py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                    <i class="fas fa-plus mr-2"></i>å»ºç«‹æ¨™ç±¤
                </button>
            `;
            return;
        }

        container.innerHTML = userTags.map(tag => `
            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                <input type="checkbox" class="assign-tag-checkbox w-5 h-5 rounded" value="${tag.id}" ${currentTagIds.has(tag.id) ? 'checked' : ''}>
                <i class="fas ${tag.icon} ml-3 mr-2" style="color: ${tag.color}"></i>
                <span>${tag.name}</span>
            </label>
        `).join('');
    }

    function hideAssignTagModal() {
        const modal = $('assignTagModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        currentAssignWatchlistId = null;
    }

    async function saveAssignedTags() {
        if (!currentAssignWatchlistId) return;
        const checkboxes = document.querySelectorAll('.assign-tag-checkbox:checked');
        const tagIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        await setWatchlistTags(currentAssignWatchlistId, tagIds);
        hideAssignTagModal();
    }

    // ============================================================
    // ç¯©é¸åŠŸèƒ½
    // ============================================================

    function filterByTag(tagId) {
        currentFilterTagId = tagId;
        if (typeof loadWatchlist === 'function') loadWatchlist();
    }

    function getFilterTagId() {
        return currentFilterTagId;
    }

    function setFilterTagId(tagId) {
        currentFilterTagId = tagId;
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.tags = {
            load: loadTags,
            create: createTag,
            update: updateTag,
            delete: deleteTag,
            initDefaults: initDefaultTags,
            getWatchlistTags,
            setWatchlistTags,
            renderBadges: renderTagBadges,
            renderFilter: renderTagFilter,
            renderManager: renderTagManager,
            getFilterId: getFilterTagId,
            setFilterId: setFilterTagId
        };
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.loadTags = loadTags;
    window.createTag = createTag;
    window.updateTag = updateTag;
    window.deleteTag = deleteTag;
    window.initDefaultTags = initDefaultTags;
    window.getWatchlistTags = getWatchlistTags;
    window.setWatchlistTags = setWatchlistTags;
    window.renderTagBadges = renderTagBadges;
    window.renderTagFilter = renderTagFilter;
    window.renderTagManager = renderTagManager;
    window.showCreateTagModal = showCreateTagModal;
    window.showEditTagModal = showEditTagModal;
    window.hideTagEditModal = hideTagEditModal;
    window.saveTagFromModal = saveTagFromModal;
    window.showAssignTagModal = showAssignTagModal;
    window.hideAssignTagModal = hideAssignTagModal;
    window.saveAssignedTags = saveAssignedTags;
    window.filterByTag = filterByTag;
    window.getFilterTagId = getFilterTagId;
    window.setFilterTagId = setFilterTagId;
    window.userTags = userTags;
    window.selectTagColor = selectTagColor;
    window.selectTagIcon = selectTagIcon;

    console.log('ğŸ·ï¸ tags.js æ¨¡çµ„å·²è¼‰å…¥ (P4 å„ªåŒ–ç‰ˆ)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/transaction.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * äº¤æ˜“è¡¨å–®æ¨¡çµ„ (P4 å„ªåŒ–ç‰ˆ)
 * 
 * å„ªåŒ–å…§å®¹ï¼š
 * 1. DOM å¿«å– - ä½¿ç”¨ $() å‡½æ•¸
 * 2. æ¸›å°‘é‡è¤‡æŸ¥è©¢
 * 
 * åŒ…å«ï¼šå°è‚¡/ç¾è‚¡äº¤æ˜“è¡¨å–®
 */

(function() {
    'use strict';

    let twLookupTimer = null;
    let usLookupTimer = null;

    // ============================================================
    // å°è‚¡äº¤æ˜“
    // ============================================================

    function showAddTwModal() {
        // âœ… P4: ä½¿ç”¨ $() å¿«å–
        $('twEditId').value = '';
        $('twModalTitle').textContent = 'æ–°å¢å°è‚¡äº¤æ˜“';
        setTwType('buy');
        $('twSymbol').value = '';
        $('twName').value = '';
        $('twNameDisplay').innerHTML = '<span class="text-gray-400">è¼¸å…¥ä»£ç¢¼è‡ªå‹•å¸¶å…¥</span>';
        $('twLots').value = '';
        $('twOddLot').value = '';
        $('twQuantityDisplay').textContent = '= 0 è‚¡';
        $('twPrice').value = '';
        $('twFee').value = '';
        $('twTax').value = '';
        $('twDate').value = new Date().toISOString().split('T')[0];
        $('twNote').value = '';

        const modal = $('twTransactionModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function closeTwModal() {
        const modal = $('twTransactionModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function setTwType(type) {
        const buyBtn = $('twTypeBuy');
        const sellBtn = $('twTypeSell');
        const typeInput = $('twType');

        if (type === 'buy') {
            if (buyBtn) {
                buyBtn.classList.add('bg-green-500', 'text-white');
                buyBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }
            if (sellBtn) {
                sellBtn.classList.remove('bg-red-500', 'text-white');
                sellBtn.classList.add('bg-gray-100', 'text-gray-700');
            }
        } else {
            if (sellBtn) {
                sellBtn.classList.add('bg-red-500', 'text-white');
                sellBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }
            if (buyBtn) {
                buyBtn.classList.remove('bg-green-500', 'text-white');
                buyBtn.classList.add('bg-gray-100', 'text-gray-700');
            }
        }
        if (typeInput) typeInput.value = type;
    }

    function updateTwQuantity() {
        const lots = parseInt($('twLots')?.value) || 0;
        const oddLot = parseInt($('twOddLot')?.value) || 0;
        const total = lots * 1000 + oddLot;

        const display = $('twQuantityDisplay');
        if (display) display.textContent = `= ${total.toLocaleString()} è‚¡`;

        const hidden = $('twQuantity');
        if (hidden) hidden.value = total;
    }

    function lookupTwStock() {
        clearTimeout(twLookupTimer);
        twLookupTimer = setTimeout(async () => {
            const symbol = $('twSymbol')?.value?.trim();
            if (!symbol || symbol.length < 4) return;

            try {
                const res = await apiRequest(`/api/stock/${symbol}.TW/info`);
                const data = await res.json();

                const nameDisplay = $('twNameDisplay');
                const nameInput = $('twName');

                if (data.success && data.name) {
                    if (nameDisplay) nameDisplay.innerHTML = `<span class="text-gray-800">${data.name}</span>`;
                    if (nameInput) nameInput.value = data.name;
                } else {
                    if (nameDisplay) nameDisplay.innerHTML = '<span class="text-gray-400">æŸ¥ç„¡è³‡æ–™</span>';
                }
            } catch (e) {
                console.error('æŸ¥è©¢å°è‚¡å¤±æ•—:', e);
            }
        }, 500);
    }

    async function submitTwTransaction() {
        const editId = $('twEditId')?.value;
        const symbol = $('twSymbol')?.value?.trim();
        const name = $('twName')?.value?.trim();
        const type = $('twType')?.value;
        const quantity = parseInt($('twQuantity')?.value) || 0;
        const price = parseFloat($('twPrice')?.value) || 0;
        const fee = parseFloat($('twFee')?.value) || 0;
        const tax = parseFloat($('twTax')?.value) || 0;
        const date = $('twDate')?.value;
        const note = $('twNote')?.value?.trim();

        if (!symbol || quantity <= 0 || price <= 0) {
            showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
            return;
        }

        const body = {
            symbol,
            name,
            transaction_type: type,
            quantity,
            price,
            fee,
            tax,
            transaction_date: date,
            note
        };

        try {
            let res;
            if (editId) {
                res = await apiRequest(`/api/portfolio/transactions/tw/${editId}`, {
                    method: 'PUT',
                    body
                });
            } else {
                res = await apiRequest('/api/portfolio/transactions/tw', {
                    method: 'POST',
                    body
                });
            }

            const data = await res.json();

            if (data.success) {
                showToast(editId ? 'äº¤æ˜“å·²æ›´æ–°' : 'äº¤æ˜“å·²æ–°å¢');
                closeTwModal();

                // âœ… P4: æ¸…é™¤ AppState å¿«å–
                if (window.AppState) {
                    AppState.set('portfolioLoaded', false);
                }

                if (typeof loadPortfolio === 'function') loadPortfolio();
                if (typeof loadTransactions === 'function') loadTransactions('tw');
            } else {
                showToast(data.detail || 'æ“ä½œå¤±æ•—');
            }
        } catch (e) {
            console.error('æäº¤äº¤æ˜“å¤±æ•—:', e);
            showToast('æ“ä½œå¤±æ•—');
        }
    }

    async function editTwTransaction(id) {
        try {
            const res = await apiRequest(`/api/portfolio/transactions/${id}`);
            const data = await res.json();

            if (data.success) {
                const t = data.data;
                $('twEditId').value = t.id;
                $('twModalTitle').textContent = 'ç·¨è¼¯å°è‚¡äº¤æ˜“';
                setTwType(t.transaction_type);

                $('twSymbol').value = t.symbol.replace('.TW', '').replace('.TWO', '');
                $('twName').value = t.name || '';

                const nameDisplay = $('twNameDisplay');
                if (nameDisplay) {
                    nameDisplay.innerHTML = t.name
                        ? `<span class="text-gray-800">${t.name}</span>`
                        : '<span class="text-gray-400">--</span>';
                }

                const lots = Math.floor(t.quantity / 1000);
                const oddLot = t.quantity % 1000;
                $('twLots').value = lots || '';
                $('twOddLot').value = oddLot || '';
                updateTwQuantity();

                $('twPrice').value = t.price;
                $('twFee').value = t.fee || '';
                $('twTax').value = t.tax || '';
                $('twDate').value = t.transaction_date;
                $('twNote').value = t.note || '';

                const modal = $('twTransactionModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            }
        } catch (e) {
            console.error('è¼‰å…¥äº¤æ˜“å¤±æ•—:', e);
            showToast('è¼‰å…¥å¤±æ•—');
        }
    }

    // ============================================================
    // ç¾è‚¡äº¤æ˜“
    // ============================================================

    function showAddUsModal() {
        $('usEditId').value = '';
        $('usModalTitle').textContent = 'æ–°å¢ç¾è‚¡äº¤æ˜“';
        setUsType('buy');
        $('usSymbol').value = '';
        $('usName').value = '';
        $('usNameDisplay').innerHTML = '<span class="text-gray-400">è¼¸å…¥ä»£ç¢¼è‡ªå‹•å¸¶å…¥</span>';
        $('usQuantity').value = '';
        $('usPrice').value = '';
        $('usFee').value = '';
        $('usTax').value = '';
        $('usDate').value = new Date().toISOString().split('T')[0];
        $('usNote').value = '';

        const modal = $('usTransactionModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function closeUsModal() {
        const modal = $('usTransactionModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function setUsType(type) {
        const buyBtn = $('usTypeBuy');
        const sellBtn = $('usTypeSell');
        const typeInput = $('usType');

        if (type === 'buy') {
            if (buyBtn) {
                buyBtn.classList.add('bg-green-500', 'text-white');
                buyBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }
            if (sellBtn) {
                sellBtn.classList.remove('bg-red-500', 'text-white');
                sellBtn.classList.add('bg-gray-100', 'text-gray-700');
            }
        } else {
            if (sellBtn) {
                sellBtn.classList.add('bg-red-500', 'text-white');
                sellBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }
            if (buyBtn) {
                buyBtn.classList.remove('bg-green-500', 'text-white');
                buyBtn.classList.add('bg-gray-100', 'text-gray-700');
            }
        }
        if (typeInput) typeInput.value = type;
    }

    function lookupUsStock() {
        clearTimeout(usLookupTimer);
        usLookupTimer = setTimeout(async () => {
            const symbol = $('usSymbol')?.value?.trim().toUpperCase();
            if (!symbol || symbol.length < 1) return;

            try {
                const res = await apiRequest(`/api/stock/${symbol}/info`);
                const data = await res.json();

                const nameDisplay = $('usNameDisplay');
                const nameInput = $('usName');

                if (data.success && data.name) {
                    if (nameDisplay) nameDisplay.innerHTML = `<span class="text-gray-800">${data.name}</span>`;
                    if (nameInput) nameInput.value = data.name;
                } else {
                    if (nameDisplay) nameDisplay.innerHTML = '<span class="text-gray-400">æŸ¥ç„¡è³‡æ–™</span>';
                }
            } catch (e) {
                console.error('æŸ¥è©¢ç¾è‚¡å¤±æ•—:', e);
            }
        }, 500);
    }

    async function submitUsTransaction() {
        const editId = $('usEditId')?.value;
        const symbol = $('usSymbol')?.value?.trim().toUpperCase();
        const name = $('usName')?.value?.trim();
        const type = $('usType')?.value;
        const quantity = parseFloat($('usQuantity')?.value) || 0;
        const price = parseFloat($('usPrice')?.value) || 0;
        const fee = parseFloat($('usFee')?.value) || 0;
        const tax = parseFloat($('usTax')?.value) || 0;
        const date = $('usDate')?.value;
        const note = $('usNote')?.value?.trim();

        if (!symbol || quantity <= 0 || price <= 0) {
            showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
            return;
        }

        const body = {
            symbol,
            name,
            transaction_type: type,
            quantity,
            price,
            fee,
            tax,
            transaction_date: date,
            note
        };

        try {
            let res;
            if (editId) {
                res = await apiRequest(`/api/portfolio/transactions/us/${editId}`, {
                    method: 'PUT',
                    body
                });
            } else {
                res = await apiRequest('/api/portfolio/transactions/us', {
                    method: 'POST',
                    body
                });
            }

            const data = await res.json();

            if (data.success) {
                showToast(editId ? 'äº¤æ˜“å·²æ›´æ–°' : 'äº¤æ˜“å·²æ–°å¢');
                closeUsModal();

                // âœ… P4: æ¸…é™¤ AppState å¿«å–
                if (window.AppState) {
                    AppState.set('portfolioLoaded', false);
                }

                if (typeof loadPortfolio === 'function') loadPortfolio();
                if (typeof loadTransactions === 'function') loadTransactions('us');
            } else {
                showToast(data.detail || 'æ“ä½œå¤±æ•—');
            }
        } catch (e) {
            console.error('æäº¤äº¤æ˜“å¤±æ•—:', e);
            showToast('æ“ä½œå¤±æ•—');
        }
    }

    async function editUsTransaction(id) {
        try {
            const res = await apiRequest(`/api/portfolio/transactions/${id}`);
            const data = await res.json();

            if (data.success) {
                const t = data.data;
                $('usEditId').value = t.id;
                $('usModalTitle').textContent = 'ç·¨è¼¯ç¾è‚¡äº¤æ˜“';
                setUsType(t.transaction_type);

                $('usSymbol').value = t.symbol;
                $('usName').value = t.name || '';

                const nameDisplay = $('usNameDisplay');
                if (nameDisplay) {
                    nameDisplay.innerHTML = t.name
                        ? `<span class="text-gray-800">${t.name}</span>`
                        : '<span class="text-gray-400">--</span>';
                }

                $('usQuantity').value = t.quantity;
                $('usPrice').value = t.price;
                $('usFee').value = t.fee || '';
                $('usTax').value = t.tax || '';
                $('usDate').value = t.transaction_date;
                $('usNote').value = t.note || '';

                const modal = $('usTransactionModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            }
        } catch (e) {
            console.error('è¼‰å…¥äº¤æ˜“å¤±æ•—:', e);
            showToast('è¼‰å…¥å¤±æ•—');
        }
    }

    // ============================================================
    // å¿«é€Ÿäº¤æ˜“ï¼ˆè¦†å¯« portfolio.js çš„ç‰ˆæœ¬ï¼‰
    // ============================================================

    function quickTrade(symbol, name, market, type) {
        if (market === 'tw') {
            showAddTwModal();
            setTwType(type);
            const cleanSymbol = symbol.replace('.TW', '').replace('.TWO', '');
            $('twSymbol').value = cleanSymbol;
            $('twName').value = name || '';

            const nameDisplay = $('twNameDisplay');
            if (nameDisplay) {
                nameDisplay.innerHTML = name
                    ? `<span class="text-gray-800">${name}</span>`
                    : '<span class="text-gray-400">--</span>';
            }
        } else {
            showAddUsModal();
            setUsType(type);
            $('usSymbol').value = symbol;
            $('usName').value = name || '';

            const nameDisplay = $('usNameDisplay');
            if (nameDisplay) {
                nameDisplay.innerHTML = name
                    ? `<span class="text-gray-800">${name}</span>`
                    : '<span class="text-gray-400">--</span>';
            }
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.transaction = {
            showTwModal: showAddTwModal,
            closeTwModal,
            showUsModal: showAddUsModal,
            closeUsModal,
            quickTrade
        };
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.showAddTwModal = showAddTwModal;
    window.closeTwModal = closeTwModal;
    window.setTwType = setTwType;
    window.updateTwQuantity = updateTwQuantity;
    window.lookupTwStock = lookupTwStock;
    window.submitTwTransaction = submitTwTransaction;
    window.editTwTransaction = editTwTransaction;

    window.showAddUsModal = showAddUsModal;
    window.closeUsModal = closeUsModal;
    window.setUsType = setUsType;
    window.lookupUsStock = lookupUsStock;
    window.submitUsTransaction = submitUsTransaction;
    window.editUsTransaction = editUsTransaction;

    window.quickTrade = quickTrade;

    console.log('ğŸ’° transaction.js æ¨¡çµ„å·²è¼‰å…¥ (P4 å„ªåŒ–ç‰ˆ)');
})();
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/utils.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * SELA å·¥å…·å‡½æ•¸åº«
 * é€™æ˜¯ä¸€å€‹éæ¨¡çµ„ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥é€šé <script> æ¨™ç±¤å¼•ç”¨
 */

// ============================================================
// æ ¼å¼åŒ–å·¥å…·
// ============================================================

/**
 * æ•¸å­—æ ¼å¼åŒ–ï¼ˆå¸¶åƒåˆ†ä½ï¼‰
 */
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return Number(num).toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

/**
 * åƒ¹æ ¼æ ¼å¼åŒ–
 */
function formatPrice(price, currency = 'USD') {
    if (price === null || price === undefined) return '--';
    const prefix = currency === 'TWD' ? 'NT$' : '$';
    return prefix + formatNumber(price);
}

/**
 * ç™¾åˆ†æ¯”æ ¼å¼åŒ–
 */
function formatPercent(value, showSign = true) {
    if (value === null || value === undefined || isNaN(value)) return '--';
    const sign = showSign && value > 0 ? '+' : '';
    return sign + value.toFixed(2) + '%';
}

/**
 * æ—¥æœŸæ ¼å¼åŒ–
 */
function formatDate(dateStr, format = 'short') {
    if (!dateStr) return '--';
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return '--';
    
    if (format === 'short') {
        return date.toLocaleDateString('zh-TW');
    } else if (format === 'full') {
        return date.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } else if (format === 'iso') {
        return date.toISOString().split('T')[0];
    }
    return date.toLocaleDateString('zh-TW');
}

/**
 * å¤§æ•¸å­—ç¸®å¯«
 */
function formatLargeNumber(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    const abs = Math.abs(num);
    if (abs >= 1e12) return (num / 1e12).toFixed(2) + 'T';
    if (abs >= 1e9) return (num / 1e9).toFixed(2) + 'B';
    if (abs >= 1e6) return (num / 1e6).toFixed(2) + 'M';
    if (abs >= 1e3) return (num / 1e3).toFixed(2) + 'K';
    return num.toFixed(2);
}

/**
 * è‚¡æ•¸æ ¼å¼åŒ–ï¼ˆå°è‚¡ç”¨å¼µï¼‰
 */
function formatShares(shares, market = 'us') {
    if (shares === null || shares === undefined) return '--';
    if (market === 'tw') {
        const lots = Math.floor(shares / 1000);
        const odd = shares % 1000;
        if (lots > 0 && odd > 0) {
            return `${lots} å¼µ ${odd} è‚¡`;
        } else if (lots > 0) {
            return `${lots} å¼µ`;
        } else {
            return `${odd} è‚¡`;
        }
    }
    return shares.toLocaleString() + ' è‚¡';
}

/**
 * æ¼²è·Œæ¨£å¼ class
 */
function getChangeClass(value) {
    if (value > 0) return 'text-green-600';
    if (value < 0) return 'text-red-600';
    return 'text-gray-500';
}

/**
 * æ¼²è·Œåœ–ç¤º
 */
function getChangeIcon(value) {
    if (value > 0) return 'â–²';
    if (value < 0) return 'â–¼';
    return 'â€”';
}

// ============================================================
// é˜²æŠ–èˆ‡ç¯€æµ
// ============================================================

/**
 * é˜²æŠ–å‡½æ•¸
 */
function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * ç¯€æµå‡½æ•¸
 */
function throttle(func, limit = 300) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// ============================================================
// LocalStorage å°è£
// ============================================================

const storage = {
    get(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
            console.error('Storage get error:', e);
            return defaultValue;
        }
    },
    
    set(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error('Storage set error:', e);
            return false;
        }
    },
    
    remove(key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (e) {
            console.error('Storage remove error:', e);
            return false;
        }
    }
};

// ============================================================
// æª”æ¡ˆè™•ç†
// ============================================================

/**
 * è§£æ CSV æª”æ¡ˆ
 */
function parseCSV(content) {
    const lines = content.split('\n').filter(l => l.trim());
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const items = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const obj = {};
        headers.forEach((h, idx) => {
            obj[h] = values[idx]?.trim();
        });
        items.push(obj);
    }
    
    return items;
}

/**
 * è§£æ JSON æª”æ¡ˆ
 */
function parseJSON(content) {
    try {
        const data = JSON.parse(content);
        return data.items || data;
    } catch (e) {
        console.error('JSON parse error:', e);
        return [];
    }
}

/**
 * é è¦½æª”æ¡ˆå…§å®¹
 */
function previewFile(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        let items = [];
        
        if (file.name.endsWith('.json')) {
            items = parseJSON(content);
        } else if (file.name.endsWith('.csv')) {
            items = parseCSV(content);
        }
        
        callback(items, null);
    };
    reader.onerror = function() {
        callback(null, new Error('æª”æ¡ˆè®€å–å¤±æ•—'));
    };
    reader.readAsText(file);
}

console.log('SELA å·¥å…·å‡½æ•¸åº«å·²è¼‰å…¥');
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ static/js/watchlist.js  â­
> *
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```js
/**
 * è¿½è¹¤æ¸…å–®æ¨¡çµ„ (P3 å„ªåŒ–ç‰ˆ)
 * 
 * å„ªåŒ–å…§å®¹ï¼š
 * 1. äº‹ä»¶å§”è¨— - æ¸›å°‘ç›£è½å™¨æ•¸é‡
 * 2. AppState æ•´åˆ - çµ±ä¸€ç‹€æ…‹ç®¡ç†
 * 3. DOM å¿«å– - ä½¿ç”¨ $() å‡½æ•¸
 * 
 * åŒ…å«ï¼šæ¸…å–®é¡¯ç¤ºã€æ–°å¢åˆªé™¤ã€åŒ¯å‡ºåŒ¯å…¥ã€ç›®æ¨™åƒ¹è¨­å®šã€æ¨™ç±¤æ•´åˆ
 */

(function() {
    'use strict';

    // ============================================================
    // ç§æœ‰è®Šæ•¸
    // ============================================================

    let watchlistData = [];
    let sortConfig = JSON.parse(localStorage.getItem('watchlistSort') || '{"field":"added_at","order":"desc"}');
    let currentTargetItemId = null;
    let watchlistTagsMap = {};

    // ============================================================
    // æ’åºåŠŸèƒ½
    // ============================================================

    function getSortConfig() {
        return sortConfig;
    }

    function setSort(field, order) {
        sortConfig = { field, order };
        localStorage.setItem('watchlistSort', JSON.stringify(sortConfig));
    }

    function sortWatchlistData(data) {
        const { field, order } = sortConfig;
        const multiplier = order === 'asc' ? 1 : -1;

        return [...data].sort((a, b) => {
            let aVal, bVal;

            if (field === 'ma20_diff') {
                aVal = (a.ma20 && a.price) ? ((a.price - a.ma20) / a.ma20 * 100) : -999;
                bVal = (b.ma20 && b.price) ? ((b.price - b.ma20) / b.ma20 * 100) : -999;
            } else {
                aVal = a[field];
                bVal = b[field];
            }

            if (aVal === null || aVal === undefined) aVal = field === 'change_pct' ? -999 : '';
            if (bVal === null || bVal === undefined) bVal = field === 'change_pct' ? -999 : '';

            if (typeof aVal === 'string') {
                return aVal.localeCompare(bVal) * multiplier;
            }
            return (aVal - bVal) * multiplier;
        });
    }

    function changeWatchlistSort(field) {
        if (sortConfig.field === field) {
            setSort(field, sortConfig.order === 'asc' ? 'desc' : 'asc');
        } else {
            setSort(field, 'desc');
        }
        renderWatchlistCards(watchlistData);
    }

    function renderSortControls() {
        const options = [
            { field: 'added_at', label: 'åŠ å…¥æ™‚é–“', icon: 'fa-clock' },
            { field: 'symbol', label: 'ä»£è™Ÿ', icon: 'fa-sort-alpha-down' },
            { field: 'change_pct', label: 'æ¼²è·Œå¹…', icon: 'fa-percent' },
            { field: 'price', label: 'åƒ¹æ ¼', icon: 'fa-dollar-sign' },
            { field: 'ma20_diff', label: 'MA20è·é›¢', icon: 'fa-chart-line' }
        ];

        return `
            <div class="flex items-center gap-2 mb-4 flex-wrap">
                <span class="text-sm text-gray-500"><i class="fas fa-sort mr-1"></i>æ’åº:</span>
                <div class="flex gap-1 flex-wrap">
                    ${options.map(opt => `
                        <button data-action="sort" data-field="${opt.field}"
                                class="px-3 py-1.5 text-xs rounded-full transition-all ${sortConfig.field === opt.field
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                            <i class="fas ${opt.icon} mr-1"></i>${opt.label}
                            ${sortConfig.field === opt.field
                                ? `<i class="fas fa-arrow-${sortConfig.order === 'asc' ? 'up' : 'down'} ml-1"></i>`
                                : ''}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // ============================================================
    // æ¸²æŸ“å¡ç‰‡
    // ============================================================

    function getMa20Badge(item) {
        if (!item.ma20 || !item.price) return '';

        const diff = ((item.price - item.ma20) / item.ma20 * 100).toFixed(1);
        const isAbove = item.price >= item.ma20;

        return `<span class="ml-2 px-2 py-0.5 text-xs rounded-full ${isAbove ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
            MA20 ${isAbove ? 'â†‘' : 'â†“'}${Math.abs(diff)}%
        </span>`;
    }

    function renderWatchlistCards(data) {
        const container = $('watchlistContent');
        if (!container) return;

        watchlistData = data;

        // åŒæ­¥åˆ° AppState
        if (window.AppState) {
            AppState.setWatchlist(data);
        }

        // æ¨™ç±¤ç¯©é¸
        const filterTagId = typeof getFilterTagId === 'function' ? getFilterTagId() : null;
        let filteredData = data;

        if (filterTagId) {
            filteredData = data.filter(item => {
                const itemTags = watchlistTagsMap[item.id] || [];
                return itemTags.some(t => t.id === filterTagId);
            });
        }

        const sortedData = sortWatchlistData(filteredData);

        // æ¨™ç±¤ç¯©é¸å™¨
        let html = '';
        if (typeof renderTagFilter === 'function') {
            html += renderTagFilter(filterTagId);
        }

        html += renderSortControls();
        html += '<div class="space-y-3" id="watchlistCards">';

        for (const item of sortedData) {
            html += renderSingleCard(item);
        }

        html += '</div>';
        container.innerHTML = html;

        // âœ… P3: åˆå§‹åŒ–äº‹ä»¶å§”è¨—
        initWatchlistEventDelegation();
    }

    function renderSingleCard(item) {
        const typeClass = item.asset_type === 'crypto' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
        const typeText = item.asset_type === 'crypto' ? 'å¹£' : 'è‚¡';

        const hasTarget = item.target_price !== null && item.target_price !== undefined;
        const targetReached = item.target_reached === true;
        const cardBorderClass = targetReached
            ? 'border-yellow-500 ring-2 ring-yellow-300'
            : (item.asset_type === 'crypto' ? 'border-purple-500' : 'border-blue-500');

        let priceInfo = '';
        if (item.price !== null && item.price !== undefined) {
            const change = item.change_pct || 0;
            const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
            const changeIcon = change >= 0 ? 'â–²' : 'â–¼';
            const ma20Badge = getMa20Badge(item);

            let targetBadge = '';
            if (hasTarget) {
                if (targetReached) {
                    targetBadge = `<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700 animate-pulse">
                        <i class="fas fa-bell mr-1"></i>å·²é”æ¨™ $${item.target_price.toLocaleString()}
                    </span>`;
                } else {
                    const diff = ((item.target_price - item.price) / item.price * 100).toFixed(1);
                    targetBadge = `<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">
                        <i class="fas fa-crosshairs mr-1"></i>ç›®æ¨™ $${item.target_price.toLocaleString()} (${diff > 0 ? '+' : ''}${diff}%)
                    </span>`;
                }
            }

            priceInfo = `
                <div class="flex items-baseline gap-2 mt-2 flex-wrap">
                    <span class="text-xl font-bold text-gray-800">$${item.price.toLocaleString()}</span>
                    <span class="${changeClass} text-sm font-medium">${changeIcon} ${Math.abs(change).toFixed(2)}%</span>
                    ${ma20Badge}
                    ${targetBadge}
                </div>
            `;
        } else {
            priceInfo = `<div class="flex items-baseline gap-2 mt-2"><span class="text-gray-400 text-sm">åƒ¹æ ¼æ›´æ–°ä¸­...</span></div>`;
        }

        const nameDisplay = item.name ? `<span class="text-gray-500 text-sm ml-2">${item.name}</span>` : '';
        const isCrypto = item.asset_type === 'crypto';
        const isTw = item.symbol.includes('.TW') || /^\d+$/.test(item.symbol);
        const market = isTw ? 'tw' : 'us';

        // æ¨™ç±¤ badges
        const itemTags = watchlistTagsMap[item.id] || [];
        const tagBadges = typeof renderTagBadges === 'function' ? renderTagBadges(itemTags) : '';

        // âœ… P3: ä½¿ç”¨ data-action æ›¿ä»£ onclick
        const tradeButtons = isCrypto ? '' : `
            <div class="flex gap-2 mr-2">
                <button data-action="trade" data-symbol="${item.symbol}" data-name="${item.name || ''}" data-market="${market}" data-type="buy"
                        class="px-3 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 touch-target">
                    <i class="fas fa-arrow-down mr-1"></i>è²·å…¥
                </button>
                <button data-action="trade" data-symbol="${item.symbol}" data-name="${item.name || ''}" data-market="${market}" data-type="sell"
                        class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 touch-target">
                    <i class="fas fa-arrow-up mr-1"></i>è³£å‡º
                </button>
            </div>
        `;

        return `
            <div class="stock-card bg-white rounded-xl shadow-sm p-4 border-l-4 ${cardBorderClass}" data-id="${item.id}" data-symbol="${item.symbol}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center flex-wrap gap-1">
                            <span class="font-bold text-lg text-gray-800">${item.symbol}</span>
                            <span class="px-2 py-0.5 rounded text-xs ${typeClass}">${typeText}</span>
                            ${targetReached ? '<span class="px-2 py-0.5 rounded text-xs bg-yellow-500 text-white"><i class="fas fa-bell"></i> åˆ°åƒ¹</span>' : ''}
                            ${nameDisplay}
                        </div>
                        ${tagBadges ? `<div class="flex flex-wrap gap-1 mt-1">${tagBadges}</div>` : ''}
                        ${priceInfo}
                        ${item.note ? `<p class="text-gray-500 text-sm mt-2 italic"><i class="fas fa-sticky-note mr-1"></i>${item.note}</p>` : ''}
                    </div>
                    <button data-action="remove" data-symbol="${item.symbol}" class="p-2 text-gray-400 hover:text-red-500 touch-target">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between mt-3 pt-3 border-t flex-wrap gap-2">
                    <span class="text-gray-400 text-xs"><i class="fas fa-clock mr-1"></i>åŠ å…¥æ–¼ ${new Date(item.added_at).toLocaleDateString()}</span>
                    <div class="flex items-center">
                        <button data-action="assign-tag" data-id="${item.id}" data-symbol="${item.symbol}"
                                class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 touch-target mr-2"
                                title="è¨­å®šæ¨™ç±¤">
                            <i class="fas fa-tags"></i>
                        </button>
                        <button data-action="target-price" data-id="${item.id}" data-symbol="${item.symbol}" data-target="${item.target_price || ''}"
                                class="px-3 py-2 ${hasTarget ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'} rounded-lg text-sm hover:bg-yellow-200 touch-target mr-2"
                                title="${hasTarget ? 'ä¿®æ”¹ç›®æ¨™åƒ¹' : 'è¨­å®šç›®æ¨™åƒ¹'}">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        ${tradeButtons}
                        <button data-action="analyze" data-symbol="${item.symbol}" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 touch-target">
                            <i class="fas fa-chart-line mr-1"></i>è©³ç´°åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // ============================================================
    // äº‹ä»¶å§”è¨— (P3 æ ¸å¿ƒå„ªåŒ–)
    // ============================================================

    let delegationInitialized = false;

    function initWatchlistEventDelegation() {
        const container = $('watchlistContent');
        if (!container || delegationInitialized) return;

        container.addEventListener('click', handleWatchlistClick);
        delegationInitialized = true;
        console.log('ğŸ“Œ è¿½è¹¤æ¸…å–®äº‹ä»¶å§”è¨—å·²åˆå§‹åŒ–');
    }

    function handleWatchlistClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        e.preventDefault();
        const action = target.dataset.action;

        switch (action) {
            case 'sort':
                changeWatchlistSort(target.dataset.field);
                break;

            case 'remove':
                removeFromWatchlist(target.dataset.symbol);
                break;

            case 'analyze':
                if (typeof searchSymbol === 'function') {
                    searchSymbol(target.dataset.symbol);
                }
                break;

            case 'trade':
                if (typeof quickTrade === 'function') {
                    quickTrade(
                        target.dataset.symbol,
                        target.dataset.name,
                        target.dataset.market,
                        target.dataset.type
                    );
                }
                break;

            case 'target-price':
                showTargetPriceModal(
                    parseInt(target.dataset.id),
                    target.dataset.symbol,
                    target.dataset.target ? parseFloat(target.dataset.target) : null
                );
                break;

            case 'assign-tag':
                if (typeof showAssignTagModal === 'function') {
                    showAssignTagModal(parseInt(target.dataset.id), target.dataset.symbol);
                }
                break;

            case 'filter-tag':
                if (typeof setFilterTagId === 'function') {
                    const tagId = target.dataset.tagId ? parseInt(target.dataset.tagId) : null;
                    setFilterTagId(tagId);
                    renderWatchlistCards(watchlistData);
                }
                break;
        }
    }

    // ============================================================
    // API æ“ä½œ
    // ============================================================

    async function loadWatchlist() {
        const container = $('watchlistContent');
        const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : window.currentUser;

        if (!currentUser || !currentUser.id) {
            console.error('loadWatchlist: ç”¨æˆ¶æœªç™»å…¥');
            if (container) {
                container.innerHTML = '<p class="text-red-500 text-center py-4">è«‹å…ˆç™»å…¥</p>';
            }
            return;
        }

        // âœ… P3: æª¢æŸ¥ AppState æ˜¯å¦å·²æœ‰è³‡æ–™
        if (window.AppState && AppState.watchlistLoaded && AppState.watchlist.length > 0) {
            renderWatchlistCards(AppState.watchlist);
            return;
        }

        if (container) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
            `;
        }

        try {
            if (typeof loadTags === 'function') {
                await loadTags();
            }

            const res = await apiRequest('/api/watchlist/with-prices');
            const data = await res.json();

            if (!data.success || !data.data || data.data.length === 0) {
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-star text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">å°šç„¡è¿½è¹¤æ¸…å–®</p>
                            <button data-action="show-add-modal" class="mt-4 px-4 py-2 bg-orange-500 text-white rounded-lg">
                                <i class="fas fa-plus mr-2"></i>æ–°å¢è¿½è¹¤
                            </button>
                        </div>
                    `;
                    initWatchlistEventDelegation();
                }
                return;
            }

            // â­ æ•ˆèƒ½å„ªåŒ–ï¼šç›´æ¥ä½¿ç”¨ API è¿”å›çš„æ¨™ç±¤ï¼Œæ¶ˆé™¤ N+1 å•é¡Œ
            // èˆŠæ–¹æ³•ï¼šawait loadAllWatchlistTags(data.data); // æœƒç”¢ç”Ÿ N æ¬¡è«‹æ±‚
            watchlistTagsMap = {};
            data.data.forEach(item => {
                watchlistTagsMap[item.id] = item.tags || [];
            });
            
            renderWatchlistCards(data.data);

        } catch (e) {
            console.error('è¼‰å…¥è¿½è¹¤æ¸…å–®å¤±æ•—:', e);
            if (container) {
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            }
        }
    }

    async function loadAllWatchlistTags(items) {
        watchlistTagsMap = {};

        const promises = items.map(async item => {
            try {
                if (typeof getWatchlistTags === 'function') {
                    const tags = await getWatchlistTags(item.id);
                    watchlistTagsMap[item.id] = tags;
                }
            } catch (e) {
                watchlistTagsMap[item.id] = [];
            }
        });

        await Promise.all(promises);
    }

    async function addToWatchlist() {
        const symbol = $('addSymbol')?.value?.trim().toUpperCase();
        const assetType = $('addAssetType')?.value || 'stock';
        const note = $('addNote')?.value?.trim() || null;

        if (!symbol) {
            showToast('è«‹è¼¸å…¥ä»£è™Ÿ');
            return;
        }

        try {
            const res = await apiRequest('/api/watchlist', {
                method: 'POST',
                body: { symbol, asset_type: assetType, note }
            });

            const data = await res.json();

            if (data.success) {
                showToast('å·²æ–°å¢è‡³è¿½è¹¤æ¸…å–®');
                hideAddWatchlistModal();

                // âœ… P3: æ¨‚è§€æ›´æ–° AppState
                if (window.AppState) {
                    AppState.addToWatchlist({
                        id: data.data?.id,
                        symbol,
                        asset_type: assetType,
                        note,
                        added_at: new Date().toISOString()
                    });
                }

                loadWatchlist();
                if (typeof loadWatchlistOverview === 'function') {
                    loadWatchlistOverview();
                }
            } else {
                showToast(data.detail || 'æ–°å¢å¤±æ•—');
            }
        } catch (e) {
            console.error('æ–°å¢è¿½è¹¤å¤±æ•—:', e);
            showToast('æ–°å¢å¤±æ•—');
        }
    }

    async function removeFromWatchlist(symbol) {
        if (!confirm(`ç¢ºå®šè¦ç§»é™¤ ${symbol} å—ï¼Ÿ`)) return;

        try {
            const res = await apiRequest(`/api/watchlist/${encodeURIComponent(symbol)}`, {
                method: 'DELETE'
            });

            const data = await res.json();

            if (data.success) {
                showToast('å·²ç§»é™¤');

                // âœ… P3: æ›´æ–° AppState
                if (window.AppState) {
                    AppState.removeFromWatchlist(symbol);
                }

                loadWatchlist();
                if (typeof loadWatchlistOverview === 'function') {
                    loadWatchlistOverview();
                }
            } else {
                showToast(data.detail || 'ç§»é™¤å¤±æ•—');
            }
        } catch (e) {
            console.error('ç§»é™¤è¿½è¹¤å¤±æ•—:', e);
            showToast('ç§»é™¤å¤±æ•—');
        }
    }

    // ============================================================
    // Modal æ§åˆ¶
    // ============================================================

    function showAddWatchlistModal() {
        const modal = $('addWatchlistModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            $('addSymbol')?.focus();
        }
    }

    function hideAddWatchlistModal() {
        const modal = $('addWatchlistModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            if ($('addSymbol')) $('addSymbol').value = '';
            if ($('addNote')) $('addNote').value = '';
        }
    }

    function toggleWatchlistMenu() {
        const menu = $('watchlistMenu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    }

    // ============================================================
    // åŒ¯å‡ºåŒ¯å…¥
    // ============================================================

    function showImportWatchlistModal() {
        const modal = $('importWatchlistModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        const menu = $('watchlistMenu');
        if (menu) menu.classList.add('hidden');
    }

    function hideImportWatchlistModal() {
        const modal = $('importWatchlistModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        const preview = $('importWatchlistPreview');
        if (preview) preview.innerHTML = '';
    }

    async function exportWatchlist() {
        try {
            const res = await apiRequest('/api/watchlist/export');
            const data = await res.json();

            if (!data.success) {
                showToast('åŒ¯å‡ºå¤±æ•—');
                return;
            }

            const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `watchlist_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('åŒ¯å‡ºæˆåŠŸ');
        } catch (e) {
            console.error('åŒ¯å‡ºå¤±æ•—:', e);
            showToast('åŒ¯å‡ºå¤±æ•—');
        }
    }

    function previewWatchlistFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const preview = $('importWatchlistPreview');
        if (!preview) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let items = [];
                const content = e.target.result;

                if (file.name.endsWith('.json')) {
                    items = JSON.parse(content);
                } else if (file.name.endsWith('.csv')) {
                    const lines = content.split('\n').filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim());

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const item = {};
                        headers.forEach((h, idx) => {
                            item[h] = values[idx];
                        });
                        items.push(item);
                    }
                }

                preview.innerHTML = `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2">é è¦½ (${items.length} ç­†):</p>
                        <ul class="text-sm space-y-1 max-h-40 overflow-y-auto">
                            ${items.slice(0, 10).map(item => `
                                <li class="flex justify-between">
                                    <span class="font-medium">${item.symbol}</span>
                                    <span class="text-gray-500">${item.asset_type || 'stock'}</span>
                                </li>
                            `).join('')}
                            ${items.length > 10 ? `<li class="text-gray-400">...é‚„æœ‰ ${items.length - 10} ç­†</li>` : ''}
                        </ul>
                    </div>
                `;
            } catch (err) {
                preview.innerHTML = '<p class="text-red-500 text-sm mt-2">æª”æ¡ˆæ ¼å¼éŒ¯èª¤</p>';
            }
        };
        reader.readAsText(file);
    }

    async function importWatchlist() {
        const fileInput = $('importWatchlistFile');
        const file = fileInput?.files[0];

        if (!file) {
            showToast('è«‹é¸æ“‡æª”æ¡ˆ');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/api/watchlist/import', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                showToast(`åŒ¯å…¥æˆåŠŸ: ${data.imported} ç­†`);
                hideImportWatchlistModal();

                // æ¸…é™¤ AppState å¿«å–ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥
                if (window.AppState) {
                    AppState.set('watchlistLoaded', false);
                }

                loadWatchlist();
                if (typeof loadWatchlistOverview === 'function') {
                    loadWatchlistOverview();
                }
            } else {
                showToast(data.detail || 'åŒ¯å…¥å¤±æ•—');
            }
        } catch (e) {
            console.error('åŒ¯å…¥å¤±æ•—:', e);
            showToast('åŒ¯å…¥å¤±æ•—');
        }
    }

    // ============================================================
    // ç›®æ¨™åƒ¹è¨­å®š
    // ============================================================

    function showTargetPriceModal(itemId, symbol, currentTarget) {
        currentTargetItemId = itemId;

        const modal = $('targetPriceModal');
        const symbolEl = $('targetPriceSymbol');
        const input = $('targetPriceInput');

        if (symbolEl) symbolEl.textContent = symbol;
        if (input) input.value = currentTarget || '';

        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (input) input.focus();
        }
    }

    function hideTargetPriceModal() {
        const modal = $('targetPriceModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        currentTargetItemId = null;
    }

    async function saveTargetPrice() {
        if (!currentTargetItemId) return;

        const input = $('targetPriceInput');
        const targetPrice = parseFloat(input?.value);

        if (isNaN(targetPrice) || targetPrice <= 0) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®æ¨™åƒ¹');
            return;
        }

        try {
            const res = await apiRequest(`/api/watchlist/${currentTargetItemId}/target`, {
                method: 'PUT',
                body: { target_price: targetPrice }
            });

            const data = await res.json();

            if (data.success) {
                showToast('ç›®æ¨™åƒ¹å·²è¨­å®š');
                hideTargetPriceModal();
                loadWatchlist();
            } else {
                showToast(data.detail || 'è¨­å®šå¤±æ•—');
            }
        } catch (e) {
            console.error('è¨­å®šç›®æ¨™åƒ¹å¤±æ•—:', e);
            showToast('è¨­å®šå¤±æ•—');
        }
    }

    async function clearTargetPrice() {
        if (!currentTargetItemId) return;

        try {
            const res = await apiRequest(`/api/watchlist/${currentTargetItemId}/target`, {
                method: 'DELETE'
            });

            const data = await res.json();

            if (data.success) {
                showToast('å·²æ¸…é™¤ç›®æ¨™åƒ¹');
                hideTargetPriceModal();
                loadWatchlist();
            } else {
                showToast(data.detail || 'æ¸…é™¤å¤±æ•—');
            }
        } catch (e) {
            console.error('æ¸…é™¤ç›®æ¨™åƒ¹å¤±æ•—:', e);
            showToast('æ¸…é™¤å¤±æ•—');
        }
    }

    // ============================================================
    // å„€è¡¨æ¿å¿«è¦½
    // ============================================================

    async function loadWatchlistOverview() {
        const container = $('dashboardWatchlist');
        if (!container) return;

        const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : window.currentUser;

        if (!currentUser || !currentUser.id) {
            container.innerHTML = '<p class="text-red-500 text-center py-4">è«‹å…ˆç™»å…¥</p>';
            return;
        }

        try {
            const res = await apiRequest('/api/watchlist/with-prices');
            const data = await res.json();

            if (!data.success) {
                container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
                return;
            }

            if (!data.data || data.data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-star text-gray-300 text-3xl mb-2"></i>
                        <p class="text-gray-500 text-sm">å°šç„¡è¿½è¹¤æ¸…å–®</p>
                        <button data-action="goto-search" class="mt-2 text-blue-600 text-sm">å‰å¾€æŸ¥è©¢è‚¡ç¥¨</button>
                    </div>
                `;
                return;
            }

            const items = data.data.slice(0, 5);
            let html = '<div class="space-y-2" id="dashboardWatchlistItems">';

            for (const item of items) {
                const change = item.change_pct || 0;
                const changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';

                const priceText = item.price !== null && item.price !== undefined
                    ? `$${item.price.toLocaleString()}`
                    : '--';

                const changeText = item.price !== null && item.price !== undefined
                    ? `<span class="${changeClass} text-sm ml-1">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`
                    : '';

                const isCrypto = item.asset_type === 'crypto';
                const isTw = item.symbol.includes('.TW') || /^\d+$/.test(item.symbol);
                const market = isTw ? 'tw' : 'us';

                const tradeButtons = isCrypto ? '' : `
                    <button data-action="trade" data-symbol="${item.symbol}" data-name="${item.name || ''}" data-market="${market}" data-type="buy"
                            class="p-1.5 bg-green-100 text-green-600 rounded text-xs hover:bg-green-200">
                        <i class="fas fa-plus"></i>
                    </button>
                `;

                html += `
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center cursor-pointer" data-action="analyze" data-symbol="${item.symbol}">
                            <span class="font-medium text-gray-800">${item.symbol}</span>
                            <span class="text-gray-500 text-sm ml-2">${priceText}</span>
                            ${changeText}
                        </div>
                        <div class="flex items-center gap-1">
                            ${tradeButtons}
                            <button data-action="analyze" data-symbol="${item.symbol}" class="p-1.5 bg-orange-100 text-orange-600 rounded text-xs hover:bg-orange-200">
                                <i class="fas fa-chart-line"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;

            // åˆå§‹åŒ–å„€è¡¨æ¿äº‹ä»¶å§”è¨—
            container.addEventListener('click', handleWatchlistClick);

        } catch (e) {
            console.error('è¼‰å…¥è¿½è¹¤å¿«è¦½å¤±æ•—:', e);
            container.innerHTML = '<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—</p>';
        }
    }

    // ============================================================
    // å°å‡º
    // ============================================================

    // æ›è¼‰åˆ° SELA å‘½åç©ºé–“
    if (window.SELA) {
        window.SELA.watchlist = {
            load: loadWatchlist,
            loadOverview: loadWatchlistOverview,
            add: addToWatchlist,
            remove: removeFromWatchlist,
            changeSort: changeWatchlistSort,
            exportData: exportWatchlist,
            importData: importWatchlist
        };
    }

    // å…¨åŸŸå°å‡ºï¼ˆå‘å¾Œå…¼å®¹ï¼‰
    window.loadWatchlist = loadWatchlist;
    window.loadWatchlistOverview = loadWatchlistOverview;
    window.addToWatchlist = addToWatchlist;
    window.removeFromWatchlist = removeFromWatchlist;
    window.changeWatchlistSort = changeWatchlistSort;
    window.showAddWatchlistModal = showAddWatchlistModal;
    window.hideAddWatchlistModal = hideAddWatchlistModal;
    window.toggleWatchlistMenu = toggleWatchlistMenu;
    window.showImportWatchlistModal = showImportWatchlistModal;
    window.hideImportWatchlistModal = hideImportWatchlistModal;
    window.exportWatchlist = exportWatchlist;
    window.previewWatchlistFile = previewWatchlistFile;
    window.importWatchlist = importWatchlist;
    window.showTargetPriceModal = showTargetPriceModal;
    window.hideTargetPriceModal = hideTargetPriceModal;
    window.saveTargetPrice = saveTargetPrice;
    window.clearTargetPrice = clearTargetPrice;

    console.log('â­ watchlist.js æ¨¡çµ„å·²è¼‰å…¥ (P3 å„ªåŒ–ç‰ˆ)');
})();
```

======================================================================
## ğŸ“ å…¶ä»–æª”æ¡ˆ
======================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/__init__.py  â­
> Stock Analysis System
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Stock Analysis System
å¤šç”¨æˆ¶è‚¡ç¥¨èˆ‡åŠ å¯†è²¨å¹£æŠ€è¡“åˆ†æå¹³å°
"""
__version__ = "0.1.0"
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/cli.py  â­
> è‚¡ç¥¨åˆ†æç³»çµ± CLI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
#!/usr/bin/env python3
"""
è‚¡ç¥¨åˆ†æç³»çµ± CLI
å‘½ä»¤åˆ—æŸ¥è©¢ä»‹é¢
"""
import sys
import argparse
from datetime import datetime
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.text import Text
from rich import box

from app.database import init_db_sync, get_sync_session
from app.services.stock_service import StockService
from app.services.crypto_service import CryptoService
from app.services.chart_service import chart_service
from app.data_sources.coingecko import CRYPTO_MAP
from app.config import settings

console = Console()

# æ”¯æ´çš„åŠ å¯†è²¨å¹£ä»£è™Ÿ
SUPPORTED_CRYPTO = set(k for k in CRYPTO_MAP.keys() if k not in ("BITCOIN", "ETHEREUM"))


def print_header():
    """é¡¯ç¤ºæ¨™é¡Œ"""
    console.print()
    console.print(Panel.fit(
        "[bold orange1]ğŸ“ˆ è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ±[/bold orange1]\n"
        f"[dim]ç‰ˆæœ¬ {settings.APP_VERSION}[/dim]",
        border_style="orange1",
    ))
    console.print()


def is_crypto(symbol: str) -> bool:
    """åˆ¤æ–·æ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£"""
    return symbol.upper() in SUPPORTED_CRYPTO


def print_stock_analysis(analysis: dict):
    """é¡¯ç¤ºè‚¡ç¥¨åˆ†æå ±å‘Š"""
    symbol = analysis["symbol"]
    name = analysis["name"]
    price_info = analysis["price"]
    change_info = analysis["change"]
    volume_info = analysis.get("volume", {})
    indicators = analysis["indicators"]
    signals = analysis["signals"]
    score = analysis["score"]
    
    # æ¨™é¡Œ
    console.print(Panel(
        f"[bold]{symbol}[/bold] - {name}",
        border_style="blue",
    ))
    
    # åƒ¹æ ¼è³‡è¨Š
    price_table = Table(title="ğŸ’° åƒ¹æ ¼è³‡è¨Š", box=box.ROUNDED, show_header=False)
    price_table.add_column("é …ç›®", style="cyan")
    price_table.add_column("æ•¸å€¼", justify="right")
    
    current_price = price_info["current"]
    price_table.add_row("ç¾åƒ¹", f"[bold green]${current_price:,.2f}[/bold green]")
    
    if price_info.get("high_52w"):
        price_table.add_row("52é€±æœ€é«˜", f"${price_info['high_52w']:,.2f}")
    if price_info.get("low_52w"):
        price_table.add_row("52é€±æœ€ä½", f"${price_info['low_52w']:,.2f}")
    if price_info.get("from_high_pct"):
        pct = price_info["from_high_pct"]
        color = "red" if pct < 0 else "green"
        price_table.add_row("è·é«˜é»", f"[{color}]{pct:+.2f}%[/{color}]")
    if price_info.get("from_low_pct"):
        pct = price_info["from_low_pct"]
        color = "green" if pct > 0 else "red"
        price_table.add_row("è·ä½é»", f"[{color}]{pct:+.2f}%[/{color}]")
    
    console.print(price_table)
    console.print()
    
    # æ¼²è·Œå¹…
    change_table = Table(title="ğŸ“Š æ¼²è·Œå¹…", box=box.ROUNDED)
    change_table.add_column("æ—¥", justify="center")
    change_table.add_column("é€±", justify="center")
    change_table.add_column("æœˆ", justify="center")
    change_table.add_column("å­£", justify="center")
    change_table.add_column("å¹´", justify="center")
    
    def format_change(val):
        if val is None:
            return "-"
        color = "green" if val >= 0 else "red"
        return f"[{color}]{val:+.2f}%[/{color}]"
    
    change_table.add_row(
        format_change(change_info.get("day")),
        format_change(change_info.get("week")),
        format_change(change_info.get("month")),
        format_change(change_info.get("quarter")),
        format_change(change_info.get("year")),
    )
    
    console.print(change_table)
    console.print()
    
    # æˆäº¤é‡
    if volume_info:
        vol_table = Table(title="ğŸ“ˆ æˆäº¤é‡", box=box.ROUNDED, show_header=False)
        vol_table.add_column("é …ç›®", style="cyan")
        vol_table.add_column("æ•¸å€¼", justify="right")
        
        vol_table.add_row("ä»Šæ—¥æˆäº¤é‡", f"{volume_info.get('today', 0):,}")
        if volume_info.get("avg_20d"):
            vol_table.add_row("20æ—¥å‡é‡", f"{volume_info['avg_20d']:,}")
        if volume_info.get("ratio"):
            ratio = volume_info["ratio"]
            color = "yellow" if ratio >= 2.0 else ("green" if ratio >= 1.0 else "dim")
            vol_table.add_row("é‡æ¯”", f"[{color}]{ratio:.2f}[/{color}]")
        
        console.print(vol_table)
        console.print()
    
    # æŠ€è¡“æŒ‡æ¨™
    _print_indicators(indicators)
    
    # è¨Šè™Ÿ
    if signals:
        signal_panel = Panel(
            "\n".join([f"â€¢ {s['description']}" for s in signals]),
            title="âš¡ æœ€æ–°è¨Šè™Ÿ",
            border_style="yellow",
        )
        console.print(signal_panel)
        console.print()
    
    # ç¶œåˆè©•åˆ†
    _print_score(score)
    
    # æ›´æ–°æ™‚é–“
    console.print()
    console.print(f"[dim]æ›´æ–°æ™‚é–“: {analysis.get('updated_at', '-')}[/dim]")


def print_crypto_analysis(analysis: dict):
    """é¡¯ç¤ºåŠ å¯†è²¨å¹£åˆ†æå ±å‘Š"""
    symbol = analysis["symbol"]
    name = analysis["name"]
    price_info = analysis["price"]
    change_info = analysis["change"]
    market_info = analysis.get("market", {})
    indicators = analysis["indicators"]
    signals = analysis["signals"]
    score = analysis["score"]
    
    # æ¨™é¡Œ
    console.print(Panel(
        f"[bold]{symbol}[/bold] - {name} [dim](åŠ å¯†è²¨å¹£)[/dim]",
        border_style="yellow",
    ))
    
    # åƒ¹æ ¼è³‡è¨Š
    price_table = Table(title="ğŸ’° åƒ¹æ ¼è³‡è¨Š", box=box.ROUNDED, show_header=False)
    price_table.add_column("é …ç›®", style="cyan")
    price_table.add_column("æ•¸å€¼", justify="right")
    
    current_price = price_info["current"]
    if current_price >= 1000:
        price_table.add_row("ç¾åƒ¹", f"[bold green]${current_price:,.2f}[/bold green]")
    else:
        price_table.add_row("ç¾åƒ¹", f"[bold green]${current_price:,.4f}[/bold green]")
    
    if price_info.get("ath"):
        price_table.add_row("æ­·å²æœ€é«˜ (ATH)", f"${price_info['ath']:,.2f}")
    if price_info.get("from_ath_pct"):
        pct = price_info["from_ath_pct"]
        color = "red" if pct < 0 else "green"
        price_table.add_row("è· ATH", f"[{color}]{pct:+.2f}%[/{color}]")
    if price_info.get("high_24h"):
        price_table.add_row("24H æœ€é«˜", f"${price_info['high_24h']:,.2f}")
    if price_info.get("low_24h"):
        price_table.add_row("24H æœ€ä½", f"${price_info['low_24h']:,.2f}")
    
    console.print(price_table)
    console.print()
    
    # å¸‚å ´è³‡è¨Š
    if market_info:
        market_table = Table(title="ğŸŒ å¸‚å ´è³‡è¨Š", box=box.ROUNDED, show_header=False)
        market_table.add_column("é …ç›®", style="cyan")
        market_table.add_column("æ•¸å€¼", justify="right")
        
        if market_info.get("market_cap"):
            market_table.add_row("å¸‚å€¼", f"${market_info['market_cap']:,.0f}")
        if market_info.get("market_cap_rank"):
            market_table.add_row("å¸‚å€¼æ’å", f"#{market_info['market_cap_rank']}")
        if market_info.get("volume_24h"):
            market_table.add_row("24H æˆäº¤é‡", f"${market_info['volume_24h']:,.0f}")
        
        console.print(market_table)
        console.print()
    
    # æ¼²è·Œå¹…
    change_table = Table(title="ğŸ“Š æ¼²è·Œå¹…", box=box.ROUNDED)
    change_table.add_column("24H", justify="center")
    change_table.add_column("7D", justify="center")
    change_table.add_column("30D", justify="center")
    change_table.add_column("1Y", justify="center")
    
    def format_change(val):
        if val is None:
            return "-"
        color = "green" if val >= 0 else "red"
        return f"[{color}]{val:+.2f}%[/{color}]"
    
    change_table.add_row(
        format_change(change_info.get("day")),
        format_change(change_info.get("week")),
        format_change(change_info.get("month")),
        format_change(change_info.get("year")),
    )
    
    console.print(change_table)
    console.print()
    
    # æŠ€è¡“æŒ‡æ¨™
    _print_crypto_indicators(indicators)
    
    # è¨Šè™Ÿ
    if signals:
        signal_panel = Panel(
            "\n".join([f"â€¢ {s['description']}" for s in signals]),
            title="âš¡ æœ€æ–°è¨Šè™Ÿ",
            border_style="yellow",
        )
        console.print(signal_panel)
        console.print()
    
    # ç¶œåˆè©•åˆ†
    _print_score(score)
    
    # æ›´æ–°æ™‚é–“
    console.print()
    console.print(f"[dim]æ›´æ–°æ™‚é–“: {analysis.get('updated_at', '-')}[/dim]")


def _print_indicators(indicators: dict):
    """åˆ—å°æŠ€è¡“æŒ‡æ¨™ï¼ˆè‚¡ç¥¨ç‰ˆï¼‰"""
    ind_table = Table(title="ğŸ“ æŠ€è¡“æŒ‡æ¨™", box=box.ROUNDED)
    ind_table.add_column("æŒ‡æ¨™", style="cyan")
    ind_table.add_column("æ•¸å€¼", justify="right")
    ind_table.add_column("ç‹€æ…‹", justify="center")
    
    # MA
    ma = indicators.get("ma", {})
    alignment = ma.get("alignment", "neutral")
    alignment_text = {
        "bullish": "[green]å¤šé ­æ’åˆ—[/green]",
        "bearish": "[red]ç©ºé ­æ’åˆ—[/red]",
        "neutral": "[yellow]ç›¤æ•´[/yellow]",
    }.get(alignment, alignment)
    
    for ma_key in [f"ma{settings.MA_SHORT}", f"ma{settings.MA_MID}", f"ma{settings.MA_LONG}"]:
        val = ma.get(ma_key)
        pos = ma.get(f"price_vs_{ma_key}")
        pos_text = "[green]â–²[/green]" if pos == "above" else "[red]â–¼[/red]" if pos == "below" else ""
        ind_table.add_row(
            ma_key.upper(),
            f"${val:,.2f}" if val else "-",
            pos_text,
        )
    
    ind_table.add_row("æ’åˆ—", "", alignment_text)
    
    # RSI
    rsi = indicators.get("rsi", {})
    rsi_val = rsi.get("value")
    rsi_status = rsi.get("status", "")
    rsi_color = "red" if rsi_status == "overbought" else "green" if rsi_status == "oversold" else "white"
    rsi_status_text = {
        "overbought": "[red]è¶…è²·[/red]",
        "oversold": "[green]è¶…è³£[/green]",
        "neutral": "ä¸­æ€§",
    }.get(rsi_status, rsi_status)
    
    ind_table.add_row(
        "RSI",
        f"[{rsi_color}]{rsi_val:.1f}[/{rsi_color}]" if rsi_val else "-",
        rsi_status_text,
    )
    
    # MACD
    macd = indicators.get("macd", {})
    macd_hist = macd.get("histogram")
    macd_status = macd.get("status", "")
    macd_color = "green" if macd_status == "bullish" else "red"
    
    ind_table.add_row(
        "MACD æŸ±",
        f"[{macd_color}]{macd_hist:.4f}[/{macd_color}]" if macd_hist is not None else "-",
        f"[{macd_color}]{'å¤š' if macd_status == 'bullish' else 'ç©º'}[/{macd_color}]",
    )
    
    # Bollinger
    bb = indicators.get("bollinger", {})
    bb_pos = bb.get("position", "")
    bb_pos_text = {
        "above_upper": "[red]è¶…å‡ºä¸Šè»Œ[/red]",
        "below_lower": "[green]è·Œç ´ä¸‹è»Œ[/green]",
        "upper_half": "é€šé“ä¸ŠåŠ",
        "lower_half": "é€šé“ä¸‹åŠ",
    }.get(bb_pos, bb_pos)
    
    ind_table.add_row(
        "å¸ƒæ—",
        f"â†‘{bb.get('upper'):.2f} â†“{bb.get('lower'):.2f}" if bb.get("upper") else "-",
        bb_pos_text,
    )
    
    console.print(ind_table)
    console.print()


def _print_crypto_indicators(indicators: dict):
    """åˆ—å°æŠ€è¡“æŒ‡æ¨™ï¼ˆåŠ å¯†è²¨å¹£ç‰ˆï¼‰"""
    ind_table = Table(title="ğŸ“ æŠ€è¡“æŒ‡æ¨™", box=box.ROUNDED)
    ind_table.add_column("æŒ‡æ¨™", style="cyan")
    ind_table.add_column("æ•¸å€¼", justify="right")
    ind_table.add_column("ç‹€æ…‹", justify="center")
    
    # MAï¼ˆå¹£åœˆé€±æœŸï¼‰
    ma = indicators.get("ma", {})
    alignment = ma.get("alignment", "neutral")
    alignment_text = {
        "bullish": "[green]å¤šé ­æ’åˆ—[/green]",
        "bearish": "[red]ç©ºé ­æ’åˆ—[/red]",
        "neutral": "[yellow]ç›¤æ•´[/yellow]",
    }.get(alignment, alignment)
    
    for ma_key in ["ma7", "ma25", "ma99"]:
        val = ma.get(ma_key)
        ind_table.add_row(
            ma_key.upper(),
            f"${val:,.2f}" if val else "-",
            "",
        )
    
    ind_table.add_row("æ’åˆ—", "", alignment_text)
    
    # RSI
    rsi = indicators.get("rsi", {})
    rsi_val = rsi.get("value")
    rsi_status = rsi.get("status", "")
    rsi_color = "red" if rsi_status == "overbought" else "green" if rsi_status == "oversold" else "white"
    rsi_status_text = {
        "overbought": "[red]è¶…è²·[/red]",
        "oversold": "[green]è¶…è³£[/green]",
        "neutral": "ä¸­æ€§",
    }.get(rsi_status, rsi_status)
    
    ind_table.add_row(
        "RSI",
        f"[{rsi_color}]{rsi_val:.1f}[/{rsi_color}]" if rsi_val else "-",
        rsi_status_text,
    )
    
    # MACD
    macd = indicators.get("macd", {})
    macd_hist = macd.get("histogram")
    macd_status = macd.get("status", "")
    macd_color = "green" if macd_status == "bullish" else "red"
    
    ind_table.add_row(
        "MACD",
        f"[{macd_color}]{macd_hist:.2f}[/{macd_color}]" if macd_hist is not None else "-",
        f"[{macd_color}]{'å¤š' if macd_status == 'bullish' else 'ç©º'}[/{macd_color}]",
    )
    
    console.print(ind_table)
    console.print()


def _print_score(score: dict):
    """åˆ—å°ç¶œåˆè©•åˆ†"""
    buy_score = score.get("buy_score", 0)
    sell_score = score.get("sell_score", 0)
    rating = score.get("rating", "neutral")
    details = score.get("details", [])
    
    rating_text = {
        "strong_buy": "[bold green]å¼·çƒˆè²·é€² â­â­â­â­â­[/bold green]",
        "buy": "[green]è²·é€² â­â­â­â­[/green]",
        "neutral": "[yellow]ä¸­æ€§ â­â­â­[/yellow]",
        "sell": "[red]è³£å‡º â­â­[/red]",
        "strong_sell": "[bold red]å¼·çƒˆè³£å‡º â­[/bold red]",
        "insufficient_data": "[dim]è³‡æ–™ä¸è¶³[/dim]",
    }.get(rating, rating)
    
    score_content = f"è²·é€²è¨Šè™Ÿ: {buy_score} / è³£å‡ºè¨Šè™Ÿ: {sell_score}\n"
    score_content += f"ç¶œåˆè©•ç­‰: {rating_text}\n\n"
    if details:
        score_content += "\n".join(details)
    
    console.print(Panel(
        score_content,
        title="ğŸ¯ ç¶œåˆè©•åˆ†",
        border_style="magenta",
    ))


def print_sentiment(sentiment: dict):
    """é¡¯ç¤ºå¸‚å ´æƒ…ç·’"""
    console.print(Panel.fit(
        "[bold]ğŸ“Š å¸‚å ´æƒ…ç·’æŒ‡æ•¸[/bold]",
        border_style="cyan",
    ))
    
    sent_table = Table(box=box.ROUNDED)
    sent_table.add_column("å¸‚å ´", style="cyan")
    sent_table.add_column("æŒ‡æ•¸", justify="center")
    sent_table.add_column("ç‹€æ…‹", justify="center")
    sent_table.add_column("å»ºè­°", justify="left")
    
    from app.data_sources.fear_greed import fear_greed as fg_client
    
    for market, data in sentiment.items():
        if not data:
            continue
        
        value = data.get("value", 0)
        classification_zh = data.get("classification_zh", "")
        
        # æ ¹æ“šæ•¸å€¼æ±ºå®šé¡è‰²
        if value <= 25:
            color = "green"
            emoji = "ğŸ˜±"
        elif value <= 45:
            color = "cyan"
            emoji = "ğŸ˜Ÿ"
        elif value <= 55:
            color = "yellow"
            emoji = "ğŸ˜"
        elif value <= 75:
            color = "orange1"
            emoji = "ğŸ˜Š"
        else:
            color = "red"
            emoji = "ğŸ¤‘"
        
        market_name = "ç¾è‚¡" if market == "stock" else "åŠ å¯†è²¨å¹£"
        advice = fg_client.get_sentiment_advice(value)
        
        sent_table.add_row(
            market_name,
            f"[{color}]{value}[/{color}] {emoji}",
            f"[{color}]{classification_zh}[/{color}]",
            advice[:30] + "..." if len(advice) > 30 else advice,
        )
    
    console.print(sent_table)


def cmd_query(args):
    """æŸ¥è©¢è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£"""
    symbol = args.symbol.upper()
    
    db = get_sync_session()
    try:
        if is_crypto(symbol):
            # åŠ å¯†è²¨å¹£
            with console.status(f"[bold green]æ­£åœ¨åˆ†æ {symbol} (åŠ å¯†è²¨å¹£)..."):
                service = CryptoService(db)
                analysis = service.get_crypto_analysis(symbol, force_refresh=args.refresh)
                
                if analysis is None:
                    console.print(f"[red]âŒ æ‰¾ä¸åˆ°åŠ å¯†è²¨å¹£: {symbol}[/red]")
                    return 1
                
                print_crypto_analysis(analysis)
        else:
            # è‚¡ç¥¨
            with console.status(f"[bold green]æ­£åœ¨åˆ†æ {symbol}..."):
                service = StockService(db)
                analysis = service.get_stock_analysis(symbol, force_refresh=args.refresh)
                
                if analysis is None:
                    console.print(f"[red]âŒ æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}[/red]")
                    return 1
                
                print_stock_analysis(analysis)
        
        return 0
    finally:
        db.close()


def cmd_sentiment(args):
    """æŸ¥è©¢å¸‚å ´æƒ…ç·’"""
    with console.status("[bold green]æ­£åœ¨å–å¾—å¸‚å ´æƒ…ç·’..."):
        db = get_sync_session()
        try:
            service = CryptoService(db)
            sentiment = service.get_market_sentiment("all")
            
            if not sentiment:
                console.print("[yellow]âš ï¸ ç„¡æ³•å–å¾—å¸‚å ´æƒ…ç·’è³‡æ–™[/yellow]")
                return 1
            
            print_sentiment(sentiment)
            return 0
        finally:
            db.close()


def cmd_chart(args):
    """ç”Ÿæˆåœ–è¡¨"""
    symbol = args.symbol.upper()
    
    db = get_sync_session()
    try:
        if is_crypto(symbol):
            service = CryptoService(db)
            with console.status(f"[bold green]æ­£åœ¨ç”Ÿæˆ {symbol} åœ–è¡¨..."):
                df = service.get_crypto_data(symbol)
        else:
            service = StockService(db)
            with console.status(f"[bold green]æ­£åœ¨ç”Ÿæˆ {symbol} åœ–è¡¨..."):
                df = service.get_stock_data(symbol)
        
        if df is None:
            console.print(f"[red]âŒ ç„¡æ³•å–å¾—è³‡æ–™: {symbol}[/red]")
            return 1
        
        # ç”Ÿæˆåœ–è¡¨
        chart_path = chart_service.plot_stock_analysis(
            df,
            symbol,
            days=args.days,
            show_kd=args.kd,
        )
        
        console.print(f"[green]âœ… åœ–è¡¨å·²å„²å­˜: {chart_path}[/green]")
        return 0
        
    finally:
        db.close()


def cmd_refresh(args):
    """æ›´æ–°è³‡æ–™"""
    symbol = args.symbol.upper()
    
    db = get_sync_session()
    try:
        if is_crypto(symbol):
            with console.status(f"[bold green]æ­£åœ¨æ›´æ–° {symbol}..."):
                service = CryptoService(db)
                success = service.fetch_and_cache_crypto(symbol)
        else:
            with console.status(f"[bold green]æ­£åœ¨æ›´æ–° {symbol}..."):
                service = StockService(db)
                success = service.fetch_and_cache_stock(symbol)
        
        if success:
            console.print(f"[green]âœ… å·²æ›´æ–° {symbol} è³‡æ–™[/green]")
            return 0
        else:
            console.print(f"[red]âŒ æ›´æ–°å¤±æ•—: {symbol}[/red]")
            return 1
    finally:
        db.close()


def cmd_init(args):
    """åˆå§‹åŒ–è³‡æ–™åº«"""
    with console.status("[bold green]æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«..."):
        init_db_sync()
    console.print("[green]âœ… è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ[/green]")
    return 0


def main():
    """ä¸»ç¨‹å¼"""
    parser = argparse.ArgumentParser(
        description="è‚¡ç¥¨æŠ€è¡“åˆ†æç³»çµ±",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    
    subparsers = parser.add_subparsers(dest="command", help="å¯ç”¨æŒ‡ä»¤")
    
    # init æŒ‡ä»¤
    init_parser = subparsers.add_parser("init", help="åˆå§‹åŒ–è³‡æ–™åº«")
    init_parser.set_defaults(func=cmd_init)
    
    # query æŒ‡ä»¤
    query_parser = subparsers.add_parser("query", help="æŸ¥è©¢è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£")
    query_parser.add_argument("symbol", help="ä»£è™Ÿ (è‚¡ç¥¨å¦‚ AAPL, åŠ å¯†è²¨å¹£å¦‚ BTC)")
    query_parser.add_argument("-r", "--refresh", action="store_true", help="å¼·åˆ¶æ›´æ–°è³‡æ–™")
    query_parser.set_defaults(func=cmd_query)
    
    # sentiment æŒ‡ä»¤
    sentiment_parser = subparsers.add_parser("sentiment", help="æŸ¥è©¢å¸‚å ´æƒ…ç·’")
    sentiment_parser.set_defaults(func=cmd_sentiment)
    
    # chart æŒ‡ä»¤
    chart_parser = subparsers.add_parser("chart", help="ç”ŸæˆæŠ€è¡“åˆ†æåœ–è¡¨")
    chart_parser.add_argument("symbol", help="ä»£è™Ÿ")
    chart_parser.add_argument("-d", "--days", type=int, default=120, help="é¡¯ç¤ºå¤©æ•¸ (é è¨­ 120)")
    chart_parser.add_argument("--kd", action="store_true", help="é¡¯ç¤º KD æŒ‡æ¨™")
    chart_parser.set_defaults(func=cmd_chart)
    
    # refresh æŒ‡ä»¤
    refresh_parser = subparsers.add_parser("refresh", help="æ›´æ–°è³‡æ–™")
    refresh_parser.add_argument("symbol", help="ä»£è™Ÿ")
    refresh_parser.set_defaults(func=cmd_refresh)
    
    # è§£æåƒæ•¸
    args = parser.parse_args()
    
    print_header()
    
    if not args.command:
        # äº’å‹•æ¨¡å¼
        console.print("[cyan]è¼¸å…¥ä»£è™Ÿé€²è¡ŒæŸ¥è©¢ (è‚¡ç¥¨å¦‚ AAPLï¼ŒåŠ å¯†è²¨å¹£å¦‚ BTC)[/cyan]")
        console.print("[cyan]è¼¸å…¥ 'sentiment' æŸ¥çœ‹å¸‚å ´æƒ…ç·’ï¼Œ'q' é›¢é–‹[/cyan]")
        console.print()
        
        init_db_sync()
        db = get_sync_session()
        stock_service = StockService(db)
        crypto_service = CryptoService(db)
        
        try:
            while True:
                try:
                    user_input = console.input("[bold]ä»£è™Ÿ> [/bold]").strip().upper()
                    
                    if user_input in ("Q", "QUIT", "EXIT"):
                        console.print("[yellow]å†è¦‹ï¼[/yellow]")
                        break
                    
                    if not user_input:
                        continue
                    
                    if user_input == "SENTIMENT":
                        sentiment = crypto_service.get_market_sentiment("all")
                        if sentiment:
                            print_sentiment(sentiment)
                        else:
                            console.print("[yellow]âš ï¸ ç„¡æ³•å–å¾—å¸‚å ´æƒ…ç·’[/yellow]")
                        console.print()
                        continue
                    
                    # æŸ¥è©¢è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£
                    if is_crypto(user_input):
                        with console.status(f"[bold green]æ­£åœ¨åˆ†æ {user_input}..."):
                            analysis = crypto_service.get_crypto_analysis(user_input)
                        if analysis:
                            print_crypto_analysis(analysis)
                        else:
                            console.print(f"[red]âŒ æ‰¾ä¸åˆ°: {user_input}[/red]")
                    else:
                        with console.status(f"[bold green]æ­£åœ¨åˆ†æ {user_input}..."):
                            analysis = stock_service.get_stock_analysis(user_input)
                        if analysis:
                            print_stock_analysis(analysis)
                        else:
                            console.print(f"[red]âŒ æ‰¾ä¸åˆ°: {user_input}[/red]")
                    
                    console.print()
                    
                except KeyboardInterrupt:
                    console.print("\n[yellow]å†è¦‹ï¼[/yellow]")
                    break
        finally:
            db.close()
        
        return 0
    
    # åŸ·è¡ŒæŒ‡ä»¤
    return args.func(args)


if __name__ == "__main__":
    sys.exit(main())
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/__init__.py  â­
> å¤–éƒ¨è³‡æ–™ä¾†æºæ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¤–éƒ¨è³‡æ–™ä¾†æºæ¨¡çµ„
"""
from app.data_sources.yahoo_finance import yahoo_finance
from app.data_sources.coingecko import coingecko
from app.data_sources.fear_greed import fear_greed

__all__ = [
    "yahoo_finance",
    "coingecko",
    "fear_greed",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/coingecko.py  â­
> CoinGecko API è³‡æ–™ä¾†æº
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
CoinGecko API è³‡æ–™ä¾†æº
æŠ“å–åŠ å¯†è²¨å¹£åƒ¹æ ¼è³‡æ–™
"""
import requests
import pandas as pd
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
import logging
import time

logger = logging.getLogger(__name__)

# CoinGecko API åŸºç¤ URL
BASE_URL = "https://api.coingecko.com/api/v3"

# æ”¯æ´çš„åŠ å¯†è²¨å¹£å°æ‡‰
CRYPTO_MAP = {
    "BTC": "bitcoin",
    "ETH": "ethereum",
    "BITCOIN": "bitcoin",
    "ETHEREUM": "ethereum",
}


class CoinGeckoClient:
    """CoinGecko API å®¢æˆ¶ç«¯"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "Accept": "application/json",
        })
        self._last_request_time = 0
        self._min_request_interval = 1.5  # å…è²» API é™åˆ¶ï¼š~30 æ¬¡/åˆ†é˜
    
    def _rate_limit(self):
        """é€Ÿç‡é™åˆ¶"""
        elapsed = time.time() - self._last_request_time
        if elapsed < self._min_request_interval:
            time.sleep(self._min_request_interval - elapsed)
        self._last_request_time = time.time()
    
    def _get(self, endpoint: str, params: dict = None) -> Optional[Dict]:
        """ç™¼é€ GET è«‹æ±‚"""
        self._rate_limit()
        
        try:
            url = f"{BASE_URL}/{endpoint}"
            logger.info(f"CoinGecko API è«‹æ±‚: {url}")
            response = self.session.get(url, params=params, timeout=15)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.Timeout as e:
            logger.error(f"CoinGecko API è«‹æ±‚è¶…æ™‚: {e}")
            return None
        except requests.exceptions.ConnectionError as e:
            logger.error(f"CoinGecko API é€£ç·šå¤±æ•— (å¯èƒ½è¢«ç¶²è·¯é™åˆ¶): {e}")
            return None
        except requests.exceptions.RequestException as e:
            logger.error(f"CoinGecko API è«‹æ±‚å¤±æ•—: {e}")
            return None
    
    def get_coin_id(self, symbol: str) -> Optional[str]:
        """å°‡ä»£è™Ÿè½‰æ›ç‚º CoinGecko ID"""
        symbol = symbol.upper()
        return CRYPTO_MAP.get(symbol)
    
    def get_current_price(self, symbols: List[str]) -> Optional[Dict[str, Any]]:
        """
        å–å¾—å³æ™‚åƒ¹æ ¼
        
        Args:
            symbols: ä»£è™Ÿåˆ—è¡¨ (å¦‚ ["BTC", "ETH"])
            
        Returns:
            {
                "BTC": {"price": 67850, "change_24h": 2.35, ...},
                "ETH": {"price": 3450, "change_24h": 1.82, ...}
            }
        """
        # è½‰æ›ä»£è™Ÿ
        coin_ids = []
        symbol_map = {}
        for symbol in symbols:
            coin_id = self.get_coin_id(symbol)
            if coin_id:
                coin_ids.append(coin_id)
                symbol_map[coin_id] = symbol.upper()
        
        if not coin_ids:
            return None
        
        params = {
            "ids": ",".join(coin_ids),
            "vs_currencies": "usd",
            "include_24hr_change": "true",
            "include_24hr_vol": "true",
            "include_market_cap": "true",
        }
        
        data = self._get("simple/price", params)
        if not data:
            return None
        
        result = {}
        for coin_id, values in data.items():
            symbol = symbol_map.get(coin_id, coin_id.upper())
            result[symbol] = {
                "price": values.get("usd"),
                "change_24h": values.get("usd_24h_change"),
                "volume_24h": values.get("usd_24h_vol"),
                "market_cap": values.get("usd_market_cap"),
            }
        
        return result
    
    def get_coin_info(self, symbol: str) -> Optional[Dict[str, Any]]:
        """
        å–å¾—åŠ å¯†è²¨å¹£è©³ç´°è³‡è¨Š
        
        Args:
            symbol: ä»£è™Ÿ (å¦‚ BTC, ETH)
            
        Returns:
            åŒ…å«åƒ¹æ ¼ã€å¸‚å€¼ã€æ­·å²é«˜é»ç­‰è³‡è¨Š
        """
        coin_id = self.get_coin_id(symbol)
        if not coin_id:
            logger.warning(f"ä¸æ”¯æ´çš„åŠ å¯†è²¨å¹£: {symbol}")
            return None
        
        params = {
            "localization": "false",
            "tickers": "false",
            "community_data": "false",
            "developer_data": "false",
        }
        
        data = self._get(f"coins/{coin_id}", params)
        if not data:
            return None
        
        market_data = data.get("market_data", {})
        
        return {
            "symbol": symbol.upper(),
            "name": data.get("name"),
            "current_price": market_data.get("current_price", {}).get("usd"),
            "market_cap": market_data.get("market_cap", {}).get("usd"),
            "market_cap_rank": market_data.get("market_cap_rank"),
            "total_volume": market_data.get("total_volume", {}).get("usd"),
            "high_24h": market_data.get("high_24h", {}).get("usd"),
            "low_24h": market_data.get("low_24h", {}).get("usd"),
            "price_change_24h": market_data.get("price_change_24h"),
            "price_change_percentage_24h": market_data.get("price_change_percentage_24h"),
            "price_change_percentage_7d": market_data.get("price_change_percentage_7d"),
            "price_change_percentage_30d": market_data.get("price_change_percentage_30d"),
            "price_change_percentage_1y": market_data.get("price_change_percentage_1y"),
            "ath": market_data.get("ath", {}).get("usd"),
            "ath_date": market_data.get("ath_date", {}).get("usd"),
            "ath_change_percentage": market_data.get("ath_change_percentage", {}).get("usd"),
            "atl": market_data.get("atl", {}).get("usd"),
            "atl_date": market_data.get("atl_date", {}).get("usd"),
            "circulating_supply": market_data.get("circulating_supply"),
            "total_supply": market_data.get("total_supply"),
            "last_updated": data.get("last_updated"),
        }
    
    def get_market_chart(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾—æ­·å²åƒ¹æ ¼è³‡æ–™
        
        Args:
            symbol: ä»£è™Ÿ (å¦‚ BTC, ETH)
            days: å¤©æ•¸ (æœ€å¤š 365 å¤©ï¼Œå…è²» API é™åˆ¶)
            
        Returns:
            DataFrame with columns: date, price, volume, market_cap
        """
        coin_id = self.get_coin_id(symbol)
        if not coin_id:
            return None
        
        params = {
            "vs_currency": "usd",
            "days": min(days, 365),  # å…è²» API é™åˆ¶
            "interval": "daily",
        }
        
        data = self._get(f"coins/{coin_id}/market_chart", params)
        if not data:
            return None
        
        # è§£æè³‡æ–™
        prices = data.get("prices", [])
        volumes = data.get("total_volumes", [])
        market_caps = data.get("market_caps", [])
        
        if not prices:
            return None
        
        records = []
        for i, (timestamp, price) in enumerate(prices):
            record = {
                "date": datetime.fromtimestamp(timestamp / 1000).date(),
                "price": price,
                "volume_24h": volumes[i][1] if i < len(volumes) else None,
                "market_cap": market_caps[i][1] if i < len(market_caps) else None,
            }
            records.append(record)
        
        df = pd.DataFrame(records)
        df["symbol"] = symbol.upper()
        
        # ç§»é™¤é‡è¤‡æ—¥æœŸï¼ˆä¿ç•™æœ€å¾Œä¸€ç­†ï¼‰
        df = df.drop_duplicates(subset=["date"], keep="last")
        df = df.sort_values("date").reset_index(drop=True)
        
        return df
    
    def get_ohlc(
        self,
        symbol: str,
        days: int = 365,
    ) -> Optional[pd.DataFrame]:
        """
        å–å¾— OHLC è³‡æ–™ï¼ˆKç·šè³‡æ–™ï¼‰
        
        Args:
            symbol: ä»£è™Ÿ
            days: å¤©æ•¸ (1/7/14/30/90/180/365/max)
            
        Returns:
            DataFrame with columns: date, open, high, low, close
        """
        coin_id = self.get_coin_id(symbol)
        if not coin_id:
            return None
        
        # CoinGecko OHLC åªæ”¯æ´ç‰¹å®šå¤©æ•¸
        valid_days = [1, 7, 14, 30, 90, 180, 365]
        days = min(valid_days, key=lambda x: abs(x - days))
        
        params = {
            "vs_currency": "usd",
            "days": days,
        }
        
        data = self._get(f"coins/{coin_id}/ohlc", params)
        if not data:
            return None
        
        records = []
        for item in data:
            timestamp, open_p, high, low, close = item
            records.append({
                "date": datetime.fromtimestamp(timestamp / 1000).date(),
                "open": open_p,
                "high": high,
                "low": low,
                "close": close,
            })
        
        df = pd.DataFrame(records)
        df["symbol"] = symbol.upper()
        
        # ç§»é™¤é‡è¤‡æ—¥æœŸ
        df = df.drop_duplicates(subset=["date"], keep="last")
        df = df.sort_values("date").reset_index(drop=True)
        
        return df
    
    def validate_symbol(self, symbol: str) -> bool:
        """é©—è­‰ä»£è™Ÿæ˜¯å¦æ”¯æ´"""
        return self.get_coin_id(symbol) is not None


# å»ºç«‹å…¨åŸŸå®¢æˆ¶ç«¯å¯¦ä¾‹
coingecko = CoinGeckoClient()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/fear_greed.py  â­
> å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™ä¾†æº
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å¸‚å ´æƒ…ç·’æŒ‡æ•¸è³‡æ–™ä¾†æº
- CNN Fear & Greed Index (ç¾è‚¡)
- Alternative.me (åŠ å¯†è²¨å¹£)
"""
import requests
from datetime import datetime, date
from typing import Optional, Dict, Any, List
import logging
import re

logger = logging.getLogger(__name__)


class FearGreedClient:
    """å¸‚å ´æƒ…ç·’æŒ‡æ•¸å®¢æˆ¶ç«¯"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        })
    
    # ==================== åŠ å¯†è²¨å¹£æƒ…ç·’ (Alternative.me) ====================
    
    def get_crypto_fear_greed(self, limit: int = 1) -> Optional[Dict[str, Any]]:
        """
        å–å¾—åŠ å¯†è²¨å¹£ Fear & Greed æŒ‡æ•¸
        ä¾†æº: Alternative.me
        
        Args:
            limit: å–å¾—å¤©æ•¸ (1 = åªå–ä»Šå¤©)
            
        Returns:
            {
                "value": 45,
                "classification": "fear",
                "classification_zh": "ææ‡¼",
                "timestamp": "2025-01-05",
                "history": [...]  # å¦‚æœ limit > 1
            }
        """
        try:
            url = "https://api.alternative.me/fng/"
            params = {"limit": limit}
            
            response = self.session.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            if not data.get("data"):
                return self._get_fallback_crypto()
            
            latest = data["data"][0]
            value = int(latest["value"])
            
            result = {
                "value": value,
                "classification": latest.get("value_classification", "").lower().replace(" ", "_"),
                "classification_zh": self._get_classification_zh(value),
                "timestamp": datetime.fromtimestamp(int(latest["timestamp"])).strftime("%Y-%m-%d"),
                "market": "crypto",
            }
            
            # å¦‚æœéœ€è¦æ­·å²è³‡æ–™
            if limit > 1:
                result["history"] = [
                    {
                        "value": int(item["value"]),
                        "classification": item.get("value_classification", "").lower().replace(" ", "_"),
                        "timestamp": datetime.fromtimestamp(int(item["timestamp"])).strftime("%Y-%m-%d"),
                    }
                    for item in data["data"]
                ]
            
            return result
            
        except Exception as e:
            logger.error(f"å–å¾—åŠ å¯†è²¨å¹£æƒ…ç·’æŒ‡æ•¸å¤±æ•—: {e}")
            return self._get_fallback_crypto()
    
    def _get_fallback_crypto(self) -> Dict[str, Any]:
        """åŠ å¯†è²¨å¹£æƒ…ç·’çš„å‚™ç”¨å€¼"""
        return {
            "value": 50,
            "classification": "neutral",
            "classification_zh": "ä¸­æ€§",
            "timestamp": date.today().strftime("%Y-%m-%d"),
            "market": "crypto",
            "is_fallback": True,
        }
    
    # ==================== ç¾è‚¡æƒ…ç·’ (CNN Fear & Greed) ====================
    
    def get_stock_fear_greed(self) -> Optional[Dict[str, Any]]:
        """
        å–å¾—ç¾è‚¡ Fear & Greed æŒ‡æ•¸
        ä¾†æº: CNN Business (é€éç¬¬ä¸‰æ–¹ API æˆ–çˆ¬èŸ²)
        
        Returns:
            {
                "value": 55,
                "classification": "neutral",
                "classification_zh": "ä¸­æ€§",
                "timestamp": "2025-01-05",
            }
        """
        # æ–¹æ³• 1: ä½¿ç”¨ CNN çš„éå®˜æ–¹ API
        result = self._get_cnn_fear_greed_api()
        if result:
            return result
        
        # æ–¹æ³• 2: ä½¿ç”¨å‚™ç”¨è³‡æ–™ä¾†æº
        result = self._get_fear_greed_alternative()
        if result:
            return result
        
        logger.warning("ç„¡æ³•å–å¾—ç¾è‚¡æƒ…ç·’æŒ‡æ•¸ï¼Œä½¿ç”¨å‚™ç”¨å€¼")
        # è¿”å›å‚™ç”¨å€¼è€Œé None
        return {
            "value": 50,
            "classification": "neutral",
            "classification_zh": "ä¸­æ€§",
            "timestamp": date.today().strftime("%Y-%m-%d"),
            "market": "stock",
            "is_fallback": True,
        }
    
    def _get_cnn_fear_greed_api(self) -> Optional[Dict[str, Any]]:
        """å¾ CNN API å–å¾— Fear & Greed"""
        try:
            # CNN çš„éå®˜æ–¹ API ç«¯é»
            url = "https://production.dataviz.cnn.io/index/fearandgreed/graphdata"
            
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            if not data.get("fear_and_greed"):
                return None
            
            fg_data = data["fear_and_greed"]
            value = int(round(fg_data.get("score", 0)))
            
            return {
                "value": value,
                "classification": self._get_classification(value),
                "classification_zh": self._get_classification_zh(value),
                "timestamp": date.today().strftime("%Y-%m-%d"),
                "market": "stock",
                "rating": fg_data.get("rating", ""),
            }
            
        except Exception as e:
            logger.debug(f"CNN API å–å¾—å¤±æ•—: {e}")
            return None
    
    def _get_fear_greed_alternative(self) -> Optional[Dict[str, Any]]:
        """å‚™ç”¨æ–¹æ³•ï¼šä½¿ç”¨å…¶ä»–è³‡æ–™ä¾†æº"""
        try:
            # å¯ä»¥ä½¿ç”¨å…¶ä»–å…¬é–‹ API æˆ–çˆ¬èŸ²
            # é€™è£¡æä¾›ä¸€å€‹æ¨¡æ“¬çš„å‚™ç”¨æ–¹æ¡ˆ
            
            # ä¾‹å¦‚å¾ rapidapi æˆ–å…¶ä»–ä¾†æºå–å¾—
            # ç›®å‰è¿”å› Noneï¼Œè¡¨ç¤ºç„¡æ³•å–å¾—
            return None
            
        except Exception as e:
            logger.debug(f"å‚™ç”¨ä¾†æºå–å¾—å¤±æ•—: {e}")
            return None
    
    # ==================== é€šç”¨æ–¹æ³• ====================
    
    def get_all_sentiment(self) -> Dict[str, Any]:
        """
        å–å¾—æ‰€æœ‰å¸‚å ´æƒ…ç·’
        
        Returns:
            {
                "stock": {...},
                "crypto": {...}
            }
        """
        result = {}
        
        # ç¾è‚¡æƒ…ç·’
        stock_sentiment = self.get_stock_fear_greed()
        if stock_sentiment:
            result["stock"] = stock_sentiment
        
        # åŠ å¯†è²¨å¹£æƒ…ç·’
        crypto_sentiment = self.get_crypto_fear_greed()
        if crypto_sentiment:
            result["crypto"] = crypto_sentiment
        
        return result
    
    def _get_classification(self, value: int) -> str:
        """å–å¾—è‹±æ–‡åˆ†é¡"""
        if value <= 25:
            return "extreme_fear"
        elif value <= 45:
            return "fear"
        elif value <= 55:
            return "neutral"
        elif value <= 75:
            return "greed"
        else:
            return "extreme_greed"
    
    def _get_classification_zh(self, value: int) -> str:
        """å–å¾—ä¸­æ–‡åˆ†é¡"""
        if value <= 25:
            return "æ¥µåº¦ææ‡¼"
        elif value <= 45:
            return "ææ‡¼"
        elif value <= 55:
            return "ä¸­æ€§"
        elif value <= 75:
            return "è²ªå©ª"
        else:
            return "æ¥µåº¦è²ªå©ª"
    
    def get_sentiment_advice(self, value: int) -> str:
        """æ ¹æ“šæƒ…ç·’å€¼å–å¾—å»ºè­°"""
        if value <= 25:
            return "å¸‚å ´æ¥µåº¦ææ‡¼ï¼Œå¯èƒ½æ˜¯è²·å…¥æ©Ÿæœƒï¼Œä½†éœ€è¬¹æ…"
        elif value <= 45:
            return "å¸‚å ´åææ‡¼ï¼Œç•™æ„æ½›åœ¨æ©Ÿæœƒ"
        elif value <= 55:
            return "å¸‚å ´ä¸­æ€§ï¼Œè§€æœ›ç‚ºä¸»"
        elif value <= 75:
            return "å¸‚å ´åæ¨‚è§€ï¼Œç•™æ„é¢¨éšª"
        else:
            return "å¸‚å ´æ¥µåº¦è²ªå©ªï¼Œå¯èƒ½æ˜¯ç²åˆ©äº†çµæ™‚æ©Ÿ"
    
    def get_crypto_fear_greed_history(self, days: int = 365) -> List[Dict[str, Any]]:
        """
        å–å¾—åŠ å¯†è²¨å¹£ Fear & Greed æ­·å²è³‡æ–™
        
        Args:
            days: å–å¾—å¤©æ•¸ï¼ˆæœ€å¤š 365 å¤©ï¼‰
            
        Returns:
            æ­·å²è³‡æ–™åˆ—è¡¨
        """
        try:
            url = "https://api.alternative.me/fng/"
            params = {"limit": min(days, 365)}
            
            response = self.session.get(url, params=params, timeout=15)
            response.raise_for_status()
            data = response.json()
            
            if not data.get("data"):
                return []
            
            history = []
            for item in data["data"]:
                value = int(item["value"])
                history.append({
                    "date": datetime.fromtimestamp(int(item["timestamp"])).strftime("%Y-%m-%d"),
                    "value": value,
                    "classification": item.get("value_classification", "").lower().replace(" ", "_"),
                    "classification_zh": self._get_classification_zh(value),
                })
            
            # åè½‰é †åºï¼Œè®“æœ€èˆŠçš„åœ¨å‰é¢
            history.reverse()
            
            return history
            
        except Exception as e:
            logger.error(f"å–å¾—åŠ å¯†è²¨å¹£æƒ…ç·’æ­·å²å¤±æ•—: {e}")
            return []


# å»ºç«‹å…¨åŸŸå®¢æˆ¶ç«¯å¯¦ä¾‹
fear_greed = FearGreedClient()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/taiwan_stocks.py  â­
> å°è‚¡åç¨±å°ç…§è¡¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
å°è‚¡åç¨±å°ç…§è¡¨
ç‰ˆæœ¬: 1.0.0
æ—¥æœŸ: 2026-01-12

è§£æ±º Yahoo Finance API è¿”å›çš„å°è‚¡åç¨± UTF-8 ç·¨ç¢¼å•é¡Œ
"""

# å¸¸è¦‹å°è‚¡åç¨±å°ç…§è¡¨ï¼ˆæ­£ç¢º UTF-8 ç·¨ç¢¼ï¼‰
TAIWAN_STOCK_NAMES = {
    # === ETF ===
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "0057": "å¯Œé‚¦æ‘©å°",
    "006205": "å¯Œé‚¦ä¸Šè­‰",
    "006206": "å…ƒå¤§ä¸Šè­‰50",
    "006208": "å¯Œé‚¦å°50",
    "00631L": "å…ƒå¤§å°ç£50æ­£2",
    "00632R": "å…ƒå¤§å°ç£50å1",
    "00635U": "å…ƒå¤§S&Pé»ƒé‡‘",
    "00636": "åœ‹æ³°ä¸­åœ‹A50",
    "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
    "00639": "å¯Œé‚¦æ·±100",
    "00642U": "å…ƒå¤§S&PçŸ³æ²¹",
    "00645": "å¯Œé‚¦æ—¥æœ¬",
    "00646": "å…ƒå¤§S&P500",
    "00647L": "å…ƒå¤§S&P500æ­£2",
    "00648R": "å…ƒå¤§S&P500å1",
    "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
    "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
    "00657": "åœ‹æ³°æ—¥ç¶“225",
    "00661": "å…ƒå¤§æ—¥ç¶“225",
    "00662": "å¯Œé‚¦NASDAQ",
    "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
    "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
    "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
    "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
    "00670L": "å¯Œé‚¦NASDAQæ­£2",
    "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
    "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
    "00677U": "å¯Œé‚¦VIX",
    "00678": "ç¾¤ç›ŠNBIç”ŸæŠ€",
    "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
    "00681R": "å…ƒå¤§ç¾å‚µ20å1",
    "00682U": "å…ƒå¤§ç¾å‚µ20",
    "00683L": "å…ƒå¤§ç¾å‚µå1",
    "00685L": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šæ­£2",
    "00686R": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šå1",
    "00688L": "åœ‹æ³°20å¹´ç¾å‚µæ­£2",
    "00689R": "åœ‹æ³°20å¹´ç¾å‚µå1",
    "00690": "å…†è±è—ç±Œ30",
    "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
    "00693U": "è¡—å£S&Pé»ƒé‡‘",
    "00696": "å¯Œé‚¦éŠæˆ²å¨›æ¨‚",
    "00700": "å¯Œé‚¦æ–°èˆˆåœ‹ä¼",
    "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
    "00703": "å°æ–°MSCIä¸­åœ‹",
    "00706L": "å…ƒå¤§ç¾å…ƒæŒ‡æ•¸æ­£2",
    "00707R": "å…ƒå¤§ç¾å…ƒæŒ‡æ•¸å1",
    "00708L": "å…ƒå¤§æ­æ´²50æ­£2",
    "00709": "å¯Œé‚¦æ­æ´²",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00714": "ç¾¤ç›Šé“ç“Šç¾åœ‹åœ°ç”¢",
    "00715L": "è¡—å£æŠ•ä¿¡å¸ƒè˜­ç‰¹æ­£2",
    "00717": "å¯Œé‚¦ç¾åœ‹ç‰¹åˆ¥è‚¡",
    "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
    "00731": "å¾©è¯å¯Œæ™‚é«˜æ¯ä½æ³¢",
    "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
    "00735": "åœ‹æ³°è‡ºéŸ“ç§‘æŠ€",
    "00736": "åœ‹æ³°æ–°èˆˆå¸‚å ´",
    "00737": "åœ‹æ³°AI+Robo",
    "00738U": "å…ƒå¤§é“ç“Šç™½éŠ€",
    "00739": "å…ƒå¤§MSCI Aè‚¡",
    "00752": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00753L": "ä¸­ä¿¡ä¸­åœ‹50æ­£2",
    "00757": "çµ±ä¸€FANG+",
    "00762": "å…ƒå¤§å…¨çƒAI",
    "00763U": "è¡—å£é“ç“ŠéŠ…",
    "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
    "00771": "å…ƒå¤§USé«˜æ¯ç‰¹åˆ¥è‚¡",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00851": "å°æ–°å…¨çƒAI",
    "00852L": "åœ‹æ³°ç¾åœ‹è²»åŠæ­£2",
    "00853": "çµ±ä¸€MSCIéŸ“åœ‹",
    "00861": "å…ƒå¤§å…¨çƒæœªä¾†é—œéµç§‘æŠ€",
    "00865B": "åœ‹æ³°USçŸ­æœŸå…¬å‚µ",
    "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
    "00876": "å…ƒå¤§å…¨çƒ5G",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00885": "å¯Œé‚¦è¶Šå—",
    "00886": "å…ƒå¤§å…¨çƒé›²ç«¯æœå‹™",
    "00887": "æ°¸è±å°ç£ESG",
    "00888": "æ°¸è±ç¾åœ‹è²»åŠ",
    "00889": "æ°¸è±å°ç£æ™ºèƒ½è»Š",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00896": "ä¸­ä¿¡ç¶ èƒ½é›»å‹•è»Š",
    "00897": "å¯Œé‚¦åŸºå› å…ç–«ç”ŸæŠ€",
    "00898": "åœ‹æ³°åŸºå› å…ç–«é©å‘½",
    "00899": "å¯Œé‚¦ç¾å‚µ20å¹´",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
    "00902": "ä¸­ä¿¡é›»æ± åŠå„²èƒ½",
    "00903": "å¯Œé‚¦å…ƒå®‡å®™",
    "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
    "00905": "FTè‡ºç£Smart",
    "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
    "00908": "å¯Œé‚¦å…¥æ¯REITs+",
    "00909": "åœ‹æ³°æ•¸ä½æ”¯ä»˜æœå‹™",
    "00910": "ç¬¬ä¸€é‡‘å¤ªç©ºè¡›æ˜Ÿ",
    "00911": "å…†è±æ´²éš›åŠå°é«”",
    "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
    "00913": "å…†è±å°ç£æ™¶åœ“è£½é€ ",
    "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
    "00916": "åœ‹æ³°å…¨çƒå“ç‰Œ50",
    "00917": "ä¸­ä¿¡ç‰¹é¸é‡‘è",
    "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00920": "å¯Œé‚¦å…¨çƒéæŠ•ç­‰å‚µ",
    "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
    "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
    "00923": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00926": "å‡±åŸºåŠå°é«”",
    "00927": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00928": "ä¸­ä¿¡ä¸Šæ«ƒESG30",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
    "00931": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
    "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
    "00933": "åœ‹æ³°10Y+é‡‘èå‚µ",
    "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
    "00935": "é‡æ‘å°ç£æ–°ç§‘æŠ€50",
    "00936": "å°æ–°è‡ºç£ICè¨­è¨ˆ",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
    
    # === å¸¸è¦‹å€‹è‚¡ ===
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    "1216": "çµ±ä¸€",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "1402": "é æ±æ–°",
    "1476": "å„’é´»",
    "2002": "ä¸­é‹¼",
    "2105": "æ­£æ–°",
    "2207": "å’Œæ³°è»Š",
    "2227": "è£•æ—¥è»Š",
    "2301": "å…‰å¯¶ç§‘",
    "2303": "è¯é›»",
    "2308": "å°é”é›»",
    "2317": "é´»æµ·",
    "2324": "ä»å¯¶",
    "2327": "åœ‹å·¨",
    "2330": "å°ç©é›»",
    "2337": "æ—ºå®",
    "2344": "è¯é‚¦é›»",
    "2345": "æ™ºé‚¦",
    "2351": "é †å¾·",
    "2353": "å®ç¢",
    "2354": "é´»æº–",
    "2356": "è‹±æ¥­é”",
    "2357": "è¯ç¢©",
    "2360": "è‡´èŒ‚",
    "2376": "æŠ€å˜‰",
    "2377": "å¾®æ˜Ÿ",
    "2379": "ç‘æ˜±",
    "2382": "å»£é”",
    "2383": "å°å…‰é›»",
    "2385": "ç¾¤å…‰",
    "2388": "å¨ç››",
    "2392": "æ­£å´´",
    "2395": "ç ”è¯",
    "2401": "å‡Œé™½",
    "2402": "æ¯…å˜‰",
    "2408": "å—äºç§‘",
    "2409": "å‹é”",
    "2412": "ä¸­è¯é›»",
    "2454": "è¯ç™¼ç§‘",
    "2474": "å¯æˆ",
    "2492": "è¯æ–°ç§‘",
    "2498": "å®é”é›»",
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2610": "è¯èˆª",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2633": "å°ç£é«˜éµ",
    "2801": "å½°éŠ€",
    "2809": "äº¬åŸéŠ€",
    "2812": "å°ä¸­éŠ€",
    "2816": "æ—ºæ—ºä¿",
    "2823": "ä¸­å£½",
    "2834": "è‡ºä¼éŠ€",
    "2838": "è¯é‚¦éŠ€",
    "2845": "é æ±éŠ€",
    "2867": "ä¸‰å•†å£½",
    "2880": "è¯å—é‡‘",
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2886": "å…†è±é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2889": "åœ‹ç¥¨é‡‘",
    "2890": "æ°¸è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2903": "é ç™¾",
    "2912": "çµ±ä¸€è¶…",
    "3008": "å¤§ç«‹å…‰",
    "3017": "å¥‡é‹",
    "3034": "è¯è© ",
    "3037": "æ¬£èˆˆ",
    "3044": "å¥é¼",
    "3045": "å°ç£å¤§",
    "3231": "ç·¯å‰µ",
    "3443": "å‰µæ„",
    "3481": "ç¾¤å‰µ",
    "3533": "å˜‰æ¾¤",
    "3661": "ä¸–èŠ¯-KY",
    "3665": "è²¿è¯-KY",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "4904": "é å‚³",
    "4938": "å’Œç¢©",
    "5269": "ç¥¥ç¢©",
    "5347": "ä¸–ç•Œ",
    "5871": "ä¸­ç§Ÿ-KY",
    "5876": "ä¸Šæµ·å•†éŠ€",
    "5880": "åˆåº«é‡‘",
    "6005": "ç¾¤ç›Šè­‰",
    "6116": "å½©æ™¶",
    "6176": "ç‘å„€",
    "6239": "åŠ›æˆ",
    "6269": "å°éƒ¡",
    "6285": "å•Ÿç¢",
    "6409": "æ—­éš¼",
    "6415": "çŸ½åŠ›-KY",
    "6446": "è—¥è¯è—¥",
    "6488": "ç’°çƒæ™¶",
    "6505": "å°å¡‘åŒ–",
    "6515": "ç©å´´",
    "6531": "æ„›æ™®",
    "6533": "æ™¶å¿ƒç§‘",
    "6547": "é«˜ç«¯ç–«è‹—",
    "6552": "æ˜“è¯é›»",
    "6558": "èˆˆèƒ½é«˜",
    "6669": "ç·¯ç©",
    "6670": "å¾©ç››æ‡‰ç”¨",
    "6789": "é‡‡éˆº",
    "8046": "å—é›»",
    "8454": "å¯Œé‚¦åª’",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "9941": "è£•è",
    "9945": "æ½¤æ³°æ–°",
}


def get_taiwan_stock_name(symbol: str) -> str:
    """
    å–å¾—å°è‚¡åç¨±
    
    Args:
        symbol: è‚¡ç¥¨ä»£ç¢¼ (ä¾‹å¦‚ "2330" æˆ– "2330.TW")
    
    Returns:
        è‚¡ç¥¨åç¨±ï¼Œè‹¥æ‰¾ä¸åˆ°å‰‡è¿”å›ä»£ç¢¼æœ¬èº«
    """
    stock_code = symbol.replace('.TW', '').replace('.TWO', '').strip()
    return TAIWAN_STOCK_NAMES.get(stock_code, symbol)


def is_taiwan_stock(symbol: str) -> bool:
    """åˆ¤æ–·æ˜¯å¦ç‚ºå°è‚¡"""
    symbol = symbol.upper().strip()
    
    if symbol.endswith('.TW') or symbol.endswith('.TWO'):
        return True
    
    if symbol.isdigit() and 4 <= len(symbol) <= 6:
        return True
    
    return False
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/data_sources/yahoo_finance.py  â­
> Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â ÃƒÂ¦Ã‚ÂºÃ‚Â
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â ÃƒÂ¦Ã‚ÂºÃ‚Â
ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ yfinance ÃƒÂ¥Ã‚Â¥Ã¢â‚¬â€ÃƒÂ¤Ã‚Â»Ã‚Â¶ÃƒÂ¦Ã…Â Ã¢â‚¬Å“ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ§Ã‚Â¾Ã…Â½ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
"""
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
import logging

logger = logging.getLogger(__name__)

# ÃƒÂ¥Ã‚Â¸Ã‚Â¸ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¥Ã‚ÂÃ‚Â°ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±ÃƒÂ¥Ã‚Â°Ã‚ÂÃƒÂ§Ã¢â‚¬Â¦Ã‚Â§ÃƒÂ¨Ã‚Â¡Ã‚Â¨
TAIWAN_STOCK_NAMES = {
    # ===== æ¬Šå€¼è‚¡ =====
    "2330": "å°ç©é›»",
    "2317": "é´»æµ·",
    "2454": "è¯ç™¼ç§‘",
    "2308": "å°é”é›»",
    "2412": "ä¸­è¯é›»",
    "2303": "è¯é›»",
    "2002": "ä¸­é‹¼",
    "1301": "å°å¡‘",
    "1303": "å—äº",
    "1326": "å°åŒ–",
    "6505": "å°å¡‘åŒ–",
    "1101": "å°æ³¥",
    "1102": "äºæ³¥",
    "1216": "çµ±ä¸€",
    "2207": "å’Œæ³°è»Š",
    # ===== é‡‘èè‚¡ =====
    "2881": "å¯Œé‚¦é‡‘",
    "2882": "åœ‹æ³°é‡‘",
    "2884": "ç‰å±±é‡‘",
    "2886": "å…†è±é‡‘",
    "2891": "ä¸­ä¿¡é‡‘",
    "2892": "ç¬¬ä¸€é‡‘",
    "2880": "è¯å—é‡‘",
    "2883": "é–‹ç™¼é‡‘",
    "2885": "å…ƒå¤§é‡‘",
    "2887": "å°æ–°é‡‘",
    "2888": "æ–°å…‰é‡‘",
    "2890": "æ°¸è±é‡‘",
    "5880": "åˆåº«é‡‘",
    "5876": "ä¸Šæµ·å•†éŠ€",
    # ===== é›»å­è‚¡ =====
    "2912": "çµ±ä¸€è¶…",
    "2357": "è¯ç¢©",
    "2382": "å»£é”",
    "2395": "ç ”è¯",
    "3008": "å¤§ç«‹å…‰",
    "3711": "æ—¥æœˆå…‰æŠ•æ§",
    "2345": "æ™ºé‚¦",
    "2379": "ç‘æ˜±",
    "2327": "åœ‹å·¨",
    "3034": "è¯è© ",
    "2301": "å…‰å¯¶ç§‘",
    "2408": "å—äºç§‘",
    "2474": "å¯æˆ",
    "3045": "å°ç£å¤§",
    "4904": "é å‚³",
    "3231": "ç·¯å‰µ",
    "2356": "è‹±æ¥­é”",
    "2353": "å®ç¢",
    "2324": "ä»å¯¶",
    "2377": "å¾®æ˜Ÿ",
    "2376": "æŠ€å˜‰",
    "4938": "å’Œç¢©",
    "2409": "å‹é”",
    "3481": "ç¾¤å‰µ",
    "6669": "ç·¯ç©",
    "3037": "æ¬£èˆˆ",
    "2344": "è¯é‚¦é›»",
    "2337": "æ—ºå®",
    "3443": "å‰µæ„",
    "6488": "ç’°çƒæ™¶",
    "5269": "ç¥¥ç¢©",
    "6415": "çŸ½åŠ›-KY",
    "3661": "ä¸–èŠ¯-KY",
    "6239": "åŠ›æˆ",
    "8046": "å—é›»",
    "3017": "å¥‡é‹",
    "6176": "ç‘å„€",
    "6285": "å•Ÿç¢",
    "2492": "è¯æ–°ç§‘",
    "3533": "å˜‰æ¾¤",
    "6531": "æ„›æ™®",
    "3665": "è²¿è¯-KY",
    "8454": "å¯Œé‚¦åª’",
    "2383": "å°å…‰é›»",
    "2351": "é †å¾·",
    "2354": "é´»æº–",
    "2360": "è‡´èŒ‚",
    "2385": "ç¾¤å…‰",
    "2388": "å¨ç››",
    "2392": "æ­£å´´",
    "2401": "å‡Œé™½",
    "2402": "æ¯…å˜‰",
    # ===== èˆªé‹/å‚³ç”¢ =====
    "2603": "é•·æ¦®",
    "2609": "é™½æ˜",
    "2615": "è¬æµ·",
    "2618": "é•·æ¦®èˆª",
    "2610": "è¯èˆª",
    "2633": "å°ç£é«˜éµ",
    "9910": "è±æ³°",
    "9921": "å·¨å¤§",
    "5871": "ä¸­ç§Ÿ-KY",
    "9941": "è£•è",
    # ===== ç”ŸæŠ€ =====
    "6446": "è—¥è¯è—¥",
    "6547": "é«˜ç«¯ç–«è‹—",
    # ===== ETF =====
    "0050": "å…ƒå¤§å°ç£50",
    "0051": "å…ƒå¤§ä¸­å‹100",
    "0052": "å¯Œé‚¦ç§‘æŠ€",
    "0053": "å…ƒå¤§é›»å­",
    "0055": "å…ƒå¤§MSCIé‡‘è",
    "0056": "å…ƒå¤§é«˜è‚¡æ¯",
    "0057": "å¯Œé‚¦æ‘©å°",
    "006205": "å¯Œé‚¦ä¸Šè­‰",
    "006206": "å…ƒå¤§ä¸Šè­‰50",
    "006208": "å¯Œé‚¦å°50",
    "00631L": "å…ƒå¤§å°ç£50æ­£2",
    "00632R": "å…ƒå¤§å°ç£50å1",
    "00635U": "å…ƒå¤§S&Pé»ƒé‡‘",
    "00636": "åœ‹æ³°ä¸­åœ‹A50",
    "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
    "00639": "å¯Œé‚¦æ·±100",
    "00642U": "å…ƒå¤§S&PçŸ³æ²¹",
    "00645": "å¯Œé‚¦æ—¥æœ¬",
    "00646": "å…ƒå¤§S&P500",
    "00647L": "å…ƒå¤§S&P500æ­£2",
    "00648R": "å…ƒå¤§S&P500å1",
    "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
    "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
    "00657": "åœ‹æ³°æ—¥ç¶“225",
    "00661": "å…ƒå¤§æ—¥ç¶“225",
    "00662": "å¯Œé‚¦NASDAQ",
    "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
    "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
    "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
    "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
    "00670L": "å¯Œé‚¦NASDAQæ­£2",
    "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
    "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
    "00677U": "å¯Œé‚¦VIX",
    "00678": "ç¾¤ç›ŠNBIç”ŸæŠ€",
    "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
    "00681R": "å…ƒå¤§ç¾å‚µ20å1",
    "00682U": "å…ƒå¤§ç¾å‚µ20å¹´",
    "00690": "å…†è±è—ç±Œ30",
    "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
    "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
    "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
    "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
    "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
    "00757": "çµ±ä¸€FANG+",
    "00762": "å…ƒå¤§å…¨çƒAI",
    "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
    "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
    "00851": "å°æ–°å…¨çƒAI",
    "00852L": "åœ‹æ³°ç¾åœ‹è²»åŠæ­£2",
    "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
    "00876": "å…ƒå¤§å…¨çƒ5G",
    "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
    "00881": "åœ‹æ³°å°ç£5G+",
    "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
    "00885": "å¯Œé‚¦è¶Šå—",
    "00886": "å…ƒå¤§å…¨çƒé›²ç«¯æœå‹™",
    "00887": "æ°¸è±å°ç£ESG",
    "00888": "æ°¸è±ç¾åœ‹è²»åŠ",
    "00889": "æ°¸è±å°ç£æ™ºèƒ½è»Š",
    "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
    "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
    "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
    "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
    "00895": "å¯Œé‚¦æœªä¾†è»Š",
    "00896": "ä¸­ä¿¡ç¶ èƒ½é›»å‹•è»Š",
    "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
    "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
    "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
    "00905": "FTè‡ºç£Smart",
    "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
    "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
    "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
    "00916": "åœ‹æ³°å…¨çƒå“ç‰Œ50",
    "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
    "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
    "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
    "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
    "00923": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
    "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
    "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
    "00931": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
    "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
    "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
    "00935": "é‡æ‘å°ç£æ–°ç§‘æŠ€50",
    "00936": "å°æ–°è‡ºç£ICè¨­è¨ˆ",
    "00939": "çµ±ä¸€å°ç£é«˜æ¯å„ªé¸",
    "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
}



class YahooFinanceClient:
    """Yahoo Finance ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã¢â‚¬Å“Ã‚Â·ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â®Ã‚Â¢ÃƒÂ¦Ã‹â€ Ã‚Â¶ÃƒÂ§Ã‚Â«Ã‚Â¯"""
    
    def __init__(self):
        pass
    
    def get_stock_info(self, symbol: str) -> Optional[Dict[str, Any]]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¥Ã…Â¸Ã‚ÂºÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â 
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸ (ÃƒÂ¥Ã‚Â¦Ã¢â‚¬Å¡ AAPL, TSLA, 2330.TW)
            
        Returns:
            ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â ÃƒÂ¥Ã‚Â­Ã¢â‚¬â€ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¸ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±ÃƒÂ£Ã¢â€šÂ¬Ã‚ÂÃƒÂ¥Ã‚Â¸Ã¢â‚¬Å¡ÃƒÂ¥Ã¢â€šÂ¬Ã‚Â¼ÃƒÂ§Ã‚Â­Ã¢â‚¬Â°
        """
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info or {}
            
            # ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±ÃƒÂ¯Ã‚Â¼Ã…Â¡ÃƒÂ¥Ã¢â‚¬Å¾Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¦Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ longNameÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¶ÃƒÂ¥Ã‚Â¾Ã…â€™ shortName
            name = info.get("longName") or info.get("shortName") or symbol
            
            # ÃƒÂ¥Ã‚Â°Ã‚ÂÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ¥Ã‚ÂÃ‚Â°ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã¢â‚¬Å¾Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¦Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¥Ã…â€œÃ‚Â°ÃƒÂ¦Ã‹Å“Ã‚Â ÃƒÂ¥Ã‚Â°Ã¢â‚¬Å¾ÃƒÂ¨Ã‚Â¡Ã‚Â¨ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±
            if symbol.endswith(".TW") or symbol.endswith(".TWO"):
                # ÃƒÂ¦Ã‚ÂÃ‚ÂÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸ (ÃƒÂ¥Ã…Â½Ã‚Â»ÃƒÂ¦Ã…Â½Ã¢â‚¬Â° .TW ÃƒÂ¦Ã‹â€ Ã¢â‚¬â€œ .TWO)
                stock_code = symbol.replace(".TW", "").replace(".TWO", "")
                # ÃƒÂ¥Ã¢â‚¬Å¾Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¦Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¥Ã…â€œÃ‚Â°ÃƒÂ¦Ã‹Å“Ã‚Â ÃƒÂ¥Ã‚Â°Ã¢â‚¬Å¾ÃƒÂ¨Ã‚Â¡Ã‚Â¨
                if stock_code in TAIWAN_STOCK_NAMES:
                    name = TAIWAN_STOCK_NAMES[stock_code]
                else:
                    # ÃƒÂ¥Ã‹Å“Ã¢â‚¬â€ÃƒÂ¨Ã‚Â©Ã‚Â¦ÃƒÂ¥Ã‚Â¾Ã…Â¾ Yahoo Finance ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚ÂÃ‚Â
                    display_name = info.get("displayName")
                    if display_name:
                        name = display_name
            
            # ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¤Ã‚Â½Ã‚Â¿ info ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚Â®Ã…â€™ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â¹Ã…Â¸ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ÂÃƒÂ¥Ã¢â‚¬ÂºÃ…Â¾ÃƒÂ¥Ã…Â¸Ã‚ÂºÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â 
            return {
                "symbol": info.get("symbol", symbol),
                "name": name,
                "shortName": info.get("shortName", ""),
                "longName": info.get("longName", ""),
                "currency": info.get("currency", "TWD" if symbol.endswith((".TW", ".TWO")) else "USD"),
                "market_cap": info.get("marketCap"),
                "sector": info.get("sector"),
                "industry": info.get("industry"),
                "fifty_two_week_high": info.get("fiftyTwoWeekHigh"),
                "fifty_two_week_low": info.get("fiftyTwoWeekLow"),
            }
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            # ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ¥Ã¢â‚¬Â¡Ã‚ÂºÃƒÂ©Ã…â€™Ã‚Â¯ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã‚Â°Ã‚ÂÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ¥Ã‚ÂÃ‚Â°ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ¤Ã‚Â¹Ã…Â¸ÃƒÂ¥Ã‹Å“Ã¢â‚¬â€ÃƒÂ¨Ã‚Â©Ã‚Â¦ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ÂÃƒÂ¥Ã¢â‚¬ÂºÃ…Â¾ÃƒÂ¦Ã…â€œÃ‚Â¬ÃƒÂ¥Ã…â€œÃ‚Â°ÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±
            if symbol.endswith(".TW") or symbol.endswith(".TWO"):
                stock_code = symbol.replace(".TW", "").replace(".TWO", "")
                name = TAIWAN_STOCK_NAMES.get(stock_code, symbol)
                return {
                    "symbol": symbol,
                    "name": name,
                    "shortName": "",
                    "longName": "",
                    "currency": "TWD",
                    "market_cap": None,
                    "sector": None,
                    "industry": None,
                    "fifty_two_week_high": None,
                    "fifty_two_week_low": None,
                }
            return None
    
    def get_stock_history(
        self,
        symbol: str,
        period: str = "1y",
        start: Optional[datetime] = None,
        end: Optional[datetime] = None,
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            period: ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“ (1d, 5d, 1mo, 3mo, 6mo, 1y, 2y, 5y, 10y, ytd, max)
            start: ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Â¹ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¨Ã‹â€ Ã¢â‚¬Â¡ end ÃƒÂ¦Ã‚ÂÃ‚Â­ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¯Ã‚Â¼Ã…â€™period ÃƒÂ¦Ã…â€œÃ†â€™ÃƒÂ¨Ã‚Â¢Ã‚Â«ÃƒÂ¥Ã‚Â¿Ã‚Â½ÃƒÂ§Ã¢â‚¬Â¢Ã‚Â¥ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
            end: ÃƒÂ§Ã‚ÂµÃ‚ÂÃƒÂ¦Ã‚ÂÃ…Â¸ÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â« OHLCV ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrameÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¶ÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ¯Ã‚Â¼Ã…Â¡
            - close: ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ÃƒÂ§Ã¢â‚¬ÂºÃ‚Â¤ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ©Ã‚Â¡Ã‚Â¯ÃƒÂ§Ã‚Â¤Ã‚ÂºÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
            - adj_close: ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‚Â¾Ã…â€™ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â¼ÃƒÂ¥Ã…â€œÃ¢â‚¬â€œÃƒÂ¨Ã‚Â¡Ã‚Â¨ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        """
        try:
            ticker = yf.Ticker(symbol)
            
            # ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼
            if start and end:
                df_raw = ticker.history(start=start, end=end, auto_adjust=False)
            else:
                df_raw = ticker.history(period=period, auto_adjust=False)
            
            if df_raw.empty:
                logger.warning(f"ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¡ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢: {symbol}")
                return None
            
            df_raw = df_raw.reset_index()
            
            # ÃƒÂ¦Ã‚Â¨Ã¢â€Â¢ÃƒÂ¦Ã‚ÂºÃ¢â‚¬â€œÃƒÂ¥Ã…â€™Ã¢â‚¬â€œÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚Â
            date_col = "Date" if "Date" in df_raw.columns else "Datetime"
            
            # ÃƒÂ¥Ã‚Â»Ã‚ÂºÃƒÂ§Ã‚Â«Ã¢â‚¬Â¹ÃƒÂ§Ã‚ÂµÃ‚ÂÃƒÂ¦Ã…Â¾Ã…â€œ DataFrame
            df = pd.DataFrame()
            df["date"] = pd.to_datetime(df_raw[date_col]).dt.date
            df["open"] = df_raw["Open"].values
            df["high"] = df_raw["High"].values
            df["low"] = df_raw["Low"].values
            df["close"] = df_raw["Close"].values
            df["volume"] = df_raw["Volume"].values if "Volume" in df_raw.columns else 0
            
            # ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¤Ã‚Â¸Ã‚Â¦ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
            df = self._detect_and_adjust_splits(df, symbol)
            
            # ÃƒÂ¥Ã…Â Ã‚Â ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¥ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            df["symbol"] = symbol.upper()
            
            return df
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def _detect_and_adjust_splits(self, df: pd.DataFrame, symbol: str) -> pd.DataFrame:
        """
        ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â·ÃƒÂ¥Ã‚Â´Ã¢â‚¬â€œÃƒÂ¤Ã‚Â¸Ã‚Â¦ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã‚ÂÃ‚ÂªÃƒÂ¨Ã¢â€Â¢Ã¢â‚¬Â¢ÃƒÂ§Ã‚ÂÃ¢â‚¬Â ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        
        ÃƒÂ§Ã¢â‚¬Â¢Ã‚Â¶ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã‹â€ Ã‚Â°ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ§Ã‚ÂªÃ‚ÂÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¶ÃƒÂ¤Ã‚Â¸Ã¢â‚¬Â¹ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¨Ã‚Â¶Ã¢â‚¬Â¦ÃƒÂ©Ã‚ÂÃ…Â½ 40%ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã†â€™Ã‚Â½ÃƒÂ¦Ã‹Å“Ã‚Â¯ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°ÃƒÂ¯Ã‚Â¼Ã…â€™
        ÃƒÂ¦Ã…â€œÃ†â€™ÃƒÂ¨Ã¢â‚¬Â¡Ã‚ÂªÃƒÂ¥Ã¢â‚¬Â¹Ã¢â‚¬Â¢ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã¢â€šÂ¬Ã¢â‚¬Â¹ÃƒÂ¥Ã‚ÂºÃ‚ÂÃƒÂ¥Ã‹â€ Ã¢â‚¬â€ÃƒÂ©Ã¢â€šÂ¬Ã‚Â£ÃƒÂ§Ã‚ÂºÃ…â€™ÃƒÂ£Ã¢â€šÂ¬Ã¢â‚¬Å¡
        """
        if len(df) < 2:
            df['adj_close'] = df['close'].copy()
            return df
        
        df = df.copy()
        df = df.sort_values('date').reset_index(drop=True)
        
        # ÃƒÂ¨Ã‚Â¨Ã‹â€ ÃƒÂ§Ã‚Â®Ã¢â‚¬â€ÃƒÂ¦Ã‚Â¯Ã‚ÂÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã‚Â¼Ã‚Â²ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¥Ã‚Â¹Ã¢â‚¬Â¦
        df['pct_change'] = df['close'].pct_change()
        
        # ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ©Ã‚Â»Ã…Â¾ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¤Ã‚Â¸Ã¢â‚¬Â¹ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¨Ã‚Â¶Ã¢â‚¬Â¦ÃƒÂ©Ã‚ÂÃ…Â½ 40%ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        split_indices = []
        for i in range(1, len(df)):
            pct = df.loc[i, 'pct_change']
            if pd.notna(pct) and pct < -0.40:
                prev_close = float(df.loc[i-1, 'close'])
                curr_close = float(df.loc[i, 'close'])
                if curr_close > 0:
                    ratio = prev_close / curr_close
                    rounded_ratio = round(ratio)
                    # ÃƒÂ¥Ã‚ÂÃ‚ÂªÃƒÂ¦Ã…â€œÃ¢â‚¬Â°ÃƒÂ¦Ã‚Â¯Ã¢â‚¬ÂÃƒÂ§Ã…Â½Ã¢â‚¬Â¡ÃƒÂ¦Ã…Â½Ã‚Â¥ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ËœÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¦Ã¢â‚¬Â°Ã‚ÂÃƒÂ¨Ã‚ÂªÃ‚ÂÃƒÂ§Ã¢â‚¬Å¡Ã‚ÂºÃƒÂ¦Ã‹Å“Ã‚Â¯ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã‹â€ 2, 3, 4, 5, 10 ÃƒÂ§Ã‚Â­Ã¢â‚¬Â°ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
                    if rounded_ratio >= 2 and abs(ratio - rounded_ratio) < 0.3:
                        split_indices.append({
                            'index': i,
                            'date': df.loc[i, 'date'],
                            'ratio': rounded_ratio,
                            'prev_close': prev_close,
                            'curr_close': curr_close
                        })
                        logger.info(f"{symbol} ÃƒÂ¥Ã‚ÂÃ‚ÂµÃƒÂ¦Ã‚Â¸Ã‚Â¬ÃƒÂ¥Ã‹â€ Ã‚Â°ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²: {df.loc[i, 'date']}, ÃƒÂ¦Ã‚Â¯Ã¢â‚¬ÂÃƒÂ§Ã…Â½Ã¢â‚¬Â¡ 1:{rounded_ratio}, ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ {prev_close:.2f} -> ÃƒÂ§Ã‚ÂÃ‚Â¾ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ {curr_close:.2f}")
        
        # ÃƒÂ¥Ã‹â€ Ã‚ÂÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã…â€™Ã¢â‚¬â€œÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‚Â¾Ã…â€™ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼
        df['adj_close'] = df['close'].astype(float)
        
        # ÃƒÂ¥Ã‚Â¾Ã…Â¾ÃƒÂ¦Ã…â€œÃ¢â€šÂ¬ÃƒÂ¨Ã‚Â¿Ã¢â‚¬ËœÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Â¹ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã‚Â¾Ã¢â€šÂ¬ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ§Ã‚Â´Ã‚Â¯ÃƒÂ§Ã‚Â©Ã‚ÂÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â ÃƒÂ¥Ã‚Â­Ã‚ÂÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        if split_indices:
            cumulative_factor = 1.0
            
            for split in reversed(split_indices):
                idx = split['index']
                ratio = split['ratio']
                cumulative_factor *= ratio
                
                # ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ©Ã‚Â»Ã…Â¾ÃƒÂ¤Ã‚Â¹Ã¢â‚¬Â¹ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¦Ã¢â‚¬Â°Ã¢â€šÂ¬ÃƒÂ¦Ã…â€œÃ¢â‚¬Â°ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ close ÃƒÂ©Ã¢â€Â¢Ã‚Â¤ÃƒÂ¤Ã‚Â»Ã‚Â¥ÃƒÂ§Ã‚Â´Ã‚Â¯ÃƒÂ§Ã‚Â©Ã‚ÂÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â ÃƒÂ¥Ã‚Â­Ã‚ÂÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
                df.loc[:idx-1, 'adj_close'] = df.loc[:idx-1, 'close'].astype(float) / cumulative_factor
            
            logger.info(f"{symbol} ÃƒÂ¥Ã‚Â·Ã‚Â²ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ {len(split_indices)} ÃƒÂ¦Ã‚Â¬Ã‚Â¡ÃƒÂ¥Ã‹â€ Ã¢â‚¬Â ÃƒÂ¥Ã¢â‚¬Â°Ã‚Â²ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ§Ã‚Â¸Ã‚Â½ÃƒÂ¨Ã‚ÂªÃ‚Â¿ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â´ÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â ÃƒÂ¥Ã‚Â­Ã‚Â: {cumulative_factor}")
        
        # ÃƒÂ§Ã‚Â§Ã‚Â»ÃƒÂ©Ã¢â€Â¢Ã‚Â¤ÃƒÂ¨Ã¢â‚¬Â¡Ã‚Â¨ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚Â
        df = df.drop(columns=['pct_change'], errors='ignore')
        
        return df
    
    def get_current_price(self, symbol: str) -> Optional[Dict[str, Any]]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¥Ã‚Â»Ã‚Â¶ÃƒÂ©Ã‚ÂÃ‚Â²ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°ÃƒÂ¥Ã‚Â Ã‚Â±ÃƒÂ¥Ã†â€™Ã‚Â¹
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ§Ã¢â‚¬Â¢Ã‚Â¶ÃƒÂ¥Ã¢â‚¬Â°Ã‚ÂÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¥Ã¢â‚¬â„¢Ã…â€™ÃƒÂ¦Ã‚Â¼Ã‚Â²ÃƒÂ¨Ã‚Â·Ã…â€™ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¨Ã‚Â¨Ã…Â ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¥Ã‚Â­Ã¢â‚¬â€ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¸
        """
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info
            
            if not info:
                return None
            
            # ÃƒÂ¥Ã‹Å“Ã¢â‚¬â€ÃƒÂ¨Ã‚Â©Ã‚Â¦ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼
            current_price = info.get("currentPrice") or info.get("regularMarketPrice")
            previous_close = info.get("previousClose") or info.get("regularMarketPreviousClose")
            
            if not current_price:
                # ÃƒÂ¥Ã‚Â¾Ã…Â¾ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã…â€œÃ¢â€šÂ¬ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â°ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¶ÃƒÂ§Ã¢â‚¬ÂºÃ‚Â¤ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¤Ã‚Â½Ã‚Â¿ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ÃƒÂ¥Ã…Â½Ã…Â¸ÃƒÂ¥Ã‚Â§Ã¢â‚¬Â¹ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¦Ã‚Â Ã‚Â¼ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
                hist = ticker.history(period="5d", auto_adjust=False)
                if not hist.empty:
                    current_price = hist["Close"].iloc[-1]
                    if len(hist) >= 2:
                        previous_close = hist["Close"].iloc[-2]
            
            if not current_price:
                return None
            
            change = current_price - previous_close if previous_close else 0
            change_pct = (change / previous_close * 100) if previous_close else 0
            
            return {
                "symbol": symbol.upper(),
                "price": round(current_price, 2),
                "previous_close": round(previous_close, 2) if previous_close else None,
                "change": round(change, 2),
                "change_pct": round(change_pct, 2),
                "volume": info.get("volume") or info.get("regularMarketVolume"),
            }
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚ÂÃ‚Â³ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ¥Ã‚Â Ã‚Â±ÃƒÂ¥Ã†â€™Ã‚Â¹ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def validate_symbol(self, symbol: str) -> bool:
        """
        Ã¥Â¿Â«Ã©â‚¬Å¸Ã©Â©â€”Ã¨Â­â€°Ã¨â€šÂ¡Ã§Â¥Â¨Ã¤Â»Â£Ã¨â„¢Å¸Ã¦ËœÂ¯Ã¥ÂÂ¦Ã¦Å“â€°Ã¦â€¢Ë†
        
        Ã¤Â½Â¿Ã§â€Â¨ history API Ã¨â‚¬Å’Ã©ÂÅ¾ infoÃ¯Â¼Å’Ã©â‚¬Å¸Ã¥ÂºÂ¦Ã¥Â¿Â« 5-10 Ã¥â‚¬Â
        
        Args:
            symbol: Ã¨â€šÂ¡Ã§Â¥Â¨Ã¤Â»Â£Ã¨â„¢Å¸
            
        Returns:
            Ã¦ËœÂ¯Ã¥ÂÂ¦Ã§â€šÂºÃ¦Å“â€°Ã¦â€¢Ë†Ã¤Â»Â£Ã¨â„¢Å¸
        """
        try:
            ticker = yf.Ticker(symbol)
            # Ã¥ÂÂªÃ¦Å â€œ 1 Ã¥Â¤Â©Ã¨Â³â€¡Ã¦â€“â„¢Ã¯Â¼Å’Ã¦Â¯â€ info Ã¥Â¿Â«Ã¥Â¾Ë†Ã¥Â¤Å¡
            hist = ticker.history(period="1d")
            return not hist.empty
        except Exception:
            return False
    
    def get_dividends(
        self,
        symbol: str,
        period: str = "10y",
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            period: ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“ (1y, 5y, 10y, max)
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â«ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã‚Â¨Ã‹Å“ÃƒÂ©Ã…â€™Ã¢â‚¬Å¾ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrame
        """
        try:
            ticker = yf.Ticker(symbol)
            dividends = ticker.dividends
            
            if dividends.empty:
                logger.info(f"{symbol} ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¡ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã‚Â¨Ã‹Å“ÃƒÂ©Ã…â€™Ã¢â‚¬Å¾")
                return None
            
            # ÃƒÂ¨Ã‚Â½Ã¢â‚¬Â°ÃƒÂ¦Ã‚ÂÃ¢â‚¬ÂºÃƒÂ¦Ã‹â€ Ã‚Â DataFrame
            df = dividends.reset_index()
            df.columns = ["date", "amount"]
            df["date"] = pd.to_datetime(df["date"]).dt.date
            df["symbol"] = symbol.upper()
            
            # ÃƒÂ¦Ã‚Â Ã‚Â¹ÃƒÂ¦Ã¢â‚¬Å“Ã…Â¡ period ÃƒÂ©Ã‚ÂÃ…Â½ÃƒÂ¦Ã‚Â¿Ã‚Â¾
            if period != "max":
                years = int(period.replace("y", ""))
                cutoff_date = datetime.now().date() - timedelta(days=years * 365)
                df = df[df["date"] >= cutoff_date]
            
            return df
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ©Ã¢â‚¬Â¦Ã‚ÂÃƒÂ¦Ã‚ÂÃ‚Â¯ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def get_index_data(
        self,
        symbol: str,
        period: str = "10y",
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¥Ã‚Â¸Ã¢â‚¬Å¡ÃƒÂ¥Ã‚Â Ã‚Â´ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
        
        Args:
            symbol: ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸ (^GSPC, ^DJI, ^IXIC)
            period: ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â« OHLCV ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrame
        """
        try:
            ticker = yf.Ticker(symbol)
            df = ticker.history(period=period, auto_adjust=False)
            
            if df.empty:
                logger.warning(f"ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¡ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢: {symbol}")
                return None
            
            # ÃƒÂ©Ã¢â‚¬Â¡Ã‚ÂÃƒÂ¨Ã‚Â¨Ã‚Â­ÃƒÂ§Ã‚Â´Ã‚Â¢ÃƒÂ¥Ã‚Â¼Ã¢â‚¬Â¢
            df = df.reset_index()
            
            # ÃƒÂ¦Ã‚Â¨Ã¢â€Â¢ÃƒÂ¦Ã‚ÂºÃ¢â‚¬â€œÃƒÂ¥Ã…â€™Ã¢â‚¬â€œÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚ÂÃƒÂ¥Ã‚ÂÃ‚ÂÃƒÂ§Ã‚Â¨Ã‚Â±
            column_mapping = {
                "Date": "date",
                "Datetime": "date",
                "Open": "open",
                "High": "high",
                "Low": "low",
                "Close": "close",
                "Volume": "volume",
            }
            existing_columns = {k: v for k, v in column_mapping.items() if k in df.columns}
            df = df.rename(columns=existing_columns)
            
            # ÃƒÂ§Ã‚Â¢Ã‚ÂºÃƒÂ¤Ã‚Â¿Ã‚ÂÃƒÂ¦Ã¢â‚¬â€Ã‚Â¥ÃƒÂ¦Ã…â€œÃ…Â¸ÃƒÂ¦Ã‹Å“Ã‚Â¯ date ÃƒÂ©Ã‚Â¡Ã…Â¾ÃƒÂ¥Ã…Â¾Ã¢â‚¬Â¹
            df["date"] = pd.to_datetime(df["date"]).dt.date
            
            # ÃƒÂ¨Ã‚Â¨Ã‹â€ ÃƒÂ§Ã‚Â®Ã¢â‚¬â€ÃƒÂ¦Ã‚Â¼Ã‚Â²ÃƒÂ¨Ã‚Â·Ã…â€™
            df["change"] = df["close"].diff()
            df["change_pct"] = df["close"].pct_change() * 100
            
            # ÃƒÂ¥Ã…Â Ã‚Â ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¥ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            df["symbol"] = symbol
            
            # ÃƒÂ¥Ã‚ÂÃ‚ÂªÃƒÂ¤Ã‚Â¿Ã‚ÂÃƒÂ§Ã¢â‚¬Â¢Ã¢â€Â¢ÃƒÂ©Ã…â€œÃ¢â€šÂ¬ÃƒÂ¨Ã‚Â¦Ã‚ÂÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ÃƒÂ¦Ã‚Â¬Ã¢â‚¬Å¾ÃƒÂ¤Ã‚Â½Ã‚Â
            keep_columns = ["symbol", "date", "open", "high", "low", "close", "volume", "change", "change_pct"]
            df = df[[c for c in keep_columns if c in df.columns]]
            
            return df
            
        except Exception as e:
            logger.error(f"ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¥Ã‚Â¤Ã‚Â±ÃƒÂ¦Ã¢â‚¬Â¢Ã¢â‚¬â€ {symbol}: {e}")
            return None
    
    def get_all_indices(self, period: str = "10y") -> Dict[str, pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¦Ã¢â‚¬Â°Ã¢â€šÂ¬ÃƒÂ¦Ã…â€œÃ¢â‚¬Â°ÃƒÂ¤Ã‚Â¸Ã¢â‚¬Â°ÃƒÂ¥Ã‚Â¤Ã‚Â§ÃƒÂ¦Ã…â€™Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢
        
        Returns:
            {symbol: DataFrame}
        """
        indices = ["^GSPC", "^DJI", "^IXIC"]
        result = {}
        
        for symbol in indices:
            df = self.get_index_data(symbol, period)
            if df is not None:
                result[symbol] = df
        
        return result
    
    def get_stock_history_extended(
        self,
        symbol: str,
        years: int = 10,
    ) -> Optional[pd.DataFrame]:
        """
        ÃƒÂ¥Ã‚ÂÃ¢â‚¬â€œÃƒÂ¥Ã‚Â¾Ã¢â‚¬â€ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¥Ã‚Â»Ã‚Â¶ÃƒÂ¤Ã‚Â¼Ã‚Â¸ÃƒÂ¦Ã‚Â­Ã‚Â·ÃƒÂ¥Ã‚ÂÃ‚Â²ÃƒÂ¨Ã‚Â³Ã¢â‚¬Â¡ÃƒÂ¦Ã¢â‚¬â€œÃ¢â€Â¢ÃƒÂ¯Ã‚Â¼Ã‹â€ ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¯ÃƒÂ¦Ã‚ÂÃ‚Â´ÃƒÂ¦Ã¢â‚¬ÂºÃ‚Â´ÃƒÂ©Ã¢â‚¬Â¢Ã‚Â·ÃƒÂ¦Ã¢â€Â¢Ã¢â‚¬Å¡ÃƒÂ©Ã¢â‚¬â€œÃ¢â‚¬Å“ÃƒÂ¯Ã‚Â¼Ã¢â‚¬Â°
        
        Args:
            symbol: ÃƒÂ¨Ã¢â‚¬Å¡Ã‚Â¡ÃƒÂ§Ã‚Â¥Ã‚Â¨ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¨Ã¢â€Â¢Ã…Â¸
            years: ÃƒÂ¥Ã‚Â¹Ã‚Â´ÃƒÂ¦Ã¢â‚¬Â¢Ã‚Â¸ (1, 3, 5, 10)
            
        Returns:
            ÃƒÂ¥Ã…â€™Ã¢â‚¬Â¦ÃƒÂ¥Ã‚ÂÃ‚Â« OHLCV ÃƒÂ§Ã…Â¡Ã¢â‚¬Å¾ DataFrame
        """
        period_map = {
            1: "1y",
            2: "2y",
            3: "3y",  # yfinance ÃƒÂ¤Ã‚Â¸Ã‚ÂÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¯ÃƒÂ¦Ã‚ÂÃ‚Â´ 3yÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ§Ã¢â‚¬ÂÃ‚Â¨ 5y ÃƒÂ¤Ã‚Â»Ã‚Â£ÃƒÂ¦Ã¢â‚¬ÂºÃ‚Â¿
            5: "5y",
            10: "10y",
        }
        
        period = period_map.get(years, "10y")
        if years == 3:
            period = "5y"  # ÃƒÂ§Ã¢â‚¬Å¾Ã‚Â¶ÃƒÂ¥Ã‚Â¾Ã…â€™ÃƒÂ¥Ã…â€œÃ‚Â¨ÃƒÂ§Ã‚Â¨Ã¢â‚¬Â¹ÃƒÂ¥Ã‚Â¼Ã‚ÂÃƒÂ¤Ã‚Â¸Ã‚Â­ÃƒÂ©Ã‚ÂÃ…Â½ÃƒÂ¦Ã‚Â¿Ã‚Â¾
        
        df = self.get_stock_history(symbol, period=period)
        
        if df is None:
            return None
        
        # ÃƒÂ¥Ã‚Â¦Ã¢â‚¬Å¡ÃƒÂ¦Ã…Â¾Ã…â€œÃƒÂ¦Ã‹Å“Ã‚Â¯ 3 ÃƒÂ¥Ã‚Â¹Ã‚Â´ÃƒÂ¯Ã‚Â¼Ã…â€™ÃƒÂ©Ã…â€œÃ¢â€šÂ¬ÃƒÂ¨Ã‚Â¦Ã‚ÂÃƒÂ©Ã‚ÂÃ…Â½ÃƒÂ¦Ã‚Â¿Ã‚Â¾
        if years == 3:
            cutoff_date = datetime.now().date() - timedelta(days=3 * 365)
            df = df[df["date"] >= cutoff_date]
        
        return df


# ÃƒÂ¥Ã‚Â»Ã‚ÂºÃƒÂ§Ã‚Â«Ã¢â‚¬Â¹ÃƒÂ¥Ã¢â‚¬Â¦Ã‚Â¨ÃƒÂ¥Ã…Â¸Ã…Â¸ÃƒÂ¥Ã‚Â®Ã‚Â¢ÃƒÂ¦Ã‹â€ Ã‚Â¶ÃƒÂ§Ã‚Â«Ã‚Â¯ÃƒÂ¥Ã‚Â¯Ã‚Â¦ÃƒÂ¤Ã‚Â¾Ã¢â‚¬Â¹
yahoo_finance = YahooFinanceClient()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/dependencies/__init__.py  â­
> ä¾è³´æ³¨å…¥æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
ä¾è³´æ³¨å…¥æ¨¡çµ„
çµ±ä¸€ç®¡ç†èªè­‰ã€è³‡æ–™åº«ç­‰å…±ç”¨ä¾è³´
"""
from app.dependencies.auth import (
    get_current_user,
    get_admin_user,
    get_optional_user,
)

__all__ = [
    "get_current_user",
    "get_admin_user", 
    "get_optional_user",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/dependencies/auth.py  â­
> çµ±ä¸€èªè­‰ä¾è³´æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
çµ±ä¸€èªè­‰ä¾è³´æ¨¡çµ„
=================
è§£æ±ºå¤šå€‹ router é‡è¤‡å®šç¾© get_current_user çš„å•é¡Œ

ç”¨æ³•:
    from app.dependencies import get_current_user, get_admin_user
    
    @router.get("/my-data")
    async def my_endpoint(user: User = Depends(get_current_user)):
        ...
    
    @router.post("/admin/action")
    async def admin_endpoint(admin: User = Depends(get_admin_user)):
        ...
"""
from fastapi import Request, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional
import logging

from app.database import get_async_session
from app.models.user import User
from app.config import settings

logger = logging.getLogger(__name__)


async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session)
) -> User:
    """
    å¾ JWT Token å–å¾—ç•¶å‰ç™»å…¥ç”¨æˆ¶ï¼ˆå¿…é ˆç™»å…¥ï¼‰
    
    Raises:
        HTTPException 401: æœªæä¾› Token æˆ– Token ç„¡æ•ˆ
    """
    from app.services.auth_service import AuthService
    
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )
    
    return user


async def get_admin_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session)
) -> User:
    """
    è¦æ±‚ç®¡ç†å“¡æ¬Šé™ï¼ˆå¿…é ˆæ˜¯ç®¡ç†å“¡ï¼‰
    
    Raises:
        HTTPException 401: æœªæä¾› Token æˆ– Token ç„¡æ•ˆ
        HTTPException 403: ä¸æ˜¯ç®¡ç†å“¡
    """
    from app.services.auth_service import AuthService
    
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="æœªæä¾›èªè­‰ Token")
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        raise HTTPException(status_code=401, detail="ç„¡æ•ˆçš„ Token")
    
    # æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    if not user.is_admin:
        # æª¢æŸ¥æ˜¯å¦åœ¨ç’°å¢ƒè®Šæ•¸çš„åˆå§‹ç®¡ç†å“¡åå–®ä¸­
        admin_ids = settings.get_admin_line_ids()
        if user.line_user_id not in admin_ids:
            raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å“¡æ¬Šé™")
        
        # è‡ªå‹•è¨­å®šç‚ºç®¡ç†å“¡
        user.is_admin = True
        await db.commit()
        logger.info(f"Auto-promoted user {user.id} to admin")
    
    return user


async def get_optional_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session)
) -> Optional[User]:
    """
    å¯é¸èªè­‰ - æœ‰ Token å°±é©—è­‰ï¼Œæ²’æœ‰ä¹Ÿå…è¨±ï¼ˆè¿”å› Noneï¼‰
    
    é©ç”¨å ´æ™¯:
        - å…¬é–‹ API ä½†ç™»å…¥ç”¨æˆ¶æœ‰é¡å¤–åŠŸèƒ½
        - éœ€è¦åˆ¤æ–·æ˜¯å¦ç™»å…¥çš„æ··åˆé é¢
    """
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        return None
    
    try:
        from app.services.auth_service import AuthService
        token = auth_header.split(" ")[1]
        auth_service = AuthService(db)
        user = await auth_service.get_user_from_token(token)
        return user
    except Exception:
        return None
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/exceptions/__init__.py  â­
> è‡ªè¨‚ç•°å¸¸é¡åˆ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è‡ªè¨‚ç•°å¸¸é¡åˆ¥
============
çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
"""


class SELAException(Exception):
    """SELA åŸºç¤ç•°å¸¸"""
    status_code: int = 400
    error_code: str = "SELA_ERROR"
    
    def __init__(self, message: str, error_code: str = None):
        self.message = message
        if error_code:
            self.error_code = error_code
        super().__init__(message)


class StockNotFoundError(SELAException):
    """æ‰¾ä¸åˆ°è‚¡ç¥¨"""
    status_code = 404
    error_code = "STOCK_NOT_FOUND"
    
    def __init__(self, symbol: str):
        super().__init__(f"æ‰¾ä¸åˆ°è‚¡ç¥¨: {symbol}")
        self.symbol = symbol


class CryptoNotFoundError(SELAException):
    """æ‰¾ä¸åˆ°åŠ å¯†è²¨å¹£"""
    status_code = 404
    error_code = "CRYPTO_NOT_FOUND"
    
    def __init__(self, symbol: str):
        super().__init__(f"æ‰¾ä¸åˆ°åŠ å¯†è²¨å¹£: {symbol}")
        self.symbol = symbol


class AuthenticationError(SELAException):
    """èªè­‰å¤±æ•—"""
    status_code = 401
    error_code = "AUTH_FAILED"
    
    def __init__(self, message: str = "èªè­‰å¤±æ•—"):
        super().__init__(message)


class AuthorizationError(SELAException):
    """æ¬Šé™ä¸è¶³"""
    status_code = 403
    error_code = "FORBIDDEN"
    
    def __init__(self, message: str = "æ¬Šé™ä¸è¶³"):
        super().__init__(message)


class RateLimitError(SELAException):
    """è«‹æ±‚éæ–¼é »ç¹"""
    status_code = 429
    error_code = "RATE_LIMITED"
    
    def __init__(self, message: str = "è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦"):
        super().__init__(message)


class DataSourceError(SELAException):
    """å¤–éƒ¨è³‡æ–™ä¾†æºéŒ¯èª¤"""
    status_code = 502
    error_code = "DATA_SOURCE_ERROR"
    
    def __init__(self, source: str, message: str = None):
        msg = f"{source} è³‡æ–™ä¾†æºéŒ¯èª¤"
        if message:
            msg += f": {message}"
        super().__init__(msg)
        self.source = source


class ValidationError(SELAException):
    """è³‡æ–™é©—è­‰éŒ¯èª¤"""
    status_code = 422
    error_code = "VALIDATION_ERROR"


class CacheError(SELAException):
    """å¿«å–éŒ¯èª¤"""
    status_code = 500
    error_code = "CACHE_ERROR"
    
    def __init__(self, message: str = "å¿«å–æ“ä½œå¤±æ•—"):
        super().__init__(message)


class DatabaseError(SELAException):
    """è³‡æ–™åº«éŒ¯èª¤"""
    status_code = 500
    error_code = "DATABASE_ERROR"
    
    def __init__(self, message: str = "è³‡æ–™åº«æ“ä½œå¤±æ•—"):
        super().__init__(message)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/logging_config.py  â­
> æ—¥èªŒè¨­å®š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ—¥èªŒè¨­å®š
ç¢ºä¿æ‰€æœ‰é‡è¦æ“ä½œéƒ½æœ‰è¨˜éŒ„
"""
import logging
import sys
from datetime import datetime
from pathlib import Path


def setup_logging(log_level: str = "INFO", log_to_file: bool = True):
    """
    è¨­å®šæ—¥èªŒç³»çµ±
    
    Args:
        log_level: æ—¥èªŒç­‰ç´š (DEBUG, INFO, WARNING, ERROR)
        log_to_file: æ˜¯å¦å¯«å…¥æª”æ¡ˆ
    """
    # å»ºç«‹ logs ç›®éŒ„
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)
    
    # æ—¥èªŒæ ¼å¼
    log_format = "%(asctime)s | %(levelname)-8s | %(name)s | %(message)s"
    date_format = "%Y-%m-%d %H:%M:%S"
    
    # å»ºç«‹ formatter
    formatter = logging.Formatter(log_format, datefmt=date_format)
    
    # å–å¾— root logger
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, log_level.upper(), logging.INFO))
    
    # æ¸…é™¤ç¾æœ‰çš„ handlers
    root_logger.handlers.clear()
    
    # Console handler
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    console_handler.setLevel(logging.INFO)
    root_logger.addHandler(console_handler)
    
    if log_to_file:
        # ä¸»è¦æ—¥èªŒæª”ï¼ˆæ‰€æœ‰æ—¥èªŒï¼‰
        today = datetime.now().strftime("%Y-%m-%d")
        main_log_file = log_dir / f"app_{today}.log"
        file_handler = logging.FileHandler(main_log_file, encoding="utf-8")
        file_handler.setFormatter(formatter)
        file_handler.setLevel(logging.DEBUG)
        root_logger.addHandler(file_handler)
        
        # èªè­‰æ—¥èªŒæª”ï¼ˆç™»å…¥/ç™»å‡ºï¼‰
        auth_logger = logging.getLogger("app.services.auth_service")
        auth_log_file = log_dir / f"auth_{today}.log"
        auth_handler = logging.FileHandler(auth_log_file, encoding="utf-8")
        auth_handler.setFormatter(formatter)
        auth_handler.setLevel(logging.INFO)
        auth_logger.addHandler(auth_handler)
        
        # Watchlist æ—¥èªŒæª”
        watchlist_logger = logging.getLogger("app.services.watchlist_service")
        watchlist_log_file = log_dir / f"watchlist_{today}.log"
        watchlist_handler = logging.FileHandler(watchlist_log_file, encoding="utf-8")
        watchlist_handler.setFormatter(formatter)
        watchlist_handler.setLevel(logging.INFO)
        watchlist_logger.addHandler(watchlist_handler)
    
    # è¨­å®šç¬¬ä¸‰æ–¹å¥—ä»¶çš„æ—¥èªŒç­‰ç´š
    logging.getLogger("httpx").setLevel(logging.WARNING)
    logging.getLogger("httpcore").setLevel(logging.WARNING)
    logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)
    logging.getLogger("uvicorn").setLevel(logging.INFO)
    
    root_logger.info("æ—¥èªŒç³»çµ±åˆå§‹åŒ–å®Œæˆ")
    if log_to_file:
        root_logger.info(f"æ—¥èªŒæª”æ¡ˆ: {log_dir.absolute()}")


def get_logger(name: str) -> logging.Logger:
    """å–å¾— logger"""
    return logging.getLogger(name)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/__init__.py  â­
> æ’ç¨‹ä»»å‹™æ¨¡çµ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ’ç¨‹ä»»å‹™æ¨¡çµ„
"""
from app.tasks.scheduler import scheduler_service, SchedulerService

__all__ = [
    "scheduler_service",
    "SchedulerService",
]
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/price_cache_task.py  â­
> åƒ¹æ ¼å¿«å–æ’ç¨‹ä»»å‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
åƒ¹æ ¼å¿«å–æ’ç¨‹ä»»å‹™

æ’ç¨‹é‚è¼¯ï¼š
1. æ¯ 10 åˆ†é˜åŸ·è¡Œ run_update()
   - è‡ªå‹•åˆ¤æ–·å“ªäº›å¸‚å ´é–‹ç›¤
   - åªæ›´æ–°é–‹ç›¤ä¸­çš„å¸‚å ´
   
2. æ”¶ç›¤å¾Œå„åŸ·è¡Œä¸€æ¬¡ï¼ˆç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹ï¼‰
   - å°è‚¡ï¼š13:35
   - ç¾è‚¡ï¼š05:05
"""
import logging
from datetime import datetime
from typing import Dict, Any

from app.database import SyncSessionLocal
from app.services.price_cache_service import PriceCacheService, get_market_status

logger = logging.getLogger(__name__)


class PriceCacheScheduler:
    """åƒ¹æ ¼å¿«å–æ’ç¨‹å™¨"""
    
    def __init__(self):
        self.last_run: datetime = None
        self.last_result: Dict[str, Any] = {}
    
    def run_update(self) -> Dict[str, Any]:
        """
        åŸ·è¡Œåƒ¹æ ¼å¿«å–æ›´æ–°ï¼ˆæ¯ 10 åˆ†é˜ï¼‰
        
        è‡ªå‹•åˆ¤æ–·ï¼š
        - å°è‚¡é–‹ç›¤ (09:00-13:30) â†’ æ›´æ–°å°è‚¡
        - ç¾è‚¡é–‹ç›¤ (21:30-05:00) â†’ æ›´æ–°ç¾è‚¡
        - åŠ å¯†è²¨å¹£ â†’ 24 å°æ™‚æ›´æ–°
        """
        market_status = get_market_status()
        
        # å¦‚æœæ‰€æœ‰è‚¡å¸‚éƒ½æ”¶ç›¤ï¼Œåªæ›´æ–°åŠ å¯†è²¨å¹£
        if not market_status["tw_open"] and not market_status["us_open"]:
            logger.info("å°è‚¡ç¾è‚¡çš†æ”¶ç›¤ï¼Œåªæ›´æ–°åŠ å¯†è²¨å¹£")
        
        return self._do_update(force=False)
    
    def run_force_update(self) -> Dict[str, Any]:
        """
        å¼·åˆ¶æ›´æ–°æ‰€æœ‰å¸‚å ´ï¼ˆç”¨æ–¼æ”¶ç›¤å¾Œæˆ–æ‰‹å‹•è§¸ç™¼ï¼‰
        """
        logger.info("å¼·åˆ¶æ›´æ–°æ‰€æœ‰å¸‚å ´")
        return self._do_update(force=True)
    
    def run_tw_close_update(self) -> Dict[str, Any]:
        """
        å°è‚¡æ”¶ç›¤å¾Œæ›´æ–°ï¼ˆ13:35 åŸ·è¡Œï¼‰
        ç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹
        """
        logger.info("å°è‚¡æ”¶ç›¤ï¼ŒåŸ·è¡Œæœ€çµ‚æ›´æ–°")
        
        db = SyncSessionLocal()
        try:
            service = PriceCacheService(db)
            tracked = service.get_all_tracked_symbols()
            
            if tracked["tw_stocks"]:
                result = service.batch_update_stock_prices(tracked["tw_stocks"])
                logger.info(f"å°è‚¡æ”¶ç›¤æ›´æ–°å®Œæˆ: {result['updated']} æ”¯")
                return result
            return {"updated": 0, "message": "ç„¡å°è‚¡è¿½è¹¤"}
            
        except Exception as e:
            logger.error(f"å°è‚¡æ”¶ç›¤æ›´æ–°å¤±æ•—: {e}")
            return {"error": str(e)}
        finally:
            db.close()
    
    def run_us_close_update(self) -> Dict[str, Any]:
        """
        ç¾è‚¡æ”¶ç›¤å¾Œæ›´æ–°ï¼ˆ05:05 åŸ·è¡Œï¼‰
        ç¢ºä¿æœ‰æœ€çµ‚æ”¶ç›¤åƒ¹
        """
        logger.info("ç¾è‚¡æ”¶ç›¤ï¼ŒåŸ·è¡Œæœ€çµ‚æ›´æ–°")
        
        db = SyncSessionLocal()
        try:
            service = PriceCacheService(db)
            tracked = service.get_all_tracked_symbols()
            
            if tracked["us_stocks"]:
                result = service.batch_update_stock_prices(tracked["us_stocks"])
                logger.info(f"ç¾è‚¡æ”¶ç›¤æ›´æ–°å®Œæˆ: {result['updated']} æ”¯")
                return result
            return {"updated": 0, "message": "ç„¡ç¾è‚¡è¿½è¹¤"}
            
        except Exception as e:
            logger.error(f"ç¾è‚¡æ”¶ç›¤æ›´æ–°å¤±æ•—: {e}")
            return {"error": str(e)}
        finally:
            db.close()
    
    def _do_update(self, force: bool = False) -> Dict[str, Any]:
        """åŸ·è¡Œæ›´æ–°"""
        logger.info("=" * 50)
        logger.info(f"æ’ç¨‹: é–‹å§‹æ›´æ–°åƒ¹æ ¼å¿«å– (force={force})")
        logger.info(f"æ™‚é–“: {datetime.now()}")
        logger.info("=" * 50)
        
        db = SyncSessionLocal()
        
        try:
            service = PriceCacheService(db)
            result = service.update_all_tracked_prices(force=force)
            
            self.last_run = datetime.now()
            self.last_result = result
            
            logger.info(f"æ’ç¨‹: åƒ¹æ ¼å¿«å–æ›´æ–°å®Œæˆ, å…± {result['total_updated']} ç­†")
            
            return result
            
        except Exception as e:
            logger.error(f"æ’ç¨‹: åƒ¹æ ¼å¿«å–æ›´æ–°å¤±æ•—: {e}", exc_info=True)
            return {
                "success": False,
                "error": str(e),
                "timestamp": datetime.now().isoformat(),
            }
        finally:
            db.close()
    
    def get_status(self) -> Dict[str, Any]:
        """å–å¾—æ’ç¨‹ç‹€æ…‹"""
        return {
            "last_run": self.last_run.isoformat() if self.last_run else None,
            "last_result": self.last_result,
            "market_status": get_market_status(),
        }


# å…¨åŸŸå¯¦ä¾‹
price_cache_scheduler = PriceCacheScheduler()


# ============================================================
# APScheduler è¨­å®šç¯„ä¾‹ï¼ˆåŠ åˆ° main.pyï¼‰
# ============================================================

"""
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from app.tasks.price_cache_task import price_cache_scheduler

scheduler = AsyncIOScheduler()

# 1. æ¯ 10 åˆ†é˜åŸ·è¡Œï¼ˆè‡ªå‹•åˆ¤æ–·é–‹ç›¤æ™‚é–“ï¼‰
scheduler.add_job(
    price_cache_scheduler.run_update,
    'interval',
    minutes=10,
    id='price_cache_interval',
    name='åƒ¹æ ¼å¿«å–æ›´æ–°(æ¯10åˆ†é˜)',
)

# 2. å°è‚¡æ”¶ç›¤å¾ŒåŸ·è¡Œä¸€æ¬¡ï¼ˆé€±ä¸€åˆ°é€±äº” 13:35ï¼‰
scheduler.add_job(
    price_cache_scheduler.run_tw_close_update,
    CronTrigger(day_of_week='mon-fri', hour=13, minute=35),
    id='price_cache_tw_close',
    name='å°è‚¡æ”¶ç›¤æ›´æ–°',
)

# 3. ç¾è‚¡æ”¶ç›¤å¾ŒåŸ·è¡Œä¸€æ¬¡ï¼ˆé€±äºŒåˆ°é€±å…­ 05:05ï¼Œå°æ‡‰ç¾è‚¡é€±ä¸€åˆ°é€±äº”ï¼‰
scheduler.add_job(
    price_cache_scheduler.run_us_close_update,
    CronTrigger(day_of_week='tue-sat', hour=5, minute=5),
    id='price_cache_us_close',
    name='ç¾è‚¡æ”¶ç›¤æ›´æ–°',
)

# å•Ÿå‹•æ’ç¨‹
@app.on_event("startup")
async def startup_event():
    scheduler.start()
    # å•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡ï¼ˆå¼·åˆ¶æ›´æ–°æ‰€æœ‰ï¼‰
    price_cache_scheduler.run_force_update()

@app.on_event("shutdown")
async def shutdown_event():
    scheduler.shutdown()
"""
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/scheduler.py  â­
> æ’ç¨‹ä»»å‹™æœå‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
æ’ç¨‹ä»»å‹™æœå‹™
æ¯æ—¥è‡ªå‹•æ›´æ–°è‚¡åƒ¹ã€æŒ‡æ•¸ã€æƒ…ç·’è³‡æ–™ï¼Œä¸¦ç™¼é€è¨Šè™Ÿé€šçŸ¥
"""
import asyncio
from datetime import datetime, date, timedelta
from typing import Dict, Any, List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import select, distinct, and_
import logging

from app.database import SyncSessionLocal, AsyncSessionLocal
from app.models.watchlist import Watchlist
from app.models.stock_price import StockPrice
from app.models.index_price import IndexPrice, INDEX_SYMBOLS
from app.models.market_sentiment import MarketSentiment
from app.models.notification import Notification
from app.models.user import User
from app.models.user_settings import UserAlertSettings
from app.services.market_service import MarketService
from app.services.signal_service import signal_service, SignalType
from app.data_sources.yahoo_finance import yahoo_finance

logger = logging.getLogger(__name__)


class SchedulerService:
    """æ’ç¨‹ä»»å‹™æœå‹™"""
    
    # é‡è¦è¨Šè™Ÿé¡å‹ï¼ˆåªé€šçŸ¥é€™äº›ï¼‰
    IMPORTANT_SIGNAL_TYPES = [
        # äº¤å‰è¨Šè™Ÿ
        SignalType.MA_GOLDEN_CROSS,
        SignalType.MA_DEATH_CROSS,
        SignalType.MACD_GOLDEN_CROSS,
        SignalType.MACD_DEATH_CROSS,
        SignalType.KD_GOLDEN_CROSS,
        SignalType.KD_DEATH_CROSS,
        # RSI æ¥µç«¯å€¼
        SignalType.RSI_OVERBOUGHT,
        SignalType.RSI_OVERSOLD,
    ]
    
    def __init__(self):
        self.last_run: Optional[datetime] = None
        self.last_result: Dict[str, Any] = {}
    
    def _get_db(self) -> Session:
        """å–å¾—è³‡æ–™åº« session"""
        return SyncSessionLocal()
    
    def run_daily_update(self) -> Dict[str, Any]:
        """
        åŸ·è¡Œæ¯æ—¥æ›´æ–°ä»»å‹™
        
        åŒ…å«ï¼š
        1. æ›´æ–°æ‰€æœ‰è¿½è¹¤è‚¡ç¥¨çš„åƒ¹æ ¼
        2. æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
        3. æ›´æ–°å¸‚å ´æƒ…ç·’
        4. åµæ¸¬è¨Šè™Ÿä¸¦ç™¼é€é€šçŸ¥
        
        Returns:
            åŸ·è¡Œçµæœæ‘˜è¦
        """
        logger.info("=" * 50)
        logger.info("é–‹å§‹åŸ·è¡Œæ¯æ—¥æ›´æ–°ä»»å‹™")
        logger.info(f"åŸ·è¡Œæ™‚é–“: {datetime.now()}")
        logger.info("=" * 50)
        
        result = {
            "start_time": datetime.now().isoformat(),
            "stocks_updated": 0,
            "indices_updated": {},
            "sentiment_updated": {},
            "signals_detected": 0,
            "notifications_sent": 0,
            "errors": [],
        }
        
        db = self._get_db()
        
        try:
            # 1. æ›´æ–°è¿½è¹¤è‚¡ç¥¨
            stocks_result = self._update_watchlist_stocks(db)
            result["stocks_updated"] = stocks_result["count"]
            if stocks_result.get("errors"):
                result["errors"].extend(stocks_result["errors"])
            
            # 2. æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
            market_service = MarketService(db)
            indices_result = self._update_indices(market_service)
            result["indices_updated"] = indices_result
            
            # 3. æ›´æ–°å¸‚å ´æƒ…ç·’
            sentiment_result = market_service.update_today_sentiment()
            result["sentiment_updated"] = sentiment_result
            
            # 4. åµæ¸¬è¨Šè™Ÿä¸¦ç™¼é€é€šçŸ¥
            signal_result = self._detect_and_notify(db)
            result["signals_detected"] = signal_result.get("signals_count", 0)
            result["notifications_sent"] = signal_result.get("notifications_sent", 0)
            if signal_result.get("errors"):
                result["errors"].extend(signal_result["errors"])
            
            result["end_time"] = datetime.now().isoformat()
            result["success"] = True
            
            logger.info("=" * 50)
            logger.info("æ¯æ—¥æ›´æ–°ä»»å‹™å®Œæˆ")
            logger.info(f"è‚¡ç¥¨æ›´æ–°: {result['stocks_updated']} æª”")
            logger.info(f"æŒ‡æ•¸æ›´æ–°: {result['indices_updated']}")
            logger.info(f"æƒ…ç·’æ›´æ–°: {result['sentiment_updated']}")
            logger.info(f"è¨Šè™Ÿåµæ¸¬: {result['signals_detected']} å€‹")
            logger.info(f"é€šçŸ¥ç™¼é€: {result['notifications_sent']} äºº")
            logger.info("=" * 50)
            
        except Exception as e:
            logger.error(f"æ¯æ—¥æ›´æ–°ä»»å‹™å¤±æ•—: {e}")
            result["errors"].append(str(e))
            result["success"] = False
        finally:
            db.close()
        
        self.last_run = datetime.now()
        self.last_result = result
        
        return result
    
    def _detect_and_notify(self, db: Session) -> Dict[str, Any]:
        """
        åµæ¸¬è¨Šè™Ÿä¸¦ç™¼é€é€šçŸ¥
        
        æµç¨‹ï¼š
        1. å–å¾—æ‰€æœ‰ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®ï¼ˆè¯é›†ï¼‰
        2. å°æ¯æ”¯è‚¡ç¥¨è¨ˆç®—æŒ‡æ¨™ä¸¦åµæ¸¬è¨Šè™Ÿ
        3. æ ¹æ“šç”¨æˆ¶è¨­å®šç™¼é€é€šçŸ¥
        """
        result = {
            "signals_count": 0,
            "notifications_sent": 0,
            "errors": [],
        }
        
        logger.info("é–‹å§‹åµæ¸¬è¨Šè™Ÿ...")
        
        try:
            # 1. å–å¾—æ‰€æœ‰è¿½è¹¤çš„è‚¡ç¥¨
            stmt = select(distinct(Watchlist.symbol)).where(Watchlist.asset_type == "stock")
            symbols = db.execute(stmt).scalars().all()
            logger.info(f"éœ€è¦åµæ¸¬çš„è‚¡ç¥¨: {len(symbols)} æª”")
            
            # 2. å°æ¯æ”¯è‚¡ç¥¨åµæ¸¬è¨Šè™Ÿ
            all_signals = {}  # {symbol: [signals]}
            
            for symbol in symbols:
                try:
                    signals = self._detect_signals_for_symbol(symbol)
                    
                    # åªä¿ç•™äº¤å‰è¨Šè™Ÿ
                    cross_signals = [s for s in signals if s.signal_type in self.IMPORTANT_SIGNAL_TYPES]
                    
                    if cross_signals:
                        all_signals[symbol] = cross_signals
                        result["signals_count"] += len(cross_signals)
                        logger.info(f"{symbol}: åµæ¸¬åˆ° {len(cross_signals)} å€‹äº¤å‰è¨Šè™Ÿ")
                
                except Exception as e:
                    logger.error(f"åµæ¸¬ {symbol} è¨Šè™Ÿå¤±æ•—: {e}")
                    result["errors"].append(f"{symbol}: {str(e)}")
            
            logger.info(f"å…±åµæ¸¬åˆ° {result['signals_count']} å€‹äº¤å‰è¨Šè™Ÿ")
            
            if not all_signals:
                logger.info("ä»Šæ—¥ç„¡äº¤å‰è¨Šè™Ÿï¼Œä¸ç™¼é€é€šçŸ¥")
                return result
            
            # 3. å–å¾—éœ€è¦é€šçŸ¥çš„ç”¨æˆ¶
            users_to_notify = self._get_users_to_notify(db, all_signals)
            logger.info(f"éœ€è¦é€šçŸ¥çš„ç”¨æˆ¶: {len(users_to_notify)} äºº")
            
            # 4. ç™¼é€é€šçŸ¥
            for user_id, user_data in users_to_notify.items():
                try:
                    success = self._send_notification(db, user_data)
                    if success:
                        result["notifications_sent"] += 1
                except Exception as e:
                    logger.error(f"ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶ {user_id} å¤±æ•—: {e}")
                    result["errors"].append(f"notify user {user_id}: {str(e)}")
            
        except Exception as e:
            logger.error(f"è¨Šè™Ÿåµæ¸¬å¤±æ•—: {e}")
            result["errors"].append(str(e))
        
        return result
    
    def _detect_signals_for_symbol(self, symbol: str) -> List:
        """å°å–®ä¸€è‚¡ç¥¨åµæ¸¬è¨Šè™Ÿ"""
        from app.services.indicator_service import indicator_service, SignalType as IndicatorSignalType
        
        # å–å¾—è‚¡ç¥¨è³‡æ–™
        df = yahoo_finance.get_stock_history(symbol, period="3mo")
        
        if df is None or df.empty:
            return []
        
        # è¨ˆç®—æŒ‡æ¨™
        df = indicator_service.calculate_all_indicators(df)
        
        if df is None or df.empty:
            return []
        
        # å–å¾—è¨Šè™Ÿ
        indicator_signals = indicator_service.get_all_signals(df)
        
        if not indicator_signals:
            return []
        
        # è½‰æ›è¨Šè™Ÿæ ¼å¼ï¼ˆå¾ indicator_service.Signal åˆ° signal_service.Signalï¼‰
        from app.services.signal_service import Signal, SignalType
        
        signals = []
        current_price = float(df.iloc[-1]['close']) if 'close' in df.columns else 0
        
        # è¨Šè™Ÿé¡å‹å°ç…§
        type_mapping = {
            IndicatorSignalType.GOLDEN_CROSS: SignalType.MA_GOLDEN_CROSS,
            IndicatorSignalType.DEATH_CROSS: SignalType.MA_DEATH_CROSS,
            IndicatorSignalType.RSI_OVERBOUGHT: SignalType.RSI_OVERBOUGHT,
            IndicatorSignalType.RSI_OVERSOLD: SignalType.RSI_OVERSOLD,
            IndicatorSignalType.MACD_GOLDEN_CROSS: SignalType.MACD_GOLDEN_CROSS,
            IndicatorSignalType.MACD_DEATH_CROSS: SignalType.MACD_DEATH_CROSS,
            IndicatorSignalType.KD_GOLDEN_CROSS: SignalType.KD_GOLDEN_CROSS,
            IndicatorSignalType.KD_DEATH_CROSS: SignalType.KD_DEATH_CROSS,
            IndicatorSignalType.APPROACHING_BREAKOUT: SignalType.APPROACHING_BREAKOUT,
            IndicatorSignalType.APPROACHING_BREAKDOWN: SignalType.APPROACHING_BREAKDOWN,
        }
        
        for ind_sig in indicator_signals:
            sig_type = type_mapping.get(ind_sig.type)
            if sig_type:
                signals.append(Signal(
                    symbol=symbol,
                    asset_type="stock",
                    signal_type=sig_type,
                    indicator=ind_sig.indicator,
                    message=ind_sig.description,
                    price=current_price,
                    details={},
                    timestamp=datetime.now(),
                ))
        
        return signals
    
    def _get_users_to_notify(self, db: Session, all_signals: Dict) -> Dict:
        """
        å–å¾—éœ€è¦é€šçŸ¥çš„ç”¨æˆ¶
        
        Returns:
            {user_id: {
                "line_user_id": "xxx",
                "display_name": "xxx",
                "signals": [...]
            }}
        """
        users_to_notify = {}
        
        # å–å¾—æ‰€æœ‰ç”¨æˆ¶å’Œä»–å€‘çš„è¿½è¹¤æ¸…å–®
        stmt = select(User).where(User.is_active == True, User.is_blocked == False)
        users = db.execute(stmt).scalars().all()
        
        for user in users:
            # å–å¾—ç”¨æˆ¶çš„è¿½è¹¤æ¸…å–®
            watchlist_stmt = select(Watchlist.symbol).where(
                Watchlist.user_id == user.id,
                Watchlist.asset_type == "stock"
            )
            user_symbols = set(db.execute(watchlist_stmt).scalars().all())
            
            # å–å¾—ç”¨æˆ¶çš„é€šçŸ¥è¨­å®šï¼ˆæª¢æŸ¥æ˜¯å¦é–‹å•Ÿäº¤å‰é€šçŸ¥ï¼‰
            alert_stmt = select(UserAlertSettings).where(UserAlertSettings.user_id == user.id)
            alert_settings = db.execute(alert_stmt).scalar_one_or_none()
            
            # é è¨­é–‹å•Ÿ MA å’Œ MACD äº¤å‰é€šçŸ¥
            alert_ma = True
            alert_macd = True
            alert_kd = False
            alert_rsi = True  # é è¨­é–‹å•Ÿ RSI
            
            if alert_settings:
                alert_ma = alert_settings.alert_ma_cross
                alert_macd = alert_settings.alert_macd
                alert_kd = alert_settings.alert_kd
                alert_rsi = alert_settings.alert_rsi
            
            # æ‰¾å‡ºç”¨æˆ¶è¿½è¹¤ä¸­æœ‰è¨Šè™Ÿçš„è‚¡ç¥¨
            user_signals = []
            for symbol, signals in all_signals.items():
                if symbol not in user_symbols:
                    continue
                
                for signal in signals:
                    # æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦é–‹å•Ÿè©²é¡å‹çš„é€šçŸ¥
                    if signal.signal_type in [SignalType.MA_GOLDEN_CROSS, SignalType.MA_DEATH_CROSS]:
                        if not alert_ma:
                            continue
                    elif signal.signal_type in [SignalType.MACD_GOLDEN_CROSS, SignalType.MACD_DEATH_CROSS]:
                        if not alert_macd:
                            continue
                    elif signal.signal_type in [SignalType.KD_GOLDEN_CROSS, SignalType.KD_DEATH_CROSS]:
                        if not alert_kd:
                            continue
                    elif signal.signal_type in [SignalType.RSI_OVERBOUGHT, SignalType.RSI_OVERSOLD]:
                        if not alert_rsi:
                            continue
                    
                    # æª¢æŸ¥ 24 å°æ™‚å…§æ˜¯å¦å·²é€šçŸ¥é
                    if self._has_recent_notification(db, user.id, symbol, signal.signal_type.value):
                        continue
                    
                    user_signals.append(signal)
            
            if user_signals:
                users_to_notify[user.id] = {
                    "user_id": user.id,
                    "line_user_id": user.line_user_id,
                    "display_name": user.display_name,
                    "signals": user_signals,
                }
        
        return users_to_notify
    
    def _has_recent_notification(self, db: Session, user_id: int, symbol: str, alert_type: str) -> bool:
        """æª¢æŸ¥ 24 å°æ™‚å…§æ˜¯å¦å·²ç™¼é€éç›¸åŒé€šçŸ¥"""
        cutoff = datetime.now() - timedelta(hours=24)
        
        stmt = select(Notification).where(
            Notification.user_id == user_id,
            Notification.symbol == symbol,
            Notification.alert_type == alert_type,
            Notification.triggered_at >= cutoff,
        )
        
        existing = db.execute(stmt).scalar_one_or_none()
        return existing is not None
    
    def _send_notification(self, db: Session, user_data: Dict) -> bool:
        """ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶"""
        from app.services.line_notify_service import line_notify_service
        
        line_user_id = user_data["line_user_id"]
        signals = user_data["signals"]
        
        if not line_user_id or not signals:
            return False
        
        # åˆ†é¡è¨Šè™Ÿ
        bullish = []
        bearish = []
        
        for signal in signals:
            signal_name = signal_service.SIGNAL_NAMES.get(signal.signal_type, str(signal.signal_type))
            item = {
                "symbol": signal.symbol,
                "signal": signal_name,
                "price": signal.price,
                "signal_type": signal.signal_type.value,
            }
            
            # åˆ¤æ–·å¤šç©º
            if signal.signal_type in [
                SignalType.MA_GOLDEN_CROSS, 
                SignalType.MACD_GOLDEN_CROSS, 
                SignalType.KD_GOLDEN_CROSS,
                SignalType.RSI_OVERSOLD,
            ]:
                bullish.append(item)
            else:
                bearish.append(item)
        
        # æ ¼å¼åŒ–è¨Šæ¯
        message = self._format_notification_message(bullish, bearish)
        
        # ç™¼é€è¨Šæ¯ï¼ˆä½¿ç”¨ asyncio åŸ·è¡Œï¼‰
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            success = loop.run_until_complete(
                line_notify_service.push_text_message(line_user_id, message)
            )
            loop.close()
        except Exception as e:
            logger.error(f"ç™¼é€ LINE è¨Šæ¯å¤±æ•—: {e}")
            success = False
        
        # è¨˜éŒ„é€šçŸ¥
        for signal in signals:
            notification = Notification(
                user_id=user_data.get("user_id"),
                symbol=signal.symbol,
                asset_type=signal.asset_type,
                alert_type=signal.signal_type.value,
                indicator=signal.indicator,
                message=signal.message,
                price_at_trigger=signal.price,
                sent=success,
                sent_at=datetime.now() if success else None,
            )
            db.add(notification)
        
        db.commit()
        
        return success
    
    def _format_notification_message(self, bullish: List[Dict], bearish: List[Dict]) -> str:
        """æ ¼å¼åŒ–æ¯æ—¥è¨Šè™Ÿé€šçŸ¥è¨Šæ¯"""
        lines = ["ğŸ“Š SELA é¸è‚¡ç³»çµ± - æ¯æ—¥è¨Šè™Ÿ", ""]
        
        if bullish:
            lines.append("ğŸŸ¢ åå¤šè¨Šè™Ÿ")
            for item in bullish:
                price_str = f" @ ${item['price']:.2f}" if item['price'] > 0 else ""
                lines.append(f"  â€¢ {item['symbol']}{price_str}")
                lines.append(f"    {item['signal']}")
            lines.append("")
        
        if bearish:
            lines.append("ğŸ”´ åç©ºè¨Šè™Ÿ")
            for item in bearish:
                price_str = f" @ ${item['price']:.2f}" if item['price'] > 0 else ""
                lines.append(f"  â€¢ {item['symbol']}{price_str}")
                lines.append(f"    {item['signal']}")
            lines.append("")
        
        if not bullish and not bearish:
            lines.append("ä»Šæ—¥æ‚¨çš„è¿½è¹¤æ¸…å–®ç„¡é‡è¦è¨Šè™Ÿ âœ¨")
            lines.append("")
        
        lines.append(f"â° {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        
        return "\n".join(lines)
    
    def run_signal_detection_only(self) -> Dict[str, Any]:
        """
        åªåŸ·è¡Œè¨Šè™Ÿåµæ¸¬ï¼ˆä¸ç™¼é€é€šçŸ¥ï¼‰
        ç”¨æ–¼æ¸¬è©¦
        """
        logger.info("é–‹å§‹è¨Šè™Ÿåµæ¸¬ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰...")
        
        result = {
            "signals": [],
            "by_symbol": {},
        }
        
        db = self._get_db()
        
        try:
            stmt = select(distinct(Watchlist.symbol)).where(Watchlist.asset_type == "stock")
            symbols = db.execute(stmt).scalars().all()
            
            for symbol in symbols:
                try:
                    signals = self._detect_signals_for_symbol(symbol)
                    cross_signals = [s for s in signals if s.signal_type in self.IMPORTANT_SIGNAL_TYPES]
                    
                    if cross_signals:
                        result["by_symbol"][symbol] = [
                            {
                                "type": s.signal_type.value,
                                "message": s.message,
                                "price": s.price,
                            }
                            for s in cross_signals
                        ]
                        result["signals"].extend(cross_signals)
                
                except Exception as e:
                    logger.error(f"{symbol} åµæ¸¬å¤±æ•—: {e}")
        
        finally:
            db.close()
        
        return result

    def _update_watchlist_stocks(self, db: Session) -> Dict[str, Any]:
        """
        æ›´æ–°æ‰€æœ‰è¿½è¹¤æ¸…å–®ä¸­çš„è‚¡ç¥¨
        """
        result = {"count": 0, "errors": []}
        
        # å–å¾—æ‰€æœ‰ä¸é‡è¤‡çš„è¿½è¹¤è‚¡ç¥¨
        stmt = select(distinct(Watchlist.symbol)).where(Watchlist.asset_type == "stock")
        symbols = db.execute(stmt).scalars().all()
        
        logger.info(f"éœ€è¦æ›´æ–°çš„è‚¡ç¥¨: {len(symbols)} æª”")
        
        for symbol in symbols:
            try:
                # å¾ Yahoo Finance æŠ“å–æœ€æ–°è³‡æ–™
                df = yahoo_finance.get_stock_history(symbol, period="5d")
                
                if df is None or df.empty:
                    logger.warning(f"ç„¡æ³•å–å¾— {symbol} çš„è³‡æ–™")
                    result["errors"].append(f"{symbol}: ç„¡è³‡æ–™")
                    continue
                
                # å„²å­˜åˆ°è³‡æ–™åº«
                count = self._save_stock_prices(db, df)
                result["count"] += 1
                logger.debug(f"{symbol} æ›´æ–°å®Œæˆï¼Œæ–°å¢ {count} ç­†")
                
            except Exception as e:
                logger.error(f"æ›´æ–° {symbol} å¤±æ•—: {e}")
                result["errors"].append(f"{symbol}: {str(e)}")
        
        return result
    
    def _save_stock_prices(self, db: Session, df) -> int:
        """å„²å­˜è‚¡ç¥¨åƒ¹æ ¼"""
        if df is None or df.empty:
            return 0
        
        count = 0
        for _, row in df.iterrows():
            stmt = select(StockPrice).where(
                and_(
                    StockPrice.symbol == row["symbol"],
                    StockPrice.date == row["date"],
                )
            )
            existing = db.execute(stmt).scalar_one_or_none()
            
            if existing:
                existing.open = row["open"]
                existing.high = row["high"]
                existing.low = row["low"]
                existing.close = row["close"]
                existing.volume = row["volume"]
            else:
                price = StockPrice(
                    symbol=row["symbol"],
                    date=row["date"],
                    open=row["open"],
                    high=row["high"],
                    low=row["low"],
                    close=row["close"],
                    volume=row["volume"],
                )
                db.add(price)
                count += 1
        
        db.commit()
        return count
    
    def _update_indices(self, market_service: MarketService) -> Dict[str, int]:
        """
        æ›´æ–°ä¸‰å¤§æŒ‡æ•¸ï¼ˆåªæ›´æ–°æœ€è¿‘ 5 å¤©ï¼‰
        """
        result = {}
        
        for symbol in INDEX_SYMBOLS.keys():
            try:
                df = yahoo_finance.get_index_data(symbol, period="5d")
                if df is not None:
                    count = market_service.save_index_data(df, symbol)
                    result[symbol] = count
                else:
                    result[symbol] = 0
            except Exception as e:
                logger.error(f"æ›´æ–°æŒ‡æ•¸ {symbol} å¤±æ•—: {e}")
                result[symbol] = -1
        
        return result
    
    def initialize_historical_data(self, years: int = 10) -> Dict[str, Any]:
        """
        åˆå§‹åŒ–æ­·å²è³‡æ–™ï¼ˆé¦–æ¬¡åŸ·è¡Œæ™‚ä½¿ç”¨ï¼‰
        
        åŒ…å«ï¼š
        1. ä¸‰å¤§æŒ‡æ•¸ 10 å¹´æ­·å²
        2. å¹£åœˆæƒ…ç·’ 365 å¤©æ­·å²
        
        Args:
            years: æŒ‡æ•¸æ­·å²å¹´æ•¸
            
        Returns:
            åŸ·è¡Œçµæœ
        """
        logger.info("=" * 50)
        logger.info("é–‹å§‹åˆå§‹åŒ–æ­·å²è³‡æ–™")
        logger.info("=" * 50)
        
        result = {
            "start_time": datetime.now().isoformat(),
            "indices": {},
            "crypto_sentiment": 0,
            "errors": [],
        }
        
        db = self._get_db()
        
        try:
            market_service = MarketService(db)
            
            # 1. åˆå§‹åŒ–ä¸‰å¤§æŒ‡æ•¸
            logger.info(f"åˆå§‹åŒ–ä¸‰å¤§æŒ‡æ•¸ ({years} å¹´è³‡æ–™)...")
            indices_result = market_service.fetch_and_save_all_indices(period=f"{years}y")
            result["indices"] = indices_result
            
            # 2. åˆå§‹åŒ–å¹£åœˆæƒ…ç·’æ­·å²
            logger.info("åˆå§‹åŒ–å¹£åœˆæƒ…ç·’æ­·å² (365 å¤©)...")
            crypto_count = market_service.fetch_and_save_crypto_history(days=365)
            result["crypto_sentiment"] = crypto_count
            
            result["success"] = True
            result["end_time"] = datetime.now().isoformat()
            
            logger.info("=" * 50)
            logger.info("æ­·å²è³‡æ–™åˆå§‹åŒ–å®Œæˆ")
            logger.info(f"æŒ‡æ•¸: {result['indices']}")
            logger.info(f"å¹£åœˆæƒ…ç·’: {result['crypto_sentiment']} ç­†")
            logger.info("=" * 50)
            
        except Exception as e:
            logger.error(f"åˆå§‹åŒ–å¤±æ•—: {e}")
            result["errors"].append(str(e))
            result["success"] = False
        finally:
            db.close()
        
        return result
    
    def get_status(self) -> Dict[str, Any]:
        """å–å¾—æ’ç¨‹ç‹€æ…‹"""
        return {
            "last_run": self.last_run.isoformat() if self.last_run else None,
            "last_result": self.last_result,
        }


# å»ºç«‹å…¨åŸŸæ’ç¨‹æœå‹™å¯¦ä¾‹
scheduler_service = SchedulerService()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ app/tasks/subscription_tasks.py  â­
> è¨‚é–±ç²¾é¸æ’ç¨‹ä»»å‹™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
"""
è¨‚é–±ç²¾é¸æ’ç¨‹ä»»å‹™
æ¯å°æ™‚æŠ“å–ä¸€æ¬¡ RSS
"""
import logging
from datetime import datetime

from app.database import SessionLocal
from app.services.subscription_service import SubscriptionService

logger = logging.getLogger(__name__)


def scheduled_fetch_subscriptions():
    """
    æ’ç¨‹ä»»å‹™ï¼šæŠ“å–æ‰€æœ‰è¨‚é–±æº
    æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    """
    logger.info("=" * 40)
    logger.info(f"é–‹å§‹æ’ç¨‹æŠ“å–è¨‚é–±æº - {datetime.now()}")
    logger.info("=" * 40)
    
    try:
        db = SessionLocal()
        service = SubscriptionService(db)
        
        # æŠ“å–æ‰€æœ‰è¨‚é–±æºï¼ˆéå›æº¯æ¨¡å¼ï¼ŒåªæŠ“æ–°çš„ï¼‰
        result = service.fetch_all_sources(backfill=False)
        
        logger.info(f"æŠ“å–å®Œæˆ: æ–°å¢ {result['total_new']}, æ›´æ–° {result['total_updated']}")
        
        db.close()
        return result
        
    except Exception as e:
        logger.error(f"æ’ç¨‹æŠ“å–å¤±æ•—: {e}", exc_info=True)
        return None


def init_and_backfill():
    """
    åˆå§‹åŒ–ä¸¦å›æº¯æŠ“å–
    é¦–æ¬¡éƒ¨ç½²æ™‚åŸ·è¡Œ
    """
    logger.info("=" * 40)
    logger.info("åˆå§‹åŒ–è¨‚é–±æºä¸¦å›æº¯æŠ“å–")
    logger.info("=" * 40)
    
    try:
        db = SessionLocal()
        service = SubscriptionService(db)
        
        # åˆå§‹åŒ–é è¨­è¨‚é–±æº
        service.init_default_sources()
        
        # å›æº¯æŠ“å– 30 å¤©
        result = service.fetch_all_sources(backfill=True)
        
        logger.info(f"å›æº¯å®Œæˆ: æ–°å¢ {result['total_new']}, æ›´æ–° {result['total_updated']}")
        
        db.close()
        return result
        
    except Exception as e:
        logger.error(f"åˆå§‹åŒ–å¤±æ•—: {e}", exc_info=True)
        return None
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ BACKEND_CHANGES.md  â­
> P2 å¾Œç«¯ä¿®æ”¹èªªæ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# P2 å¾Œç«¯ä¿®æ”¹èªªæ˜

## 1. ä¿®æ”¹ `app/routers/stock.py` - å¢åŠ  chart_data.volumes å’Œ MA é€²éšåˆ†æ

æ‰¾åˆ° `get_stock_analysis` å‡½æ•¸ä¸­çš„ `chart_data` éƒ¨åˆ†ï¼Œä¿®æ”¹ç‚ºï¼š

```python
# æ·»åŠ åœ–è¡¨æ•¸æ“š (æœ€è¿‘ 1500 å¤©ï¼Œæ”¯æ´ 5 å¹´ç¯„åœ)
"chart_data": {
    "dates": [str(d) for d in df['date'].tail(1500).tolist()],
    "prices": [float(p) for p in df['close'].tail(1500).tolist()],
    "volumes": [int(v) if not pd.isna(v) else 0 for v in df['volume'].tail(1500).tolist()] if 'volume' in df.columns else [],  # ğŸ†• æˆäº¤é‡
    "ma20": [float(v) if not pd.isna(v) else None for v in df['ma20'].tail(1500).tolist()] if 'ma20' in df.columns else [],
    "ma50": [float(v) if not pd.isna(v) else None for v in df['ma50'].tail(1500).tolist()] if 'ma50' in df.columns else [],
    "ma200": [float(v) if not pd.isna(v) else None for v in df['ma200'].tail(1500).tolist()] if 'ma200' in df.columns else [],
    "ma250": [float(v) if not pd.isna(v) else None for v in df['ma250'].tail(1500).tolist()] if 'ma250' in df.columns else [],
},
```

## 2. ä¿®æ”¹ `app/routers/stock.py` æˆ– `app/services/indicator_service.py` - å¢åŠ  MA é€²éšåˆ†æ

åœ¨ indicators.ma éƒ¨åˆ†å¢åŠ ä»¥ä¸‹æ¬„ä½ï¼š

```python
def analyze_ma_advanced(df, current_price):
    """è¨ˆç®— MA é€²éšåˆ†æ"""
    result = {}
    
    # è·é›¢å‡ç·šç™¾åˆ†æ¯”
    if 'ma20' in df.columns and not pd.isna(df['ma20'].iloc[-1]):
        ma20 = df['ma20'].iloc[-1]
        result['dist_ma20'] = round((current_price - ma20) / ma20 * 100, 2)
    
    if 'ma50' in df.columns and not pd.isna(df['ma50'].iloc[-1]):
        ma50 = df['ma50'].iloc[-1]
        result['dist_ma50'] = round((current_price - ma50) / ma50 * 100, 2)
    
    if 'ma200' in df.columns and not pd.isna(df['ma200'].iloc[-1]):
        ma200 = df['ma200'].iloc[-1]
        result['dist_ma200'] = round((current_price - ma200) / ma200 * 100, 2)
    
    # é»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰åµæ¸¬ (æœ€è¿‘ 30 å¤©å…§)
    if 'ma20' in df.columns and 'ma50' in df.columns:
        for i in range(min(30, len(df) - 1), 0, -1):
            idx = -i
            prev_idx = idx - 1
            
            if pd.isna(df['ma20'].iloc[idx]) or pd.isna(df['ma50'].iloc[idx]):
                continue
            if pd.isna(df['ma20'].iloc[prev_idx]) or pd.isna(df['ma50'].iloc[prev_idx]):
                continue
            
            # é»ƒé‡‘äº¤å‰: MA20 ç”±ä¸‹å¾€ä¸Šç©¿è¶Š MA50
            if df['ma20'].iloc[prev_idx] < df['ma50'].iloc[prev_idx] and df['ma20'].iloc[idx] >= df['ma50'].iloc[idx]:
                result['golden_cross_20_50'] = True
                result['golden_cross_20_50_days'] = i
                break
            
            # æ­»äº¡äº¤å‰: MA20 ç”±ä¸Šå¾€ä¸‹ç©¿è¶Š MA50
            if df['ma20'].iloc[prev_idx] > df['ma50'].iloc[prev_idx] and df['ma20'].iloc[idx] <= df['ma50'].iloc[idx]:
                result['death_cross_20_50'] = True
                result['death_cross_20_50_days'] = i
                break
    
    # MA50/MA200 äº¤å‰åµæ¸¬
    if 'ma50' in df.columns and 'ma200' in df.columns:
        for i in range(min(30, len(df) - 1), 0, -1):
            idx = -i
            prev_idx = idx - 1
            
            if pd.isna(df['ma50'].iloc[idx]) or pd.isna(df['ma200'].iloc[idx]):
                continue
            if pd.isna(df['ma50'].iloc[prev_idx]) or pd.isna(df['ma200'].iloc[prev_idx]):
                continue
            
            if df['ma50'].iloc[prev_idx] < df['ma200'].iloc[prev_idx] and df['ma50'].iloc[idx] >= df['ma200'].iloc[idx]:
                result['golden_cross_50_200'] = True
                result['golden_cross_50_200_days'] = i
                break
            
            if df['ma50'].iloc[prev_idx] > df['ma200'].iloc[prev_idx] and df['ma50'].iloc[idx] <= df['ma200'].iloc[idx]:
                result['death_cross_50_200'] = True
                result['death_cross_50_200_days'] = i
                break
    
    return result
```

ç„¶å¾Œåœ¨ `get_stock_analysis` ä¸­èª¿ç”¨ä¸¦åˆä½µåˆ° `indicators.ma`ï¼š

```python
# åœ¨ indicators å»ºæ§‹å¾Œ
ma_advanced = analyze_ma_advanced(df, current_price)
# åˆä½µåˆ° ma æŒ‡æ¨™
indicators["ma"].update(ma_advanced)
```

## 3. æ–°å¢ `app/routers/watchlist.py` - ç†±é–€è¿½è¹¤ API

```python
@router.get("/popular", summary="å–å¾—ç†±é–€è¿½è¹¤è‚¡ç¥¨")
async def get_popular_stocks(
    limit: int = Query(10, ge=1, le=50, description="è¿”å›æ•¸é‡"),
    db: Session = Depends(get_db)
):
    """
    å–å¾—æœ€å¤šäººè¿½è¹¤çš„è‚¡ç¥¨æ’è¡Œ
    """
    from sqlalchemy import func
    
    try:
        # çµ±è¨ˆæ¯å€‹ symbol è¢«è¿½è¹¤çš„æ¬¡æ•¸
        popular = db.query(
            Watchlist.symbol,
            func.count(Watchlist.user_id).label('count')
        ).group_by(Watchlist.symbol).order_by(func.count(Watchlist.user_id).desc()).limit(limit).all()
        
        result = [{"symbol": row.symbol, "count": row.count} for row in popular]
        
        return {
            "success": True,
            "data": result
        }
    except Exception as e:
        logger.error(f"å–å¾—ç†±é–€è¿½è¹¤å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

## 4. HTML ä¿®æ”¹ - dashboard.html

åœ¨å„€è¡¨æ¿é é¢å¢åŠ ç†±é–€è¿½è¹¤å€å¡Šï¼š

```html
<!-- ç†±é–€è¿½è¹¤ -->
<div class="bg-white rounded-xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-700">ğŸ”¥ ç†±é–€è¿½è¹¤</h3>
        <button onclick="loadPopularStocks()" class="text-gray-400 hover:text-blue-600 text-sm">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    <div id="popularStocksContainer">
        <div class="text-center py-4 text-gray-400 text-sm">
            <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...
        </div>
    </div>
</div>
```

## 5. HTML ä¿®æ”¹ - å…¨è¢å¹•åœ–è¡¨å¢åŠ æˆäº¤é‡å€åŸŸ

åœ¨ `chartFullscreen` modal ä¸­çš„åœ–è¡¨ä¸‹æ–¹å¢åŠ ï¼š

```html
<!-- æˆäº¤é‡åœ–è¡¨ -->
<div id="volumeChartContainer" class="hidden mt-2" style="height: 100px;">
    <canvas id="volumeChart"></canvas>
</div>
```

---

## å¿«é€Ÿæ•´åˆæ­¥é©Ÿ

1. è¤‡è£½ `search.js` åˆ° `static/js/search.js`
2. è¤‡è£½ `dashboard.js` åˆ° `static/js/dashboard.js`
3. ä¿®æ”¹å¾Œç«¯ `app/routers/stock.py` å¢åŠ  volumes å’Œ MA é€²éšåˆ†æ
4. ä¿®æ”¹å¾Œç«¯ `app/routers/watchlist.py` å¢åŠ  `/popular` API
5. ä¿®æ”¹ `dashboard.html` å¢åŠ ç†±é–€è¿½è¹¤å€å¡Šå’Œæˆäº¤é‡åœ–è¡¨å®¹å™¨
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ migrations/add_target_price.sql  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```sql
-- æ·»åŠ  target_price æ¬„ä½åˆ° watchlists è¡¨
-- åŸ·è¡Œæ™‚é–“: éƒ¨ç½²å¾Œè‡ªå‹•åŸ·è¡Œ

ALTER TABLE watchlists 
ADD COLUMN IF NOT EXISTS target_price NUMERIC(12, 4) DEFAULT NULL;

-- æ·»åŠ è¨»è§£
COMMENT ON COLUMN watchlists.target_price IS 'ç›®æ¨™åƒ¹æ ¼ï¼Œç”¨æ–¼åˆ°åƒ¹æé†’';
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ railway.json  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port $PORT",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ ROUTER_CHANGES.md  â­
> ğŸ“‹ Router ä¿®æ”¹å¿«é€Ÿåƒè€ƒ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ“‹ Router ä¿®æ”¹å¿«é€Ÿåƒè€ƒ

ä»¥ä¸‹æ˜¯å„ router æª”æ¡ˆéœ€è¦ä¿®æ”¹çš„å…·é«”å…§å®¹ã€‚

---

## ğŸ”§ é€šç”¨ä¿®æ”¹æ¨¡å¼

### åˆªé™¤ï¼ˆç´„ 15-20 è¡Œï¼‰

æ‰¾åˆ°ä¸¦**åˆªé™¤**é¡ä¼¼ä»¥ä¸‹çš„é‡è¤‡ç¨‹å¼ç¢¼ï¼š

```python
# âŒ åˆªé™¤é€™æ•´æ®µ
async def get_current_user(
    request: Request,
    db: AsyncSession = Depends(get_async_session),
) -> User:
    """ä¾è³´æ³¨å…¥ï¼šå–å¾—ç•¶å‰ç”¨æˆ¶"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        logger.warning("API: æœªæä¾›èªè­‰ Token")
        raise HTTPException(
            status_code=401,
            detail="æœªæä¾›èªè­‰ Token"
        )
    
    token = auth_header.split(" ")[1]
    auth_service = AuthService(db)
    user = await auth_service.get_user_from_token(token)
    
    if not user:
        logger.warning("API: Token é©—è­‰å¤±æ•—")
        raise HTTPException(
            status_code=401,
            detail="ç„¡æ•ˆçš„ Token"
        )
    
    return user
```

ä¹Ÿè¦åˆªé™¤å¯èƒ½å­˜åœ¨çš„ `get_optional_user` å’Œ `get_current_admin` é‡è¤‡å®šç¾©ã€‚

### æ–°å¢ï¼ˆ1 è¡Œï¼‰

åœ¨æª”æ¡ˆé–‹é ­çš„ import å€åŠ å…¥ï¼š

```python
# âœ… åŠ å…¥é€™è¡Œ
from app.dependencies import get_current_user, get_admin_user, get_optional_user
```

---

## ğŸ“ å„æª”æ¡ˆå…·é«”ä¿®æ”¹

### 1. `app/routers/subscription.py`

```python
# åˆªé™¤ç´„ç¬¬ 20-40 è¡Œçš„ get_current_user å®šç¾©

# åœ¨ import å€åŠ å…¥
from app.dependencies import get_current_user, get_admin_user
```

**å·²æä¾›å®Œæ•´ä¿®æ”¹å¾Œç‰ˆæœ¬**: `sela_p0_fix/app/routers/subscription.py`

---

### 2. `app/routers/portfolio.py`

```python
# åˆªé™¤ç´„ç¬¬ 70-90 è¡Œçš„ get_current_user å®šç¾©

# åœ¨ import å€åŠ å…¥ï¼ˆç´„ç¬¬ 15 è¡Œï¼‰
from app.dependencies import get_current_user
```

**æ³¨æ„**: portfolio.py åªç”¨åˆ° `get_current_user`ï¼Œä¸éœ€è¦ admin

---

### 3. `app/routers/compare.py`

```python
# åˆªé™¤ç´„ç¬¬ 20-50 è¡Œçš„ get_current_user å’Œ get_optional_user å®šç¾©

# åœ¨ import å€åŠ å…¥
from app.dependencies import get_current_user, get_optional_user
```

---

### 4. `app/routers/watchlist.py`

```python
# åˆªé™¤é‡è¤‡çš„ get_current_user å®šç¾©

# åœ¨ import å€åŠ å…¥
from app.dependencies import get_current_user
```

---

### 5. `app/routers/market.py`

```python
# åˆªé™¤ç´„ç¬¬ 20-50 è¡Œçš„ get_current_user_optional å’Œ get_current_admin å®šç¾©

# åœ¨ import å€åŠ å…¥
from app.dependencies import get_optional_user, get_admin_user

# æ³¨æ„ï¼šmarket.py ä½¿ç”¨çš„æ˜¯ get_current_user_optionalï¼Œéœ€è¦æ”¹æˆ get_optional_user
# æˆ–è€…ä½¿ç”¨å‘ä¸‹ç›¸å®¹åˆ¥å get_current_user_optional
```

---

### 6. `app/routers/admin.py`

```python
# admin.py å·²ç¶“æœ‰è‡ªå·±çš„ get_admin_userï¼Œå¯ä»¥æ”¹ç”¨çµ±ä¸€ç‰ˆæœ¬

# åœ¨ import å€åŠ å…¥
from app.dependencies import get_admin_user

# åˆªé™¤åŸæœ¬çš„ get_admin_user å®šç¾©
```

---

## ğŸ” å¿«é€Ÿæœå°‹æŒ‡ä»¤

ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ‰¾å‡ºæ‰€æœ‰éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆï¼š

```bash
# æ‰¾å‡ºæ‰€æœ‰å®šç¾© get_current_user çš„æª”æ¡ˆ
grep -rn "async def get_current_user" app/routers/

# æ‰¾å‡ºæ‰€æœ‰å®šç¾© get_current_admin çš„æª”æ¡ˆ  
grep -rn "async def get_current_admin" app/routers/

# æ‰¾å‡ºæ‰€æœ‰å®šç¾© get_optional_user çš„æª”æ¡ˆ
grep -rn "async def get_optional_user" app/routers/
grep -rn "async def get_current_user_optional" app/routers/
```

---

## âœ… ä¿®æ”¹æª¢æŸ¥æ¸…å–®

| æª”æ¡ˆ | åˆªé™¤é‡è¤‡èªè­‰ | åŠ å…¥ import | æ¸¬è©¦ |
|------|-------------|-------------|------|
| subscription.py | â˜ | â˜ | â˜ |
| portfolio.py | â˜ | â˜ | â˜ |
| compare.py | â˜ | â˜ | â˜ |
| watchlist.py | â˜ | â˜ | â˜ |
| market.py | â˜ | â˜ | â˜ |
| admin.py | â˜ | â˜ | â˜ |

---

## ğŸ’¡ å°æŠ€å·§

1. **é€ä¸€ä¿®æ”¹**: æ¯æ”¹ä¸€å€‹æª”æ¡ˆå°±æ¸¬è©¦ï¼Œç¢ºä¿æ²’å•é¡Œå†æ”¹ä¸‹ä¸€å€‹
2. **ä¿ç•™å‚™ä»½**: ä¿®æ”¹å‰å…ˆ `cp file.py file.py.bak`
3. **IDE æœå°‹**: ä½¿ç”¨ VS Code çš„å…¨åŸŸæœå°‹åŠŸèƒ½æ›´æ–¹ä¾¿
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ runtime.txt  â­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```text
python-3.11.0
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ scripts/åŒ¯æ•´å­ç¨‹å¼.py  â­
> å°ˆæ¡ˆæ•´åˆå·¥å…· - æŠŠè³‡æ–™å¤¾çµæ§‹å’Œç¨‹å¼ç¢¼æ•´åˆæˆå–®ä¸€æª”æ¡ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
#!/usr/bin/env python3
"""
å°ˆæ¡ˆæ•´åˆå·¥å…· - æŠŠè³‡æ–™å¤¾çµæ§‹å’Œç¨‹å¼ç¢¼æ•´åˆæˆå–®ä¸€æª”æ¡ˆ
ç”¨é€”ï¼šä¸Šå‚³åˆ° Claude å°ˆæ¡ˆä½œç‚º context
"""

import os
from pathlib import Path
from datetime import datetime

# ===== è¨­å®š =====
IGNORE_DIRS = {'.git', '__pycache__', '.venv', 'venv', 'node_modules', '.idea', '.vscode', 'dist', 'build', '__MACOSX'}
IGNORE_FILES = {'.DS_Store', 'Thumbs.db', '.gitignore', '*.pyc', '*.pyo'}
CODE_EXTENSIONS = {'.py', '.js', '.ts', '.html', '.css', '.json', '.yaml', '.yml', '.md', '.txt', '.sql', '.sh', '.env.example'}
MAX_FILE_SIZE = 100 * 1024  # 100KBï¼Œè¶…éçš„æª”æ¡ˆåªé¡¯ç¤ºè·¯å¾‘ä¸é¡¯ç¤ºå…§å®¹


def should_ignore(path: Path) -> bool:
    """åˆ¤æ–·æ˜¯å¦è¦å¿½ç•¥æ­¤è·¯å¾‘"""
    if path.name in IGNORE_DIRS or path.name in IGNORE_FILES:
        return True
    if path.name.startswith('.') and path.name not in {'.env.example'}:
        return True
    return False


def generate_tree(root: Path, prefix: str = "") -> list[str]:
    """ç”¢ç”Ÿç›®éŒ„æ¨¹ç‹€åœ–"""
    lines = []
    items = sorted(root.iterdir(), key=lambda x: (x.is_file(), x.name.lower()))
    items = [x for x in items if not should_ignore(x)]
    
    for i, item in enumerate(items):
        is_last = i == len(items) - 1
        connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
        
        if item.is_dir():
            lines.append(f"{prefix}{connector}{item.name}/")
            extension = "    " if is_last else "â”‚   "
            lines.extend(generate_tree(item, prefix + extension))
        else:
            lines.append(f"{prefix}{connector}{item.name}")
    
    return lines


def collect_files(root: Path) -> list[Path]:
    """æ”¶é›†æ‰€æœ‰ç¨‹å¼ç¢¼æª”æ¡ˆ"""
    files = []
    for path in root.rglob('*'):
        if path.is_file() and not should_ignore(path):
            # æª¢æŸ¥çˆ¶ç›®éŒ„æ˜¯å¦åœ¨å¿½ç•¥æ¸…å–®
            if any(p.name in IGNORE_DIRS for p in path.parents):
                continue
            if path.suffix.lower() in CODE_EXTENSIONS or path.name in {'Dockerfile', 'Makefile', 'requirements.txt', 'Procfile'}:
                files.append(path)
    return sorted(files, key=lambda x: str(x).lower())


def bundle_project(target_dir: str, output_file: str = None):
    """ä¸»ç¨‹å¼ï¼šæ•´åˆå°ˆæ¡ˆ"""
    root = Path(target_dir).resolve()
    
    if not root.exists():
        print(f"âŒ æ‰¾ä¸åˆ°è³‡æ–™å¤¾: {root}")
        return
    
    if output_file is None:
        output_file = f"{root.name}_bundle.txt"
    
    output_path = Path(output_file).resolve()
    
    with open(output_path, 'w', encoding='utf-8') as out:
        # æ¨™é¡Œ
        out.write(f"{'='*70}\n")
        out.write(f"å°ˆæ¡ˆåç¨±: {root.name}\n")
        out.write(f"æ•´åˆæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        out.write(f"{'='*70}\n\n")
        
        # ç›®éŒ„çµæ§‹
        out.write("## ç›®éŒ„çµæ§‹\n\n")
        out.write("```\n")
        out.write(f"{root.name}/\n")
        for line in generate_tree(root):
            out.write(f"{line}\n")
        out.write("```\n\n")
        
        # æª”æ¡ˆå…§å®¹
        out.write(f"{'='*70}\n")
        out.write("## æª”æ¡ˆå…§å®¹\n")
        out.write(f"{'='*70}\n\n")
        
        files = collect_files(root)
        
        for filepath in files:
            rel_path = filepath.relative_to(root)
            out.write(f"\n{'â”€'*70}\n")
            out.write(f"### {rel_path}\n")
            out.write(f"{'â”€'*70}\n\n")
            
            # æª¢æŸ¥æª”æ¡ˆå¤§å°
            if filepath.stat().st_size > MAX_FILE_SIZE:
                out.write(f"ï¼ˆæª”æ¡ˆéå¤§ï¼Œç•¥éå…§å®¹ï¼š{filepath.stat().st_size / 1024:.1f} KBï¼‰\n")
                continue
            
            try:
                content = filepath.read_text(encoding='utf-8')
                # æ ¹æ“šå‰¯æª”ååŠ ä¸Š code block
                lang = filepath.suffix.lstrip('.') or 'text'
                if lang == 'txt':
                    lang = 'text'
                out.write(f"```{lang}\n")
                out.write(content)
                if not content.endswith('\n'):
                    out.write('\n')
                out.write("```\n")
            except UnicodeDecodeError:
                out.write("ï¼ˆäºŒé€²ä½æª”æ¡ˆï¼Œç•¥éï¼‰\n")
            except Exception as e:
                out.write(f"ï¼ˆè®€å–éŒ¯èª¤ï¼š{e}ï¼‰\n")
        
        # çµ±è¨ˆ
        out.write(f"\n{'='*70}\n")
        out.write(f"## çµ±è¨ˆ\n")
        out.write(f"å…± {len(files)} å€‹æª”æ¡ˆ\n")
        out.write(f"{'='*70}\n")
    
    print(f"âœ… å®Œæˆï¼è¼¸å‡ºæª”æ¡ˆ: {output_path}")
    print(f"   å…±æ•´åˆ {len(files)} å€‹æª”æ¡ˆ")


if __name__ == "__main__":
    import sys
    
    if len(sys.argv) < 2:
        # é è¨­ä½¿ç”¨ç›®å‰ç›®éŒ„
        target = "."
    else:
        target = sys.argv[1]
    
    output = sys.argv[2] if len(sys.argv) > 2 else None
    bundle_project(target, output)
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ UI_UNIFIED_GUIDE.md  â­
> ğŸ”§ SELA UI çµ±ä¸€ä¿®å¾©æŒ‡å—
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# ğŸ”§ SELA UI çµ±ä¸€ä¿®å¾©æŒ‡å—

## å•é¡Œ
é»é¸ã€Œå ±é…¬ç‡æ¯”è¼ƒã€ã€ã€Œå¾Œå°ç®¡ç†ã€æ™‚æœƒè·³è½‰åˆ°ç¨ç«‹é é¢ï¼Œå¤±å»å°èˆªåˆ—ã€‚

## ç›®æ¨™
çµ±ä¸€ UI é«”é©—ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ dashboard.html å…§ä»¥ section æ–¹å¼åˆ‡æ›ã€‚

---

## ä¿®æ”¹ 1ï¼šå´é‚Šæ¬„å°èˆªé€£çµ

### é›»è…¦ç‰ˆå´é‚Šæ¬„ (ç´„ç¬¬ 21875, 21884 è¡Œ)

**ä¿®æ”¹å‰ï¼š**
```html
<a href="/static/compare.html" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
    <i class="fas fa-trophy mr-3"></i>
    <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
</a>
...
<a id="adminSidebarLink" href="/static/admin.html" class="hidden flex items-center px-4 py-2 text-orange-500 hover:bg-orange-50 rounded-lg mt-4 border-t pt-4">
    <i class="fas fa-user-shield mr-3"></i>
    <span>ç®¡ç†å¾Œå°</span>
</a>
```

**ä¿®æ”¹å¾Œï¼š**
```html
<a href="#" onclick="showSection('cagr', event)" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg" data-section="cagr">
    <i class="fas fa-trophy mr-3"></i>
    <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
</a>
...
<a id="adminSidebarLink" href="#" onclick="showSection('admin', event)" class="hidden nav-link flex items-center px-4 py-2 text-orange-500 hover:bg-orange-50 rounded-lg mt-4 border-t pt-4" data-section="admin">
    <i class="fas fa-user-shield mr-3"></i>
    <span>ç®¡ç†å¾Œå°</span>
</a>
```

### æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„ (ç´„ç¬¬ 21787 è¡Œ)

**ä¿®æ”¹å‰ï¼š**
```html
<a href="/static/compare.html" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target">
    <i class="fas fa-trophy mr-3 w-5"></i>
    <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
</a>
```

**ä¿®æ”¹å¾Œï¼š**
```html
<a href="#" onclick="mobileNavTo('cagr')" class="mobile-nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg touch-target" data-section="cagr">
    <i class="fas fa-trophy mr-3 w-5"></i>
    <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
</a>
```

### é ‚éƒ¨å°èˆªçš„ç®¡ç†å“¡é€£çµ (ç´„ç¬¬ 21832 è¡Œ)

**ä¿®æ”¹å‰ï¼š**
```html
<a id="adminLink" href="/static/admin.html" class="text-orange-500 hover:text-orange-600 hidden p-2" title="ç®¡ç†å¾Œå°">
```

**ä¿®æ”¹å¾Œï¼š**
```html
<a id="adminLink" href="#" onclick="showSection('admin', event)" class="text-orange-500 hover:text-orange-600 hidden p-2" title="ç®¡ç†å¾Œå°">
```

---

## ä¿®æ”¹ 2ï¼šæ–°å¢ Section

åœ¨ `</main>` ä¹‹å‰ï¼ˆç´„ç¬¬ 22804 è¡Œï¼‰ï¼Œåœ¨ `section-settings` ä¹‹å¾Œæ–°å¢ï¼š

```html
            <!-- ===== å ±é…¬ç‡æ¯”è¼ƒå€å¡Š ===== -->
            <section id="section-cagr" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    å ±é…¬ç‡æ¯”è¼ƒ
                </h2>
                
                <!-- èªªæ˜å¡ç‰‡ -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-4 md:p-6 mb-4 text-white">
                    <h3 class="text-lg font-bold mb-2">ğŸ† å¹´åŒ–å ±é…¬ç‡ (CAGR) æ¯”è¼ƒå™¨</h3>
                    <p class="text-blue-100 text-sm">æ¯”è¼ƒè‚¡ç¥¨ã€åŠ å¯†è²¨å¹£ã€æŒ‡æ•¸çš„é•·æœŸæŠ•è³‡å ±é…¬è¡¨ç¾ï¼Œæ‰¾å‡ºæœ€ä½³æŠ•è³‡æ¨™çš„</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                    <!-- å·¦å´ï¼šé¸æ“‡æ¨™çš„ -->
                    <div class="lg:col-span-1 space-y-4">
                        <!-- å¿«é€Ÿé¸æ“‡é è¨­çµ„åˆ -->
                        <div class="bg-white rounded-xl shadow p-4">
                            <h3 class="font-bold text-gray-700 mb-3">ğŸš€ å¿«é€Ÿæ¯”è¼ƒ</h3>
                            <div class="space-y-2" id="cagrPresetList">
                                <button onclick="loadCagrPreset(['AAPL','MSFT','GOOGL','AMZN','META'])" class="w-full text-left px-3 py-2 border rounded-lg hover:bg-gray-50 text-sm">
                                    ğŸ“± ç§‘æŠ€äº”å·¨é ­
                                </button>
                                <button onclick="loadCagrPreset(['BTC','ETH','SOL'])" class="w-full text-left px-3 py-2 border rounded-lg hover:bg-gray-50 text-sm">
                                    ğŸª™ åŠ å¯†è²¨å¹£
                                </button>
                                <button onclick="loadCagrPreset(['^GSPC','^IXIC','^DJI'])" class="w-full text-left px-3 py-2 border rounded-lg hover:bg-gray-50 text-sm">
                                    ğŸ“Š ç¾åœ‹ä¸‰å¤§æŒ‡æ•¸
                                </button>
                                <button onclick="loadCagrPreset(['2330.TW','2317.TW','2454.TW'])" class="w-full text-left px-3 py-2 border rounded-lg hover:bg-gray-50 text-sm">
                                    ğŸ‡¹ğŸ‡¼ å°ç£æ¬Šå€¼è‚¡
                                </button>
                            </div>
                        </div>
                        
                        <!-- è‡ªè¨‚æ¨™çš„ -->
                        <div class="bg-white rounded-xl shadow p-4">
                            <h3 class="font-bold text-gray-700 mb-3">ğŸ¯ è‡ªè¨‚æ¨™çš„</h3>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="cagrSymbolInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ AAPL)" 
                                    class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                                    onkeypress="if(event.key==='Enter')addCagrSymbol()">
                                <button onclick="addCagrSymbol()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="cagrSymbolTags" class="flex flex-wrap gap-2 mb-3">
                                <!-- å‹•æ…‹ç”Ÿæˆçš„æ¨™ç±¤ -->
                            </div>
                            <button onclick="compareCagr()" class="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center justify-center">
                                <i class="fas fa-calculator mr-2"></i>
                                é–‹å§‹æ¯”è¼ƒ
                            </button>
                        </div>
                    </div>

                    <!-- å³å´ï¼šæ¯”è¼ƒçµæœ -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow p-4">
                            <h3 class="font-bold text-gray-700 mb-3">ğŸ“Š æ¯”è¼ƒçµæœ</h3>
                            <div id="cagrResults">
                                <p class="text-gray-400 text-center py-8">é¸æ“‡æ¨™çš„å¾Œé»æ“Šã€Œé–‹å§‹æ¯”è¼ƒã€</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== ç®¡ç†å¾Œå°å€å¡Š ===== -->
            <section id="section-admin" class="section hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6">
                    <i class="fas fa-user-shield text-orange-500 mr-2"></i>
                    ç®¡ç†å¾Œå°
                </h2>
                
                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4 mb-4 md:mb-6">
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ç¸½ç”¨æˆ¶æ•¸</div>
                        <div id="adminStatTotal" class="text-xl md:text-2xl font-bold text-slate-800">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ç¸½ç™»å…¥æ¬¡æ•¸</div>
                        <div id="adminStatTotalLogins" class="text-xl md:text-2xl font-bold text-purple-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ä»Šæ—¥ç™»å…¥</div>
                        <div id="adminStatToday" class="text-xl md:text-2xl font-bold text-green-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">å°é–ç”¨æˆ¶</div>
                        <div id="adminStatBlocked" class="text-xl md:text-2xl font-bold text-red-600">-</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 md:p-4">
                        <div class="text-gray-500 text-xs md:text-sm">ç®¡ç†å“¡</div>
                        <div id="adminStatAdmin" class="text-xl md:text-2xl font-bold text-blue-600">-</div>
                    </div>
                </div>

                <!-- ç³»çµ±ç®¡ç† -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š å¸‚å ´è³‡æ–™ç®¡ç†</h3>
                    <div class="flex flex-wrap gap-2 md:gap-3">
                        <button onclick="adminInitializeData()" class="bg-blue-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                            <i class="fas fa-sync mr-2"></i>åˆå§‹åŒ–æ­·å²è³‡æ–™
                        </button>
                        <button onclick="adminUpdateIndices()" class="bg-green-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-green-700 flex items-center text-sm">
                            <i class="fas fa-chart-line mr-2"></i>æ›´æ–°ä¸‰å¤§æŒ‡æ•¸
                        </button>
                        <button onclick="adminUpdateSentiment()" class="bg-purple-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center text-sm">
                            <i class="fas fa-brain mr-2"></i>æ›´æ–°ææ‡¼è²ªå©ª
                        </button>
                        <button onclick="adminTriggerDailyUpdate()" class="bg-orange-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center text-sm">
                            <i class="fas fa-bolt mr-2"></i>åŸ·è¡Œæ¯æ—¥æ›´æ–°
                        </button>
                    </div>
                    <p id="adminSystemMessage" class="mt-3 text-sm text-gray-500"></p>
                </div>

                <!-- è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­ -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6 mb-4">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ”” è¨Šè™Ÿæª¢æŸ¥èˆ‡æ¨æ’­</h3>
                    <div class="flex flex-wrap gap-2 md:gap-3 mb-3">
                        <button onclick="adminRunSignalCheck()" class="bg-indigo-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center text-sm">
                            <i class="fas fa-search mr-2"></i>åµæ¸¬è¨Šè™Ÿ
                        </button>
                        <button onclick="adminSendSignalNotifications()" class="bg-orange-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center text-sm">
                            <i class="fas fa-paper-plane mr-2"></i>ç™¼é€è¨Šè™Ÿé€šçŸ¥
                        </button>
                        <button onclick="adminTestLineNotify()" class="bg-green-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-green-600 flex items-center text-sm">
                            <i class="fab fa-line mr-2"></i>æ¸¬è©¦ LINE æ¨æ’­
                        </button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" id="adminTestSymbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæ¸¬è©¦è¨Šè™Ÿåµæ¸¬ (å¦‚ AAPL)"
                            class="flex-1 px-3 md:px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm">
                        <button onclick="adminTestSignalDetection()" class="bg-gray-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm">
                            æ¸¬è©¦åµæ¸¬
                        </button>
                    </div>
                    <p id="adminSignalMessage" class="mt-3 text-sm text-gray-500"></p>
                </div>

                <!-- ç”¨æˆ¶ç®¡ç† -->
                <div class="bg-white rounded-xl shadow p-4 md:p-6">
                    <h3 class="font-bold text-gray-700 mb-4">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h3>
                    <div class="flex flex-col md:flex-row gap-3 md:gap-4 mb-4">
                        <input type="text" id="adminSearchInput" placeholder="æœå°‹ç”¨æˆ¶åç¨±ã€Email æˆ– LINE ID..."
                            class="flex-1 px-3 md:px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm">
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="adminBlockedOnly" class="mr-2">
                                <span>åªé¡¯ç¤ºå°é–</span>
                            </label>
                            <button onclick="adminLoadUsers()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 text-sm">
                                æœå°‹
                            </button>
                        </div>
                    </div>
                    <div id="adminUserList" class="overflow-x-auto">
                        <p class="text-gray-400 text-center py-4">é»æ“Šæœå°‹æŸ¥çœ‹ç”¨æˆ¶åˆ—è¡¨</p>
                    </div>
                </div>
            </section>
```

---

## ä¿®æ”¹ 3ï¼šæ–°å¢ JavaScript å‡½æ•¸

åœ¨ `<script>` å€å¡Šä¸­æ–°å¢ä»¥ä¸‹å‡½æ•¸ï¼š

```javascript
// ========== å ±é…¬ç‡æ¯”è¼ƒåŠŸèƒ½ ==========
let cagrSymbols = [];

function addCagrSymbol() {
    const input = document.getElementById('cagrSymbolInput');
    const symbol = input.value.trim().toUpperCase();
    if (symbol && !cagrSymbols.includes(symbol) && cagrSymbols.length < 10) {
        cagrSymbols.push(symbol);
        renderCagrTags();
        input.value = '';
    }
}

function removeCagrSymbol(symbol) {
    cagrSymbols = cagrSymbols.filter(s => s !== symbol);
    renderCagrTags();
}

function renderCagrTags() {
    const container = document.getElementById('cagrSymbolTags');
    container.innerHTML = cagrSymbols.map(s => `
        <span class="inline-flex items-center px-3 py-1 bg-gray-100 rounded-full text-sm">
            ${s}
            <button onclick="removeCagrSymbol('${s}')" class="ml-2 text-gray-400 hover:text-red-500">
                <i class="fas fa-times"></i>
            </button>
        </span>
    `).join('');
}

function loadCagrPreset(symbols) {
    cagrSymbols = [...symbols];
    renderCagrTags();
    compareCagr();
}

async function compareCagr() {
    if (cagrSymbols.length === 0) {
        showToast('è«‹å…ˆæ·»åŠ è¦æ¯”è¼ƒçš„æ¨™çš„', 'warning');
        return;
    }
    
    const resultsDiv = document.getElementById('cagrResults');
    resultsDiv.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i><p class="mt-2 text-gray-500">è¨ˆç®—ä¸­...</p></div>';
    
    try {
        const response = await apiRequest(`/api/cagr/compare?symbols=${cagrSymbols.join(',')}`);
        if (response.success) {
            renderCagrResults(response.data);
        } else {
            resultsDiv.innerHTML = '<p class="text-red-500 text-center py-4">æŸ¥è©¢å¤±æ•—</p>';
        }
    } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-500 text-center py-4">éŒ¯èª¤: ${error.message}</p>`;
    }
}

function renderCagrResults(data) {
    const resultsDiv = document.getElementById('cagrResults');
    
    // æŒ‰ 10 å¹´ CAGR æ’åº
    const sorted = Object.entries(data).sort((a, b) => (b[1].cagr_10y || -999) - (a[1].cagr_10y || -999));
    
    let html = '<div class="space-y-3">';
    sorted.forEach(([symbol, info], index) => {
        const rankClass = index === 0 ? 'bg-yellow-50 border-yellow-300' : 
                         index === 1 ? 'bg-gray-50 border-gray-300' : 
                         index === 2 ? 'bg-orange-50 border-orange-300' : 'bg-white';
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `#${index + 1}`;
        
        html += `
            <div class="p-4 border rounded-lg ${rankClass}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">${medal}</span>
                        <span class="font-bold text-gray-800">${symbol}</span>
                        <span class="text-gray-500 text-sm ml-2">${info.name || ''}</span>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 text-sm">
                    <div>
                        <span class="text-gray-500">1å¹´</span>
                        <div class="${info.cagr_1y >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                            ${info.cagr_1y != null ? info.cagr_1y.toFixed(1) + '%' : '-'}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-500">3å¹´</span>
                        <div class="${info.cagr_3y >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                            ${info.cagr_3y != null ? info.cagr_3y.toFixed(1) + '%' : '-'}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-500">5å¹´</span>
                        <div class="${info.cagr_5y >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                            ${info.cagr_5y != null ? info.cagr_5y.toFixed(1) + '%' : '-'}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-500">10å¹´</span>
                        <div class="${info.cagr_10y >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">
                            ${info.cagr_10y != null ? info.cagr_10y.toFixed(1) + '%' : '-'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
}

// ========== ç®¡ç†å¾Œå°åŠŸèƒ½ ==========
async function loadAdminStats() {
    try {
        const response = await apiRequest('/api/admin/users');
        if (response.success) {
            document.getElementById('adminStatTotal').textContent = response.data.length;
            document.getElementById('adminStatBlocked').textContent = response.data.filter(u => u.is_blocked).length;
            document.getElementById('adminStatAdmin').textContent = response.data.filter(u => u.is_admin).length;
            // ä»Šæ—¥ç™»å…¥éœ€è¦é¡å¤– API
        }
    } catch (error) {
        console.error('è¼‰å…¥ç®¡ç†çµ±è¨ˆå¤±æ•—:', error);
    }
}

async function adminInitializeData() {
    showAdminMessage('æ­£åœ¨åˆå§‹åŒ–æ­·å²è³‡æ–™...');
    try {
        const response = await apiRequest('/api/admin/initialize', { method: 'POST' });
        showAdminMessage(response.message || 'åˆå§‹åŒ–å®Œæˆ', 'success');
    } catch (error) {
        showAdminMessage('åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminUpdateIndices() {
    showAdminMessage('æ­£åœ¨æ›´æ–°ä¸‰å¤§æŒ‡æ•¸...');
    try {
        const response = await apiRequest('/api/admin/update-indices', { method: 'POST' });
        showAdminMessage(response.message || 'æ›´æ–°å®Œæˆ', 'success');
    } catch (error) {
        showAdminMessage('æ›´æ–°å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminUpdateSentiment() {
    showAdminMessage('æ­£åœ¨æ›´æ–°ææ‡¼è²ªå©ªæŒ‡æ•¸...');
    try {
        const response = await apiRequest('/api/admin/update-sentiment', { method: 'POST' });
        showAdminMessage(response.message || 'æ›´æ–°å®Œæˆ', 'success');
    } catch (error) {
        showAdminMessage('æ›´æ–°å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminTriggerDailyUpdate() {
    showAdminMessage('æ­£åœ¨åŸ·è¡Œæ¯æ—¥æ›´æ–°...');
    try {
        const response = await apiRequest('/api/admin/daily-update', { method: 'POST' });
        showAdminMessage(response.message || 'æ›´æ–°å®Œæˆ', 'success');
    } catch (error) {
        showAdminMessage('æ›´æ–°å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminRunSignalCheck() {
    showAdminSignalMessage('æ­£åœ¨åµæ¸¬è¨Šè™Ÿ...');
    try {
        const response = await apiRequest('/api/admin/signal-check', { method: 'POST' });
        showAdminSignalMessage(response.message || 'åµæ¸¬å®Œæˆ', 'success');
    } catch (error) {
        showAdminSignalMessage('åµæ¸¬å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminSendSignalNotifications() {
    showAdminSignalMessage('æ­£åœ¨ç™¼é€é€šçŸ¥...');
    try {
        const response = await apiRequest('/api/admin/send-notifications', { method: 'POST' });
        showAdminSignalMessage(response.message || 'ç™¼é€å®Œæˆ', 'success');
    } catch (error) {
        showAdminSignalMessage('ç™¼é€å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminTestLineNotify() {
    showAdminSignalMessage('æ­£åœ¨æ¸¬è©¦ LINE æ¨æ’­...');
    try {
        const response = await apiRequest('/api/admin/test-line', { method: 'POST' });
        showAdminSignalMessage(response.message || 'æ¸¬è©¦å®Œæˆ', 'success');
    } catch (error) {
        showAdminSignalMessage('æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminTestSignalDetection() {
    const symbol = document.getElementById('adminTestSymbolInput').value.trim();
    if (!symbol) {
        showAdminSignalMessage('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ', 'warning');
        return;
    }
    showAdminSignalMessage(`æ­£åœ¨æ¸¬è©¦ ${symbol} è¨Šè™Ÿåµæ¸¬...`);
    try {
        const response = await apiRequest(`/api/admin/test-signal/${symbol}`);
        showAdminSignalMessage(JSON.stringify(response, null, 2), 'success');
    } catch (error) {
        showAdminSignalMessage('æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
    }
}

async function adminLoadUsers() {
    const search = document.getElementById('adminSearchInput').value.trim();
    const blockedOnly = document.getElementById('adminBlockedOnly').checked;
    
    try {
        let url = '/api/admin/users';
        if (search) url += `?search=${encodeURIComponent(search)}`;
        if (blockedOnly) url += (search ? '&' : '?') + 'blocked_only=true';
        
        const response = await apiRequest(url);
        if (response.success) {
            renderAdminUserList(response.data);
        }
    } catch (error) {
        document.getElementById('adminUserList').innerHTML = `<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
    }
}

function renderAdminUserList(users) {
    const container = document.getElementById('adminUserList');
    if (users.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">æ²’æœ‰æ‰¾åˆ°ç”¨æˆ¶</p>';
        return;
    }
    
    let html = `
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-3 py-2 text-left">ç”¨æˆ¶</th>
                    <th class="px-3 py-2 text-left hidden md:table-cell">Email</th>
                    <th class="px-3 py-2 text-center">ç‹€æ…‹</th>
                    <th class="px-3 py-2 text-center">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody class="divide-y">
    `;
    
    users.forEach(user => {
        html += `
            <tr class="${user.is_blocked ? 'bg-red-50' : ''}">
                <td class="px-3 py-2">
                    <div class="flex items-center">
                        <img src="${user.avatar_url || '/static/default-avatar.png'}" class="w-8 h-8 rounded-full mr-2">
                        <span class="font-medium">${user.display_name || user.line_name || '-'}</span>
                    </div>
                </td>
                <td class="px-3 py-2 hidden md:table-cell text-gray-500">${user.email || '-'}</td>
                <td class="px-3 py-2 text-center">
                    ${user.is_admin ? '<span class="px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs">ç®¡ç†å“¡</span>' : ''}
                    ${user.is_blocked ? '<span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs">å°é–</span>' : '<span class="px-2 py-1 bg-green-100 text-green-600 rounded text-xs">æ­£å¸¸</span>'}
                </td>
                <td class="px-3 py-2 text-center">
                    <button onclick="toggleUserBlock(${user.id}, ${!user.is_blocked})" class="px-2 py-1 ${user.is_blocked ? 'bg-green-500' : 'bg-red-500'} text-white rounded text-xs hover:opacity-80">
                        ${user.is_blocked ? 'è§£å°' : 'å°é–'}
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function toggleUserBlock(userId, block) {
    try {
        await apiRequest(`/api/admin/users/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_blocked: block })
        });
        adminLoadUsers();
        showToast(block ? 'ç”¨æˆ¶å·²å°é–' : 'ç”¨æˆ¶å·²è§£å°', 'success');
    } catch (error) {
        showToast('æ“ä½œå¤±æ•—: ' + error.message, 'error');
    }
}

function showAdminMessage(msg, type = 'info') {
    const el = document.getElementById('adminSystemMessage');
    el.textContent = msg;
    el.className = `mt-3 text-sm ${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-gray-500'}`;
}

function showAdminSignalMessage(msg, type = 'info') {
    const el = document.getElementById('adminSignalMessage');
    el.textContent = msg;
    el.className = `mt-3 text-sm ${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-gray-500'}`;
}

// åœ¨ showSection ä¸­æ·»åŠ ç®¡ç†å¾Œå°çš„è¼‰å…¥
// æ‰¾åˆ° showSection å‡½æ•¸ï¼Œåœ¨ switch æˆ– if åˆ¤æ–·ä¸­åŠ å…¥ï¼š
// case 'admin':
//     loadAdminStats();
//     break;
```

---

## ä¿®æ”¹ 4ï¼šæ›´æ–° showSection å‡½æ•¸

æ‰¾åˆ° `showSection` å‡½æ•¸ï¼Œç¢ºä¿å®ƒèƒ½è™•ç†æ–°çš„ sectionï¼š

```javascript
function showSection(name, evt) {
    if (evt) evt.preventDefault();
    
    // éš±è—æ‰€æœ‰ section
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    
    // é¡¯ç¤ºç›®æ¨™ section
    const target = document.getElementById(`section-${name}`);
    if (target) {
        target.classList.remove('hidden');
    }
    
    // æ›´æ–°å°èˆªç‹€æ…‹
    document.querySelectorAll('.nav-link, .mobile-nav-link, .bottom-nav-item').forEach(link => {
        link.classList.remove('bg-blue-50', 'text-gray-700', 'active');
        if (link.dataset.section === name) {
            link.classList.add('bg-blue-50', 'text-gray-700');
            if (link.classList.contains('bottom-nav-item')) {
                link.classList.add('active');
            }
        }
    });
    
    // è¼‰å…¥ç‰¹å®š section çš„è³‡æ–™
    switch(name) {
        case 'watchlist':
            loadWatchlist();
            break;
        case 'sentiment':
            loadSentiment();
            break;
        case 'portfolio':
            loadPortfolioData();
            break;
        case 'admin':
            loadAdminStats();
            break;
        // ... å…¶ä»– case
    }
    
    // é—œé–‰æ‰‹æ©Ÿé¸å–®
    closeMobileSidebar();
}
```

---

## é©—è­‰

ä¿®æ”¹å®Œæˆå¾Œï¼Œæ¸¬è©¦ä»¥ä¸‹åŠŸèƒ½ï¼š
1. âœ… é»æ“Šã€Œå ±é…¬ç‡æ¯”è¼ƒã€â†’ ä¿æŒå°èˆªåˆ—ï¼Œåªåˆ‡æ›å…§å®¹
2. âœ… é»æ“Šã€Œå¾Œå°ç®¡ç†ã€â†’ ä¿æŒå°èˆªåˆ—ï¼Œåªåˆ‡æ›å…§å®¹
3. âœ… é»æ“Šã€Œè¨­å®šã€â†’ ä¿æŒå°èˆªåˆ—ï¼Œåªåˆ‡æ›å…§å®¹
4. âœ… æ‰‹æ©Ÿç‰ˆä¹Ÿèƒ½æ­£å¸¸åˆ‡æ›
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ äº¤ç­_20260115_2330.md  â­
> SELA è‡ªå‹•é¸è‚¡ç³»çµ± - äº¤ç­ç´€éŒ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```md
# SELA è‡ªå‹•é¸è‚¡ç³»çµ± - äº¤ç­ç´€éŒ„
**æ—¥æœŸ**: 2026-01-15 23:30
**ç‰ˆæœ¬**: v0.8.2

---

## âœ… æœ¬æ¬¡å·²å®Œæˆä¿®æ­£

### 1. è‚¡ç¥¨è©³æƒ…æŠ€è¡“æŒ‡æ¨™æ¶ˆå¤±å•é¡Œ
**å•é¡Œ**: æŸ¥è©¢è‚¡ç¥¨æ™‚åªè¿”å›å¿«å–çš„ç°¡åŒ–è³‡æ–™ï¼Œæ²’æœ‰åœ–è¡¨å’Œå®Œæ•´æŒ‡æ¨™
**åŸå› **: `stock.py` çš„å¿«å–é‚è¼¯éŒ¯èª¤ï¼Œå¿«å–å‘½ä¸­æ™‚ç›´æ¥è¿”å›ç°¡åŒ–è³‡æ–™
**ä¿®æ­£**: 
- ç§»é™¤è‚¡ç¥¨è©³æƒ…æŸ¥è©¢çš„å¿«å–è¿”å›é‚è¼¯
- æ°¸é å¾ Yahoo Finance å–å¾—å®Œæ•´è³‡æ–™ï¼ˆå«åœ–è¡¨ã€æ‰€æœ‰æŒ‡æ¨™ï¼‰
- æŸ¥è©¢å®Œæˆå¾Œè‡ªå‹•æ›´æ–°åƒ¹æ ¼å¿«å–ï¼ˆä¾›è¿½è¹¤æ¸…å–®ä½¿ç”¨ï¼‰
**æª”æ¡ˆ**: `app/routers/stock.py`

### 2. è¨‚é–±æŒ‰éˆ•æ²’åæ‡‰
**å•é¡Œ**: é»æ“Šè¨‚é–±/å–æ¶ˆè¨‚é–±æŒ‰éˆ•ç„¡åæ‡‰
**åŸå› **: `onclick` æœªæ­£ç¢ºç¶å®šåˆ°å…¨åŸŸå‡½æ•¸
**ä¿®æ­£**: æ”¹ç”¨ `window.toggleSubscription` ç¢ºä¿å‡½æ•¸å¯è¢«å‘¼å«
**æª”æ¡ˆ**: `static/js/subscription.js`

### 3. è¨‚é–±ç²¾é¸æ—¥æœŸé¡¯ç¤ºéŒ¯èª¤
**å•é¡Œ**: é¡¯ç¤ºçš„æ˜¯æŠ“å–æ—¥æœŸè€Œéæ–‡ç« ç™¼ä½ˆæ—¥æœŸ
**ä¿®æ­£**: å„ªå…ˆä½¿ç”¨ `article_date`ï¼ˆæ–‡ç« ç™¼ä½ˆæ—¥ï¼‰ï¼Œè€Œé `first_seen_at`
**æª”æ¡ˆ**: `static/js/subscription.js`

### 4. ç®¡ç†å“¡å·¥å…·ç¼ºå°‘ã€Œæ›´æ–°è¨‚é–±ã€åŠŸèƒ½
**å•é¡Œ**: è¨­å®šé é¢æ²’æœ‰æ‰‹å‹•è§¸ç™¼è¨‚é–±æŠ“å–çš„æŒ‰éˆ•
**ä¿®æ­£**: 
- åœ¨ `settings.js` æ–°å¢ `adminFetchSubscriptions()` å‡½æ•¸
- åœ¨ `dashboard.html` æ–°å¢ã€Œç®¡ç†å“¡å·¥å…·ã€å€å¡Šï¼ŒåŒ…å«ä¸‰å€‹æŒ‰éˆ•ï¼š
  - æ›´æ–°åƒ¹æ ¼å¿«å–
  - æ›´æ–°åŒ¯ç‡
  - æŠ“å–è¨‚é–±ç²¾é¸ï¼ˆå›æº¯30å¤©ï¼‰
**æª”æ¡ˆ**: `static/js/settings.js`, `static/dashboard.html`

### 5. è¿½è¹¤æ¸…å–® MA20 æ’åºæ¶ˆå¤±
**å•é¡Œ**: æ’åºé¸é …æ²’æœ‰ MA20 è·é›¢
**ä¿®æ­£**: æ–°å¢ã€ŒMA20è·é›¢ã€æ’åºé¸é …ï¼Œè¨ˆç®—åƒ¹æ ¼èˆ‡ MA20 çš„å·®è·ç™¾åˆ†æ¯”
**æª”æ¡ˆ**: `static/js/watchlist.js`

### 6. å¿«é€Ÿæ–°å¢è¿½è¹¤æç¤ºæ¶ˆå¤±
**å•é¡Œ**: å¾è¨‚é–±ç²¾é¸é»ã€Œ+ã€åŠ å…¥è¿½è¹¤æ²’æœ‰æç¤º
**ä¿®æ­£**: åœ¨ `watchlist.js` æ–°å¢ `quickAddToWatchlist()` å‡½æ•¸ä¸¦å°å‡ºåˆ°å…¨åŸŸ
**æª”æ¡ˆ**: `static/js/watchlist.js`

---

## ğŸ“¦ å·²ç”¢å‡ºçš„æª”æ¡ˆ

| æª”æ¡ˆ | ç”¨é€” | éƒ¨ç½²ä½ç½® |
|------|------|----------|
| `stock.py` | å¾Œç«¯è‚¡ç¥¨æŸ¥è©¢ä¿®æ­£ | `app/routers/stock.py` |
| `frontend_fix_20260115.zip` | å‰ç«¯ä¿®æ­£åŒ… | è§£å£“åˆ° `static/` |

### frontend_fix_20260115.zip å…§å®¹
```
js/subscription.js   â† è¨‚é–±åŠŸèƒ½ä¿®æ­£
js/settings.js       â† ç®¡ç†å“¡å·¥å…·å‡½æ•¸
js/watchlist.js      â† MA20æ’åº + quickAdd
dashboard.html       â† ç®¡ç†å“¡å·¥å…·å€å¡Š
```

---

## âš ï¸ å·²çŸ¥å•é¡Œï¼ˆæœªä¿®ï¼‰

### 1. Railway éƒ¨ç½²å¡ä½
- ç¾è±¡: "Taking a snapshot of the code" å¡ä½ 24+ åˆ†é˜
- è§£æ³•: å–æ¶ˆé‡æ–°éƒ¨ç½²ï¼Œæˆ–æª¢æŸ¥ Railway ç‹€æ…‹ https://status.railway.app

### 2. index_service æ¨¡çµ„ä¸å­˜åœ¨
```
ModuleNotFoundError: No module named 'app.services.index_service'
```
- ä½ç½®: `app/routers/admin.py` ç¬¬ 967 è¡Œ
- å½±éŸ¿: `/api/admin/update-indices` API æœƒå ±éŒ¯
- å»ºè­°: ç¢ºèªæ˜¯å¦éœ€è¦æ­¤åŠŸèƒ½ï¼Œè‹¥ä¸éœ€è¦å¯ç§»é™¤ç›¸é—œ import

### 3. è¨‚é–±ç²¾é¸æ²’æœ‰è‡ªå‹•æ›´æ–°
- åŸå› : æ’ç¨‹å¯èƒ½æ²’æœ‰æ­£ç¢ºåŸ·è¡Œ
- è§£æ³•: å·²åŠ å…¥æ‰‹å‹•è§¸ç™¼æŒ‰éˆ•ï¼Œç®¡ç†å“¡å¯åœ¨ã€Œè¨­å®šã€é é¢æ‰‹å‹•æŠ“å–

---

## ğŸ“‹ å¾…è¾¦äº‹é … (P1)

| # | é …ç›® | ç‹€æ…‹ |
|---|------|------|
| 1 | è¨‚é–±ç²¾é¸å‰ç«¯ Tab | âœ… å·²å®ŒæˆåŸºæœ¬åŠŸèƒ½ |
| 2 | è¿½è¹¤æ¸…å–®åŒ¯å‡ºåŒ¯å…¥ | å¾…é–‹ç™¼ |
| 3 | æŒè‚¡äº¤æ˜“åŒ¯å‡ºåŒ¯å…¥ | å¾…é–‹ç™¼ |
| 4 | è¿½è¹¤æ¸…å–®åˆ†çµ„ Tag | å¾…é–‹ç™¼ |
| 5 | åˆ°åƒ¹æé†’è®Šè‰² | âœ… å·²å®Œæˆ |
| 6 | stock_info ç¨®å­è¡¨ | å¾…é–‹ç™¼ |

---

## ğŸ”§ éƒ¨ç½²æ­¥é©Ÿ

### å¾Œç«¯
```bash
# æ›¿æ› stock.py
cp stock.py app/routers/stock.py
```

### å‰ç«¯
```bash
# è§£å£“å‰ç«¯ä¿®æ­£åŒ…
unzip frontend_fix_20260115.zip -d static/
```

### éƒ¨ç½²å¾Œé©—è­‰
1. æŸ¥è©¢è‚¡ç¥¨ â†’ æ‡‰é¡¯ç¤ºå®Œæ•´æŠ€è¡“æŒ‡æ¨™å’Œåœ–è¡¨
2. è¿½è¹¤æ¸…å–® â†’ æ’åºæ‡‰æœ‰ã€ŒMA20è·é›¢ã€é¸é …
3. è¨‚é–±ç²¾é¸ â†’ é»ã€Œ+ã€æ‡‰é¡¯ç¤ºã€ŒXXX å·²åŠ å…¥è¿½è¹¤æ¸…å–®ã€
4. è¨­å®šé é¢ â†’ æ‡‰çœ‹åˆ°ã€Œç®¡ç†å“¡å·¥å…·ã€å€å¡Š
5. ç®¡ç†å“¡å·¥å…· â†’ é»ã€ŒæŠ“å–è¨‚é–±ç²¾é¸ã€æ‡‰æŠ“å–æœ€æ–°æ–‡ç« 

---

## ğŸ“ å‚™è¨»

- Railway å…è²»æ–¹æ¡ˆæ¯æœˆç´„ 500 å°æ™‚ï¼Œæ³¨æ„ç”¨é‡
- è³‡æ–™åº«é·ç§»å¿…é ˆé€é `database.py` çš„ `run_migrations()` åŸ·è¡Œ
- LINE Login å¤šç’°å¢ƒéƒ¨ç½²éœ€åœ¨ LINE Developers Console æ·»åŠ å°æ‡‰ Callback URL
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
### ğŸ“„ åŒ¯æ•´å°ˆæ¡ˆ V3.py  â­
> å°ˆæ¡ˆæ•´åˆå·¥å…· v2 - æ™ºèƒ½åˆ†å±¤æ•´ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```py
#!/usr/bin/env python3
"""
å°ˆæ¡ˆæ•´åˆå·¥å…· v2 - æ™ºèƒ½åˆ†å±¤æ•´ç†
ç”¨é€”ï¼šä¸Šå‚³åˆ° Claude å°ˆæ¡ˆä½œç‚º contextï¼Œçµæ§‹åŒ–ä¾¿æ–¼é–±è®€
"""

import os
import re
import shutil
from pathlib import Path
from datetime import datetime
from collections import defaultdict

# ===== è¨­å®š =====
IGNORE_DIRS = {'.git', '__pycache__', '.venv', 'venv', 'node_modules', '.idea', '.vscode', 'dist', 'build', '__MACOSX', '.pytest_cache', 'htmlcov'}
IGNORE_FILES = {'.DS_Store', 'Thumbs.db', '*.pyc', '*.pyo', '*.so', '*.egg-info'}
CODE_EXTENSIONS = {'.py', '.js', '.ts', '.jsx', '.tsx', '.html', '.css', '.json', '.yaml', '.yml', '.md', '.txt', '.sql', '.sh', '.env.example', '.toml'}

# ===== æª”æ¡ˆå¤§å°èˆ‡æˆªæ–·è¦å‰‡ =====
FILE_RULES = {
    # å®Œæ•´ä¿ç•™ï¼ˆä¸é™å¤§å°ï¼‰
    'full': {
        'extensions': {'.md', '.txt', '.toml', '.yaml', '.yml', '.env.example'},
        'files': {'requirements.txt', 'dockerfile', 'makefile', 'procfile'},
    },
    # ç¨‹å¼ç¢¼ï¼ˆä¸Šé™ 200KBï¼‰
    'code': {
        'extensions': {'.py', '.js', '.ts', '.jsx', '.tsx', '.html', '.sql', '.sh'},
        'max_size': 200 * 1024,
    },
    # æ¨£å¼ï¼ˆåªå–å‰ 150 è¡Œï¼‰
    'style': {
        'extensions': {'.css', '.scss', '.less'},
        'max_lines': 150,
    },
    # è³‡æ–™æª”ï¼ˆåªå–å‰ 50 è¡Œ + çµæ§‹èªªæ˜ï¼‰
    'data': {
        'extensions': {'.json', '.csv', '.tsv'},
        'max_lines': 50,
    },
}

# é‡è¦æª”æ¡ˆï¼ˆè¢«è·³éæ™‚è¦è¤‡è£½å‡ºä¾†ï¼‰
IMPORTANT_PATTERNS = {
    'extensions': {'.py', '.js', '.ts', '.md', '.html'},
    'files': {'main.py', 'app.py', 'index.py', 'config.py', 'settings.py'},
    'layers': {'entry', 'api', 'core', 'overview'},
}

# ===== åˆ†å±¤å®šç¾© =====
# å„ªå…ˆé †åºï¼šæ•¸å­—è¶Šå°è¶Šå‰é¢
LAYER_RULES = {
    # ç¬¬ 1 å±¤ï¼šå°ˆæ¡ˆæ¦‚è¿°
    'overview': {
        'order': 1,
        'title': 'ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°',
        'patterns': ['README*', 'CHANGELOG*', 'LICENSE*', 'docs/*', 'doc/*'],
        'files': {
            # åŸºæœ¬
            'readme.md', 'readme.txt', 'changelog.md', 'license', 'license.md',
            # é–‹ç™¼æ–‡æª”
            'troubleshooting.md', 'trouble_shooting.md', 'faq.md',
            'architecture.md', 'design.md', 'structure.md',
            'setup.md', 'install.md', 'installation.md',
            'development.md', 'dev.md', 'dev_notes.md', 'notes.md',
            'deployment.md', 'deploy.md',
            'contributing.md', 'contribute.md',
            'api.md', 'api_docs.md', 'endpoints.md',
            'todo.md', 'roadmap.md', 'plan.md',
            'guide.md', 'usage.md', 'manual.md',
            # ä¸­æ–‡å¸¸è¦‹
            'èªªæ˜.md', 'é–‹ç™¼ç­†è¨˜.md', 'å•é¡Œæ’è§£.md', 'æ¶æ§‹.md',
        },
    },
    # ç¬¬ 2 å±¤ï¼šè¨­å®šæª”
    'config': {
        'order': 2,
        'title': 'âš™ï¸ è¨­å®šæª”',
        'patterns': ['*.toml', '*.yaml', '*.yml', '.env*', 'config/*', 'settings/*'],
        'files': {'pyproject.toml', 'package.json', 'requirements.txt', 'dockerfile', 'docker-compose.yml', 'makefile', 'procfile', '.env.example', 'config.py', 'settings.py'},
    },
    # ç¬¬ 3 å±¤ï¼šé€²å…¥é»
    'entry': {
        'order': 3,
        'title': 'ğŸš€ ç¨‹å¼é€²å…¥é»',
        'patterns': [],
        'files': {'main.py', 'app.py', 'index.py', 'server.py', 'run.py', 'index.js', 'index.ts', 'app.js', 'server.js'},
    },
    # ç¬¬ 4 å±¤ï¼šè·¯ç”±/API
    'api': {
        'order': 4,
        'title': 'ğŸŒ API / è·¯ç”±',
        'patterns': ['routes/*', 'routers/*', 'api/*', 'endpoints/*', 'views/*'],
        'files': {'routes.py', 'router.py', 'api.py', 'urls.py'},
    },
    # ç¬¬ 5 å±¤ï¼šè³‡æ–™æ¨¡å‹
    'models': {
        'order': 5,
        'title': 'ğŸ“¦ è³‡æ–™æ¨¡å‹',
        'patterns': ['models/*', 'schemas/*', 'entities/*', 'types/*'],
        'files': {'models.py', 'schemas.py', 'database.py', 'db.py'},
    },
    # ç¬¬ 6 å±¤ï¼šæ ¸å¿ƒé‚è¼¯
    'core': {
        'order': 6,
        'title': 'ğŸ§  æ ¸å¿ƒé‚è¼¯',
        'patterns': ['core/*', 'services/*', 'handlers/*', 'controllers/*', 'lib/*'],
        'files': {'service.py', 'services.py', 'handler.py', 'controller.py'},
    },
    # ç¬¬ 7 å±¤ï¼šå·¥å…·/è¼”åŠ©
    'utils': {
        'order': 7,
        'title': 'ğŸ”§ å·¥å…· / è¼”åŠ©',
        'patterns': ['utils/*', 'helpers/*', 'common/*', 'shared/*'],
        'files': {'utils.py', 'helpers.py', 'common.py', 'tools.py'},
    },
    # ç¬¬ 8 å±¤ï¼šå‰ç«¯/éœæ…‹
    'frontend': {
        'order': 8,
        'title': 'ğŸ¨ å‰ç«¯ / éœæ…‹è³‡æº',
        'patterns': ['static/*', 'public/*', 'templates/*', 'assets/*', 'frontend/*', 'src/*'],
        'files': set(),
        'extensions': {'.html', '.css', '.js', '.jsx', '.tsx', '.vue', '.svelte'},
    },
    # ç¬¬ 9 å±¤ï¼šæ¸¬è©¦
    'tests': {
        'order': 9,
        'title': 'ğŸ§ª æ¸¬è©¦',
        'patterns': ['tests/*', 'test/*', '__tests__/*', 'spec/*'],
        'files': set(),
    },
    # ç¬¬ 10 å±¤ï¼šå…¶ä»–
    'other': {
        'order': 99,
        'title': 'ğŸ“ å…¶ä»–æª”æ¡ˆ',
        'patterns': [],
        'files': set(),
    },
}


def should_ignore(path: Path) -> bool:
    """åˆ¤æ–·æ˜¯å¦è¦å¿½ç•¥æ­¤è·¯å¾‘"""
    name = path.name
    if name in IGNORE_DIRS or name in IGNORE_FILES:
        return True
    if name.startswith('.') and name not in {'.env.example', '.gitignore'}:
        return True
    for pattern in IGNORE_FILES:
        if '*' in pattern and name.endswith(pattern.replace('*', '')):
            return True
    return False


def match_pattern(rel_path: str, patterns: list) -> bool:
    """æª¢æŸ¥è·¯å¾‘æ˜¯å¦ç¬¦åˆ pattern"""
    rel_lower = rel_path.lower()
    for pattern in patterns:
        pattern_lower = pattern.lower()
        if pattern_lower.endswith('/*'):
            # è³‡æ–™å¤¾ pattern
            folder = pattern_lower[:-2]
            if rel_lower.startswith(folder + '/') or ('/' + folder + '/') in rel_lower:
                return True
        elif '*' in pattern_lower:
            # è¬ç”¨å­—å…ƒ
            regex = pattern_lower.replace('*', '.*')
            if re.match(regex, rel_lower):
                return True
        else:
            if rel_lower == pattern_lower:
                return True
    return False


def classify_file(filepath: Path, root: Path) -> str:
    """åˆ†é¡æª”æ¡ˆåˆ°å°æ‡‰å±¤ç´š"""
    rel_path = str(filepath.relative_to(root))
    filename = filepath.name.lower()
    ext = filepath.suffix.lower()
    
    for layer_id, layer in LAYER_RULES.items():
        # 1. æª¢æŸ¥æª”å
        if filename in layer['files']:
            return layer_id
        
        # 2. æª¢æŸ¥è·¯å¾‘ pattern
        if match_pattern(rel_path, layer['patterns']):
            return layer_id
        
        # 3. æª¢æŸ¥å‰¯æª”åï¼ˆåƒ… frontend å±¤ï¼‰
        if layer_id == 'frontend' and ext in layer.get('extensions', set()):
            # ä½†è¦æ’é™¤å·²ç¶“è¢«å…¶ä»–è¦å‰‡åŒ¹é…çš„
            if '/static/' in rel_path.lower() or '/templates/' in rel_path.lower() or '/public/' in rel_path.lower():
                return layer_id
    
    # ç‰¹æ®Šåˆ¤æ–·ï¼štest æª”æ¡ˆ
    if 'test' in filename or filename.startswith('test_') or filename.endswith('_test.py'):
        return 'tests'
    
    return 'other'


def generate_tree(root: Path, prefix: str = "") -> list[str]:
    """ç”¢ç”Ÿç›®éŒ„æ¨¹ç‹€åœ–"""
    lines = []
    try:
        items = sorted(root.iterdir(), key=lambda x: (x.is_file(), x.name.lower()))
    except PermissionError:
        return lines
    
    items = [x for x in items if not should_ignore(x)]
    
    for i, item in enumerate(items):
        is_last = i == len(items) - 1
        connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
        
        if item.is_dir():
            lines.append(f"{prefix}{connector}{item.name}/")
            extension = "    " if is_last else "â”‚   "
            lines.extend(generate_tree(item, prefix + extension))
        else:
            lines.append(f"{prefix}{connector}{item.name}")
    
    return lines


def collect_files(root: Path) -> list[Path]:
    """æ”¶é›†æ‰€æœ‰ç¨‹å¼ç¢¼æª”æ¡ˆ"""
    files = []
    for path in root.rglob('*'):
        if path.is_file() and not should_ignore(path):
            if any(p.name in IGNORE_DIRS for p in path.parents):
                continue
            if path.suffix.lower() in CODE_EXTENSIONS or path.name.lower() in {'dockerfile', 'makefile', 'requirements.txt', 'procfile', 'license'}:
                files.append(path)
    return files


def estimate_importance(filepath: Path, layer: str) -> str:
    """ä¼°ç®—æª”æ¡ˆé‡è¦åº¦"""
    filename = filepath.name.lower()
    
    # é«˜é‡è¦åº¦
    if layer in ('entry', 'overview'):
        return 'â­â­â­'
    if layer == 'config' and filename in {'pyproject.toml', 'package.json', 'requirements.txt'}:
        return 'â­â­â­'
    if layer == 'api':
        return 'â­â­â­'
    if layer == 'models':
        return 'â­â­'
    if layer == 'core':
        return 'â­â­â­'
    
    # ä¸­é‡è¦åº¦
    if layer in ('config', 'models'):
        return 'â­â­'
    
    # ä½é‡è¦åº¦
    if layer in ('utils', 'tests', 'other'):
        return 'â­'
    if layer == 'frontend':
        return 'â­'
    
    return 'â­'


def get_file_description(filepath: Path) -> str:
    """å˜—è©¦å¾æª”æ¡ˆå–å¾—æè¿°ï¼ˆdocstring æˆ–ç¬¬ä¸€è¡Œè¨»è§£ï¼‰"""
    try:
        content = filepath.read_text(encoding='utf-8')
        lines = content.split('\n')
        
        # Python docstring
        if filepath.suffix == '.py':
            for i, line in enumerate(lines[:10]):
                if '"""' in line or "'''" in line:
                    # å–®è¡Œ docstring
                    match = re.search(r'["\'\s]{3}(.+?)["\'\s]{3}', line)
                    if match:
                        return match.group(1).strip()[:60]
                    # å¤šè¡Œ docstring
                    for j in range(i+1, min(i+5, len(lines))):
                        if lines[j].strip() and not lines[j].strip().startswith(('"""', "'''")):
                            return lines[j].strip()[:60]
                    break
        
        # ç¬¬ä¸€è¡Œè¨»è§£
        for line in lines[:5]:
            line = line.strip()
            if line.startswith('#') and len(line) > 2:
                return line[1:].strip()[:60]
            if line.startswith('//') and len(line) > 3:
                return line[2:].strip()[:60]
            if line.startswith('/*'):
                return line[2:].replace('*/', '').strip()[:60]
    except:
        pass
    return ''


def get_file_handling(filepath: Path) -> dict:
    """æ±ºå®šæª”æ¡ˆçš„è™•ç†æ–¹å¼"""
    ext = filepath.suffix.lower()
    filename = filepath.name.lower()
    
    # å®Œæ•´ä¿ç•™
    if ext in FILE_RULES['full']['extensions'] or filename in FILE_RULES['full']['files']:
        return {'type': 'full'}
    
    # æ¨£å¼æª”
    if ext in FILE_RULES['style']['extensions']:
        return {'type': 'truncate_lines', 'max_lines': FILE_RULES['style']['max_lines']}
    
    # è³‡æ–™æª”
    if ext in FILE_RULES['data']['extensions']:
        return {'type': 'truncate_lines', 'max_lines': FILE_RULES['data']['max_lines'], 'show_structure': True}
    
    # ç¨‹å¼ç¢¼
    if ext in FILE_RULES['code']['extensions']:
        return {'type': 'size_limit', 'max_size': FILE_RULES['code']['max_size']}
    
    # é è¨­
    return {'type': 'size_limit', 'max_size': 100 * 1024}


def is_important_file(filepath: Path, layer: str) -> bool:
    """åˆ¤æ–·æ˜¯å¦ç‚ºé‡è¦æª”æ¡ˆ"""
    ext = filepath.suffix.lower()
    filename = filepath.name.lower()
    
    if ext in IMPORTANT_PATTERNS['extensions']:
        return True
    if filename in IMPORTANT_PATTERNS['files']:
        return True
    if layer in IMPORTANT_PATTERNS['layers']:
        return True
    return False


def read_file_content(filepath: Path, handling: dict) -> tuple[str, bool, str]:
    """
    è®€å–æª”æ¡ˆå…§å®¹
    å›å‚³: (å…§å®¹, æ˜¯å¦è¢«æˆªæ–·, æˆªæ–·åŸå› )
    """
    try:
        file_size = filepath.stat().st_size
        
        if handling['type'] == 'full':
            content = filepath.read_text(encoding='utf-8')
            return content, False, ''
        
        elif handling['type'] == 'size_limit':
            max_size = handling['max_size']
            if file_size > max_size:
                return '', True, f'æª”æ¡ˆéå¤§ï¼ˆ{file_size/1024:.1f} KB > {max_size/1024:.0f} KBï¼‰'
            content = filepath.read_text(encoding='utf-8')
            return content, False, ''
        
        elif handling['type'] == 'truncate_lines':
            max_lines = handling['max_lines']
            content = filepath.read_text(encoding='utf-8')
            lines = content.split('\n')
            
            if len(lines) <= max_lines:
                return content, False, ''
            
            truncated = '\n'.join(lines[:max_lines])
            note = f'\n\n# ... å·²æˆªæ–·ï¼ˆé¡¯ç¤ºå‰ {max_lines} è¡Œï¼Œå…± {len(lines)} è¡Œï¼‰...\n'
            
            # JSON é¡¯ç¤ºçµæ§‹
            if handling.get('show_structure') and filepath.suffix.lower() == '.json':
                note += '# é€™æ˜¯è³‡æ–™æª”ï¼Œåƒ…é¡¯ç¤ºé–‹é ­çµæ§‹ä¾›åƒè€ƒ\n'
            
            return truncated + note, True, f'åƒ…é¡¯ç¤ºå‰ {max_lines} è¡Œ'
        
        return '', True, 'æœªçŸ¥è™•ç†é¡å‹'
        
    except UnicodeDecodeError:
        return '', True, 'äºŒé€²ä½æª”æ¡ˆ'
    except Exception as e:
        return '', True, f'è®€å–éŒ¯èª¤: {e}'


def bundle_project(target_dir: str, output_file: str = None, split_output: bool = False):
    """ä¸»ç¨‹å¼ï¼šæ•´åˆå°ˆæ¡ˆ"""
    root = Path(target_dir).resolve()
    
    if not root.exists():
        print(f"âŒ æ‰¾ä¸åˆ°è³‡æ–™å¤¾: {root}")
        return
    
    timestamp = datetime.now().strftime('%Y%m%d_%H%M')
    
    # å»ºç«‹è¼¸å‡ºè³‡æ–™å¤¾ï¼ˆæ‰å¹³çµæ§‹ï¼‰
    output_dir = root / f"for_Claude_{timestamp}"
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # bundle æª”æ¡ˆæ”¾åœ¨è¼¸å‡ºè³‡æ–™å¤¾å…§
    bundle_filename = f"{root.name}_bundle_{timestamp}.txt"
    output_path = output_dir / bundle_filename
    
    skipped_files = []  # [(åŸå§‹ç›¸å°è·¯å¾‘, æ–°æª”å), ...]
    
    # æ”¶é›†ä¸¦åˆ†é¡æª”æ¡ˆ
    all_files = collect_files(root)
    layers = defaultdict(list)
    
    for f in all_files:
        layer = classify_file(f, root)
        layers[layer].append(f)
    
    # æ’åºæ¯å±¤å…§çš„æª”æ¡ˆ
    for layer in layers:
        layers[layer].sort(key=lambda x: str(x).lower())
    
    # é–‹å§‹è¼¸å‡º
    with open(output_path, 'w', encoding='utf-8') as out:
        # ===== æ¨™é¡Œ =====
        out.write(f"{'='*70}\n")
        out.write(f"# å°ˆæ¡ˆï¼š{root.name}\n")
        out.write(f"# æ•´åˆæ™‚é–“ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        out.write(f"# æª”æ¡ˆæ•¸é‡ï¼š{len(all_files)}\n")
        out.write(f"{'='*70}\n\n")
        
        # ===== ç›®éŒ„çµæ§‹ =====
        out.write("## ğŸ“‚ ç›®éŒ„çµæ§‹\n\n")
        out.write("```\n")
        out.write(f"{root.name}/\n")
        for line in generate_tree(root):
            out.write(f"{line}\n")
        out.write("```\n\n")
        
        # ===== æª”æ¡ˆç´¢å¼• =====
        out.write(f"{'='*70}\n")
        out.write("## ğŸ“‘ æª”æ¡ˆç´¢å¼•\n\n")
        out.write("| å±¤ç´š | æª”æ¡ˆ | èªªæ˜ | é‡è¦åº¦ |\n")
        out.write("|------|------|------|--------|\n")
        
        sorted_layers = sorted(LAYER_RULES.items(), key=lambda x: x[1]['order'])
        for layer_id, layer_info in sorted_layers:
            if layer_id not in layers:
                continue
            for f in layers[layer_id]:
                rel = f.relative_to(root)
                desc = get_file_description(f)
                importance = estimate_importance(f, layer_id)
                layer_emoji = layer_info['title'].split()[0]
                out.write(f"| {layer_emoji} | `{rel}` | {desc} | {importance} |\n")
        out.write("\n")
        
        # ===== åˆ†å±¤å…§å®¹ =====
        for layer_id, layer_info in sorted_layers:
            if layer_id not in layers:
                continue
            
            out.write(f"\n{'='*70}\n")
            out.write(f"## {layer_info['title']}\n")
            out.write(f"{'='*70}\n")
            
            for filepath in layers[layer_id]:
                rel_path = filepath.relative_to(root)
                importance = estimate_importance(filepath, layer_id)
                desc = get_file_description(filepath)
                handling = get_file_handling(filepath)
                
                out.write(f"\n{'â”€'*70}\n")
                out.write(f"### ğŸ“„ {rel_path}  {importance}\n")
                if desc:
                    out.write(f"> {desc}\n")
                out.write(f"{'â”€'*70}\n\n")
                
                # è®€å–å…§å®¹
                content, was_skipped, skip_reason = read_file_content(filepath, handling)
                
                if was_skipped:
                    out.write(f"âš ï¸ {skip_reason}\n")
                    
                    # é‡è¦æª”æ¡ˆè¤‡è£½åˆ°è¼¸å‡ºè³‡æ–™å¤¾ï¼ˆæ‰å¹³åŒ–ï¼Œç”¨ -- å–ä»£ /ï¼‰
                    if is_important_file(filepath, layer_id):
                        # æŠŠè·¯å¾‘è½‰æˆæª”åï¼šapi/routes/auth.py â†’ api--routes--auth.py
                        flat_name = str(rel_path).replace('/', '--').replace('\\', '--')
                        dest = output_dir / flat_name
                        shutil.copy2(filepath, dest)
                        skipped_files.append((rel_path, flat_name))
                        out.write(f"ğŸ“ å·²è¤‡è£½: {flat_name}\n")
                else:
                    lang = filepath.suffix.lstrip('.') or 'text'
                    lang_map = {'txt': 'text', 'yml': 'yaml'}
                    lang = lang_map.get(lang, lang)
                    
                    out.write(f"```{lang}\n")
                    out.write(content)
                    if not content.endswith('\n'):
                        out.write('\n')
                    out.write("```\n")
        
        # ===== çµ±è¨ˆ =====
        out.write(f"\n{'='*70}\n")
        out.write("## ğŸ“Š çµ±è¨ˆ\n\n")
        for layer_id, layer_info in sorted_layers:
            if layer_id in layers:
                out.write(f"- {layer_info['title']}ï¼š{len(layers[layer_id])} å€‹æª”æ¡ˆ\n")
        out.write(f"\n**ç¸½è¨ˆï¼š{len(all_files)} å€‹æª”æ¡ˆ**\n")
        
        if skipped_files:
            out.write(f"\n### âš ï¸ è¢«è·³éçš„é‡è¦æª”æ¡ˆï¼ˆå·²è¤‡è£½åˆ°æ­¤è³‡æ–™å¤¾ï¼‰\n\n")
            out.write("| åŸå§‹è·¯å¾‘ | æª”å |\n")
            out.write("|----------|------|\n")
            for orig, flat in skipped_files:
                out.write(f"| `{orig}` | `{flat}` |\n")
        
        out.write(f"{'='*70}\n")
    
    # åˆ—å‡ºè³‡æ–™å¤¾å…§å®¹
    all_output_files = list(output_dir.iterdir())
    
    print(f"\n{'='*50}")
    print(f"âœ… å®Œæˆï¼")
    print(f"{'='*50}")
    print(f"\nğŸ“ è¼¸å‡ºè³‡æ–™å¤¾: {output_dir}")
    print(f"\n   è«‹å…¨é¸ä»¥ä¸‹ {len(all_output_files)} å€‹æª”æ¡ˆä¸Šå‚³åˆ° Claude:")
    for f in sorted(all_output_files, key=lambda x: (not x.name.endswith('.txt'), x.name)):
        print(f"   â€¢ {f.name}")
    
    if skipped_files:
        print(f"\n   ğŸ’¡ æª”åä¸­çš„ '--' ä»£è¡¨åŸæœ¬çš„è³‡æ–™å¤¾å±¤ç´š")
        print(f"      ä¾‹å¦‚: api--routes--auth.py = api/routes/auth.py")
    
    print(f"\nğŸ“Š åˆ†å±¤çµ±è¨ˆ:")
    for layer_id, layer_info in sorted_layers:
        if layer_id in layers:
            print(f"   {layer_info['title']}ï¼š{len(layers[layer_id])} å€‹")


if __name__ == "__main__":
    import sys
    
    print("=" * 50)
    print("ğŸ“¦ å°ˆæ¡ˆæ•´åˆå·¥å…· v2")
    print("=" * 50)
    
    if len(sys.argv) < 2:
        target = "."
        print(f"ä½¿ç”¨ç›®å‰ç›®éŒ„: {Path(target).resolve()}")
    else:
        target = sys.argv[1]
    
    output = sys.argv[2] if len(sys.argv) > 2 else None
    bundle_project(target, output)
```

======================================================================
## ğŸ“Š çµ±è¨ˆ

- ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°ï¼š23 å€‹æª”æ¡ˆ
- âš™ï¸ è¨­å®šæª”ï¼š4 å€‹æª”æ¡ˆ
- ğŸš€ ç¨‹å¼é€²å…¥é»ï¼š2 å€‹æª”æ¡ˆ
- ğŸŒ API / è·¯ç”±ï¼š12 å€‹æª”æ¡ˆ
- ğŸ“¦ è³‡æ–™æ¨¡å‹ï¼š19 å€‹æª”æ¡ˆ
- ğŸ§  æ ¸å¿ƒé‚è¼¯ï¼š20 å€‹æª”æ¡ˆ
- ğŸ”§ å·¥å…· / è¼”åŠ©ï¼š3 å€‹æª”æ¡ˆ
- ğŸ¨ å‰ç«¯ / éœæ…‹è³‡æºï¼š29 å€‹æª”æ¡ˆ
- ğŸ“ å…¶ä»–æª”æ¡ˆï¼š24 å€‹æª”æ¡ˆ

**ç¸½è¨ˆï¼š136 å€‹æª”æ¡ˆ**
======================================================================
